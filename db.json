{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"source/README.md","path":"README.md","modified":0,"renderable":0},{"_id":"source/fonts/chinese-zodiac.eot","path":"fonts/chinese-zodiac.eot","modified":0,"renderable":0},{"_id":"source/fonts/chinese-zodiac.woff","path":"fonts/chinese-zodiac.woff","modified":0,"renderable":0},{"_id":"source/fonts/chinese-zodiac.woff2","path":"fonts/chinese-zodiac.woff2","modified":0,"renderable":0},{"_id":"source/lib/jquery_lazyload/LICENSE","path":"lib/jquery_lazyload/LICENSE","modified":0,"renderable":0},{"_id":"themes/next/source/user.jpg","path":"user.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/QQ.png","path":"images/QQ.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/alipay.png","path":"images/alipay.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/background1.jpeg","path":"images/background1.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/background2.jpeg","path":"images/background2.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon2.png","path":"images/favicon2.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/messagepad.jpg","path":"images/messagepad.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/messagepad2.jpeg","path":"images/messagepad2.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/sword.ico","path":"images/sword.ico","modified":0,"renderable":1},{"_id":"themes/next/source/images/sword1.ico","path":"images/sword1.ico","modified":0,"renderable":1},{"_id":"themes/next/source/images/user.jpg","path":"images/user.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/wechatpay.png","path":"images/wechatpay.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/zabbix01.png","path":"images/zabbix01.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/zabbix02.png","path":"images/zabbix02.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/bubble.js","path":"js/bubble.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/love.js","path":"js/love.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/cursor/cherry.js","path":"js/cursor/cherry.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/cursor/explosion.min.js","path":"js/cursor/explosion.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/busuanzi.pure.mini.js","path":"js/schemes/busuanzi.pure.mini.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/LICENSE","path":"lib/canvas-nest/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/README.md","path":"lib/canvas-nest/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest-nomobile.min.js","path":"lib/canvas-nest/canvas-nest-nomobile.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/LICENSE","path":"lib/fancybox/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/README.md","path":"lib/fancybox/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.css","path":"lib/fancybox/source/jquery.fancybox.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.js","path":"lib/fancybox/source/jquery.fancybox.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager.png","path":"images/pg_buffer_manager.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_2.png","path":"images/pg_buffer_manager_2.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_3.png","path":"images/pg_buffer_manager_3.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_4.png","path":"images/pg_buffer_manager_4.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_10.png","path":"images/pg_buffer_manager_10.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_5.png","path":"images/pg_buffer_manager_5.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_6.png","path":"images/pg_buffer_manager_6.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_7.png","path":"images/pg_buffer_manager_7.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_8.png","path":"images/pg_buffer_manager_8.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/pg_buffer_manager_9.png","path":"images/pg_buffer_manager_9.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/A_example_of_the_process_architecture_in_PostgreSQL.png","path":"images/A_example_of_the_process_architecture_in_PostgreSQL.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/Valine.min.js","path":"js/Valine.min.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/README.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1596425818863},{"_id":"source/404/index.html","hash":"684d1410fc194cc8d4331dda28fe770935c9b0c9","modified":1614945209141},{"_id":"source/_data/styles.styl","hash":"3f68ba03a64a4c8af4ada4e6896fc3d4adb36477","modified":1614933047555},{"_id":"source/about/index.md","hash":"4a63c4cb4894364f37be9a8ed7bd49b119918ef0","modified":1614933047555},{"_id":"source/_posts/PostgreSQL两阶段事物提交.md","hash":"f0f1ad6ebdaee1a5c3d99ab81e63f843681a11f4","modified":1614933047555},{"_id":"source/_posts/PostgreSQL_install_from_source.md","hash":"16c5d7ba08c61885bdf3d15537d9bcc4f634c431","modified":1597408951596},{"_id":"source/_posts/PostgreSQL有用的SQL.md","hash":"7c0d2dcd3c4b7deee293da4bdad4879f43be364f","modified":1615446091376},{"_id":"source/_posts/PostgreSQL用户权限.md","hash":"42bcf09bed2da96e8419ab93431f7492aece96ec","modified":1596802197332},{"_id":"source/_posts/PostgreSQL行列转换.md","hash":"a6caa352d0d9ec8eba7d56d1e613bf8a1d7d0c44","modified":1596801892707},{"_id":"source/_posts/Python小技巧.md","hash":"c9b60e42853ff118750b696e9acf6fd6ba9c948c","modified":1599122014162},{"_id":"source/_posts/hello-world.md","hash":"0ec7845706c5c9b4f87cb502bdec551201a415b8","modified":1596510329474},{"_id":"source/_posts/linux配置vim.md","hash":"7a17b3c79bf80d6e5057b68c42fd45263d179350","modified":1614933047555},{"_id":"source/_posts/pg13_notice.md","hash":"5f27cb6cad989f0763c5bc3994030efa4f060fd5","modified":1597825972741},{"_id":"source/_posts/psql显示风格设置.md","hash":"55a0889c488865bb9b1cf4187ece4b3965c82e98","modified":1596621993637},{"_id":"source/_posts/softdog.md","hash":"dfe31f5cd0aa428d244f0d4eadb0706c0a95fba7","modified":1596802469600},{"_id":"source/_posts/unbutu_PostgreSQL_postgis_install.md","hash":"42cd70b5a6df8bed42dd085c747f270c10914d22","modified":1597145065051},{"_id":"source/_posts/zabbix编译安装.md","hash":"7f0ce29762b953f28a1b4f6de44eb888ddf90319","modified":1597116837716},{"_id":"source/_posts/利用Github分支备份Hexo博客源文件.md","hash":"429d66a78200cd8a07ae5e1f7c091e97b9fc5992","modified":1596803081324},{"_id":"source/_posts/微信聊天自动回复机器人.md","hash":"5f4975e9bbf9fe340f5d9fba63f4166353958052","modified":1596803179430},{"_id":"source/_posts/麻雀.md","hash":"226463a19e5853d3b8af1049cdde60becb7f5c8c","modified":1597408221883},{"_id":"source/categories/index.md","hash":"019bc7f497814ab5b3c20ce997a55da432b20e7f","modified":1614933047555},{"_id":"source/fonts/chinese-zodiac.eot","hash":"e3ea84e00f4fae1bbf157650ed09000299ea8c7b","modified":1535341589000},{"_id":"source/fonts/chinese-zodiac.woff","hash":"bf8137ae4b8a1e11bc5480ba5af2d44244d13f99","modified":1535341204000},{"_id":"source/fonts/chinese-zodiac.woff2","hash":"96af181d987ecc97bf9f1fe12df883102bdc18a4","modified":1535341642000},{"_id":"source/messagepad/index.md","hash":"25b46c31c2dfddf5d95adc1b8f46ed9687d62a04","modified":1614933047555},{"_id":"source/sitemap/index.md","hash":"3214af1807c0aaccf8b5ec8f1e05d887cee1a6ef","modified":1596513356127},{"_id":"source/tags/index.md","hash":"63cd5036cd1f3cb4f23eceb767440dc099095d2d","modified":1614933047555},{"_id":"source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/README.md","hash":"195a44ef23a22f166f7e56d37eaf27647b4f8b19","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1596595128538},{"_id":"source/lib/jquery_lazyload/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/config","hash":"675e4198cdbf1572eb297a238267ca1e1eb0c0c8","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/index","hash":"ec777c314af82e9a80ff2b646fbe8b2d843c1dc7","modified":1596607643680},{"_id":"source/lib/jquery_lazyload/.git/packed-refs","hash":"83ee2ab10ad076007e0c6c5896841c2e95de64ec","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/fsmonitor-watchman.sample","hash":"55a762007dd48d229ef89fe8d0882256dcbee41a","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1596595124190},{"_id":"source/lib/jquery_lazyload/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1596595124194},{"_id":"source/lib/jquery_lazyload/.git/logs/HEAD","hash":"ffa1a9d6f0f2a2ae810507435f4a191e4d81ab25","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/objects/08/d4d5ef639d45881e2c31089252871109b3cb0e","hash":"e1d5e486a1d20a1cb219a6998fcb9549f84ca0a7","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/0d/fe01dbfc3817db9740f7d9593e6c0d0ce4bcfe","hash":"40d7c408638a545f5d206dacc7a666562ae863b6","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/1e/6843316b3b3be83c6296e38edbcf7a1a389eaa","hash":"b85a7e69e5655a3e37e9fc6d0f7e2bacdbff58fc","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/3a/9ca03dafb2e0a3ee0132e998e1f95146a1187b","hash":"b2a3ed46595b48486b9ba48cc3718cb981f62533","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/49/94fde5a528c6dcf575d1300c9feb7a790580dd","hash":"849400735df951aba8ed44ba0a66b4d7c13c09a8","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/7e/6c9d90608b7b346b87da90c2aa3389822a5872","hash":"5a939a822a36748559b6b67651f48b82d6d9a209","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/92/9d3c446aba8ac3a7854bca3fa99071ec0f1b0a","hash":"324298d9a7b50c2a0640053f01aeaa53e8d1a7ca","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/99/99f3981a0f624ec98a63f2bef6b59ab5a4a130","hash":"e3318de2933bd40a6b707e06d63d97a72d2a41b6","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/a0/bb6371002f36c275d90ef0a78f4e951c1b36a4","hash":"e73b2d57d9528243fa4163d4078ff74f274aa159","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/b8/7cfcee7b6c989840000d9f5e3bfe75287e7450","hash":"51ead0dc580f672ab9fab6ae4b4b49918b813574","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/objects/cb/5cc9434249607fc442175e3e6c31f3a8cb7a04","hash":"ee1bd67de46a7e6c3a47a1abe0487a2b741d6be4","modified":1596595128526},{"_id":"source/lib/jquery_lazyload/.git/objects/fe/a9333a5d0d257dd748e4348bd97a5b71075026","hash":"a093eb542e88824fac9dda1103bb8def2c565ec6","modified":1596595128522},{"_id":"source/lib/jquery_lazyload/.git/refs/heads/master","hash":"ffca309262e3481ddc8a642c00d96ba47da8dca4","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/logs/refs/heads/master","hash":"ffa1a9d6f0f2a2ae810507435f4a191e4d81ab25","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1596595128530},{"_id":"source/lib/jquery_lazyload/.git/logs/refs/remotes/origin/HEAD","hash":"ffa1a9d6f0f2a2ae810507435f4a191e4d81ab25","modified":1596595128530},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1596439782946},{"_id":"themes/next/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1596439782946},{"_id":"themes/next/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1596439782946},{"_id":"themes/next/.gitignore","hash":"56f3470755c20311ddd30d421b377697a6e5e68b","modified":1596439782946},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1596439782946},{"_id":"themes/next/.travis.yml","hash":"ecca3b919a5b15886e3eca58aa84aafc395590da","modified":1596439782946},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1596439782946},{"_id":"themes/next/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1596439782946},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1596439782946},{"_id":"themes/next/_config.yml","hash":"b165da22ecc89380a96e344bbf9afe28ccd0294b","modified":1614945605536},{"_id":"themes/next/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1596439782950},{"_id":"themes/next/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1596439782954},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"aa4cb7aff595ca628cb58160ee1eee117989ec4e","modified":1596439782946},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"e554931b98f251fd49ff1d2443006d9ea2c20461","modified":1596439782946},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"1a435c20ae8fa183d49bbf96ac956f7c6c25c8af","modified":1596439782946},{"_id":"themes/next/.github/config.yml","hash":"1d3f4e8794986817c0fead095c74f756d45f91ed","modified":1596439782946},{"_id":"themes/next/.github/issue-close-app.yml","hash":"7cba457eec47dbfcfd4086acd1c69eaafca2f0cd","modified":1596439782946},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1596439782946},{"_id":"themes/next/.github/lock.yml","hash":"61173b9522ebac13db2c544e138808295624f7fd","modified":1596439782946},{"_id":"themes/next/.github/mergeable.yml","hash":"0ee56e23bbc71e1e76427d2bd255a9879bd36e22","modified":1596439782946},{"_id":"themes/next/.github/stale.yml","hash":"fdf82de9284f8bc8e0b0712b4cc1cb081a94de59","modified":1596439782946},{"_id":"themes/next/.github/release-drafter.yml","hash":"3cc10ce75ecc03a5ce86b00363e2a17eb65d15ea","modified":1596439782946},{"_id":"themes/next/.github/support.yml","hash":"d75db6ffa7b4ca3b865a925f9de9aef3fc51925c","modified":1596439782946},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1596439782946},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1596439782946},{"_id":"themes/next/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1596439782946},{"_id":"themes/next/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1596439782946},{"_id":"themes/next/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1596439782946},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1596439782946},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1596439782946},{"_id":"themes/next/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1596439782946},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1596439782946},{"_id":"themes/next/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1596439782950},{"_id":"themes/next/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1596439782950},{"_id":"themes/next/languages/default.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1596439782950},{"_id":"themes/next/languages/en.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1596439782950},{"_id":"themes/next/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1596439782950},{"_id":"themes/next/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1596439782950},{"_id":"themes/next/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1596439782950},{"_id":"themes/next/languages/hu.yml","hash":"b1ebb77a5fd101195b79f94de293bcf9001d996f","modified":1596439782950},{"_id":"themes/next/languages/id.yml","hash":"572ed855d47aafe26f58c73b1394530754881ec2","modified":1596439782950},{"_id":"themes/next/languages/it.yml","hash":"44759f779ce9c260b895532de1d209ad4bd144bf","modified":1596439782950},{"_id":"themes/next/languages/ja.yml","hash":"0cf0baa663d530f22ff380a051881216d6adcdd8","modified":1596439782950},{"_id":"themes/next/languages/ko.yml","hash":"0feea9e43cd399f3610b94d755a39fff1d371e97","modified":1596439782950},{"_id":"themes/next/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1596439782950},{"_id":"themes/next/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1596439782950},{"_id":"themes/next/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1596439782950},{"_id":"themes/next/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1596439782950},{"_id":"themes/next/languages/tr.yml","hash":"fe793f4c2608e3f85f0b872fd0ac1fb93e6155e2","modified":1596439782950},{"_id":"themes/next/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1596439782950},{"_id":"themes/next/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1596439782950},{"_id":"themes/next/languages/zh-CN.yml","hash":"a1f15571ee7e1e84e3cc0985c3ec4ba1a113f6f8","modified":1596439782950},{"_id":"themes/next/languages/zh-HK.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1596439782950},{"_id":"themes/next/languages/zh-Hans.yml","hash":"bf12566d33fc014c1f3a36562a0bbd4995d2af06","modified":1596533798025},{"_id":"themes/next/languages/zh-TW.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1596439782950},{"_id":"themes/next/layout/_layout.swig","hash":"49b0201b15352e6fbeecd5a25aa53da483c0377c","modified":1614945047820},{"_id":"themes/next/layout/archive.swig","hash":"e4e31317a8df68f23156cfc49e9b1aa9a12ad2ed","modified":1596439782954},{"_id":"themes/next/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1596439782954},{"_id":"themes/next/layout/index.swig","hash":"7a342f260e923cbe5e7791d40ece6fa883f1d3ea","modified":1597062422700},{"_id":"themes/next/layout/page.swig","hash":"0d6ac2e9b64977afd260471680ffe60948b70d14","modified":1597113701188},{"_id":"themes/next/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1596439782954},{"_id":"themes/next/layout/tag-bubble.swig","hash":"df221de627c1f5dcc5fb03f6619633287da7e575","modified":1597052767499},{"_id":"themes/next/layout/tag-color.swig","hash":"5826fca287979119e35f4d194e1aa17413503bd4","modified":1597048148434},{"_id":"themes/next/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1596439782954},{"_id":"themes/next/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1596439782954},{"_id":"themes/next/source/user.jpg","hash":"c5544a049921ee5de0d97a4a17ae1fa7951af9c1","modified":1596440057896},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"c3e6b8196c983c40fd140bdeca012d03e6e86967","modified":1596439782946},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"12d99fb8b62bd9e34d9672f306c9ae4ace7e053e","modified":1596439782946},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"d3efc0df0275c98440e69476f733097916a2d579","modified":1596439782946},{"_id":"themes/next/.github/ISSUE_TEMPLATE/question.md","hash":"53df7d537e26aaf062d70d86835c5fd8f81412f3","modified":1596439782946},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1596439782946},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1596439782946},{"_id":"themes/next/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1596439782946},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1596439782946},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1596439782950},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1596439782950},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1596439782950},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1596439782950},{"_id":"themes/next/layout/_custom/clock.swig","hash":"731e3da31af17a63096753c9b7e880ddb9d41381","modified":1597051712195},{"_id":"themes/next/layout/_custom/custom.swig","hash":"15e47fd33f4ed7e94c14fb4da5e1d862ea62bb83","modified":1596445267457},{"_id":"themes/next/layout/_custom/runtime.swig","hash":"e643c6b9f827062e590fa9961114c298b644ae6b","modified":1597051963186},{"_id":"themes/next/layout/_macro/carousel.swig","hash":"6064fa9ca088db45362ac06df0d01d97901c89f8","modified":1597047521842},{"_id":"themes/next/layout/_macro/passage-end-tag.swig","hash":"f29b50d83bcdc9e70696b6a8a8917d8b2ad4be10","modified":1596442716543},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"cdbccc0d12da467fc753d9843bc66c935b5ba18d","modified":1597048756532},{"_id":"themes/next/layout/_macro/post.swig","hash":"d3a766d462cc4db5f4930db33e60720ecc1c4ad7","modified":1597048655203},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"23a74d87e862fbc4c26d3f101125f8fe03990e8e","modified":1597145573102},{"_id":"themes/next/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1596439782950},{"_id":"themes/next/layout/_partials/footer.swig","hash":"14856eaac42cf4c658bdb2685d72df8f12262412","modified":1597145325684},{"_id":"themes/next/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1596439782950},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1596439782950},{"_id":"themes/next/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1596439782950},{"_id":"themes/next/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1596439782950},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1596439782950},{"_id":"themes/next/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1596439782950},{"_id":"themes/next/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1596439782950},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1596439782950},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1596439782950},{"_id":"themes/next/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1596439782950},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1596439782950},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1596439782950},{"_id":"themes/next/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1596439782954},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1596439782954},{"_id":"themes/next/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1596439782954},{"_id":"themes/next/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1596439782954},{"_id":"themes/next/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1596439782954},{"_id":"themes/next/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1596439782954},{"_id":"themes/next/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1596439782954},{"_id":"themes/next/scripts/helpers/font.js","hash":"40cf00e9f2b7aa6e5f33d412e03ed10304b15fd7","modified":1596439782954},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1596439782954},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1596439782954},{"_id":"themes/next/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1596439782954},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1596439782954},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1596439782954},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1596439782954},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1596439782954},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1596439782954},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1596439782954},{"_id":"themes/next/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1596439782954},{"_id":"themes/next/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1596439782954},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1596439782954},{"_id":"themes/next/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1596439782954},{"_id":"themes/next/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1596439782954},{"_id":"themes/next/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1596439782958},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1596439782958},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1596439782958},{"_id":"themes/next/source/images/alipay.png","hash":"8ad703b62bb310b21dbb320993302726b0508427","modified":1596609759380},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1596439782958},{"_id":"themes/next/source/images/background1.jpeg","hash":"7ed0a8faf2db3927ab2f57977cdf58075cd7a7c2","modified":1596512144258},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1596439782958},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1596439782958},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1596439782958},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1596439782958},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1596439782958},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1596439782958},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1596439782958},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1596439782958},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1596439782958},{"_id":"themes/next/source/images/favicon.ico","hash":"aaad3ca3c9194649d8a40e08ecb22f7c252cf187","modified":1596441173191},{"_id":"themes/next/source/images/favicon2.png","hash":"a7ff12fde93adb2e0d27dc05b074f590b782a208","modified":1596623787149},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1596439782958},{"_id":"themes/next/source/images/user.jpg","hash":"c5544a049921ee5de0d97a4a17ae1fa7951af9c1","modified":1596455672339},{"_id":"themes/next/source/images/wechatpay.png","hash":"c12e730178060b0d9c6c22b930c491ec8101072d","modified":1596609783528},{"_id":"themes/next/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1596439782958},{"_id":"themes/next/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1596439782958},{"_id":"themes/next/source/js/bubble.js","hash":"5a4227d3f6d084148102f31b9add45faa62604f2","modified":1597052807358},{"_id":"themes/next/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1596439782958},{"_id":"themes/next/source/js/love.js","hash":"d2cb21e05c635a0bbbbb4dd6a37bd63506588fa3","modified":1596442629778},{"_id":"themes/next/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1596439782958},{"_id":"themes/next/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1596439782958},{"_id":"themes/next/source/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1596439782958},{"_id":"themes/next/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1596439782958},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1596439782950},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"f530847d7dbe2d450a10c2abdd63a165344deb9b","modified":1596441496471},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1596439782950},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1596439782950},{"_id":"themes/next/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1596439782950},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1596439782950},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1596439782950},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1596439782950},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1596439782950},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1596439782950},{"_id":"themes/next/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1596439782950},{"_id":"themes/next/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1596439782950},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1596439782950},{"_id":"themes/next/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1596439782950},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1596439782950},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1596439782950},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1596439782950},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"7334378a2d763df7772e979a066e72a4ef8275c9","modified":1597145877557},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1596439782950},{"_id":"themes/next/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1596439782950},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1596439782950},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1596439782950},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1596439782950},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1596439782950},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1596439782950},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1596439782950},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1596439782950},{"_id":"themes/next/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1596439782950},{"_id":"themes/next/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1596439782950},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1614933936922},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1596439782950},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1596439782950},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1596439782950},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1596439782950},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1596439782950},{"_id":"themes/next/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1596439782954},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"d531f0ed3d27550bae02499fd104728399c9cf88","modified":1596799764858},{"_id":"themes/next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1596439782954},{"_id":"themes/next/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1596439782954},{"_id":"themes/next/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1596439782954},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1596439782954},{"_id":"themes/next/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1596439782954},{"_id":"themes/next/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1596439782954},{"_id":"themes/next/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1596439782954},{"_id":"themes/next/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1596439782954},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"a54708fd9309b4357c423a3730eb67f395344a5e","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1596439782954},{"_id":"themes/next/scripts/filters/comment/valine.js","hash":"6cbd85f9433c06bae22225ccf75ac55e04f2d106","modified":1596439782954},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"e8861188551ae8abd59dbb0aca1e9fa05e1c475c","modified":1596803617739},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1596439782958},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1596439782958},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"08a873febb1694bc2d3bee4401f4dd62834d39ed","modified":1596803696565},{"_id":"themes/next/source/css/_variables/base.styl","hash":"35a07e295f40dcf72ae8d44000a23546acf8f0a2","modified":1597113300088},{"_id":"themes/next/source/js/cursor/cherry.js","hash":"569e23e279f87b0dfef8eea6c5992a8aa610f663","modified":1596445158607},{"_id":"themes/next/source/js/cursor/explosion.min.js","hash":"233e9a9ed0e8aa4799bfbe02899f0c34f9af5a7b","modified":1596445180719},{"_id":"themes/next/source/js/schemes/busuanzi.pure.mini.js","hash":"6e41f31100ae7eb3a6f23f2c168f6dd56e7f7a9a","modified":1543721990000},{"_id":"themes/next/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1596439782958},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1596439782958},{"_id":"themes/next/source/lib/canvas-nest/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1596510798226},{"_id":"themes/next/source/lib/canvas-nest/README.md","hash":"0ba5a24a483f36166f0cb871bd30f4c7467f3593","modified":1596510798226},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"956eada198babd00f028e8908767cb158926c3f3","modified":1596510798230},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"d8bf9cb15d9d91c7ad022ba2954b5b4d326f17f7","modified":1597030573698},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1596510798230},{"_id":"themes/next/source/lib/fancybox/README.md","hash":"8286582ed7c338fce8bb03566b769fba378bce83","modified":1597030573698},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1596439782962},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1596439782962},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1596439782954},{"_id":"themes/next/source/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1597030573698},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1596439782954},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1597030573698},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1596439782954},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1596439782954},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1596439782958},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1596439782958},{"_id":"themes/next/source/lib/canvas-nest/.git/config","hash":"7aac3f671ea9ee22cdf431c0ceb7e937b051a3b5","modified":1596510798218},{"_id":"themes/next/source/lib/canvas-nest/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1596510798218},{"_id":"themes/next/source/lib/canvas-nest/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/index","hash":"10bfa944d6d90f8520391a6ef8581873637bdbbd","modified":1596510798230},{"_id":"themes/next/source/lib/canvas-nest/.git/packed-refs","hash":"80eecf0c5c7f21b2678dc1c329f74de19b6a3a67","modified":1596510798214},{"_id":"themes/next/source/lib/canvas-nest/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1596510798226},{"_id":"themes/next/source/lib/fancybox/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1597030573682},{"_id":"themes/next/source/lib/fancybox/.git/config","hash":"20d66faedf1f14f990d90b16690e4030dbc56c70","modified":1597030573686},{"_id":"themes/next/source/lib/fancybox/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/index","hash":"d50c93855a2b1ac1b23345a4e57c6b1faae6a671","modified":1597030573706},{"_id":"themes/next/source/lib/fancybox/.git/packed-refs","hash":"b6ffcdb23c4f9b3e5576fe104e8596ea71603c84","modified":1597030573682},{"_id":"themes/next/source/lib/fancybox/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1597030573698},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1597030573698},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1597030573698},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1596439782958},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1596439782958},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"07650f28a06e1679ddc0bbaa5b0d836ba99f8264","modified":1597113140389},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"70cdcf935bcbf014f7ba840b29f1e12df595ce10","modified":1596442690959},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"9575ed206da25265782229a8262476027c01633e","modified":1596440126261},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1596439782954},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"44487d9ab290dc97871fa8dd4487016deb56e123","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1596439782954},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1596439782954},{"_id":"themes/next/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1596439782954},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/fsmonitor-watchman.sample","hash":"55a762007dd48d229ef89fe8d0882256dcbee41a","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1596510795470},{"_id":"themes/next/source/lib/canvas-nest/.git/logs/HEAD","hash":"23659fee9ab0cc6e66a7d424f0e29fc47d5d8b80","modified":1596510798218},{"_id":"themes/next/source/lib/canvas-nest/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1596510795470},{"_id":"themes/next/source/lib/fancybox/.git/hooks/fsmonitor-watchman.sample","hash":"55a762007dd48d229ef89fe8d0882256dcbee41a","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1597030569078},{"_id":"themes/next/source/lib/fancybox/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1597030569078},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1596510798146},{"_id":"themes/next/source/lib/fancybox/.git/logs/HEAD","hash":"5166fe518f374116dc0f064fd7d225cfedbee3d1","modified":1597030573686},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/17/9eb5d6cd5f44ba3dd9e08b4ffcd83bb26db80a","hash":"03d593c92c9fad045d298f58afdbbcfbde923999","modified":1596510798146},{"_id":"themes/next/source/lib/fancybox/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1597030569078},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/2a/f622a4d7df40a2708946e91d6d7a0df1dc468c","hash":"3da7207fb18d361b83c56f4e35f67e9e945abd82","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/22/504fa21ce1b75e3f898ffafc8d2a8bed8d00c9","hash":"7c6ee7a38812c72e52ecb5c2ad725a9f103923a6","modified":1596510798202},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/44/6ddf9b6c0e5ade17ca5cb99f9b3a5300919c57","hash":"fb72799ff98445f72fda041337da4cf105d9dcba","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/46/cad4f872aa93e813aed99547c4705322ca483f","hash":"b0465d3186e2d58a8a99c56c6e68aa2965a396d4","modified":1596510798142},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/45/9262fe92f0115707bf8d8764f1886bc5e7c9e0","hash":"36040483f8af76775b7e4b6d87cec53729625399","modified":1596510798158},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/4b/2975337cf280e5555ca7a82dc7c2d4b437c5b0","hash":"d36f2c2b52c48d7f7cd0d0beb42be2ecd7534287","modified":1596510798158},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/50/306daa49b7b24c4759a4e832bfba3531c53f49","hash":"32aa9d96315007f8d79cd162bc77398addfa6ddf","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/50/dd2a6539498a70226c81a587db486b47e839ff","hash":"3844b0c815d0b4b32c6312c751a826bf9dc2c945","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/51/7c5eb7dcc2cb9769efea2e7375ff6e04123150","hash":"ec53157077d47430f4729bf164999d18d370aeab","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/5a/69ce9c2e4a1a34f6063ae9a121af1555669c69","hash":"dad25cc0f450e2827b5676975f4a70636e3fd2c8","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/5e/8ae972c99b04af7dd56dabfc485e8fdae5094d","hash":"791b3349c5696ccacae00bffbdbb8d88a03e61a9","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/69/39233ece53c9bdb9a1faf3271ed5768b034aad","hash":"5a770d418c1bb7b0f031f4d5416530002032fcf3","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/75/de2b8fa62d52690de32c351c63ab6446104ed5","hash":"52d10122d633ce4895a0690c5955e1b356f5a391","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/86/1c9f4241fe0eb6af02ad770d5ce04c1f68972b","hash":"7005c3e36015a4af30d4b91bd5a849a7861a073e","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/7b/c7e3186212b6f2e06d3370502565e2c6326890","hash":"379f3c6486f589fc9c1ab07d0382adacf4f655a2","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/8c/150fefb741be4edee07810003c8a845113e209","hash":"067de29d5efa0a46cdc8f9f113820e5e09bfa50a","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/8b/66994be5014f18d17347ff32232c91d51ad08c","hash":"a22da1680018e1ab95118216eb88115d2947930a","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/90/f6477118d05f5f96ce0a63c6f18b7b2baea200","hash":"385f58e92981f27fa54eb52bf60424e87c70a9d8","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/91/f99a0c53b26dd54f56b9e452c68f56b06f8f7e","hash":"3dca8a5629e66599b6e0f146aa32f1b7ce023d89","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/98/67d1132e0e50bbb7df754a63358d70741df6d5","hash":"3cb710a1faee73c08036f5e2df7df3a7ce29e9dd","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/99/be66a33ab4ebc34f62f2880a0e0cc6d334d0f2","hash":"f2346fe8ddd7d7abf38f2946f3083d8150f502d2","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/aa/da83ad9aa55faa2b34ede31b1d41e16966f80b","hash":"b304541ab95b7969a63ba2ec4f60f5391bd8bb44","modified":1596510798146},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/ab/45cbef9bc70ceff60f1ed52f2a5c34f6ad5725","hash":"ee2fa8f3df0de9092a4fce015cefd76ea18f4cfd","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/b3/5fc481f71dd08037f6b9febb5ec02c790f843b","hash":"ed5aa3a748675544aaa141c182a317453dd1e774","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/b1/bb278ca2e50dff1b343f9d5ca025272859432f","hash":"74f0afa72a30268d84613fb0d1d893bba866f01d","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/bb/5755c22b6c1b7461319624f0f000bc947882ee","hash":"2b87a2a354a0fa77cbddf461b03b0b8e43c16a4f","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/ca/3466a8cbf05c2982c58199d6ee71ec6d0271ca","hash":"a9b80b5d827b5e84229b1afd7920d9218dce610f","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/d1/b8c85241243a80f16d56e7a50244d3695f6e6e","hash":"baf56a83286c72af11667786dc59e7c58d30e427","modified":1596510798202},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/d4/95d28a8fab74d23908f6ccef9e4db2625fbacb","hash":"59e6067b0a806deee7bda6460b36c0f63e2e1db5","modified":1596510798154},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/d6/5de52977302632417c21e015956fb3dab8cabd","hash":"e0c8f0483b20434e63748a649ca4afbb417997f4","modified":1596510798150},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/e1/5c0793114874195462829db04d021face6640e","hash":"ff6c6d9f05b171ba67b44564ae3574d16eae6222","modified":1596510798142},{"_id":"themes/next/source/lib/canvas-nest/.git/objects/fd/3e2cc9301ef9c1978ace2bd0aee99f47176661","hash":"09b27ad6cf69d4dcb926389e16913daccb5d2972","modified":1596510798206},{"_id":"themes/next/source/lib/canvas-nest/.git/refs/heads/master","hash":"473e30291eac5f6d120dfe823b29ad4b2218f05a","modified":1596510798218},{"_id":"themes/next/source/lib/fancybox/.git/objects/00/c03f6be011e8878608eec12f68caf42b73f38e","hash":"8516bd35bc8f9223e13de5877778c8d14d49d6db","modified":1597030573674},{"_id":"themes/next/source/lib/fancybox/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/16/b01254a56610f4c6b7721c534ed4fc40ae51dd","hash":"88ca5fd99322d3a4067e0711af79f41c078f2ef5","modified":1597030571834},{"_id":"themes/next/source/lib/fancybox/.git/objects/19/3567a3107003507fafacd255c349857e417926","hash":"ef5eab75e8c6998cb223edb4eb8a26c4cfc9415c","modified":1597030573442},{"_id":"themes/next/source/lib/fancybox/.git/objects/1f/a2c5f332b7e304431213aec21012e53f8781d7","hash":"7632806182aa989d3b7029579d5c03c34b113ee3","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1597030571442},{"_id":"themes/next/source/lib/fancybox/.git/objects/36/9bab09306448a2970d378b59bb21c059edad63","hash":"877e0c15623d0d6ff8f09bb627fc60a489f3c105","modified":1597030571478},{"_id":"themes/next/source/lib/fancybox/.git/objects/3d/521bfc64755e348870094e85323dc1b9c96a6b","hash":"e9660fc4f89ecb176b0ab6e4860579c1bfe9f9cb","modified":1597030572706},{"_id":"themes/next/source/lib/fancybox/.git/objects/40/9607f1ba381a64c3ccb8d5440299e8ef868ef8","hash":"a462f7a9efebb70c4051f92c09ccbd9885132c77","modified":1597030571434},{"_id":"themes/next/source/lib/fancybox/.git/objects/47/d427b6c52396bbab53a05f57aaa82b52c805b1","hash":"c5626bbb62f4d1d1e39034e7f44baf4c509410d6","modified":1597030572706},{"_id":"themes/next/source/lib/fancybox/.git/objects/51/cf05811ed7d35e92551db1ba5a6e267ce781a5","hash":"99c009035ea86e3876b586577677d4d62ae12379","modified":1597030572706},{"_id":"themes/next/source/lib/fancybox/.git/objects/53/ceaabe0f8677333c5be196778b3e40840a1869","hash":"7bc1c1c42059d5402335b5293bfb5e54bee22557","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/54/0a7b36ee26decfc3f0f34bf73bc85c48899128","hash":"2e5447a9dd879d71368e9dddd34d93849d00b934","modified":1597030573674},{"_id":"themes/next/source/lib/fancybox/.git/objects/63/c555caede30ab06d6dba16644a827e9574c8cb","hash":"846603220288272ad5d35ebdc3c917cc4adce424","modified":1597030571434},{"_id":"themes/next/source/lib/fancybox/.git/objects/64/c47e893a0fef71c8c0930975ef114d9812da56","hash":"eaad75fab15724f9c2b069fc1ce9b8216be149d7","modified":1597030571478},{"_id":"themes/next/source/lib/fancybox/.git/objects/78/068b93f813cecbbd50c8247de547035009d512","hash":"4bc2bee779bd7e3cca13ee34801cf1e12585e5ae","modified":1597030572706},{"_id":"themes/next/source/lib/fancybox/.git/objects/7b/15d3cb03fda86241f8b2b335f04e9b9de0e1c4","hash":"d1fe3bd82c90f7d93874798a8ee8ebf1391d7207","modified":1597030573266},{"_id":"themes/next/source/lib/fancybox/.git/objects/7c/00ef8195b73793d477d22e723ecdac9553ebf3","hash":"fd8c4fd143b32fb3e86367f123feb7c35b305262","modified":1597030572686},{"_id":"themes/next/source/lib/fancybox/.git/objects/7c/c60b295fa2dcb82537a63792c9b3b3c2e74c33","hash":"b2dc23c71b13726c391aaefaa5312227a9b6ab7e","modified":1597030571834},{"_id":"themes/next/source/lib/fancybox/.git/objects/89/9d7a75b543fbed2a785f67d995bc77e06eb2e9","hash":"5651e2b80703225f642625c0fb2646543096d2cf","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/80/6b27034bd69d563e4243c2f12b43c7064b32dd","hash":"b7d3e8020767ae60a2029da8eccb0068623dc618","modified":1597030572706},{"_id":"themes/next/source/lib/fancybox/.git/objects/92/4369c371444afb18fb86309229f5b4c24c6cf4","hash":"9eb6fa8ff9081e6650f6bee350d21567df105737","modified":1597030573442},{"_id":"themes/next/source/lib/fancybox/.git/objects/94/a9ed024d3859793618152ea559a168bbcbb5e2","hash":"1c2d080a86f03eb960e112a94910a5115addf57a","modified":1597030571478},{"_id":"themes/next/source/lib/fancybox/.git/objects/9b/fe9361836240600c1bcc3cab9d42b35e731fad","hash":"3d38ffc7ac1ae85224691ef15d7f32e40c40b3a2","modified":1597030571834},{"_id":"themes/next/source/lib/fancybox/.git/objects/aa/654e17af8c354994f706c4e33bba6b5b70caeb","hash":"22b1bdf0b0974bf5e9022953ac26066056c235ff","modified":1597030573674},{"_id":"themes/next/source/lib/fancybox/.git/objects/ac/97c2cc9f61c52753abe4174a4a74b2064e5af0","hash":"272e74036b0612de83d9d0aa9604d3edf888b249","modified":1597030573266},{"_id":"themes/next/source/lib/fancybox/.git/objects/ad/569256343419017e8832a38faaa1c786716a1d","hash":"0538e4abd112b0a843035f28a511edabbe73f2ce","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/b3/b3098638624b56be968573e2dab1684f8a7f06","hash":"6fa11a2d904dff2b8f4ae1bd88bdbb66736438a1","modified":1597030571930},{"_id":"themes/next/source/lib/fancybox/.git/objects/b6/c361c8dcf2f5a7572e81b956272e4cfe1198c1","hash":"3e160c605dbd94dcef2b9692a4a5a82bddb76264","modified":1597030571478},{"_id":"themes/next/source/lib/fancybox/.git/objects/c2/fc5def1b6c38369e5e8b849adb956bd79b549e","hash":"27f03b9616e615b2724bac0fa4507d152697f3f1","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/bd/e1f741357b44b49290d43fdd193125202fef81","hash":"9beefc75cc0c37d04e98dd13b51ad85df40e77b9","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/ce/c0e316bee5d497ee834dbd29e0c5aad8331052","hash":"3d769fa5f55014841d10bb3bdf1b9725c43e9043","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/objects/d5/d10f6be62acc10fec6e11e8dc4affe1184a17b","hash":"cec51b2539349d2aba1ec5d11eaded3815eccdc5","modified":1597030571938},{"_id":"themes/next/source/lib/fancybox/.git/objects/f6/bb280a0b2c68256a8e906b35c6976c80c1b3be","hash":"5daaee11fc384fbe0f02c7123036c954ee9a73fd","modified":1597030571438},{"_id":"themes/next/source/lib/fancybox/.git/refs/heads/master","hash":"0b56bdb897316a3b4ec6c120673249f65f4cb420","modified":1597030573686},{"_id":"themes/next/source/lib/canvas-nest/.git/logs/refs/heads/master","hash":"23659fee9ab0cc6e66a7d424f0e29fc47d5d8b80","modified":1596510798218},{"_id":"themes/next/source/lib/canvas-nest/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1596510798218},{"_id":"themes/next/source/lib/fancybox/.git/logs/refs/heads/master","hash":"5166fe518f374116dc0f064fd7d225cfedbee3d1","modified":1597030573686},{"_id":"themes/next/source/lib/fancybox/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1597030573682},{"_id":"themes/next/source/lib/canvas-nest/.git/logs/refs/remotes/origin/HEAD","hash":"23659fee9ab0cc6e66a7d424f0e29fc47d5d8b80","modified":1596510798218},{"_id":"themes/next/source/lib/fancybox/.git/logs/refs/remotes/origin/HEAD","hash":"5166fe518f374116dc0f064fd7d225cfedbee3d1","modified":1597030573682},{"_id":"themes/next/source/images/QQ.png","hash":"b6849b3c5bcc6ea9aafd9ead10b494929f139e60","modified":1596611111298},{"_id":"themes/next/source/images/background2.jpeg","hash":"52e0d90a8d8f13bc692957bd6d8b71e5655075a5","modified":1596512311495},{"_id":"themes/next/source/images/messagepad.jpg","hash":"bde4952b2628e12213400bd16f7542dfa72a5ec4","modified":1596529719022},{"_id":"themes/next/source/images/zabbix01.png","hash":"d5d6d5f6814c5f7bc1303795c14cce9f47a88b91","modified":1597116413845},{"_id":"themes/next/source/images/zabbix02.png","hash":"188abc228cc18039e1951e90d3ccdc733f5c535f","modified":1597116422513},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1597030573702},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1596439782958},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1596439782962},{"_id":"themes/next/source/images/sword1.ico","hash":"1f0f4ae248c3e516ff032680aacc51121ba8ea69","modified":1597049944381},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1597030573702},{"_id":"themes/next/source/images/sword.ico","hash":"f489f8f2c7664a64b2076c20a713f9ab0cff3bb3","modified":1597049794862},{"_id":"themes/next/source/images/messagepad2.jpeg","hash":"2416825a60ab79237396bde4d430beb2162e15bd","modified":1596530260313},{"_id":"public/lib/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1597408229093},{"_id":"public/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1597408229093},{"_id":"public/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1597408229093},{"_id":"public/atom.xml","hash":"30a0b2fec77f604af94fef9a3d4d9f6d5312bfd8","modified":1615530281482},{"_id":"public/search.xml","hash":"12413fc1e51e97b4e353b36f8df0dcb703a57167","modified":1615530281482},{"_id":"public/404.html","hash":"d5eff1ff6b0f039704db95ff3e7f9ae94611fa1d","modified":1615530281482},{"_id":"public/about/index.html","hash":"5369b27993707bf90f354b673946b7891647dad5","modified":1615530281482},{"_id":"public/categories/index.html","hash":"8cfc04c0cf13ce5051216fa3b9f9fa258d8628b2","modified":1615530281482},{"_id":"public/messagepad/index.html","hash":"3ee55bdbc0c4188db405d81e9d6e0751d2da69d5","modified":1615530281482},{"_id":"public/sitemap/index.html","hash":"afcad50f1af2353816d5c5d75066822c2487c345","modified":1615530281482},{"_id":"public/tags/index.html","hash":"8ce204d0710874ec58284bdbe30533913e828ac3","modified":1615530281482},{"_id":"public/lib/jquery_lazyload/README.html","hash":"88595bb08b2b95d7773969639986f9f9e25f41ab","modified":1615530281482},{"_id":"public/PostgreSQL/pg13_notice/index.html","hash":"4ee0ee3ca0e9a03833897b28cd6a8ec78ae83418","modified":1599122019894},{"_id":"public/PostgreSQL/unbutu_PostgreSQL_postgis_install/index.html","hash":"b77eba9075f32c7887c897595096d1f4a41824ab","modified":1615530281482},{"_id":"public/PostgreSQL/PostgreSQL_install_from_source/index.html","hash":"8bf277cd2986cffe54111c766650dae05946875d","modified":1615530281482},{"_id":"public/个人记录/麻雀/index.html","hash":"d24f22619e7123da74d75e7936bf18954769de69","modified":1597909170404},{"_id":"public/zabbix/zabbix编译安装/index.html","hash":"75b02a754870cf36c7333006b45422dd8ab82c7d","modified":1615530281482},{"_id":"public/PostgreSQL/psql显示风格设置/index.html","hash":"d4a6ac7d3aa03182b2ffe749242620d5b169de70","modified":1615530281482},{"_id":"public/PostgreSQL/PostgreSQL用户权限/index.html","hash":"88b89a23dabbd5383e083715a453d8f03151a159","modified":1615530281482},{"_id":"public/PostgreSQL/PostgreSQL两阶段事物提交/index.html","hash":"b3bb2dda2783707b962269d10d3c0252ff476c03","modified":1615530281482},{"_id":"public/Linux/softdog/index.html","hash":"c499811958b762b2ad5c07e1803790e761d9481c","modified":1615530281482},{"_id":"public/python/Python小技巧/index.html","hash":"6112e1716a9ab798b6ea6303a5f72be13ad6868d","modified":1615530281482},{"_id":"public/PostgreSQL/PostgreSQL行列转换/index.html","hash":"c97b35d0f450015385c1a6932067870309013846","modified":1615530281482},{"_id":"public/hexo/利用Github分支备份Hexo博客源文件/index.html","hash":"fe1b956832d86ee5e0f646240c8e2b857c23c61e","modified":1615530281482},{"_id":"public/python/微信聊天自动回复机器人/index.html","hash":"8f3fc5bcba1d3529926f97dc678b50d2277d35a0","modified":1615530281482},{"_id":"public/uncategorized/hello-world/index.html","hash":"a3adc38763a544f015fcaf1be52ee549c2c6515c","modified":1615530281482},{"_id":"public/数据库/PostgreSQL有用的SQL/index.html","hash":"73f7a22ddbb4998d33d4c8ced790b9afef69fa66","modified":1615530281482},{"_id":"public/vim/linux配置vim/index.html","hash":"c89adb6383addf6a9370e4844dc61462cb7b7220","modified":1615530281482},{"_id":"public/archives/index.html","hash":"a1b8ca688465d575131dbe8e2e24acbf71204b3f","modified":1615530281482},{"_id":"public/archives/page/2/index.html","hash":"5bb8d00277c346e54961e2a3bb33cb0ad8b95605","modified":1615530281482},{"_id":"public/archives/2019/index.html","hash":"139564ba5cb392b8cba48899fec15aa6d700efc6","modified":1615530281482},{"_id":"public/archives/2019/04/index.html","hash":"1d3ca160cefe6b3f06d4e09efe1e90f437c1d566","modified":1615530281482},{"_id":"public/archives/2020/index.html","hash":"c839985648e2cc1120785a05bc49696c2e536a8c","modified":1615530281482},{"_id":"public/archives/2020/page/2/index.html","hash":"7b0d5dc2867aebd6988c6c7b3898b992d9ef1444","modified":1615530281482},{"_id":"public/archives/2020/07/index.html","hash":"ce8a2e604d52afe8450a43435d452b618de34d31","modified":1615530281482},{"_id":"public/archives/2020/08/index.html","hash":"2bcaacf1bbf6b4e89cd6063f110f36d190fdaada","modified":1615530281482},{"_id":"public/archives/2020/08/page/2/index.html","hash":"2db066394bee9ed4456e0887a28c6d5df2ed14ca","modified":1615530281482},{"_id":"public/categories/PostgreSQL/index.html","hash":"1ad5e16a09db80e4987739dce11e50c42fece268","modified":1615530281482},{"_id":"public/categories/python/index.html","hash":"8a9055ec04070b7067a48b29096a7406c05a9456","modified":1615530281482},{"_id":"public/categories/vim/index.html","hash":"b98e142b0f80f1433f131d78078b51a25b911344","modified":1615530281482},{"_id":"public/categories/Linux/index.html","hash":"12e4d2b87a3e9b6744c7e6114f66fdc18f9013e8","modified":1615530281482},{"_id":"public/categories/zabbix/index.html","hash":"597b15d33d292e18454660870e937a22dd901d1f","modified":1615530281482},{"_id":"public/categories/hexo/index.html","hash":"64bcb2557c73479d1bf3954034ef654e8c76fc5e","modified":1615530281482},{"_id":"public/categories/个人记录/index.html","hash":"690e85bc6000e8d918858c7e5cd54c52d87bd0b6","modified":1615530281482},{"_id":"public/categories/数据库/index.html","hash":"5fb7af6ee0507d27db16aeaa2559747361093061","modified":1615530281482},{"_id":"public/index.html","hash":"afe221823486afefab582b4f7bef1ca84f72220d","modified":1615530281482},{"_id":"public/page/2/index.html","hash":"e127d7a32cacc816b75de4f378cca3a215b07e72","modified":1615530281482},{"_id":"public/page/3/index.html","hash":"f23768ef537c068ae28a98608288f19926991737","modified":1615530281482},{"_id":"public/page/4/index.html","hash":"bbfe8102ed5f3aef27fce2425ac2d33c501c5541","modified":1615530281482},{"_id":"public/tags/postgres/index.html","hash":"3901c419445c73a3df13bc40dcfaae75e74d9609","modified":1615530281482},{"_id":"public/tags/pg/index.html","hash":"d13c7b1c5f0e6a9b8fb448008b164417247051e6","modified":1615530281482},{"_id":"public/tags/install/index.html","hash":"9615b2e0d5fcdb2af08ed881dad1794873f75f82","modified":1615530281482},{"_id":"public/tags/source/index.html","hash":"a67ae47cd52fc79b8c94c3fa13c9a061fdbfc87f","modified":1615530281482},{"_id":"public/tags/postgresql/index.html","hash":"91e4395b3e3743b077860d15c0c4ad314565c9f7","modified":1615530281482},{"_id":"public/tags/PostgreSQL/index.html","hash":"4fa8fa96d5ed25b7d78b95dffb2fb316746959f0","modified":1615530281482},{"_id":"public/tags/2pc/index.html","hash":"96915913562916e4298a20197d45532b8cfe17eb","modified":1615530281482},{"_id":"public/tags/role/index.html","hash":"fde311c5542c13c2bbe155a4077aaf6783fcd31c","modified":1615530281482},{"_id":"public/tags/权限/index.html","hash":"d586c8f4eeb76667b780c916f89ad2479823c4e3","modified":1615530281482},{"_id":"public/tags/行列转换/index.html","hash":"08adf7e79100c751da76f24f4131b5096a4816b7","modified":1615530281482},{"_id":"public/tags/LATERAL/index.html","hash":"45cc4b9a8eced10d3e75378f82034100482d2aaf","modified":1615530281482},{"_id":"public/tags/自连接/index.html","hash":"9328b1f34604257589c78f19a99e2de2832fea4d","modified":1615530281482},{"_id":"public/tags/python/index.html","hash":"ae57ca1bcfec49e87ac3cb5f7c87ac679af1a53b","modified":1615530281482},{"_id":"public/tags/Linux/index.html","hash":"198adb2e28da84f66475f12ce8f48e2c9a1609bc","modified":1615530281482},{"_id":"public/tags/vim/index.html","hash":"2c6f5eb70fb19a3ac95f5ff832f8b9bd013dace5","modified":1615530281482},{"_id":"public/tags/git/index.html","hash":"edf8bb8eaa925a5af4d52c4593f4f06ac4a720cd","modified":1615530281482},{"_id":"public/tags/postgresql-git/index.html","hash":"a15431fae2b7f0543317e2194271adab05bd27ee","modified":1615530281482},{"_id":"public/tags/psql/index.html","hash":"7437fe03b059aa2eeeaff5e230c3a5907bb425f1","modified":1615530281482},{"_id":"public/tags/softdog/index.html","hash":"c51ad4ded3ee9231169fa91e185d53684dbecf2e","modified":1615530281482},{"_id":"public/tags/watchdog/index.html","hash":"37471d964f4b1674d4d0fff10bbd98d7a18aaf17","modified":1615530281482},{"_id":"public/tags/postgis/index.html","hash":"ed1234405e8b7688defb189e4c074b55e375f183","modified":1615530281482},{"_id":"public/tags/geo/index.html","hash":"c95117c887fc842318ed95840122a2ab86a21d21","modified":1615530281482},{"_id":"public/tags/gis/index.html","hash":"5520b8838b202310861dd1f6b8968b033e1c672c","modified":1615530281482},{"_id":"public/tags/zabbix/index.html","hash":"d2ea5231995a11a4af078ca79d63031a54c7ce9e","modified":1615530281482},{"_id":"public/tags/hexo/index.html","hash":"d01045f8c1cc37c60d1e18b35dcf377dddd006c1","modified":1615530281482},{"_id":"public/tags/github/index.html","hash":"eb6c87643404d675989e6c5d59af615613ae9dde","modified":1615530281482},{"_id":"public/tags/robot/index.html","hash":"43d0bd71b84e7e0af7ec8e5d713bffe6c4fdecaf","modified":1615530281482},{"_id":"public/tags/微信自动回复/index.html","hash":"eeab091d369948cadfe697c0d6f9007c4eb8283c","modified":1615530281482},{"_id":"public/tags/personal/index.html","hash":"02ca413db96cd17f310c2ea3322cea67867a33ba","modified":1615530281482},{"_id":"public/tags/DBA/index.html","hash":"53e24eeb51195a6a8207bcf766cc25df053a1fe7","modified":1615530281482},{"_id":"public/tags/SQL/index.html","hash":"c5a25ebcb52b653df1aa1ae6330a2be2dcecb162","modified":1615530281482},{"_id":"public/README.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1597408229093},{"_id":"public/fonts/chinese-zodiac.eot","hash":"e3ea84e00f4fae1bbf157650ed09000299ea8c7b","modified":1597408229093},{"_id":"public/fonts/chinese-zodiac.woff","hash":"bf8137ae4b8a1e11bc5480ba5af2d44244d13f99","modified":1597408229093},{"_id":"public/fonts/chinese-zodiac.woff2","hash":"96af181d987ecc97bf9f1fe12df883102bdc18a4","modified":1597408229093},{"_id":"public/lib/jquery_lazyload/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1597408229093},{"_id":"public/user.jpg","hash":"c5544a049921ee5de0d97a4a17ae1fa7951af9c1","modified":1597408229093},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1597408229093},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1597408229093},{"_id":"public/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1597408229093},{"_id":"public/images/alipay.png","hash":"8ad703b62bb310b21dbb320993302726b0508427","modified":1597408229093},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1597408229093},{"_id":"public/images/background1.jpeg","hash":"7ed0a8faf2db3927ab2f57977cdf58075cd7a7c2","modified":1597408229093},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1597408229093},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1597408229093},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1597408229093},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1597408229093},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1597408229093},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1597408229093},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1597408229093},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1597408229093},{"_id":"public/images/favicon.ico","hash":"aaad3ca3c9194649d8a40e08ecb22f7c252cf187","modified":1597408229093},{"_id":"public/images/favicon2.png","hash":"a7ff12fde93adb2e0d27dc05b074f590b782a208","modified":1597408229093},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1597408229093},{"_id":"public/images/user.jpg","hash":"c5544a049921ee5de0d97a4a17ae1fa7951af9c1","modified":1597408229093},{"_id":"public/images/wechatpay.png","hash":"c12e730178060b0d9c6c22b930c491ec8101072d","modified":1597408229093},{"_id":"public/lib/canvas-nest/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1597408229093},{"_id":"public/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1597408229093},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1597408229093},{"_id":"public/live2dw/assets/haruto.model.json","hash":"76f915f7edbd9c47df0ca041dddb151c0c93a2bf","modified":1597408229093},{"_id":"public/live2dw/assets/haruto.physics.json","hash":"2fbf886979212357ba293bd35884f2cb5b26b6a6","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/01.mtn","hash":"61d7d590d9feb71b32fd6bd142b59410d75bc1fa","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/02.mtn","hash":"efc99efdff39c93372cff0f6d62c4e748e1a5593","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/03.mtn","hash":"a72b697a92a7cff40d15774b143b465b34cee5e6","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/04.mtn","hash":"32c888667455a3ff6f1b04f910c1a5cc4de30af0","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/05.mtn","hash":"637e00442da4042cd4b0ed2cc62ffb1559881814","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/06.mtn","hash":"df10cc1d333c96da1296a4853c1ddbd44d8a11f3","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/07.mtn","hash":"d8c9410135c81604eba665b59808089808e0851a","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/09.mtn","hash":"ecf1283b72e1c4b7e3a97343cd97726813f18790","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/08.mtn","hash":"9b95ef8548b979d1fca557c74f8d66fb15b34578","modified":1597408229093},{"_id":"public/live2dw/assets/mtn/idle_02.mtn","hash":"d130dd1d194f05b3eb5391289b0339999e37c3a6","modified":1597408229093},{"_id":"public/live2dw/lib/L2Dwidget.min.js","hash":"5f1a807437cc723bcadc3791d37add5ceed566a2","modified":1597408229093},{"_id":"public/images/QQ.png","hash":"b6849b3c5bcc6ea9aafd9ead10b494929f139e60","modified":1597408229093},{"_id":"public/images/background2.jpeg","hash":"52e0d90a8d8f13bc692957bd6d8b71e5655075a5","modified":1597408229093},{"_id":"public/images/zabbix01.png","hash":"d5d6d5f6814c5f7bc1303795c14cce9f47a88b91","modified":1597408229093},{"_id":"public/images/zabbix02.png","hash":"188abc228cc18039e1951e90d3ccdc733f5c535f","modified":1597408229093},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1597408229093},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1597408229093},{"_id":"public/live2dw/lib/L2Dwidget.min.js.map","hash":"3290fe2df45f065b51a1cd7b24ec325cbf9bb5ce","modified":1597408229093},{"_id":"public/images/messagepad.jpg","hash":"bde4952b2628e12213400bd16f7542dfa72a5ec4","modified":1597408229093},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js","hash":"35bb5b588b6de25c9be2dd51d3fd331feafac02d","modified":1597408229093},{"_id":"public/lib/canvas-nest/README.html","hash":"4e20cd8831f1cce4864388a8ac0966b5f7a59cfd","modified":1597408229093},{"_id":"public/lib/fancybox/README.html","hash":"fffc1380e58ba6c3b354598af4c8628838b8836c","modified":1597408229093},{"_id":"public/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1597408229093},{"_id":"public/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1597408229093},{"_id":"public/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1597408229093},{"_id":"public/js/bubble.js","hash":"5a4227d3f6d084148102f31b9add45faa62604f2","modified":1597408229093},{"_id":"public/js/love.js","hash":"d2cb21e05c635a0bbbbb4dd6a37bd63506588fa3","modified":1597408229093},{"_id":"public/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1597408229093},{"_id":"public/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1597408229093},{"_id":"public/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1597408229093},{"_id":"public/js/cursor/cherry.js","hash":"569e23e279f87b0dfef8eea6c5992a8aa610f663","modified":1597408229093},{"_id":"public/js/cursor/explosion.min.js","hash":"233e9a9ed0e8aa4799bfbe02899f0c34f9af5a7b","modified":1597408229093},{"_id":"public/js/schemes/busuanzi.pure.mini.js","hash":"6e41f31100ae7eb3a6f23f2c168f6dd56e7f7a9a","modified":1597408229093},{"_id":"public/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1597408229093},{"_id":"public/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1597408229093},{"_id":"public/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"956eada198babd00f028e8908767cb158926c3f3","modified":1597408229093},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1597408229093},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1597408229093},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1597408229093},{"_id":"public/images/sword.ico","hash":"f489f8f2c7664a64b2076c20a713f9ab0cff3bb3","modified":1597408229093},{"_id":"public/live2dw/assets/moc/haruto.2048/texture_00.png","hash":"62b970aa1480a1c18bdc4e74e297f2a1b34ca9fa","modified":1597408229093},{"_id":"public/css/main.css","hash":"6d310956091a1099365aa7b30b42f1a076cb4848","modified":1597408229093},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1597408229093},{"_id":"public/live2dw/assets/moc/haruto.moc","hash":"57bec0b245b49ea941d61ba3dee671f20441afae","modified":1597408229093},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"f3e8c5312298b446ded8992fb80bc0362483e1dc","modified":1597408229093},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1597408229093},{"_id":"public/images/sword1.ico","hash":"1f0f4ae248c3e516ff032680aacc51121ba8ea69","modified":1597408229093},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1597408229093},{"_id":"public/images/messagepad2.jpeg","hash":"2416825a60ab79237396bde4d430beb2162e15bd","modified":1597408229093},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1597408229093},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1597408229093},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js.map","hash":"35e71cc2a130199efb167b9a06939576602f0d75","modified":1597408229093},{"_id":"source/_posts/The_two_kinds_of_stats_in_PostgreSQL.md","hash":"76acd5f58a296d01a8a8fd6c86a66b7f936725cd","modified":1597648722987},{"_id":"public/uncategorized/The_two_kinds_of_stats_in_PostgreSQL/index.html","hash":"95932a3b943da00342ebdf1cc35745d2a727f12b","modified":1597648514147},{"_id":"public/PostgreSQL/The_two_kinds_of_stats_in_PostgreSQL/index.html","hash":"3c3ed2290b893d4570fce959095e29f438b71b86","modified":1615530281482},{"_id":"public/tags/stat/index.html","hash":"6e3a0ef446f1845f117f6fbc2197555eb494f603","modified":1615530281482},{"_id":"source/_posts/pg_hint_plan.md","hash":"3a8a42757e2c08ed7d8cb8e3259cd4f6b9eb5c15","modified":1597734906547},{"_id":"public/uncategorized/pg_hint_plan/index.html","hash":"caed5caea3443d8ddc223eaa177ac67f62dfae43","modified":1597732497865},{"_id":"public/PostgreSQL/pg_hint_plan/index.html","hash":"527da7a6585ffc6335ea7e223c1402b4167b9342","modified":1615530281482},{"_id":"public/tags/pg-hint-plan/index.html","hash":"b47732d75dae44a5e95f83c82a722befdff3ebc5","modified":1615530281482},{"_id":"source/_posts/Linux_cmd_summary.md","hash":"b428ffad7ed910a9ec79d8eca7322bd842d1563b","modified":1615435718292},{"_id":"source/_posts/PostgreSQL_backend_process.md","hash":"5ed2f68f8c8fd4a0d1ca3622dba1ad4c118822b2","modified":1598521101934},{"_id":"public/uncategorized/Linux_cmd_summary/index.html","hash":"44657a079885270fc84ce42e5ae3c8b5d24f808d","modified":1599481561085},{"_id":"public/PostgreSQL/PostgreSQL_backend_process/index.html","hash":"1e0d8d5f180c4a8f8edef14138f11e980c8e7c42","modified":1615530281482},{"_id":"source/_posts/PostgreSQL_Buffer_Manager.md","hash":"8d32cb15ed0be757e8c2f4fd43eaf3809bf3d309","modified":1597909898027},{"_id":"themes/next/source/images/pg_buffer_manager_2.png","hash":"c52dcd1a4eb59b424f6b996efa49fa34b8541f12","modified":1597894273999},{"_id":"themes/next/source/images/pg_buffer_manager_3.png","hash":"91835c69b23de8e9038906d2ddfb2e85dc547802","modified":1597894551556},{"_id":"themes/next/source/images/pg_buffer_manager_4.png","hash":"c26c8a7667259c3a7f80b0088c9979d09b4c0336","modified":1597894639273},{"_id":"themes/next/source/images/pg_buffer_manager.png","hash":"b6869a4e4b39dbb01814be2609dfb6324a7e422d","modified":1597893759727},{"_id":"public/uncategorized/PostgreSQL_Buffer_Manager/index.html","hash":"37ac5345345b1aec56d3359205974f3fb11df99d","modified":1597894787330},{"_id":"public/archives/page/3/index.html","hash":"8fd8e141fba0d1e96f1a107dc1426342401990cf","modified":1615530281482},{"_id":"public/page/5/index.html","hash":"b14934db72ecb72b906a95ef19ccdeab30aa7b77","modified":1615530281482},{"_id":"public/images/pg_buffer_manager.png","hash":"b6869a4e4b39dbb01814be2609dfb6324a7e422d","modified":1597894787330},{"_id":"public/images/pg_buffer_manager_3.png","hash":"91835c69b23de8e9038906d2ddfb2e85dc547802","modified":1597894787330},{"_id":"public/images/pg_buffer_manager_2.png","hash":"c52dcd1a4eb59b424f6b996efa49fa34b8541f12","modified":1597894787330},{"_id":"public/images/pg_buffer_manager_4.png","hash":"c26c8a7667259c3a7f80b0088c9979d09b4c0336","modified":1597894787330},{"_id":"public/PostgreSQL/PostgreSQL_Buffer_Manager/index.html","hash":"6466a6d43ca16484211cf846d21919a2459e130d","modified":1615530281482},{"_id":"public/categories/PostgreSQL/page/2/index.html","hash":"af4f02462dea1bd5ace1334bf157802edb67b49c","modified":1615530281482},{"_id":"public/tags/PostgreSQL/page/2/index.html","hash":"9e8979c733eed566094f9e5bdcee07f3c6891354","modified":1615530281482},{"_id":"public/tags/buffer/index.html","hash":"49295f310ea9bd87f08e0c3f4e6091c551588681","modified":1615530281482},{"_id":"themes/next/source/images/pg_buffer_manager_5.png","hash":"b7f03464671b81f178173b25cb0d4ce6e9eba2e0","modified":1597895711438},{"_id":"themes/next/source/images/pg_buffer_manager_6.png","hash":"8e27d48dc668041f344fdd86bed7f8f7a433396c","modified":1597895908472},{"_id":"themes/next/source/images/pg_buffer_manager_7.png","hash":"3d25c438add79fd45c5010199b4ee4bcee4d30a3","modified":1597896080217},{"_id":"themes/next/source/images/pg_buffer_manager_8.png","hash":"37930643b0f4c6cbda0dac073d88f01834c24e4d","modified":1597896511692},{"_id":"themes/next/source/images/pg_buffer_manager_9.png","hash":"cec59334b7d343f43978fccb25db9128c296933a","modified":1597896632461},{"_id":"themes/next/source/images/pg_buffer_manager_10.png","hash":"348dd5beded379c30a55cf8cb09f5042382f99a2","modified":1597896762630},{"_id":"public/images/pg_buffer_manager_6.png","hash":"8e27d48dc668041f344fdd86bed7f8f7a433396c","modified":1597896944838},{"_id":"public/images/pg_buffer_manager_5.png","hash":"b7f03464671b81f178173b25cb0d4ce6e9eba2e0","modified":1597896944838},{"_id":"public/images/pg_buffer_manager_7.png","hash":"3d25c438add79fd45c5010199b4ee4bcee4d30a3","modified":1597896944838},{"_id":"public/images/pg_buffer_manager_8.png","hash":"37930643b0f4c6cbda0dac073d88f01834c24e4d","modified":1597896944838},{"_id":"public/images/pg_buffer_manager_9.png","hash":"cec59334b7d343f43978fccb25db9128c296933a","modified":1597896944838},{"_id":"public/images/pg_buffer_manager_10.png","hash":"348dd5beded379c30a55cf8cb09f5042382f99a2","modified":1597896944838},{"_id":"source/_posts/有用的连接.md","hash":"221bf13459ef25c7ab065f4e8593bf44fde52ce7","modified":1606823987917},{"_id":"public/个人记录/有用的连接/index.html","hash":"e97552defb8f7df638649910e30ad17de1c3c49d","modified":1615530281482},{"_id":"source/_posts/PostgreSQL_vacuum.md","hash":"e1c20d76d1f6668bf834dc25ebe70c3d627cc92f","modified":1597923310487},{"_id":"public/PostgreSQL/PostgreSQL_vacuum/index.html","hash":"c51051d03f11ca9286b7365f05dde0e51c31ea9d","modified":1615530281482},{"_id":"public/archives/2020/page/3/index.html","hash":"568478d9633561ec7860d8e180f5af31f8107c03","modified":1615530281482},{"_id":"public/tags/vacuum/index.html","hash":"83df9c69e4a870699cc819907734040542665ea4","modified":1615530281482},{"_id":"themes/next/source/images/A_example_of_the_process_architecture_in_PostgreSQL.png","hash":"0c781f9434f6b43d5670fcaf3baab3e198bb06bd","modified":1598520110758},{"_id":"public/images/A_example_of_the_process_architecture_in_PostgreSQL.png","hash":"0c781f9434f6b43d5670fcaf3baab3e198bb06bd","modified":1598520197472},{"_id":"public/tags/backend/index.html","hash":"29b1e826b867cc9e891a95fd49c707370653852f","modified":1615530281482},{"_id":"public/tags/Architecture/index.html","hash":"83807e66240f52fe97b8691c649ac9f9abdb8be0","modified":1615530281482},{"_id":"source/_posts/pg14_git_log.md","hash":"83308c90d8468f9c267f061144ada7bcdb53ddc8","modified":1599205523941},{"_id":"public/PostgreSQL/pg14_git_log/index.html","hash":"07048170388fc931b01ee181133cd94c7e86e19b","modified":1615530281482},{"_id":"source/_posts/get_partition_table_valus.md","hash":"4ed043abaa064b4dd4108ee2318222e425a12304","modified":1599478287732},{"_id":"public/PostgreSQL/get_partition_table_valus/index.html","hash":"02cfde774496de67e1ca2b583a6b08655d151a41","modified":1599478293538},{"_id":"public/archives/2020/09/index.html","hash":"04074bf2b766a4d045fc260cece5af06c16670a4","modified":1615530281482},{"_id":"public/tags/hash-key/index.html","hash":"fee0dc027a9db8a60c550cf869ca22a70835c33e","modified":1615530281482},{"_id":"public/tags/partition-table/index.html","hash":"6099c7e6ee500e3d628f6f0200019595ad848b33","modified":1615530281482},{"_id":"source/_posts/get_partition_table_value.md","hash":"96c6e5e974112e11ca8beaef6318d285eb03fb0a","modified":1599478497126},{"_id":"public/PostgreSQL/get_partition_table_value/index.html","hash":"cd39307ca4ebd4ee41b7985365201738263c635f","modified":1615530281482},{"_id":"public/Linux/Linux_cmd_summary/index.html","hash":"b48048e40ea65be25822d3b8f802b4a156fe0ec6","modified":1615530281482},{"_id":"public/tags/command/index.html","hash":"3293d4f96c4da3171d5a2e1f0224b51beba5820f","modified":1615530281482},{"_id":"source/_posts/python3_ldap验证.md","hash":"6f2922cffc7da09d2ece2cf05ad5f29131b83666","modified":1608284735015},{"_id":"public/python/python3_ldap验证/index.html","hash":"5837adbba2f4fbc0991c82a18d7e1bf6e4960dd0","modified":1615530281482},{"_id":"public/archives/2020/12/index.html","hash":"65b53c6278edd9bd0fa1aa9161105bf5fada1dd6","modified":1615530281482},{"_id":"public/tags/python3/index.html","hash":"6121230a8ad5b6cef26cf1119b583f4164645f3b","modified":1615530281482},{"_id":"public/tags/ldap/index.html","hash":"a3356b5bae5ffef76cef0a166a47130ee8631252","modified":1615530281482},{"_id":"source/_posts/Postgis常用函数.md","hash":"5e279b73b4d9a2ac6d8b038d2626a0fe9f6d879c","modified":1608796067919},{"_id":"public/PostgreSQL/gis/Postgis/Postgis常用函数/index.html","hash":"4c34d66d1fb433b62e493d1248654f2ef87f1d7b","modified":1615530281482},{"_id":"public/categories/PostgreSQL/gis/index.html","hash":"46e3cd3bda723a80ad8b6105e94f51268da5e780","modified":1615530281482},{"_id":"public/categories/PostgreSQL/gis/Postgis/index.html","hash":"d0afdff32b26a2583ddd57bcc388c1cb3b7816fe","modified":1615530281482},{"_id":"source/_posts/PostgreSQL_git_log.md","hash":"007299bd0f480015f2ffb846391383c2774d8a48","modified":1615447527103},{"_id":"public/PostgreSQL/PostgreSQL_git_log/index.html","hash":"c3ffc3f8bdaf29945c6af5212093d96327786d69","modified":1615530281482},{"_id":"public/archives/2021/index.html","hash":"eb2ee7ca11a8741a3b60d1254fe7d7d7352733f7","modified":1615530281482},{"_id":"public/archives/2021/01/index.html","hash":"ba9ad55b464dc51a2b2c34d536ddc749198b328e","modified":1615530281482},{"_id":"public/page/6/index.html","hash":"c5f89ec86423dbd25480ebe5b748b7795328a4f5","modified":1615530281482},{"_id":"public/tags/commit-log/index.html","hash":"59a8e3710b7361186cdb8ba6917108d4f0f69549","modified":1615530281482},{"_id":"source/_posts/PostgreSQL开发指南.md","hash":"f3b97aa8d93023f399c323a8083982ba101b82ef","modified":1614245479534},{"_id":"public/uncategorized/PostgreSQL开发指南/index.html","hash":"197a2c02258167a48fe52c5c4f7fb42f23a97096","modified":1614244732457},{"_id":"public/archives/2021/02/index.html","hash":"e09606f1f845f4d818e9465041fc133e183a67ef","modified":1615530281482},{"_id":"public/PostgreSQL/PostgreSQL开发指南/index.html","hash":"92a73819a68b3867ce6f49d90672d505107b25f1","modified":1615530281482},{"_id":"public/tags/开发指南/index.html","hash":"83069e873c121bf05d5b2f16731a06de3ab1d714","modified":1615530281482},{"_id":"source/_posts/Next主题配置.md","hash":"6588575d8db95aa3c9d260a63201d3e72ca050e6","modified":1614932740037},{"_id":"source/_posts/test.md","hash":"e277178e9a6133ae1ff6c95c41c640aa802a10c9","modified":1614932740037},{"_id":"public/uncategorized/Next主题配置/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1614933016238},{"_id":"public/uncategorized/test/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1614933016238},{"_id":"public/archives/1970/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1614933016238},{"_id":"public/archives/1970/01/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1614933016238},{"_id":"public/tags/hexo-hothub/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1614933016238},{"_id":"themes/next/source/js/Valine.min.js","hash":"1fc891b7c4077c7e2964c9ac5f80c031f6e3ca95","modified":1614933539583},{"_id":"public/js/Valine.min.js","hash":"1fc891b7c4077c7e2964c9ac5f80c031f6e3ca95","modified":1614933600080},{"_id":"source/_posts/PostgreSQL_docker.md","hash":"cb42979a343fe770aed25cc1dda6669ada8bd293","modified":1615530272140},{"_id":"public/PostgreSQL/docker/PostgreSQL_docker/index.html","hash":"a6a5085f0b7d4e5381d19d75d9eaee085f154157","modified":1615530281482},{"_id":"public/archives/2021/03/index.html","hash":"ed57ae50490a219dc59a583f34669c319e296f26","modified":1615530281482},{"_id":"public/categories/PostgreSQL/docker/index.html","hash":"82d6dd7f98a86457eca6f988418b0c5df393debc","modified":1615530281482},{"_id":"public/tags/docker/index.html","hash":"04536ac2ac0a09116e99473d81e201dc6bd9f0c1","modified":1615530281482},{"_id":"source/_posts/docker_command.md","hash":"32fba0abd2a2f342101099c139dd03d4cfdb9e03","modified":1615453111580},{"_id":"public/docker/docker_command/index.html","hash":"8a2f145802e8d9fa43a1c84de64b25cca2693caa","modified":1615530281482},{"_id":"public/categories/docker/index.html","hash":"12cc7c183b8eba623e24191f645fc2acd612b292","modified":1615530281482},{"_id":"source/_posts/PostgreSQL_refcursor.md","hash":"dd71319e56bc66105e08316293299126dff0b62b","modified":1615529900905},{"_id":"public/PostgreSQL/cursor/refcursor/PostgreSQL_refcursor/index.html","hash":"0d9899d623dd1350454f56d06361cfc470284a28","modified":1615530281482},{"_id":"public/categories/PostgreSQL/cursor/index.html","hash":"a05eb3d4ffc041031e3589abbe95ada1979f26ca","modified":1615530281482},{"_id":"public/categories/PostgreSQL/cursor/refcursor/index.html","hash":"ac1a7bac6c74a7c3223edcda4749128fec208665","modified":1615530281482},{"_id":"public/tags/cursor/index.html","hash":"4b6b7680f8ba9efabc3ae022700e0cdec969f3e6","modified":1615530281482},{"_id":"public/tags/refcursor/index.html","hash":"e12e6f85b1c95cd838836813e74142ebd1537a72","modified":1615530281482}],"Category":[{"name":"PostgreSQL","_id":"ckdu7m6us0004yreb6azcgugx"},{"name":"python","_id":"ckdu7m6v7000qyrebhrba46aj"},{"name":"vim","_id":"ckdu7m6vd000xyrebfoxu9fnk"},{"name":"Linux","_id":"ckdu7m6vf0013yreb16lpcpa6"},{"name":"zabbix","_id":"ckdu7m6vh0019yreba44c8mbh"},{"name":"hexo","_id":"ckdu7m6vj001fyreb95de03ez"},{"name":"个人记录","_id":"ckdu7m6vk001lyreb6bs4fjdl"},{"name":"数据库","_id":"ckdu7m6wv003lyreb7ac6hedk"},{"name":"gis","parent":"ckdu7m6us0004yreb6azcgugx","_id":"ckj2jn71h0002n7eb559z7z73"},{"name":"Postgis","parent":"ckj2jn71h0002n7eb559z7z73","_id":"ckj2jn71o0005n7ebc3fnb3at"},{"name":"docker","parent":"ckdu7m6us0004yreb6azcgugx","_id":"ckm4mphh80002hmeb997038gm"},{"name":"docker","_id":"ckm4n2rh700011pebb66qa8fp"},{"name":"cursor","parent":"ckdu7m6us0004yreb6azcgugx","_id":"ckm5wshhc00022iebdaojb0e2"},{"name":"refcursor","parent":"ckm5wshhc00022iebdaojb0e2","_id":"ckm5wshhe00042ieb086i8eph"}],"Data":[{"_id":"styles","data":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}],"Page":[{"title":"404 Not Found：该页无法显示","toc":false,"comments":0,"_content":"<!DOCTYPE html>\n<html>\n    <head>\n         <meta charset=\"UTF-8\" />\n         <title>404</title>                                                                                                                                        \n    </head>\n    <body>\n         <script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\" homePageName=\"返回首页\" homePageUrl=\"https://daydayup863.github.io\"></script>\n\t</body>\n</html>\n","source":"404/index.html","raw":"---\ntitle: 404 Not Found：该页无法显示\ntoc: false\ncomments: false\npermalink: /404\n---\n<!DOCTYPE html>\n<html>\n    <head>\n         <meta charset=\"UTF-8\" />\n         <title>404</title>                                                                                                                                        \n    </head>\n    <body>\n         <script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\" homePageName=\"返回首页\" homePageUrl=\"https://daydayup863.github.io\"></script>\n\t</body>\n</html>\n","date":"2021-03-05T11:53:29.145Z","updated":"2021-03-05T11:53:29.141Z","path":"/404.html","_id":"ckdu7m6uh0000yreb2dmu3wr4","layout":"page","content":"<!DOCTYPE html>\n<html>\n    <head>\n         <meta charset=\"UTF-8\" />\n         <title>404</title>                                                                                                                                        \n    </head>\n    <body>\n         <script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\" homePageName=\"返回首页\" homePageUrl=\"https://daydayup863.github.io\"></script>\n\t</body>\n</html>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<!DOCTYPE html>\n<html>\n    <head>\n         <meta charset=\"UTF-8\" />\n         <title>404</title>                                                                                                                                        \n    </head>\n    <body>\n         <script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\" homePageName=\"返回首页\" homePageUrl=\"https://daydayup863.github.io\"></script>\n\t</body>\n</html>\n"},{"title":"about","date":"2020-08-04T03:55:44.000Z","comments":0,"_content":"\n# 基本信息\n目前所在城市：北京\n\n# 个人简介\nPostgreSQL DBA\n\n欢迎大家加入技术交流 QQ 群 939362327\n![QQ群](/images/QQ.png)\n\n","source":"about/index.md","raw":"---\ntitle: about\ndate: 2020-08-04 11:55:44\ncomments: false\n\n---\n\n# 基本信息\n目前所在城市：北京\n\n# 个人简介\nPostgreSQL DBA\n\n欢迎大家加入技术交流 QQ 群 939362327\n![QQ群](/images/QQ.png)\n\n","updated":"2021-03-05T08:30:47.555Z","path":"about/index.html","_id":"ckdu7m6up0002yreb94ocg8no","layout":"page","content":"<h1 id=\"基本信息\"><a href=\"#基本信息\" class=\"headerlink\" title=\"基本信息\"></a>基本信息</h1><p>目前所在城市：北京</p>\n<h1 id=\"个人简介\"><a href=\"#个人简介\" class=\"headerlink\" title=\"个人简介\"></a>个人简介</h1><p>PostgreSQL DBA</p>\n<p>欢迎大家加入技术交流 QQ 群 939362327<br><img data-src=\"/images/QQ.png\" alt=\"QQ群\"></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"基本信息\"><a href=\"#基本信息\" class=\"headerlink\" title=\"基本信息\"></a>基本信息</h1><p>目前所在城市：北京</p>\n<h1 id=\"个人简介\"><a href=\"#个人简介\" class=\"headerlink\" title=\"个人简介\"></a>个人简介</h1><p>PostgreSQL DBA</p>\n<p>欢迎大家加入技术交流 QQ 群 939362327<br><img data-src=\"/images/QQ.png\" alt=\"QQ群\"></p>\n"},{"title":"categories","date":"2020-08-03T02:45:27.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2020-08-03 10:45:27\ntype: \"categories\"\ncomments: false\n\n---\n","updated":"2021-03-05T08:30:47.555Z","path":"categories/index.html","_id":"ckdu7m6uu0006yreb4ksf7z87","layout":"page","content":"","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":""},{"title":"欢迎大家留言","_content":"![](/images/messagepad2.jpeg)\n<div class=\"ds-recent-visitors\" data-num-items=\"28\" data-avatar-size=\"42\" id=\"ds-recent-visitors\"></div>\n","source":"messagepad/index.md","raw":"---\ntitle: 欢迎大家留言\n---\n![](/images/messagepad2.jpeg)\n<div class=\"ds-recent-visitors\" data-num-items=\"28\" data-avatar-size=\"42\" id=\"ds-recent-visitors\"></div>\n","date":"2021-03-05T08:30:47.555Z","updated":"2021-03-05T08:30:47.555Z","path":"messagepad/index.html","_id":"ckdu7m6uv0008yreb7jjd8kew","comments":1,"layout":"page","content":"<p><img data-src=\"/images/messagepad2.jpeg\" alt=\"\"></p>\n<div class=\"ds-recent-visitors\" data-num-items=\"28\" data-avatar-size=\"42\" id=\"ds-recent-visitors\"></div>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<p><img data-src=\"/images/messagepad2.jpeg\" alt=\"\"></p>\n<div class=\"ds-recent-visitors\" data-num-items=\"28\" data-avatar-size=\"42\" id=\"ds-recent-visitors\"></div>\n"},{"title":"sitemap","date":"2020-08-04T03:55:56.000Z","_content":"","source":"sitemap/index.md","raw":"---\ntitle: sitemap\ndate: 2020-08-04 11:55:56\n---\n","updated":"2020-08-04T03:55:56.127Z","path":"sitemap/index.html","comments":1,"layout":"page","_id":"ckdu7m6uw000ayreb70msgxd0","content":"","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":""},{"title":"tags","date":"2020-08-03T02:34:59.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2020-08-03 10:34:59\ntype: \"tags\"\ncomments: false\n\n---\n","updated":"2021-03-05T08:30:47.555Z","path":"tags/index.html","_id":"ckdu7m6v0000eyreb7ccgb4rp","layout":"page","content":"","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":""},{"_content":"{\n  \"name\": \"jquery_lazyload\",\n  \"version\": \"1.9.4\",\n  \"homepage\": \"http://www.appelsiini.net/projects/lazyload\",\n  \"authors\": [\n    \"Mika Tuupola <tuupola@appelsiini.net>\"\n  ],\n  \"description\": \"jQuery plugin for lazy loading images\",\n  \"main\": [\n    \"jquery.lazyload.js\",\n    \"jquery.scrollstop.js\"\n  ],\n  \"license\": \"MIT\",\n  \"ignore\": [\n    \"**/.*\",\n    \"**/*.min.js\",\n    \"**/*.html\",\n    \"**/*.textile\",\n    \"Gruntfile.js\",\n    \"lazyload.jquery.json\",\n    \"package.json\",\n    \"node_modules\",\n    \"bower_components\",\n    \"test\",\n    \"img\"\n  ]\n}\n","source":"lib/jquery_lazyload/bower.json","raw":"{\n  \"name\": \"jquery_lazyload\",\n  \"version\": \"1.9.4\",\n  \"homepage\": \"http://www.appelsiini.net/projects/lazyload\",\n  \"authors\": [\n    \"Mika Tuupola <tuupola@appelsiini.net>\"\n  ],\n  \"description\": \"jQuery plugin for lazy loading images\",\n  \"main\": [\n    \"jquery.lazyload.js\",\n    \"jquery.scrollstop.js\"\n  ],\n  \"license\": \"MIT\",\n  \"ignore\": [\n    \"**/.*\",\n    \"**/*.min.js\",\n    \"**/*.html\",\n    \"**/*.textile\",\n    \"Gruntfile.js\",\n    \"lazyload.jquery.json\",\n    \"package.json\",\n    \"node_modules\",\n    \"bower_components\",\n    \"test\",\n    \"img\"\n  ]\n}\n","date":"2020-08-05T02:38:48.538Z","updated":"2020-08-05T02:38:48.538Z","path":"lib/jquery_lazyload/bower.json","layout":"false","title":"","comments":1,"_id":"ckdu7m6v2000gyreban49d5ay","content":"{\"name\":\"jquery_lazyload\",\"version\":\"1.9.4\",\"homepage\":\"http://www.appelsiini.net/projects/lazyload\",\"authors\":[\"Mika Tuupola <tuupola@appelsiini.net>\"],\"description\":\"jQuery plugin for lazy loading images\",\"main\":[\"jquery.lazyload.js\",\"jquery.scrollstop.js\"],\"license\":\"MIT\",\"ignore\":[\"**/.*\",\"**/*.min.js\",\"**/*.html\",\"**/*.textile\",\"Gruntfile.js\",\"lazyload.jquery.json\",\"package.json\",\"node_modules\",\"bower_components\",\"test\",\"img\"]}","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"{\"name\":\"jquery_lazyload\",\"version\":\"1.9.4\",\"homepage\":\"http://www.appelsiini.net/projects/lazyload\",\"authors\":[\"Mika Tuupola <tuupola@appelsiini.net>\"],\"description\":\"jQuery plugin for lazy loading images\",\"main\":[\"jquery.lazyload.js\",\"jquery.scrollstop.js\"],\"license\":\"MIT\",\"ignore\":[\"**/.*\",\"**/*.min.js\",\"**/*.html\",\"**/*.textile\",\"Gruntfile.js\",\"lazyload.jquery.json\",\"package.json\",\"node_modules\",\"bower_components\",\"test\",\"img\"]}"},{"_content":"<h1 align=\"center\"><a href=\"https://github.com/tuupola/jquery_lazyload\">jquery-lazyload</a> for <a href=\"https://github.com/theme-next\">NexT</a></h1>\n\n<h1 align=\"center\">Installation</h1>\n\n<h2 align=\"center\">Step 1 &rarr; Go to NexT dir</h2>\n\nChange dir to **NexT** directory. There must be `layout`, `source`, `languages` and other directories:\n\n```sh\n$ cd themes/next\n$ ls\nbower.json  _config.yml  docs  gulpfile.coffee  languages  layout  LICENSE.md  package.json  README.md  scripts  source  test\n```\n\n<h2 align=\"center\">Step 2 &rarr; Get module</h2>\n\nInstall module to `source/lib` directory:\n\n```sh\n$ git clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload\n```\n\n<h2 align=\"center\">Step 3 &rarr; Set it up</h2>\n\nEnable module in **NexT** `_config.yml` file:\n\n```yml\nlazyload: true\n```\n\n<h1 align=\"center\">Update</h1>\n\n```sh\n$ cd themes/next/source/lib/jquery_lazyload\n$ git pull\n```\n","source":"lib/jquery_lazyload/README.md","raw":"<h1 align=\"center\"><a href=\"https://github.com/tuupola/jquery_lazyload\">jquery-lazyload</a> for <a href=\"https://github.com/theme-next\">NexT</a></h1>\n\n<h1 align=\"center\">Installation</h1>\n\n<h2 align=\"center\">Step 1 &rarr; Go to NexT dir</h2>\n\nChange dir to **NexT** directory. There must be `layout`, `source`, `languages` and other directories:\n\n```sh\n$ cd themes/next\n$ ls\nbower.json  _config.yml  docs  gulpfile.coffee  languages  layout  LICENSE.md  package.json  README.md  scripts  source  test\n```\n\n<h2 align=\"center\">Step 2 &rarr; Get module</h2>\n\nInstall module to `source/lib` directory:\n\n```sh\n$ git clone https://github.com/theme-next/theme-next-jquery-lazyload source/lib/jquery_lazyload\n```\n\n<h2 align=\"center\">Step 3 &rarr; Set it up</h2>\n\nEnable module in **NexT** `_config.yml` file:\n\n```yml\nlazyload: true\n```\n\n<h1 align=\"center\">Update</h1>\n\n```sh\n$ cd themes/next/source/lib/jquery_lazyload\n$ git pull\n```\n","date":"2020-08-05T02:38:48.538Z","updated":"2020-08-05T02:38:48.538Z","path":"lib/jquery_lazyload/README.html","title":"","comments":1,"layout":"page","_id":"ckdu7m6v5000lyreb348w0p6v","content":"<h1 align=\"center\"><a href=\"https://github.com/tuupola/jquery_lazyload\">jquery-lazyload</a> for <a href=\"https://github.com/theme-next\">NexT</a></h1>\n\n<h1 align=\"center\">Installation</h1>\n\n<h2 align=\"center\">Step 1 &rarr; Go to NexT dir</h2>\n\n<p>Change dir to <strong>NexT</strong> directory. There must be <code>layout</code>, <code>source</code>, <code>languages</code> and other directories:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ <span class=\"hljs-built_in\">cd</span> themes/next<br>$ ls<br>bower.json  _config.yml  docs  gulpfile.coffee  languages  layout  LICENSE.md  package.json  README.md  scripts  <span class=\"hljs-built_in\">source</span>  <span class=\"hljs-built_in\">test</span><br></code></pre></td></tr></table></figure>\n<h2 align=\"center\">Step 2 &rarr; Get module</h2>\n\n<p>Install module to <code>source/lib</code> directory:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ git <span class=\"hljs-built_in\">clone</span> https://github.com/theme-next/theme-next-jquery-lazyload <span class=\"hljs-built_in\">source</span>/lib/jquery_lazyload<br></code></pre></td></tr></table></figure>\n<h2 align=\"center\">Step 3 &rarr; Set it up</h2>\n\n<p>Enable module in <strong>NexT</strong> <code>_config.yml</code> file:</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yml\"><span class=\"hljs-attr\">lazyload:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n<h1 align=\"center\">Update</h1>\n\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ <span class=\"hljs-built_in\">cd</span> themes/next/<span class=\"hljs-built_in\">source</span>/lib/jquery_lazyload<br>$ git pull<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 align=\"center\"><a href=\"https://github.com/tuupola/jquery_lazyload\">jquery-lazyload</a> for <a href=\"https://github.com/theme-next\">NexT</a></h1>\n\n<h1 align=\"center\">Installation</h1>\n\n<h2 align=\"center\">Step 1 &rarr; Go to NexT dir</h2>\n\n<p>Change dir to <strong>NexT</strong> directory. There must be <code>layout</code>, <code>source</code>, <code>languages</code> and other directories:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ <span class=\"hljs-built_in\">cd</span> themes/next<br>$ ls<br>bower.json  _config.yml  docs  gulpfile.coffee  languages  layout  LICENSE.md  package.json  README.md  scripts  <span class=\"hljs-built_in\">source</span>  <span class=\"hljs-built_in\">test</span><br></code></pre></td></tr></table></figure>\n<h2 align=\"center\">Step 2 &rarr; Get module</h2>\n\n<p>Install module to <code>source/lib</code> directory:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ git <span class=\"hljs-built_in\">clone</span> https://github.com/theme-next/theme-next-jquery-lazyload <span class=\"hljs-built_in\">source</span>/lib/jquery_lazyload<br></code></pre></td></tr></table></figure>\n<h2 align=\"center\">Step 3 &rarr; Set it up</h2>\n\n<p>Enable module in <strong>NexT</strong> <code>_config.yml</code> file:</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yml\"><span class=\"hljs-attr\">lazyload:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n<h1 align=\"center\">Update</h1>\n\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sh\">$ <span class=\"hljs-built_in\">cd</span> themes/next/<span class=\"hljs-built_in\">source</span>/lib/jquery_lazyload<br>$ git pull<br></code></pre></td></tr></table></figure>\n"},{"_content":"/*!\n * Lazy Load - jQuery plugin for lazy loading images\n *\n * Copyright (c) 2007-2015 Mika Tuupola\n *\n * Licensed under the MIT license:\n *   http://www.opensource.org/licenses/mit-license.php\n *\n * Project home:\n *   http://www.appelsiini.net/projects/lazyload\n *\n * Version:  1.9.7\n *\n */\n\n(function($, window, document, undefined) {\n    var $window = $(window);\n\n    $.fn.lazyload = function(options) {\n        var elements = this;\n        var $container;\n        var settings = {\n            threshold       : 0,\n            failure_limit   : 0,\n            event           : \"scroll\",\n            effect          : \"show\",\n            container       : window,\n            data_attribute  : \"original\",\n            skip_invisible  : false,\n            appear          : null,\n            load            : null,\n            placeholder     : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\"\n        };\n\n        function update() {\n            var counter = 0;\n\n            elements.each(function() {\n                var $this = $(this);\n                if (settings.skip_invisible && !$this.is(\":visible\")) {\n                    return;\n                }\n                if ($.abovethetop(this, settings) ||\n                    $.leftofbegin(this, settings)) {\n                        /* Nothing. */\n                } else if (!$.belowthefold(this, settings) &&\n                    !$.rightoffold(this, settings)) {\n                        $this.trigger(\"appear\");\n                        /* if we found an image we'll load, reset the counter */\n                        counter = 0;\n                } else {\n                    if (++counter > settings.failure_limit) {\n                        return false;\n                    }\n                }\n            });\n\n        }\n\n        if(options) {\n            /* Maintain BC for a couple of versions. */\n            if (undefined !== options.failurelimit) {\n                options.failure_limit = options.failurelimit;\n                delete options.failurelimit;\n            }\n            if (undefined !== options.effectspeed) {\n                options.effect_speed = options.effectspeed;\n                delete options.effectspeed;\n            }\n\n            $.extend(settings, options);\n        }\n\n        /* Cache container as jQuery as object. */\n        $container = (settings.container === undefined ||\n                      settings.container === window) ? $window : $(settings.container);\n\n        /* Fire one scroll event per scroll. Not one scroll event per image. */\n        if (0 === settings.event.indexOf(\"scroll\")) {\n            $container.bind(settings.event, function() {\n                return update();\n            });\n        }\n\n        this.each(function() {\n            var self = this;\n            var $self = $(self);\n\n            self.loaded = false;\n\n            /* If no src attribute given use data:uri. */\n            if ($self.attr(\"src\") === undefined || $self.attr(\"src\") === false) {\n                if ($self.is(\"img\")) {\n                    $self.attr(\"src\", settings.placeholder);\n                }\n            }\n\n            /* When appear is triggered load original image. */\n            $self.one(\"appear\", function() {\n                if (!this.loaded) {\n                    if (settings.appear) {\n                        var elements_left = elements.length;\n                        settings.appear.call(self, elements_left, settings);\n                    }\n                    $(\"<img />\")\n                        .bind(\"load\", function() {\n\n                            var original = $self.attr(\"data-\" + settings.data_attribute);\n                            $self.hide();\n                            if ($self.is(\"img\")) {\n                                $self.attr(\"src\", original);\n                            } else {\n                                $self.css(\"background-image\", \"url('\" + original + \"')\");\n                            }\n                            $self[settings.effect](settings.effect_speed);\n\n                            self.loaded = true;\n\n                            /* Remove image from array so it is not looped next time. */\n                            var temp = $.grep(elements, function(element) {\n                                return !element.loaded;\n                            });\n                            elements = $(temp);\n\n                            if (settings.load) {\n                                var elements_left = elements.length;\n                                settings.load.call(self, elements_left, settings);\n                            }\n                        })\n                        .attr(\"src\", $self.attr(\"data-\" + settings.data_attribute));\n                }\n            });\n\n            /* When wanted event is triggered load original image */\n            /* by triggering appear.                              */\n            if (0 !== settings.event.indexOf(\"scroll\")) {\n                $self.bind(settings.event, function() {\n                    if (!self.loaded) {\n                        $self.trigger(\"appear\");\n                    }\n                });\n            }\n        });\n\n        /* Check if something appears when window is resized. */\n        $window.bind(\"resize\", function() {\n            update();\n        });\n\n        /* With IOS5 force loading images when navigating with back button. */\n        /* Non optimal workaround. */\n        if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {\n            $window.bind(\"pageshow\", function(event) {\n                if (event.originalEvent && event.originalEvent.persisted) {\n                    elements.each(function() {\n                        $(this).trigger(\"appear\");\n                    });\n                }\n            });\n        }\n\n        /* Force initial check if images should appear. */\n        $(document).ready(function() {\n            update();\n        });\n\n        return this;\n    };\n\n    /* Convenience methods in jQuery namespace.           */\n    /* Use as  $.belowthefold(element, {threshold : 100, container : window}) */\n\n    $.belowthefold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top + $(settings.container).height();\n        }\n\n        return fold <= $(element).offset().top - settings.threshold;\n    };\n\n    $.rightoffold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.width() + $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left + $(settings.container).width();\n        }\n\n        return fold <= $(element).offset().left - settings.threshold;\n    };\n\n    $.abovethetop = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top;\n        }\n\n        return fold >= $(element).offset().top + settings.threshold  + $(element).height();\n    };\n\n    $.leftofbegin = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left;\n        }\n\n        return fold >= $(element).offset().left + settings.threshold + $(element).width();\n    };\n\n    $.inviewport = function(element, settings) {\n         return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) &&\n                !$.belowthefold(element, settings) && !$.abovethetop(element, settings);\n     };\n\n    /* Custom selectors for your convenience.   */\n    /* Use as $(\"img:below-the-fold\").something() or */\n    /* $(\"img\").filter(\":below-the-fold\").something() which is faster */\n\n    $.extend($.expr[\":\"], {\n        \"below-the-fold\" : function(a) { return $.belowthefold(a, {threshold : 0}); },\n        \"above-the-top\"  : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-screen\": function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-screen\" : function(a) { return !$.rightoffold(a, {threshold : 0}); },\n        \"in-viewport\"    : function(a) { return $.inviewport(a, {threshold : 0}); },\n        /* Maintain BC for couple of versions. */\n        \"above-the-fold\" : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-fold\"  : function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-fold\"   : function(a) { return !$.rightoffold(a, {threshold : 0}); }\n    });\n\n})(jQuery, window, document);\n","source":"lib/jquery_lazyload/jquery.lazyload.js","raw":"/*!\n * Lazy Load - jQuery plugin for lazy loading images\n *\n * Copyright (c) 2007-2015 Mika Tuupola\n *\n * Licensed under the MIT license:\n *   http://www.opensource.org/licenses/mit-license.php\n *\n * Project home:\n *   http://www.appelsiini.net/projects/lazyload\n *\n * Version:  1.9.7\n *\n */\n\n(function($, window, document, undefined) {\n    var $window = $(window);\n\n    $.fn.lazyload = function(options) {\n        var elements = this;\n        var $container;\n        var settings = {\n            threshold       : 0,\n            failure_limit   : 0,\n            event           : \"scroll\",\n            effect          : \"show\",\n            container       : window,\n            data_attribute  : \"original\",\n            skip_invisible  : false,\n            appear          : null,\n            load            : null,\n            placeholder     : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\"\n        };\n\n        function update() {\n            var counter = 0;\n\n            elements.each(function() {\n                var $this = $(this);\n                if (settings.skip_invisible && !$this.is(\":visible\")) {\n                    return;\n                }\n                if ($.abovethetop(this, settings) ||\n                    $.leftofbegin(this, settings)) {\n                        /* Nothing. */\n                } else if (!$.belowthefold(this, settings) &&\n                    !$.rightoffold(this, settings)) {\n                        $this.trigger(\"appear\");\n                        /* if we found an image we'll load, reset the counter */\n                        counter = 0;\n                } else {\n                    if (++counter > settings.failure_limit) {\n                        return false;\n                    }\n                }\n            });\n\n        }\n\n        if(options) {\n            /* Maintain BC for a couple of versions. */\n            if (undefined !== options.failurelimit) {\n                options.failure_limit = options.failurelimit;\n                delete options.failurelimit;\n            }\n            if (undefined !== options.effectspeed) {\n                options.effect_speed = options.effectspeed;\n                delete options.effectspeed;\n            }\n\n            $.extend(settings, options);\n        }\n\n        /* Cache container as jQuery as object. */\n        $container = (settings.container === undefined ||\n                      settings.container === window) ? $window : $(settings.container);\n\n        /* Fire one scroll event per scroll. Not one scroll event per image. */\n        if (0 === settings.event.indexOf(\"scroll\")) {\n            $container.bind(settings.event, function() {\n                return update();\n            });\n        }\n\n        this.each(function() {\n            var self = this;\n            var $self = $(self);\n\n            self.loaded = false;\n\n            /* If no src attribute given use data:uri. */\n            if ($self.attr(\"src\") === undefined || $self.attr(\"src\") === false) {\n                if ($self.is(\"img\")) {\n                    $self.attr(\"src\", settings.placeholder);\n                }\n            }\n\n            /* When appear is triggered load original image. */\n            $self.one(\"appear\", function() {\n                if (!this.loaded) {\n                    if (settings.appear) {\n                        var elements_left = elements.length;\n                        settings.appear.call(self, elements_left, settings);\n                    }\n                    $(\"<img />\")\n                        .bind(\"load\", function() {\n\n                            var original = $self.attr(\"data-\" + settings.data_attribute);\n                            $self.hide();\n                            if ($self.is(\"img\")) {\n                                $self.attr(\"src\", original);\n                            } else {\n                                $self.css(\"background-image\", \"url('\" + original + \"')\");\n                            }\n                            $self[settings.effect](settings.effect_speed);\n\n                            self.loaded = true;\n\n                            /* Remove image from array so it is not looped next time. */\n                            var temp = $.grep(elements, function(element) {\n                                return !element.loaded;\n                            });\n                            elements = $(temp);\n\n                            if (settings.load) {\n                                var elements_left = elements.length;\n                                settings.load.call(self, elements_left, settings);\n                            }\n                        })\n                        .attr(\"src\", $self.attr(\"data-\" + settings.data_attribute));\n                }\n            });\n\n            /* When wanted event is triggered load original image */\n            /* by triggering appear.                              */\n            if (0 !== settings.event.indexOf(\"scroll\")) {\n                $self.bind(settings.event, function() {\n                    if (!self.loaded) {\n                        $self.trigger(\"appear\");\n                    }\n                });\n            }\n        });\n\n        /* Check if something appears when window is resized. */\n        $window.bind(\"resize\", function() {\n            update();\n        });\n\n        /* With IOS5 force loading images when navigating with back button. */\n        /* Non optimal workaround. */\n        if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {\n            $window.bind(\"pageshow\", function(event) {\n                if (event.originalEvent && event.originalEvent.persisted) {\n                    elements.each(function() {\n                        $(this).trigger(\"appear\");\n                    });\n                }\n            });\n        }\n\n        /* Force initial check if images should appear. */\n        $(document).ready(function() {\n            update();\n        });\n\n        return this;\n    };\n\n    /* Convenience methods in jQuery namespace.           */\n    /* Use as  $.belowthefold(element, {threshold : 100, container : window}) */\n\n    $.belowthefold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top + $(settings.container).height();\n        }\n\n        return fold <= $(element).offset().top - settings.threshold;\n    };\n\n    $.rightoffold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.width() + $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left + $(settings.container).width();\n        }\n\n        return fold <= $(element).offset().left - settings.threshold;\n    };\n\n    $.abovethetop = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top;\n        }\n\n        return fold >= $(element).offset().top + settings.threshold  + $(element).height();\n    };\n\n    $.leftofbegin = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left;\n        }\n\n        return fold >= $(element).offset().left + settings.threshold + $(element).width();\n    };\n\n    $.inviewport = function(element, settings) {\n         return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) &&\n                !$.belowthefold(element, settings) && !$.abovethetop(element, settings);\n     };\n\n    /* Custom selectors for your convenience.   */\n    /* Use as $(\"img:below-the-fold\").something() or */\n    /* $(\"img\").filter(\":below-the-fold\").something() which is faster */\n\n    $.extend($.expr[\":\"], {\n        \"below-the-fold\" : function(a) { return $.belowthefold(a, {threshold : 0}); },\n        \"above-the-top\"  : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-screen\": function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-screen\" : function(a) { return !$.rightoffold(a, {threshold : 0}); },\n        \"in-viewport\"    : function(a) { return $.inviewport(a, {threshold : 0}); },\n        /* Maintain BC for couple of versions. */\n        \"above-the-fold\" : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-fold\"  : function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-fold\"   : function(a) { return !$.rightoffold(a, {threshold : 0}); }\n    });\n\n})(jQuery, window, document);\n","date":"2020-08-05T02:38:48.538Z","updated":"2020-08-05T02:38:48.538Z","path":"lib/jquery_lazyload/jquery.lazyload.js","layout":"false","title":"","comments":1,"_id":"ckdu7m6v6000oyrebhgynfmoi","content":"/*!\n * Lazy Load - jQuery plugin for lazy loading images\n *\n * Copyright (c) 2007-2015 Mika Tuupola\n *\n * Licensed under the MIT license:\n *   http://www.opensource.org/licenses/mit-license.php\n *\n * Project home:\n *   http://www.appelsiini.net/projects/lazyload\n *\n * Version:  1.9.7\n *\n */\n\n(function($, window, document, undefined) {\n    var $window = $(window);\n\n    $.fn.lazyload = function(options) {\n        var elements = this;\n        var $container;\n        var settings = {\n            threshold       : 0,\n            failure_limit   : 0,\n            event           : \"scroll\",\n            effect          : \"show\",\n            container       : window,\n            data_attribute  : \"original\",\n            skip_invisible  : false,\n            appear          : null,\n            load            : null,\n            placeholder     : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\"\n        };\n\n        function update() {\n            var counter = 0;\n\n            elements.each(function() {\n                var $this = $(this);\n                if (settings.skip_invisible && !$this.is(\":visible\")) {\n                    return;\n                }\n                if ($.abovethetop(this, settings) ||\n                    $.leftofbegin(this, settings)) {\n                        /* Nothing. */\n                } else if (!$.belowthefold(this, settings) &&\n                    !$.rightoffold(this, settings)) {\n                        $this.trigger(\"appear\");\n                        /* if we found an image we'll load, reset the counter */\n                        counter = 0;\n                } else {\n                    if (++counter > settings.failure_limit) {\n                        return false;\n                    }\n                }\n            });\n\n        }\n\n        if(options) {\n            /* Maintain BC for a couple of versions. */\n            if (undefined !== options.failurelimit) {\n                options.failure_limit = options.failurelimit;\n                delete options.failurelimit;\n            }\n            if (undefined !== options.effectspeed) {\n                options.effect_speed = options.effectspeed;\n                delete options.effectspeed;\n            }\n\n            $.extend(settings, options);\n        }\n\n        /* Cache container as jQuery as object. */\n        $container = (settings.container === undefined ||\n                      settings.container === window) ? $window : $(settings.container);\n\n        /* Fire one scroll event per scroll. Not one scroll event per image. */\n        if (0 === settings.event.indexOf(\"scroll\")) {\n            $container.bind(settings.event, function() {\n                return update();\n            });\n        }\n\n        this.each(function() {\n            var self = this;\n            var $self = $(self);\n\n            self.loaded = false;\n\n            /* If no src attribute given use data:uri. */\n            if ($self.attr(\"src\") === undefined || $self.attr(\"src\") === false) {\n                if ($self.is(\"img\")) {\n                    $self.attr(\"src\", settings.placeholder);\n                }\n            }\n\n            /* When appear is triggered load original image. */\n            $self.one(\"appear\", function() {\n                if (!this.loaded) {\n                    if (settings.appear) {\n                        var elements_left = elements.length;\n                        settings.appear.call(self, elements_left, settings);\n                    }\n                    $(\"<img />\")\n                        .bind(\"load\", function() {\n\n                            var original = $self.attr(\"data-\" + settings.data_attribute);\n                            $self.hide();\n                            if ($self.is(\"img\")) {\n                                $self.attr(\"src\", original);\n                            } else {\n                                $self.css(\"background-image\", \"url('\" + original + \"')\");\n                            }\n                            $self[settings.effect](settings.effect_speed);\n\n                            self.loaded = true;\n\n                            /* Remove image from array so it is not looped next time. */\n                            var temp = $.grep(elements, function(element) {\n                                return !element.loaded;\n                            });\n                            elements = $(temp);\n\n                            if (settings.load) {\n                                var elements_left = elements.length;\n                                settings.load.call(self, elements_left, settings);\n                            }\n                        })\n                        .attr(\"src\", $self.attr(\"data-\" + settings.data_attribute));\n                }\n            });\n\n            /* When wanted event is triggered load original image */\n            /* by triggering appear.                              */\n            if (0 !== settings.event.indexOf(\"scroll\")) {\n                $self.bind(settings.event, function() {\n                    if (!self.loaded) {\n                        $self.trigger(\"appear\");\n                    }\n                });\n            }\n        });\n\n        /* Check if something appears when window is resized. */\n        $window.bind(\"resize\", function() {\n            update();\n        });\n\n        /* With IOS5 force loading images when navigating with back button. */\n        /* Non optimal workaround. */\n        if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {\n            $window.bind(\"pageshow\", function(event) {\n                if (event.originalEvent && event.originalEvent.persisted) {\n                    elements.each(function() {\n                        $(this).trigger(\"appear\");\n                    });\n                }\n            });\n        }\n\n        /* Force initial check if images should appear. */\n        $(document).ready(function() {\n            update();\n        });\n\n        return this;\n    };\n\n    /* Convenience methods in jQuery namespace.           */\n    /* Use as  $.belowthefold(element, {threshold : 100, container : window}) */\n\n    $.belowthefold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top + $(settings.container).height();\n        }\n\n        return fold <= $(element).offset().top - settings.threshold;\n    };\n\n    $.rightoffold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.width() + $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left + $(settings.container).width();\n        }\n\n        return fold <= $(element).offset().left - settings.threshold;\n    };\n\n    $.abovethetop = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top;\n        }\n\n        return fold >= $(element).offset().top + settings.threshold  + $(element).height();\n    };\n\n    $.leftofbegin = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left;\n        }\n\n        return fold >= $(element).offset().left + settings.threshold + $(element).width();\n    };\n\n    $.inviewport = function(element, settings) {\n         return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) &&\n                !$.belowthefold(element, settings) && !$.abovethetop(element, settings);\n     };\n\n    /* Custom selectors for your convenience.   */\n    /* Use as $(\"img:below-the-fold\").something() or */\n    /* $(\"img\").filter(\":below-the-fold\").something() which is faster */\n\n    $.extend($.expr[\":\"], {\n        \"below-the-fold\" : function(a) { return $.belowthefold(a, {threshold : 0}); },\n        \"above-the-top\"  : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-screen\": function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-screen\" : function(a) { return !$.rightoffold(a, {threshold : 0}); },\n        \"in-viewport\"    : function(a) { return $.inviewport(a, {threshold : 0}); },\n        /* Maintain BC for couple of versions. */\n        \"above-the-fold\" : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-fold\"  : function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-fold\"   : function(a) { return !$.rightoffold(a, {threshold : 0}); }\n    });\n\n})(jQuery, window, document);\n","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"/*!\n * Lazy Load - jQuery plugin for lazy loading images\n *\n * Copyright (c) 2007-2015 Mika Tuupola\n *\n * Licensed under the MIT license:\n *   http://www.opensource.org/licenses/mit-license.php\n *\n * Project home:\n *   http://www.appelsiini.net/projects/lazyload\n *\n * Version:  1.9.7\n *\n */\n\n(function($, window, document, undefined) {\n    var $window = $(window);\n\n    $.fn.lazyload = function(options) {\n        var elements = this;\n        var $container;\n        var settings = {\n            threshold       : 0,\n            failure_limit   : 0,\n            event           : \"scroll\",\n            effect          : \"show\",\n            container       : window,\n            data_attribute  : \"original\",\n            skip_invisible  : false,\n            appear          : null,\n            load            : null,\n            placeholder     : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\"\n        };\n\n        function update() {\n            var counter = 0;\n\n            elements.each(function() {\n                var $this = $(this);\n                if (settings.skip_invisible && !$this.is(\":visible\")) {\n                    return;\n                }\n                if ($.abovethetop(this, settings) ||\n                    $.leftofbegin(this, settings)) {\n                        /* Nothing. */\n                } else if (!$.belowthefold(this, settings) &&\n                    !$.rightoffold(this, settings)) {\n                        $this.trigger(\"appear\");\n                        /* if we found an image we'll load, reset the counter */\n                        counter = 0;\n                } else {\n                    if (++counter > settings.failure_limit) {\n                        return false;\n                    }\n                }\n            });\n\n        }\n\n        if(options) {\n            /* Maintain BC for a couple of versions. */\n            if (undefined !== options.failurelimit) {\n                options.failure_limit = options.failurelimit;\n                delete options.failurelimit;\n            }\n            if (undefined !== options.effectspeed) {\n                options.effect_speed = options.effectspeed;\n                delete options.effectspeed;\n            }\n\n            $.extend(settings, options);\n        }\n\n        /* Cache container as jQuery as object. */\n        $container = (settings.container === undefined ||\n                      settings.container === window) ? $window : $(settings.container);\n\n        /* Fire one scroll event per scroll. Not one scroll event per image. */\n        if (0 === settings.event.indexOf(\"scroll\")) {\n            $container.bind(settings.event, function() {\n                return update();\n            });\n        }\n\n        this.each(function() {\n            var self = this;\n            var $self = $(self);\n\n            self.loaded = false;\n\n            /* If no src attribute given use data:uri. */\n            if ($self.attr(\"src\") === undefined || $self.attr(\"src\") === false) {\n                if ($self.is(\"img\")) {\n                    $self.attr(\"src\", settings.placeholder);\n                }\n            }\n\n            /* When appear is triggered load original image. */\n            $self.one(\"appear\", function() {\n                if (!this.loaded) {\n                    if (settings.appear) {\n                        var elements_left = elements.length;\n                        settings.appear.call(self, elements_left, settings);\n                    }\n                    $(\"<img />\")\n                        .bind(\"load\", function() {\n\n                            var original = $self.attr(\"data-\" + settings.data_attribute);\n                            $self.hide();\n                            if ($self.is(\"img\")) {\n                                $self.attr(\"src\", original);\n                            } else {\n                                $self.css(\"background-image\", \"url('\" + original + \"')\");\n                            }\n                            $self[settings.effect](settings.effect_speed);\n\n                            self.loaded = true;\n\n                            /* Remove image from array so it is not looped next time. */\n                            var temp = $.grep(elements, function(element) {\n                                return !element.loaded;\n                            });\n                            elements = $(temp);\n\n                            if (settings.load) {\n                                var elements_left = elements.length;\n                                settings.load.call(self, elements_left, settings);\n                            }\n                        })\n                        .attr(\"src\", $self.attr(\"data-\" + settings.data_attribute));\n                }\n            });\n\n            /* When wanted event is triggered load original image */\n            /* by triggering appear.                              */\n            if (0 !== settings.event.indexOf(\"scroll\")) {\n                $self.bind(settings.event, function() {\n                    if (!self.loaded) {\n                        $self.trigger(\"appear\");\n                    }\n                });\n            }\n        });\n\n        /* Check if something appears when window is resized. */\n        $window.bind(\"resize\", function() {\n            update();\n        });\n\n        /* With IOS5 force loading images when navigating with back button. */\n        /* Non optimal workaround. */\n        if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {\n            $window.bind(\"pageshow\", function(event) {\n                if (event.originalEvent && event.originalEvent.persisted) {\n                    elements.each(function() {\n                        $(this).trigger(\"appear\");\n                    });\n                }\n            });\n        }\n\n        /* Force initial check if images should appear. */\n        $(document).ready(function() {\n            update();\n        });\n\n        return this;\n    };\n\n    /* Convenience methods in jQuery namespace.           */\n    /* Use as  $.belowthefold(element, {threshold : 100, container : window}) */\n\n    $.belowthefold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top + $(settings.container).height();\n        }\n\n        return fold <= $(element).offset().top - settings.threshold;\n    };\n\n    $.rightoffold = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.width() + $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left + $(settings.container).width();\n        }\n\n        return fold <= $(element).offset().left - settings.threshold;\n    };\n\n    $.abovethetop = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollTop();\n        } else {\n            fold = $(settings.container).offset().top;\n        }\n\n        return fold >= $(element).offset().top + settings.threshold  + $(element).height();\n    };\n\n    $.leftofbegin = function(element, settings) {\n        var fold;\n\n        if (settings.container === undefined || settings.container === window) {\n            fold = $window.scrollLeft();\n        } else {\n            fold = $(settings.container).offset().left;\n        }\n\n        return fold >= $(element).offset().left + settings.threshold + $(element).width();\n    };\n\n    $.inviewport = function(element, settings) {\n         return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) &&\n                !$.belowthefold(element, settings) && !$.abovethetop(element, settings);\n     };\n\n    /* Custom selectors for your convenience.   */\n    /* Use as $(\"img:below-the-fold\").something() or */\n    /* $(\"img\").filter(\":below-the-fold\").something() which is faster */\n\n    $.extend($.expr[\":\"], {\n        \"below-the-fold\" : function(a) { return $.belowthefold(a, {threshold : 0}); },\n        \"above-the-top\"  : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-screen\": function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-screen\" : function(a) { return !$.rightoffold(a, {threshold : 0}); },\n        \"in-viewport\"    : function(a) { return $.inviewport(a, {threshold : 0}); },\n        /* Maintain BC for couple of versions. */\n        \"above-the-fold\" : function(a) { return !$.belowthefold(a, {threshold : 0}); },\n        \"right-of-fold\"  : function(a) { return $.rightoffold(a, {threshold : 0}); },\n        \"left-of-fold\"   : function(a) { return !$.rightoffold(a, {threshold : 0}); }\n    });\n\n})(jQuery, window, document);\n"},{"_content":"/* http://james.padolsey.com/javascript/special-scroll-events-for-jquery/ */\n\n(function(){\n    \n    var special = jQuery.event.special,\n        uid1 = \"D\" + (+new Date()),\n        uid2 = \"D\" + (+new Date() + 1);\n        \n    special.scrollstart = {\n        setup: function() {\n            \n            var timer,\n                handler =  function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    } else {\n                        evt.type = \"scrollstart\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        timer = null;\n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid1, handler);\n            \n        },\n        teardown: function(){\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid1) );\n        }\n    };\n    \n    special.scrollstop = {\n        latency: 300,\n        setup: function() {\n            \n            var timer,\n                    handler = function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        \n                        timer = null;\n                        evt.type = \"scrollstop\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                        \n                        \n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid2, handler);\n            \n        },\n        teardown: function() {\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid2) );\n        }\n    };\n    \n})();","source":"lib/jquery_lazyload/jquery.scrollstop.js","raw":"/* http://james.padolsey.com/javascript/special-scroll-events-for-jquery/ */\n\n(function(){\n    \n    var special = jQuery.event.special,\n        uid1 = \"D\" + (+new Date()),\n        uid2 = \"D\" + (+new Date() + 1);\n        \n    special.scrollstart = {\n        setup: function() {\n            \n            var timer,\n                handler =  function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    } else {\n                        evt.type = \"scrollstart\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        timer = null;\n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid1, handler);\n            \n        },\n        teardown: function(){\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid1) );\n        }\n    };\n    \n    special.scrollstop = {\n        latency: 300,\n        setup: function() {\n            \n            var timer,\n                    handler = function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        \n                        timer = null;\n                        evt.type = \"scrollstop\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                        \n                        \n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid2, handler);\n            \n        },\n        teardown: function() {\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid2) );\n        }\n    };\n    \n})();","date":"2020-08-05T02:38:48.538Z","updated":"2020-08-05T02:38:48.538Z","path":"lib/jquery_lazyload/jquery.scrollstop.js","layout":"false","title":"","comments":1,"_id":"ckdu7m6v8000tyreb90456v0r","content":"/* http://james.padolsey.com/javascript/special-scroll-events-for-jquery/ */\n\n(function(){\n    \n    var special = jQuery.event.special,\n        uid1 = \"D\" + (+new Date()),\n        uid2 = \"D\" + (+new Date() + 1);\n        \n    special.scrollstart = {\n        setup: function() {\n            \n            var timer,\n                handler =  function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    } else {\n                        evt.type = \"scrollstart\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        timer = null;\n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid1, handler);\n            \n        },\n        teardown: function(){\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid1) );\n        }\n    };\n    \n    special.scrollstop = {\n        latency: 300,\n        setup: function() {\n            \n            var timer,\n                    handler = function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        \n                        timer = null;\n                        evt.type = \"scrollstop\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                        \n                        \n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid2, handler);\n            \n        },\n        teardown: function() {\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid2) );\n        }\n    };\n    \n})();","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"/* http://james.padolsey.com/javascript/special-scroll-events-for-jquery/ */\n\n(function(){\n    \n    var special = jQuery.event.special,\n        uid1 = \"D\" + (+new Date()),\n        uid2 = \"D\" + (+new Date() + 1);\n        \n    special.scrollstart = {\n        setup: function() {\n            \n            var timer,\n                handler =  function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    } else {\n                        evt.type = \"scrollstart\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        timer = null;\n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid1, handler);\n            \n        },\n        teardown: function(){\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid1) );\n        }\n    };\n    \n    special.scrollstop = {\n        latency: 300,\n        setup: function() {\n            \n            var timer,\n                    handler = function(evt) {\n                    \n                    var _self = this,\n                        _args = arguments;\n                    \n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n                    \n                    timer = setTimeout( function(){\n                        \n                        timer = null;\n                        evt.type = \"scrollstop\";\n                        jQuery.event.dispatch.apply(_self, _args);\n                        \n                        \n                    }, special.scrollstop.latency);\n                    \n                };\n            \n            jQuery(this).bind(\"scroll\", handler).data(uid2, handler);\n            \n        },\n        teardown: function() {\n            jQuery(this).unbind( \"scroll\", jQuery(this).data(uid2) );\n        }\n    };\n    \n})();"}],"Post":[{"title":"两阶段提交事物","date":"2020-08-05T03:35:20.000Z","top":10,"password":null,"_content":"\n# 什么是两阶段提交事物\n两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。 \n顾名思义，该协议将一个分布式的事务过程拆分成两个阶段： 准备和事务提交\n\n\n<!-- more -->\n\n# PostgreSQL两阶段提交协议\n\n    两阶段提交协议有五个步骤，如下：\n\n1. 应用程序先调用各台机数据库做一些操作，但不提交事务。然后应用程序调用事务协调器（这个协调器可能也是由应用自己实现）中的提交方法。\n2. 事务协调器将联络事务中涉及的每台数据库，并通知它们准备提交事务，这是第一阶段的开始。在PostgreSQL一般是调用“PREPARE TRANSACTION”命令。\n3. 各台数据库接收到“PREPARE TRANSACTION”命令后，如果要返回成功，则数据库必须将自己置于以下状态：确保能在被要求提交事务时提交事务，或在被要求回滚事务时回滚事务。所以PostgreSQL会将已准备好提交的信息写入持久存储区中。如果数据库无法完成此事务，它会直接返回失败给事务协调器。\n4. 事务协调器接收到了所有数据库的响应。\n5. 在第二阶段，如果任一数据库在第一阶段返回失败，则事务协调器会将发一个回滚命令（ROLLBACK PREPARED）给各台数据库。如果所有数据库的响应都是成功的，则向各台数据库发送“COMMIT PREPARED”命令，通知各台数据库事务成功。\n\n# 测试\n```\nmydb=# create table t1(id int, crt_time timestamptz);\nCREATE TABLE\nmydb=# begin;                                              -- 开启事务\nBEGIN\nmydb=*# insert into t1 select 1, now();    -- 插入一条数据\nINSERT 0 1\nmydb=*# prepare transaction 'p1';            -- 准备事务\nPREPARE TRANSACTION\nmydb=# \\q\njintao@jintao-ThinkPad-L490:~$ sudo -iu jintao /opt/pg-master/bin/pg_ctl -D /export/pgdata-master/ restart -l /tmp/start.log     -- 重启数据库\nwaiting for server to shut down.... done\nserver stopped\nwaiting for server to start.... done\nserver started\njintao@jintao-ThinkPad-L490:~$ psql\npsql (14devel)\nType \"help\" for help.\n\nmydb=# select * from pg_prepared_xacts ;          -- 查看两阶段事务系统表\n transaction | gid |           prepared            | owner  | database\n-------------+-----+-------------------------------+--------+----------\n        1045 | p1  | 2020-07-15 17:02:07.180102+08 | jintao | mydb\n(1 row)\n\nmydb=# select * from t1;\n id | crt_time\n----+----------\n(0 rows)\n\nmydb=# commit prepared 'p1';                            -- 提交\nCOMMIT PREPARED\nmydb=# select * from t1;\n id |           crt_time\n----+-------------------------------\n  1 | 2020-07-15 17:01:59.163772+08\n(1 row)\n\n```\n","source":"_posts/PostgreSQL两阶段事物提交.md","raw":"---\ntitle: 两阶段提交事物 \ndate: 2020-08-05 11:35:20\ntags: [ PostgreSQL, 2pc ]\ncategories: \n- PostgreSQL\ntop: 10\npassword: \n\n---\n\n# 什么是两阶段提交事物\n两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。 \n顾名思义，该协议将一个分布式的事务过程拆分成两个阶段： 准备和事务提交\n\n\n<!-- more -->\n\n# PostgreSQL两阶段提交协议\n\n    两阶段提交协议有五个步骤，如下：\n\n1. 应用程序先调用各台机数据库做一些操作，但不提交事务。然后应用程序调用事务协调器（这个协调器可能也是由应用自己实现）中的提交方法。\n2. 事务协调器将联络事务中涉及的每台数据库，并通知它们准备提交事务，这是第一阶段的开始。在PostgreSQL一般是调用“PREPARE TRANSACTION”命令。\n3. 各台数据库接收到“PREPARE TRANSACTION”命令后，如果要返回成功，则数据库必须将自己置于以下状态：确保能在被要求提交事务时提交事务，或在被要求回滚事务时回滚事务。所以PostgreSQL会将已准备好提交的信息写入持久存储区中。如果数据库无法完成此事务，它会直接返回失败给事务协调器。\n4. 事务协调器接收到了所有数据库的响应。\n5. 在第二阶段，如果任一数据库在第一阶段返回失败，则事务协调器会将发一个回滚命令（ROLLBACK PREPARED）给各台数据库。如果所有数据库的响应都是成功的，则向各台数据库发送“COMMIT PREPARED”命令，通知各台数据库事务成功。\n\n# 测试\n```\nmydb=# create table t1(id int, crt_time timestamptz);\nCREATE TABLE\nmydb=# begin;                                              -- 开启事务\nBEGIN\nmydb=*# insert into t1 select 1, now();    -- 插入一条数据\nINSERT 0 1\nmydb=*# prepare transaction 'p1';            -- 准备事务\nPREPARE TRANSACTION\nmydb=# \\q\njintao@jintao-ThinkPad-L490:~$ sudo -iu jintao /opt/pg-master/bin/pg_ctl -D /export/pgdata-master/ restart -l /tmp/start.log     -- 重启数据库\nwaiting for server to shut down.... done\nserver stopped\nwaiting for server to start.... done\nserver started\njintao@jintao-ThinkPad-L490:~$ psql\npsql (14devel)\nType \"help\" for help.\n\nmydb=# select * from pg_prepared_xacts ;          -- 查看两阶段事务系统表\n transaction | gid |           prepared            | owner  | database\n-------------+-----+-------------------------------+--------+----------\n        1045 | p1  | 2020-07-15 17:02:07.180102+08 | jintao | mydb\n(1 row)\n\nmydb=# select * from t1;\n id | crt_time\n----+----------\n(0 rows)\n\nmydb=# commit prepared 'p1';                            -- 提交\nCOMMIT PREPARED\nmydb=# select * from t1;\n id |           crt_time\n----+-------------------------------\n  1 | 2020-07-15 17:01:59.163772+08\n(1 row)\n\n```\n","slug":"PostgreSQL两阶段事物提交","published":1,"updated":"2021-03-05T08:30:47.555Z","_id":"ckdu7m6uq0003yrebf49phet6","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"什么是两阶段提交事物\"><a href=\"#什么是两阶段提交事物\" class=\"headerlink\" title=\"什么是两阶段提交事物\"></a>什么是两阶段提交事物</h1><p>两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。<br>顾名思义，该协议将一个分布式的事务过程拆分成两个阶段： 准备和事务提交</p>\n<a id=\"more\"></a>\n<h1 id=\"PostgreSQL两阶段提交协议\"><a href=\"#PostgreSQL两阶段提交协议\" class=\"headerlink\" title=\"PostgreSQL两阶段提交协议\"></a>PostgreSQL两阶段提交协议</h1><pre><code>两阶段提交协议有五个步骤，如下：\n</code></pre><ol>\n<li>应用程序先调用各台机数据库做一些操作，但不提交事务。然后应用程序调用事务协调器（这个协调器可能也是由应用自己实现）中的提交方法。</li>\n<li>事务协调器将联络事务中涉及的每台数据库，并通知它们准备提交事务，这是第一阶段的开始。在PostgreSQL一般是调用“PREPARE TRANSACTION”命令。</li>\n<li>各台数据库接收到“PREPARE TRANSACTION”命令后，如果要返回成功，则数据库必须将自己置于以下状态：确保能在被要求提交事务时提交事务，或在被要求回滚事务时回滚事务。所以PostgreSQL会将已准备好提交的信息写入持久存储区中。如果数据库无法完成此事务，它会直接返回失败给事务协调器。</li>\n<li>事务协调器接收到了所有数据库的响应。</li>\n<li>在第二阶段，如果任一数据库在第一阶段返回失败，则事务协调器会将发一个回滚命令（ROLLBACK PREPARED）给各台数据库。如果所有数据库的响应都是成功的，则向各台数据库发送“COMMIT PREPARED”命令，通知各台数据库事务成功。</li>\n</ol>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create table t1(id int, crt_time timestamptz);<br>CREATE TABLE<br><span class=\"hljs-attribute\">mydb</span>=# begin;                                              -- 开启事务<br>BEGIN<br><span class=\"hljs-attribute\">mydb</span>=*# insert into t1 select 1, now();    -- 插入一条数据<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=*# prepare transaction <span class=\"hljs-string\">&#x27;p1&#x27;</span>;            -- 准备事务<br>PREPARE TRANSACTION<br><span class=\"hljs-attribute\">mydb</span>=# \\q<br>jintao@jintao-ThinkPad-L490:~$ sudo -iu jintao /opt/pg-master/bin/pg_ctl -D /export/pgdata-master/ restart -l /tmp/start.log     -- 重启数据库<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> shut down<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span> done<br>server stopped<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span> done<br>server started<br>jintao@jintao-ThinkPad-L490:~$ psql<br>psql (14devel)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> pg_prepared_xacts ;          -- 查看两阶段事务系统表<br> transaction | gid |           prepared            | owner  | database<br>-------------+-----+-------------------------------+--------+----------<br>        1045 | p1  | 2020-07-15 17:02:07.180102+08 | jintao | mydb<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> t1;<br> id | crt_time<br>----+----------<br>(0 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=# commit prepared <span class=\"hljs-string\">&#x27;p1&#x27;</span>;                            -- 提交<br>COMMIT PREPARED<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> t1;<br> id |           crt_time<br>----+-------------------------------<br>  1 | 2020-07-15 17:01:59.163772+08<br>(1 row)<br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"什么是两阶段提交事物\"><a href=\"#什么是两阶段提交事物\" class=\"headerlink\" title=\"什么是两阶段提交事物\"></a>什么是两阶段提交事物</h1><p>两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。<br>顾名思义，该协议将一个分布式的事务过程拆分成两个阶段： 准备和事务提交</p>","more":"<h1 id=\"PostgreSQL两阶段提交协议\"><a href=\"#PostgreSQL两阶段提交协议\" class=\"headerlink\" title=\"PostgreSQL两阶段提交协议\"></a>PostgreSQL两阶段提交协议</h1><pre><code>两阶段提交协议有五个步骤，如下：\n</code></pre><ol>\n<li>应用程序先调用各台机数据库做一些操作，但不提交事务。然后应用程序调用事务协调器（这个协调器可能也是由应用自己实现）中的提交方法。</li>\n<li>事务协调器将联络事务中涉及的每台数据库，并通知它们准备提交事务，这是第一阶段的开始。在PostgreSQL一般是调用“PREPARE TRANSACTION”命令。</li>\n<li>各台数据库接收到“PREPARE TRANSACTION”命令后，如果要返回成功，则数据库必须将自己置于以下状态：确保能在被要求提交事务时提交事务，或在被要求回滚事务时回滚事务。所以PostgreSQL会将已准备好提交的信息写入持久存储区中。如果数据库无法完成此事务，它会直接返回失败给事务协调器。</li>\n<li>事务协调器接收到了所有数据库的响应。</li>\n<li>在第二阶段，如果任一数据库在第一阶段返回失败，则事务协调器会将发一个回滚命令（ROLLBACK PREPARED）给各台数据库。如果所有数据库的响应都是成功的，则向各台数据库发送“COMMIT PREPARED”命令，通知各台数据库事务成功。</li>\n</ol>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create table t1(id int, crt_time timestamptz);<br>CREATE TABLE<br><span class=\"hljs-attribute\">mydb</span>=# begin;                                              -- 开启事务<br>BEGIN<br><span class=\"hljs-attribute\">mydb</span>=*# insert into t1 select 1, now();    -- 插入一条数据<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=*# prepare transaction <span class=\"hljs-string\">&#x27;p1&#x27;</span>;            -- 准备事务<br>PREPARE TRANSACTION<br><span class=\"hljs-attribute\">mydb</span>=# \\q<br>jintao@jintao-ThinkPad-L490:~$ sudo -iu jintao /opt/pg-master/bin/pg_ctl -D /export/pgdata-master/ restart -l /tmp/start.log     -- 重启数据库<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> shut down<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span> done<br>server stopped<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span> done<br>server started<br>jintao@jintao-ThinkPad-L490:~$ psql<br>psql (14devel)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> pg_prepared_xacts ;          -- 查看两阶段事务系统表<br> transaction | gid |           prepared            | owner  | database<br>-------------+-----+-------------------------------+--------+----------<br>        1045 | p1  | 2020-07-15 17:02:07.180102+08 | jintao | mydb<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> t1;<br> id | crt_time<br>----+----------<br>(0 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=# commit prepared <span class=\"hljs-string\">&#x27;p1&#x27;</span>;                            -- 提交<br>COMMIT PREPARED<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> t1;<br> id |           crt_time<br>----+-------------------------------<br>  1 | 2020-07-15 17:01:59.163772+08<br>(1 row)<br><br></code></pre></td></tr></table></figure>"},{"title":"Hello World","description":" ","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\ndescription: ' '\n\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"date":"2020-08-04T03:05:29.474Z","updated":"2020-08-04T03:05:29.474Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckdu7m6v1000fyreb2b50fcqq","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo new <span class=\"hljs-string\">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo server<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo generate<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo deploy<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","site":{"data":{"styles":"/* build time:Fri Aug 14 2020 20:30:30 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo new <span class=\"hljs-string\">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo server<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo generate<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">$ hexo deploy<br></code></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"Linux vim常用配置","date":"2019-04-12T12:42:06.000Z","_content":"\n列举一些有用的vim小功能, 能有效的避免重复造轮子.\n\n<!-- more -->\n\n\n# vim新建文件时, 按F4既可以添加作者信息\n\n~/.vimrc中追加如下内容\n\n```\n\"进行版权声明的设置\n\"\"添加或更新头\nmap <F4> :call TitleDet() <cr>'s\nfunction AddTitle()\n    call append(0,\"/********************************************************\")\n    call append(1,\"* Author        : ×××\")\n    call append(2,\"* Email         : ×××@×××.com\")\n    call append(3,\"* Last modified : \".strftime(\"%Y-%m-%d %H:%M\"))\n    call append(4,\"* Filename      : \".expand(\"%:t\"))\n    call append(5,\"* Description   : \")\n    call append(6,\"*********************************************************/\")\n    echohl WarningMsg | echo \"Successful in adding the copyright.\" | echohl None\nendf\n\"更新最近修改时间和文件名\nfunction UpdateTitle()\n    normal m'\n    execute '/# *Last modified:/s@:.*$@\\=strftime(\":\\t%Y-%m-%d %H:%M\")@'\n    normal ''\n    normal mk                                         \n    execute '/# *Filename:/s@:.*$@\\=\":\\t\\t\".expand(\"%:t\")@'\n    execute \"noh\"                               \n    normal 'k\n    echohl WarningMsg | echo \"Successful in updating the copy right | echohl None\nendfunction\n\"判断前10行代码里面，是否有Last modified这个单词，\n\"如果没有的话，代表没有添加过作者信息，需要新添加；\n\"如果有的话，那么只需要更新即可\nfunction TitleDet()     \n    let n = 1\n    \"默认为添加\n    while n < 7\n        let line = getline(n)\n        if line =~ '^\\#\\s*\\S*Last\\smodified:\\S*.*$'\n            call UpdateTitle()\n            return\n        endif\n        let n = n+1\n    endwhile\n    call AddTitle()\nendfunction\n```\n\n\n# vim新建python或者bash脚本添加固定内容\n\n~/.vimrc中追加如下内容\n\n```\nautocmd BufNewFile *.py,*.sh, exec \":call SetTitle()\"\nlet $author_name = \"taot.jin\"\nlet $author_email = \"taot.jin@q.com\"\n\nfunc SetTitle()\n    if &filetype == 'sh'\n    call setline(1,\"\\###################################################################\")\n    call append(line(\".\"), \"\\# File Name: \".expand(\"%\"))\n    call append(line(\".\")+1, \"\\# Author: \".$author_name)\n    call append(line(\".\")+2, \"\\# mail: \".$author_email)\n    call append(line(\".\")+3, \"\\# Created Time: \".strftime(\"%c\"))\n    call append(line(\".\")+4, \"\\#=============================================================\")\n    call append(line(\".\")+5, \"\\#!/bin/bash\")\n    call append(line(\".\")+6, \"\")\n    else\n    call setline(1,\"\\###################################################################\")\n    call append(line(\".\"), \"\\# File Name: \".expand(\"%\"))\n    call append(line(\".\")+1, \"\\# Author: \".$author_name)\n    call append(line(\".\")+2, \"\\# mail: \".$author_email)\n    call append(line(\".\")+3, \"\\# Created Time: \".strftime(\"%c\"))\n    call append(line(\".\")+4, \"\\#=============================================================\")\n    call append(line(\".\")+5, \"\\#!/usr/bin/python\")\n    call append(line(\".\")+5, \"\\# -*- coding: utf-8 -*-\")\n    \"call append(line(\".\")+6, \"\")\n    endif\nendfunc\n```\n\n# vim新建markdown文件时添加固定信息\n\n~/.vimrc中追加如下内容\n\n```\nautocmd BufNewFile *.md, exec \":call SetTitle1()\"\nlet $author_name = \"taot.jin\"\nlet $author_email = \"taot.jin@q.com\"\n\nfunc SetTitle1()\n    call setline(1,\"---\")\n    call append(line(\".\"), \"title: \")\n    call append(line(\".\")+1, \"date: \".strftime(\"%Y-%m-%d\"))\n    call append(line(\".\")+2, \"tags: \")\n    call append(line(\".\")+3, \"categories: \")\n    call append(line(\".\")+4, \"top: \")\n    call append(line(\".\")+5, \"description: \")\n    call append(line(\".\")+6, \"password: \")\n    call append(line(\".\")+7, \"\")\n    call append(line(\".\")+8, \"---\")\nendfunc\n```\n","source":"_posts/linux配置vim.md","raw":"---\ntitle: Linux vim常用配置\ndate: 2019-04-12 20:42:06\ncategories:  vim\ntags: [ Linux, vim ]\n\n---\n\n列举一些有用的vim小功能, 能有效的避免重复造轮子.\n\n<!-- more -->\n\n\n# vim新建文件时, 按F4既可以添加作者信息\n\n~/.vimrc中追加如下内容\n\n```\n\"进行版权声明的设置\n\"\"添加或更新头\nmap <F4> :call TitleDet() <cr>'s\nfunction AddTitle()\n    call append(0,\"/********************************************************\")\n    call append(1,\"* Author        : ×××\")\n    call append(2,\"* Email         : ×××@×××.com\")\n    call append(3,\"* Last modified : \".strftime(\"%Y-%m-%d %H:%M\"))\n    call append(4,\"* Filename      : \".expand(\"%:t\"))\n    call append(5,\"* Description   : \")\n    call append(6,\"*********************************************************/\")\n    echohl WarningMsg | echo \"Successful in adding the copyright.\" | echohl None\nendf\n\"更新最近修改时间和文件名\nfunction UpdateTitle()\n    normal m'\n    execute '/# *Last modified:/s@:.*$@\\=strftime(\":\\t%Y-%m-%d %H:%M\")@'\n    normal ''\n    normal mk                                         \n    execute '/# *Filename:/s@:.*$@\\=\":\\t\\t\".expand(\"%:t\")@'\n    execute \"noh\"                               \n    normal 'k\n    echohl WarningMsg | echo \"Successful in updating the copy right | echohl None\nendfunction\n\"判断前10行代码里面，是否有Last modified这个单词，\n\"如果没有的话，代表没有添加过作者信息，需要新添加；\n\"如果有的话，那么只需要更新即可\nfunction TitleDet()     \n    let n = 1\n    \"默认为添加\n    while n < 7\n        let line = getline(n)\n        if line =~ '^\\#\\s*\\S*Last\\smodified:\\S*.*$'\n            call UpdateTitle()\n            return\n        endif\n        let n = n+1\n    endwhile\n    call AddTitle()\nendfunction\n```\n\n\n# vim新建python或者bash脚本添加固定内容\n\n~/.vimrc中追加如下内容\n\n```\nautocmd BufNewFile *.py,*.sh, exec \":call SetTitle()\"\nlet $author_name = \"taot.jin\"\nlet $author_email = \"taot.jin@q.com\"\n\nfunc SetTitle()\n    if &filetype == 'sh'\n    call setline(1,\"\\###################################################################\")\n    call append(line(\".\"), \"\\# File Name: \".expand(\"%\"))\n    call append(line(\".\")+1, \"\\# Author: \".$author_name)\n    call append(line(\".\")+2, \"\\# mail: \".$author_email)\n    call append(line(\".\")+3, \"\\# Created Time: \".strftime(\"%c\"))\n    call append(line(\".\")+4, \"\\#=============================================================\")\n    call append(line(\".\")+5, \"\\#!/bin/bash\")\n    call append(line(\".\")+6, \"\")\n    else\n    call setline(1,\"\\###################################################################\")\n    call append(line(\".\"), \"\\# File Name: \".expand(\"%\"))\n    call append(line(\".\")+1, \"\\# Author: \".$author_name)\n    call append(line(\".\")+2, \"\\# mail: \".$author_email)\n    call append(line(\".\")+3, \"\\# Created Time: \".strftime(\"%c\"))\n    call append(line(\".\")+4, \"\\#=============================================================\")\n    call append(line(\".\")+5, \"\\#!/usr/bin/python\")\n    call append(line(\".\")+5, \"\\# -*- coding: utf-8 -*-\")\n    \"call append(line(\".\")+6, \"\")\n    endif\nendfunc\n```\n\n# vim新建markdown文件时添加固定信息\n\n~/.vimrc中追加如下内容\n\n```\nautocmd BufNewFile *.md, exec \":call SetTitle1()\"\nlet $author_name = \"taot.jin\"\nlet $author_email = \"taot.jin@q.com\"\n\nfunc SetTitle1()\n    call setline(1,\"---\")\n    call append(line(\".\"), \"title: \")\n    call append(line(\".\")+1, \"date: \".strftime(\"%Y-%m-%d\"))\n    call append(line(\".\")+2, \"tags: \")\n    call append(line(\".\")+3, \"categories: \")\n    call append(line(\".\")+4, \"top: \")\n    call append(line(\".\")+5, \"description: \")\n    call append(line(\".\")+6, \"password: \")\n    call append(line(\".\")+7, \"\")\n    call append(line(\".\")+8, \"---\")\nendfunc\n```\n","slug":"linux配置vim","published":1,"updated":"2021-03-05T08:30:47.555Z","_id":"ckdu7m6v3000hyrebbp1n17hd","comments":1,"layout":"post","photos":[],"link":"","content":"<p>列举一些有用的vim小功能, 能有效的避免重复造轮子.</p>\n<a id=\"more\"></a>\n<h1 id=\"vim新建文件时-按F4既可以添加作者信息\"><a href=\"#vim新建文件时-按F4既可以添加作者信息\" class=\"headerlink\" title=\"vim新建文件时, 按F4既可以添加作者信息\"></a>vim新建文件时, 按F4既可以添加作者信息</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight scilab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scilab\"><span class=\"hljs-string\">&quot;进行版权声明的设置</span><br><span class=\"hljs-string\">&quot;</span><span class=\"hljs-string\">&quot;添加或更新头</span><br><span class=\"hljs-string\">map &lt;F4&gt; :call TitleDet() &lt;cr&gt;&#x27;</span>s<br><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">AddTitle</span><span class=\"hljs-params\">()</span></span><br>    call append(<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">&quot;/********************************************************&quot;</span>)<br>    call append(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;* Author        : ×××&quot;</span>)<br>    call append(<span class=\"hljs-number\">2</span>,<span class=\"hljs-string\">&quot;* Email         : ×××@×××.com&quot;</span>)<br>    call append(<span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">&quot;* Last modified : &quot;</span>.strftime(<span class=\"hljs-string\">&quot;%Y-%m-%d %H:%M&quot;</span>))<br>    call append(<span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">&quot;* Filename      : &quot;</span>.expand(<span class=\"hljs-string\">&quot;%:t&quot;</span>))<br>    call append(<span class=\"hljs-number\">5</span>,<span class=\"hljs-string\">&quot;* Description   : &quot;</span>)<br>    call append(<span class=\"hljs-number\">6</span>,<span class=\"hljs-string\">&quot;*********************************************************/&quot;</span>)<br>    echohl WarningMsg | echo <span class=\"hljs-string\">&quot;Successful in adding the copyright.&quot;</span> | echohl None<br>endf<br><span class=\"hljs-string\">&quot;更新最近修改时间和文件名</span><br><span class=\"hljs-string\">function UpdateTitle()</span><br><span class=\"hljs-string\">    normal m&#x27;</span><br>    execute <span class=\"hljs-string\">&#x27;/# *Last modified:/s@:.*$@\\=strftime(&quot;</span>:\\t%Y-%m-%d %H:%M<span class=\"hljs-string\">&quot;)@&#x27;</span><br>    normal <span class=\"hljs-string\">&#x27;&#x27;</span><br>    normal mk                                         <br>    execute <span class=\"hljs-string\">&#x27;/# *Filename:/s@:.*$@\\=&quot;</span>:\\t\\t<span class=\"hljs-string\">&quot;.expand(&quot;</span>%:t<span class=\"hljs-string\">&quot;)@&#x27;</span><br>    execute <span class=\"hljs-string\">&quot;noh&quot;</span>                               <br>    normal <span class=\"hljs-string\">&#x27;k</span><br><span class=\"hljs-string\">    echohl WarningMsg | echo &quot;</span>Successful in updating the copy right | echohl None<br><span class=\"hljs-keyword\">endfunction</span><br><span class=\"hljs-string\">&quot;判断前10行代码里面，是否有Last modified这个单词，</span><br><span class=\"hljs-string\">&quot;</span>如果没有的话，代表没有添加过作者信息，需要新添加；<br><span class=\"hljs-string\">&quot;如果有的话，那么只需要更新即可</span><br><span class=\"hljs-string\">function TitleDet()     </span><br><span class=\"hljs-string\">    let n = 1</span><br><span class=\"hljs-string\">    &quot;</span>默认为添加<br>    <span class=\"hljs-keyword\">while</span> n &lt; <span class=\"hljs-number\">7</span><br>        let line = getline(n)<br>        <span class=\"hljs-keyword\">if</span> line =~ <span class=\"hljs-string\">&#x27;^\\#\\s*\\S*Last\\smodified:\\S*.*$&#x27;</span><br>            call UpdateTitle()<br>            <span class=\"hljs-keyword\">return</span><br>        endif<br>        let n = n+<span class=\"hljs-number\">1</span><br>    endwhile<br>    call AddTitle()<br><span class=\"hljs-keyword\">endfunction</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"vim新建python或者bash脚本添加固定内容\"><a href=\"#vim新建python或者bash脚本添加固定内容\" class=\"headerlink\" title=\"vim新建python或者bash脚本添加固定内容\"></a>vim新建python或者bash脚本添加固定内容</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">autocmd</span> BufNewFile *.<span class=\"hljs-keyword\">py</span>,*.<span class=\"hljs-keyword\">sh</span>, exec <span class=\"hljs-string\">&quot;:call SetTitle()&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_name = <span class=\"hljs-string\">&quot;taot.jin&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_email = <span class=\"hljs-string\">&quot;taot.jin@q.com&quot;</span><br><br>func SetTitle()<br>    <span class=\"hljs-keyword\">if</span> &amp;<span class=\"hljs-keyword\">filetype</span> == <span class=\"hljs-string\">&#x27;sh&#x27;</span><br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;\\###################################################################&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;\\# File Name: &quot;</span>.<span class=\"hljs-built_in\">expand</span>(<span class=\"hljs-string\">&quot;%&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;\\# Author: &quot;</span>.$author_name)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;\\# mail: &quot;</span>.$author_email)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;\\# Created Time: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%c&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;\\#=============================================================&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\#!/bin/bash&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">6</span>, <span class=\"hljs-string\">&quot;&quot;</span>)<br>    <span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;\\###################################################################&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;\\# File Name: &quot;</span>.<span class=\"hljs-built_in\">expand</span>(<span class=\"hljs-string\">&quot;%&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;\\# Author: &quot;</span>.$author_name)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;\\# mail: &quot;</span>.$author_email)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;\\# Created Time: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%c&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;\\#=============================================================&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\#!/usr/bin/python&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\# -*- coding: utf-8 -*-&quot;</span>)<br>    <span class=\"hljs-string\">&quot;call append(line(&quot;</span>.<span class=\"hljs-string\">&quot;)+6, &quot;</span><span class=\"hljs-comment\">&quot;)</span><br>    <span class=\"hljs-keyword\">endif</span><br>endfunc<br></code></pre></td></tr></table></figure>\n<h1 id=\"vim新建markdown文件时添加固定信息\"><a href=\"#vim新建markdown文件时添加固定信息\" class=\"headerlink\" title=\"vim新建markdown文件时添加固定信息\"></a>vim新建markdown文件时添加固定信息</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">autocmd</span> BufNewFile *.md, exec <span class=\"hljs-string\">&quot;:call SetTitle1()&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_name = <span class=\"hljs-string\">&quot;taot.jin&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_email = <span class=\"hljs-string\">&quot;taot.jin@q.com&quot;</span><br><br>func SetTitle1()<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;---&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;title: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;date: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%Y-%m-%d&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;tags: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;categories: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;top: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;description: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">6</span>, <span class=\"hljs-string\">&quot;password: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">7</span>, <span class=\"hljs-string\">&quot;&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">8</span>, <span class=\"hljs-string\">&quot;---&quot;</span>)<br>endfunc<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>列举一些有用的vim小功能, 能有效的避免重复造轮子.</p>","more":"<h1 id=\"vim新建文件时-按F4既可以添加作者信息\"><a href=\"#vim新建文件时-按F4既可以添加作者信息\" class=\"headerlink\" title=\"vim新建文件时, 按F4既可以添加作者信息\"></a>vim新建文件时, 按F4既可以添加作者信息</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight scilab\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scilab\"><span class=\"hljs-string\">&quot;进行版权声明的设置</span><br><span class=\"hljs-string\">&quot;</span><span class=\"hljs-string\">&quot;添加或更新头</span><br><span class=\"hljs-string\">map &lt;F4&gt; :call TitleDet() &lt;cr&gt;&#x27;</span>s<br><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">AddTitle</span><span class=\"hljs-params\">()</span></span><br>    call append(<span class=\"hljs-number\">0</span>,<span class=\"hljs-string\">&quot;/********************************************************&quot;</span>)<br>    call append(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;* Author        : ×××&quot;</span>)<br>    call append(<span class=\"hljs-number\">2</span>,<span class=\"hljs-string\">&quot;* Email         : ×××@×××.com&quot;</span>)<br>    call append(<span class=\"hljs-number\">3</span>,<span class=\"hljs-string\">&quot;* Last modified : &quot;</span>.strftime(<span class=\"hljs-string\">&quot;%Y-%m-%d %H:%M&quot;</span>))<br>    call append(<span class=\"hljs-number\">4</span>,<span class=\"hljs-string\">&quot;* Filename      : &quot;</span>.expand(<span class=\"hljs-string\">&quot;%:t&quot;</span>))<br>    call append(<span class=\"hljs-number\">5</span>,<span class=\"hljs-string\">&quot;* Description   : &quot;</span>)<br>    call append(<span class=\"hljs-number\">6</span>,<span class=\"hljs-string\">&quot;*********************************************************/&quot;</span>)<br>    echohl WarningMsg | echo <span class=\"hljs-string\">&quot;Successful in adding the copyright.&quot;</span> | echohl None<br>endf<br><span class=\"hljs-string\">&quot;更新最近修改时间和文件名</span><br><span class=\"hljs-string\">function UpdateTitle()</span><br><span class=\"hljs-string\">    normal m&#x27;</span><br>    execute <span class=\"hljs-string\">&#x27;/# *Last modified:/s@:.*$@\\=strftime(&quot;</span>:\\t%Y-%m-%d %H:%M<span class=\"hljs-string\">&quot;)@&#x27;</span><br>    normal <span class=\"hljs-string\">&#x27;&#x27;</span><br>    normal mk                                         <br>    execute <span class=\"hljs-string\">&#x27;/# *Filename:/s@:.*$@\\=&quot;</span>:\\t\\t<span class=\"hljs-string\">&quot;.expand(&quot;</span>%:t<span class=\"hljs-string\">&quot;)@&#x27;</span><br>    execute <span class=\"hljs-string\">&quot;noh&quot;</span>                               <br>    normal <span class=\"hljs-string\">&#x27;k</span><br><span class=\"hljs-string\">    echohl WarningMsg | echo &quot;</span>Successful in updating the copy right | echohl None<br><span class=\"hljs-keyword\">endfunction</span><br><span class=\"hljs-string\">&quot;判断前10行代码里面，是否有Last modified这个单词，</span><br><span class=\"hljs-string\">&quot;</span>如果没有的话，代表没有添加过作者信息，需要新添加；<br><span class=\"hljs-string\">&quot;如果有的话，那么只需要更新即可</span><br><span class=\"hljs-string\">function TitleDet()     </span><br><span class=\"hljs-string\">    let n = 1</span><br><span class=\"hljs-string\">    &quot;</span>默认为添加<br>    <span class=\"hljs-keyword\">while</span> n &lt; <span class=\"hljs-number\">7</span><br>        let line = getline(n)<br>        <span class=\"hljs-keyword\">if</span> line =~ <span class=\"hljs-string\">&#x27;^\\#\\s*\\S*Last\\smodified:\\S*.*$&#x27;</span><br>            call UpdateTitle()<br>            <span class=\"hljs-keyword\">return</span><br>        endif<br>        let n = n+<span class=\"hljs-number\">1</span><br>    endwhile<br>    call AddTitle()<br><span class=\"hljs-keyword\">endfunction</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"vim新建python或者bash脚本添加固定内容\"><a href=\"#vim新建python或者bash脚本添加固定内容\" class=\"headerlink\" title=\"vim新建python或者bash脚本添加固定内容\"></a>vim新建python或者bash脚本添加固定内容</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">autocmd</span> BufNewFile *.<span class=\"hljs-keyword\">py</span>,*.<span class=\"hljs-keyword\">sh</span>, exec <span class=\"hljs-string\">&quot;:call SetTitle()&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_name = <span class=\"hljs-string\">&quot;taot.jin&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_email = <span class=\"hljs-string\">&quot;taot.jin@q.com&quot;</span><br><br>func SetTitle()<br>    <span class=\"hljs-keyword\">if</span> &amp;<span class=\"hljs-keyword\">filetype</span> == <span class=\"hljs-string\">&#x27;sh&#x27;</span><br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;\\###################################################################&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;\\# File Name: &quot;</span>.<span class=\"hljs-built_in\">expand</span>(<span class=\"hljs-string\">&quot;%&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;\\# Author: &quot;</span>.$author_name)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;\\# mail: &quot;</span>.$author_email)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;\\# Created Time: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%c&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;\\#=============================================================&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\#!/bin/bash&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">6</span>, <span class=\"hljs-string\">&quot;&quot;</span>)<br>    <span class=\"hljs-keyword\">else</span><br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;\\###################################################################&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;\\# File Name: &quot;</span>.<span class=\"hljs-built_in\">expand</span>(<span class=\"hljs-string\">&quot;%&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;\\# Author: &quot;</span>.$author_name)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;\\# mail: &quot;</span>.$author_email)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;\\# Created Time: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%c&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;\\#=============================================================&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\#!/usr/bin/python&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;\\# -*- coding: utf-8 -*-&quot;</span>)<br>    <span class=\"hljs-string\">&quot;call append(line(&quot;</span>.<span class=\"hljs-string\">&quot;)+6, &quot;</span><span class=\"hljs-comment\">&quot;)</span><br>    <span class=\"hljs-keyword\">endif</span><br>endfunc<br></code></pre></td></tr></table></figure>\n<h1 id=\"vim新建markdown文件时添加固定信息\"><a href=\"#vim新建markdown文件时添加固定信息\" class=\"headerlink\" title=\"vim新建markdown文件时添加固定信息\"></a>vim新建markdown文件时添加固定信息</h1><p>~/.vimrc中追加如下内容</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"><span class=\"hljs-keyword\">autocmd</span> BufNewFile *.md, exec <span class=\"hljs-string\">&quot;:call SetTitle1()&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_name = <span class=\"hljs-string\">&quot;taot.jin&quot;</span><br><span class=\"hljs-keyword\">let</span> $author_email = <span class=\"hljs-string\">&quot;taot.jin@q.com&quot;</span><br><br>func SetTitle1()<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-built_in\">setline</span>(<span class=\"hljs-number\">1</span>,<span class=\"hljs-string\">&quot;---&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>), <span class=\"hljs-string\">&quot;title: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;date: &quot;</span>.<span class=\"hljs-built_in\">strftime</span>(<span class=\"hljs-string\">&quot;%Y-%m-%d&quot;</span>))<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;tags: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;categories: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;top: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&quot;description: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">6</span>, <span class=\"hljs-string\">&quot;password: &quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">7</span>, <span class=\"hljs-string\">&quot;&quot;</span>)<br>    <span class=\"hljs-keyword\">call</span> <span class=\"hljs-keyword\">append</span>(<span class=\"hljs-built_in\">line</span>(<span class=\"hljs-string\">&quot;.&quot;</span>)+<span class=\"hljs-number\">8</span>, <span class=\"hljs-string\">&quot;---&quot;</span>)<br>endfunc<br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL有用的SQL","date":"2020-07-31T10:19:15.000Z","top":10,"_content":"\n记录工作中常用到的PostgreSQL常用SQL， tps, qps 等等.\n\n<!-- more -->\n\n# 抓去网站天气信息\n```\npostgres=#   CREATE OR REPLACE FUNCTION get_weather_info(city text)\n RETURNS jsonb\n LANGUAGE plpython3u\nAS $function$\n\nimport re\nimport json\nimport requests, bs4\n\nres = requests.get('http://pm25.in/{}'.format(city))\nsoup = bs4.BeautifulSoup(res.text, 'html.parser')\n\n#script = soup.findAll('script', text=re.compile(\"highcharts\"))\n#categorie = re.findall(\"categories: (.*),\",script[0].string)[0]\n#data = re.findall(\"data: (.*),\",script[0].string)[0]\n#info = dict(zip(json.loads(categorie), json.loads(data)))\n\ntable = soup.find('table', attrs={\"id\": \"detail-data\"})\ninfo = {\n    \"thead\": [ th.get_text() for th in table.find('thead').find('tr').select('th') ],\n    \"tbody\": []\n}\ntheads = [ th.get_text() for th in table.find('thead').find('tr').select('th') ]\nfor tr in table.find('tbody').findAll('tr'):\n    tbodys = [ td.get_text() for td in tr.select('td') ]\n    info['tbody'].append(tbodys)\n\nreturn json.dumps(info, ensure_ascii=False)\n\n$function$;\nCREATE FUNCTION\npostgres=# select get_weather_info('putian');\n\n                                                                          f1\n\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n------------------------------------------------------------------------------------------------------------------------------------------------------\n {\"tbody\": [[\"荔城区仓后路\", \"39\", \"优\", \"_\", \"20\", \"39\", \"0.5\", \"15\", \"122\", \"90\", \"5\"], [\"莆田市监测站\", \"_\", \"\", \"_\", \"20\", \"39\", \"_\", \"14\", \"126\", \"98\", \"4\"], [\"涵江区六中\", \"_\", \"\", \"_\", \"_\", \"_\", \"0.6\", \"19\", \"138\", \"88\", \"7\"], [\"秀屿区政府\", \"51\",\n \"良\", \"颗粒物(PM10)\", \"18\", \"52\", \"0.6\", \"10\", \"128\", \"83\", \"5\"], [\"东圳水库\", \"19\", \"优\", \"_\", \"10\", \"10\", \"0.5\", \"10\", \"58\", \"58\", \"4\"], [\"东圳水库(对照点)\", \"36\", \"优\", \"_\", \"19\", \"34\", \"0.5\", \"13\", \"114\", \"81\", \"3\"]], \"thead\": [\"监测点\", \"AQI\", \"空\n质量指数类别\", \"首要污染物\", \"PM2.5细颗粒物\", \"PM10可吸入颗粒物\", \"CO一氧化碳\", \"NO2二氧化氮\", \"O3臭氧1小时平均\", \"O3臭氧8小时平均\", \"SO2二氧化硫\"]}\n(1 row)\n\n```\n\n# plpgsql函数获取Server磁盘空间信息\n```\nCREATE OR REPLACE FUNCTION public.get_disk_size()\n RETURNS jsonb\n LANGUAGE plpgsql\nAS $function$\ndeclare\n    sqlstring text;\n    tablename text;\n    result jsonb;\nbegin\n    -- uuid_generate_v4() in pg12-， gen_random_uuid() in pg13+\n    tablename = quote_ident( 'get_disk_size_' ||  uuid_generate_v4()::text);\n    sqlstring = format('create temp table if not exists %s(Filesystem text, type text, Size int, Used int, Avail int, \"useper\" numeric, \"mounted on\" text) ON COMMIT DROP', tablename);\n    execute sqlstring;\n    --LC_ALL=C ignore OS language environment\n    sqlstring = format('copy %s from program ''LC_ALL=C /bin/df -Tm | /bin/grep -v \"Mounted\" | /bin/sed \"s/\\s\\+/|/g\" | /bin/sed \"s/%%//g\"'' with delimiter ''|''', tablename);\n    execute sqlstring;\n    sqlstring = format('select json_agg(row_to_json(%s.*)) from %s', tablename, tablename);\n    execute sqlstring into result;\n    return result;\nend;\n$function$;\n\n```\n\n# python函数获取Server磁盘空间信息\n```\ncreate or replace function get_disk_size()\nreturns jsonb as\n$$\nimport psutil as ps\nimport json\n\nreturn json.dumps([{\n    \"mounted on\": part.mountpoint,\n    \"filesystem\": part.device,\n    \"size\": round(ps.disk_usage(part.mountpoint).total / 1024 / 1024, 2),\n    \"avail\": round(ps.disk_usage(part.mountpoint).free / 1024 / 1024, 2),\n    \"used\": round(ps.disk_usage(part.mountpoint).used / 1024 / 1024, 2),\n    \"use%\": ps.disk_usage(part.mountpoint).percent,\n    \"type\": part.fstype,\n    \"opts\": part.opts}\n    for part in ps.disk_partitions()])\n$$LANGUAGE plpython3u;\n```\n\n# 主库查询主从延迟\n```\n SELECT pg_stat_replication.application_name,\n    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), pg_stat_replication.replay_lsn)) AS diff\n   FROM pg_stat_replication;\n```\n\n# 从库查询主从延迟\n```\nSELECT\n    CASE\n        WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0::double precision\n        ELSE date_part('epoch'::text, now() - pg_last_xact_replay_timestamp())\n    END AS log_delay;\n```\n\n# 按query分组查询活跃SQL数量\n```\n SELECT pg_stat_activity.query,\n    count(1) AS count\n   FROM pg_stat_activity\n  WHERE pg_stat_activity.state <> 'idle'::text AND pg_stat_activity.pid <> pg_backend_pid() AND pg_stat_activity.query <> ''::text AND pg_stat_activity.query !~ '^DISCARD|^SET extra_float_digits = 3'::text\n  GROUP BY pg_stat_activity.query\n HAVING count(1) > 1\n  ORDER BY (count(1)) DESC\n LIMIT 10;\n```\n\n# 查询锁\n```\nselect\n      wait.pid,\n      wait.state,\n      wait.datname,\n      (select string_agg(distinct transactionid::text, ',') from pg_locks where pid = wait.pid and locktype = 'transactionid' and transactionid::text <> wait.transactionid::text),\n      wait.virtualxid,\n      wait.locktype,\n      wait.usename,\n      wait.application_name,\n      wait.client_addr,\n      wait.wait_event_type,\n      wait.wait_event,\n      wait.query_start,\n      wait.query,\n\n      wait.relation,\n      wait.datname || '.' || d.nspname || '.' || c.relname as relname,\n      granted.relation,\n\n      granted.pid              as waitfor_pid,\n      granted.state            as waitfor_state,\n      granted.transactionid    as waitfor_transactionid,\n      granted.virtualxid       as waitfor_virtualxid,\n      granted.locktype         as waitfor_locktype,\n      granted.usename          as waitfor_usename,\n      granted.client_addr      as waitfor_client_addr,\n      granted.application_name as waitfor_application_name,\n      granted.wait_event_type  as waitfor_wait_event_type,\n      granted.wait_event       as waitfor_wait_event,\n      granted.query_start      as waitfor_query_start,\n      granted.query            as waitfor_query,\n      now() - granted.query_start  as waitfor_time\n\nfrom\n    (select\n          a.pid,\n          a.state,\n          b.transactionid,\n          b.virtualxid,\n          b.locktype,\n          b.relation,\n          b.page,\n          b.tuple,\n          a.usename,\n          a.datname,\n          a.application_name,\n          a.client_addr,\n          a.wait_event_type,\n          a.wait_event,\n          a.query_start,\n          a.query\n     from\n          pg_stat_activity a,\n          pg_locks b\n     where\n          a.wait_event_type is not null\n          and a.pid = b.pid\n          and granted = 'f'\n    ) wait\njoin\n    (select\n          b.pid,\n          b.state,\n          a.transactionid,\n          a.virtualxid,\n          a.locktype,\n          a.relation,\n          a.page,\n          a.tuple,\n          b.usename,\n          b.datname,\n          b.application_name,\n          b.client_addr,\n          b.wait_event_type,\n          b.wait_event,\n          b.query_start,\n          b.query\n    from\n        pg_locks a,\n        pg_stat_activity b\n    where\n        a.pid = b.pid\n        and a.granted = 't'\n    ) granted\non (\n    ( wait.locktype = 'transactionid'\n    and granted.locktype = 'transactionid'\n    and wait.transactionid = granted.transactionid )\n    or\n    ( wait.locktype = 'relation'\n    and granted.locktype = 'relation'\n    and wait.relation = granted.relation\n    )\n    or\n    ( wait.locktype = 'virtualxid'\n    and granted.locktype = 'virtualxid'\n    and wait.virtualxid = granted.virtualxid )\n    or\n    ( wait.locktype = 'tuple'\n    and granted.locktype = 'tuple'\n    and wait.relation = granted.relation\n    and wait.page = granted.page\n    and wait.tuple = granted.tuple )\n)\nleft join\n    pg_class c\non ( c.relfilenode = wait.relation )\nleft join\n    pg_namespace d\non ( c.relnamespace = d.oid )\norder by\n    granted.query_start\n;\n```\n\n# 查询表大小, 按占用大小排序\n```\nSELECT\n    t.spcname,\n    (n.nspname::text || '.'::text) || c.relname::text AS relation,\n    pg_size_pretty(pg_total_relation_size(c.oid::regclass)) AS total_table_size,\n    pg_size_pretty(pg_relation_size(c.oid::regclass)) AS table_only_size,\n    pg_size_pretty(pg_indexes_size(c.oid::regclass)) AS total_index_size\nFROM\n    pg_class c\n    LEFT JOIN pg_tablespace t ON c.reltablespace = t.oid\n    LEFT JOIN pg_namespace n ON n.oid = c.relnamespace\nWHERE (n.nspname <> ALL (ARRAY['pg_catalog'::name, 'information_schema'::name, 'pg_toast'::name]))\n    AND c.relkind = 'r'::\"char\"\nORDER BY\n    (pg_total_relation_size(c.oid::regclass)) DESC;\n```\n\n\n\n# 找出重复的index\n```\nSELECT\n    relname,\n    (array_agg(idx))[1] idx1,\n    pg_get_indexdef((array_agg(idx))[1]) idx1_def,\n    (array_agg(idx))[2] idx2,\n    pg_get_indexdef((array_agg(idx))[2]) idx2_def,\n    (array_agg(idx))[3] idx3,\n    pg_get_indexdef((array_agg(idx))[3]) idx3_def\nFROM (\n    SELECT\n        indrelid::regclass AS relname,\n        indexrelid::regclass AS idx,\n        (indrelid::text || indclass::text || indkey::text || COALESCE(indexprs::text, '') || COALESCE(indpred::text, '')) AS KEY\n    FROM\n        pg_index) sub\nGROUP BY\n    relname,\n    KEY\nHAVING\n    count(*) > 1;\n```\n\n# 自定义操作符兼容Oracle varchar = int\n```\nmydb=# create table test(info varchar);\nCREATE TABLE\nmydb=# insert into test select '1';\nINSERT 0 1\nmydb=# insert into test select '2';\nINSERT 0 1\nmydb=# insert into test select '3';\nINSERT 0 1\nmydb=# select * from test;\n info\n------\n 1\n 2\n 3\n(3 rows)\n\nmydb=# select * from test where info = 1;\nERROR:  operator does not exist: character varying = integer\nLINE 1: select * from test where info = 1;\n                                      ^\nHINT:  No operator matches the given name and argument types. You might need to add explicit type casts.\nmydb=# CREATE OR REPLACE FUNCTION equal(character varying, integer) RETURNS boolean AS $function$ select cast($1 as text) = cast($2 as text) $function$ LANGUAGE sql;\nCREATE FUNCTION\nmydb=# create operator = (leftarg = varchar, rightarg = int, procedure = equal, commutator = =);\nCREATE OPERATOR\nmydb=# select * from test where info = 1;\n info\n------\n 1\n(1 row)\n\nmydb=#\n\n```\n\n# 兼容instr \n```\nmydb=# select instr('helloworld', 'l', 2, 2);\n instr\n-------\n     4\n(1 row)\n\nmydb=# select instr('helloworld', 'l', 3, 2);\n instr\n-------\n     4\n(1 row)\n\nmydb=# select instr('helloworld', 'l', -1, 1);\n instr\n-------\n     9\n(1 row)\n\nmydb=# select instr('helloworld', 'l', -2, 1);\n instr\n-------\n     9\n(1 row)\n\nmydb=# \\sf instr\nCREATE OR REPLACE FUNCTION public.instr(str text, sub text, startpos integer DEFAULT 1, occurrence integer DEFAULT 1)\n RETURNS integer\n LANGUAGE plpgsql\nAS $function$\ndeclare\n    tail text;\n    shift int;\n    pos int;\n    i int;\nbegin\n    shift:= 0;\n    if startpos = 0 or occurrence <= 0 then\n        return 0;\n    end if;\n    if startpos < 0 then\n        str:= reverse(str);\n        sub:= reverse(sub);\n        pos:= -startpos;\n    else\n        pos:= startpos;\n    end if;\n    for i in 1..occurrence loop\n        shift:= shift+ pos;\n        tail:= substr(str, shift);\n        pos:= strpos(tail, sub);\n        if pos = 0 then\n            return 0;\n        end if;\n    end loop;\n    if startpos > 0 then\n        return pos+ shift- 1;\n    else\n        return length(str)- length(sub)- pos- shift+ 3;\n    end if;\nend $function$\nmydb=#\n\n```\n\n# procedure 异常处理\n```\nmydb=# CREATE OR REPLACE PROCEDURE f1()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  my_ex_state text;\n  my_ex_message text;\n  my_ex_detail text;\n  my_ex_hint text;\n  my_ex_ctx text;\nbegin\n  begin\n    raise notice 'A';\n  exception when others then\n    raise notice 'C';\n    GET STACKED DIAGNOSTICS\n      my_ex_state   = RETURNED_SQLSTATE,\n      my_ex_message = MESSAGE_TEXT,\n      my_ex_detail  = PG_EXCEPTION_DETAIL,\n      my_ex_hint    = PG_EXCEPTION_HINT,\n      my_ex_ctx     = PG_EXCEPTION_CONTEXT\n    ;\n    raise notice '% % % % %', my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;\n  end;\n\n  commit;\n\n  begin\n    raise notice 'B';\n  exception when others then\n    raise notice 'C';\n    GET STACKED DIAGNOSTICS\n      my_ex_state   = RETURNED_SQLSTATE,\n      my_ex_message = MESSAGE_TEXT,\n      my_ex_detail  = PG_EXCEPTION_DETAIL,\n      my_ex_hint    = PG_EXCEPTION_HINT,\n      my_ex_ctx     = PG_EXCEPTION_CONTEXT\n    ;\n    raise notice '% % % % %', my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;\n  end;\nend;\n$procedure$\n;\n\n```\n\n# 找下一个周末\n```\npostgres=# select next_day('2020-12-22'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\npostgres=# select next_day('2020-12-21'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\npostgres=# select next_day('2020-12-20'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\n```\n\n# PostgreSQL只迁移FUNCTION\n```\npg_dump -h localhost -U jintao -Fc -s -f db_dump mydb\nmore db_dump\npg_restore -l db_dump | grep FUNCTION > function_list\ncat function_list\npg_restore -h localhost -U postgres -d postgres -L function_list db_dump\n```\n\n# pageinspect 查看xmax的状态\n\n```\nSELECT lp,\n       t_ctid AS ctid,\n       t_xmin AS xmin,\n       t_xmax AS xmax,\n       (t_infomask & 128)::boolean AS xmax_is_lock,\n       (t_infomask & 1024)::boolean AS xmax_committed,\n       (t_infomask & 2048)::boolean AS xmax_rolled_back,\n       (t_infomask & 4096)::boolean AS xmax_multixact,\n       t_attrs[1] AS p_id,\n       t_attrs[2] AS p_val\nFROM heap_page_item_attrs(\n        get_raw_page('parent', 0),\n        'parent'\n     );\n```\n\n# PostgreSQL9.1主从延迟查询\n```\npostgres=# \\sf pg_xlog_location_diff\nCREATE OR REPLACE FUNCTION pg_catalog.pg_xlog_location_diff(text, text)\n RETURNS numeric\n LANGUAGE plpgsql\nAS $function$\n    DECLARE\n       offset1 text;\n       offset2 text;\n       xlog1 text;\n       xlog2 text;\n       SQL text;\n       diff text;\n    BEGIN\n       /* Extract the Offset and xlog from input in\n          offset and xlog variables */\n\n       offset1=split_part($1,'/',2);\n         xlog1=split_part($1,'/',1);\n       offset2=split_part($2,'/',2);\n         xlog2=split_part($2,'/',1);\n\n       /* Prepare SQL query for calculation based on following formula\n         (FF000000 * xlog + offset) - (FF000000 * xlog + offset)\n         which gives value in hexadecimal. Since, hexadecimal calculation is cumbersome\n         so convert into decimal and then calculate the difference */\n\n       SQL='SELECT (x'''||'FF000000'||'''::bigint * x'''||xlog1||'''::bigint\n                                +  x'''||offset1||'''::bigint)'||'\n                -\n                   (x'''||'FF000000'||'''::bigint * x'''||xlog2||'''::bigint\n                                +  x'''||offset2||'''::bigint)';\n       EXECUTE SQL into diff;\n\n       /* Return the value in numeric by explicit casting  */\n\n       RETURN diff::numeric;\n    END;\n $function$\npostgres=# SELECT\n    application_name,\n    pg_xlog_location_diff(pg_current_xlog_location(), replay_location) as diff\nFROM\n    pg_stat_replication\n;\n application_name | diff\n------------------+-------\n walreceiver      | 18272\n(1 row)\n\n```\n\n# 获取cluster初始化的时间\n```\n$ pg_controldata |grep -i system\nDatabase system identifier:           6888133981158752630\n$ psql\npsql (14devel)\nType \"help\" for help.\n\nmydb=# SELECT to_timestamp(((6888133981158752630>>32) & (2^32 -1)::bigint));\n      to_timestamp\n------------------------\n 2020-10-27 11:17:48+08\n(1 row)\n\nmydb=#\n\n```\n\n# tuple-internal详解\n```\nhttps://pgconf.ru/media/2016/05/13/tuple-internals.pdf\n```\n\n# PostgreSQL clog最大大小\n```\n#define CLOG_BITS_PER_XACT      2   //2bit一个事物\n#define CLOG_XACTS_PER_BYTE 4       //1Byte4个事物\n#define CLOG_XACTS_PER_PAGE (BLCKSZ * CLOG_XACTS_PER_BYTE)\n\n500M，内存中处理完全够效率, 想想要是64位xid, 光clog大小就不一定多大了.\n\nclog总大小约500MB, 每个clog文件256kb, 最多2097152个clog文件.\n\nmydb=# select 2^31/4/256;\n ?column?\n----------\n  2097152\n(1 row)\n\nmydb=# select pg_size_pretty((2^31/4)::bigint);\n pg_size_pretty\n----------------\n 512 MB\n(1 row)\n\nmydb=#\n\n```\n\n# bytea转为原始字符\n```\npostgres=# create table t_bytea(info bytea);\nCREATE TABLE\npostgres=# insert into t_bytea select 'hello';\nINSERT 0 1\npostgres=# insert into t_bytea select '我的家乡';\nINSERT 0 1\npostgres=# select * from t_bytea ;\n            info\n----------------------------\n \\x68656c6c6f\n \\xe68891e79a84e5aeb6e4b9a1\n(2 rows)\n\npostgres=# select encode(info, 'escape') from t_bytea ;\n                      encode\n--------------------------------------------------\n hello\n \\346\\210\\221\\347\\232\\204\\345\\256\\266\\344\\271\\241\n(2 rows)\n\npostgres=# select convert_from(info, 'UTF8') from t_bytea ;\n convert_from\n--------------\n hello\n 我的家乡\n(2 rows)\n\n```\n\n```\ncreate schema dba;\n```\n#  tps\n```\ncreate or replace procedure dba.tps() as $$\ndeclare\n  v1 int8;\n  v2 int8;\nbegin\n  select txid_snapshot_xmax(txid_current_snapshot()) into v1;\n  commit;\n  perform pg_sleep(1);\n  select txid_snapshot_xmax(txid_current_snapshot()) into v2;\n  commit;\n  raise notice 'tps: %', v2-v1;\nend;\n$$ language plpgsql ;\n```\n# qps\n\n用select sum(calls) s from pg_stat_statements(false) 而不用select sum(calls) s from pg_stat_statements\n不需要具体的query, 查询效率好很多.\n```\nwith\na as (select sum(calls) s from pg_stat_statements(false)),   \nb as (select sum(calls) s from pg_stat_statements(false) , pg_sleep(1))   \nselect   \nb.s-a.s          -- QPS  \nfrom a,b;\n```\n\n#  查询没有使用过的大于1MB的索引 top 10\n```\nCREATE VIEW dba.top10notusedidx AS\nSELECT\n    pg_size_pretty(pg_relation_size(indexrelid)),\n    *\nFROM\n    pg_stat_all_indexes\nWHERE\n    pg_relation_size(indexrelid) >= 1024000\n    AND (idx_scan = 0\n        OR idx_tup_read = 0\n        OR idx_tup_fetch = 0)\n    AND schemaname NOT IN ('pg_toast', 'pg_catalog')\nORDER BY\n    pg_relation_size(indexrelid) DESC\nLIMIT 10;\n```\n注意, PK、UK如果只是用于约束, 可能不会被统计计数,但是不能删掉) \n\n# 查询没有使用过的大于1MB的表 top 10\n```\nCREATE VIEW dba.top10notusedtab AS\nSELECT\n    pg_size_pretty(pg_relation_size(relid)),\n    *\nFROM\n    pg_stat_all_tables\nWHERE\n    pg_relation_size(relid) >= 1024000\n    AND seq_scan = 0\n    AND idx_scan = 0\n    AND schemaname NOT IN ('pg_toast', 'pg_catalog', 'information_schema')\nORDER BY\n    pg_relation_size(relid) DESC\nLIMIT 10;\n```\n# 查询热表top 10\n```\nCREATE VIEW dba.top10hottab AS\nSELECT\n    pg_size_pretty(pg_relation_size(relid)),\n    *\nFROM\n    pg_stat_all_tables\nWHERE\n    schemaname NOT IN ('pg_toast', 'pg_catalog', 'information_schema')\nORDER BY\n    seq_scan + idx_scan DESC,\n    pg_relation_size(relid) DESC\nLIMIT 10;\n```\n# 在standby节点执行， 接收wal的速度。\n```\nCREATE OR REPLACE PROCEDURE dba.wal_receive_bw()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  v1 pg_lsn;\n  v2 pg_lsn;\nbegin\n  select pg_last_wal_receive_lsn() into v1;\n  commit;\n  perform pg_sleep(1);\n  select pg_last_wal_receive_lsn() into v2;\n  commit;\n  raise notice 'wal receive bw: %/s', pg_size_pretty(pg_wal_lsn_diff(v2,v1));\nend;\n$procedure$;\n```\n# 在standby节点执行， replay wal的速度。\n```\nCREATE OR REPLACE PROCEDURE dba.wal_replay_bw()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  v1 pg_lsn;\n  v2 pg_lsn;\nbegin\n  select pg_last_wal_replay_lsn() into v1;\n  commit;\n  perform pg_sleep(1);\n  select pg_last_wal_replay_lsn() into v2;\n  commit;\n  raise notice 'wal replay bw: %/s', pg_size_pretty(pg_wal_lsn_diff(v2,v1));\nend;\n$procedure$; \n```\n\n# 查询膨胀空间top 10的表\n```\ncreate view dba.top10bloatsizetable as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml order by wastedbytes desc limit 5;  \n```\n\n# 查询膨胀空间top 10的索引\n```\ncreate view dba.top10bloatsizeindex as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml order by wastedibytes desc limit 5;  \n```\n# 查询膨胀比例top 10的表(浪费空间大于10MB的表)\n```\ncreate view dba.top10bloatratiotable as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml   \nwhere (CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END) >= 10240000  \norder by tbloat desc,wastedbytes desc limit 5;  \n```\n# 查询膨胀比例top 10的索引(浪费空间大于10MB的索引)\n```\ncreate view dba.top10bloatratioindex as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml   \nwhere (CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END) >= 10240000  \norder by ibloat desc,wastedibytes desc limit 5; \n```\n# 查询序列距离最大值的范围\n```\ncreate view dba.seqs as select max_value-last_value,* from pg_sequences order by max_value-last_value ;\n```\n# freeze风暴预测相关的3个视图\n```\ncreate view dba.v_freeze as    \nselect     \n  e.*,     \n  a.*     \nfrom    \n(select     \n  current_setting('autovacuum_freeze_max_age')::int as v1,            -- 如果表的事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    \n  current_setting('autovacuum_multixact_freeze_max_age')::int as v2,  -- 如果表的并行事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    \n  current_setting('vacuum_freeze_min_age')::int as v3,                -- 手动或自动垃圾回收时, 如果记录的事务ID年龄大于该值, 将被FREEZE    \n  current_setting('vacuum_multixact_freeze_min_age')::int as v4,      -- 手动或自动垃圾回收时, 如果记录的并行事务ID年龄大于该值, 将被FREEZE    \n  current_setting('vacuum_freeze_table_age')::int as v5,              -- 手动垃圾回收时, 如果表的事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_freeze_max_age    \n  current_setting('vacuum_multixact_freeze_table_age')::int as v6,    -- 手动垃圾回收时, 如果表的并行事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_multixact_freeze_max_age    \n  current_setting('autovacuum_vacuum_cost_delay') as v7,              -- 自动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源. -1 表示沿用vacuum_cost_delay的设置    \n  current_setting('autovacuum_vacuum_cost_limit') as v8,              -- 自动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定. -1 表示沿用vacuum_cost_limit的设置    \n  current_setting('vacuum_cost_delay') as v9,                         -- 手动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源.    \n  current_setting('vacuum_cost_limit') as v10,                        -- 手动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定.    \n  current_setting('autovacuum') as autovacuum                         -- 是否开启自动垃圾回收    \n) a,     \nLATERAL (   -- LATERAL 允许你在这个SUBQUERY中直接引用前面的table, subquery中的column     \nselect     \npg_size_pretty(pg_total_relation_size(oid)) sz,   -- 表的大小(含TOAST, 索引)    \noid::regclass as reloid,    -- 表名(物化视图)    \nrelkind,                    -- r=表, m=物化视图    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_freeze_table_age=(\\d+)')::int     \n  ),    \n  a.v1    \n)    \n-    \nage(case when relfrozenxid::text::int<3 then null else relfrozenxid end)     \nas remain_ages_xid,   -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_multixact_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_multixact_freeze_table_age=(\\d+)')::int     \n  ),    \n  a.v2    \n)    \n-    \nage(case when relminmxid::text::int<3 then null else relminmxid end)     \nas remain_ages_mxid,  -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为并发事务ID    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_min_age=(\\d+)')::int    \n  ),    \n  a.v3    \n) as xid_lower_to_minage,    -- 如果触发FREEZE, 该表的事务ID年龄会降到多少    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_multixact_freeze_min_age=(\\d+)')::int    \n  ),    \n  a.v4    \n) as mxid_lower_to_minage,   -- 如果触发FREEZE, 该表的并行事务ID年龄会降到多少    \ncase     \n  when v5 <= age(case when relfrozenxid::text::int<3 then null else relfrozenxid end) then 'YES'    \n  else 'NOT'    \nend as vacuum_trigger_freeze1,    -- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(事务ID年龄达到阈值)    \ncase     \n  when v6 <= age(case when relminmxid::text::int<3 then null else relminmxid end) then 'YES'    \n  else 'NOT'    \nend as vacuum_trigger_freeze2,    -- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(并行事务ID年龄达到阈值)    \nreloptions                        -- 表级参数, 优先. 例如是否开启自动垃圾回收, autovacuum_freeze_max_age, autovacuum_freeze_table_age, autovacuum_multixact_freeze_max_age, autovacuum_multixact_freeze_table_age    \nfrom pg_class     \n  where relkind in ('r','m')    \n) e     \norder by     \n  least(e.remain_ages_xid , e.remain_ages_mxid),  -- 排在越前, 越先触发自动FREEZE, 即风暴来临的预测    \n  pg_total_relation_size(reloid) desc   -- 同样剩余年龄, 表越大, 排越前    \n;    \n\ncreate view dba.v_freeze_stat as    \nselect     \nwb,                                                     -- 第几个BATCH, 每个batch代表流逝100万个事务     \ncnt,                                                    -- 这个batch 有多少表    \npg_size_pretty(ssz) as ssz1,                            -- 这个batch 这些 表+TOAST+索引 有多少容量    \npg_size_pretty(ssz) as ssz2,                            -- 这个batch FREEZE 会导致多少读IO    \npg_size_pretty(ssz*3) as ssz3,                          -- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    \npg_size_pretty(min_sz) as ssz4,                         -- 这个batch 最小的表多大    \npg_size_pretty(max_sz) as ssz5,                         -- 这个batch 最大的表多大    \npg_size_pretty(avg_sz) as ssz6,                         -- 这个batch 平均表多大    \npg_size_pretty(stddev_sz) as ssz7,                      -- 这个batch 表大小的方差, 越大, 说明表大小差异化明显    \nmin_rest_age,                                           -- 这个batch 距离自动FREEZE最低剩余事务数    \nmax_rest_age,                                           -- 这个batch 距离自动FREEZE最高剩余事务数    \nstddev_rest_age,                                        -- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    \ncorr_rest_age_sz,                                       -- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 sz7 说明的问题越有价值    \nround(100*(ssz/(sum(ssz) over ())), 2)||' %' as ratio   -- 这个BATCH的容量占比，占比如果非常不均匀，说明有必要调整表级FREEZE参数，让占比均匀化    \nfrom         \n(    \nselect a.*, b.* from     \n(    \nselect     \n  min(least(remain_ages_xid, remain_ages_mxid)) as v_min,   -- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    \n  max(least(remain_ages_xid, remain_ages_mxid)) as v_max    -- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    \nfrom v_freeze    \n) as a,    \nLATERAL (  -- 高级SQL    \nselect     \nwidth_bucket(    \n  least(remain_ages_xid, remain_ages_mxid),     \n  a.v_min,    \n  a.v_max,    \n  greatest((a.v_max-a.v_min)/1000000, 1)   -- 100万个事务, 如果要更改统计例如，修改这个值即可    \n) as wb,      \ncount(*) as cnt,     \nsum(pg_total_relation_size(reloid)) as ssz,     \nstddev_samp(pg_total_relation_size(reloid) order by least(remain_ages_xid, remain_ages_mxid)) as stddev_sz,     \nmin(pg_total_relation_size(reloid)) as min_sz,     \nmax(pg_total_relation_size(reloid)) as max_sz,     \navg(pg_total_relation_size(reloid)) as avg_sz,     \nmin(least(remain_ages_xid, remain_ages_mxid)) as min_rest_age,     \nmax(least(remain_ages_xid, remain_ages_mxid)) as max_rest_age,     \nstddev_samp(least(remain_ages_xid, remain_ages_mxid) order by least(remain_ages_xid, remain_ages_mxid)) as stddev_rest_age,     \ncorr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) as corr_rest_age_sz     \nfrom v_freeze     \ngroup by wb     \n) as b     \n) t     \norder by wb; \n\ncreate view dba.v_freeze_stat_detail as      \nselect     \npg_size_pretty(t.ssz) as ssz2,     -- 这个batch FREEZE 会导致多少读IO (表+TOAST+索引)    \npg_size_pretty(t.ssz*3) as ssz3,   -- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    \npg_size_pretty(t.ssz_sum) as ssz4, -- 所有batch 所有表的总大小  (表+TOAST+索引)    \nround(100*(t.ssz/t.ssz_sum), 2)||' %' as ratio_batch,     -- 这个BATCH的容量占比，目标是让所有BATCH占比尽量一致    \nround(100*(pg_total_relation_size(t.reloid)/t.ssz), 2)||' %' as ratio_table,     -- 这个表占整个batch的容量占比，大表尽量错开freeze    \nt.*      \nfrom         \n(    \nselect a.*, b.* from       \n(    \n  select     \n    min(least(remain_ages_xid, remain_ages_mxid)) as v_min,   -- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    \n    max(least(remain_ages_xid, remain_ages_mxid)) as v_max    -- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    \n  from v_freeze     \n) as a,     \nLATERAL (     -- 高级SQL    \nselect     \n  count(*) over w as cnt,                                                -- 这个batch 有多少表      \n  sum(pg_total_relation_size(reloid)) over () as ssz_sum,                -- 所有batch 所有表的总大小  (表+TOAST+索引)    \n  sum(pg_total_relation_size(reloid)) over w as ssz,                     -- 这个batch 的表大小总和 (表+TOAST+索引)    \n  pg_size_pretty(min(pg_total_relation_size(reloid)) over w) as min_sz,  -- 这个batch 最小的表多大    \n  pg_size_pretty(max(pg_total_relation_size(reloid)) over w) as max_sz,  -- 这个batch 最大的表多大    \n  pg_size_pretty(avg(pg_total_relation_size(reloid)) over w) as avg_sz,  -- 这个batch 平均表多大    \n  pg_size_pretty(stddev_samp(pg_total_relation_size(reloid)) over w) as stddev_sz,  -- 这个batch 表大小的方差, 越大, 说明表大小差异化明显                                                                                                                 \n  min(least(remain_ages_xid, remain_ages_mxid)) over w as min_rest_age,             -- 这个batch 距离自动FREEZE最低剩余事务数                                                                                                                             \n  max(least(remain_ages_xid, remain_ages_mxid)) over w as max_rest_age,             -- 这个batch 距离自动FREEZE最高剩余事务数                                                                                                                             \n  stddev_samp(least(remain_ages_xid, remain_ages_mxid)) over w as stddev_rest_age,  -- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    \n  corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) over w as corr_rest_age_sz,  -- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 stddev_sz 说明的问题越有价值    \n  t1.*     \nfrom     \n  (    \n  select     \n    width_bucket(    \n      least(tt.remain_ages_xid, tt.remain_ages_mxid),     \n      a.v_min,    \n      a.v_max,    \n      greatest((a.v_max-a.v_min)/1000000, 1)         -- 100万个事务, 如果要更改统计例如，修改这个值即可    \n    )     \n    as wb,                                           -- 第几个BATCH, 每个batch代表流逝100万个事务      \n    * from v_freeze tt    \n  ) as t1      \n  window w as     \n  (    \n    partition by t1.wb     \n  )     \n) as b    \n) t    \norder by     \n  t.wb,      \n  least(t.remain_ages_xid, t.remain_ages_mxid),       \n  pg_total_relation_size(t.reloid) desc       \n;      \n  \ncreate view dba.top20freezebigtable as \nselect relowner::regrole, relnamespace::regnamespace, relname, \nage(relfrozenxid),pg_size_pretty(pg_total_relation_size(oid)) , -- 当前年龄 \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_freeze_table_age=(\\d+)')::int     \n  ),    \n  current_setting('autovacuum_freeze_max_age')::int   \n)    \n-    \nage(case when relfrozenxid::text::int<3 then null else relfrozenxid end)     \nas remain_ages_xid,  -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID\ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_min_age=(\\d+)')::int    \n  ),    \n  current_setting('vacuum_freeze_min_age')::int   \n) as xid_lower_to_minage    -- 如果触发FREEZE, 该表的事务ID年龄会降到多少  \nfrom pg_class where relkind='r' order by pg_total_relation_size(oid) desc limit 20; \n```\n\n# 未归档wal文件\n```\ncreate view dba.arch_undone as \nselect * from pg_ls_archive_statusdir() where name !~ 'done$';\n```\n# 归档任务状态\n```\ncreate view dba.arch_status as\nselect * from pg_stat_get_archiver();\n```\n# wal空间占用\n```\ncreate view dba.walsize as \nselect pg_size_pretty(sum(size)) from pg_ls_waldir();\n```\n# 系统强制保留wal大小\n```\ncreate view dba.wal_keep_size as\nwith a as (select setting from pg_settings where name='wal_keep_segments') , b as (select setting,unit from pg_settings where name='wal_segment_size') select pg_size_pretty(a.setting::int8*b.setting::int8) from a,b;\n```\n# 长事务、prepared statement\n```\ncreate view dba.long_snapshot as \nwith a as (select min(transaction::Text::int8) m from pg_prepared_xacts ),\nb as (select txid_snapshot_xmin(txid_current_snapshot())::text::int8 as m),\nc as (select min(least(backend_xid::text::int8,backend_xmin::text::int8)) m from pg_stat_activity ),\nd as (select datname,usename,pid,query_start,xact_start,now(),wait_event,query from pg_stat_activity where backend_xid is not null or backend_xmin is not null\norder by least(backend_xid::text::int8,backend_xmin::text::int8) limit 1),\ne as (select * from pg_prepared_xacts order by transaction::Text::int8 limit 1)\nselect b.m-least(a.m,c.m),d.*,e.* from a,b,c,d left join e on (1=1);\n```\n\n# 重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)\n```\nselect pg_stat_statements_reset();\n```\n# 查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化\n```\ncreate view dba.session_acting_cnt as select count(*) from pg_stat_activity where wait_event is not null and (backend_xid is not null or backend_xmin is not null); \n```\n\n# 当前活跃会话\n```\ncreate view dba.sessions as select * from pg_stat_activity where wait_event is not null and (backend_xid is not null or backend_xmin is not null);  \n```\n# 查看锁等待\n```\ncreate view dba.locks as with      \nt_wait as      \n(      \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and not a.granted     \n),     \nt_run as     \n(     \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and a.granted     \n),     \nt_overlap as     \n(     \n  select r.* from t_wait w join t_run r on     \n  (     \n    r.locktype is not distinct from w.locktype and     \n    r.database is not distinct from w.database and     \n    r.relation is not distinct from w.relation and     \n    r.page is not distinct from w.page and     \n    r.tuple is not distinct from w.tuple and     \n    r.virtualxid is not distinct from w.virtualxid and     \n    r.transactionid is not distinct from w.transactionid and     \n    r.classid is not distinct from w.classid and     \n    r.objid is not distinct from w.objid and     \n    r.objsubid is not distinct from w.objsubid and     \n    r.pid <> w.pid     \n  )      \n),      \nt_unionall as      \n(      \n  select r.* from t_overlap r      \n  union all      \n  select w.* from t_wait w      \n)      \nselect locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::text,classid::regclass,objid,objsubid,     \nstring_agg(     \n'Pid: '||case when pid is null then 'NULL' else pid::text end||chr(10)||     \n'Lock_Granted: '||case when granted is null then 'NULL' else granted::text end||' , Mode: '||case when mode is null then 'NULL' else mode::text end||' , FastPath: '||case when fastpath is null then 'NULL' else fastpath::text end||' , VirtualTransaction: '||case when virtualtransaction is null then 'NULL' else virtualtransaction::text end||' , Session_State: '||case when state is null then 'NULL' else state::text end||chr(10)||     \n'Username: '||case when usename is null then 'NULL' else usename::text end||' , Database: '||case when datname is null then 'NULL' else datname::text end||' , Client_Addr: '||case when client_addr is null then 'NULL' else client_addr::text end||' , Client_Port: '||case when client_port is null then 'NULL' else client_port::text end||' , Application_Name: '||case when application_name is null then 'NULL' else application_name::text end||chr(10)||      \n'Xact_Start: '||case when xact_start is null then 'NULL' else xact_start::text end||' , Query_Start: '||case when query_start is null then 'NULL' else query_start::text end||' , Xact_Elapse: '||case when (now()-xact_start) is null then 'NULL' else (now()-xact_start)::text end||' , Query_Elapse: '||case when (now()-query_start) is null then 'NULL' else (now()-query_start)::text end||chr(10)||      \n'SQL (Current SQL in Transaction): '||chr(10)||    \ncase when query is null then 'NULL' else query::text end,      \nchr(10)||'--------'||chr(10)      \norder by      \n  (  case mode      \n    when 'INVALID' then 0     \n    when 'AccessShareLock' then 1     \n    when 'RowShareLock' then 2     \n    when 'RowExclusiveLock' then 3     \n    when 'ShareUpdateExclusiveLock' then 4     \n    when 'ShareLock' then 5     \n    when 'ShareRowExclusiveLock' then 6     \n    when 'ExclusiveLock' then 7     \n    when 'AccessExclusiveLock' then 8     \n    else 0     \n  end  ) desc,     \n  (case when granted then 0 else 1 end)    \n) as lock_conflict    \nfrom t_unionall     \ngroup by     \nlocktype,datname,relation,page,tuple,virtualxid,transactionid::text,classid,objid,objsubid ;\n```\n\n# 查看索引支持类型\n```\nSELECT\n    am.amname AS index_method,\n    opc.opcname AS opclass_name,\n    opc.opcintype::regtype AS indexed_type,\n    opc.opcdefault AS is_default\nFROM\n    pg_am am,\n    pg_opclass opc\nWHERE\n    opc.opcmethod = am.oid\nORDER BY\n    index_method,\n    opclass_name;\nSELECT\n    amname,\n    opcname,\n    opcintype::regtype,\n    opckeytype::regtype,\n    opcdefault\nFROM\n    pg_am am,\n    pg_opclass opc\nWHERE\n    am.oid = opc.opcmethod\n    AND amname = 'gin';\n\nSELECT\n    oid,\n    oprnegate,\n    oprname,\n    oprcode,\n    oprresult::regtype,\n    oprleft::regtype,\n    oprright::regtype,\n    oprcanmerge\nFROM\n    pg_operator;\n\n```\n# 判断ip是否在某一网段内\n```\nCREATE OR REPLACE FUNCTION public.is_same_network (ip1 ip4, ip2 ip4, mask integer)\n    RETURNS boolean\nAS\n$$\nDECLARE\n    is_same_network boolean;\nBEGIN\n    IF mask > 32 OR mask < 0 THEN\n        raise\n        exception 'The mask must be between 0 and 32';\n    END IF;\n \n    EXECUTE format('select (~($1 # $2))::bigint::bit(32)::bit(%I)::text ~ ''^1+$''', mask) using ip1, ip2 into is_same_network;\n    RETURN is_same_network;\nexception\n    WHEN OTHERS THEN\n        raise NOTICE '%', SQLERRM;\n    RETURN FALSE;\nEND;\n$$ language plpgsql;\n```\n# 指定字符替换\n```\npostgres=# SELECT regexp_replace('foobarbaz', 'b(..)', 'X\\1Y', 'g');\n regexp_replace \n----------------\n fooXarYXazY\n(1 row)\n\n```\n#  SQL实现圣诞树\n```\nmydb=# WITH leaf AS\n (SELECT lpad(rpad('*', (id - 1) * 2 + 1, '*'), id + 20) leaf,\n         id\n    FROM generate_series(1, 3) AS t(id)),\nlv AS\n (SELECT id lv FROM generate_series(1, 5) AS t(id)),\nleafs AS\n (SELECT lpad(rpad('*', ((row_number() over()) ::INT - 1) * 2 + 1 + (lv - 1) * 2, '*'), (row_number()\n                over())\n               ::INT + 20 + lv) leaf\n    FROM leaf,\n         lv),\nroot AS\n (SELECT lpad(rpad('*', 5, '*'), 24) FROM generate_series(1, 4) AS t(id))\nSELECT leaf\n  FROM leafs\nUNION ALL\nSELECT * FROM root;\n                   leaf                  \n------------------------------------------\n                      *\n                    *****\n                  *********\n                *************\n              *****************\n                 ***********\n               ***************\n             *******************\n           ***********************\n         ***************************\n            *********************\n          *************************\n        *****************************\n      *********************************\n    *************************************\n                    *****\n                    *****\n                    *****\n                    *****\n(19 rows)\n \nmydb=#\n\n```\n#  生成随机中文\n\n```sql\ncreate or replace function gen_hanzi(int) returns text as $$  \ndeclare  \n  res text;  \nbegin  \n  if $1 >=1 then  \n    select string_agg(chr(19968+(random()*20901)::int), '') into res from generate_series(1,$1);  \n    return res;  \n  end if;  \n  return null;  \nend;  \n$$ language plpgsql strict;\n```\n#  生成随机时间\n```\ncreate or replace function get_rand_ts() returns timestamp as $$  \n  select now()::timestamp  +  ((1000*random())::int::text||' days')::interval;            \n$$ language sql strict;  \n```\n# 找出index 维护SQL\n```sql\nselect\n        CASE\n                WHEN flag = 1 THEN\n                        CASE\n                        WHEN indexdef !~ ' WHERE ' THEN\n                                regexp_replace(indexdef, E'(INDEX )(.+)( ON )(.+\\\\)\\$)'  ,E' \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default ','g') ||'; '\n                        ELSE\n                                regexp_replace(indexdef, E'(INDEX )(.+)( ON )(.+)( WHERE )'  ,E' \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default \\\\5 ','g') ||'; '\n                        END\n                WHEN flag = 2 THEN\n                                'ANALYZE VERBOSE '||schemaname||'.'||tablename||' ; select pg_sleep(600) ; DROP INDEX CONCURRENTLY IF EXISTS '||schemaname||'.'||indexname||'; '\n        END\nfrom\n        (\n        select\n                generate_series(1,2) as flag,\n                indexdef,\n                indexname,\n                tablename,\n                pi.schemaname\n        from\n                pg_indexes pi\n        join\n                pg_namespace n\n          on\n                pi.schemaname = n.nspname\n        join\n                pg_class pcl\n          on\n                pcl.relnamespace = n.oid\n                and pcl.relname = pi.tablename\n        left join\n                pg_constraint pco\n          on\n                pco.conname = pi.indexname\n                and pco.conrelid = pcl.oid\n        where\n                (pi.schemaname, pi.tablename) = ('mirror','b2c_order')\n                and pco.contype is distinct from  'p'\n                and pco.contype is distinct from  'u'\n        order by\n                pi.schemaname, tablename, indexname, pg_table_size(schemaname||'.'||indexname::text) desc, flag asc\n        ) as foo\norder by\n       schemaname, tablename, indexname, pg_table_size(schemaname||'.'||indexname::text) desc, flag asc\n;\n```\n\n# 参考\n[德哥](https://github.com/digoal/blog/blob/master/202005/20200509_02.md)\n","source":"_posts/PostgreSQL有用的SQL.md","raw":"---\ntitle: PostgreSQL有用的SQL\ndate: 2020-07-31 18:19:15\ntags: [PostgreSQL, DBA, SQL]\ncategories: 数据库\ntop: 10\n\n---\n\n记录工作中常用到的PostgreSQL常用SQL， tps, qps 等等.\n\n<!-- more -->\n\n# 抓去网站天气信息\n```\npostgres=#   CREATE OR REPLACE FUNCTION get_weather_info(city text)\n RETURNS jsonb\n LANGUAGE plpython3u\nAS $function$\n\nimport re\nimport json\nimport requests, bs4\n\nres = requests.get('http://pm25.in/{}'.format(city))\nsoup = bs4.BeautifulSoup(res.text, 'html.parser')\n\n#script = soup.findAll('script', text=re.compile(\"highcharts\"))\n#categorie = re.findall(\"categories: (.*),\",script[0].string)[0]\n#data = re.findall(\"data: (.*),\",script[0].string)[0]\n#info = dict(zip(json.loads(categorie), json.loads(data)))\n\ntable = soup.find('table', attrs={\"id\": \"detail-data\"})\ninfo = {\n    \"thead\": [ th.get_text() for th in table.find('thead').find('tr').select('th') ],\n    \"tbody\": []\n}\ntheads = [ th.get_text() for th in table.find('thead').find('tr').select('th') ]\nfor tr in table.find('tbody').findAll('tr'):\n    tbodys = [ td.get_text() for td in tr.select('td') ]\n    info['tbody'].append(tbodys)\n\nreturn json.dumps(info, ensure_ascii=False)\n\n$function$;\nCREATE FUNCTION\npostgres=# select get_weather_info('putian');\n\n                                                                          f1\n\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n------------------------------------------------------------------------------------------------------------------------------------------------------\n {\"tbody\": [[\"荔城区仓后路\", \"39\", \"优\", \"_\", \"20\", \"39\", \"0.5\", \"15\", \"122\", \"90\", \"5\"], [\"莆田市监测站\", \"_\", \"\", \"_\", \"20\", \"39\", \"_\", \"14\", \"126\", \"98\", \"4\"], [\"涵江区六中\", \"_\", \"\", \"_\", \"_\", \"_\", \"0.6\", \"19\", \"138\", \"88\", \"7\"], [\"秀屿区政府\", \"51\",\n \"良\", \"颗粒物(PM10)\", \"18\", \"52\", \"0.6\", \"10\", \"128\", \"83\", \"5\"], [\"东圳水库\", \"19\", \"优\", \"_\", \"10\", \"10\", \"0.5\", \"10\", \"58\", \"58\", \"4\"], [\"东圳水库(对照点)\", \"36\", \"优\", \"_\", \"19\", \"34\", \"0.5\", \"13\", \"114\", \"81\", \"3\"]], \"thead\": [\"监测点\", \"AQI\", \"空\n质量指数类别\", \"首要污染物\", \"PM2.5细颗粒物\", \"PM10可吸入颗粒物\", \"CO一氧化碳\", \"NO2二氧化氮\", \"O3臭氧1小时平均\", \"O3臭氧8小时平均\", \"SO2二氧化硫\"]}\n(1 row)\n\n```\n\n# plpgsql函数获取Server磁盘空间信息\n```\nCREATE OR REPLACE FUNCTION public.get_disk_size()\n RETURNS jsonb\n LANGUAGE plpgsql\nAS $function$\ndeclare\n    sqlstring text;\n    tablename text;\n    result jsonb;\nbegin\n    -- uuid_generate_v4() in pg12-， gen_random_uuid() in pg13+\n    tablename = quote_ident( 'get_disk_size_' ||  uuid_generate_v4()::text);\n    sqlstring = format('create temp table if not exists %s(Filesystem text, type text, Size int, Used int, Avail int, \"useper\" numeric, \"mounted on\" text) ON COMMIT DROP', tablename);\n    execute sqlstring;\n    --LC_ALL=C ignore OS language environment\n    sqlstring = format('copy %s from program ''LC_ALL=C /bin/df -Tm | /bin/grep -v \"Mounted\" | /bin/sed \"s/\\s\\+/|/g\" | /bin/sed \"s/%%//g\"'' with delimiter ''|''', tablename);\n    execute sqlstring;\n    sqlstring = format('select json_agg(row_to_json(%s.*)) from %s', tablename, tablename);\n    execute sqlstring into result;\n    return result;\nend;\n$function$;\n\n```\n\n# python函数获取Server磁盘空间信息\n```\ncreate or replace function get_disk_size()\nreturns jsonb as\n$$\nimport psutil as ps\nimport json\n\nreturn json.dumps([{\n    \"mounted on\": part.mountpoint,\n    \"filesystem\": part.device,\n    \"size\": round(ps.disk_usage(part.mountpoint).total / 1024 / 1024, 2),\n    \"avail\": round(ps.disk_usage(part.mountpoint).free / 1024 / 1024, 2),\n    \"used\": round(ps.disk_usage(part.mountpoint).used / 1024 / 1024, 2),\n    \"use%\": ps.disk_usage(part.mountpoint).percent,\n    \"type\": part.fstype,\n    \"opts\": part.opts}\n    for part in ps.disk_partitions()])\n$$LANGUAGE plpython3u;\n```\n\n# 主库查询主从延迟\n```\n SELECT pg_stat_replication.application_name,\n    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), pg_stat_replication.replay_lsn)) AS diff\n   FROM pg_stat_replication;\n```\n\n# 从库查询主从延迟\n```\nSELECT\n    CASE\n        WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0::double precision\n        ELSE date_part('epoch'::text, now() - pg_last_xact_replay_timestamp())\n    END AS log_delay;\n```\n\n# 按query分组查询活跃SQL数量\n```\n SELECT pg_stat_activity.query,\n    count(1) AS count\n   FROM pg_stat_activity\n  WHERE pg_stat_activity.state <> 'idle'::text AND pg_stat_activity.pid <> pg_backend_pid() AND pg_stat_activity.query <> ''::text AND pg_stat_activity.query !~ '^DISCARD|^SET extra_float_digits = 3'::text\n  GROUP BY pg_stat_activity.query\n HAVING count(1) > 1\n  ORDER BY (count(1)) DESC\n LIMIT 10;\n```\n\n# 查询锁\n```\nselect\n      wait.pid,\n      wait.state,\n      wait.datname,\n      (select string_agg(distinct transactionid::text, ',') from pg_locks where pid = wait.pid and locktype = 'transactionid' and transactionid::text <> wait.transactionid::text),\n      wait.virtualxid,\n      wait.locktype,\n      wait.usename,\n      wait.application_name,\n      wait.client_addr,\n      wait.wait_event_type,\n      wait.wait_event,\n      wait.query_start,\n      wait.query,\n\n      wait.relation,\n      wait.datname || '.' || d.nspname || '.' || c.relname as relname,\n      granted.relation,\n\n      granted.pid              as waitfor_pid,\n      granted.state            as waitfor_state,\n      granted.transactionid    as waitfor_transactionid,\n      granted.virtualxid       as waitfor_virtualxid,\n      granted.locktype         as waitfor_locktype,\n      granted.usename          as waitfor_usename,\n      granted.client_addr      as waitfor_client_addr,\n      granted.application_name as waitfor_application_name,\n      granted.wait_event_type  as waitfor_wait_event_type,\n      granted.wait_event       as waitfor_wait_event,\n      granted.query_start      as waitfor_query_start,\n      granted.query            as waitfor_query,\n      now() - granted.query_start  as waitfor_time\n\nfrom\n    (select\n          a.pid,\n          a.state,\n          b.transactionid,\n          b.virtualxid,\n          b.locktype,\n          b.relation,\n          b.page,\n          b.tuple,\n          a.usename,\n          a.datname,\n          a.application_name,\n          a.client_addr,\n          a.wait_event_type,\n          a.wait_event,\n          a.query_start,\n          a.query\n     from\n          pg_stat_activity a,\n          pg_locks b\n     where\n          a.wait_event_type is not null\n          and a.pid = b.pid\n          and granted = 'f'\n    ) wait\njoin\n    (select\n          b.pid,\n          b.state,\n          a.transactionid,\n          a.virtualxid,\n          a.locktype,\n          a.relation,\n          a.page,\n          a.tuple,\n          b.usename,\n          b.datname,\n          b.application_name,\n          b.client_addr,\n          b.wait_event_type,\n          b.wait_event,\n          b.query_start,\n          b.query\n    from\n        pg_locks a,\n        pg_stat_activity b\n    where\n        a.pid = b.pid\n        and a.granted = 't'\n    ) granted\non (\n    ( wait.locktype = 'transactionid'\n    and granted.locktype = 'transactionid'\n    and wait.transactionid = granted.transactionid )\n    or\n    ( wait.locktype = 'relation'\n    and granted.locktype = 'relation'\n    and wait.relation = granted.relation\n    )\n    or\n    ( wait.locktype = 'virtualxid'\n    and granted.locktype = 'virtualxid'\n    and wait.virtualxid = granted.virtualxid )\n    or\n    ( wait.locktype = 'tuple'\n    and granted.locktype = 'tuple'\n    and wait.relation = granted.relation\n    and wait.page = granted.page\n    and wait.tuple = granted.tuple )\n)\nleft join\n    pg_class c\non ( c.relfilenode = wait.relation )\nleft join\n    pg_namespace d\non ( c.relnamespace = d.oid )\norder by\n    granted.query_start\n;\n```\n\n# 查询表大小, 按占用大小排序\n```\nSELECT\n    t.spcname,\n    (n.nspname::text || '.'::text) || c.relname::text AS relation,\n    pg_size_pretty(pg_total_relation_size(c.oid::regclass)) AS total_table_size,\n    pg_size_pretty(pg_relation_size(c.oid::regclass)) AS table_only_size,\n    pg_size_pretty(pg_indexes_size(c.oid::regclass)) AS total_index_size\nFROM\n    pg_class c\n    LEFT JOIN pg_tablespace t ON c.reltablespace = t.oid\n    LEFT JOIN pg_namespace n ON n.oid = c.relnamespace\nWHERE (n.nspname <> ALL (ARRAY['pg_catalog'::name, 'information_schema'::name, 'pg_toast'::name]))\n    AND c.relkind = 'r'::\"char\"\nORDER BY\n    (pg_total_relation_size(c.oid::regclass)) DESC;\n```\n\n\n\n# 找出重复的index\n```\nSELECT\n    relname,\n    (array_agg(idx))[1] idx1,\n    pg_get_indexdef((array_agg(idx))[1]) idx1_def,\n    (array_agg(idx))[2] idx2,\n    pg_get_indexdef((array_agg(idx))[2]) idx2_def,\n    (array_agg(idx))[3] idx3,\n    pg_get_indexdef((array_agg(idx))[3]) idx3_def\nFROM (\n    SELECT\n        indrelid::regclass AS relname,\n        indexrelid::regclass AS idx,\n        (indrelid::text || indclass::text || indkey::text || COALESCE(indexprs::text, '') || COALESCE(indpred::text, '')) AS KEY\n    FROM\n        pg_index) sub\nGROUP BY\n    relname,\n    KEY\nHAVING\n    count(*) > 1;\n```\n\n# 自定义操作符兼容Oracle varchar = int\n```\nmydb=# create table test(info varchar);\nCREATE TABLE\nmydb=# insert into test select '1';\nINSERT 0 1\nmydb=# insert into test select '2';\nINSERT 0 1\nmydb=# insert into test select '3';\nINSERT 0 1\nmydb=# select * from test;\n info\n------\n 1\n 2\n 3\n(3 rows)\n\nmydb=# select * from test where info = 1;\nERROR:  operator does not exist: character varying = integer\nLINE 1: select * from test where info = 1;\n                                      ^\nHINT:  No operator matches the given name and argument types. You might need to add explicit type casts.\nmydb=# CREATE OR REPLACE FUNCTION equal(character varying, integer) RETURNS boolean AS $function$ select cast($1 as text) = cast($2 as text) $function$ LANGUAGE sql;\nCREATE FUNCTION\nmydb=# create operator = (leftarg = varchar, rightarg = int, procedure = equal, commutator = =);\nCREATE OPERATOR\nmydb=# select * from test where info = 1;\n info\n------\n 1\n(1 row)\n\nmydb=#\n\n```\n\n# 兼容instr \n```\nmydb=# select instr('helloworld', 'l', 2, 2);\n instr\n-------\n     4\n(1 row)\n\nmydb=# select instr('helloworld', 'l', 3, 2);\n instr\n-------\n     4\n(1 row)\n\nmydb=# select instr('helloworld', 'l', -1, 1);\n instr\n-------\n     9\n(1 row)\n\nmydb=# select instr('helloworld', 'l', -2, 1);\n instr\n-------\n     9\n(1 row)\n\nmydb=# \\sf instr\nCREATE OR REPLACE FUNCTION public.instr(str text, sub text, startpos integer DEFAULT 1, occurrence integer DEFAULT 1)\n RETURNS integer\n LANGUAGE plpgsql\nAS $function$\ndeclare\n    tail text;\n    shift int;\n    pos int;\n    i int;\nbegin\n    shift:= 0;\n    if startpos = 0 or occurrence <= 0 then\n        return 0;\n    end if;\n    if startpos < 0 then\n        str:= reverse(str);\n        sub:= reverse(sub);\n        pos:= -startpos;\n    else\n        pos:= startpos;\n    end if;\n    for i in 1..occurrence loop\n        shift:= shift+ pos;\n        tail:= substr(str, shift);\n        pos:= strpos(tail, sub);\n        if pos = 0 then\n            return 0;\n        end if;\n    end loop;\n    if startpos > 0 then\n        return pos+ shift- 1;\n    else\n        return length(str)- length(sub)- pos- shift+ 3;\n    end if;\nend $function$\nmydb=#\n\n```\n\n# procedure 异常处理\n```\nmydb=# CREATE OR REPLACE PROCEDURE f1()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  my_ex_state text;\n  my_ex_message text;\n  my_ex_detail text;\n  my_ex_hint text;\n  my_ex_ctx text;\nbegin\n  begin\n    raise notice 'A';\n  exception when others then\n    raise notice 'C';\n    GET STACKED DIAGNOSTICS\n      my_ex_state   = RETURNED_SQLSTATE,\n      my_ex_message = MESSAGE_TEXT,\n      my_ex_detail  = PG_EXCEPTION_DETAIL,\n      my_ex_hint    = PG_EXCEPTION_HINT,\n      my_ex_ctx     = PG_EXCEPTION_CONTEXT\n    ;\n    raise notice '% % % % %', my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;\n  end;\n\n  commit;\n\n  begin\n    raise notice 'B';\n  exception when others then\n    raise notice 'C';\n    GET STACKED DIAGNOSTICS\n      my_ex_state   = RETURNED_SQLSTATE,\n      my_ex_message = MESSAGE_TEXT,\n      my_ex_detail  = PG_EXCEPTION_DETAIL,\n      my_ex_hint    = PG_EXCEPTION_HINT,\n      my_ex_ctx     = PG_EXCEPTION_CONTEXT\n    ;\n    raise notice '% % % % %', my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;\n  end;\nend;\n$procedure$\n;\n\n```\n\n# 找下一个周末\n```\npostgres=# select next_day('2020-12-22'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\npostgres=# select next_day('2020-12-21'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\npostgres=# select next_day('2020-12-20'::date, 7);\n  next_day\n------------\n 2020-12-26\n(1 row)\n\n```\n\n# PostgreSQL只迁移FUNCTION\n```\npg_dump -h localhost -U jintao -Fc -s -f db_dump mydb\nmore db_dump\npg_restore -l db_dump | grep FUNCTION > function_list\ncat function_list\npg_restore -h localhost -U postgres -d postgres -L function_list db_dump\n```\n\n# pageinspect 查看xmax的状态\n\n```\nSELECT lp,\n       t_ctid AS ctid,\n       t_xmin AS xmin,\n       t_xmax AS xmax,\n       (t_infomask & 128)::boolean AS xmax_is_lock,\n       (t_infomask & 1024)::boolean AS xmax_committed,\n       (t_infomask & 2048)::boolean AS xmax_rolled_back,\n       (t_infomask & 4096)::boolean AS xmax_multixact,\n       t_attrs[1] AS p_id,\n       t_attrs[2] AS p_val\nFROM heap_page_item_attrs(\n        get_raw_page('parent', 0),\n        'parent'\n     );\n```\n\n# PostgreSQL9.1主从延迟查询\n```\npostgres=# \\sf pg_xlog_location_diff\nCREATE OR REPLACE FUNCTION pg_catalog.pg_xlog_location_diff(text, text)\n RETURNS numeric\n LANGUAGE plpgsql\nAS $function$\n    DECLARE\n       offset1 text;\n       offset2 text;\n       xlog1 text;\n       xlog2 text;\n       SQL text;\n       diff text;\n    BEGIN\n       /* Extract the Offset and xlog from input in\n          offset and xlog variables */\n\n       offset1=split_part($1,'/',2);\n         xlog1=split_part($1,'/',1);\n       offset2=split_part($2,'/',2);\n         xlog2=split_part($2,'/',1);\n\n       /* Prepare SQL query for calculation based on following formula\n         (FF000000 * xlog + offset) - (FF000000 * xlog + offset)\n         which gives value in hexadecimal. Since, hexadecimal calculation is cumbersome\n         so convert into decimal and then calculate the difference */\n\n       SQL='SELECT (x'''||'FF000000'||'''::bigint * x'''||xlog1||'''::bigint\n                                +  x'''||offset1||'''::bigint)'||'\n                -\n                   (x'''||'FF000000'||'''::bigint * x'''||xlog2||'''::bigint\n                                +  x'''||offset2||'''::bigint)';\n       EXECUTE SQL into diff;\n\n       /* Return the value in numeric by explicit casting  */\n\n       RETURN diff::numeric;\n    END;\n $function$\npostgres=# SELECT\n    application_name,\n    pg_xlog_location_diff(pg_current_xlog_location(), replay_location) as diff\nFROM\n    pg_stat_replication\n;\n application_name | diff\n------------------+-------\n walreceiver      | 18272\n(1 row)\n\n```\n\n# 获取cluster初始化的时间\n```\n$ pg_controldata |grep -i system\nDatabase system identifier:           6888133981158752630\n$ psql\npsql (14devel)\nType \"help\" for help.\n\nmydb=# SELECT to_timestamp(((6888133981158752630>>32) & (2^32 -1)::bigint));\n      to_timestamp\n------------------------\n 2020-10-27 11:17:48+08\n(1 row)\n\nmydb=#\n\n```\n\n# tuple-internal详解\n```\nhttps://pgconf.ru/media/2016/05/13/tuple-internals.pdf\n```\n\n# PostgreSQL clog最大大小\n```\n#define CLOG_BITS_PER_XACT      2   //2bit一个事物\n#define CLOG_XACTS_PER_BYTE 4       //1Byte4个事物\n#define CLOG_XACTS_PER_PAGE (BLCKSZ * CLOG_XACTS_PER_BYTE)\n\n500M，内存中处理完全够效率, 想想要是64位xid, 光clog大小就不一定多大了.\n\nclog总大小约500MB, 每个clog文件256kb, 最多2097152个clog文件.\n\nmydb=# select 2^31/4/256;\n ?column?\n----------\n  2097152\n(1 row)\n\nmydb=# select pg_size_pretty((2^31/4)::bigint);\n pg_size_pretty\n----------------\n 512 MB\n(1 row)\n\nmydb=#\n\n```\n\n# bytea转为原始字符\n```\npostgres=# create table t_bytea(info bytea);\nCREATE TABLE\npostgres=# insert into t_bytea select 'hello';\nINSERT 0 1\npostgres=# insert into t_bytea select '我的家乡';\nINSERT 0 1\npostgres=# select * from t_bytea ;\n            info\n----------------------------\n \\x68656c6c6f\n \\xe68891e79a84e5aeb6e4b9a1\n(2 rows)\n\npostgres=# select encode(info, 'escape') from t_bytea ;\n                      encode\n--------------------------------------------------\n hello\n \\346\\210\\221\\347\\232\\204\\345\\256\\266\\344\\271\\241\n(2 rows)\n\npostgres=# select convert_from(info, 'UTF8') from t_bytea ;\n convert_from\n--------------\n hello\n 我的家乡\n(2 rows)\n\n```\n\n```\ncreate schema dba;\n```\n#  tps\n```\ncreate or replace procedure dba.tps() as $$\ndeclare\n  v1 int8;\n  v2 int8;\nbegin\n  select txid_snapshot_xmax(txid_current_snapshot()) into v1;\n  commit;\n  perform pg_sleep(1);\n  select txid_snapshot_xmax(txid_current_snapshot()) into v2;\n  commit;\n  raise notice 'tps: %', v2-v1;\nend;\n$$ language plpgsql ;\n```\n# qps\n\n用select sum(calls) s from pg_stat_statements(false) 而不用select sum(calls) s from pg_stat_statements\n不需要具体的query, 查询效率好很多.\n```\nwith\na as (select sum(calls) s from pg_stat_statements(false)),   \nb as (select sum(calls) s from pg_stat_statements(false) , pg_sleep(1))   \nselect   \nb.s-a.s          -- QPS  \nfrom a,b;\n```\n\n#  查询没有使用过的大于1MB的索引 top 10\n```\nCREATE VIEW dba.top10notusedidx AS\nSELECT\n    pg_size_pretty(pg_relation_size(indexrelid)),\n    *\nFROM\n    pg_stat_all_indexes\nWHERE\n    pg_relation_size(indexrelid) >= 1024000\n    AND (idx_scan = 0\n        OR idx_tup_read = 0\n        OR idx_tup_fetch = 0)\n    AND schemaname NOT IN ('pg_toast', 'pg_catalog')\nORDER BY\n    pg_relation_size(indexrelid) DESC\nLIMIT 10;\n```\n注意, PK、UK如果只是用于约束, 可能不会被统计计数,但是不能删掉) \n\n# 查询没有使用过的大于1MB的表 top 10\n```\nCREATE VIEW dba.top10notusedtab AS\nSELECT\n    pg_size_pretty(pg_relation_size(relid)),\n    *\nFROM\n    pg_stat_all_tables\nWHERE\n    pg_relation_size(relid) >= 1024000\n    AND seq_scan = 0\n    AND idx_scan = 0\n    AND schemaname NOT IN ('pg_toast', 'pg_catalog', 'information_schema')\nORDER BY\n    pg_relation_size(relid) DESC\nLIMIT 10;\n```\n# 查询热表top 10\n```\nCREATE VIEW dba.top10hottab AS\nSELECT\n    pg_size_pretty(pg_relation_size(relid)),\n    *\nFROM\n    pg_stat_all_tables\nWHERE\n    schemaname NOT IN ('pg_toast', 'pg_catalog', 'information_schema')\nORDER BY\n    seq_scan + idx_scan DESC,\n    pg_relation_size(relid) DESC\nLIMIT 10;\n```\n# 在standby节点执行， 接收wal的速度。\n```\nCREATE OR REPLACE PROCEDURE dba.wal_receive_bw()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  v1 pg_lsn;\n  v2 pg_lsn;\nbegin\n  select pg_last_wal_receive_lsn() into v1;\n  commit;\n  perform pg_sleep(1);\n  select pg_last_wal_receive_lsn() into v2;\n  commit;\n  raise notice 'wal receive bw: %/s', pg_size_pretty(pg_wal_lsn_diff(v2,v1));\nend;\n$procedure$;\n```\n# 在standby节点执行， replay wal的速度。\n```\nCREATE OR REPLACE PROCEDURE dba.wal_replay_bw()\n LANGUAGE plpgsql\nAS $procedure$\ndeclare\n  v1 pg_lsn;\n  v2 pg_lsn;\nbegin\n  select pg_last_wal_replay_lsn() into v1;\n  commit;\n  perform pg_sleep(1);\n  select pg_last_wal_replay_lsn() into v2;\n  commit;\n  raise notice 'wal replay bw: %/s', pg_size_pretty(pg_wal_lsn_diff(v2,v1));\nend;\n$procedure$; \n```\n\n# 查询膨胀空间top 10的表\n```\ncreate view dba.top10bloatsizetable as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml order by wastedbytes desc limit 5;  \n```\n\n# 查询膨胀空间top 10的索引\n```\ncreate view dba.top10bloatsizeindex as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml order by wastedibytes desc limit 5;  \n```\n# 查询膨胀比例top 10的表(浪费空间大于10MB的表)\n```\ncreate view dba.top10bloatratiotable as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml   \nwhere (CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END) >= 10240000  \norder by tbloat desc,wastedbytes desc limit 5;  \n```\n# 查询膨胀比例top 10的索引(浪费空间大于10MB的索引)\n```\ncreate view dba.top10bloatratioindex as  \nSELECT  \n  current_database() AS db, schemaname, tablename, reltuples::bigint AS tups, relpages::bigint AS pages, otta,  \n  ROUND(CASE WHEN otta=0 OR sml.relpages=0 OR sml.relpages=otta THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS tbloat,  \n  CASE WHEN relpages < otta THEN 0 ELSE relpages::bigint - otta END AS wastedpages,  \n  CASE WHEN relpages < otta THEN 0 ELSE bs*(sml.relpages-otta)::bigint END AS wastedbytes,  \n  CASE WHEN relpages < otta THEN '0 bytes'::text ELSE pg_size_pretty((bs*(relpages-otta))::bigint) END AS wastedsize,  \n  iname, ituples::bigint AS itups, ipages::bigint AS ipages, iotta,  \n  ROUND(CASE WHEN iotta=0 OR ipages=0 OR ipages=iotta THEN 0.0 ELSE ipages/iotta::numeric END,1) AS ibloat,  \n  CASE WHEN ipages < iotta THEN 0 ELSE ipages::bigint - iotta END AS wastedipages,  \n  CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END AS wastedibytes,  \n  CASE WHEN ipages < iotta THEN '0 bytes' ELSE pg_size_pretty((bs*(ipages-iotta))::bigint) END AS wastedisize,  \n  pg_size_pretty(CASE WHEN relpages < otta THEN  \n    CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta::bigint) END  \n    ELSE CASE WHEN ipages < iotta THEN bs*(relpages-otta::bigint)  \n      ELSE bs*(relpages-otta::bigint + ipages-iotta::bigint) END  \n  END) AS totalwastedbytes  \nFROM (  \n  SELECT  \n    nn.nspname AS schemaname,  \n    cc.relname AS tablename,  \n    COALESCE(cc.reltuples,0) AS reltuples,  \n    COALESCE(cc.relpages,0) AS relpages,  \n    COALESCE(bs,0) AS bs,  \n    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  \n      (CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)),0) AS otta,  \n    COALESCE(c2.relname,'?') AS iname, COALESCE(c2.reltuples,0) AS ituples, COALESCE(c2.relpages,0) AS ipages,  \n    COALESCE(CEIL((c2.reltuples*(datahdr-12))/(bs-20::float)),0) AS iotta -- very rough approximation, assumes all cols  \n  FROM  \n     pg_class cc  \n  JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname <> 'information_schema'  \n  LEFT JOIN  \n  (  \n    SELECT  \n      ma,bs,foo.nspname,foo.relname,  \n      (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr,  \n      (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2  \n    FROM (  \n      SELECT  \n        ns.nspname, tbl.relname, hdr, ma, bs,  \n        SUM((1-coalesce(null_frac,0))*coalesce(avg_width, 2048)) AS datawidth,  \n        MAX(coalesce(null_frac,0)) AS maxfracsum,  \n        hdr+(  \n          SELECT 1+count(*)/8  \n          FROM pg_stats s2  \n          WHERE null_frac<>0 AND s2.schemaname = ns.nspname AND s2.tablename = tbl.relname  \n        ) AS nullhdr  \n      FROM pg_attribute att  \n      JOIN pg_class tbl ON att.attrelid = tbl.oid  \n      JOIN pg_namespace ns ON ns.oid = tbl.relnamespace  \n      LEFT JOIN pg_stats s ON s.schemaname=ns.nspname  \n      AND s.tablename = tbl.relname  \n      AND s.inherited=false  \n      AND s.attname=att.attname,  \n      (  \n        SELECT  \n          (SELECT current_setting('block_size')::numeric) AS bs,  \n            CASE WHEN SUBSTRING(SPLIT_PART(v, ' ', 2) FROM '#\"[0-9]+.[0-9]+#\"%' for '#')  \n              IN ('8.0','8.1','8.2') THEN 27 ELSE 23 END AS hdr,  \n          CASE WHEN v ~ 'mingw32' OR v ~ '64-bit' THEN 8 ELSE 4 END AS ma  \n        FROM (SELECT version() AS v) AS foo  \n      ) AS constants  \n      WHERE att.attnum > 0 AND tbl.relkind='r'  \n      GROUP BY 1,2,3,4,5  \n    ) AS foo  \n  ) AS rs  \n  ON cc.relname = rs.relname AND nn.nspname = rs.nspname  \n  LEFT JOIN pg_index i ON indrelid = cc.oid  \n  LEFT JOIN pg_class c2 ON c2.oid = i.indexrelid  \n) AS sml   \nwhere (CASE WHEN ipages < iotta THEN 0 ELSE bs*(ipages-iotta) END) >= 10240000  \norder by ibloat desc,wastedibytes desc limit 5; \n```\n# 查询序列距离最大值的范围\n```\ncreate view dba.seqs as select max_value-last_value,* from pg_sequences order by max_value-last_value ;\n```\n# freeze风暴预测相关的3个视图\n```\ncreate view dba.v_freeze as    \nselect     \n  e.*,     \n  a.*     \nfrom    \n(select     \n  current_setting('autovacuum_freeze_max_age')::int as v1,            -- 如果表的事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    \n  current_setting('autovacuum_multixact_freeze_max_age')::int as v2,  -- 如果表的并行事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    \n  current_setting('vacuum_freeze_min_age')::int as v3,                -- 手动或自动垃圾回收时, 如果记录的事务ID年龄大于该值, 将被FREEZE    \n  current_setting('vacuum_multixact_freeze_min_age')::int as v4,      -- 手动或自动垃圾回收时, 如果记录的并行事务ID年龄大于该值, 将被FREEZE    \n  current_setting('vacuum_freeze_table_age')::int as v5,              -- 手动垃圾回收时, 如果表的事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_freeze_max_age    \n  current_setting('vacuum_multixact_freeze_table_age')::int as v6,    -- 手动垃圾回收时, 如果表的并行事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_multixact_freeze_max_age    \n  current_setting('autovacuum_vacuum_cost_delay') as v7,              -- 自动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源. -1 表示沿用vacuum_cost_delay的设置    \n  current_setting('autovacuum_vacuum_cost_limit') as v8,              -- 自动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定. -1 表示沿用vacuum_cost_limit的设置    \n  current_setting('vacuum_cost_delay') as v9,                         -- 手动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源.    \n  current_setting('vacuum_cost_limit') as v10,                        -- 手动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定.    \n  current_setting('autovacuum') as autovacuum                         -- 是否开启自动垃圾回收    \n) a,     \nLATERAL (   -- LATERAL 允许你在这个SUBQUERY中直接引用前面的table, subquery中的column     \nselect     \npg_size_pretty(pg_total_relation_size(oid)) sz,   -- 表的大小(含TOAST, 索引)    \noid::regclass as reloid,    -- 表名(物化视图)    \nrelkind,                    -- r=表, m=物化视图    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_freeze_table_age=(\\d+)')::int     \n  ),    \n  a.v1    \n)    \n-    \nage(case when relfrozenxid::text::int<3 then null else relfrozenxid end)     \nas remain_ages_xid,   -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_multixact_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_multixact_freeze_table_age=(\\d+)')::int     \n  ),    \n  a.v2    \n)    \n-    \nage(case when relminmxid::text::int<3 then null else relminmxid end)     \nas remain_ages_mxid,  -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为并发事务ID    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_min_age=(\\d+)')::int    \n  ),    \n  a.v3    \n) as xid_lower_to_minage,    -- 如果触发FREEZE, 该表的事务ID年龄会降到多少    \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_multixact_freeze_min_age=(\\d+)')::int    \n  ),    \n  a.v4    \n) as mxid_lower_to_minage,   -- 如果触发FREEZE, 该表的并行事务ID年龄会降到多少    \ncase     \n  when v5 <= age(case when relfrozenxid::text::int<3 then null else relfrozenxid end) then 'YES'    \n  else 'NOT'    \nend as vacuum_trigger_freeze1,    -- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(事务ID年龄达到阈值)    \ncase     \n  when v6 <= age(case when relminmxid::text::int<3 then null else relminmxid end) then 'YES'    \n  else 'NOT'    \nend as vacuum_trigger_freeze2,    -- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(并行事务ID年龄达到阈值)    \nreloptions                        -- 表级参数, 优先. 例如是否开启自动垃圾回收, autovacuum_freeze_max_age, autovacuum_freeze_table_age, autovacuum_multixact_freeze_max_age, autovacuum_multixact_freeze_table_age    \nfrom pg_class     \n  where relkind in ('r','m')    \n) e     \norder by     \n  least(e.remain_ages_xid , e.remain_ages_mxid),  -- 排在越前, 越先触发自动FREEZE, 即风暴来临的预测    \n  pg_total_relation_size(reloid) desc   -- 同样剩余年龄, 表越大, 排越前    \n;    \n\ncreate view dba.v_freeze_stat as    \nselect     \nwb,                                                     -- 第几个BATCH, 每个batch代表流逝100万个事务     \ncnt,                                                    -- 这个batch 有多少表    \npg_size_pretty(ssz) as ssz1,                            -- 这个batch 这些 表+TOAST+索引 有多少容量    \npg_size_pretty(ssz) as ssz2,                            -- 这个batch FREEZE 会导致多少读IO    \npg_size_pretty(ssz*3) as ssz3,                          -- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    \npg_size_pretty(min_sz) as ssz4,                         -- 这个batch 最小的表多大    \npg_size_pretty(max_sz) as ssz5,                         -- 这个batch 最大的表多大    \npg_size_pretty(avg_sz) as ssz6,                         -- 这个batch 平均表多大    \npg_size_pretty(stddev_sz) as ssz7,                      -- 这个batch 表大小的方差, 越大, 说明表大小差异化明显    \nmin_rest_age,                                           -- 这个batch 距离自动FREEZE最低剩余事务数    \nmax_rest_age,                                           -- 这个batch 距离自动FREEZE最高剩余事务数    \nstddev_rest_age,                                        -- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    \ncorr_rest_age_sz,                                       -- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 sz7 说明的问题越有价值    \nround(100*(ssz/(sum(ssz) over ())), 2)||' %' as ratio   -- 这个BATCH的容量占比，占比如果非常不均匀，说明有必要调整表级FREEZE参数，让占比均匀化    \nfrom         \n(    \nselect a.*, b.* from     \n(    \nselect     \n  min(least(remain_ages_xid, remain_ages_mxid)) as v_min,   -- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    \n  max(least(remain_ages_xid, remain_ages_mxid)) as v_max    -- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    \nfrom v_freeze    \n) as a,    \nLATERAL (  -- 高级SQL    \nselect     \nwidth_bucket(    \n  least(remain_ages_xid, remain_ages_mxid),     \n  a.v_min,    \n  a.v_max,    \n  greatest((a.v_max-a.v_min)/1000000, 1)   -- 100万个事务, 如果要更改统计例如，修改这个值即可    \n) as wb,      \ncount(*) as cnt,     \nsum(pg_total_relation_size(reloid)) as ssz,     \nstddev_samp(pg_total_relation_size(reloid) order by least(remain_ages_xid, remain_ages_mxid)) as stddev_sz,     \nmin(pg_total_relation_size(reloid)) as min_sz,     \nmax(pg_total_relation_size(reloid)) as max_sz,     \navg(pg_total_relation_size(reloid)) as avg_sz,     \nmin(least(remain_ages_xid, remain_ages_mxid)) as min_rest_age,     \nmax(least(remain_ages_xid, remain_ages_mxid)) as max_rest_age,     \nstddev_samp(least(remain_ages_xid, remain_ages_mxid) order by least(remain_ages_xid, remain_ages_mxid)) as stddev_rest_age,     \ncorr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) as corr_rest_age_sz     \nfrom v_freeze     \ngroup by wb     \n) as b     \n) t     \norder by wb; \n\ncreate view dba.v_freeze_stat_detail as      \nselect     \npg_size_pretty(t.ssz) as ssz2,     -- 这个batch FREEZE 会导致多少读IO (表+TOAST+索引)    \npg_size_pretty(t.ssz*3) as ssz3,   -- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    \npg_size_pretty(t.ssz_sum) as ssz4, -- 所有batch 所有表的总大小  (表+TOAST+索引)    \nround(100*(t.ssz/t.ssz_sum), 2)||' %' as ratio_batch,     -- 这个BATCH的容量占比，目标是让所有BATCH占比尽量一致    \nround(100*(pg_total_relation_size(t.reloid)/t.ssz), 2)||' %' as ratio_table,     -- 这个表占整个batch的容量占比，大表尽量错开freeze    \nt.*      \nfrom         \n(    \nselect a.*, b.* from       \n(    \n  select     \n    min(least(remain_ages_xid, remain_ages_mxid)) as v_min,   -- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    \n    max(least(remain_ages_xid, remain_ages_mxid)) as v_max    -- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    \n  from v_freeze     \n) as a,     \nLATERAL (     -- 高级SQL    \nselect     \n  count(*) over w as cnt,                                                -- 这个batch 有多少表      \n  sum(pg_total_relation_size(reloid)) over () as ssz_sum,                -- 所有batch 所有表的总大小  (表+TOAST+索引)    \n  sum(pg_total_relation_size(reloid)) over w as ssz,                     -- 这个batch 的表大小总和 (表+TOAST+索引)    \n  pg_size_pretty(min(pg_total_relation_size(reloid)) over w) as min_sz,  -- 这个batch 最小的表多大    \n  pg_size_pretty(max(pg_total_relation_size(reloid)) over w) as max_sz,  -- 这个batch 最大的表多大    \n  pg_size_pretty(avg(pg_total_relation_size(reloid)) over w) as avg_sz,  -- 这个batch 平均表多大    \n  pg_size_pretty(stddev_samp(pg_total_relation_size(reloid)) over w) as stddev_sz,  -- 这个batch 表大小的方差, 越大, 说明表大小差异化明显                                                                                                                 \n  min(least(remain_ages_xid, remain_ages_mxid)) over w as min_rest_age,             -- 这个batch 距离自动FREEZE最低剩余事务数                                                                                                                             \n  max(least(remain_ages_xid, remain_ages_mxid)) over w as max_rest_age,             -- 这个batch 距离自动FREEZE最高剩余事务数                                                                                                                             \n  stddev_samp(least(remain_ages_xid, remain_ages_mxid)) over w as stddev_rest_age,  -- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    \n  corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) over w as corr_rest_age_sz,  -- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 stddev_sz 说明的问题越有价值    \n  t1.*     \nfrom     \n  (    \n  select     \n    width_bucket(    \n      least(tt.remain_ages_xid, tt.remain_ages_mxid),     \n      a.v_min,    \n      a.v_max,    \n      greatest((a.v_max-a.v_min)/1000000, 1)         -- 100万个事务, 如果要更改统计例如，修改这个值即可    \n    )     \n    as wb,                                           -- 第几个BATCH, 每个batch代表流逝100万个事务      \n    * from v_freeze tt    \n  ) as t1      \n  window w as     \n  (    \n    partition by t1.wb     \n  )     \n) as b    \n) t    \norder by     \n  t.wb,      \n  least(t.remain_ages_xid, t.remain_ages_mxid),       \n  pg_total_relation_size(t.reloid) desc       \n;      \n  \ncreate view dba.top20freezebigtable as \nselect relowner::regrole, relnamespace::regnamespace, relname, \nage(relfrozenxid),pg_size_pretty(pg_total_relation_size(oid)) , -- 当前年龄 \ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_max_age=(\\d+)')::int,     \n    substring(reloptions::text, 'autovacuum_freeze_table_age=(\\d+)')::int     \n  ),    \n  current_setting('autovacuum_freeze_max_age')::int   \n)    \n-    \nage(case when relfrozenxid::text::int<3 then null else relfrozenxid end)     \nas remain_ages_xid,  -- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID\ncoalesce(    \n  least(    \n    substring(reloptions::text, 'autovacuum_freeze_min_age=(\\d+)')::int    \n  ),    \n  current_setting('vacuum_freeze_min_age')::int   \n) as xid_lower_to_minage    -- 如果触发FREEZE, 该表的事务ID年龄会降到多少  \nfrom pg_class where relkind='r' order by pg_total_relation_size(oid) desc limit 20; \n```\n\n# 未归档wal文件\n```\ncreate view dba.arch_undone as \nselect * from pg_ls_archive_statusdir() where name !~ 'done$';\n```\n# 归档任务状态\n```\ncreate view dba.arch_status as\nselect * from pg_stat_get_archiver();\n```\n# wal空间占用\n```\ncreate view dba.walsize as \nselect pg_size_pretty(sum(size)) from pg_ls_waldir();\n```\n# 系统强制保留wal大小\n```\ncreate view dba.wal_keep_size as\nwith a as (select setting from pg_settings where name='wal_keep_segments') , b as (select setting,unit from pg_settings where name='wal_segment_size') select pg_size_pretty(a.setting::int8*b.setting::int8) from a,b;\n```\n# 长事务、prepared statement\n```\ncreate view dba.long_snapshot as \nwith a as (select min(transaction::Text::int8) m from pg_prepared_xacts ),\nb as (select txid_snapshot_xmin(txid_current_snapshot())::text::int8 as m),\nc as (select min(least(backend_xid::text::int8,backend_xmin::text::int8)) m from pg_stat_activity ),\nd as (select datname,usename,pid,query_start,xact_start,now(),wait_event,query from pg_stat_activity where backend_xid is not null or backend_xmin is not null\norder by least(backend_xid::text::int8,backend_xmin::text::int8) limit 1),\ne as (select * from pg_prepared_xacts order by transaction::Text::int8 limit 1)\nselect b.m-least(a.m,c.m),d.*,e.* from a,b,c,d left join e on (1=1);\n```\n\n# 重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)\n```\nselect pg_stat_statements_reset();\n```\n# 查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化\n```\ncreate view dba.session_acting_cnt as select count(*) from pg_stat_activity where wait_event is not null and (backend_xid is not null or backend_xmin is not null); \n```\n\n# 当前活跃会话\n```\ncreate view dba.sessions as select * from pg_stat_activity where wait_event is not null and (backend_xid is not null or backend_xmin is not null);  \n```\n# 查看锁等待\n```\ncreate view dba.locks as with      \nt_wait as      \n(      \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and not a.granted     \n),     \nt_run as     \n(     \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and a.granted     \n),     \nt_overlap as     \n(     \n  select r.* from t_wait w join t_run r on     \n  (     \n    r.locktype is not distinct from w.locktype and     \n    r.database is not distinct from w.database and     \n    r.relation is not distinct from w.relation and     \n    r.page is not distinct from w.page and     \n    r.tuple is not distinct from w.tuple and     \n    r.virtualxid is not distinct from w.virtualxid and     \n    r.transactionid is not distinct from w.transactionid and     \n    r.classid is not distinct from w.classid and     \n    r.objid is not distinct from w.objid and     \n    r.objsubid is not distinct from w.objsubid and     \n    r.pid <> w.pid     \n  )      \n),      \nt_unionall as      \n(      \n  select r.* from t_overlap r      \n  union all      \n  select w.* from t_wait w      \n)      \nselect locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::text,classid::regclass,objid,objsubid,     \nstring_agg(     \n'Pid: '||case when pid is null then 'NULL' else pid::text end||chr(10)||     \n'Lock_Granted: '||case when granted is null then 'NULL' else granted::text end||' , Mode: '||case when mode is null then 'NULL' else mode::text end||' , FastPath: '||case when fastpath is null then 'NULL' else fastpath::text end||' , VirtualTransaction: '||case when virtualtransaction is null then 'NULL' else virtualtransaction::text end||' , Session_State: '||case when state is null then 'NULL' else state::text end||chr(10)||     \n'Username: '||case when usename is null then 'NULL' else usename::text end||' , Database: '||case when datname is null then 'NULL' else datname::text end||' , Client_Addr: '||case when client_addr is null then 'NULL' else client_addr::text end||' , Client_Port: '||case when client_port is null then 'NULL' else client_port::text end||' , Application_Name: '||case when application_name is null then 'NULL' else application_name::text end||chr(10)||      \n'Xact_Start: '||case when xact_start is null then 'NULL' else xact_start::text end||' , Query_Start: '||case when query_start is null then 'NULL' else query_start::text end||' , Xact_Elapse: '||case when (now()-xact_start) is null then 'NULL' else (now()-xact_start)::text end||' , Query_Elapse: '||case when (now()-query_start) is null then 'NULL' else (now()-query_start)::text end||chr(10)||      \n'SQL (Current SQL in Transaction): '||chr(10)||    \ncase when query is null then 'NULL' else query::text end,      \nchr(10)||'--------'||chr(10)      \norder by      \n  (  case mode      \n    when 'INVALID' then 0     \n    when 'AccessShareLock' then 1     \n    when 'RowShareLock' then 2     \n    when 'RowExclusiveLock' then 3     \n    when 'ShareUpdateExclusiveLock' then 4     \n    when 'ShareLock' then 5     \n    when 'ShareRowExclusiveLock' then 6     \n    when 'ExclusiveLock' then 7     \n    when 'AccessExclusiveLock' then 8     \n    else 0     \n  end  ) desc,     \n  (case when granted then 0 else 1 end)    \n) as lock_conflict    \nfrom t_unionall     \ngroup by     \nlocktype,datname,relation,page,tuple,virtualxid,transactionid::text,classid,objid,objsubid ;\n```\n\n# 查看索引支持类型\n```\nSELECT\n    am.amname AS index_method,\n    opc.opcname AS opclass_name,\n    opc.opcintype::regtype AS indexed_type,\n    opc.opcdefault AS is_default\nFROM\n    pg_am am,\n    pg_opclass opc\nWHERE\n    opc.opcmethod = am.oid\nORDER BY\n    index_method,\n    opclass_name;\nSELECT\n    amname,\n    opcname,\n    opcintype::regtype,\n    opckeytype::regtype,\n    opcdefault\nFROM\n    pg_am am,\n    pg_opclass opc\nWHERE\n    am.oid = opc.opcmethod\n    AND amname = 'gin';\n\nSELECT\n    oid,\n    oprnegate,\n    oprname,\n    oprcode,\n    oprresult::regtype,\n    oprleft::regtype,\n    oprright::regtype,\n    oprcanmerge\nFROM\n    pg_operator;\n\n```\n# 判断ip是否在某一网段内\n```\nCREATE OR REPLACE FUNCTION public.is_same_network (ip1 ip4, ip2 ip4, mask integer)\n    RETURNS boolean\nAS\n$$\nDECLARE\n    is_same_network boolean;\nBEGIN\n    IF mask > 32 OR mask < 0 THEN\n        raise\n        exception 'The mask must be between 0 and 32';\n    END IF;\n \n    EXECUTE format('select (~($1 # $2))::bigint::bit(32)::bit(%I)::text ~ ''^1+$''', mask) using ip1, ip2 into is_same_network;\n    RETURN is_same_network;\nexception\n    WHEN OTHERS THEN\n        raise NOTICE '%', SQLERRM;\n    RETURN FALSE;\nEND;\n$$ language plpgsql;\n```\n# 指定字符替换\n```\npostgres=# SELECT regexp_replace('foobarbaz', 'b(..)', 'X\\1Y', 'g');\n regexp_replace \n----------------\n fooXarYXazY\n(1 row)\n\n```\n#  SQL实现圣诞树\n```\nmydb=# WITH leaf AS\n (SELECT lpad(rpad('*', (id - 1) * 2 + 1, '*'), id + 20) leaf,\n         id\n    FROM generate_series(1, 3) AS t(id)),\nlv AS\n (SELECT id lv FROM generate_series(1, 5) AS t(id)),\nleafs AS\n (SELECT lpad(rpad('*', ((row_number() over()) ::INT - 1) * 2 + 1 + (lv - 1) * 2, '*'), (row_number()\n                over())\n               ::INT + 20 + lv) leaf\n    FROM leaf,\n         lv),\nroot AS\n (SELECT lpad(rpad('*', 5, '*'), 24) FROM generate_series(1, 4) AS t(id))\nSELECT leaf\n  FROM leafs\nUNION ALL\nSELECT * FROM root;\n                   leaf                  \n------------------------------------------\n                      *\n                    *****\n                  *********\n                *************\n              *****************\n                 ***********\n               ***************\n             *******************\n           ***********************\n         ***************************\n            *********************\n          *************************\n        *****************************\n      *********************************\n    *************************************\n                    *****\n                    *****\n                    *****\n                    *****\n(19 rows)\n \nmydb=#\n\n```\n#  生成随机中文\n\n```sql\ncreate or replace function gen_hanzi(int) returns text as $$  \ndeclare  \n  res text;  \nbegin  \n  if $1 >=1 then  \n    select string_agg(chr(19968+(random()*20901)::int), '') into res from generate_series(1,$1);  \n    return res;  \n  end if;  \n  return null;  \nend;  \n$$ language plpgsql strict;\n```\n#  生成随机时间\n```\ncreate or replace function get_rand_ts() returns timestamp as $$  \n  select now()::timestamp  +  ((1000*random())::int::text||' days')::interval;            \n$$ language sql strict;  \n```\n# 找出index 维护SQL\n```sql\nselect\n        CASE\n                WHEN flag = 1 THEN\n                        CASE\n                        WHEN indexdef !~ ' WHERE ' THEN\n                                regexp_replace(indexdef, E'(INDEX )(.+)( ON )(.+\\\\)\\$)'  ,E' \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default ','g') ||'; '\n                        ELSE\n                                regexp_replace(indexdef, E'(INDEX )(.+)( ON )(.+)( WHERE )'  ,E' \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default \\\\5 ','g') ||'; '\n                        END\n                WHEN flag = 2 THEN\n                                'ANALYZE VERBOSE '||schemaname||'.'||tablename||' ; select pg_sleep(600) ; DROP INDEX CONCURRENTLY IF EXISTS '||schemaname||'.'||indexname||'; '\n        END\nfrom\n        (\n        select\n                generate_series(1,2) as flag,\n                indexdef,\n                indexname,\n                tablename,\n                pi.schemaname\n        from\n                pg_indexes pi\n        join\n                pg_namespace n\n          on\n                pi.schemaname = n.nspname\n        join\n                pg_class pcl\n          on\n                pcl.relnamespace = n.oid\n                and pcl.relname = pi.tablename\n        left join\n                pg_constraint pco\n          on\n                pco.conname = pi.indexname\n                and pco.conrelid = pcl.oid\n        where\n                (pi.schemaname, pi.tablename) = ('mirror','b2c_order')\n                and pco.contype is distinct from  'p'\n                and pco.contype is distinct from  'u'\n        order by\n                pi.schemaname, tablename, indexname, pg_table_size(schemaname||'.'||indexname::text) desc, flag asc\n        ) as foo\norder by\n       schemaname, tablename, indexname, pg_table_size(schemaname||'.'||indexname::text) desc, flag asc\n;\n```\n\n# 参考\n[德哥](https://github.com/digoal/blog/blob/master/202005/20200509_02.md)\n","slug":"PostgreSQL有用的SQL","published":1,"updated":"2021-03-11T07:01:31.376Z","_id":"ckdu7m6wu003kyrebf7678o8s","comments":1,"layout":"post","photos":[],"link":"","content":"<p>记录工作中常用到的PostgreSQL常用SQL， tps, qps 等等.</p>\n<a id=\"more\"></a>\n<h1 id=\"抓去网站天气信息\"><a href=\"#抓去网站天气信息\" class=\"headerlink\" title=\"抓去网站天气信息\"></a>抓去网站天气信息</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">postgres</span>=#   CREATE <span class=\"hljs-keyword\">OR</span> REPLACE FUNCTION get_weather_info(city text)<br> RETURNS jsonb<br> LANGUAGE plpython3u<br>AS <span class=\"hljs-variable\">$function</span>$<br><br>import re<br>import json<br>import requests, bs4<br><br>res = requests.<span class=\"hljs-builtin-name\">get</span>(<span class=\"hljs-string\">&#x27;http://pm25.in/&#123;&#125;&#x27;</span>.format(city))<br>soup = bs4.BeautifulSoup(res.text, <span class=\"hljs-string\">&#x27;html.parser&#x27;</span>)<br><br><span class=\"hljs-comment\">#script = soup.findAll(&#x27;script&#x27;, text=re.compile(&quot;highcharts&quot;))</span><br><span class=\"hljs-comment\">#categorie = re.findall(&quot;categories: (.*),&quot;,script[0].string)[0]</span><br><span class=\"hljs-comment\">#data = re.findall(&quot;data: (.*),&quot;,script[0].string)[0]</span><br><span class=\"hljs-comment\">#info = dict(zip(json.loads(categorie), json.loads(data)))</span><br><br>table = soup.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;table&#x27;</span>, attrs=&#123;<span class=\"hljs-string\">&quot;id&quot;</span>: <span class=\"hljs-string\">&quot;detail-data&quot;</span>&#125;)<br><span class=\"hljs-builtin-name\">info</span> = &#123;<br>    <span class=\"hljs-string\">&quot;thead&quot;</span>: [ th.get_text() <span class=\"hljs-keyword\">for</span> th <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;thead&#x27;</span>).<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tr&#x27;</span>).select(<span class=\"hljs-string\">&#x27;th&#x27;</span>) ],<br>    <span class=\"hljs-string\">&quot;tbody&quot;</span>: []<br>&#125;<br>theads = [ th.get_text() <span class=\"hljs-keyword\">for</span> th <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;thead&#x27;</span>).<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tr&#x27;</span>).select(<span class=\"hljs-string\">&#x27;th&#x27;</span>) ]<br><span class=\"hljs-keyword\">for</span> tr <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tbody&#x27;</span>).findAll(<span class=\"hljs-string\">&#x27;tr&#x27;</span>):<br>    tbodys = [ td.get_text() <span class=\"hljs-keyword\">for</span> td <span class=\"hljs-keyword\">in</span> tr.select(<span class=\"hljs-string\">&#x27;td&#x27;</span>) ]<br>    <span class=\"hljs-builtin-name\">info</span>[<span class=\"hljs-string\">&#x27;tbody&#x27;</span>].append(tbodys)<br><br>return json.dumps(info, <span class=\"hljs-attribute\">ensure_ascii</span>=<span class=\"hljs-literal\">False</span>)<br><br><span class=\"hljs-variable\">$function</span>$;<br>CREATE FUNCTION<br><span class=\"hljs-attribute\">postgres</span>=# select get_weather_info(<span class=\"hljs-string\">&#x27;putian&#x27;</span>);<br><br>                                                                          f1<br><br>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------------------------<br> &#123;<span class=\"hljs-string\">&quot;tbody&quot;</span>: [[<span class=\"hljs-string\">&quot;荔城区仓后路&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;20&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;15&quot;</span>, <span class=\"hljs-string\">&quot;122&quot;</span>, <span class=\"hljs-string\">&quot;90&quot;</span>, <span class=\"hljs-string\">&quot;5&quot;</span>], [<span class=\"hljs-string\">&quot;莆田市监测站&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;20&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;14&quot;</span>, <span class=\"hljs-string\">&quot;126&quot;</span>, <span class=\"hljs-string\">&quot;98&quot;</span>, <span class=\"hljs-string\">&quot;4&quot;</span>], [<span class=\"hljs-string\">&quot;涵江区六中&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;0.6&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;138&quot;</span>, <span class=\"hljs-string\">&quot;88&quot;</span>, <span class=\"hljs-string\">&quot;7&quot;</span>], [<span class=\"hljs-string\">&quot;秀屿区政府&quot;</span>, <span class=\"hljs-string\">&quot;51&quot;</span>,<br> <span class=\"hljs-string\">&quot;良&quot;</span>, <span class=\"hljs-string\">&quot;颗粒物(PM10)&quot;</span>, <span class=\"hljs-string\">&quot;18&quot;</span>, <span class=\"hljs-string\">&quot;52&quot;</span>, <span class=\"hljs-string\">&quot;0.6&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;128&quot;</span>, <span class=\"hljs-string\">&quot;83&quot;</span>, <span class=\"hljs-string\">&quot;5&quot;</span>], [<span class=\"hljs-string\">&quot;东圳水库&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;58&quot;</span>, <span class=\"hljs-string\">&quot;58&quot;</span>, <span class=\"hljs-string\">&quot;4&quot;</span>], [<span class=\"hljs-string\">&quot;东圳水库(对照点)&quot;</span>, <span class=\"hljs-string\">&quot;36&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;34&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;13&quot;</span>, <span class=\"hljs-string\">&quot;114&quot;</span>, <span class=\"hljs-string\">&quot;81&quot;</span>, <span class=\"hljs-string\">&quot;3&quot;</span>]], <span class=\"hljs-string\">&quot;thead&quot;</span>: [<span class=\"hljs-string\">&quot;监测点&quot;</span>, <span class=\"hljs-string\">&quot;AQI&quot;</span>, <span class=\"hljs-string\">&quot;空</span><br><span class=\"hljs-string\">质量指数类别&quot;</span>, <span class=\"hljs-string\">&quot;首要污染物&quot;</span>, <span class=\"hljs-string\">&quot;PM2.5细颗粒物&quot;</span>, <span class=\"hljs-string\">&quot;PM10可吸入颗粒物&quot;</span>, <span class=\"hljs-string\">&quot;CO一氧化碳&quot;</span>, <span class=\"hljs-string\">&quot;NO2二氧化氮&quot;</span>, <span class=\"hljs-string\">&quot;O3臭氧1小时平均&quot;</span>, <span class=\"hljs-string\">&quot;O3臭氧8小时平均&quot;</span>, <span class=\"hljs-string\">&quot;SO2二氧化硫&quot;</span>]&#125;<br>(1 row)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"plpgsql函数获取Server磁盘空间信息\"><a href=\"#plpgsql函数获取Server磁盘空间信息\" class=\"headerlink\" title=\"plpgsql函数获取Server磁盘空间信息\"></a>plpgsql函数获取Server磁盘空间信息</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR</span> <span class=\"hljs-keyword\">REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> public.get_disk_size()<br> <span class=\"hljs-keyword\">RETURNS</span> jsonb<br> <span class=\"hljs-keyword\">LANGUAGE</span> plpgsql<br><span class=\"hljs-keyword\">AS</span> $<span class=\"hljs-keyword\">function</span>$<br><span class=\"hljs-keyword\">declare</span><br>    sqlstring <span class=\"hljs-built_in\">text</span>;<br>    tablename text;<br>    result jsonb;<br><span class=\"hljs-keyword\">begin</span><br>    <span class=\"hljs-comment\">-- uuid_generate_v4() in pg12-， gen_random_uuid() in pg13+</span><br>    tablename = quote_ident( <span class=\"hljs-string\">&#x27;get_disk_size_&#x27;</span> ||  uuid_generate_v4()::<span class=\"hljs-built_in\">text</span>);<br>    sqlstring = format(&#x27;<span class=\"hljs-keyword\">create</span> temp <span class=\"hljs-keyword\">table</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">exists</span> %s(Filesystem <span class=\"hljs-built_in\">text</span>, <span class=\"hljs-keyword\">type</span> <span class=\"hljs-built_in\">text</span>, <span class=\"hljs-keyword\">Size</span> <span class=\"hljs-built_in\">int</span>, Used <span class=\"hljs-built_in\">int</span>, Avail <span class=\"hljs-built_in\">int</span>, <span class=\"hljs-string\">&quot;useper&quot;</span> <span class=\"hljs-built_in\">numeric</span>, <span class=\"hljs-string\">&quot;mounted on&quot;</span> <span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">ON</span> <span class=\"hljs-keyword\">COMMIT</span> <span class=\"hljs-keyword\">DROP</span><span class=\"hljs-string\">&#x27;, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring;</span><br><span class=\"hljs-string\">    --LC_ALL=C ignore OS language environment</span><br><span class=\"hljs-string\">    sqlstring = format(&#x27;</span>copy %s <span class=\"hljs-keyword\">from</span> program <span class=\"hljs-string\">&#x27;&#x27;</span>LC_ALL=C /<span class=\"hljs-keyword\">bin</span>/df -Tm | /<span class=\"hljs-keyword\">bin</span>/grep -v <span class=\"hljs-string\">&quot;Mounted&quot;</span> | /<span class=\"hljs-keyword\">bin</span>/sed <span class=\"hljs-string\">&quot;s/\\s\\+/|/g&quot;</span> | /<span class=\"hljs-keyword\">bin</span>/sed <span class=\"hljs-string\">&quot;s/%%//g&quot;</span><span class=\"hljs-string\">&#x27;&#x27;</span> <span class=\"hljs-keyword\">with</span> delimiter <span class=\"hljs-string\">&#x27;&#x27;</span>|<span class=\"hljs-string\">&#x27;&#x27;&#x27;, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring;</span><br><span class=\"hljs-string\">    sqlstring = format(&#x27;</span><span class=\"hljs-keyword\">select</span> json_agg(row_to_json(%s.*)) <span class=\"hljs-keyword\">from</span> %s<span class=\"hljs-string\">&#x27;, tablename, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring into result;</span><br><span class=\"hljs-string\">    return result;</span><br><span class=\"hljs-string\">end;</span><br><span class=\"hljs-string\">$function$;</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"python函数获取Server磁盘空间信息\"><a href=\"#python函数获取Server磁盘空间信息\" class=\"headerlink\" title=\"python函数获取Server磁盘空间信息\"></a>python函数获取Server磁盘空间信息</h1><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\">create or replace <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_disk_size</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">returns</span> <span class=\"hljs-title\">jsonb</span> <span class=\"hljs-title\">as</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">$$</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">import</span> <span class=\"hljs-title\">psutil</span> <span class=\"hljs-title\">as</span> <span class=\"hljs-title\">ps</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">import</span> <span class=\"hljs-title\">json</span></span><br><span class=\"hljs-function\"></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">return</span> <span class=\"hljs-title\">json</span>.<span class=\"hljs-title\">dumps</span>(<span class=\"hljs-params\">[&#123;</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;mounted on&quot;</span>: part.mountpoint,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;filesystem&quot;</span>: part.device,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;size&quot;</span>: round(ps.disk_usage(part.mountpoint).total <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;avail&quot;</span>: round(ps.disk_usage(part.mountpoint).free <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;used&quot;</span>: round(ps.disk_usage(part.mountpoint).used <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;use%&quot;</span>: ps.disk_usage(part.mountpoint).percent,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;type&quot;</span>: part.fstype,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;opts&quot;</span>: part.opts&#125;</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    for part in ps.disk_partitions()]</span>)</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">$$LANGUAGE</span> <span class=\"hljs-title\">plpython3u</span>;</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"主库查询主从延迟\"><a href=\"#主库查询主从延迟\" class=\"headerlink\" title=\"主库查询主从延迟\"></a>主库查询主从延迟</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span> pg_stat_replication.application_name,<br>   pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), pg_stat_replication.replay_lsn)) <span class=\"hljs-keyword\">AS</span> diff<br>  <span class=\"hljs-keyword\">FROM</span> pg_stat_replication;<br></code></pre></td></tr></table></figure>\n<h1 id=\"从库查询主从延迟\"><a href=\"#从库查询主从延迟\" class=\"headerlink\" title=\"从库查询主从延迟\"></a>从库查询主从延迟</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    <span class=\"hljs-keyword\">CASE</span><br>        <span class=\"hljs-keyword\">WHEN</span> pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span>::<span class=\"hljs-type\">double</span> <span class=\"hljs-type\">precision</span><br>        <span class=\"hljs-keyword\">ELSE</span> date_part(<span class=\"hljs-string\">&#x27;epoch&#x27;</span>::<span class=\"hljs-type\">text</span>, now() - pg_last_xact_replay_timestamp())<br>    <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> log_delay;<br></code></pre></td></tr></table></figure>\n<h1 id=\"按query分组查询活跃SQL数量\"><a href=\"#按query分组查询活跃SQL数量\" class=\"headerlink\" title=\"按query分组查询活跃SQL数量\"></a>按query分组查询活跃SQL数量</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span> pg_stat_activity.query,<br>   count(<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> count<br>  <span class=\"hljs-keyword\">FROM</span> pg_stat_activity<br> <span class=\"hljs-keyword\">WHERE</span> pg_stat_activity.state &lt;&gt; <span class=\"hljs-string\">&#x27;idle&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AND</span> pg_stat_activity.pid &lt;&gt; pg_backend_pid() <span class=\"hljs-keyword\">AND</span> pg_stat_activity.query &lt;&gt; <span class=\"hljs-string\">&#x27;&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AND</span> pg_stat_activity.query !~ <span class=\"hljs-string\">&#x27;^DISCARD|^SET extra_float_digits = 3&#x27;</span>::<span class=\"hljs-type\">text</span><br> <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> pg_stat_activity.query<br><span class=\"hljs-keyword\">HAVING</span> count(<span class=\"hljs-number\">1</span>) &gt; <span class=\"hljs-number\">1</span><br> <span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> (count(<span class=\"hljs-number\">1</span>)) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询锁\"><a href=\"#查询锁\" class=\"headerlink\" title=\"查询锁\"></a>查询锁</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">select</span><br>      wait.pid,<br>      wait.state,<br>      wait.datname,<br>      (<span class=\"hljs-keyword\">select</span> string_agg(<span class=\"hljs-keyword\">distinct</span> transactionid::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;,&#x27;</span>) <span class=\"hljs-keyword\">from</span> pg_locks <span class=\"hljs-keyword\">where</span> pid = wait.pid <span class=\"hljs-keyword\">and</span> locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span> <span class=\"hljs-keyword\">and</span> transactionid::<span class=\"hljs-type\">text</span> &lt;&gt; wait.transactionid::<span class=\"hljs-type\">text</span>),<br>      wait.virtualxid,<br>      wait.locktype,<br>      wait.usename,<br>      wait.application_name,<br>      wait.client_addr,<br>      wait.wait_event_type,<br>      wait.wait_event,<br>      wait.query_start,<br>      wait.query,<br><br>      wait.relation,<br>      wait.datname || <span class=\"hljs-string\">&#x27;.&#x27;</span> || d.nspname || <span class=\"hljs-string\">&#x27;.&#x27;</span> || c.relname <span class=\"hljs-keyword\">as</span> relname,<br>      granted.relation,<br><br>      granted.pid              <span class=\"hljs-keyword\">as</span> waitfor_pid,<br>      granted.state            <span class=\"hljs-keyword\">as</span> waitfor_state,<br>      granted.transactionid    <span class=\"hljs-keyword\">as</span> waitfor_transactionid,<br>      granted.virtualxid       <span class=\"hljs-keyword\">as</span> waitfor_virtualxid,<br>      granted.locktype         <span class=\"hljs-keyword\">as</span> waitfor_locktype,<br>      granted.usename          <span class=\"hljs-keyword\">as</span> waitfor_usename,<br>      granted.client_addr      <span class=\"hljs-keyword\">as</span> waitfor_client_addr,<br>      granted.application_name <span class=\"hljs-keyword\">as</span> waitfor_application_name,<br>      granted.wait_event_type  <span class=\"hljs-keyword\">as</span> waitfor_wait_event_type,<br>      granted.wait_event       <span class=\"hljs-keyword\">as</span> waitfor_wait_event,<br>      granted.query_start      <span class=\"hljs-keyword\">as</span> waitfor_query_start,<br>      granted.query            <span class=\"hljs-keyword\">as</span> waitfor_query,<br>      now() - granted.query_start  <span class=\"hljs-keyword\">as</span> waitfor_time<br><br><span class=\"hljs-keyword\">from</span><br>    (<span class=\"hljs-keyword\">select</span><br>          a.pid,<br>          a.state,<br>          b.transactionid,<br>          b.virtualxid,<br>          b.locktype,<br>          b.relation,<br>          b.page,<br>          b.tuple,<br>          a.usename,<br>          a.datname,<br>          a.application_name,<br>          a.client_addr,<br>          a.wait_event_type,<br>          a.wait_event,<br>          a.query_start,<br>          a.query<br>     <span class=\"hljs-keyword\">from</span><br>          pg_stat_activity a,<br>          pg_locks b<br>     <span class=\"hljs-keyword\">where</span><br>          a.wait_event_type <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span><br>          <span class=\"hljs-keyword\">and</span> a.pid = b.pid<br>          <span class=\"hljs-keyword\">and</span> granted = <span class=\"hljs-string\">&#x27;f&#x27;</span><br>    ) wait<br><span class=\"hljs-keyword\">join</span><br>    (<span class=\"hljs-keyword\">select</span><br>          b.pid,<br>          b.state,<br>          a.transactionid,<br>          a.virtualxid,<br>          a.locktype,<br>          a.relation,<br>          a.page,<br>          a.tuple,<br>          b.usename,<br>          b.datname,<br>          b.application_name,<br>          b.client_addr,<br>          b.wait_event_type,<br>          b.wait_event,<br>          b.query_start,<br>          b.query<br>    <span class=\"hljs-keyword\">from</span><br>        pg_locks a,<br>        pg_stat_activity b<br>    <span class=\"hljs-keyword\">where</span><br>        a.pid = b.pid<br>        <span class=\"hljs-keyword\">and</span> a.granted = <span class=\"hljs-string\">&#x27;t&#x27;</span><br>    ) granted<br><span class=\"hljs-keyword\">on</span> (<br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.transactionid = granted.transactionid )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;relation&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;relation&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.relation = granted.relation<br>    )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;virtualxid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;virtualxid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.virtualxid = granted.virtualxid )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;tuple&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;tuple&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.relation = granted.relation<br>    <span class=\"hljs-keyword\">and</span> wait.page = granted.page<br>    <span class=\"hljs-keyword\">and</span> wait.tuple = granted.tuple )<br>)<br><span class=\"hljs-keyword\">left join</span><br>    pg_class c<br><span class=\"hljs-keyword\">on</span> ( c.relfilenode = wait.relation )<br><span class=\"hljs-keyword\">left join</span><br>    pg_namespace d<br><span class=\"hljs-keyword\">on</span> ( c.relnamespace = d.oid )<br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>    granted.query_start<br>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询表大小-按占用大小排序\"><a href=\"#查询表大小-按占用大小排序\" class=\"headerlink\" title=\"查询表大小, 按占用大小排序\"></a>查询表大小, 按占用大小排序</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    t.spcname,<br>    (n.nspname::<span class=\"hljs-type\">text</span> || <span class=\"hljs-string\">&#x27;.&#x27;</span>::<span class=\"hljs-type\">text</span>) || c.relname::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AS</span> relation,<br>    pg_size_pretty(pg_total_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> total_table_size,<br>    pg_size_pretty(pg_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> table_only_size,<br>    pg_size_pretty(pg_indexes_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> total_index_size<br><span class=\"hljs-keyword\">FROM</span><br>    pg_class c<br>    <span class=\"hljs-keyword\">LEFT JOIN</span> pg_tablespace t <span class=\"hljs-keyword\">ON</span> c.reltablespace = t.oid<br>    <span class=\"hljs-keyword\">LEFT JOIN</span> pg_namespace n <span class=\"hljs-keyword\">ON</span> n.oid = c.relnamespace<br><span class=\"hljs-keyword\">WHERE</span> (n.nspname &lt;&gt; <span class=\"hljs-keyword\">ALL</span> (<span class=\"hljs-keyword\">ARRAY</span>[<span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>::<span class=\"hljs-type\">name</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>::<span class=\"hljs-type\">name</span>, <span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>::<span class=\"hljs-type\">name</span>]))<br>    <span class=\"hljs-keyword\">AND</span> c.relkind = <span class=\"hljs-string\">&#x27;r&#x27;</span>::&quot;char&quot;<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    (pg_total_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">DESC</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"找出重复的index\"><a href=\"#找出重复的index\" class=\"headerlink\" title=\"找出重复的index\"></a>找出重复的index</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    relname,<br>    (array_agg(idx))[<span class=\"hljs-number\">1</span>] idx1,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">1</span>]) idx1_def,<br>    (array_agg(idx))[<span class=\"hljs-number\">2</span>] idx2,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">2</span>]) idx2_def,<br>    (array_agg(idx))[<span class=\"hljs-number\">3</span>] idx3,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">3</span>]) idx3_def<br><span class=\"hljs-keyword\">FROM</span> (<br>    <span class=\"hljs-keyword\">SELECT</span><br>        indrelid::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">AS</span> relname,<br>        indexrelid::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">AS</span> idx,<br>        (indrelid::<span class=\"hljs-type\">text</span> || indclass::<span class=\"hljs-type\">text</span> || indkey::<span class=\"hljs-type\">text</span> || COALESCE(indexprs::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;&#x27;</span>) || COALESCE(indpred::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;&#x27;</span>)) <span class=\"hljs-keyword\">AS</span> KEY<br>    <span class=\"hljs-keyword\">FROM</span><br>        pg_index) sub<br><span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span><br>    relname,<br>    KEY<br><span class=\"hljs-keyword\">HAVING</span><br>    count(*) &gt; <span class=\"hljs-number\">1</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"自定义操作符兼容Oracle-varchar-int\"><a href=\"#自定义操作符兼容Oracle-varchar-int\" class=\"headerlink\" title=\"自定义操作符兼容Oracle varchar = int\"></a>自定义操作符兼容Oracle varchar = int</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create table test(<span class=\"hljs-builtin-name\">info</span> varchar);<br>CREATE TABLE<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;1&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;2&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;3&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test;<br> info<br>------<br> 1<br> 2<br> 3<br>(3 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br>ERROR:  operator does <span class=\"hljs-keyword\">not</span> exist: character varying = integer<br>LINE 1: select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br>                                      ^<br>HINT:  <span class=\"hljs-literal\">No</span> operator matches the given name <span class=\"hljs-keyword\">and</span> argument types. You might need <span class=\"hljs-keyword\">to</span> <span class=\"hljs-builtin-name\">add</span> explicit<span class=\"hljs-built_in\"> type </span>casts.<br><span class=\"hljs-attribute\">mydb</span>=# CREATE <span class=\"hljs-keyword\">OR</span> REPLACE FUNCTION equal(character varying, integer) RETURNS boolean AS <span class=\"hljs-variable\">$function</span>$ select cast(<span class=\"hljs-variable\">$1</span> as text) = cast(<span class=\"hljs-variable\">$2</span> as text) <span class=\"hljs-variable\">$function</span>$ LANGUAGE sql;<br>CREATE FUNCTION<br><span class=\"hljs-attribute\">mydb</span>=# create operator = (leftarg = varchar, rightarg = int, procedure = equal, commutator = =);<br>CREATE OPERATOR<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br> info<br>------<br> 1<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"兼容instr\"><a href=\"#兼容instr\" class=\"headerlink\" title=\"兼容instr\"></a>兼容instr</h1><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs perl\">mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, 2, 2);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">4</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, 3, 2);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">4</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, -1, 1);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">9</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, -2, 1);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">9</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># \\sf instr</span><br>CREATE OR REPLACE FUNCTION public.instr(str text, <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span> <span class=\"hljs-title\">text</span>, <span class=\"hljs-title\">startpos</span> <span class=\"hljs-title\">integer</span> <span class=\"hljs-title\">DEFAULT</span> 1, <span class=\"hljs-title\">occurrence</span> <span class=\"hljs-title\">integer</span> <span class=\"hljs-title\">DEFAULT</span> 1)</span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">RETURNS</span> <span class=\"hljs-title\">integer</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">function</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">    <span class=\"hljs-title\">tail</span> <span class=\"hljs-title\">text</span></span>;<br>    <span class=\"hljs-keyword\">shift</span> <span class=\"hljs-keyword\">int</span>;<br>    <span class=\"hljs-keyword\">pos</span> <span class=\"hljs-keyword\">int</span>;<br>    i <span class=\"hljs-keyword\">int</span>;<br>begin<br>    <span class=\"hljs-keyword\">shift</span>:= <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">if</span> startpos = <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">or</span> occurrence &lt;= <span class=\"hljs-number\">0</span> then<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>    end <span class=\"hljs-keyword\">if</span>;<br>    <span class=\"hljs-keyword\">if</span> startpos &lt; <span class=\"hljs-number\">0</span> then<br>        str:= <span class=\"hljs-keyword\">reverse</span>(str);<br>        <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>:= <span class=\"hljs-title\">reverse</span></span>(<span class=\"hljs-keyword\">sub</span>);<br>        <span class=\"hljs-keyword\">pos</span>:= -startpos;<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-keyword\">pos</span>:= startpos;<br>    end <span class=\"hljs-keyword\">if</span>;<br>    <span class=\"hljs-keyword\">for</span> i in <span class=\"hljs-number\">1</span>..occurrence loop<br>        <span class=\"hljs-keyword\">shift</span>:= <span class=\"hljs-keyword\">shift</span>+ <span class=\"hljs-keyword\">pos</span>;<br>        tail:= <span class=\"hljs-keyword\">substr</span>(str, <span class=\"hljs-keyword\">shift</span>);<br>        <span class=\"hljs-keyword\">pos</span>:= strpos(tail, <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>)</span>;<br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">pos</span> = <span class=\"hljs-number\">0</span> then<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        end <span class=\"hljs-keyword\">if</span>;<br>    end loop;<br>    <span class=\"hljs-keyword\">if</span> startpos &gt; <span class=\"hljs-number\">0</span> then<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">pos</span>+ <span class=\"hljs-keyword\">shift</span>- <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">length</span>(str)- <span class=\"hljs-keyword\">length</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>)- <span class=\"hljs-title\">pos</span>- <span class=\"hljs-title\">shift</span>+ 3</span>;<br>    end <span class=\"hljs-keyword\">if</span>;<br>end $function$<br>mydb=<span class=\"hljs-comment\">#</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"procedure-异常处理\"><a href=\"#procedure-异常处理\" class=\"headerlink\" title=\"procedure 异常处理\"></a>procedure 异常处理</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">mydb=# CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">f1</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">my_ex_state</span> <span class=\"hljs-title\">text</span>;</span><br>  my_ex_message text;<br>  my_ex_detail text;<br>  my_ex_hint text;<br>  my_ex_ctx text;<br><span class=\"hljs-keyword\">begin</span><br>  <span class=\"hljs-keyword\">begin</span><br>    raise notice <span class=\"hljs-string\">&#x27;A&#x27;</span>;<br>  exception when others <span class=\"hljs-keyword\">then</span><br>    raise notice <span class=\"hljs-string\">&#x27;C&#x27;</span>;<br>    GET STACKED DIAGNOSTICS<br>      my_ex_state   = RETURNED_SQLSTATE,<br>      my_ex_message = MESSAGE_TEXT,<br>      my_ex_detail  = PG_EXCEPTION_DETAIL,<br>      my_ex_hint    = PG_EXCEPTION_HINT,<br>      my_ex_ctx     = PG_EXCEPTION_CONTEXT<br>    ;<br>    raise notice <span class=\"hljs-string\">&#x27;% % % % %&#x27;</span>, my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;<br>  <span class=\"hljs-keyword\">end</span>;<br><br>  commit;<br><br>  <span class=\"hljs-keyword\">begin</span><br>    raise notice <span class=\"hljs-string\">&#x27;B&#x27;</span>;<br>  exception when others <span class=\"hljs-keyword\">then</span><br>    raise notice <span class=\"hljs-string\">&#x27;C&#x27;</span>;<br>    GET STACKED DIAGNOSTICS<br>      my_ex_state   = RETURNED_SQLSTATE,<br>      my_ex_message = MESSAGE_TEXT,<br>      my_ex_detail  = PG_EXCEPTION_DETAIL,<br>      my_ex_hint    = PG_EXCEPTION_HINT,<br>      my_ex_ctx     = PG_EXCEPTION_CONTEXT<br>    ;<br>    raise notice <span class=\"hljs-string\">&#x27;% % % % %&#x27;</span>, my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;<br>  <span class=\"hljs-keyword\">end</span>;<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$</span><br><span class=\"hljs-function\">;</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"找下一个周末\"><a href=\"#找下一个周末\" class=\"headerlink\" title=\"找下一个周末\"></a>找下一个周末</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-22&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-21&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-20&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL只迁移FUNCTION\"><a href=\"#PostgreSQL只迁移FUNCTION\" class=\"headerlink\" title=\"PostgreSQL只迁移FUNCTION\"></a>PostgreSQL只迁移FUNCTION</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">pg_dump -h localhost -U jintao -Fc -s -f db_dump mydb<br>more db_dump<br>pg_restore -l db_dump | grep <span class=\"hljs-keyword\">FUNCTION</span> &gt; function_list<br>cat function_list<br>pg_restore -h localhost -U postgres -d postgres -L function_list db_dump<br></code></pre></td></tr></table></figure>\n<h1 id=\"pageinspect-查看xmax的状态\"><a href=\"#pageinspect-查看xmax的状态\" class=\"headerlink\" title=\"pageinspect 查看xmax的状态\"></a>pageinspect 查看xmax的状态</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">SELECT</span> lp,<br>       t_ctid <span class=\"hljs-keyword\">AS</span> ctid,<br>       t_xmin <span class=\"hljs-keyword\">AS</span> xmin,<br>       t_xmax <span class=\"hljs-keyword\">AS</span> xmax,<br>       (t_infomask &amp; <span class=\"hljs-number\">128</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_is_lock,<br>       (t_infomask &amp; <span class=\"hljs-number\">1024</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_committed,<br>       (t_infomask &amp; <span class=\"hljs-number\">2048</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_rolled_back,<br>       (t_infomask &amp; <span class=\"hljs-number\">4096</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_multixact,<br>       t_attrs[<span class=\"hljs-number\">1</span>] <span class=\"hljs-keyword\">AS</span> p_id,<br>       t_attrs[<span class=\"hljs-number\">2</span>] <span class=\"hljs-keyword\">AS</span> p_val<br><span class=\"hljs-keyword\">FROM</span> heap_page_item_attrs(<br>        get_raw_page(<span class=\"hljs-string\">&#x27;parent&#x27;</span>, <span class=\"hljs-number\">0</span>),<br>        <span class=\"hljs-string\">&#x27;parent&#x27;</span><br>     );<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL9-1主从延迟查询\"><a href=\"#PostgreSQL9-1主从延迟查询\" class=\"headerlink\" title=\"PostgreSQL9.1主从延迟查询\"></a>PostgreSQL9.1主从延迟查询</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">postgres=<span class=\"hljs-comment\"># \\sf pg_xlog_location_diff</span><br>CREATE OR REPLACE FUNCTION pg_catalog.pg_xlog_location_diff(text, text)<br> RETURNS numeric<br> LANGUAGE plpgsql<br>AS <span class=\"hljs-variable\">$function</span>$<br>    DECLARE<br>       offset1 text;<br>       offset2 text;<br>       xlog1 text;<br>       xlog2 text;<br>       SQL text;<br>       diff text;<br>    <span class=\"hljs-keyword\">BEGIN</span><br>       /* Extract the Offset and xlog from input <span class=\"hljs-keyword\">in</span><br>          offset and xlog variables */<br><br>       offset1=split_part(<span class=\"hljs-variable\">$1</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">2</span>);<br>         xlog1=split_part(<span class=\"hljs-variable\">$1</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">1</span>);<br>       offset2=split_part(<span class=\"hljs-variable\">$2</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">2</span>);<br>         xlog2=split_part(<span class=\"hljs-variable\">$2</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">1</span>);<br><br>       /* Prepare SQL query <span class=\"hljs-keyword\">for</span> calculation based on following formula<br>         (FF000000 * xlog + offset) - (FF000000 * xlog + offset)<br>         which gives value <span class=\"hljs-keyword\">in</span> hexadecimal. Since, hexadecimal calculation is cumbersome<br>         so convert into decimal and then calculate the difference */<br><br>       SQL=<span class=\"hljs-string\">&#x27;SELECT (x&#x27;</span><span class=\"hljs-string\">&#x27;&#x27;</span>||<span class=\"hljs-string\">&#x27;FF000000&#x27;</span>||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint * x&#x27;&#x27;&#x27;</span>||xlog1||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint</span><br><span class=\"hljs-string\">                                +  x&#x27;&#x27;&#x27;</span>||offset1||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint)&#x27;||&#x27;</span><br><span class=\"hljs-string\">                -</span><br><span class=\"hljs-string\">                   (x&#x27;&#x27;&#x27;</span>||<span class=\"hljs-string\">&#x27;FF000000&#x27;</span>||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint * x&#x27;&#x27;&#x27;</span>||xlog2||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint</span><br><span class=\"hljs-string\">                                +  x&#x27;&#x27;&#x27;</span>||offset2||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint)&#x27;;</span><br><span class=\"hljs-string\">       EXECUTE SQL into diff;</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">       /* Return the value in numeric by explicit casting  */</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">       RETURN diff::numeric;</span><br><span class=\"hljs-string\">    END;</span><br><span class=\"hljs-string\"> $function$</span><br><span class=\"hljs-string\">postgres=# SELECT</span><br><span class=\"hljs-string\">    application_name,</span><br><span class=\"hljs-string\">    pg_xlog_location_diff(pg_current_xlog_location(), replay_location) as diff</span><br><span class=\"hljs-string\">FROM</span><br><span class=\"hljs-string\">    pg_stat_replication</span><br><span class=\"hljs-string\">;</span><br><span class=\"hljs-string\"> application_name | diff</span><br><span class=\"hljs-string\">------------------+-------</span><br><span class=\"hljs-string\"> walreceiver      | 18272</span><br><span class=\"hljs-string\">(1 row)</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取cluster初始化的时间\"><a href=\"#获取cluster初始化的时间\" class=\"headerlink\" title=\"获取cluster初始化的时间\"></a>获取cluster初始化的时间</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">$ pg_controldata |grep -i system<br>Database<span class=\"hljs-built_in\"> system </span>identifier:           6888133981158752630<br>$ psql<br>psql (14devel)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">mydb</span>=# SELECT to_timestamp(((6888133981158752630&gt;&gt;32) &amp; (2^32 -1)::bigint));<br>      to_timestamp<br>------------------------<br> 2020-10-27 11:17:48+08<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"tuple-internal详解\"><a href=\"#tuple-internal详解\" class=\"headerlink\" title=\"tuple-internal详解\"></a>tuple-internal详解</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>pgconf.ru<span class=\"hljs-regexp\">/media/</span><span class=\"hljs-number\">2016</span><span class=\"hljs-regexp\">/05/</span><span class=\"hljs-number\">13</span>/tuple-internals.pdf<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL-clog最大大小\"><a href=\"#PostgreSQL-clog最大大小\" class=\"headerlink\" title=\"PostgreSQL clog最大大小\"></a>PostgreSQL clog最大大小</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-meta\">#define CLOG_BITS_PER_XACT      2   //2bit一个事物</span><br><span class=\"hljs-meta\">#define CLOG_XACTS_PER_BYTE 4       //1Byte4个事物</span><br><span class=\"hljs-meta\">#define CLOG_XACTS_PER_PAGE (BLCKSZ * CLOG_XACTS_PER_BYTE)</span><br><br><span class=\"hljs-number\">500</span>M，内存中处理完全够效率, 想想要是<span class=\"hljs-number\">64</span>位xid, 光clog大小就不一定多大了.<br><br>clog总大小约<span class=\"hljs-number\">500</span>MB, 每个clog文件<span class=\"hljs-number\">256</span>kb, 最多<span class=\"hljs-number\">2097152</span>个clog文件.<br><br>mydb=# <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>^<span class=\"hljs-number\">31</span>/<span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">256</span>;<br> ?<span class=\"hljs-keyword\">column</span>?<br><span class=\"hljs-comment\">----------</span><br>  <span class=\"hljs-number\">2097152</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=# <span class=\"hljs-keyword\">select</span> pg_size_pretty((<span class=\"hljs-number\">2</span>^<span class=\"hljs-number\">31</span>/<span class=\"hljs-number\">4</span>)::<span class=\"hljs-type\">bigint</span>);<br> pg_size_pretty<br><span class=\"hljs-comment\">----------------</span><br> <span class=\"hljs-number\">512</span> MB<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"bytea转为原始字符\"><a href=\"#bytea转为原始字符\" class=\"headerlink\" title=\"bytea转为原始字符\"></a>bytea转为原始字符</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> t_bytea(<span class=\"hljs-keyword\">info</span> <span class=\"hljs-type\">bytea</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>postgres=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> t_bytea <span class=\"hljs-keyword\">select</span> <span class=\"hljs-string\">&#x27;hello&#x27;</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>postgres=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> t_bytea <span class=\"hljs-keyword\">select</span> <span class=\"hljs-string\">&#x27;我的家乡&#x27;</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>postgres=# <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> t_bytea ;<br>            <span class=\"hljs-keyword\">info</span><br><span class=\"hljs-comment\">----------------------------</span><br> \\x68656c6c6f<br> \\xe68891e79a84e5aeb6e4b9a1<br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-keyword\">select</span> encode(<span class=\"hljs-keyword\">info</span>, <span class=\"hljs-string\">&#x27;escape&#x27;</span>) <span class=\"hljs-keyword\">from</span> t_bytea ;<br>                      encode<br><span class=\"hljs-comment\">--------------------------------------------------</span><br> hello<br> \\<span class=\"hljs-number\">346</span>\\<span class=\"hljs-number\">210</span>\\<span class=\"hljs-number\">221</span>\\<span class=\"hljs-number\">347</span>\\<span class=\"hljs-number\">232</span>\\<span class=\"hljs-number\">204</span>\\<span class=\"hljs-number\">345</span>\\<span class=\"hljs-number\">256</span>\\<span class=\"hljs-number\">266</span>\\<span class=\"hljs-number\">344</span>\\<span class=\"hljs-number\">271</span>\\<span class=\"hljs-number\">241</span><br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-keyword\">select</span> convert_from(<span class=\"hljs-keyword\">info</span>, <span class=\"hljs-string\">&#x27;UTF8&#x27;</span>) <span class=\"hljs-keyword\">from</span> t_bytea ;<br> convert_from<br><span class=\"hljs-comment\">--------------</span><br> hello<br> 我的家乡<br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs n1ql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">schema</span> dba;<br></code></pre></td></tr></table></figure>\n<h1 id=\"tps\"><a href=\"#tps\" class=\"headerlink\" title=\"tps\"></a>tps</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">procedure</span> dba.tps() <span class=\"hljs-keyword\">as</span> $$<br><span class=\"pgsql\"><span class=\"hljs-keyword\">declare</span></span><br><span class=\"pgsql\">  v1 <span class=\"hljs-type\">int8</span>;</span><br><span class=\"pgsql\">  v2 <span class=\"hljs-type\">int8</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">begin</span></span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class=\"hljs-keyword\">into</span> v1;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">commit</span>;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">perform</span> pg_sleep(<span class=\"hljs-number\">1</span>);</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class=\"hljs-keyword\">into</span> v2;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">commit</span>;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">raise</span> <span class=\"hljs-keyword\">notice</span> <span class=\"hljs-string\">&#x27;tps: %&#x27;</span>, v2-v1;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">end</span>;</span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> plpgsql ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"qps\"><a href=\"#qps\" class=\"headerlink\" title=\"qps\"></a>qps</h1><p>用select sum(calls) s from pg_stat_statements(false) 而不用select sum(calls) s from pg_stat_statements<br>不需要具体的query, 查询效率好很多.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">with</span><br>a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> sum(calls) s <span class=\"hljs-keyword\">from</span> pg_stat_statements(<span class=\"hljs-keyword\">false</span>)),   <br>b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> sum(calls) s <span class=\"hljs-keyword\">from</span> pg_stat_statements(<span class=\"hljs-keyword\">false</span>) , pg_sleep(<span class=\"hljs-number\">1</span>))   <br><span class=\"hljs-keyword\">select</span>   <br>b.s-a.s          <span class=\"hljs-comment\">-- QPS  </span><br><span class=\"hljs-keyword\">from</span> a,b;<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"查询没有使用过的大于1MB的索引-top-10\"><a href=\"#查询没有使用过的大于1MB的索引-top-10\" class=\"headerlink\" title=\"查询没有使用过的大于1MB的索引 top 10\"></a>查询没有使用过的大于1MB的索引 top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10notusedidx <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(indexrelid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_indexes<br><span class=\"hljs-keyword\">WHERE</span><br>    pg_relation_size(indexrelid) &gt;= <span class=\"hljs-number\">1024000</span><br>    <span class=\"hljs-keyword\">AND</span> (idx_scan = <span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">OR</span> idx_tup_read = <span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">OR</span> idx_tup_fetch = <span class=\"hljs-number\">0</span>)<br>    <span class=\"hljs-keyword\">AND</span> schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    pg_relation_size(indexrelid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<p>注意, PK、UK如果只是用于约束, 可能不会被统计计数,但是不能删掉) </p>\n<h1 id=\"查询没有使用过的大于1MB的表-top-10\"><a href=\"#查询没有使用过的大于1MB的表-top-10\" class=\"headerlink\" title=\"查询没有使用过的大于1MB的表 top 10\"></a>查询没有使用过的大于1MB的表 top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10notusedtab <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_tables<br><span class=\"hljs-keyword\">WHERE</span><br>    pg_relation_size(relid) &gt;= <span class=\"hljs-number\">1024000</span><br>    <span class=\"hljs-keyword\">AND</span> seq_scan = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-keyword\">AND</span> idx_scan = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-keyword\">AND</span> schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    pg_relation_size(relid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询热表top-10\"><a href=\"#查询热表top-10\" class=\"headerlink\" title=\"查询热表top 10\"></a>查询热表top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10hottab <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_tables<br><span class=\"hljs-keyword\">WHERE</span><br>    schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    seq_scan + idx_scan <span class=\"hljs-keyword\">DESC</span>,<br>    pg_relation_size(relid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"在standby节点执行，-接收wal的速度。\"><a href=\"#在standby节点执行，-接收wal的速度。\" class=\"headerlink\" title=\"在standby节点执行， 接收wal的速度。\"></a>在standby节点执行， 接收wal的速度。</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">dba</span>.<span class=\"hljs-title\">wal_receive_bw</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">v1</span> <span class=\"hljs-title\">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class=\"hljs-keyword\">begin</span><br>  select pg_last_wal_receive_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class=\"hljs-number\">1</span>);<br>  select pg_last_wal_receive_lsn() into v2;<br>  commit;<br>  raise notice <span class=\"hljs-string\">&#x27;wal receive bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$;</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"在standby节点执行，-replay-wal的速度。\"><a href=\"#在standby节点执行，-replay-wal的速度。\" class=\"headerlink\" title=\"在standby节点执行， replay wal的速度。\"></a>在standby节点执行， replay wal的速度。</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">dba</span>.<span class=\"hljs-title\">wal_replay_bw</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">v1</span> <span class=\"hljs-title\">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class=\"hljs-keyword\">begin</span><br>  select pg_last_wal_replay_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class=\"hljs-number\">1</span>);<br>  select pg_last_wal_replay_lsn() into v2;<br>  commit;<br>  raise notice <span class=\"hljs-string\">&#x27;wal replay bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$;</span> <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀空间top-10的表\"><a href=\"#查询膨胀空间top-10的表\" class=\"headerlink\" title=\"查询膨胀空间top 10的表\"></a>查询膨胀空间top 10的表</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatsizetable <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wastedbytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀空间top-10的索引\"><a href=\"#查询膨胀空间top-10的索引\" class=\"headerlink\" title=\"查询膨胀空间top 10的索引\"></a>查询膨胀空间top 10的索引</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatsizeindex <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wastedibytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀比例top-10的表-浪费空间大于10MB的表\"><a href=\"#查询膨胀比例top-10的表-浪费空间大于10MB的表\" class=\"headerlink\" title=\"查询膨胀比例top 10的表(浪费空间大于10MB的表)\"></a>查询膨胀比例top 10的表(浪费空间大于10MB的表)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatratiotable <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml   <br><span class=\"hljs-keyword\">where</span> (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span>) &gt;= <span class=\"hljs-number\">10240000</span>  <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> tbloat <span class=\"hljs-keyword\">desc</span>,wastedbytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀比例top-10的索引-浪费空间大于10MB的索引\"><a href=\"#查询膨胀比例top-10的索引-浪费空间大于10MB的索引\" class=\"headerlink\" title=\"查询膨胀比例top 10的索引(浪费空间大于10MB的索引)\"></a>查询膨胀比例top 10的索引(浪费空间大于10MB的索引)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatratioindex <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml   <br><span class=\"hljs-keyword\">where</span> (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span>) &gt;= <span class=\"hljs-number\">10240000</span>  <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> ibloat <span class=\"hljs-keyword\">desc</span>,wastedibytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>; <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询序列距离最大值的范围\"><a href=\"#查询序列距离最大值的范围\" class=\"headerlink\" title=\"查询序列距离最大值的范围\"></a>查询序列距离最大值的范围</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.seqs <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> max_value-last_value,* <span class=\"hljs-keyword\">from</span> pg_sequences <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> max_value-last_value ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"freeze风暴预测相关的3个视图\"><a href=\"#freeze风暴预测相关的3个视图\" class=\"headerlink\" title=\"freeze风暴预测相关的3个视图\"></a>freeze风暴预测相关的3个视图</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze <span class=\"hljs-keyword\">as</span>    <br><span class=\"hljs-keyword\">select</span>     <br>  e.*,     <br>  a.*     <br><span class=\"hljs-keyword\">from</span>    <br>(<span class=\"hljs-keyword\">select</span>     <br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v1,            <span class=\"hljs-comment\">-- 如果表的事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v2,  <span class=\"hljs-comment\">-- 如果表的并行事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v3,                <span class=\"hljs-comment\">-- 手动或自动垃圾回收时, 如果记录的事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_multixact_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v4,      <span class=\"hljs-comment\">-- 手动或自动垃圾回收时, 如果记录的并行事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_table_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v5,              <span class=\"hljs-comment\">-- 手动垃圾回收时, 如果表的事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_freeze_max_age    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_multixact_freeze_table_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v6,    <span class=\"hljs-comment\">-- 手动垃圾回收时, 如果表的并行事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_multixact_freeze_max_age    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_vacuum_cost_delay&#x27;</span>) <span class=\"hljs-keyword\">as</span> v7,              <span class=\"hljs-comment\">-- 自动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源. -1 表示沿用vacuum_cost_delay的设置    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_vacuum_cost_limit&#x27;</span>) <span class=\"hljs-keyword\">as</span> v8,              <span class=\"hljs-comment\">-- 自动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定. -1 表示沿用vacuum_cost_limit的设置    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_cost_delay&#x27;</span>) <span class=\"hljs-keyword\">as</span> v9,                         <span class=\"hljs-comment\">-- 手动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源.    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_cost_limit&#x27;</span>) <span class=\"hljs-keyword\">as</span> v10,                        <span class=\"hljs-comment\">-- 手动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定.    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum&#x27;</span>) <span class=\"hljs-keyword\">as</span> autovacuum                         <span class=\"hljs-comment\">-- 是否开启自动垃圾回收    </span><br>) a,     <br><span class=\"hljs-keyword\">LATERAL</span> (   <span class=\"hljs-comment\">-- LATERAL 允许你在这个SUBQUERY中直接引用前面的table, subquery中的column     </span><br><span class=\"hljs-keyword\">select</span>     <br>pg_size_pretty(pg_total_relation_size(<span class=\"hljs-type\">oid</span>)) sz,   <span class=\"hljs-comment\">-- 表的大小(含TOAST, 索引)    </span><br><span class=\"hljs-type\">oid</span>::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">as</span> reloid,    <span class=\"hljs-comment\">-- 表名(物化视图)    </span><br>relkind,                    <span class=\"hljs-comment\">-- r=表, m=物化视图    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  a.v1    <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_xid,   <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  a.v2    <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relminmxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relminmxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_mxid,  <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为并发事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  a.v3    <br>) <span class=\"hljs-keyword\">as</span> xid_lower_to_minage,    <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  a.v4    <br>) <span class=\"hljs-keyword\">as</span> mxid_lower_to_minage,   <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的并行事务ID年龄会降到多少    </span><br><span class=\"hljs-keyword\">case</span>     <br>  <span class=\"hljs-keyword\">when</span> v5 &lt;= age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>) <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;YES&#x27;</span>    <br>  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;NOT&#x27;</span>    <br><span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">as</span> vacuum_trigger_freeze1,    <span class=\"hljs-comment\">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(事务ID年龄达到阈值)    </span><br><span class=\"hljs-keyword\">case</span>     <br>  <span class=\"hljs-keyword\">when</span> v6 &lt;= age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relminmxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relminmxid <span class=\"hljs-keyword\">end</span>) <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;YES&#x27;</span>    <br>  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;NOT&#x27;</span>    <br><span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">as</span> vacuum_trigger_freeze2,    <span class=\"hljs-comment\">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(并行事务ID年龄达到阈值)    </span><br>reloptions                        <span class=\"hljs-comment\">-- 表级参数, 优先. 例如是否开启自动垃圾回收, autovacuum_freeze_max_age, autovacuum_freeze_table_age, autovacuum_multixact_freeze_max_age, autovacuum_multixact_freeze_table_age    </span><br><span class=\"hljs-keyword\">from</span> pg_class     <br>  <span class=\"hljs-keyword\">where</span> relkind <span class=\"hljs-keyword\">in</span> (<span class=\"hljs-string\">&#x27;r&#x27;</span>,<span class=\"hljs-string\">&#x27;m&#x27;</span>)    <br>) e     <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>     <br>  least(e.remain_ages_xid , e.remain_ages_mxid),  <span class=\"hljs-comment\">-- 排在越前, 越先触发自动FREEZE, 即风暴来临的预测    </span><br>  pg_total_relation_size(reloid) <span class=\"hljs-keyword\">desc</span>   <span class=\"hljs-comment\">-- 同样剩余年龄, 表越大, 排越前    </span><br>;    <br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze_stat <span class=\"hljs-keyword\">as</span>    <br><span class=\"hljs-keyword\">select</span>     <br>wb,                                                     <span class=\"hljs-comment\">-- 第几个BATCH, 每个batch代表流逝100万个事务     </span><br>cnt,                                                    <span class=\"hljs-comment\">-- 这个batch 有多少表    </span><br>pg_size_pretty(ssz) <span class=\"hljs-keyword\">as</span> ssz1,                            <span class=\"hljs-comment\">-- 这个batch 这些 表+TOAST+索引 有多少容量    </span><br>pg_size_pretty(ssz) <span class=\"hljs-keyword\">as</span> ssz2,                            <span class=\"hljs-comment\">-- 这个batch FREEZE 会导致多少读IO    </span><br>pg_size_pretty(ssz*<span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">as</span> ssz3,                          <span class=\"hljs-comment\">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(min_sz) <span class=\"hljs-keyword\">as</span> ssz4,                         <span class=\"hljs-comment\">-- 这个batch 最小的表多大    </span><br>pg_size_pretty(max_sz) <span class=\"hljs-keyword\">as</span> ssz5,                         <span class=\"hljs-comment\">-- 这个batch 最大的表多大    </span><br>pg_size_pretty(avg_sz) <span class=\"hljs-keyword\">as</span> ssz6,                         <span class=\"hljs-comment\">-- 这个batch 平均表多大    </span><br>pg_size_pretty(stddev_sz) <span class=\"hljs-keyword\">as</span> ssz7,                      <span class=\"hljs-comment\">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显    </span><br>min_rest_age,                                           <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最低剩余事务数    </span><br>max_rest_age,                                           <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最高剩余事务数    </span><br>stddev_rest_age,                                        <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>corr_rest_age_sz,                                       <span class=\"hljs-comment\">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 sz7 说明的问题越有价值    </span><br>round(<span class=\"hljs-number\">100</span>*(ssz/(sum(ssz) <span class=\"hljs-keyword\">over</span> ())), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio   <span class=\"hljs-comment\">-- 这个BATCH的容量占比，占比如果非常不均匀，说明有必要调整表级FREEZE参数，让占比均匀化    </span><br><span class=\"hljs-keyword\">from</span>         <br>(    <br><span class=\"hljs-keyword\">select</span> a.*, b.* <span class=\"hljs-keyword\">from</span>     <br>(    <br><span class=\"hljs-keyword\">select</span>     <br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_min,   <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_max    <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br><span class=\"hljs-keyword\">from</span> v_freeze    <br>) <span class=\"hljs-keyword\">as</span> a,    <br><span class=\"hljs-keyword\">LATERAL</span> (  <span class=\"hljs-comment\">-- 高级SQL    </span><br><span class=\"hljs-keyword\">select</span>     <br>width_bucket(    <br>  least(remain_ages_xid, remain_ages_mxid),     <br>  a.v_min,    <br>  a.v_max,    <br>  greatest((a.v_max-a.v_min)/<span class=\"hljs-number\">1000000</span>, <span class=\"hljs-number\">1</span>)   <span class=\"hljs-comment\">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>) <span class=\"hljs-keyword\">as</span> wb,      <br>count(*) <span class=\"hljs-keyword\">as</span> cnt,     <br>sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> ssz,     <br>stddev_samp(pg_total_relation_size(reloid) <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> stddev_sz,     <br>min(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> min_sz,     <br>max(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> max_sz,     <br>avg(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> avg_sz,     <br>min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> min_rest_age,     <br>max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> max_rest_age,     <br>stddev_samp(least(remain_ages_xid, remain_ages_mxid) <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> stddev_rest_age,     <br>corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> corr_rest_age_sz     <br><span class=\"hljs-keyword\">from</span> v_freeze     <br><span class=\"hljs-keyword\">group</span> <span class=\"hljs-keyword\">by</span> wb     <br>) <span class=\"hljs-keyword\">as</span> b     <br>) t     <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wb; <br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze_stat_detail <span class=\"hljs-keyword\">as</span>      <br><span class=\"hljs-keyword\">select</span>     <br>pg_size_pretty(t.ssz) <span class=\"hljs-keyword\">as</span> ssz2,     <span class=\"hljs-comment\">-- 这个batch FREEZE 会导致多少读IO (表+TOAST+索引)    </span><br>pg_size_pretty(t.ssz*<span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">as</span> ssz3,   <span class=\"hljs-comment\">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(t.ssz_sum) <span class=\"hljs-keyword\">as</span> ssz4, <span class=\"hljs-comment\">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>round(<span class=\"hljs-number\">100</span>*(t.ssz/t.ssz_sum), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio_batch,     <span class=\"hljs-comment\">-- 这个BATCH的容量占比，目标是让所有BATCH占比尽量一致    </span><br>round(<span class=\"hljs-number\">100</span>*(pg_total_relation_size(t.reloid)/t.ssz), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio_table,     <span class=\"hljs-comment\">-- 这个表占整个batch的容量占比，大表尽量错开freeze    </span><br>t.*      <br><span class=\"hljs-keyword\">from</span>         <br>(    <br><span class=\"hljs-keyword\">select</span> a.*, b.* <span class=\"hljs-keyword\">from</span>       <br>(    <br>  <span class=\"hljs-keyword\">select</span>     <br>    min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_min,   <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>    max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_max    <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br>  <span class=\"hljs-keyword\">from</span> v_freeze     <br>) <span class=\"hljs-keyword\">as</span> a,     <br><span class=\"hljs-keyword\">LATERAL</span> (     <span class=\"hljs-comment\">-- 高级SQL    </span><br><span class=\"hljs-keyword\">select</span>     <br>  count(*) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> cnt,                                                <span class=\"hljs-comment\">-- 这个batch 有多少表      </span><br>  sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> () <span class=\"hljs-keyword\">as</span> ssz_sum,                <span class=\"hljs-comment\">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>  sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> ssz,                     <span class=\"hljs-comment\">-- 这个batch 的表大小总和 (表+TOAST+索引)    </span><br>  pg_size_pretty(min(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> min_sz,  <span class=\"hljs-comment\">-- 这个batch 最小的表多大    </span><br>  pg_size_pretty(max(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> max_sz,  <span class=\"hljs-comment\">-- 这个batch 最大的表多大    </span><br>  pg_size_pretty(avg(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> avg_sz,  <span class=\"hljs-comment\">-- 这个batch 平均表多大    </span><br>  pg_size_pretty(stddev_samp(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> stddev_sz,  <span class=\"hljs-comment\">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显                                                                                                                 </span><br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> min_rest_age,             <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最低剩余事务数                                                                                                                             </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> max_rest_age,             <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最高剩余事务数                                                                                                                             </span><br>  stddev_samp(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> stddev_rest_age,  <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>  corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> corr_rest_age_sz,  <span class=\"hljs-comment\">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 stddev_sz 说明的问题越有价值    </span><br>  t1.*     <br><span class=\"hljs-keyword\">from</span>     <br>  (    <br>  <span class=\"hljs-keyword\">select</span>     <br>    width_bucket(    <br>      least(tt.remain_ages_xid, tt.remain_ages_mxid),     <br>      a.v_min,    <br>      a.v_max,    <br>      greatest((a.v_max-a.v_min)/<span class=\"hljs-number\">1000000</span>, <span class=\"hljs-number\">1</span>)         <span class=\"hljs-comment\">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>    )     <br>    <span class=\"hljs-keyword\">as</span> wb,                                           <span class=\"hljs-comment\">-- 第几个BATCH, 每个batch代表流逝100万个事务      </span><br>    * <span class=\"hljs-keyword\">from</span> v_freeze tt    <br>  ) <span class=\"hljs-keyword\">as</span> t1      <br>  <span class=\"hljs-keyword\">window</span> w <span class=\"hljs-keyword\">as</span>     <br>  (    <br>    <span class=\"hljs-keyword\">partition</span> <span class=\"hljs-keyword\">by</span> t1.wb     <br>  )     <br>) <span class=\"hljs-keyword\">as</span> b    <br>) t    <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>     <br>  t.wb,      <br>  least(t.remain_ages_xid, t.remain_ages_mxid),       <br>  pg_total_relation_size(t.reloid) <span class=\"hljs-keyword\">desc</span>       <br>;      <br>  <br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top20freezebigtable <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> relowner::<span class=\"hljs-type\">regrole</span>, relnamespace::<span class=\"hljs-type\">regnamespace</span>, relname, <br>age(relfrozenxid),pg_size_pretty(pg_total_relation_size(<span class=\"hljs-type\">oid</span>)) , <span class=\"hljs-comment\">-- 当前年龄 </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span>   <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_xid,  <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID</span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span>   <br>) <span class=\"hljs-keyword\">as</span> xid_lower_to_minage    <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少  </span><br><span class=\"hljs-keyword\">from</span> pg_class <span class=\"hljs-keyword\">where</span> relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span> <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> pg_total_relation_size(<span class=\"hljs-type\">oid</span>) <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">20</span>; <br></code></pre></td></tr></table></figure>\n<h1 id=\"未归档wal文件\"><a href=\"#未归档wal文件\" class=\"headerlink\" title=\"未归档wal文件\"></a>未归档wal文件</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.arch_undone <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_ls_archive_statusdir() <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span> !~ <span class=\"hljs-string\">&#x27;done$&#x27;</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"归档任务状态\"><a href=\"#归档任务状态\" class=\"headerlink\" title=\"归档任务状态\"></a>归档任务状态</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.arch_status <span class=\"hljs-keyword\">as</span><br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_stat_get_archiver();<br></code></pre></td></tr></table></figure>\n<h1 id=\"wal空间占用\"><a href=\"#wal空间占用\" class=\"headerlink\" title=\"wal空间占用\"></a>wal空间占用</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.walsize <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> pg_size_pretty(sum(size)) <span class=\"hljs-keyword\">from</span> pg_ls_waldir();<br></code></pre></td></tr></table></figure>\n<h1 id=\"系统强制保留wal大小\"><a href=\"#系统强制保留wal大小\" class=\"headerlink\" title=\"系统强制保留wal大小\"></a>系统强制保留wal大小</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.wal_keep_size <span class=\"hljs-keyword\">as</span><br><span class=\"hljs-keyword\">with</span> a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> setting <span class=\"hljs-keyword\">from</span> pg_settings <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span>=<span class=\"hljs-string\">&#x27;wal_keep_segments&#x27;</span>) , b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> setting,unit <span class=\"hljs-keyword\">from</span> pg_settings <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span>=<span class=\"hljs-string\">&#x27;wal_segment_size&#x27;</span>) <span class=\"hljs-keyword\">select</span> pg_size_pretty(a.setting::<span class=\"hljs-type\">int8</span>*b.setting::<span class=\"hljs-type\">int8</span>) <span class=\"hljs-keyword\">from</span> a,b;<br></code></pre></td></tr></table></figure>\n<h1 id=\"长事务、prepared-statement\"><a href=\"#长事务、prepared-statement\" class=\"headerlink\" title=\"长事务、prepared statement\"></a>长事务、prepared statement</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.long_snapshot <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">with</span> a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> min(<span class=\"hljs-keyword\">transaction</span>::<span class=\"hljs-type\">Text</span>::<span class=\"hljs-type\">int8</span>) m <span class=\"hljs-keyword\">from</span> pg_prepared_xacts ),<br>b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> txid_snapshot_xmin(txid_current_snapshot())::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span> <span class=\"hljs-keyword\">as</span> m),<br>c <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> min(least(backend_xid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>,backend_xmin::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>)) m <span class=\"hljs-keyword\">from</span> pg_stat_activity ),<br>d <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> datname,usename,pid,query_start,xact_start,now(),wait_event,query <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span><br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(backend_xid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>,backend_xmin::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>) <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">1</span>),<br>e <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_prepared_xacts <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">transaction</span>::<span class=\"hljs-type\">Text</span>::<span class=\"hljs-type\">int8</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">1</span>)<br><span class=\"hljs-keyword\">select</span> b.m-least(a.m,c.m),d.*,e.* <span class=\"hljs-keyword\">from</span> a,b,c,d <span class=\"hljs-keyword\">left join</span> e <span class=\"hljs-keyword\">on</span> (<span class=\"hljs-number\">1</span>=<span class=\"hljs-number\">1</span>);<br></code></pre></td></tr></table></figure>\n<h1 id=\"重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰\"><a href=\"#重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰\" class=\"headerlink\" title=\"重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)\"></a>重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">select</span> pg_stat_statements_reset();<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化\"><a href=\"#查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化\" class=\"headerlink\" title=\"查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化\"></a>查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.session_acting_cnt <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> count(*) <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> wait_event <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">and</span> (backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span>); <br></code></pre></td></tr></table></figure>\n<h1 id=\"当前活跃会话\"><a href=\"#当前活跃会话\" class=\"headerlink\" title=\"当前活跃会话\"></a>当前活跃会话</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.sessions <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> wait_event <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">and</span> (backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span>);  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查看锁等待\"><a href=\"#查看锁等待\" class=\"headerlink\" title=\"查看锁等待\"></a>查看锁等待</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.locks <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">with</span>      <br>t_wait <span class=\"hljs-keyword\">as</span>      <br>(      <br>  <span class=\"hljs-keyword\">select</span> a.mode,a.locktype,a.<span class=\"hljs-keyword\">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class=\"hljs-keyword\">from</span> pg_locks a,pg_stat_activity b <span class=\"hljs-keyword\">where</span> a.pid=b.pid <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">not</span> a.granted     <br>),     <br>t_run <span class=\"hljs-keyword\">as</span>     <br>(     <br>  <span class=\"hljs-keyword\">select</span> a.mode,a.locktype,a.<span class=\"hljs-keyword\">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class=\"hljs-keyword\">from</span> pg_locks a,pg_stat_activity b <span class=\"hljs-keyword\">where</span> a.pid=b.pid <span class=\"hljs-keyword\">and</span> a.granted     <br>),     <br>t_overlap <span class=\"hljs-keyword\">as</span>     <br>(     <br>  <span class=\"hljs-keyword\">select</span> r.* <span class=\"hljs-keyword\">from</span> t_wait w <span class=\"hljs-keyword\">join</span> t_run r <span class=\"hljs-keyword\">on</span>     <br>  (     <br>    r.locktype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.locktype <span class=\"hljs-keyword\">and</span>     <br>    r.<span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.<span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">and</span>     <br>    r.relation <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.relation <span class=\"hljs-keyword\">and</span>     <br>    r.page <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.page <span class=\"hljs-keyword\">and</span>     <br>    r.tuple <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.tuple <span class=\"hljs-keyword\">and</span>     <br>    r.virtualxid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.virtualxid <span class=\"hljs-keyword\">and</span>     <br>    r.transactionid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.transactionid <span class=\"hljs-keyword\">and</span>     <br>    r.classid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.classid <span class=\"hljs-keyword\">and</span>     <br>    r.objid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.objid <span class=\"hljs-keyword\">and</span>     <br>    r.objsubid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.objsubid <span class=\"hljs-keyword\">and</span>     <br>    r.pid &lt;&gt; w.pid     <br>  )      <br>),      <br>t_unionall <span class=\"hljs-keyword\">as</span>      <br>(      <br>  <span class=\"hljs-keyword\">select</span> r.* <span class=\"hljs-keyword\">from</span> t_overlap r      <br>  <span class=\"hljs-keyword\">union</span> <span class=\"hljs-keyword\">all</span>      <br>  <span class=\"hljs-keyword\">select</span> w.* <span class=\"hljs-keyword\">from</span> t_wait w      <br>)      <br><span class=\"hljs-keyword\">select</span> locktype,datname,relation::<span class=\"hljs-type\">regclass</span>,page,tuple,virtualxid,transactionid::<span class=\"hljs-type\">text</span>,classid::<span class=\"hljs-type\">regclass</span>,objid,objsubid,     <br>string_agg(     <br><span class=\"hljs-string\">&#x27;Pid: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> pid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> pid::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||     <br><span class=\"hljs-string\">&#x27;Lock_Granted: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> granted <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> granted::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Mode: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> mode <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> mode::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , FastPath: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> fastpath <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> fastpath::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , VirtualTransaction: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> virtualtransaction <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> virtualtransaction::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Session_State: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> state <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> state::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||     <br><span class=\"hljs-string\">&#x27;Username: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> usename <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> usename::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Database: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> datname <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> datname::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Client_Addr: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> client_addr <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> client_addr::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Client_Port: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> client_port <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> client_port::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Application_Name: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> application_name <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> application_name::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||      <br><span class=\"hljs-string\">&#x27;Xact_Start: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> xact_start <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> xact_start::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Query_Start: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> query_start <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> query_start::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Xact_Elapse: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> (now()-xact_start) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> (now()-xact_start)::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Query_Elapse: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> (now()-query_start) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> (now()-query_start)::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||      <br><span class=\"hljs-string\">&#x27;SQL (Current SQL in Transaction): &#x27;</span>||chr(<span class=\"hljs-number\">10</span>)||    <br><span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> query <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> query::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>,      <br>chr(<span class=\"hljs-number\">10</span>)||<span class=\"hljs-string\">&#x27;--------&#x27;</span>||chr(<span class=\"hljs-number\">10</span>)      <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>      <br>  (  <span class=\"hljs-keyword\">case</span> mode      <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;INVALID&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">0</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;AccessShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">1</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;RowShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">2</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;RowExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">3</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareUpdateExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">4</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">5</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareRowExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">6</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">7</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;AccessExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">8</span>     <br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-number\">0</span>     <br>  <span class=\"hljs-keyword\">end</span>  ) <span class=\"hljs-keyword\">desc</span>,     <br>  (<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> granted <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">else</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">end</span>)    <br>) <span class=\"hljs-keyword\">as</span> lock_conflict    <br><span class=\"hljs-keyword\">from</span> t_unionall     <br><span class=\"hljs-keyword\">group</span> <span class=\"hljs-keyword\">by</span>     <br>locktype,datname,relation,page,tuple,virtualxid,transactionid::<span class=\"hljs-type\">text</span>,classid,objid,objsubid ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查看索引支持类型\"><a href=\"#查看索引支持类型\" class=\"headerlink\" title=\"查看索引支持类型\"></a>查看索引支持类型</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    am.amname <span class=\"hljs-keyword\">AS</span> index_method,<br>    opc.opcname <span class=\"hljs-keyword\">AS</span> opclass_name,<br>    opc.opcintype::<span class=\"hljs-type\">regtype</span> <span class=\"hljs-keyword\">AS</span> indexed_type,<br>    opc.opcdefault <span class=\"hljs-keyword\">AS</span> is_default<br><span class=\"hljs-keyword\">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class=\"hljs-keyword\">WHERE</span><br>    opc.opcmethod = am.oid<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    index_method,<br>    opclass_name;<br><span class=\"hljs-keyword\">SELECT</span><br>    amname,<br>    opcname,<br>    opcintype::<span class=\"hljs-type\">regtype</span>,<br>    opckeytype::<span class=\"hljs-type\">regtype</span>,<br>    opcdefault<br><span class=\"hljs-keyword\">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class=\"hljs-keyword\">WHERE</span><br>    am.oid = opc.opcmethod<br>    <span class=\"hljs-keyword\">AND</span> amname = <span class=\"hljs-string\">&#x27;gin&#x27;</span>;<br><br><span class=\"hljs-keyword\">SELECT</span><br>    <span class=\"hljs-type\">oid</span>,<br>    oprnegate,<br>    oprname,<br>    oprcode,<br>    oprresult::<span class=\"hljs-type\">regtype</span>,<br>    oprleft::<span class=\"hljs-type\">regtype</span>,<br>    oprright::<span class=\"hljs-type\">regtype</span>,<br>    oprcanmerge<br><span class=\"hljs-keyword\">FROM</span><br>    pg_operator;<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"判断ip是否在某一网段内\"><a href=\"#判断ip是否在某一网段内\" class=\"headerlink\" title=\"判断ip是否在某一网段内\"></a>判断ip是否在某一网段内</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> <span class=\"hljs-built_in\">public</span>.is_same_network (ip1 ip4, ip2 ip4, mask <span class=\"hljs-type\">integer</span>)<br>    <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-type\">boolean</span><br><span class=\"hljs-keyword\">AS</span><br>$$<br><span class=\"pgsql\"><span class=\"hljs-keyword\">DECLARE</span></span><br><span class=\"pgsql\">    is_same_network <span class=\"hljs-type\">boolean</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">BEGIN</span></span><br>    IF mask &gt; 32 OR mask &lt; 0 THEN<br><span class=\"pgsql\">        <span class=\"hljs-keyword\">raise</span></span><br><span class=\"pgsql\">        <span class=\"hljs-keyword\">exception</span> <span class=\"hljs-string\">&#x27;The mask must be between 0 and 32&#x27;</span>;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span>;</span><br> <br><span class=\"pgsql\">    <span class=\"hljs-keyword\">EXECUTE</span> format(<span class=\"hljs-string\">&#x27;select (~($1 # $2))::bigint::bit(32)::bit(%I)::text ~ &#x27;&#x27;^1+$&#x27;&#x27;&#x27;</span>, mask) <span class=\"hljs-keyword\">using</span> ip1, ip2 <span class=\"hljs-keyword\">into</span> is_same_network;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">RETURN</span> is_same_network;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">exception</span></span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">WHEN</span> OTHERS <span class=\"hljs-keyword\">THEN</span></span><br><span class=\"pgsql\">        <span class=\"hljs-keyword\">raise</span> <span class=\"hljs-keyword\">NOTICE</span> <span class=\"hljs-string\">&#x27;%&#x27;</span>, <span class=\"hljs-built_in\">SQLERRM</span>;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">RETURN</span> <span class=\"hljs-keyword\">FALSE</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">END</span>;</span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> plpgsql;<br></code></pre></td></tr></table></figure>\n<h1 id=\"指定字符替换\"><a href=\"#指定字符替换\" class=\"headerlink\" title=\"指定字符替换\"></a>指定字符替换</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">SELECT</span> regexp_replace(<span class=\"hljs-string\">&#x27;foobarbaz&#x27;</span>, <span class=\"hljs-string\">&#x27;b(..)&#x27;</span>, <span class=\"hljs-string\">&#x27;X\\1Y&#x27;</span>, <span class=\"hljs-string\">&#x27;g&#x27;</span>);<br> regexp_replace <br><span class=\"hljs-comment\">----------------</span><br> fooXarYXazY<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"SQL实现圣诞树\"><a href=\"#SQL实现圣诞树\" class=\"headerlink\" title=\"SQL实现圣诞树\"></a>SQL实现圣诞树</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">WITH</span> leaf <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, (id - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span> + <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), id + <span class=\"hljs-number\">20</span>) leaf,<br>         id<br>    <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">AS</span> t(id)),<br>lv <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> id lv <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">5</span>) <span class=\"hljs-keyword\">AS</span> t(id)),<br>leafs <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, ((row_number() <span class=\"hljs-keyword\">over</span>()) ::<span class=\"hljs-type\">INT</span> - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span> + <span class=\"hljs-number\">1</span> + (lv - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), (row_number()<br>                <span class=\"hljs-keyword\">over</span>())<br>               ::<span class=\"hljs-type\">INT</span> + <span class=\"hljs-number\">20</span> + lv) leaf<br>    <span class=\"hljs-keyword\">FROM</span> leaf,<br>         lv),<br>root <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), <span class=\"hljs-number\">24</span>) <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">4</span>) <span class=\"hljs-keyword\">AS</span> t(id))<br><span class=\"hljs-keyword\">SELECT</span> leaf<br>  <span class=\"hljs-keyword\">FROM</span> leafs<br><span class=\"hljs-keyword\">UNION</span> <span class=\"hljs-keyword\">ALL</span><br><span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> root;<br>                   leaf                  <br><span class=\"hljs-comment\">------------------------------------------</span><br>                      *<br>                    *****<br>                  *********<br>                *************<br>              *****************<br>                 ***********<br>               ***************<br>             *******************<br>           ***********************<br>         ***************************<br>            *********************<br>          *************************<br>        *****************************<br>      *********************************<br>    *************************************<br>                    *****<br>                    *****<br>                    *****<br>                    *****<br>(<span class=\"hljs-number\">19</span> <span class=\"hljs-keyword\">rows</span>)<br> <br>mydb=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"生成随机中文\"><a href=\"#生成随机中文\" class=\"headerlink\" title=\"生成随机中文\"></a>生成随机中文</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">replace</span> <span class=\"hljs-keyword\">function</span> gen_hanzi(<span class=\"hljs-built_in\">int</span>) <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-built_in\">text</span> <span class=\"hljs-keyword\">as</span> $$  <br><span class=\"hljs-keyword\">declare</span>  <br>  res <span class=\"hljs-built_in\">text</span>;  <br><span class=\"hljs-keyword\">begin</span>  <br>  <span class=\"hljs-keyword\">if</span> $<span class=\"hljs-number\">1</span> &gt;=<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">then</span>  <br>    <span class=\"hljs-keyword\">select</span> string_agg(<span class=\"hljs-keyword\">chr</span>(<span class=\"hljs-number\">19968</span>+(random()*<span class=\"hljs-number\">20901</span>)::<span class=\"hljs-built_in\">int</span>), <span class=\"hljs-string\">&#x27;&#x27;</span>) <span class=\"hljs-keyword\">into</span> res <span class=\"hljs-keyword\">from</span> generate_series(<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">1</span>);  <br>    return res;  <br>  <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">if</span>;  <br>  return null;  <br><span class=\"hljs-keyword\">end</span>;  <br>$$ language plpgsql strict;<br></code></pre></td></tr></table></figure>\n<h1 id=\"生成随机时间\"><a href=\"#生成随机时间\" class=\"headerlink\" title=\"生成随机时间\"></a>生成随机时间</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">function</span> get_rand_ts() <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-keyword\">as</span> $$  <br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> now()::<span class=\"hljs-type\">timestamp</span>  +  ((<span class=\"hljs-number\">1000</span>*random())::<span class=\"hljs-type\">int</span>::<span class=\"hljs-type\">text</span>||<span class=\"hljs-string\">&#x27; days&#x27;</span>)::<span class=\"hljs-type\">interval</span>;            </span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> <span class=\"hljs-keyword\">sql</span> <span class=\"hljs-keyword\">strict</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"找出index-维护SQL\"><a href=\"#找出index-维护SQL\" class=\"headerlink\" title=\"找出index 维护SQL\"></a>找出index 维护SQL</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">select</span><br>        <span class=\"hljs-keyword\">CASE</span><br>                <span class=\"hljs-keyword\">WHEN</span> flag = <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">THEN</span><br>                        <span class=\"hljs-keyword\">CASE</span><br>                        <span class=\"hljs-keyword\">WHEN</span> indexdef !~ <span class=\"hljs-string\">&#x27; WHERE &#x27;</span> <span class=\"hljs-keyword\">THEN</span><br>                                regexp_replace(indexdef, E<span class=\"hljs-string\">&#x27;(INDEX )(.+)( ON )(.+\\\\)\\$)&#x27;</span>  ,E<span class=\"hljs-string\">&#x27; \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default &#x27;</span>,<span class=\"hljs-string\">&#x27;g&#x27;</span>) ||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>                        <span class=\"hljs-keyword\">ELSE</span><br>                                regexp_replace(indexdef, E<span class=\"hljs-string\">&#x27;(INDEX )(.+)( ON )(.+)( WHERE )&#x27;</span>  ,E<span class=\"hljs-string\">&#x27; \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default \\\\5 &#x27;</span>,<span class=\"hljs-string\">&#x27;g&#x27;</span>) ||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>                        <span class=\"hljs-keyword\">END</span><br>                <span class=\"hljs-keyword\">WHEN</span> flag = <span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">THEN</span><br>                                <span class=\"hljs-string\">&#x27;ANALYZE VERBOSE &#x27;</span>||schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||tablename||<span class=\"hljs-string\">&#x27; ; select pg_sleep(600) ; DROP INDEX CONCURRENTLY IF EXISTS &#x27;</span>||schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>        <span class=\"hljs-keyword\">END</span><br><span class=\"hljs-keyword\">from</span><br>        (<br>        <span class=\"hljs-keyword\">select</span><br>                generate_series(<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> flag,<br>                indexdef,<br>                indexname,<br>                tablename,<br>                pi.schemaname<br>        <span class=\"hljs-keyword\">from</span><br>                pg_indexes <span class=\"hljs-keyword\">pi</span><br>        <span class=\"hljs-keyword\">join</span><br>                pg_namespace n<br>          <span class=\"hljs-keyword\">on</span><br>                pi.schemaname = n.nspname<br>        <span class=\"hljs-keyword\">join</span><br>                pg_class pcl<br>          <span class=\"hljs-keyword\">on</span><br>                pcl.relnamespace = n.oid<br>                <span class=\"hljs-keyword\">and</span> pcl.relname = pi.tablename<br>        <span class=\"hljs-keyword\">left</span> <span class=\"hljs-keyword\">join</span><br>                pg_constraint pco<br>          <span class=\"hljs-keyword\">on</span><br>                pco.conname = pi.indexname<br>                <span class=\"hljs-keyword\">and</span> pco.conrelid = pcl.oid<br>        <span class=\"hljs-keyword\">where</span><br>                (pi.schemaname, pi.tablename) = (<span class=\"hljs-string\">&#x27;mirror&#x27;</span>,<span class=\"hljs-string\">&#x27;b2c_order&#x27;</span>)<br>                <span class=\"hljs-keyword\">and</span> pco.contype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span>  <span class=\"hljs-string\">&#x27;p&#x27;</span><br>                <span class=\"hljs-keyword\">and</span> pco.contype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span>  <span class=\"hljs-string\">&#x27;u&#x27;</span><br>        <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>                pi.schemaname, tablename, indexname, pg_table_size(schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname::<span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">desc</span>, flag <span class=\"hljs-keyword\">asc</span><br>        ) <span class=\"hljs-keyword\">as</span> foo<br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>       schemaname, tablename, indexname, pg_table_size(schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname::<span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">desc</span>, flag <span class=\"hljs-keyword\">asc</span><br>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://github.com/digoal/blog/blob/master/202005/20200509_02.md\">德哥</a></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>记录工作中常用到的PostgreSQL常用SQL， tps, qps 等等.</p>","more":"<h1 id=\"抓去网站天气信息\"><a href=\"#抓去网站天气信息\" class=\"headerlink\" title=\"抓去网站天气信息\"></a>抓去网站天气信息</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">postgres</span>=#   CREATE <span class=\"hljs-keyword\">OR</span> REPLACE FUNCTION get_weather_info(city text)<br> RETURNS jsonb<br> LANGUAGE plpython3u<br>AS <span class=\"hljs-variable\">$function</span>$<br><br>import re<br>import json<br>import requests, bs4<br><br>res = requests.<span class=\"hljs-builtin-name\">get</span>(<span class=\"hljs-string\">&#x27;http://pm25.in/&#123;&#125;&#x27;</span>.format(city))<br>soup = bs4.BeautifulSoup(res.text, <span class=\"hljs-string\">&#x27;html.parser&#x27;</span>)<br><br><span class=\"hljs-comment\">#script = soup.findAll(&#x27;script&#x27;, text=re.compile(&quot;highcharts&quot;))</span><br><span class=\"hljs-comment\">#categorie = re.findall(&quot;categories: (.*),&quot;,script[0].string)[0]</span><br><span class=\"hljs-comment\">#data = re.findall(&quot;data: (.*),&quot;,script[0].string)[0]</span><br><span class=\"hljs-comment\">#info = dict(zip(json.loads(categorie), json.loads(data)))</span><br><br>table = soup.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;table&#x27;</span>, attrs=&#123;<span class=\"hljs-string\">&quot;id&quot;</span>: <span class=\"hljs-string\">&quot;detail-data&quot;</span>&#125;)<br><span class=\"hljs-builtin-name\">info</span> = &#123;<br>    <span class=\"hljs-string\">&quot;thead&quot;</span>: [ th.get_text() <span class=\"hljs-keyword\">for</span> th <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;thead&#x27;</span>).<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tr&#x27;</span>).select(<span class=\"hljs-string\">&#x27;th&#x27;</span>) ],<br>    <span class=\"hljs-string\">&quot;tbody&quot;</span>: []<br>&#125;<br>theads = [ th.get_text() <span class=\"hljs-keyword\">for</span> th <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;thead&#x27;</span>).<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tr&#x27;</span>).select(<span class=\"hljs-string\">&#x27;th&#x27;</span>) ]<br><span class=\"hljs-keyword\">for</span> tr <span class=\"hljs-keyword\">in</span> table.<span class=\"hljs-builtin-name\">find</span>(<span class=\"hljs-string\">&#x27;tbody&#x27;</span>).findAll(<span class=\"hljs-string\">&#x27;tr&#x27;</span>):<br>    tbodys = [ td.get_text() <span class=\"hljs-keyword\">for</span> td <span class=\"hljs-keyword\">in</span> tr.select(<span class=\"hljs-string\">&#x27;td&#x27;</span>) ]<br>    <span class=\"hljs-builtin-name\">info</span>[<span class=\"hljs-string\">&#x27;tbody&#x27;</span>].append(tbodys)<br><br>return json.dumps(info, <span class=\"hljs-attribute\">ensure_ascii</span>=<span class=\"hljs-literal\">False</span>)<br><br><span class=\"hljs-variable\">$function</span>$;<br>CREATE FUNCTION<br><span class=\"hljs-attribute\">postgres</span>=# select get_weather_info(<span class=\"hljs-string\">&#x27;putian&#x27;</span>);<br><br>                                                                          f1<br><br>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------------------------<br> &#123;<span class=\"hljs-string\">&quot;tbody&quot;</span>: [[<span class=\"hljs-string\">&quot;荔城区仓后路&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;20&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;15&quot;</span>, <span class=\"hljs-string\">&quot;122&quot;</span>, <span class=\"hljs-string\">&quot;90&quot;</span>, <span class=\"hljs-string\">&quot;5&quot;</span>], [<span class=\"hljs-string\">&quot;莆田市监测站&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;20&quot;</span>, <span class=\"hljs-string\">&quot;39&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;14&quot;</span>, <span class=\"hljs-string\">&quot;126&quot;</span>, <span class=\"hljs-string\">&quot;98&quot;</span>, <span class=\"hljs-string\">&quot;4&quot;</span>], [<span class=\"hljs-string\">&quot;涵江区六中&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;0.6&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;138&quot;</span>, <span class=\"hljs-string\">&quot;88&quot;</span>, <span class=\"hljs-string\">&quot;7&quot;</span>], [<span class=\"hljs-string\">&quot;秀屿区政府&quot;</span>, <span class=\"hljs-string\">&quot;51&quot;</span>,<br> <span class=\"hljs-string\">&quot;良&quot;</span>, <span class=\"hljs-string\">&quot;颗粒物(PM10)&quot;</span>, <span class=\"hljs-string\">&quot;18&quot;</span>, <span class=\"hljs-string\">&quot;52&quot;</span>, <span class=\"hljs-string\">&quot;0.6&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;128&quot;</span>, <span class=\"hljs-string\">&quot;83&quot;</span>, <span class=\"hljs-string\">&quot;5&quot;</span>], [<span class=\"hljs-string\">&quot;东圳水库&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;10&quot;</span>, <span class=\"hljs-string\">&quot;58&quot;</span>, <span class=\"hljs-string\">&quot;58&quot;</span>, <span class=\"hljs-string\">&quot;4&quot;</span>], [<span class=\"hljs-string\">&quot;东圳水库(对照点)&quot;</span>, <span class=\"hljs-string\">&quot;36&quot;</span>, <span class=\"hljs-string\">&quot;优&quot;</span>, <span class=\"hljs-string\">&quot;_&quot;</span>, <span class=\"hljs-string\">&quot;19&quot;</span>, <span class=\"hljs-string\">&quot;34&quot;</span>, <span class=\"hljs-string\">&quot;0.5&quot;</span>, <span class=\"hljs-string\">&quot;13&quot;</span>, <span class=\"hljs-string\">&quot;114&quot;</span>, <span class=\"hljs-string\">&quot;81&quot;</span>, <span class=\"hljs-string\">&quot;3&quot;</span>]], <span class=\"hljs-string\">&quot;thead&quot;</span>: [<span class=\"hljs-string\">&quot;监测点&quot;</span>, <span class=\"hljs-string\">&quot;AQI&quot;</span>, <span class=\"hljs-string\">&quot;空</span><br><span class=\"hljs-string\">质量指数类别&quot;</span>, <span class=\"hljs-string\">&quot;首要污染物&quot;</span>, <span class=\"hljs-string\">&quot;PM2.5细颗粒物&quot;</span>, <span class=\"hljs-string\">&quot;PM10可吸入颗粒物&quot;</span>, <span class=\"hljs-string\">&quot;CO一氧化碳&quot;</span>, <span class=\"hljs-string\">&quot;NO2二氧化氮&quot;</span>, <span class=\"hljs-string\">&quot;O3臭氧1小时平均&quot;</span>, <span class=\"hljs-string\">&quot;O3臭氧8小时平均&quot;</span>, <span class=\"hljs-string\">&quot;SO2二氧化硫&quot;</span>]&#125;<br>(1 row)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"plpgsql函数获取Server磁盘空间信息\"><a href=\"#plpgsql函数获取Server磁盘空间信息\" class=\"headerlink\" title=\"plpgsql函数获取Server磁盘空间信息\"></a>plpgsql函数获取Server磁盘空间信息</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR</span> <span class=\"hljs-keyword\">REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> public.get_disk_size()<br> <span class=\"hljs-keyword\">RETURNS</span> jsonb<br> <span class=\"hljs-keyword\">LANGUAGE</span> plpgsql<br><span class=\"hljs-keyword\">AS</span> $<span class=\"hljs-keyword\">function</span>$<br><span class=\"hljs-keyword\">declare</span><br>    sqlstring <span class=\"hljs-built_in\">text</span>;<br>    tablename text;<br>    result jsonb;<br><span class=\"hljs-keyword\">begin</span><br>    <span class=\"hljs-comment\">-- uuid_generate_v4() in pg12-， gen_random_uuid() in pg13+</span><br>    tablename = quote_ident( <span class=\"hljs-string\">&#x27;get_disk_size_&#x27;</span> ||  uuid_generate_v4()::<span class=\"hljs-built_in\">text</span>);<br>    sqlstring = format(&#x27;<span class=\"hljs-keyword\">create</span> temp <span class=\"hljs-keyword\">table</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">exists</span> %s(Filesystem <span class=\"hljs-built_in\">text</span>, <span class=\"hljs-keyword\">type</span> <span class=\"hljs-built_in\">text</span>, <span class=\"hljs-keyword\">Size</span> <span class=\"hljs-built_in\">int</span>, Used <span class=\"hljs-built_in\">int</span>, Avail <span class=\"hljs-built_in\">int</span>, <span class=\"hljs-string\">&quot;useper&quot;</span> <span class=\"hljs-built_in\">numeric</span>, <span class=\"hljs-string\">&quot;mounted on&quot;</span> <span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">ON</span> <span class=\"hljs-keyword\">COMMIT</span> <span class=\"hljs-keyword\">DROP</span><span class=\"hljs-string\">&#x27;, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring;</span><br><span class=\"hljs-string\">    --LC_ALL=C ignore OS language environment</span><br><span class=\"hljs-string\">    sqlstring = format(&#x27;</span>copy %s <span class=\"hljs-keyword\">from</span> program <span class=\"hljs-string\">&#x27;&#x27;</span>LC_ALL=C /<span class=\"hljs-keyword\">bin</span>/df -Tm | /<span class=\"hljs-keyword\">bin</span>/grep -v <span class=\"hljs-string\">&quot;Mounted&quot;</span> | /<span class=\"hljs-keyword\">bin</span>/sed <span class=\"hljs-string\">&quot;s/\\s\\+/|/g&quot;</span> | /<span class=\"hljs-keyword\">bin</span>/sed <span class=\"hljs-string\">&quot;s/%%//g&quot;</span><span class=\"hljs-string\">&#x27;&#x27;</span> <span class=\"hljs-keyword\">with</span> delimiter <span class=\"hljs-string\">&#x27;&#x27;</span>|<span class=\"hljs-string\">&#x27;&#x27;&#x27;, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring;</span><br><span class=\"hljs-string\">    sqlstring = format(&#x27;</span><span class=\"hljs-keyword\">select</span> json_agg(row_to_json(%s.*)) <span class=\"hljs-keyword\">from</span> %s<span class=\"hljs-string\">&#x27;, tablename, tablename);</span><br><span class=\"hljs-string\">    execute sqlstring into result;</span><br><span class=\"hljs-string\">    return result;</span><br><span class=\"hljs-string\">end;</span><br><span class=\"hljs-string\">$function$;</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"python函数获取Server磁盘空间信息\"><a href=\"#python函数获取Server磁盘空间信息\" class=\"headerlink\" title=\"python函数获取Server磁盘空间信息\"></a>python函数获取Server磁盘空间信息</h1><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\">create or replace <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">get_disk_size</span>(<span class=\"hljs-params\"></span>)</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">returns</span> <span class=\"hljs-title\">jsonb</span> <span class=\"hljs-title\">as</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">$$</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">import</span> <span class=\"hljs-title\">psutil</span> <span class=\"hljs-title\">as</span> <span class=\"hljs-title\">ps</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">import</span> <span class=\"hljs-title\">json</span></span><br><span class=\"hljs-function\"></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">return</span> <span class=\"hljs-title\">json</span>.<span class=\"hljs-title\">dumps</span>(<span class=\"hljs-params\">[&#123;</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;mounted on&quot;</span>: part.mountpoint,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;filesystem&quot;</span>: part.device,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;size&quot;</span>: round(ps.disk_usage(part.mountpoint).total <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;avail&quot;</span>: round(ps.disk_usage(part.mountpoint).free <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;used&quot;</span>: round(ps.disk_usage(part.mountpoint).used <span class=\"hljs-regexp\">/ 1024 /</span> <span class=\"hljs-number\">1024</span>, <span class=\"hljs-number\">2</span>),</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;use%&quot;</span>: ps.disk_usage(part.mountpoint).percent,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;type&quot;</span>: part.fstype,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    <span class=\"hljs-string\">&quot;opts&quot;</span>: part.opts&#125;</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">    for part in ps.disk_partitions()]</span>)</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">$$LANGUAGE</span> <span class=\"hljs-title\">plpython3u</span>;</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"主库查询主从延迟\"><a href=\"#主库查询主从延迟\" class=\"headerlink\" title=\"主库查询主从延迟\"></a>主库查询主从延迟</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span> pg_stat_replication.application_name,<br>   pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), pg_stat_replication.replay_lsn)) <span class=\"hljs-keyword\">AS</span> diff<br>  <span class=\"hljs-keyword\">FROM</span> pg_stat_replication;<br></code></pre></td></tr></table></figure>\n<h1 id=\"从库查询主从延迟\"><a href=\"#从库查询主从延迟\" class=\"headerlink\" title=\"从库查询主从延迟\"></a>从库查询主从延迟</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    <span class=\"hljs-keyword\">CASE</span><br>        <span class=\"hljs-keyword\">WHEN</span> pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span>::<span class=\"hljs-type\">double</span> <span class=\"hljs-type\">precision</span><br>        <span class=\"hljs-keyword\">ELSE</span> date_part(<span class=\"hljs-string\">&#x27;epoch&#x27;</span>::<span class=\"hljs-type\">text</span>, now() - pg_last_xact_replay_timestamp())<br>    <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> log_delay;<br></code></pre></td></tr></table></figure>\n<h1 id=\"按query分组查询活跃SQL数量\"><a href=\"#按query分组查询活跃SQL数量\" class=\"headerlink\" title=\"按query分组查询活跃SQL数量\"></a>按query分组查询活跃SQL数量</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span> pg_stat_activity.query,<br>   count(<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> count<br>  <span class=\"hljs-keyword\">FROM</span> pg_stat_activity<br> <span class=\"hljs-keyword\">WHERE</span> pg_stat_activity.state &lt;&gt; <span class=\"hljs-string\">&#x27;idle&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AND</span> pg_stat_activity.pid &lt;&gt; pg_backend_pid() <span class=\"hljs-keyword\">AND</span> pg_stat_activity.query &lt;&gt; <span class=\"hljs-string\">&#x27;&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AND</span> pg_stat_activity.query !~ <span class=\"hljs-string\">&#x27;^DISCARD|^SET extra_float_digits = 3&#x27;</span>::<span class=\"hljs-type\">text</span><br> <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> pg_stat_activity.query<br><span class=\"hljs-keyword\">HAVING</span> count(<span class=\"hljs-number\">1</span>) &gt; <span class=\"hljs-number\">1</span><br> <span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> (count(<span class=\"hljs-number\">1</span>)) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询锁\"><a href=\"#查询锁\" class=\"headerlink\" title=\"查询锁\"></a>查询锁</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">select</span><br>      wait.pid,<br>      wait.state,<br>      wait.datname,<br>      (<span class=\"hljs-keyword\">select</span> string_agg(<span class=\"hljs-keyword\">distinct</span> transactionid::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;,&#x27;</span>) <span class=\"hljs-keyword\">from</span> pg_locks <span class=\"hljs-keyword\">where</span> pid = wait.pid <span class=\"hljs-keyword\">and</span> locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span> <span class=\"hljs-keyword\">and</span> transactionid::<span class=\"hljs-type\">text</span> &lt;&gt; wait.transactionid::<span class=\"hljs-type\">text</span>),<br>      wait.virtualxid,<br>      wait.locktype,<br>      wait.usename,<br>      wait.application_name,<br>      wait.client_addr,<br>      wait.wait_event_type,<br>      wait.wait_event,<br>      wait.query_start,<br>      wait.query,<br><br>      wait.relation,<br>      wait.datname || <span class=\"hljs-string\">&#x27;.&#x27;</span> || d.nspname || <span class=\"hljs-string\">&#x27;.&#x27;</span> || c.relname <span class=\"hljs-keyword\">as</span> relname,<br>      granted.relation,<br><br>      granted.pid              <span class=\"hljs-keyword\">as</span> waitfor_pid,<br>      granted.state            <span class=\"hljs-keyword\">as</span> waitfor_state,<br>      granted.transactionid    <span class=\"hljs-keyword\">as</span> waitfor_transactionid,<br>      granted.virtualxid       <span class=\"hljs-keyword\">as</span> waitfor_virtualxid,<br>      granted.locktype         <span class=\"hljs-keyword\">as</span> waitfor_locktype,<br>      granted.usename          <span class=\"hljs-keyword\">as</span> waitfor_usename,<br>      granted.client_addr      <span class=\"hljs-keyword\">as</span> waitfor_client_addr,<br>      granted.application_name <span class=\"hljs-keyword\">as</span> waitfor_application_name,<br>      granted.wait_event_type  <span class=\"hljs-keyword\">as</span> waitfor_wait_event_type,<br>      granted.wait_event       <span class=\"hljs-keyword\">as</span> waitfor_wait_event,<br>      granted.query_start      <span class=\"hljs-keyword\">as</span> waitfor_query_start,<br>      granted.query            <span class=\"hljs-keyword\">as</span> waitfor_query,<br>      now() - granted.query_start  <span class=\"hljs-keyword\">as</span> waitfor_time<br><br><span class=\"hljs-keyword\">from</span><br>    (<span class=\"hljs-keyword\">select</span><br>          a.pid,<br>          a.state,<br>          b.transactionid,<br>          b.virtualxid,<br>          b.locktype,<br>          b.relation,<br>          b.page,<br>          b.tuple,<br>          a.usename,<br>          a.datname,<br>          a.application_name,<br>          a.client_addr,<br>          a.wait_event_type,<br>          a.wait_event,<br>          a.query_start,<br>          a.query<br>     <span class=\"hljs-keyword\">from</span><br>          pg_stat_activity a,<br>          pg_locks b<br>     <span class=\"hljs-keyword\">where</span><br>          a.wait_event_type <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span><br>          <span class=\"hljs-keyword\">and</span> a.pid = b.pid<br>          <span class=\"hljs-keyword\">and</span> granted = <span class=\"hljs-string\">&#x27;f&#x27;</span><br>    ) wait<br><span class=\"hljs-keyword\">join</span><br>    (<span class=\"hljs-keyword\">select</span><br>          b.pid,<br>          b.state,<br>          a.transactionid,<br>          a.virtualxid,<br>          a.locktype,<br>          a.relation,<br>          a.page,<br>          a.tuple,<br>          b.usename,<br>          b.datname,<br>          b.application_name,<br>          b.client_addr,<br>          b.wait_event_type,<br>          b.wait_event,<br>          b.query_start,<br>          b.query<br>    <span class=\"hljs-keyword\">from</span><br>        pg_locks a,<br>        pg_stat_activity b<br>    <span class=\"hljs-keyword\">where</span><br>        a.pid = b.pid<br>        <span class=\"hljs-keyword\">and</span> a.granted = <span class=\"hljs-string\">&#x27;t&#x27;</span><br>    ) granted<br><span class=\"hljs-keyword\">on</span> (<br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;transactionid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.transactionid = granted.transactionid )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;relation&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;relation&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.relation = granted.relation<br>    )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;virtualxid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;virtualxid&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.virtualxid = granted.virtualxid )<br>    <span class=\"hljs-keyword\">or</span><br>    ( wait.locktype = <span class=\"hljs-string\">&#x27;tuple&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> granted.locktype = <span class=\"hljs-string\">&#x27;tuple&#x27;</span><br>    <span class=\"hljs-keyword\">and</span> wait.relation = granted.relation<br>    <span class=\"hljs-keyword\">and</span> wait.page = granted.page<br>    <span class=\"hljs-keyword\">and</span> wait.tuple = granted.tuple )<br>)<br><span class=\"hljs-keyword\">left join</span><br>    pg_class c<br><span class=\"hljs-keyword\">on</span> ( c.relfilenode = wait.relation )<br><span class=\"hljs-keyword\">left join</span><br>    pg_namespace d<br><span class=\"hljs-keyword\">on</span> ( c.relnamespace = d.oid )<br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>    granted.query_start<br>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询表大小-按占用大小排序\"><a href=\"#查询表大小-按占用大小排序\" class=\"headerlink\" title=\"查询表大小, 按占用大小排序\"></a>查询表大小, 按占用大小排序</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    t.spcname,<br>    (n.nspname::<span class=\"hljs-type\">text</span> || <span class=\"hljs-string\">&#x27;.&#x27;</span>::<span class=\"hljs-type\">text</span>) || c.relname::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">AS</span> relation,<br>    pg_size_pretty(pg_total_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> total_table_size,<br>    pg_size_pretty(pg_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> table_only_size,<br>    pg_size_pretty(pg_indexes_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">AS</span> total_index_size<br><span class=\"hljs-keyword\">FROM</span><br>    pg_class c<br>    <span class=\"hljs-keyword\">LEFT JOIN</span> pg_tablespace t <span class=\"hljs-keyword\">ON</span> c.reltablespace = t.oid<br>    <span class=\"hljs-keyword\">LEFT JOIN</span> pg_namespace n <span class=\"hljs-keyword\">ON</span> n.oid = c.relnamespace<br><span class=\"hljs-keyword\">WHERE</span> (n.nspname &lt;&gt; <span class=\"hljs-keyword\">ALL</span> (<span class=\"hljs-keyword\">ARRAY</span>[<span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>::<span class=\"hljs-type\">name</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>::<span class=\"hljs-type\">name</span>, <span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>::<span class=\"hljs-type\">name</span>]))<br>    <span class=\"hljs-keyword\">AND</span> c.relkind = <span class=\"hljs-string\">&#x27;r&#x27;</span>::&quot;char&quot;<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    (pg_total_relation_size(c.oid::<span class=\"hljs-type\">regclass</span>)) <span class=\"hljs-keyword\">DESC</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"找出重复的index\"><a href=\"#找出重复的index\" class=\"headerlink\" title=\"找出重复的index\"></a>找出重复的index</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    relname,<br>    (array_agg(idx))[<span class=\"hljs-number\">1</span>] idx1,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">1</span>]) idx1_def,<br>    (array_agg(idx))[<span class=\"hljs-number\">2</span>] idx2,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">2</span>]) idx2_def,<br>    (array_agg(idx))[<span class=\"hljs-number\">3</span>] idx3,<br>    pg_get_indexdef((array_agg(idx))[<span class=\"hljs-number\">3</span>]) idx3_def<br><span class=\"hljs-keyword\">FROM</span> (<br>    <span class=\"hljs-keyword\">SELECT</span><br>        indrelid::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">AS</span> relname,<br>        indexrelid::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">AS</span> idx,<br>        (indrelid::<span class=\"hljs-type\">text</span> || indclass::<span class=\"hljs-type\">text</span> || indkey::<span class=\"hljs-type\">text</span> || COALESCE(indexprs::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;&#x27;</span>) || COALESCE(indpred::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;&#x27;</span>)) <span class=\"hljs-keyword\">AS</span> KEY<br>    <span class=\"hljs-keyword\">FROM</span><br>        pg_index) sub<br><span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span><br>    relname,<br>    KEY<br><span class=\"hljs-keyword\">HAVING</span><br>    count(*) &gt; <span class=\"hljs-number\">1</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"自定义操作符兼容Oracle-varchar-int\"><a href=\"#自定义操作符兼容Oracle-varchar-int\" class=\"headerlink\" title=\"自定义操作符兼容Oracle varchar = int\"></a>自定义操作符兼容Oracle varchar = int</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create table test(<span class=\"hljs-builtin-name\">info</span> varchar);<br>CREATE TABLE<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;1&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;2&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# insert into test select <span class=\"hljs-string\">&#x27;3&#x27;</span>;<br>INSERT 0 1<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test;<br> info<br>------<br> 1<br> 2<br> 3<br>(3 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br>ERROR:  operator does <span class=\"hljs-keyword\">not</span> exist: character varying = integer<br>LINE 1: select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br>                                      ^<br>HINT:  <span class=\"hljs-literal\">No</span> operator matches the given name <span class=\"hljs-keyword\">and</span> argument types. You might need <span class=\"hljs-keyword\">to</span> <span class=\"hljs-builtin-name\">add</span> explicit<span class=\"hljs-built_in\"> type </span>casts.<br><span class=\"hljs-attribute\">mydb</span>=# CREATE <span class=\"hljs-keyword\">OR</span> REPLACE FUNCTION equal(character varying, integer) RETURNS boolean AS <span class=\"hljs-variable\">$function</span>$ select cast(<span class=\"hljs-variable\">$1</span> as text) = cast(<span class=\"hljs-variable\">$2</span> as text) <span class=\"hljs-variable\">$function</span>$ LANGUAGE sql;<br>CREATE FUNCTION<br><span class=\"hljs-attribute\">mydb</span>=# create operator = (leftarg = varchar, rightarg = int, procedure = equal, commutator = =);<br>CREATE OPERATOR<br><span class=\"hljs-attribute\">mydb</span>=# select * <span class=\"hljs-keyword\">from</span> test where <span class=\"hljs-builtin-name\">info</span> = 1;<br> info<br>------<br> 1<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"兼容instr\"><a href=\"#兼容instr\" class=\"headerlink\" title=\"兼容instr\"></a>兼容instr</h1><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs perl\">mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, 2, 2);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">4</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, 3, 2);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">4</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, -1, 1);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">9</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># select instr(&#x27;helloworld&#x27;, &#x27;l&#x27;, -2, 1);</span><br> instr<br>-------<br>     <span class=\"hljs-number\">9</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>mydb=<span class=\"hljs-comment\"># \\sf instr</span><br>CREATE OR REPLACE FUNCTION public.instr(str text, <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span> <span class=\"hljs-title\">text</span>, <span class=\"hljs-title\">startpos</span> <span class=\"hljs-title\">integer</span> <span class=\"hljs-title\">DEFAULT</span> 1, <span class=\"hljs-title\">occurrence</span> <span class=\"hljs-title\">integer</span> <span class=\"hljs-title\">DEFAULT</span> 1)</span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">RETURNS</span> <span class=\"hljs-title\">integer</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">function</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">    <span class=\"hljs-title\">tail</span> <span class=\"hljs-title\">text</span></span>;<br>    <span class=\"hljs-keyword\">shift</span> <span class=\"hljs-keyword\">int</span>;<br>    <span class=\"hljs-keyword\">pos</span> <span class=\"hljs-keyword\">int</span>;<br>    i <span class=\"hljs-keyword\">int</span>;<br>begin<br>    <span class=\"hljs-keyword\">shift</span>:= <span class=\"hljs-number\">0</span>;<br>    <span class=\"hljs-keyword\">if</span> startpos = <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">or</span> occurrence &lt;= <span class=\"hljs-number\">0</span> then<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>    end <span class=\"hljs-keyword\">if</span>;<br>    <span class=\"hljs-keyword\">if</span> startpos &lt; <span class=\"hljs-number\">0</span> then<br>        str:= <span class=\"hljs-keyword\">reverse</span>(str);<br>        <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>:= <span class=\"hljs-title\">reverse</span></span>(<span class=\"hljs-keyword\">sub</span>);<br>        <span class=\"hljs-keyword\">pos</span>:= -startpos;<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-keyword\">pos</span>:= startpos;<br>    end <span class=\"hljs-keyword\">if</span>;<br>    <span class=\"hljs-keyword\">for</span> i in <span class=\"hljs-number\">1</span>..occurrence loop<br>        <span class=\"hljs-keyword\">shift</span>:= <span class=\"hljs-keyword\">shift</span>+ <span class=\"hljs-keyword\">pos</span>;<br>        tail:= <span class=\"hljs-keyword\">substr</span>(str, <span class=\"hljs-keyword\">shift</span>);<br>        <span class=\"hljs-keyword\">pos</span>:= strpos(tail, <span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>)</span>;<br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">pos</span> = <span class=\"hljs-number\">0</span> then<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;<br>        end <span class=\"hljs-keyword\">if</span>;<br>    end loop;<br>    <span class=\"hljs-keyword\">if</span> startpos &gt; <span class=\"hljs-number\">0</span> then<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">pos</span>+ <span class=\"hljs-keyword\">shift</span>- <span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-keyword\">else</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">length</span>(str)- <span class=\"hljs-keyword\">length</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">sub</span>)- <span class=\"hljs-title\">pos</span>- <span class=\"hljs-title\">shift</span>+ 3</span>;<br>    end <span class=\"hljs-keyword\">if</span>;<br>end $function$<br>mydb=<span class=\"hljs-comment\">#</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"procedure-异常处理\"><a href=\"#procedure-异常处理\" class=\"headerlink\" title=\"procedure 异常处理\"></a>procedure 异常处理</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">mydb=# CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">f1</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">my_ex_state</span> <span class=\"hljs-title\">text</span>;</span><br>  my_ex_message text;<br>  my_ex_detail text;<br>  my_ex_hint text;<br>  my_ex_ctx text;<br><span class=\"hljs-keyword\">begin</span><br>  <span class=\"hljs-keyword\">begin</span><br>    raise notice <span class=\"hljs-string\">&#x27;A&#x27;</span>;<br>  exception when others <span class=\"hljs-keyword\">then</span><br>    raise notice <span class=\"hljs-string\">&#x27;C&#x27;</span>;<br>    GET STACKED DIAGNOSTICS<br>      my_ex_state   = RETURNED_SQLSTATE,<br>      my_ex_message = MESSAGE_TEXT,<br>      my_ex_detail  = PG_EXCEPTION_DETAIL,<br>      my_ex_hint    = PG_EXCEPTION_HINT,<br>      my_ex_ctx     = PG_EXCEPTION_CONTEXT<br>    ;<br>    raise notice <span class=\"hljs-string\">&#x27;% % % % %&#x27;</span>, my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;<br>  <span class=\"hljs-keyword\">end</span>;<br><br>  commit;<br><br>  <span class=\"hljs-keyword\">begin</span><br>    raise notice <span class=\"hljs-string\">&#x27;B&#x27;</span>;<br>  exception when others <span class=\"hljs-keyword\">then</span><br>    raise notice <span class=\"hljs-string\">&#x27;C&#x27;</span>;<br>    GET STACKED DIAGNOSTICS<br>      my_ex_state   = RETURNED_SQLSTATE,<br>      my_ex_message = MESSAGE_TEXT,<br>      my_ex_detail  = PG_EXCEPTION_DETAIL,<br>      my_ex_hint    = PG_EXCEPTION_HINT,<br>      my_ex_ctx     = PG_EXCEPTION_CONTEXT<br>    ;<br>    raise notice <span class=\"hljs-string\">&#x27;% % % % %&#x27;</span>, my_ex_state, my_ex_message, my_ex_detail, my_ex_hint, my_ex_ctx;<br>  <span class=\"hljs-keyword\">end</span>;<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$</span><br><span class=\"hljs-function\">;</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"找下一个周末\"><a href=\"#找下一个周末\" class=\"headerlink\" title=\"找下一个周末\"></a>找下一个周末</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-22&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-21&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select next_day(<span class=\"hljs-string\">&#x27;2020-12-20&#x27;</span>::date, <span class=\"hljs-number\">7</span>);<br>  next_day<br>------------<br> <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-12</span><span class=\"hljs-number\">-26</span><br>(<span class=\"hljs-number\">1</span> row)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL只迁移FUNCTION\"><a href=\"#PostgreSQL只迁移FUNCTION\" class=\"headerlink\" title=\"PostgreSQL只迁移FUNCTION\"></a>PostgreSQL只迁移FUNCTION</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">pg_dump -h localhost -U jintao -Fc -s -f db_dump mydb<br>more db_dump<br>pg_restore -l db_dump | grep <span class=\"hljs-keyword\">FUNCTION</span> &gt; function_list<br>cat function_list<br>pg_restore -h localhost -U postgres -d postgres -L function_list db_dump<br></code></pre></td></tr></table></figure>\n<h1 id=\"pageinspect-查看xmax的状态\"><a href=\"#pageinspect-查看xmax的状态\" class=\"headerlink\" title=\"pageinspect 查看xmax的状态\"></a>pageinspect 查看xmax的状态</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">SELECT</span> lp,<br>       t_ctid <span class=\"hljs-keyword\">AS</span> ctid,<br>       t_xmin <span class=\"hljs-keyword\">AS</span> xmin,<br>       t_xmax <span class=\"hljs-keyword\">AS</span> xmax,<br>       (t_infomask &amp; <span class=\"hljs-number\">128</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_is_lock,<br>       (t_infomask &amp; <span class=\"hljs-number\">1024</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_committed,<br>       (t_infomask &amp; <span class=\"hljs-number\">2048</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_rolled_back,<br>       (t_infomask &amp; <span class=\"hljs-number\">4096</span>)::<span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-keyword\">AS</span> xmax_multixact,<br>       t_attrs[<span class=\"hljs-number\">1</span>] <span class=\"hljs-keyword\">AS</span> p_id,<br>       t_attrs[<span class=\"hljs-number\">2</span>] <span class=\"hljs-keyword\">AS</span> p_val<br><span class=\"hljs-keyword\">FROM</span> heap_page_item_attrs(<br>        get_raw_page(<span class=\"hljs-string\">&#x27;parent&#x27;</span>, <span class=\"hljs-number\">0</span>),<br>        <span class=\"hljs-string\">&#x27;parent&#x27;</span><br>     );<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL9-1主从延迟查询\"><a href=\"#PostgreSQL9-1主从延迟查询\" class=\"headerlink\" title=\"PostgreSQL9.1主从延迟查询\"></a>PostgreSQL9.1主从延迟查询</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">postgres=<span class=\"hljs-comment\"># \\sf pg_xlog_location_diff</span><br>CREATE OR REPLACE FUNCTION pg_catalog.pg_xlog_location_diff(text, text)<br> RETURNS numeric<br> LANGUAGE plpgsql<br>AS <span class=\"hljs-variable\">$function</span>$<br>    DECLARE<br>       offset1 text;<br>       offset2 text;<br>       xlog1 text;<br>       xlog2 text;<br>       SQL text;<br>       diff text;<br>    <span class=\"hljs-keyword\">BEGIN</span><br>       /* Extract the Offset and xlog from input <span class=\"hljs-keyword\">in</span><br>          offset and xlog variables */<br><br>       offset1=split_part(<span class=\"hljs-variable\">$1</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">2</span>);<br>         xlog1=split_part(<span class=\"hljs-variable\">$1</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">1</span>);<br>       offset2=split_part(<span class=\"hljs-variable\">$2</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">2</span>);<br>         xlog2=split_part(<span class=\"hljs-variable\">$2</span>,<span class=\"hljs-string\">&#x27;/&#x27;</span>,<span class=\"hljs-number\">1</span>);<br><br>       /* Prepare SQL query <span class=\"hljs-keyword\">for</span> calculation based on following formula<br>         (FF000000 * xlog + offset) - (FF000000 * xlog + offset)<br>         which gives value <span class=\"hljs-keyword\">in</span> hexadecimal. Since, hexadecimal calculation is cumbersome<br>         so convert into decimal and then calculate the difference */<br><br>       SQL=<span class=\"hljs-string\">&#x27;SELECT (x&#x27;</span><span class=\"hljs-string\">&#x27;&#x27;</span>||<span class=\"hljs-string\">&#x27;FF000000&#x27;</span>||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint * x&#x27;&#x27;&#x27;</span>||xlog1||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint</span><br><span class=\"hljs-string\">                                +  x&#x27;&#x27;&#x27;</span>||offset1||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint)&#x27;||&#x27;</span><br><span class=\"hljs-string\">                -</span><br><span class=\"hljs-string\">                   (x&#x27;&#x27;&#x27;</span>||<span class=\"hljs-string\">&#x27;FF000000&#x27;</span>||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint * x&#x27;&#x27;&#x27;</span>||xlog2||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint</span><br><span class=\"hljs-string\">                                +  x&#x27;&#x27;&#x27;</span>||offset2||<span class=\"hljs-string\">&#x27;&#x27;&#x27;::bigint)&#x27;;</span><br><span class=\"hljs-string\">       EXECUTE SQL into diff;</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">       /* Return the value in numeric by explicit casting  */</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">       RETURN diff::numeric;</span><br><span class=\"hljs-string\">    END;</span><br><span class=\"hljs-string\"> $function$</span><br><span class=\"hljs-string\">postgres=# SELECT</span><br><span class=\"hljs-string\">    application_name,</span><br><span class=\"hljs-string\">    pg_xlog_location_diff(pg_current_xlog_location(), replay_location) as diff</span><br><span class=\"hljs-string\">FROM</span><br><span class=\"hljs-string\">    pg_stat_replication</span><br><span class=\"hljs-string\">;</span><br><span class=\"hljs-string\"> application_name | diff</span><br><span class=\"hljs-string\">------------------+-------</span><br><span class=\"hljs-string\"> walreceiver      | 18272</span><br><span class=\"hljs-string\">(1 row)</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取cluster初始化的时间\"><a href=\"#获取cluster初始化的时间\" class=\"headerlink\" title=\"获取cluster初始化的时间\"></a>获取cluster初始化的时间</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">$ pg_controldata |grep -i system<br>Database<span class=\"hljs-built_in\"> system </span>identifier:           6888133981158752630<br>$ psql<br>psql (14devel)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">mydb</span>=# SELECT to_timestamp(((6888133981158752630&gt;&gt;32) &amp; (2^32 -1)::bigint));<br>      to_timestamp<br>------------------------<br> 2020-10-27 11:17:48+08<br>(1 row)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"tuple-internal详解\"><a href=\"#tuple-internal详解\" class=\"headerlink\" title=\"tuple-internal详解\"></a>tuple-internal详解</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>pgconf.ru<span class=\"hljs-regexp\">/media/</span><span class=\"hljs-number\">2016</span><span class=\"hljs-regexp\">/05/</span><span class=\"hljs-number\">13</span>/tuple-internals.pdf<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL-clog最大大小\"><a href=\"#PostgreSQL-clog最大大小\" class=\"headerlink\" title=\"PostgreSQL clog最大大小\"></a>PostgreSQL clog最大大小</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-meta\">#define CLOG_BITS_PER_XACT      2   //2bit一个事物</span><br><span class=\"hljs-meta\">#define CLOG_XACTS_PER_BYTE 4       //1Byte4个事物</span><br><span class=\"hljs-meta\">#define CLOG_XACTS_PER_PAGE (BLCKSZ * CLOG_XACTS_PER_BYTE)</span><br><br><span class=\"hljs-number\">500</span>M，内存中处理完全够效率, 想想要是<span class=\"hljs-number\">64</span>位xid, 光clog大小就不一定多大了.<br><br>clog总大小约<span class=\"hljs-number\">500</span>MB, 每个clog文件<span class=\"hljs-number\">256</span>kb, 最多<span class=\"hljs-number\">2097152</span>个clog文件.<br><br>mydb=# <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>^<span class=\"hljs-number\">31</span>/<span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">256</span>;<br> ?<span class=\"hljs-keyword\">column</span>?<br><span class=\"hljs-comment\">----------</span><br>  <span class=\"hljs-number\">2097152</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=# <span class=\"hljs-keyword\">select</span> pg_size_pretty((<span class=\"hljs-number\">2</span>^<span class=\"hljs-number\">31</span>/<span class=\"hljs-number\">4</span>)::<span class=\"hljs-type\">bigint</span>);<br> pg_size_pretty<br><span class=\"hljs-comment\">----------------</span><br> <span class=\"hljs-number\">512</span> MB<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"bytea转为原始字符\"><a href=\"#bytea转为原始字符\" class=\"headerlink\" title=\"bytea转为原始字符\"></a>bytea转为原始字符</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> t_bytea(<span class=\"hljs-keyword\">info</span> <span class=\"hljs-type\">bytea</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>postgres=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> t_bytea <span class=\"hljs-keyword\">select</span> <span class=\"hljs-string\">&#x27;hello&#x27;</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>postgres=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> t_bytea <span class=\"hljs-keyword\">select</span> <span class=\"hljs-string\">&#x27;我的家乡&#x27;</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>postgres=# <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> t_bytea ;<br>            <span class=\"hljs-keyword\">info</span><br><span class=\"hljs-comment\">----------------------------</span><br> \\x68656c6c6f<br> \\xe68891e79a84e5aeb6e4b9a1<br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-keyword\">select</span> encode(<span class=\"hljs-keyword\">info</span>, <span class=\"hljs-string\">&#x27;escape&#x27;</span>) <span class=\"hljs-keyword\">from</span> t_bytea ;<br>                      encode<br><span class=\"hljs-comment\">--------------------------------------------------</span><br> hello<br> \\<span class=\"hljs-number\">346</span>\\<span class=\"hljs-number\">210</span>\\<span class=\"hljs-number\">221</span>\\<span class=\"hljs-number\">347</span>\\<span class=\"hljs-number\">232</span>\\<span class=\"hljs-number\">204</span>\\<span class=\"hljs-number\">345</span>\\<span class=\"hljs-number\">256</span>\\<span class=\"hljs-number\">266</span>\\<span class=\"hljs-number\">344</span>\\<span class=\"hljs-number\">271</span>\\<span class=\"hljs-number\">241</span><br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-keyword\">select</span> convert_from(<span class=\"hljs-keyword\">info</span>, <span class=\"hljs-string\">&#x27;UTF8&#x27;</span>) <span class=\"hljs-keyword\">from</span> t_bytea ;<br> convert_from<br><span class=\"hljs-comment\">--------------</span><br> hello<br> 我的家乡<br>(<span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">rows</span>)<br><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs n1ql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">schema</span> dba;<br></code></pre></td></tr></table></figure>\n<h1 id=\"tps\"><a href=\"#tps\" class=\"headerlink\" title=\"tps\"></a>tps</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">procedure</span> dba.tps() <span class=\"hljs-keyword\">as</span> $$<br><span class=\"pgsql\"><span class=\"hljs-keyword\">declare</span></span><br><span class=\"pgsql\">  v1 <span class=\"hljs-type\">int8</span>;</span><br><span class=\"pgsql\">  v2 <span class=\"hljs-type\">int8</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">begin</span></span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class=\"hljs-keyword\">into</span> v1;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">commit</span>;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">perform</span> pg_sleep(<span class=\"hljs-number\">1</span>);</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class=\"hljs-keyword\">into</span> v2;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">commit</span>;</span><br><span class=\"pgsql\">  <span class=\"hljs-keyword\">raise</span> <span class=\"hljs-keyword\">notice</span> <span class=\"hljs-string\">&#x27;tps: %&#x27;</span>, v2-v1;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">end</span>;</span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> plpgsql ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"qps\"><a href=\"#qps\" class=\"headerlink\" title=\"qps\"></a>qps</h1><p>用select sum(calls) s from pg_stat_statements(false) 而不用select sum(calls) s from pg_stat_statements<br>不需要具体的query, 查询效率好很多.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">with</span><br>a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> sum(calls) s <span class=\"hljs-keyword\">from</span> pg_stat_statements(<span class=\"hljs-keyword\">false</span>)),   <br>b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> sum(calls) s <span class=\"hljs-keyword\">from</span> pg_stat_statements(<span class=\"hljs-keyword\">false</span>) , pg_sleep(<span class=\"hljs-number\">1</span>))   <br><span class=\"hljs-keyword\">select</span>   <br>b.s-a.s          <span class=\"hljs-comment\">-- QPS  </span><br><span class=\"hljs-keyword\">from</span> a,b;<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"查询没有使用过的大于1MB的索引-top-10\"><a href=\"#查询没有使用过的大于1MB的索引-top-10\" class=\"headerlink\" title=\"查询没有使用过的大于1MB的索引 top 10\"></a>查询没有使用过的大于1MB的索引 top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10notusedidx <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(indexrelid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_indexes<br><span class=\"hljs-keyword\">WHERE</span><br>    pg_relation_size(indexrelid) &gt;= <span class=\"hljs-number\">1024000</span><br>    <span class=\"hljs-keyword\">AND</span> (idx_scan = <span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">OR</span> idx_tup_read = <span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">OR</span> idx_tup_fetch = <span class=\"hljs-number\">0</span>)<br>    <span class=\"hljs-keyword\">AND</span> schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    pg_relation_size(indexrelid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<p>注意, PK、UK如果只是用于约束, 可能不会被统计计数,但是不能删掉) </p>\n<h1 id=\"查询没有使用过的大于1MB的表-top-10\"><a href=\"#查询没有使用过的大于1MB的表-top-10\" class=\"headerlink\" title=\"查询没有使用过的大于1MB的表 top 10\"></a>查询没有使用过的大于1MB的表 top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10notusedtab <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_tables<br><span class=\"hljs-keyword\">WHERE</span><br>    pg_relation_size(relid) &gt;= <span class=\"hljs-number\">1024000</span><br>    <span class=\"hljs-keyword\">AND</span> seq_scan = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-keyword\">AND</span> idx_scan = <span class=\"hljs-number\">0</span><br>    <span class=\"hljs-keyword\">AND</span> schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    pg_relation_size(relid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询热表top-10\"><a href=\"#查询热表top-10\" class=\"headerlink\" title=\"查询热表top 10\"></a>查询热表top 10</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> dba.top10hottab <span class=\"hljs-keyword\">AS</span><br><span class=\"hljs-keyword\">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class=\"hljs-keyword\">FROM</span><br>    pg_stat_all_tables<br><span class=\"hljs-keyword\">WHERE</span><br>    schemaname <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;pg_toast&#x27;</span>, <span class=\"hljs-string\">&#x27;pg_catalog&#x27;</span>, <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>)<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    seq_scan + idx_scan <span class=\"hljs-keyword\">DESC</span>,<br>    pg_relation_size(relid) <span class=\"hljs-keyword\">DESC</span><br><span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">10</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"在standby节点执行，-接收wal的速度。\"><a href=\"#在standby节点执行，-接收wal的速度。\" class=\"headerlink\" title=\"在standby节点执行， 接收wal的速度。\"></a>在standby节点执行， 接收wal的速度。</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">dba</span>.<span class=\"hljs-title\">wal_receive_bw</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">v1</span> <span class=\"hljs-title\">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class=\"hljs-keyword\">begin</span><br>  select pg_last_wal_receive_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class=\"hljs-number\">1</span>);<br>  select pg_last_wal_receive_lsn() into v2;<br>  commit;<br>  raise notice <span class=\"hljs-string\">&#x27;wal receive bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$;</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"在standby节点执行，-replay-wal的速度。\"><a href=\"#在standby节点执行，-replay-wal的速度。\" class=\"headerlink\" title=\"在standby节点执行， replay wal的速度。\"></a>在standby节点执行， replay wal的速度。</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">dba</span>.<span class=\"hljs-title\">wal_replay_bw</span><span class=\"hljs-params\">()</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span></span><br><span class=\"hljs-function\">  <span class=\"hljs-title\">v1</span> <span class=\"hljs-title\">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class=\"hljs-keyword\">begin</span><br>  select pg_last_wal_replay_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class=\"hljs-number\">1</span>);<br>  select pg_last_wal_replay_lsn() into v2;<br>  commit;<br>  raise notice <span class=\"hljs-string\">&#x27;wal replay bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$;</span> <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀空间top-10的表\"><a href=\"#查询膨胀空间top-10的表\" class=\"headerlink\" title=\"查询膨胀空间top 10的表\"></a>查询膨胀空间top 10的表</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatsizetable <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wastedbytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀空间top-10的索引\"><a href=\"#查询膨胀空间top-10的索引\" class=\"headerlink\" title=\"查询膨胀空间top 10的索引\"></a>查询膨胀空间top 10的索引</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatsizeindex <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wastedibytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀比例top-10的表-浪费空间大于10MB的表\"><a href=\"#查询膨胀比例top-10的表-浪费空间大于10MB的表\" class=\"headerlink\" title=\"查询膨胀比例top 10的表(浪费空间大于10MB的表)\"></a>查询膨胀比例top 10的表(浪费空间大于10MB的表)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatratiotable <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml   <br><span class=\"hljs-keyword\">where</span> (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span>) &gt;= <span class=\"hljs-number\">10240000</span>  <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> tbloat <span class=\"hljs-keyword\">desc</span>,wastedbytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询膨胀比例top-10的索引-浪费空间大于10MB的索引\"><a href=\"#查询膨胀比例top-10的索引-浪费空间大于10MB的索引\" class=\"headerlink\" title=\"查询膨胀比例top 10的索引(浪费空间大于10MB的索引)\"></a>查询膨胀比例top 10的索引(浪费空间大于10MB的索引)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top10bloatratioindex <span class=\"hljs-keyword\">as</span>  <br><span class=\"hljs-keyword\">SELECT</span>  <br>  current_database() <span class=\"hljs-keyword\">AS</span> db, schemaname, tablename, reltuples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> tups, relpages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> pages, otta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> otta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> sml.relpages=otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> sml.relpages/otta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> tbloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> relpages::<span class=\"hljs-type\">bigint</span> - otta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedpages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(sml.relpages-otta)::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedbytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span>::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedsize,  <br>  iname, ituples::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> itups, ipages::<span class=\"hljs-type\">bigint</span> <span class=\"hljs-keyword\">AS</span> ipages, iotta,  <br>  ROUND(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> iotta=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> ipages=iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0.0</span> <span class=\"hljs-keyword\">ELSE</span> ipages/iotta::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">END</span>,<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">AS</span> ibloat,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> ipages::<span class=\"hljs-type\">bigint</span> - iotta <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedipages,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedibytes,  <br>  <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-string\">&#x27;0 bytes&#x27;</span> <span class=\"hljs-keyword\">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> wastedisize,  <br>  pg_size_pretty(<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> relpages &lt; otta <span class=\"hljs-keyword\">THEN</span>  <br>    <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>    <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span>)  <br>      <span class=\"hljs-keyword\">ELSE</span> bs*(relpages-otta::<span class=\"hljs-type\">bigint</span> + ipages-iotta::<span class=\"hljs-type\">bigint</span>) <span class=\"hljs-keyword\">END</span>  <br>  <span class=\"hljs-keyword\">END</span>) <span class=\"hljs-keyword\">AS</span> totalwastedbytes  <br><span class=\"hljs-keyword\">FROM</span> (  <br>  <span class=\"hljs-keyword\">SELECT</span>  <br>    nn.nspname <span class=\"hljs-keyword\">AS</span> schemaname,  <br>    cc.relname <span class=\"hljs-keyword\">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> relpages,  <br>    COALESCE(bs,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> datahdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> datahdr%ma <span class=\"hljs-keyword\">END</span>))+nullhdr2+<span class=\"hljs-number\">4</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> otta,  <br>    COALESCE(c2.relname,<span class=\"hljs-string\">&#x27;?&#x27;</span>) <span class=\"hljs-keyword\">AS</span> iname, COALESCE(c2.reltuples,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ituples, COALESCE(c2.relpages,<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class=\"hljs-number\">-12</span>))/(bs<span class=\"hljs-number\">-20</span>::<span class=\"hljs-type\">float</span>)),<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">AS</span> iotta <span class=\"hljs-comment\">-- very rough approximation, assumes all cols  </span><br>  <span class=\"hljs-keyword\">FROM</span>  <br>     pg_class cc  <br>  <span class=\"hljs-keyword\">JOIN</span> pg_namespace nn <span class=\"hljs-keyword\">ON</span> cc.relnamespace = nn.oid <span class=\"hljs-keyword\">AND</span> nn.nspname &lt;&gt; <span class=\"hljs-string\">&#x27;information_schema&#x27;</span>  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span>  <br>  (  <br>    <span class=\"hljs-keyword\">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> hdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> hdr%ma <span class=\"hljs-keyword\">END</span>)))::<span class=\"hljs-type\">numeric</span> <span class=\"hljs-keyword\">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> nullhdr%ma=<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span> ma <span class=\"hljs-keyword\">ELSE</span> nullhdr%ma <span class=\"hljs-keyword\">END</span>))) <span class=\"hljs-keyword\">AS</span> nullhdr2  <br>    <span class=\"hljs-keyword\">FROM</span> (  <br>      <span class=\"hljs-keyword\">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class=\"hljs-number\">1</span>-coalesce(null_frac,<span class=\"hljs-number\">0</span>))*coalesce(avg_width, <span class=\"hljs-number\">2048</span>)) <span class=\"hljs-keyword\">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class=\"hljs-number\">0</span>)) <span class=\"hljs-keyword\">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>+count(*)/<span class=\"hljs-number\">8</span>  <br>          <span class=\"hljs-keyword\">FROM</span> pg_stats s2  <br>          <span class=\"hljs-keyword\">WHERE</span> null_frac&lt;&gt;<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> s2.schemaname = ns.nspname <span class=\"hljs-keyword\">AND</span> s2.tablename = tbl.relname  <br>        ) <span class=\"hljs-keyword\">AS</span> nullhdr  <br>      <span class=\"hljs-keyword\">FROM</span> pg_attribute att  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_class tbl <span class=\"hljs-keyword\">ON</span> att.attrelid = tbl.oid  <br>      <span class=\"hljs-keyword\">JOIN</span> pg_namespace ns <span class=\"hljs-keyword\">ON</span> ns.oid = tbl.relnamespace  <br>      <span class=\"hljs-keyword\">LEFT JOIN</span> pg_stats s <span class=\"hljs-keyword\">ON</span> s.schemaname=ns.nspname  <br>      <span class=\"hljs-keyword\">AND</span> s.tablename = tbl.relname  <br>      <span class=\"hljs-keyword\">AND</span> s.inherited=<span class=\"hljs-keyword\">false</span>  <br>      <span class=\"hljs-keyword\">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class=\"hljs-keyword\">SELECT</span>  <br>          (<span class=\"hljs-keyword\">SELECT</span> current_setting(<span class=\"hljs-string\">&#x27;block_size&#x27;</span>)::<span class=\"hljs-type\">numeric</span>) <span class=\"hljs-keyword\">AS</span> bs,  <br>            <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class=\"hljs-string\">&#x27; &#x27;</span>, <span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">FROM</span> <span class=\"hljs-string\">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&#x27;#&#x27;</span>)  <br>              <span class=\"hljs-keyword\">IN</span> (<span class=\"hljs-string\">&#x27;8.0&#x27;</span>,<span class=\"hljs-string\">&#x27;8.1&#x27;</span>,<span class=\"hljs-string\">&#x27;8.2&#x27;</span>) <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">27</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">23</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> hdr,  <br>          <span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> v ~ <span class=\"hljs-string\">&#x27;mingw32&#x27;</span> <span class=\"hljs-keyword\">OR</span> v ~ <span class=\"hljs-string\">&#x27;64-bit&#x27;</span> <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">8</span> <span class=\"hljs-keyword\">ELSE</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">AS</span> ma  <br>        <span class=\"hljs-keyword\">FROM</span> (<span class=\"hljs-keyword\">SELECT</span> version() <span class=\"hljs-keyword\">AS</span> v) <span class=\"hljs-keyword\">AS</span> foo  <br>      ) <span class=\"hljs-keyword\">AS</span> constants  <br>      <span class=\"hljs-keyword\">WHERE</span> att.attnum &gt; <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">AND</span> tbl.relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span>  <br>      <span class=\"hljs-keyword\">GROUP</span> <span class=\"hljs-keyword\">BY</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>  <br>    ) <span class=\"hljs-keyword\">AS</span> foo  <br>  ) <span class=\"hljs-keyword\">AS</span> rs  <br>  <span class=\"hljs-keyword\">ON</span> cc.relname = rs.relname <span class=\"hljs-keyword\">AND</span> nn.nspname = rs.nspname  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_index i <span class=\"hljs-keyword\">ON</span> indrelid = cc.oid  <br>  <span class=\"hljs-keyword\">LEFT JOIN</span> pg_class c2 <span class=\"hljs-keyword\">ON</span> c2.oid = i.indexrelid  <br>) <span class=\"hljs-keyword\">AS</span> sml   <br><span class=\"hljs-keyword\">where</span> (<span class=\"hljs-keyword\">CASE</span> <span class=\"hljs-keyword\">WHEN</span> ipages &lt; iotta <span class=\"hljs-keyword\">THEN</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">ELSE</span> bs*(ipages-iotta) <span class=\"hljs-keyword\">END</span>) &gt;= <span class=\"hljs-number\">10240000</span>  <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> ibloat <span class=\"hljs-keyword\">desc</span>,wastedibytes <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">5</span>; <br></code></pre></td></tr></table></figure>\n<h1 id=\"查询序列距离最大值的范围\"><a href=\"#查询序列距离最大值的范围\" class=\"headerlink\" title=\"查询序列距离最大值的范围\"></a>查询序列距离最大值的范围</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.seqs <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> max_value-last_value,* <span class=\"hljs-keyword\">from</span> pg_sequences <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> max_value-last_value ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"freeze风暴预测相关的3个视图\"><a href=\"#freeze风暴预测相关的3个视图\" class=\"headerlink\" title=\"freeze风暴预测相关的3个视图\"></a>freeze风暴预测相关的3个视图</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze <span class=\"hljs-keyword\">as</span>    <br><span class=\"hljs-keyword\">select</span>     <br>  e.*,     <br>  a.*     <br><span class=\"hljs-keyword\">from</span>    <br>(<span class=\"hljs-keyword\">select</span>     <br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v1,            <span class=\"hljs-comment\">-- 如果表的事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v2,  <span class=\"hljs-comment\">-- 如果表的并行事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v3,                <span class=\"hljs-comment\">-- 手动或自动垃圾回收时, 如果记录的事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_multixact_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v4,      <span class=\"hljs-comment\">-- 手动或自动垃圾回收时, 如果记录的并行事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_table_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v5,              <span class=\"hljs-comment\">-- 手动垃圾回收时, 如果表的事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_freeze_max_age    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_multixact_freeze_table_age&#x27;</span>)::<span class=\"hljs-type\">int</span> <span class=\"hljs-keyword\">as</span> v6,    <span class=\"hljs-comment\">-- 手动垃圾回收时, 如果表的并行事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_multixact_freeze_max_age    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_vacuum_cost_delay&#x27;</span>) <span class=\"hljs-keyword\">as</span> v7,              <span class=\"hljs-comment\">-- 自动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源. -1 表示沿用vacuum_cost_delay的设置    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_vacuum_cost_limit&#x27;</span>) <span class=\"hljs-keyword\">as</span> v8,              <span class=\"hljs-comment\">-- 自动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定. -1 表示沿用vacuum_cost_limit的设置    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_cost_delay&#x27;</span>) <span class=\"hljs-keyword\">as</span> v9,                         <span class=\"hljs-comment\">-- 手动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源.    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_cost_limit&#x27;</span>) <span class=\"hljs-keyword\">as</span> v10,                        <span class=\"hljs-comment\">-- 手动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定.    </span><br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum&#x27;</span>) <span class=\"hljs-keyword\">as</span> autovacuum                         <span class=\"hljs-comment\">-- 是否开启自动垃圾回收    </span><br>) a,     <br><span class=\"hljs-keyword\">LATERAL</span> (   <span class=\"hljs-comment\">-- LATERAL 允许你在这个SUBQUERY中直接引用前面的table, subquery中的column     </span><br><span class=\"hljs-keyword\">select</span>     <br>pg_size_pretty(pg_total_relation_size(<span class=\"hljs-type\">oid</span>)) sz,   <span class=\"hljs-comment\">-- 表的大小(含TOAST, 索引)    </span><br><span class=\"hljs-type\">oid</span>::<span class=\"hljs-type\">regclass</span> <span class=\"hljs-keyword\">as</span> reloid,    <span class=\"hljs-comment\">-- 表名(物化视图)    </span><br>relkind,                    <span class=\"hljs-comment\">-- r=表, m=物化视图    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  a.v1    <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_xid,   <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  a.v2    <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relminmxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relminmxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_mxid,  <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为并发事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  a.v3    <br>) <span class=\"hljs-keyword\">as</span> xid_lower_to_minage,    <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_multixact_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  a.v4    <br>) <span class=\"hljs-keyword\">as</span> mxid_lower_to_minage,   <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的并行事务ID年龄会降到多少    </span><br><span class=\"hljs-keyword\">case</span>     <br>  <span class=\"hljs-keyword\">when</span> v5 &lt;= age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>) <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;YES&#x27;</span>    <br>  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;NOT&#x27;</span>    <br><span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">as</span> vacuum_trigger_freeze1,    <span class=\"hljs-comment\">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(事务ID年龄达到阈值)    </span><br><span class=\"hljs-keyword\">case</span>     <br>  <span class=\"hljs-keyword\">when</span> v6 &lt;= age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relminmxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relminmxid <span class=\"hljs-keyword\">end</span>) <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;YES&#x27;</span>    <br>  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;NOT&#x27;</span>    <br><span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">as</span> vacuum_trigger_freeze2,    <span class=\"hljs-comment\">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(并行事务ID年龄达到阈值)    </span><br>reloptions                        <span class=\"hljs-comment\">-- 表级参数, 优先. 例如是否开启自动垃圾回收, autovacuum_freeze_max_age, autovacuum_freeze_table_age, autovacuum_multixact_freeze_max_age, autovacuum_multixact_freeze_table_age    </span><br><span class=\"hljs-keyword\">from</span> pg_class     <br>  <span class=\"hljs-keyword\">where</span> relkind <span class=\"hljs-keyword\">in</span> (<span class=\"hljs-string\">&#x27;r&#x27;</span>,<span class=\"hljs-string\">&#x27;m&#x27;</span>)    <br>) e     <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>     <br>  least(e.remain_ages_xid , e.remain_ages_mxid),  <span class=\"hljs-comment\">-- 排在越前, 越先触发自动FREEZE, 即风暴来临的预测    </span><br>  pg_total_relation_size(reloid) <span class=\"hljs-keyword\">desc</span>   <span class=\"hljs-comment\">-- 同样剩余年龄, 表越大, 排越前    </span><br>;    <br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze_stat <span class=\"hljs-keyword\">as</span>    <br><span class=\"hljs-keyword\">select</span>     <br>wb,                                                     <span class=\"hljs-comment\">-- 第几个BATCH, 每个batch代表流逝100万个事务     </span><br>cnt,                                                    <span class=\"hljs-comment\">-- 这个batch 有多少表    </span><br>pg_size_pretty(ssz) <span class=\"hljs-keyword\">as</span> ssz1,                            <span class=\"hljs-comment\">-- 这个batch 这些 表+TOAST+索引 有多少容量    </span><br>pg_size_pretty(ssz) <span class=\"hljs-keyword\">as</span> ssz2,                            <span class=\"hljs-comment\">-- 这个batch FREEZE 会导致多少读IO    </span><br>pg_size_pretty(ssz*<span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">as</span> ssz3,                          <span class=\"hljs-comment\">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(min_sz) <span class=\"hljs-keyword\">as</span> ssz4,                         <span class=\"hljs-comment\">-- 这个batch 最小的表多大    </span><br>pg_size_pretty(max_sz) <span class=\"hljs-keyword\">as</span> ssz5,                         <span class=\"hljs-comment\">-- 这个batch 最大的表多大    </span><br>pg_size_pretty(avg_sz) <span class=\"hljs-keyword\">as</span> ssz6,                         <span class=\"hljs-comment\">-- 这个batch 平均表多大    </span><br>pg_size_pretty(stddev_sz) <span class=\"hljs-keyword\">as</span> ssz7,                      <span class=\"hljs-comment\">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显    </span><br>min_rest_age,                                           <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最低剩余事务数    </span><br>max_rest_age,                                           <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最高剩余事务数    </span><br>stddev_rest_age,                                        <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>corr_rest_age_sz,                                       <span class=\"hljs-comment\">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 sz7 说明的问题越有价值    </span><br>round(<span class=\"hljs-number\">100</span>*(ssz/(sum(ssz) <span class=\"hljs-keyword\">over</span> ())), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio   <span class=\"hljs-comment\">-- 这个BATCH的容量占比，占比如果非常不均匀，说明有必要调整表级FREEZE参数，让占比均匀化    </span><br><span class=\"hljs-keyword\">from</span>         <br>(    <br><span class=\"hljs-keyword\">select</span> a.*, b.* <span class=\"hljs-keyword\">from</span>     <br>(    <br><span class=\"hljs-keyword\">select</span>     <br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_min,   <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_max    <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br><span class=\"hljs-keyword\">from</span> v_freeze    <br>) <span class=\"hljs-keyword\">as</span> a,    <br><span class=\"hljs-keyword\">LATERAL</span> (  <span class=\"hljs-comment\">-- 高级SQL    </span><br><span class=\"hljs-keyword\">select</span>     <br>width_bucket(    <br>  least(remain_ages_xid, remain_ages_mxid),     <br>  a.v_min,    <br>  a.v_max,    <br>  greatest((a.v_max-a.v_min)/<span class=\"hljs-number\">1000000</span>, <span class=\"hljs-number\">1</span>)   <span class=\"hljs-comment\">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>) <span class=\"hljs-keyword\">as</span> wb,      <br>count(*) <span class=\"hljs-keyword\">as</span> cnt,     <br>sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> ssz,     <br>stddev_samp(pg_total_relation_size(reloid) <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> stddev_sz,     <br>min(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> min_sz,     <br>max(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> max_sz,     <br>avg(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> avg_sz,     <br>min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> min_rest_age,     <br>max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> max_rest_age,     <br>stddev_samp(least(remain_ages_xid, remain_ages_mxid) <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> stddev_rest_age,     <br>corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">as</span> corr_rest_age_sz     <br><span class=\"hljs-keyword\">from</span> v_freeze     <br><span class=\"hljs-keyword\">group</span> <span class=\"hljs-keyword\">by</span> wb     <br>) <span class=\"hljs-keyword\">as</span> b     <br>) t     <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> wb; <br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.v_freeze_stat_detail <span class=\"hljs-keyword\">as</span>      <br><span class=\"hljs-keyword\">select</span>     <br>pg_size_pretty(t.ssz) <span class=\"hljs-keyword\">as</span> ssz2,     <span class=\"hljs-comment\">-- 这个batch FREEZE 会导致多少读IO (表+TOAST+索引)    </span><br>pg_size_pretty(t.ssz*<span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">as</span> ssz3,   <span class=\"hljs-comment\">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(t.ssz_sum) <span class=\"hljs-keyword\">as</span> ssz4, <span class=\"hljs-comment\">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>round(<span class=\"hljs-number\">100</span>*(t.ssz/t.ssz_sum), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio_batch,     <span class=\"hljs-comment\">-- 这个BATCH的容量占比，目标是让所有BATCH占比尽量一致    </span><br>round(<span class=\"hljs-number\">100</span>*(pg_total_relation_size(t.reloid)/t.ssz), <span class=\"hljs-number\">2</span>)||<span class=\"hljs-string\">&#x27; %&#x27;</span> <span class=\"hljs-keyword\">as</span> ratio_table,     <span class=\"hljs-comment\">-- 这个表占整个batch的容量占比，大表尽量错开freeze    </span><br>t.*      <br><span class=\"hljs-keyword\">from</span>         <br>(    <br><span class=\"hljs-keyword\">select</span> a.*, b.* <span class=\"hljs-keyword\">from</span>       <br>(    <br>  <span class=\"hljs-keyword\">select</span>     <br>    min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_min,   <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>    max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">as</span> v_max    <span class=\"hljs-comment\">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br>  <span class=\"hljs-keyword\">from</span> v_freeze     <br>) <span class=\"hljs-keyword\">as</span> a,     <br><span class=\"hljs-keyword\">LATERAL</span> (     <span class=\"hljs-comment\">-- 高级SQL    </span><br><span class=\"hljs-keyword\">select</span>     <br>  count(*) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> cnt,                                                <span class=\"hljs-comment\">-- 这个batch 有多少表      </span><br>  sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> () <span class=\"hljs-keyword\">as</span> ssz_sum,                <span class=\"hljs-comment\">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>  sum(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> ssz,                     <span class=\"hljs-comment\">-- 这个batch 的表大小总和 (表+TOAST+索引)    </span><br>  pg_size_pretty(min(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> min_sz,  <span class=\"hljs-comment\">-- 这个batch 最小的表多大    </span><br>  pg_size_pretty(max(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> max_sz,  <span class=\"hljs-comment\">-- 这个batch 最大的表多大    </span><br>  pg_size_pretty(avg(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> avg_sz,  <span class=\"hljs-comment\">-- 这个batch 平均表多大    </span><br>  pg_size_pretty(stddev_samp(pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w) <span class=\"hljs-keyword\">as</span> stddev_sz,  <span class=\"hljs-comment\">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显                                                                                                                 </span><br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> min_rest_age,             <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最低剩余事务数                                                                                                                             </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> max_rest_age,             <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE最高剩余事务数                                                                                                                             </span><br>  stddev_samp(least(remain_ages_xid, remain_ages_mxid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> stddev_rest_age,  <span class=\"hljs-comment\">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>  corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class=\"hljs-keyword\">over</span> w <span class=\"hljs-keyword\">as</span> corr_rest_age_sz,  <span class=\"hljs-comment\">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 stddev_sz 说明的问题越有价值    </span><br>  t1.*     <br><span class=\"hljs-keyword\">from</span>     <br>  (    <br>  <span class=\"hljs-keyword\">select</span>     <br>    width_bucket(    <br>      least(tt.remain_ages_xid, tt.remain_ages_mxid),     <br>      a.v_min,    <br>      a.v_max,    <br>      greatest((a.v_max-a.v_min)/<span class=\"hljs-number\">1000000</span>, <span class=\"hljs-number\">1</span>)         <span class=\"hljs-comment\">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>    )     <br>    <span class=\"hljs-keyword\">as</span> wb,                                           <span class=\"hljs-comment\">-- 第几个BATCH, 每个batch代表流逝100万个事务      </span><br>    * <span class=\"hljs-keyword\">from</span> v_freeze tt    <br>  ) <span class=\"hljs-keyword\">as</span> t1      <br>  <span class=\"hljs-keyword\">window</span> w <span class=\"hljs-keyword\">as</span>     <br>  (    <br>    <span class=\"hljs-keyword\">partition</span> <span class=\"hljs-keyword\">by</span> t1.wb     <br>  )     <br>) <span class=\"hljs-keyword\">as</span> b    <br>) t    <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>     <br>  t.wb,      <br>  least(t.remain_ages_xid, t.remain_ages_mxid),       <br>  pg_total_relation_size(t.reloid) <span class=\"hljs-keyword\">desc</span>       <br>;      <br>  <br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.top20freezebigtable <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> relowner::<span class=\"hljs-type\">regrole</span>, relnamespace::<span class=\"hljs-type\">regnamespace</span>, relname, <br>age(relfrozenxid),pg_size_pretty(pg_total_relation_size(<span class=\"hljs-type\">oid</span>)) , <span class=\"hljs-comment\">-- 当前年龄 </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>,     <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_table_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>     <br>  ),    <br>  current_setting(<span class=\"hljs-string\">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class=\"hljs-type\">int</span>   <br>)    <br>-    <br>age(<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> relfrozenxid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int</span>&lt;<span class=\"hljs-number\">3</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">else</span> relfrozenxid <span class=\"hljs-keyword\">end</span>)     <br><span class=\"hljs-keyword\">as</span> remain_ages_xid,  <span class=\"hljs-comment\">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID</span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class=\"hljs-type\">text</span>, <span class=\"hljs-string\">&#x27;autovacuum_freeze_min_age=(\\d+)&#x27;</span>)::<span class=\"hljs-type\">int</span>    <br>  ),    <br>  current_setting(<span class=\"hljs-string\">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class=\"hljs-type\">int</span>   <br>) <span class=\"hljs-keyword\">as</span> xid_lower_to_minage    <span class=\"hljs-comment\">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少  </span><br><span class=\"hljs-keyword\">from</span> pg_class <span class=\"hljs-keyword\">where</span> relkind=<span class=\"hljs-string\">&#x27;r&#x27;</span> <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> pg_total_relation_size(<span class=\"hljs-type\">oid</span>) <span class=\"hljs-keyword\">desc</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">20</span>; <br></code></pre></td></tr></table></figure>\n<h1 id=\"未归档wal文件\"><a href=\"#未归档wal文件\" class=\"headerlink\" title=\"未归档wal文件\"></a>未归档wal文件</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.arch_undone <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_ls_archive_statusdir() <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span> !~ <span class=\"hljs-string\">&#x27;done$&#x27;</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"归档任务状态\"><a href=\"#归档任务状态\" class=\"headerlink\" title=\"归档任务状态\"></a>归档任务状态</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.arch_status <span class=\"hljs-keyword\">as</span><br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_stat_get_archiver();<br></code></pre></td></tr></table></figure>\n<h1 id=\"wal空间占用\"><a href=\"#wal空间占用\" class=\"headerlink\" title=\"wal空间占用\"></a>wal空间占用</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.walsize <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">select</span> pg_size_pretty(sum(size)) <span class=\"hljs-keyword\">from</span> pg_ls_waldir();<br></code></pre></td></tr></table></figure>\n<h1 id=\"系统强制保留wal大小\"><a href=\"#系统强制保留wal大小\" class=\"headerlink\" title=\"系统强制保留wal大小\"></a>系统强制保留wal大小</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.wal_keep_size <span class=\"hljs-keyword\">as</span><br><span class=\"hljs-keyword\">with</span> a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> setting <span class=\"hljs-keyword\">from</span> pg_settings <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span>=<span class=\"hljs-string\">&#x27;wal_keep_segments&#x27;</span>) , b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> setting,unit <span class=\"hljs-keyword\">from</span> pg_settings <span class=\"hljs-keyword\">where</span> <span class=\"hljs-type\">name</span>=<span class=\"hljs-string\">&#x27;wal_segment_size&#x27;</span>) <span class=\"hljs-keyword\">select</span> pg_size_pretty(a.setting::<span class=\"hljs-type\">int8</span>*b.setting::<span class=\"hljs-type\">int8</span>) <span class=\"hljs-keyword\">from</span> a,b;<br></code></pre></td></tr></table></figure>\n<h1 id=\"长事务、prepared-statement\"><a href=\"#长事务、prepared-statement\" class=\"headerlink\" title=\"长事务、prepared statement\"></a>长事务、prepared statement</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.long_snapshot <span class=\"hljs-keyword\">as</span> <br><span class=\"hljs-keyword\">with</span> a <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> min(<span class=\"hljs-keyword\">transaction</span>::<span class=\"hljs-type\">Text</span>::<span class=\"hljs-type\">int8</span>) m <span class=\"hljs-keyword\">from</span> pg_prepared_xacts ),<br>b <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> txid_snapshot_xmin(txid_current_snapshot())::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span> <span class=\"hljs-keyword\">as</span> m),<br>c <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> min(least(backend_xid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>,backend_xmin::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>)) m <span class=\"hljs-keyword\">from</span> pg_stat_activity ),<br>d <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> datname,usename,pid,query_start,xact_start,now(),wait_event,query <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span><br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> least(backend_xid::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>,backend_xmin::<span class=\"hljs-type\">text</span>::<span class=\"hljs-type\">int8</span>) <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">1</span>),<br>e <span class=\"hljs-keyword\">as</span> (<span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_prepared_xacts <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">transaction</span>::<span class=\"hljs-type\">Text</span>::<span class=\"hljs-type\">int8</span> <span class=\"hljs-keyword\">limit</span> <span class=\"hljs-number\">1</span>)<br><span class=\"hljs-keyword\">select</span> b.m-least(a.m,c.m),d.*,e.* <span class=\"hljs-keyword\">from</span> a,b,c,d <span class=\"hljs-keyword\">left join</span> e <span class=\"hljs-keyword\">on</span> (<span class=\"hljs-number\">1</span>=<span class=\"hljs-number\">1</span>);<br></code></pre></td></tr></table></figure>\n<h1 id=\"重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰\"><a href=\"#重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰\" class=\"headerlink\" title=\"重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)\"></a>重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">select</span> pg_stat_statements_reset();<br></code></pre></td></tr></table></figure>\n<h1 id=\"查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化\"><a href=\"#查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化\" class=\"headerlink\" title=\"查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化\"></a>查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.session_acting_cnt <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> count(*) <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> wait_event <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">and</span> (backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span>); <br></code></pre></td></tr></table></figure>\n<h1 id=\"当前活跃会话\"><a href=\"#当前活跃会话\" class=\"headerlink\" title=\"当前活跃会话\"></a>当前活跃会话</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.sessions <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_stat_activity <span class=\"hljs-keyword\">where</span> wait_event <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">and</span> (backend_xid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">or</span> backend_xmin <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span>);  <br></code></pre></td></tr></table></figure>\n<h1 id=\"查看锁等待\"><a href=\"#查看锁等待\" class=\"headerlink\" title=\"查看锁等待\"></a>查看锁等待</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">view</span> dba.locks <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">with</span>      <br>t_wait <span class=\"hljs-keyword\">as</span>      <br>(      <br>  <span class=\"hljs-keyword\">select</span> a.mode,a.locktype,a.<span class=\"hljs-keyword\">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class=\"hljs-keyword\">from</span> pg_locks a,pg_stat_activity b <span class=\"hljs-keyword\">where</span> a.pid=b.pid <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">not</span> a.granted     <br>),     <br>t_run <span class=\"hljs-keyword\">as</span>     <br>(     <br>  <span class=\"hljs-keyword\">select</span> a.mode,a.locktype,a.<span class=\"hljs-keyword\">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class=\"hljs-keyword\">from</span> pg_locks a,pg_stat_activity b <span class=\"hljs-keyword\">where</span> a.pid=b.pid <span class=\"hljs-keyword\">and</span> a.granted     <br>),     <br>t_overlap <span class=\"hljs-keyword\">as</span>     <br>(     <br>  <span class=\"hljs-keyword\">select</span> r.* <span class=\"hljs-keyword\">from</span> t_wait w <span class=\"hljs-keyword\">join</span> t_run r <span class=\"hljs-keyword\">on</span>     <br>  (     <br>    r.locktype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.locktype <span class=\"hljs-keyword\">and</span>     <br>    r.<span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.<span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">and</span>     <br>    r.relation <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.relation <span class=\"hljs-keyword\">and</span>     <br>    r.page <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.page <span class=\"hljs-keyword\">and</span>     <br>    r.tuple <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.tuple <span class=\"hljs-keyword\">and</span>     <br>    r.virtualxid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.virtualxid <span class=\"hljs-keyword\">and</span>     <br>    r.transactionid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.transactionid <span class=\"hljs-keyword\">and</span>     <br>    r.classid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.classid <span class=\"hljs-keyword\">and</span>     <br>    r.objid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.objid <span class=\"hljs-keyword\">and</span>     <br>    r.objsubid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span> w.objsubid <span class=\"hljs-keyword\">and</span>     <br>    r.pid &lt;&gt; w.pid     <br>  )      <br>),      <br>t_unionall <span class=\"hljs-keyword\">as</span>      <br>(      <br>  <span class=\"hljs-keyword\">select</span> r.* <span class=\"hljs-keyword\">from</span> t_overlap r      <br>  <span class=\"hljs-keyword\">union</span> <span class=\"hljs-keyword\">all</span>      <br>  <span class=\"hljs-keyword\">select</span> w.* <span class=\"hljs-keyword\">from</span> t_wait w      <br>)      <br><span class=\"hljs-keyword\">select</span> locktype,datname,relation::<span class=\"hljs-type\">regclass</span>,page,tuple,virtualxid,transactionid::<span class=\"hljs-type\">text</span>,classid::<span class=\"hljs-type\">regclass</span>,objid,objsubid,     <br>string_agg(     <br><span class=\"hljs-string\">&#x27;Pid: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> pid <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> pid::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||     <br><span class=\"hljs-string\">&#x27;Lock_Granted: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> granted <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> granted::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Mode: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> mode <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> mode::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , FastPath: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> fastpath <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> fastpath::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , VirtualTransaction: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> virtualtransaction <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> virtualtransaction::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Session_State: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> state <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> state::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||     <br><span class=\"hljs-string\">&#x27;Username: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> usename <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> usename::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Database: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> datname <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> datname::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Client_Addr: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> client_addr <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> client_addr::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Client_Port: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> client_port <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> client_port::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Application_Name: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> application_name <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> application_name::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||      <br><span class=\"hljs-string\">&#x27;Xact_Start: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> xact_start <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> xact_start::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Query_Start: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> query_start <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> query_start::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Xact_Elapse: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> (now()-xact_start) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> (now()-xact_start)::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||<span class=\"hljs-string\">&#x27; , Query_Elapse: &#x27;</span>||<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> (now()-query_start) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> (now()-query_start)::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>||chr(<span class=\"hljs-number\">10</span>)||      <br><span class=\"hljs-string\">&#x27;SQL (Current SQL in Transaction): &#x27;</span>||chr(<span class=\"hljs-number\">10</span>)||    <br><span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> query <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">null</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-string\">&#x27;NULL&#x27;</span> <span class=\"hljs-keyword\">else</span> query::<span class=\"hljs-type\">text</span> <span class=\"hljs-keyword\">end</span>,      <br>chr(<span class=\"hljs-number\">10</span>)||<span class=\"hljs-string\">&#x27;--------&#x27;</span>||chr(<span class=\"hljs-number\">10</span>)      <br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span>      <br>  (  <span class=\"hljs-keyword\">case</span> mode      <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;INVALID&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">0</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;AccessShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">1</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;RowShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">2</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;RowExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">3</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareUpdateExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">4</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">5</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ShareRowExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">6</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;ExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">7</span>     <br>    <span class=\"hljs-keyword\">when</span> <span class=\"hljs-string\">&#x27;AccessExclusiveLock&#x27;</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">8</span>     <br>    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-number\">0</span>     <br>  <span class=\"hljs-keyword\">end</span>  ) <span class=\"hljs-keyword\">desc</span>,     <br>  (<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">when</span> granted <span class=\"hljs-keyword\">then</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">else</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">end</span>)    <br>) <span class=\"hljs-keyword\">as</span> lock_conflict    <br><span class=\"hljs-keyword\">from</span> t_unionall     <br><span class=\"hljs-keyword\">group</span> <span class=\"hljs-keyword\">by</span>     <br>locktype,datname,relation,page,tuple,virtualxid,transactionid::<span class=\"hljs-type\">text</span>,classid,objid,objsubid ;<br></code></pre></td></tr></table></figure>\n<h1 id=\"查看索引支持类型\"><a href=\"#查看索引支持类型\" class=\"headerlink\" title=\"查看索引支持类型\"></a>查看索引支持类型</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">SELECT</span><br>    am.amname <span class=\"hljs-keyword\">AS</span> index_method,<br>    opc.opcname <span class=\"hljs-keyword\">AS</span> opclass_name,<br>    opc.opcintype::<span class=\"hljs-type\">regtype</span> <span class=\"hljs-keyword\">AS</span> indexed_type,<br>    opc.opcdefault <span class=\"hljs-keyword\">AS</span> is_default<br><span class=\"hljs-keyword\">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class=\"hljs-keyword\">WHERE</span><br>    opc.opcmethod = am.oid<br><span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span><br>    index_method,<br>    opclass_name;<br><span class=\"hljs-keyword\">SELECT</span><br>    amname,<br>    opcname,<br>    opcintype::<span class=\"hljs-type\">regtype</span>,<br>    opckeytype::<span class=\"hljs-type\">regtype</span>,<br>    opcdefault<br><span class=\"hljs-keyword\">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class=\"hljs-keyword\">WHERE</span><br>    am.oid = opc.opcmethod<br>    <span class=\"hljs-keyword\">AND</span> amname = <span class=\"hljs-string\">&#x27;gin&#x27;</span>;<br><br><span class=\"hljs-keyword\">SELECT</span><br>    <span class=\"hljs-type\">oid</span>,<br>    oprnegate,<br>    oprname,<br>    oprcode,<br>    oprresult::<span class=\"hljs-type\">regtype</span>,<br>    oprleft::<span class=\"hljs-type\">regtype</span>,<br>    oprright::<span class=\"hljs-type\">regtype</span>,<br>    oprcanmerge<br><span class=\"hljs-keyword\">FROM</span><br>    pg_operator;<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"判断ip是否在某一网段内\"><a href=\"#判断ip是否在某一网段内\" class=\"headerlink\" title=\"判断ip是否在某一网段内\"></a>判断ip是否在某一网段内</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> <span class=\"hljs-built_in\">public</span>.is_same_network (ip1 ip4, ip2 ip4, mask <span class=\"hljs-type\">integer</span>)<br>    <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-type\">boolean</span><br><span class=\"hljs-keyword\">AS</span><br>$$<br><span class=\"pgsql\"><span class=\"hljs-keyword\">DECLARE</span></span><br><span class=\"pgsql\">    is_same_network <span class=\"hljs-type\">boolean</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">BEGIN</span></span><br>    IF mask &gt; 32 OR mask &lt; 0 THEN<br><span class=\"pgsql\">        <span class=\"hljs-keyword\">raise</span></span><br><span class=\"pgsql\">        <span class=\"hljs-keyword\">exception</span> <span class=\"hljs-string\">&#x27;The mask must be between 0 and 32&#x27;</span>;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span>;</span><br> <br><span class=\"pgsql\">    <span class=\"hljs-keyword\">EXECUTE</span> format(<span class=\"hljs-string\">&#x27;select (~($1 # $2))::bigint::bit(32)::bit(%I)::text ~ &#x27;&#x27;^1+$&#x27;&#x27;&#x27;</span>, mask) <span class=\"hljs-keyword\">using</span> ip1, ip2 <span class=\"hljs-keyword\">into</span> is_same_network;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">RETURN</span> is_same_network;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">exception</span></span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">WHEN</span> OTHERS <span class=\"hljs-keyword\">THEN</span></span><br><span class=\"pgsql\">        <span class=\"hljs-keyword\">raise</span> <span class=\"hljs-keyword\">NOTICE</span> <span class=\"hljs-string\">&#x27;%&#x27;</span>, <span class=\"hljs-built_in\">SQLERRM</span>;</span><br><span class=\"pgsql\">    <span class=\"hljs-keyword\">RETURN</span> <span class=\"hljs-keyword\">FALSE</span>;</span><br><span class=\"pgsql\"><span class=\"hljs-keyword\">END</span>;</span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> plpgsql;<br></code></pre></td></tr></table></figure>\n<h1 id=\"指定字符替换\"><a href=\"#指定字符替换\" class=\"headerlink\" title=\"指定字符替换\"></a>指定字符替换</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">SELECT</span> regexp_replace(<span class=\"hljs-string\">&#x27;foobarbaz&#x27;</span>, <span class=\"hljs-string\">&#x27;b(..)&#x27;</span>, <span class=\"hljs-string\">&#x27;X\\1Y&#x27;</span>, <span class=\"hljs-string\">&#x27;g&#x27;</span>);<br> regexp_replace <br><span class=\"hljs-comment\">----------------</span><br> fooXarYXazY<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"SQL实现圣诞树\"><a href=\"#SQL实现圣诞树\" class=\"headerlink\" title=\"SQL实现圣诞树\"></a>SQL实现圣诞树</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">WITH</span> leaf <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, (id - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span> + <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), id + <span class=\"hljs-number\">20</span>) leaf,<br>         id<br>    <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>) <span class=\"hljs-keyword\">AS</span> t(id)),<br>lv <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> id lv <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">5</span>) <span class=\"hljs-keyword\">AS</span> t(id)),<br>leafs <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, ((row_number() <span class=\"hljs-keyword\">over</span>()) ::<span class=\"hljs-type\">INT</span> - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span> + <span class=\"hljs-number\">1</span> + (lv - <span class=\"hljs-number\">1</span>) * <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), (row_number()<br>                <span class=\"hljs-keyword\">over</span>())<br>               ::<span class=\"hljs-type\">INT</span> + <span class=\"hljs-number\">20</span> + lv) leaf<br>    <span class=\"hljs-keyword\">FROM</span> leaf,<br>         lv),<br>root <span class=\"hljs-keyword\">AS</span><br> (<span class=\"hljs-keyword\">SELECT</span> lpad(rpad(<span class=\"hljs-string\">&#x27;*&#x27;</span>, <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;*&#x27;</span>), <span class=\"hljs-number\">24</span>) <span class=\"hljs-keyword\">FROM</span> generate_series(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">4</span>) <span class=\"hljs-keyword\">AS</span> t(id))<br><span class=\"hljs-keyword\">SELECT</span> leaf<br>  <span class=\"hljs-keyword\">FROM</span> leafs<br><span class=\"hljs-keyword\">UNION</span> <span class=\"hljs-keyword\">ALL</span><br><span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> root;<br>                   leaf                  <br><span class=\"hljs-comment\">------------------------------------------</span><br>                      *<br>                    *****<br>                  *********<br>                *************<br>              *****************<br>                 ***********<br>               ***************<br>             *******************<br>           ***********************<br>         ***************************<br>            *********************<br>          *************************<br>        *****************************<br>      *********************************<br>    *************************************<br>                    *****<br>                    *****<br>                    *****<br>                    *****<br>(<span class=\"hljs-number\">19</span> <span class=\"hljs-keyword\">rows</span>)<br> <br>mydb=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"生成随机中文\"><a href=\"#生成随机中文\" class=\"headerlink\" title=\"生成随机中文\"></a>生成随机中文</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">replace</span> <span class=\"hljs-keyword\">function</span> gen_hanzi(<span class=\"hljs-built_in\">int</span>) <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-built_in\">text</span> <span class=\"hljs-keyword\">as</span> $$  <br><span class=\"hljs-keyword\">declare</span>  <br>  res <span class=\"hljs-built_in\">text</span>;  <br><span class=\"hljs-keyword\">begin</span>  <br>  <span class=\"hljs-keyword\">if</span> $<span class=\"hljs-number\">1</span> &gt;=<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">then</span>  <br>    <span class=\"hljs-keyword\">select</span> string_agg(<span class=\"hljs-keyword\">chr</span>(<span class=\"hljs-number\">19968</span>+(random()*<span class=\"hljs-number\">20901</span>)::<span class=\"hljs-built_in\">int</span>), <span class=\"hljs-string\">&#x27;&#x27;</span>) <span class=\"hljs-keyword\">into</span> res <span class=\"hljs-keyword\">from</span> generate_series(<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">1</span>);  <br>    return res;  <br>  <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">if</span>;  <br>  return null;  <br><span class=\"hljs-keyword\">end</span>;  <br>$$ language plpgsql strict;<br></code></pre></td></tr></table></figure>\n<h1 id=\"生成随机时间\"><a href=\"#生成随机时间\" class=\"headerlink\" title=\"生成随机时间\"></a>生成随机时间</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">function</span> get_rand_ts() <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-keyword\">as</span> $$  <br><span class=\"pgsql\">  <span class=\"hljs-keyword\">select</span> now()::<span class=\"hljs-type\">timestamp</span>  +  ((<span class=\"hljs-number\">1000</span>*random())::<span class=\"hljs-type\">int</span>::<span class=\"hljs-type\">text</span>||<span class=\"hljs-string\">&#x27; days&#x27;</span>)::<span class=\"hljs-type\">interval</span>;            </span><br><span class=\"ruby\">$$</span> <span class=\"hljs-keyword\">language</span> <span class=\"hljs-keyword\">sql</span> <span class=\"hljs-keyword\">strict</span>;  <br></code></pre></td></tr></table></figure>\n<h1 id=\"找出index-维护SQL\"><a href=\"#找出index-维护SQL\" class=\"headerlink\" title=\"找出index 维护SQL\"></a>找出index 维护SQL</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">select</span><br>        <span class=\"hljs-keyword\">CASE</span><br>                <span class=\"hljs-keyword\">WHEN</span> flag = <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">THEN</span><br>                        <span class=\"hljs-keyword\">CASE</span><br>                        <span class=\"hljs-keyword\">WHEN</span> indexdef !~ <span class=\"hljs-string\">&#x27; WHERE &#x27;</span> <span class=\"hljs-keyword\">THEN</span><br>                                regexp_replace(indexdef, E<span class=\"hljs-string\">&#x27;(INDEX )(.+)( ON )(.+\\\\)\\$)&#x27;</span>  ,E<span class=\"hljs-string\">&#x27; \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default &#x27;</span>,<span class=\"hljs-string\">&#x27;g&#x27;</span>) ||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>                        <span class=\"hljs-keyword\">ELSE</span><br>                                regexp_replace(indexdef, E<span class=\"hljs-string\">&#x27;(INDEX )(.+)( ON )(.+)( WHERE )&#x27;</span>  ,E<span class=\"hljs-string\">&#x27; \\\\1 CONCURRENTLY \\\\3 \\\\4 TABLESPACE  pg_default \\\\5 &#x27;</span>,<span class=\"hljs-string\">&#x27;g&#x27;</span>) ||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>                        <span class=\"hljs-keyword\">END</span><br>                <span class=\"hljs-keyword\">WHEN</span> flag = <span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">THEN</span><br>                                <span class=\"hljs-string\">&#x27;ANALYZE VERBOSE &#x27;</span>||schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||tablename||<span class=\"hljs-string\">&#x27; ; select pg_sleep(600) ; DROP INDEX CONCURRENTLY IF EXISTS &#x27;</span>||schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname||<span class=\"hljs-string\">&#x27;; &#x27;</span><br>        <span class=\"hljs-keyword\">END</span><br><span class=\"hljs-keyword\">from</span><br>        (<br>        <span class=\"hljs-keyword\">select</span><br>                generate_series(<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> flag,<br>                indexdef,<br>                indexname,<br>                tablename,<br>                pi.schemaname<br>        <span class=\"hljs-keyword\">from</span><br>                pg_indexes <span class=\"hljs-keyword\">pi</span><br>        <span class=\"hljs-keyword\">join</span><br>                pg_namespace n<br>          <span class=\"hljs-keyword\">on</span><br>                pi.schemaname = n.nspname<br>        <span class=\"hljs-keyword\">join</span><br>                pg_class pcl<br>          <span class=\"hljs-keyword\">on</span><br>                pcl.relnamespace = n.oid<br>                <span class=\"hljs-keyword\">and</span> pcl.relname = pi.tablename<br>        <span class=\"hljs-keyword\">left</span> <span class=\"hljs-keyword\">join</span><br>                pg_constraint pco<br>          <span class=\"hljs-keyword\">on</span><br>                pco.conname = pi.indexname<br>                <span class=\"hljs-keyword\">and</span> pco.conrelid = pcl.oid<br>        <span class=\"hljs-keyword\">where</span><br>                (pi.schemaname, pi.tablename) = (<span class=\"hljs-string\">&#x27;mirror&#x27;</span>,<span class=\"hljs-string\">&#x27;b2c_order&#x27;</span>)<br>                <span class=\"hljs-keyword\">and</span> pco.contype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span>  <span class=\"hljs-string\">&#x27;p&#x27;</span><br>                <span class=\"hljs-keyword\">and</span> pco.contype <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">distinct</span> <span class=\"hljs-keyword\">from</span>  <span class=\"hljs-string\">&#x27;u&#x27;</span><br>        <span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>                pi.schemaname, tablename, indexname, pg_table_size(schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname::<span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">desc</span>, flag <span class=\"hljs-keyword\">asc</span><br>        ) <span class=\"hljs-keyword\">as</span> foo<br><span class=\"hljs-keyword\">order</span> <span class=\"hljs-keyword\">by</span><br>       schemaname, tablename, indexname, pg_table_size(schemaname||<span class=\"hljs-string\">&#x27;.&#x27;</span>||indexname::<span class=\"hljs-built_in\">text</span>) <span class=\"hljs-keyword\">desc</span>, flag <span class=\"hljs-keyword\">asc</span><br>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://github.com/digoal/blog/blob/master/202005/20200509_02.md\">德哥</a></p>"},{"title":"Linux 命令记录","date":"2020-08-19T03:15:42.000Z","top":26,"description":null,"password":null,"_content":"\n记录一些工作中遇到的命令.\n\n<!-- more -->\n\n\n# 查找ip 对应的条数以及主机名\n```\n########   pgbouncer\n[postgres@l-pgb1zzzz ~]$ psql -Upostgres -d pgbouncer -Atc \"show clients\"|awk -F \"|\" '{print $5}'|grep \"^1\"|sort|uniq -c|sort -nk 1|awk '{printf(\"%s %s \", $1, $2); cmd=\"host \"$2; system(cmd)}'|awk '{printf(\"%5s %15s %s \\n\", $1,$2,$7)}'\n    1 192.86.238.131 host1\n    1 192.88.105.131 host2\n    8 192168.254.191 host1\n[postgres@l-pgb1zzzz ~]$\n\n\n####### postgresql\n[postgres@l-grpendb2.cc.cna ~]$ psql -Atc \"select client_addr from pg_stat_activity where client_addr is not null\" | sort|uniq -c| awk '{printf(\"%s %s \",$1,$2);cmd=\"host \"$2; system(cmd)}'|awk '{printf(\"%10s %20s %s\\n\",$1,$2,$7)}'|sort -k 3\n         1         19288.101.77 l-callcenter14.h.cn6\n         1         19286.236.29 l-host14.xxxx\n         1         19290.4.23   l-host1.yyyy\n         1         19290.15.110 l-host7.yyyy\n         1         19290.15.111 l-host8.yyyy\n```\n\n# PostgreSQL日志变成一行\n```\nawk '{if ($0 !~  \"^[\\t]\") printf(\"\\n%s\" ,$0); else printf $0}' postgresql-Tue.log\nzcat postgresql-2013-02-2*.log.gz | perl -e 'while(<>){ if($_ !~ /^\\t/ig) { chomp; print \"\\n\",$_;} else {chomp; print;}}' |less\n```\n\n# 磁盘读写测试\n```\n$ sudo hdparm -tT --direct /dev/nvme0n1p2\n\n/dev/nvme0n1p2:\n Timing O_DIRECT cached reads:   2284 MB in  2.00 seconds = 1142.33 MB/sec\n Timing O_DIRECT disk reads: 100 MB in  0.08 seconds = 1226.93 MB/sec\n\n# 顺序同步写入\n$ time dd if=/dev/zero of=test bs=8k count=5120 oflag=dsync\n5120+0 records in\n5120+0 records out\n41943040 bytes (42 MB, 40 MiB) copied, 4.98705 s, 8.4 MB/s\n\nreal\t0m4.993s\nuser\t0m0.019s\nsys\t0m0.872s\n\n# 顺序写入 \n$ time dd if=/dev/zero of=test bs=8k count=1000000\n1000000+0 records in\n1000000+0 records out\n8192000000 bytes (8.2 GB, 7.6 GiB) copied, 10.7331 s, 763 MB/s\n\nreal\t0m10.743s\nuser\t0m0.189s\nsys\t0m6.423s\n\n# 顺序读取\n$ time dd if=test of=/dev/null bs=8k\n1000000+0 records in\n1000000+0 records out\n8192000000 bytes (8.2 GB, 7.6 GiB) copied, 10.7331 s, 763 MB/s\n\nreal\t0m10.743s\nuser\t0m0.189s\nsys\t0m6.423s\n```\n\n# 启用/禁用CPU\n```\n$ sudo chcpu -d 3\nCPU 3 disabled\n$ sudo chcpu -e 3\nCPU 3 enabled\n\n```\n# 增加/删除IP\n```\n# ip a a local 192.168.0.25/32 brd + dev bond0 && arping -q -c 3 -U -I  bond0 192.168.0.25\n\n# ip a d local 192.168.0.25/32 brd + dev bond0\n\n```\n","source":"_posts/Linux_cmd_summary.md","raw":"---\ntitle: Linux 命令记录\ndate: 2020-08-19 11:15:42\ntags: \n- Linux\n- command\ncategories:\n- Linux\ntop: 26\ndescription: \npassword: \n\n---\n\n记录一些工作中遇到的命令.\n\n<!-- more -->\n\n\n# 查找ip 对应的条数以及主机名\n```\n########   pgbouncer\n[postgres@l-pgb1zzzz ~]$ psql -Upostgres -d pgbouncer -Atc \"show clients\"|awk -F \"|\" '{print $5}'|grep \"^1\"|sort|uniq -c|sort -nk 1|awk '{printf(\"%s %s \", $1, $2); cmd=\"host \"$2; system(cmd)}'|awk '{printf(\"%5s %15s %s \\n\", $1,$2,$7)}'\n    1 192.86.238.131 host1\n    1 192.88.105.131 host2\n    8 192168.254.191 host1\n[postgres@l-pgb1zzzz ~]$\n\n\n####### postgresql\n[postgres@l-grpendb2.cc.cna ~]$ psql -Atc \"select client_addr from pg_stat_activity where client_addr is not null\" | sort|uniq -c| awk '{printf(\"%s %s \",$1,$2);cmd=\"host \"$2; system(cmd)}'|awk '{printf(\"%10s %20s %s\\n\",$1,$2,$7)}'|sort -k 3\n         1         19288.101.77 l-callcenter14.h.cn6\n         1         19286.236.29 l-host14.xxxx\n         1         19290.4.23   l-host1.yyyy\n         1         19290.15.110 l-host7.yyyy\n         1         19290.15.111 l-host8.yyyy\n```\n\n# PostgreSQL日志变成一行\n```\nawk '{if ($0 !~  \"^[\\t]\") printf(\"\\n%s\" ,$0); else printf $0}' postgresql-Tue.log\nzcat postgresql-2013-02-2*.log.gz | perl -e 'while(<>){ if($_ !~ /^\\t/ig) { chomp; print \"\\n\",$_;} else {chomp; print;}}' |less\n```\n\n# 磁盘读写测试\n```\n$ sudo hdparm -tT --direct /dev/nvme0n1p2\n\n/dev/nvme0n1p2:\n Timing O_DIRECT cached reads:   2284 MB in  2.00 seconds = 1142.33 MB/sec\n Timing O_DIRECT disk reads: 100 MB in  0.08 seconds = 1226.93 MB/sec\n\n# 顺序同步写入\n$ time dd if=/dev/zero of=test bs=8k count=5120 oflag=dsync\n5120+0 records in\n5120+0 records out\n41943040 bytes (42 MB, 40 MiB) copied, 4.98705 s, 8.4 MB/s\n\nreal\t0m4.993s\nuser\t0m0.019s\nsys\t0m0.872s\n\n# 顺序写入 \n$ time dd if=/dev/zero of=test bs=8k count=1000000\n1000000+0 records in\n1000000+0 records out\n8192000000 bytes (8.2 GB, 7.6 GiB) copied, 10.7331 s, 763 MB/s\n\nreal\t0m10.743s\nuser\t0m0.189s\nsys\t0m6.423s\n\n# 顺序读取\n$ time dd if=test of=/dev/null bs=8k\n1000000+0 records in\n1000000+0 records out\n8192000000 bytes (8.2 GB, 7.6 GiB) copied, 10.7331 s, 763 MB/s\n\nreal\t0m10.743s\nuser\t0m0.189s\nsys\t0m6.423s\n```\n\n# 启用/禁用CPU\n```\n$ sudo chcpu -d 3\nCPU 3 disabled\n$ sudo chcpu -e 3\nCPU 3 enabled\n\n```\n# 增加/删除IP\n```\n# ip a a local 192.168.0.25/32 brd + dev bond0 && arping -q -c 3 -U -I  bond0 192.168.0.25\n\n# ip a d local 192.168.0.25/32 brd + dev bond0\n\n```\n","slug":"Linux_cmd_summary","published":1,"updated":"2021-03-11T04:08:38.292Z","_id":"cklw1fzgv0000pieb7p55ec0i","comments":1,"layout":"post","photos":[],"link":"","content":"<p>记录一些工作中遇到的命令.</p>\n<a id=\"more\"></a>\n<h1 id=\"查找ip-对应的条数以及主机名\"><a href=\"#查找ip-对应的条数以及主机名\" class=\"headerlink\" title=\"查找ip 对应的条数以及主机名\"></a>查找ip 对应的条数以及主机名</h1><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">########   pgbouncer<br>[postgres@l-pgb1zzzz ~]$ psql -Upostgres -d pgbouncer -Atc <span class=\"hljs-string\">&quot;show clients&quot;</span>|awk -F <span class=\"hljs-string\">&quot;|&quot;</span> &#x27;&#123;print $<span class=\"hljs-number\">5</span>&#125;&#x27;|grep <span class=\"hljs-string\">&quot;^1&quot;</span>|sort|uniq -c|sort -nk <span class=\"hljs-number\">1</span>|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%s %s &quot;</span>, $<span class=\"hljs-number\">1</span>, $<span class=\"hljs-number\">2</span>); cmd=<span class=\"hljs-string\">&quot;host &quot;</span>$<span class=\"hljs-number\">2</span>; system(cmd)&#125;&#x27;|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%5s %15s %s <span class=\"hljs-subst\">\\n</span>&quot;</span>, $<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>,$<span class=\"hljs-number\">7</span>)&#125;&#x27;<br>    <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">192.86</span><span class=\"hljs-number\">.238</span><span class=\"hljs-number\">.131</span> host1<br>    <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">192.88</span><span class=\"hljs-number\">.105</span><span class=\"hljs-number\">.131</span> host2<br>    <span class=\"hljs-number\">8</span> <span class=\"hljs-number\">192168.254</span><span class=\"hljs-number\">.191</span> host1<br>[postgres@l-pgb1zzzz ~]$<br><br><br>####### postgresql<br>[postgres@l-grpendb2.cc.cna ~]$ psql -Atc <span class=\"hljs-string\">&quot;select client_addr from pg_stat_activity where client_addr is not null&quot;</span> | sort|uniq -c| awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%s %s &quot;</span>,$<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>);cmd=<span class=\"hljs-string\">&quot;host &quot;</span>$<span class=\"hljs-number\">2</span>; system(cmd)&#125;&#x27;|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%10s %20s %s<span class=\"hljs-subst\">\\n</span>&quot;</span>,$<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>,$<span class=\"hljs-number\">7</span>)&#125;&#x27;|sort -k <span class=\"hljs-number\">3</span><br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19288.101</span><span class=\"hljs-number\">.77</span> l-callcenter14.h.cn6<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19286.236</span><span class=\"hljs-number\">.29</span> l-host14.xxxx<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.4</span><span class=\"hljs-number\">.23</span>   l-host1.yyyy<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.15</span><span class=\"hljs-number\">.110</span> l-host7.yyyy<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.15</span><span class=\"hljs-number\">.111</span> l-host8.yyyy<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL日志变成一行\"><a href=\"#PostgreSQL日志变成一行\" class=\"headerlink\" title=\"PostgreSQL日志变成一行\"></a>PostgreSQL日志变成一行</h1><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">awk &#x27;&#123;<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$0</span> !~  <span class=\"hljs-string\">&quot;^[\\t]&quot;</span>) printf(<span class=\"hljs-string\">&quot;\\n%s&quot;</span> ,<span class=\"hljs-variable\">$0</span>); <span class=\"hljs-keyword\">else</span> printf <span class=\"hljs-variable\">$0&#125;</span>&#x27; postgresql-Tue.<span class=\"hljs-keyword\">log</span><br>zcat postgresql-2013-02-2*.<span class=\"hljs-keyword\">log</span>.gz | perl -<span class=\"hljs-keyword\">e</span> &#x27;<span class=\"hljs-keyword\">while</span>(&lt;&gt;)&#123; <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$_</span> !~ /^\\t/ig) &#123; chomp; <span class=\"hljs-keyword\">print</span> <span class=\"hljs-string\">&quot;\\n&quot;</span>,<span class=\"hljs-variable\">$_</span>;&#125; <span class=\"hljs-keyword\">else</span> &#123;chomp; <span class=\"hljs-keyword\">print</span>;&#125;&#125;&#x27; |less<br></code></pre></td></tr></table></figure>\n<h1 id=\"磁盘读写测试\"><a href=\"#磁盘读写测试\" class=\"headerlink\" title=\"磁盘读写测试\"></a>磁盘读写测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">$ sudo hdparm -tT --direct /dev/nvme0n1p2<br><br>/dev/nvme0n1p2:<br> Timing O_DIRECT cached reads:   <span class=\"hljs-number\">2284</span> MB <span class=\"hljs-keyword\">in</span>  <span class=\"hljs-number\">2.00</span> seconds = <span class=\"hljs-number\">1142.33</span> MB/sec<br> Timing O_DIRECT disk reads: <span class=\"hljs-number\">100</span> MB <span class=\"hljs-keyword\">in</span>  <span class=\"hljs-number\">0.08</span> seconds = <span class=\"hljs-number\">1226.93</span> MB/sec<br><br># 顺序同步写入<br>$ time dd <span class=\"hljs-keyword\">if</span>=/dev/zero of=test bs=<span class=\"hljs-number\">8</span>k count=<span class=\"hljs-number\">5120</span> oflag=dsync<br><span class=\"hljs-number\">5120</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">5120</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">41943040</span> bytes (<span class=\"hljs-number\">42</span> MB, <span class=\"hljs-number\">40</span> MiB) copied, <span class=\"hljs-number\">4.98705</span> s, <span class=\"hljs-number\">8.4</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m4<span class=\"hljs-number\">.993</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.019</span>s<br>sys    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.872</span>s<br><br># 顺序写入 <br>$ time dd <span class=\"hljs-keyword\">if</span>=/dev/zero of=test bs=<span class=\"hljs-number\">8</span>k count=<span class=\"hljs-number\">1000000</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">8192000000</span> bytes (<span class=\"hljs-number\">8.2</span> GB, <span class=\"hljs-number\">7.6</span> GiB) copied, <span class=\"hljs-number\">10.7331</span> s, <span class=\"hljs-number\">763</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m10<span class=\"hljs-number\">.743</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.189</span>s<br>sys    <span class=\"hljs-number\">0</span>m6<span class=\"hljs-number\">.423</span>s<br><br># 顺序读取<br>$ time dd <span class=\"hljs-keyword\">if</span>=test of=/dev/<span class=\"hljs-literal\">null</span> bs=<span class=\"hljs-number\">8</span>k<br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">8192000000</span> bytes (<span class=\"hljs-number\">8.2</span> GB, <span class=\"hljs-number\">7.6</span> GiB) copied, <span class=\"hljs-number\">10.7331</span> s, <span class=\"hljs-number\">763</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m10<span class=\"hljs-number\">.743</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.189</span>s<br>sys    <span class=\"hljs-number\">0</span>m6<span class=\"hljs-number\">.423</span>s<br></code></pre></td></tr></table></figure>\n<h1 id=\"启用-禁用CPU\"><a href=\"#启用-禁用CPU\" class=\"headerlink\" title=\"启用/禁用CPU\"></a>启用/禁用CPU</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">$ sudo chcpu -d <span class=\"hljs-number\">3</span><br>CPU <span class=\"hljs-number\">3</span> disabled<br>$ sudo chcpu -e <span class=\"hljs-number\">3</span><br>CPU <span class=\"hljs-number\">3</span> enabled<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"增加-删除IP\"><a href=\"#增加-删除IP\" class=\"headerlink\" title=\"增加/删除IP\"></a>增加/删除IP</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"># ip a a local <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span>/<span class=\"hljs-number\">32</span> brd + dev bond0 &amp;&amp; arping -q -c <span class=\"hljs-number\">3</span> -U -I  bond0 <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span><br><br># ip a d local <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span>/<span class=\"hljs-number\">32</span> brd + dev bond0<br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>记录一些工作中遇到的命令.</p>","more":"<h1 id=\"查找ip-对应的条数以及主机名\"><a href=\"#查找ip-对应的条数以及主机名\" class=\"headerlink\" title=\"查找ip 对应的条数以及主机名\"></a>查找ip 对应的条数以及主机名</h1><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">########   pgbouncer<br>[postgres@l-pgb1zzzz ~]$ psql -Upostgres -d pgbouncer -Atc <span class=\"hljs-string\">&quot;show clients&quot;</span>|awk -F <span class=\"hljs-string\">&quot;|&quot;</span> &#x27;&#123;print $<span class=\"hljs-number\">5</span>&#125;&#x27;|grep <span class=\"hljs-string\">&quot;^1&quot;</span>|sort|uniq -c|sort -nk <span class=\"hljs-number\">1</span>|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%s %s &quot;</span>, $<span class=\"hljs-number\">1</span>, $<span class=\"hljs-number\">2</span>); cmd=<span class=\"hljs-string\">&quot;host &quot;</span>$<span class=\"hljs-number\">2</span>; system(cmd)&#125;&#x27;|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%5s %15s %s <span class=\"hljs-subst\">\\n</span>&quot;</span>, $<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>,$<span class=\"hljs-number\">7</span>)&#125;&#x27;<br>    <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">192.86</span><span class=\"hljs-number\">.238</span><span class=\"hljs-number\">.131</span> host1<br>    <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">192.88</span><span class=\"hljs-number\">.105</span><span class=\"hljs-number\">.131</span> host2<br>    <span class=\"hljs-number\">8</span> <span class=\"hljs-number\">192168.254</span><span class=\"hljs-number\">.191</span> host1<br>[postgres@l-pgb1zzzz ~]$<br><br><br>####### postgresql<br>[postgres@l-grpendb2.cc.cna ~]$ psql -Atc <span class=\"hljs-string\">&quot;select client_addr from pg_stat_activity where client_addr is not null&quot;</span> | sort|uniq -c| awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%s %s &quot;</span>,$<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>);cmd=<span class=\"hljs-string\">&quot;host &quot;</span>$<span class=\"hljs-number\">2</span>; system(cmd)&#125;&#x27;|awk &#x27;&#123;printf(<span class=\"hljs-string\">&quot;%10s %20s %s<span class=\"hljs-subst\">\\n</span>&quot;</span>,$<span class=\"hljs-number\">1</span>,$<span class=\"hljs-number\">2</span>,$<span class=\"hljs-number\">7</span>)&#125;&#x27;|sort -k <span class=\"hljs-number\">3</span><br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19288.101</span><span class=\"hljs-number\">.77</span> l-callcenter14.h.cn6<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19286.236</span><span class=\"hljs-number\">.29</span> l-host14.xxxx<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.4</span><span class=\"hljs-number\">.23</span>   l-host1.yyyy<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.15</span><span class=\"hljs-number\">.110</span> l-host7.yyyy<br>         <span class=\"hljs-number\">1</span>         <span class=\"hljs-number\">19290.15</span><span class=\"hljs-number\">.111</span> l-host8.yyyy<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL日志变成一行\"><a href=\"#PostgreSQL日志变成一行\" class=\"headerlink\" title=\"PostgreSQL日志变成一行\"></a>PostgreSQL日志变成一行</h1><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">awk &#x27;&#123;<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$0</span> !~  <span class=\"hljs-string\">&quot;^[\\t]&quot;</span>) printf(<span class=\"hljs-string\">&quot;\\n%s&quot;</span> ,<span class=\"hljs-variable\">$0</span>); <span class=\"hljs-keyword\">else</span> printf <span class=\"hljs-variable\">$0&#125;</span>&#x27; postgresql-Tue.<span class=\"hljs-keyword\">log</span><br>zcat postgresql-2013-02-2*.<span class=\"hljs-keyword\">log</span>.gz | perl -<span class=\"hljs-keyword\">e</span> &#x27;<span class=\"hljs-keyword\">while</span>(&lt;&gt;)&#123; <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$_</span> !~ /^\\t/ig) &#123; chomp; <span class=\"hljs-keyword\">print</span> <span class=\"hljs-string\">&quot;\\n&quot;</span>,<span class=\"hljs-variable\">$_</span>;&#125; <span class=\"hljs-keyword\">else</span> &#123;chomp; <span class=\"hljs-keyword\">print</span>;&#125;&#125;&#x27; |less<br></code></pre></td></tr></table></figure>\n<h1 id=\"磁盘读写测试\"><a href=\"#磁盘读写测试\" class=\"headerlink\" title=\"磁盘读写测试\"></a>磁盘读写测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">$ sudo hdparm -tT --direct /dev/nvme0n1p2<br><br>/dev/nvme0n1p2:<br> Timing O_DIRECT cached reads:   <span class=\"hljs-number\">2284</span> MB <span class=\"hljs-keyword\">in</span>  <span class=\"hljs-number\">2.00</span> seconds = <span class=\"hljs-number\">1142.33</span> MB/sec<br> Timing O_DIRECT disk reads: <span class=\"hljs-number\">100</span> MB <span class=\"hljs-keyword\">in</span>  <span class=\"hljs-number\">0.08</span> seconds = <span class=\"hljs-number\">1226.93</span> MB/sec<br><br># 顺序同步写入<br>$ time dd <span class=\"hljs-keyword\">if</span>=/dev/zero of=test bs=<span class=\"hljs-number\">8</span>k count=<span class=\"hljs-number\">5120</span> oflag=dsync<br><span class=\"hljs-number\">5120</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">5120</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">41943040</span> bytes (<span class=\"hljs-number\">42</span> MB, <span class=\"hljs-number\">40</span> MiB) copied, <span class=\"hljs-number\">4.98705</span> s, <span class=\"hljs-number\">8.4</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m4<span class=\"hljs-number\">.993</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.019</span>s<br>sys    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.872</span>s<br><br># 顺序写入 <br>$ time dd <span class=\"hljs-keyword\">if</span>=/dev/zero of=test bs=<span class=\"hljs-number\">8</span>k count=<span class=\"hljs-number\">1000000</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">8192000000</span> bytes (<span class=\"hljs-number\">8.2</span> GB, <span class=\"hljs-number\">7.6</span> GiB) copied, <span class=\"hljs-number\">10.7331</span> s, <span class=\"hljs-number\">763</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m10<span class=\"hljs-number\">.743</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.189</span>s<br>sys    <span class=\"hljs-number\">0</span>m6<span class=\"hljs-number\">.423</span>s<br><br># 顺序读取<br>$ time dd <span class=\"hljs-keyword\">if</span>=test of=/dev/<span class=\"hljs-literal\">null</span> bs=<span class=\"hljs-number\">8</span>k<br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">in</span><br><span class=\"hljs-number\">1000000</span>+<span class=\"hljs-number\">0</span> records <span class=\"hljs-keyword\">out</span><br><span class=\"hljs-number\">8192000000</span> bytes (<span class=\"hljs-number\">8.2</span> GB, <span class=\"hljs-number\">7.6</span> GiB) copied, <span class=\"hljs-number\">10.7331</span> s, <span class=\"hljs-number\">763</span> MB/s<br><br>real    <span class=\"hljs-number\">0</span>m10<span class=\"hljs-number\">.743</span>s<br>user    <span class=\"hljs-number\">0</span>m0<span class=\"hljs-number\">.189</span>s<br>sys    <span class=\"hljs-number\">0</span>m6<span class=\"hljs-number\">.423</span>s<br></code></pre></td></tr></table></figure>\n<h1 id=\"启用-禁用CPU\"><a href=\"#启用-禁用CPU\" class=\"headerlink\" title=\"启用/禁用CPU\"></a>启用/禁用CPU</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">$ sudo chcpu -d <span class=\"hljs-number\">3</span><br>CPU <span class=\"hljs-number\">3</span> disabled<br>$ sudo chcpu -e <span class=\"hljs-number\">3</span><br>CPU <span class=\"hljs-number\">3</span> enabled<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"增加-删除IP\"><a href=\"#增加-删除IP\" class=\"headerlink\" title=\"增加/删除IP\"></a>增加/删除IP</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"># ip a a local <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span>/<span class=\"hljs-number\">32</span> brd + dev bond0 &amp;&amp; arping -q -c <span class=\"hljs-number\">3</span> -U -I  bond0 <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span><br><br># ip a d local <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.25</span>/<span class=\"hljs-number\">32</span> brd + dev bond0<br><br></code></pre></td></tr></table></figure>"},{"title":"PostGIS 操作geometry方法","date":"2020-12-24T07:42:57.000Z","top":26,"description":null,"password":null,"_content":"\n记录Postgis常用方法.\n\n<!-- more -->\n\n# WKT定义几何对象格式：\n```\nPOINT(0 0) ——点\nLINESTRING(0 0,1 1,1 2) ——线\nPOLYGON((0 0,4 0,4 4,0 4,0 0),(1 1, 2 1, 2 2, 1 2,1 1)) ——面\nMULTIPOINT(0 0,1 2) ——多点\nMULTILINESTRING((0 0,1 1,1 2),(2 3,3 2,5 4)) ——多线\nMULTIPOLYGON(((0 0,4 0,4 4,0 4,0 0),(1 1,2 1,2 2,1 2,1 1)), ((-1 -1,-1 -2,-2 -2,-2 -1,-1 -1))) ——多面\nGEOMETRYCOLLECTION(POINT(2 3),LINESTRING((2 3,3 4))) ——几何集合\n```\n\n# 常用函数：\n\n```\nwkt转geometry st_geomfromtext(wkt,wkid)\ngeometry转wkt st_astext(geom)\n获取点对象x、y坐标值 st_x(geom)、st_y(geom)\n获取线/面对象四至 st_xmin(geom)、st_ymin(geom)、st_xmax(geom)、st_ymax(geom)\n计算两点之间距离 st_distance(geom,geom) / st_distance(wkt,wkt)\n计算线的长度 st_length(geom) / st_length(wkt)\n计算面积 st_area(geom) / st_area(wkt)\n缓冲区计算 st_buffer(geom,distance) / st_buffer(wkt,distance)\n\n```\n\n\n# 管理函数\n\n```\n添加几何字段 AddGeometryColumn(, , , , , )\n删除几何字段 DropGeometryColumn(, , )\n检查数据库几何字段并在geometry_columns中归档 Probe_Geometry_Columns()\n给几何对象设置空间参考（在通过一个范围做空间查询时常用） ST_SetSRID(geometry, integer)\n```\n\n# 几何对象关系函数\n```\n获取两个几何对象间的距离 ST_Distance(geometry, geometry)\n如果两个几何对象间距离在给定值范围内，则返回TRUE ST_DWithin(geometry, geometry, float)\n判断两个几何对象是否相等\n（比如LINESTRING(0 0, 2 2)和LINESTRING(0 0, 1 1, 2 2)是相同的几何对象） ST_Equals(geometry, geometry)\n判断两个几何对象是否分离 ST_Disjoint(geometry, geometry)\n判断两个几何对象是否相交 ST_Intersects(geometry, geometry)\n判断两个几何对象的边缘是否接触 ST_Touches(geometry, geometry)\n判断两个几何对象是否互相穿过 ST_Crosses(geometry, geometry)\n判断A是否被B包含 ST_Within(geometry A, geometry B)\n判断两个几何对象是否是重叠 ST_Overlaps(geometry, geometry)\n判断A是否包含B ST_Contains(geometry A, geometry B)\n判断A是否覆盖 B ST_Covers(geometry A, geometry B)\n判断A是否被B所覆盖 ST_CoveredBy(geometry A, geometry B)\n通过DE-9IM 矩阵判断两个几何对象的关系是否成立 ST_Relate(geometry, geometry, intersectionPatternMatrix)\n获得两个几何对象的关系（DE-9IM矩阵） ST_Relate(geometry, geometry)\n```\n\n#几何对象处理函数：\n```\n获取几何对象的中心 ST_Centroid(geometry)\n面积量测 ST_Area(geometry)\n长度量测 ST_Length(geometry)\n返回曲面上的一个点 ST_PointOnSurface(geometry)\n获取边界 ST_Boundary(geometry)\n获取缓冲后的几何对象 ST_Buffer(geometry, double, [integer])\n获取多几何对象的外接对象 ST_ConvexHull(geometry)\n获取两个几何对象相交的部分 ST_Intersection(geometry, geometry)\n将经度小于0的值加360使所有经度值在0-360间 ST_Shift_Longitude(geometry)\n获取两个几何对象不相交的部分（A、B可互换） ST_SymDifference(geometry A, geometry B)\n从A去除和B相交的部分后返回 ST_Difference(geometry A, geometry B)\n返回两个几何对象的合并结果 ST_Union(geometry, geometry)\n返回一系列几何对象的合并结果 ST_Union(geometry set)\n用较少的内存和较长的时间完成合并操作，结果和ST_Union相同 ST_MemUnion(geometry set)\n```\n\n# 几何对象存取函数\n```\n获取几何对象的WKT描述 ST_AsText(geometry)\n获取几何对象的WKB描述 ST_AsBinary(geometry)\n获取几何对象的空间参考ID ST_SRID(geometry)\n获取几何对象的维数 ST_Dimension(geometry)\n获取几何对象的边界范围 ST_Envelope(geometry)\n判断几何对象是否为空 ST_IsEmpty(geometry)\n判断几何对象是否不包含特殊点（比如自相交） ST_IsSimple(geometry)\n判断几何对象是否闭合 ST_IsClosed(geometry)\n判断曲线是否闭合并且不包含特殊点 ST_IsRing(geometry)\n获取多几何对象中的对象个数 ST_NumGeometries(geometry)\n获取多几何对象中第N个对象 ST_GeometryN(geometry,int)\n获取几何对象中的点个数 ST_NumPoints(geometry)\n获取几何对象的第N个点 ST_PointN(geometry,integer)\n获取多边形的外边缘 ST_ExteriorRing(geometry)\n获取多边形内边界个数 ST_NumInteriorRings(geometry)\n同上 ST_NumInteriorRing(geometry)\n获取多边形的第N个内边界 ST_InteriorRingN(geometry,integer)\n获取线的终点 ST_EndPoint(geometry)\n获取线的起始点 ST_StartPoint(geometry)\n获取几何对象的类型 GeometryType(geometry)\n类似上，但是不检查M值，即POINTM对象会被判断为point ST_GeometryType(geometry)\n获取点的X坐标 ST_X(geometry)\n获取点的Y坐标 ST_Y(geometry)\n获取点的Z坐标 ST_Z(geometry)\n获取点的M值 ST_M(geometry)\n```\n\n# 几何对象构造函数\n```\n参考语义\nText：WKT\nWKB：WKB\nGeom:Geometry\nM:Multi\nBd:BuildArea\nColl:Collection ST_GeomFromText(text,[])\n\nST_PointFromText(text,[])\nST_LineFromText(text,[])\nST_LinestringFromText(text,[])\nST_PolyFromText(text,[])\nST_PolygonFromText(text,[])\nST_MPointFromText(text,[])\nST_MLineFromText(text,[])\nST_MPolyFromText(text,[])\nST_GeomCollFromText(text,[])\nST_GeomFromWKB(bytea,[])\nST_GeometryFromWKB(bytea,[])\nST_PointFromWKB(bytea,[])\nST_LineFromWKB(bytea,[])\nST_LinestringFromWKB(bytea,[])\nST_PolyFromWKB(bytea,[])\nST_PolygonFromWKB(bytea,[])\nST_MPointFromWKB(bytea,[])\nST_MLineFromWKB(bytea,[])\nST_MPolyFromWKB(bytea,[])\nST_GeomCollFromWKB(bytea,[])\nST_BdPolyFromText(text WKT, integer SRID)\nST_BdMPolyFromText(text WKT, integer SRID)\n```\n","source":"_posts/Postgis常用函数.md","raw":"---\ntitle: PostGIS 操作geometry方法\ndate: 2020-12-24 15:42:57\ntags: \n- gis\n- postgis\n- PostgreSQL\ncategories: \n- PostgreSQL\n- gis\n- Postgis\ntop: 26\ndescription: \npassword: \n\n---\n\n记录Postgis常用方法.\n\n<!-- more -->\n\n# WKT定义几何对象格式：\n```\nPOINT(0 0) ——点\nLINESTRING(0 0,1 1,1 2) ——线\nPOLYGON((0 0,4 0,4 4,0 4,0 0),(1 1, 2 1, 2 2, 1 2,1 1)) ——面\nMULTIPOINT(0 0,1 2) ——多点\nMULTILINESTRING((0 0,1 1,1 2),(2 3,3 2,5 4)) ——多线\nMULTIPOLYGON(((0 0,4 0,4 4,0 4,0 0),(1 1,2 1,2 2,1 2,1 1)), ((-1 -1,-1 -2,-2 -2,-2 -1,-1 -1))) ——多面\nGEOMETRYCOLLECTION(POINT(2 3),LINESTRING((2 3,3 4))) ——几何集合\n```\n\n# 常用函数：\n\n```\nwkt转geometry st_geomfromtext(wkt,wkid)\ngeometry转wkt st_astext(geom)\n获取点对象x、y坐标值 st_x(geom)、st_y(geom)\n获取线/面对象四至 st_xmin(geom)、st_ymin(geom)、st_xmax(geom)、st_ymax(geom)\n计算两点之间距离 st_distance(geom,geom) / st_distance(wkt,wkt)\n计算线的长度 st_length(geom) / st_length(wkt)\n计算面积 st_area(geom) / st_area(wkt)\n缓冲区计算 st_buffer(geom,distance) / st_buffer(wkt,distance)\n\n```\n\n\n# 管理函数\n\n```\n添加几何字段 AddGeometryColumn(, , , , , )\n删除几何字段 DropGeometryColumn(, , )\n检查数据库几何字段并在geometry_columns中归档 Probe_Geometry_Columns()\n给几何对象设置空间参考（在通过一个范围做空间查询时常用） ST_SetSRID(geometry, integer)\n```\n\n# 几何对象关系函数\n```\n获取两个几何对象间的距离 ST_Distance(geometry, geometry)\n如果两个几何对象间距离在给定值范围内，则返回TRUE ST_DWithin(geometry, geometry, float)\n判断两个几何对象是否相等\n（比如LINESTRING(0 0, 2 2)和LINESTRING(0 0, 1 1, 2 2)是相同的几何对象） ST_Equals(geometry, geometry)\n判断两个几何对象是否分离 ST_Disjoint(geometry, geometry)\n判断两个几何对象是否相交 ST_Intersects(geometry, geometry)\n判断两个几何对象的边缘是否接触 ST_Touches(geometry, geometry)\n判断两个几何对象是否互相穿过 ST_Crosses(geometry, geometry)\n判断A是否被B包含 ST_Within(geometry A, geometry B)\n判断两个几何对象是否是重叠 ST_Overlaps(geometry, geometry)\n判断A是否包含B ST_Contains(geometry A, geometry B)\n判断A是否覆盖 B ST_Covers(geometry A, geometry B)\n判断A是否被B所覆盖 ST_CoveredBy(geometry A, geometry B)\n通过DE-9IM 矩阵判断两个几何对象的关系是否成立 ST_Relate(geometry, geometry, intersectionPatternMatrix)\n获得两个几何对象的关系（DE-9IM矩阵） ST_Relate(geometry, geometry)\n```\n\n#几何对象处理函数：\n```\n获取几何对象的中心 ST_Centroid(geometry)\n面积量测 ST_Area(geometry)\n长度量测 ST_Length(geometry)\n返回曲面上的一个点 ST_PointOnSurface(geometry)\n获取边界 ST_Boundary(geometry)\n获取缓冲后的几何对象 ST_Buffer(geometry, double, [integer])\n获取多几何对象的外接对象 ST_ConvexHull(geometry)\n获取两个几何对象相交的部分 ST_Intersection(geometry, geometry)\n将经度小于0的值加360使所有经度值在0-360间 ST_Shift_Longitude(geometry)\n获取两个几何对象不相交的部分（A、B可互换） ST_SymDifference(geometry A, geometry B)\n从A去除和B相交的部分后返回 ST_Difference(geometry A, geometry B)\n返回两个几何对象的合并结果 ST_Union(geometry, geometry)\n返回一系列几何对象的合并结果 ST_Union(geometry set)\n用较少的内存和较长的时间完成合并操作，结果和ST_Union相同 ST_MemUnion(geometry set)\n```\n\n# 几何对象存取函数\n```\n获取几何对象的WKT描述 ST_AsText(geometry)\n获取几何对象的WKB描述 ST_AsBinary(geometry)\n获取几何对象的空间参考ID ST_SRID(geometry)\n获取几何对象的维数 ST_Dimension(geometry)\n获取几何对象的边界范围 ST_Envelope(geometry)\n判断几何对象是否为空 ST_IsEmpty(geometry)\n判断几何对象是否不包含特殊点（比如自相交） ST_IsSimple(geometry)\n判断几何对象是否闭合 ST_IsClosed(geometry)\n判断曲线是否闭合并且不包含特殊点 ST_IsRing(geometry)\n获取多几何对象中的对象个数 ST_NumGeometries(geometry)\n获取多几何对象中第N个对象 ST_GeometryN(geometry,int)\n获取几何对象中的点个数 ST_NumPoints(geometry)\n获取几何对象的第N个点 ST_PointN(geometry,integer)\n获取多边形的外边缘 ST_ExteriorRing(geometry)\n获取多边形内边界个数 ST_NumInteriorRings(geometry)\n同上 ST_NumInteriorRing(geometry)\n获取多边形的第N个内边界 ST_InteriorRingN(geometry,integer)\n获取线的终点 ST_EndPoint(geometry)\n获取线的起始点 ST_StartPoint(geometry)\n获取几何对象的类型 GeometryType(geometry)\n类似上，但是不检查M值，即POINTM对象会被判断为point ST_GeometryType(geometry)\n获取点的X坐标 ST_X(geometry)\n获取点的Y坐标 ST_Y(geometry)\n获取点的Z坐标 ST_Z(geometry)\n获取点的M值 ST_M(geometry)\n```\n\n# 几何对象构造函数\n```\n参考语义\nText：WKT\nWKB：WKB\nGeom:Geometry\nM:Multi\nBd:BuildArea\nColl:Collection ST_GeomFromText(text,[])\n\nST_PointFromText(text,[])\nST_LineFromText(text,[])\nST_LinestringFromText(text,[])\nST_PolyFromText(text,[])\nST_PolygonFromText(text,[])\nST_MPointFromText(text,[])\nST_MLineFromText(text,[])\nST_MPolyFromText(text,[])\nST_GeomCollFromText(text,[])\nST_GeomFromWKB(bytea,[])\nST_GeometryFromWKB(bytea,[])\nST_PointFromWKB(bytea,[])\nST_LineFromWKB(bytea,[])\nST_LinestringFromWKB(bytea,[])\nST_PolyFromWKB(bytea,[])\nST_PolygonFromWKB(bytea,[])\nST_MPointFromWKB(bytea,[])\nST_MLineFromWKB(bytea,[])\nST_MPolyFromWKB(bytea,[])\nST_GeomCollFromWKB(bytea,[])\nST_BdPolyFromText(text WKT, integer SRID)\nST_BdMPolyFromText(text WKT, integer SRID)\n```\n","slug":"Postgis常用函数","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzh40001pieb0fav3x86","content":"<p>记录Postgis常用方法.</p>\n<a id=\"more\"></a>\n<h1 id=\"WKT定义几何对象格式：\"><a href=\"#WKT定义几何对象格式：\" class=\"headerlink\" title=\"WKT定义几何对象格式：\"></a>WKT定义几何对象格式：</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">POINT(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>) ——点<br>LINESTRING(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>) ——线<br>POLYGON((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>),(<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>)) ——面<br>MULTIPOINT(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>) ——多点<br>MULTILINESTRING((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>),(<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">3</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">5</span> <span class=\"hljs-number\">4</span>)) ——多线<br>MULTIPOLYGON(((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>),(<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>)), ((<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-1</span>,<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-2</span>,<span class=\"hljs-number\">-2</span> <span class=\"hljs-number\">-2</span>,<span class=\"hljs-number\">-2</span> <span class=\"hljs-number\">-1</span>,<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-1</span>))) ——多面<br>GEOMETRYCOLLECTION(POINT(<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>),LINESTRING((<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">3</span> <span class=\"hljs-number\">4</span>))) ——几何集合<br></code></pre></td></tr></table></figure>\n<h1 id=\"常用函数：\"><a href=\"#常用函数：\" class=\"headerlink\" title=\"常用函数：\"></a>常用函数：</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">wkt转geometry st<span class=\"hljs-constructor\">_geomfromtext(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">wkid</span>)</span><br>geometry转wkt st<span class=\"hljs-constructor\">_astext(<span class=\"hljs-params\">geom</span>)</span><br>获取点对象x、y坐标值 st<span class=\"hljs-constructor\">_x(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_y(<span class=\"hljs-params\">geom</span>)</span><br>获取线/面对象四至 st<span class=\"hljs-constructor\">_xmin(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_ymin(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_xmax(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_ymax(<span class=\"hljs-params\">geom</span>)</span><br>计算两点之间距离 st<span class=\"hljs-constructor\">_distance(<span class=\"hljs-params\">geom</span>,<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_distance(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">wkt</span>)</span><br>计算线的长度 st<span class=\"hljs-constructor\">_length(<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_length(<span class=\"hljs-params\">wkt</span>)</span><br>计算面积 st<span class=\"hljs-constructor\">_area(<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_area(<span class=\"hljs-params\">wkt</span>)</span><br>缓冲区计算 st<span class=\"hljs-constructor\">_buffer(<span class=\"hljs-params\">geom</span>,<span class=\"hljs-params\">distance</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_buffer(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">distance</span>)</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"管理函数\"><a href=\"#管理函数\" class=\"headerlink\" title=\"管理函数\"></a>管理函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">添加几何字段 <span class=\"hljs-constructor\">AddGeometryColumn(, , , , , )</span><br>删除几何字段 <span class=\"hljs-constructor\">DropGeometryColumn(, , )</span><br>检查数据库几何字段并在geometry_columns中归档 <span class=\"hljs-constructor\">Probe_Geometry_Columns()</span><br>给几何对象设置空间参考（在通过一个范围做空间查询时常用） <span class=\"hljs-constructor\">ST_SetSRID(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">integer</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象关系函数\"><a href=\"#几何对象关系函数\" class=\"headerlink\" title=\"几何对象关系函数\"></a>几何对象关系函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取两个几何对象间的距离 <span class=\"hljs-constructor\">ST_Distance(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>如果两个几何对象间距离在给定值范围内，则返回TRUE <span class=\"hljs-constructor\">ST_DWithin(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">float</span>)</span><br>判断两个几何对象是否相等<br>（比如<span class=\"hljs-constructor\">LINESTRING(0 0, 2 2)</span>和<span class=\"hljs-constructor\">LINESTRING(0 0, 1 1, 2 2)</span>是相同的几何对象） <span class=\"hljs-constructor\">ST_Equals(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否分离 <span class=\"hljs-constructor\">ST_Disjoint(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否相交 <span class=\"hljs-constructor\">ST_Intersects(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象的边缘是否接触 <span class=\"hljs-constructor\">ST_Touches(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否互相穿过 <span class=\"hljs-constructor\">ST_Crosses(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断A是否被B包含 <span class=\"hljs-constructor\">ST_Within(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断两个几何对象是否是重叠 <span class=\"hljs-constructor\">ST_Overlaps(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断A是否包含B <span class=\"hljs-constructor\">ST_Contains(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断A是否覆盖 B <span class=\"hljs-constructor\">ST_Covers(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断A是否被B所覆盖 <span class=\"hljs-constructor\">ST_CoveredBy(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>通过DE-<span class=\"hljs-number\">9</span>IM 矩阵判断两个几何对象的关系是否成立 <span class=\"hljs-constructor\">ST_Relate(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">intersectionPatternMatrix</span>)</span><br>获得两个几何对象的关系（DE-<span class=\"hljs-number\">9</span>IM矩阵） <span class=\"hljs-constructor\">ST_Relate(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象处理函数：\"><a href=\"#几何对象处理函数：\" class=\"headerlink\" title=\"几何对象处理函数：\"></a>几何对象处理函数：</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取几何对象的中心 <span class=\"hljs-constructor\">ST_Centroid(<span class=\"hljs-params\">geometry</span>)</span><br>面积量测 <span class=\"hljs-constructor\">ST_Area(<span class=\"hljs-params\">geometry</span>)</span><br>长度量测 <span class=\"hljs-constructor\">ST_Length(<span class=\"hljs-params\">geometry</span>)</span><br>返回曲面上的一个点 <span class=\"hljs-constructor\">ST_PointOnSurface(<span class=\"hljs-params\">geometry</span>)</span><br>获取边界 <span class=\"hljs-constructor\">ST_Boundary(<span class=\"hljs-params\">geometry</span>)</span><br>获取缓冲后的几何对象 <span class=\"hljs-constructor\">ST_Buffer(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">double</span>, [<span class=\"hljs-params\">integer</span>])</span><br>获取多几何对象的外接对象 <span class=\"hljs-constructor\">ST_ConvexHull(<span class=\"hljs-params\">geometry</span>)</span><br>获取两个几何对象相交的部分 <span class=\"hljs-constructor\">ST_Intersection(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>将经度小于<span class=\"hljs-number\">0</span>的值加<span class=\"hljs-number\">360</span>使所有经度值在<span class=\"hljs-number\">0</span>-<span class=\"hljs-number\">360</span>间 <span class=\"hljs-constructor\">ST_Shift_Longitude(<span class=\"hljs-params\">geometry</span>)</span><br>获取两个几何对象不相交的部分（A、B可互换） <span class=\"hljs-constructor\">ST_SymDifference(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>从A去除和B相交的部分后返回 <span class=\"hljs-constructor\">ST_Difference(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>返回两个几何对象的合并结果 <span class=\"hljs-constructor\">ST_Union(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>返回一系列几何对象的合并结果 <span class=\"hljs-constructor\">ST_Union(<span class=\"hljs-params\">geometry</span> <span class=\"hljs-params\">set</span>)</span><br>用较少的内存和较长的时间完成合并操作，结果和ST_Union相同 <span class=\"hljs-constructor\">ST_MemUnion(<span class=\"hljs-params\">geometry</span> <span class=\"hljs-params\">set</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象存取函数\"><a href=\"#几何对象存取函数\" class=\"headerlink\" title=\"几何对象存取函数\"></a>几何对象存取函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取几何对象的WKT描述 <span class=\"hljs-constructor\">ST_AsText(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的WKB描述 <span class=\"hljs-constructor\">ST_AsBinary(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的空间参考ID <span class=\"hljs-constructor\">ST_SRID(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的维数 <span class=\"hljs-constructor\">ST_Dimension(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的边界范围 <span class=\"hljs-constructor\">ST_Envelope(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否为空 <span class=\"hljs-constructor\">ST_IsEmpty(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否不包含特殊点（比如自相交） <span class=\"hljs-constructor\">ST_IsSimple(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否闭合 <span class=\"hljs-constructor\">ST_IsClosed(<span class=\"hljs-params\">geometry</span>)</span><br>判断曲线是否闭合并且不包含特殊点 <span class=\"hljs-constructor\">ST_IsRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多几何对象中的对象个数 <span class=\"hljs-constructor\">ST_NumGeometries(<span class=\"hljs-params\">geometry</span>)</span><br>获取多几何对象中第N个对象 <span class=\"hljs-constructor\">ST_GeometryN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">int</span>)</span><br>获取几何对象中的点个数 <span class=\"hljs-constructor\">ST_NumPoints(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的第N个点 <span class=\"hljs-constructor\">ST_PointN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">integer</span>)</span><br>获取多边形的外边缘 <span class=\"hljs-constructor\">ST_ExteriorRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多边形内边界个数 <span class=\"hljs-constructor\">ST_NumInteriorRings(<span class=\"hljs-params\">geometry</span>)</span><br>同上 <span class=\"hljs-constructor\">ST_NumInteriorRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多边形的第N个内边界 <span class=\"hljs-constructor\">ST_InteriorRingN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">integer</span>)</span><br>获取线的终点 <span class=\"hljs-constructor\">ST_EndPoint(<span class=\"hljs-params\">geometry</span>)</span><br>获取线的起始点 <span class=\"hljs-constructor\">ST_StartPoint(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的类型 <span class=\"hljs-constructor\">GeometryType(<span class=\"hljs-params\">geometry</span>)</span><br>类似上，但是不检查M值，即POINTM对象会被判断为point <span class=\"hljs-constructor\">ST_GeometryType(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的X坐标 <span class=\"hljs-constructor\">ST_X(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的Y坐标 <span class=\"hljs-constructor\">ST_Y(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的Z坐标 <span class=\"hljs-constructor\">ST_Z(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的M值 <span class=\"hljs-constructor\">ST_M(<span class=\"hljs-params\">geometry</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象构造函数\"><a href=\"#几何对象构造函数\" class=\"headerlink\" title=\"几何对象构造函数\"></a>几何对象构造函数</h1><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">参考语义<br>Text：WKT<br>WKB：WKB<br>Geom:Geometry<br>M:Multi<br>Bd:BuildArea<br>Coll:Collection ST_GeomFromText(text,[])<br><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PointFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LineFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LinestringFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolyFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolygonFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPointFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MLineFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPolyFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomCollFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeometryFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PointFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LineFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LinestringFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolyFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolygonFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPointFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MLineFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPolyFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomCollFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_BdPolyFromText</span><span class=\"hljs-params\">(text WKT, integer SRID)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_BdMPolyFromText</span><span class=\"hljs-params\">(text WKT, integer SRID)</span></span><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>记录Postgis常用方法.</p>","more":"<h1 id=\"WKT定义几何对象格式：\"><a href=\"#WKT定义几何对象格式：\" class=\"headerlink\" title=\"WKT定义几何对象格式：\"></a>WKT定义几何对象格式：</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">POINT(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>) ——点<br>LINESTRING(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>) ——线<br>POLYGON((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>),(<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>)) ——面<br>MULTIPOINT(<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>) ——多点<br>MULTILINESTRING((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>),(<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">3</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">5</span> <span class=\"hljs-number\">4</span>)) ——多线<br>MULTIPOLYGON(((<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">4</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">0</span> <span class=\"hljs-number\">0</span>),(<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">1</span>)), ((<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-1</span>,<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-2</span>,<span class=\"hljs-number\">-2</span> <span class=\"hljs-number\">-2</span>,<span class=\"hljs-number\">-2</span> <span class=\"hljs-number\">-1</span>,<span class=\"hljs-number\">-1</span> <span class=\"hljs-number\">-1</span>))) ——多面<br>GEOMETRYCOLLECTION(POINT(<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>),LINESTRING((<span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">3</span> <span class=\"hljs-number\">4</span>))) ——几何集合<br></code></pre></td></tr></table></figure>\n<h1 id=\"常用函数：\"><a href=\"#常用函数：\" class=\"headerlink\" title=\"常用函数：\"></a>常用函数：</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">wkt转geometry st<span class=\"hljs-constructor\">_geomfromtext(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">wkid</span>)</span><br>geometry转wkt st<span class=\"hljs-constructor\">_astext(<span class=\"hljs-params\">geom</span>)</span><br>获取点对象x、y坐标值 st<span class=\"hljs-constructor\">_x(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_y(<span class=\"hljs-params\">geom</span>)</span><br>获取线/面对象四至 st<span class=\"hljs-constructor\">_xmin(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_ymin(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_xmax(<span class=\"hljs-params\">geom</span>)</span>、st<span class=\"hljs-constructor\">_ymax(<span class=\"hljs-params\">geom</span>)</span><br>计算两点之间距离 st<span class=\"hljs-constructor\">_distance(<span class=\"hljs-params\">geom</span>,<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_distance(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">wkt</span>)</span><br>计算线的长度 st<span class=\"hljs-constructor\">_length(<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_length(<span class=\"hljs-params\">wkt</span>)</span><br>计算面积 st<span class=\"hljs-constructor\">_area(<span class=\"hljs-params\">geom</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_area(<span class=\"hljs-params\">wkt</span>)</span><br>缓冲区计算 st<span class=\"hljs-constructor\">_buffer(<span class=\"hljs-params\">geom</span>,<span class=\"hljs-params\">distance</span>)</span><span class=\"hljs-operator\"> / </span>st<span class=\"hljs-constructor\">_buffer(<span class=\"hljs-params\">wkt</span>,<span class=\"hljs-params\">distance</span>)</span><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"管理函数\"><a href=\"#管理函数\" class=\"headerlink\" title=\"管理函数\"></a>管理函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">添加几何字段 <span class=\"hljs-constructor\">AddGeometryColumn(, , , , , )</span><br>删除几何字段 <span class=\"hljs-constructor\">DropGeometryColumn(, , )</span><br>检查数据库几何字段并在geometry_columns中归档 <span class=\"hljs-constructor\">Probe_Geometry_Columns()</span><br>给几何对象设置空间参考（在通过一个范围做空间查询时常用） <span class=\"hljs-constructor\">ST_SetSRID(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">integer</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象关系函数\"><a href=\"#几何对象关系函数\" class=\"headerlink\" title=\"几何对象关系函数\"></a>几何对象关系函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取两个几何对象间的距离 <span class=\"hljs-constructor\">ST_Distance(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>如果两个几何对象间距离在给定值范围内，则返回TRUE <span class=\"hljs-constructor\">ST_DWithin(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">float</span>)</span><br>判断两个几何对象是否相等<br>（比如<span class=\"hljs-constructor\">LINESTRING(0 0, 2 2)</span>和<span class=\"hljs-constructor\">LINESTRING(0 0, 1 1, 2 2)</span>是相同的几何对象） <span class=\"hljs-constructor\">ST_Equals(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否分离 <span class=\"hljs-constructor\">ST_Disjoint(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否相交 <span class=\"hljs-constructor\">ST_Intersects(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象的边缘是否接触 <span class=\"hljs-constructor\">ST_Touches(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断两个几何对象是否互相穿过 <span class=\"hljs-constructor\">ST_Crosses(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断A是否被B包含 <span class=\"hljs-constructor\">ST_Within(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断两个几何对象是否是重叠 <span class=\"hljs-constructor\">ST_Overlaps(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>判断A是否包含B <span class=\"hljs-constructor\">ST_Contains(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断A是否覆盖 B <span class=\"hljs-constructor\">ST_Covers(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>判断A是否被B所覆盖 <span class=\"hljs-constructor\">ST_CoveredBy(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>通过DE-<span class=\"hljs-number\">9</span>IM 矩阵判断两个几何对象的关系是否成立 <span class=\"hljs-constructor\">ST_Relate(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">intersectionPatternMatrix</span>)</span><br>获得两个几何对象的关系（DE-<span class=\"hljs-number\">9</span>IM矩阵） <span class=\"hljs-constructor\">ST_Relate(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象处理函数：\"><a href=\"#几何对象处理函数：\" class=\"headerlink\" title=\"几何对象处理函数：\"></a>几何对象处理函数：</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取几何对象的中心 <span class=\"hljs-constructor\">ST_Centroid(<span class=\"hljs-params\">geometry</span>)</span><br>面积量测 <span class=\"hljs-constructor\">ST_Area(<span class=\"hljs-params\">geometry</span>)</span><br>长度量测 <span class=\"hljs-constructor\">ST_Length(<span class=\"hljs-params\">geometry</span>)</span><br>返回曲面上的一个点 <span class=\"hljs-constructor\">ST_PointOnSurface(<span class=\"hljs-params\">geometry</span>)</span><br>获取边界 <span class=\"hljs-constructor\">ST_Boundary(<span class=\"hljs-params\">geometry</span>)</span><br>获取缓冲后的几何对象 <span class=\"hljs-constructor\">ST_Buffer(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">double</span>, [<span class=\"hljs-params\">integer</span>])</span><br>获取多几何对象的外接对象 <span class=\"hljs-constructor\">ST_ConvexHull(<span class=\"hljs-params\">geometry</span>)</span><br>获取两个几何对象相交的部分 <span class=\"hljs-constructor\">ST_Intersection(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>将经度小于<span class=\"hljs-number\">0</span>的值加<span class=\"hljs-number\">360</span>使所有经度值在<span class=\"hljs-number\">0</span>-<span class=\"hljs-number\">360</span>间 <span class=\"hljs-constructor\">ST_Shift_Longitude(<span class=\"hljs-params\">geometry</span>)</span><br>获取两个几何对象不相交的部分（A、B可互换） <span class=\"hljs-constructor\">ST_SymDifference(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>从A去除和B相交的部分后返回 <span class=\"hljs-constructor\">ST_Difference(<span class=\"hljs-params\">geometry</span> A, <span class=\"hljs-params\">geometry</span> B)</span><br>返回两个几何对象的合并结果 <span class=\"hljs-constructor\">ST_Union(<span class=\"hljs-params\">geometry</span>, <span class=\"hljs-params\">geometry</span>)</span><br>返回一系列几何对象的合并结果 <span class=\"hljs-constructor\">ST_Union(<span class=\"hljs-params\">geometry</span> <span class=\"hljs-params\">set</span>)</span><br>用较少的内存和较长的时间完成合并操作，结果和ST_Union相同 <span class=\"hljs-constructor\">ST_MemUnion(<span class=\"hljs-params\">geometry</span> <span class=\"hljs-params\">set</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象存取函数\"><a href=\"#几何对象存取函数\" class=\"headerlink\" title=\"几何对象存取函数\"></a>几何对象存取函数</h1><figure class=\"highlight reasonml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs reasonml\">获取几何对象的WKT描述 <span class=\"hljs-constructor\">ST_AsText(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的WKB描述 <span class=\"hljs-constructor\">ST_AsBinary(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的空间参考ID <span class=\"hljs-constructor\">ST_SRID(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的维数 <span class=\"hljs-constructor\">ST_Dimension(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的边界范围 <span class=\"hljs-constructor\">ST_Envelope(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否为空 <span class=\"hljs-constructor\">ST_IsEmpty(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否不包含特殊点（比如自相交） <span class=\"hljs-constructor\">ST_IsSimple(<span class=\"hljs-params\">geometry</span>)</span><br>判断几何对象是否闭合 <span class=\"hljs-constructor\">ST_IsClosed(<span class=\"hljs-params\">geometry</span>)</span><br>判断曲线是否闭合并且不包含特殊点 <span class=\"hljs-constructor\">ST_IsRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多几何对象中的对象个数 <span class=\"hljs-constructor\">ST_NumGeometries(<span class=\"hljs-params\">geometry</span>)</span><br>获取多几何对象中第N个对象 <span class=\"hljs-constructor\">ST_GeometryN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">int</span>)</span><br>获取几何对象中的点个数 <span class=\"hljs-constructor\">ST_NumPoints(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的第N个点 <span class=\"hljs-constructor\">ST_PointN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">integer</span>)</span><br>获取多边形的外边缘 <span class=\"hljs-constructor\">ST_ExteriorRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多边形内边界个数 <span class=\"hljs-constructor\">ST_NumInteriorRings(<span class=\"hljs-params\">geometry</span>)</span><br>同上 <span class=\"hljs-constructor\">ST_NumInteriorRing(<span class=\"hljs-params\">geometry</span>)</span><br>获取多边形的第N个内边界 <span class=\"hljs-constructor\">ST_InteriorRingN(<span class=\"hljs-params\">geometry</span>,<span class=\"hljs-params\">integer</span>)</span><br>获取线的终点 <span class=\"hljs-constructor\">ST_EndPoint(<span class=\"hljs-params\">geometry</span>)</span><br>获取线的起始点 <span class=\"hljs-constructor\">ST_StartPoint(<span class=\"hljs-params\">geometry</span>)</span><br>获取几何对象的类型 <span class=\"hljs-constructor\">GeometryType(<span class=\"hljs-params\">geometry</span>)</span><br>类似上，但是不检查M值，即POINTM对象会被判断为point <span class=\"hljs-constructor\">ST_GeometryType(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的X坐标 <span class=\"hljs-constructor\">ST_X(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的Y坐标 <span class=\"hljs-constructor\">ST_Y(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的Z坐标 <span class=\"hljs-constructor\">ST_Z(<span class=\"hljs-params\">geometry</span>)</span><br>获取点的M值 <span class=\"hljs-constructor\">ST_M(<span class=\"hljs-params\">geometry</span>)</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"几何对象构造函数\"><a href=\"#几何对象构造函数\" class=\"headerlink\" title=\"几何对象构造函数\"></a>几何对象构造函数</h1><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\">参考语义<br>Text：WKT<br>WKB：WKB<br>Geom:Geometry<br>M:Multi<br>Bd:BuildArea<br>Coll:Collection ST_GeomFromText(text,[])<br><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PointFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LineFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LinestringFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolyFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolygonFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPointFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MLineFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPolyFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomCollFromText</span><span class=\"hljs-params\">(text,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeometryFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PointFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LineFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_LinestringFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolyFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_PolygonFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPointFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MLineFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_MPolyFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_GeomCollFromWKB</span><span class=\"hljs-params\">(bytea,[])</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_BdPolyFromText</span><span class=\"hljs-params\">(text WKT, integer SRID)</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ST_BdMPolyFromText</span><span class=\"hljs-params\">(text WKT, integer SRID)</span></span><br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL后端进程","date":"2020-08-27T09:32:48.000Z","top":20,"description":null,"password":null,"_content":"\n# 整体架构图\n\n![ An example of the process architecture in PostgreSQL ](/images/A_example_of_the_process_architecture_in_PostgreSQL.png)\n\n<!-- more -->\n\n# checkpoint\n## 功能描述\n\n其保证了数据库的一致性状态，定期执行检查点是很重要的，确保数据变化持久保存到磁盘中并且数据库的状态是一致的。\n## 参数\n\ncheckpoint_timeout\n系统自动执行checkpoint之间的最大时间间隔。系统默认值是5分钟，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO\n\nmax_wal_size\n写满多少个WAL时执行checkpoint，也是同理，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO\n\nmin_wal_size\n只要wal日志目录使用空间小于该值，那么旧的wal日志就会循环使用而不是进行删除。这个参数是为了确保足够的wal空间预留给突发情况，比如大的跑批操作。\n\ncheckpoint_completion_target\n分散检查点，默认为0.5，即表示每个checkpoint需要在checkpoints间隔时间的50%内完成，然后立马进行fsync，fsync执行是很快的(为了平滑fsync，以防尖锐的IO请求，PostgreSQL9.6以后加了checkpoint_flush_after、wal_writer_flush_after、bgwriter_flush_after和backend_flush_after这些参数来缓解)看如下一个场景。\n| 场景                             | 数据量 | 数据写入速度( 1gb/ s )          |\n| -                                | -      | -                               |\n| checkpoint_completion_target=0.5 | 100G   | 100/ ( 0.53060 ) 1024 ≈ 114 M/s |\n| checkpoint_timeout = 30min       | 100G   | 100/ ( 0.8 3060 ) 1024 ≈ 71 M/s |\n\nfull_page_writes\nPostgreSQL服务器在检查点之后对页面的第一次写入时将整个页面写到WAL里面。如果checkpoint发生太频繁，会导致写放大，默认为on，假如调为off，需要确保数据库在压测期间不要崩溃，不然重启后可能发生数据块部分写，导致重启失败。full_page_writes就是为了确保数据页一致性，不发生块折断。而在MySQL中，则是通过double write来预防partial write的。如果你的块设备对齐，并支持原子写(原子写大于或等于一个DATA FILE数据页的大小)，那可以关闭这个参数\n\n# background writer\n## 功能描述\n\n1、数据库在进行查询处理时若发现要读取的数据不在缓冲区中时要先从磁盘中读入需要的页面，此时如果缓冲区已满，则需要遵从类似于LRU算法先选择部分缓冲区中的页面置换出去。如果被替换的页面没有被修改过，则可以直接丢弃；但如果已经被修改过，则需要先将这些页面写出到磁盘后才能置换，通过使用BgWriter定期写出缓冲区中的部分脏页，为缓冲区腾出空间，就可以降低查询处理被阻塞的可能性；\n\n2、PostgreSQL在定期做检查点时需要把所有脏页写出到磁盘，通过BgWriter预先写出一些脏页，可以减少检查点时要进行的IO动作，使系统的IO更加平稳。通过BgWriter对共享缓冲区写操作的管理，避免了其他服务进程在需要读入新的页面到缓冲区时，不得不先进行写盘的操作。\n\n## 参数\n\nwriter_delay\nbackground writer每次扫描之间的时间间隔，也就是刷shared buffer脏页的进程调度间隔，尽量高频调度，减少用户进程申请不到内存而需要主动刷脏页的可能(导致RT升高)\n\nbgwriter_lru_maxpages\n一次最多刷多少脏页\n\nbgwriter_lru_multiplier\n写出至多bgwriter_lru_multiplier * N个脏页，并且不超过bgwriter_lru_maxpages值的限制。其中N是最近一段时间在两次BgWriter运行期间系统新申请的缓冲区页数。后台写进程根据最近服务进程需要的buffer数量乘上这个比率估算出下次服务进程需要的buffer数量，再使用后台写进程刷脏页面，使缓冲区能使用的干净页面达到这个估计值\n\nbgwriter_flush_after\n每当bgwriter写入的字节数超过bgwriter_flush_after时，就会强制OS从page cache中写出。这样做将限制page cache中脏数据量，从而减少在检查点末尾发出fsync或操作系统在后台大批量写回数据时出现停顿的可能性\n","source":"_posts/PostgreSQL_backend_process.md","raw":"---\ntitle: PostgreSQL后端进程 \ndate: 2020-08-27 17:32:48\ntags: \n- PostgreSQL\n- backend\n- Architecture\ncategories: \n- PostgreSQL\ntop: 20\ndescription: \npassword: \n\n---\n\n# 整体架构图\n\n![ An example of the process architecture in PostgreSQL ](/images/A_example_of_the_process_architecture_in_PostgreSQL.png)\n\n<!-- more -->\n\n# checkpoint\n## 功能描述\n\n其保证了数据库的一致性状态，定期执行检查点是很重要的，确保数据变化持久保存到磁盘中并且数据库的状态是一致的。\n## 参数\n\ncheckpoint_timeout\n系统自动执行checkpoint之间的最大时间间隔。系统默认值是5分钟，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO\n\nmax_wal_size\n写满多少个WAL时执行checkpoint，也是同理，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO\n\nmin_wal_size\n只要wal日志目录使用空间小于该值，那么旧的wal日志就会循环使用而不是进行删除。这个参数是为了确保足够的wal空间预留给突发情况，比如大的跑批操作。\n\ncheckpoint_completion_target\n分散检查点，默认为0.5，即表示每个checkpoint需要在checkpoints间隔时间的50%内完成，然后立马进行fsync，fsync执行是很快的(为了平滑fsync，以防尖锐的IO请求，PostgreSQL9.6以后加了checkpoint_flush_after、wal_writer_flush_after、bgwriter_flush_after和backend_flush_after这些参数来缓解)看如下一个场景。\n| 场景                             | 数据量 | 数据写入速度( 1gb/ s )          |\n| -                                | -      | -                               |\n| checkpoint_completion_target=0.5 | 100G   | 100/ ( 0.53060 ) 1024 ≈ 114 M/s |\n| checkpoint_timeout = 30min       | 100G   | 100/ ( 0.8 3060 ) 1024 ≈ 71 M/s |\n\nfull_page_writes\nPostgreSQL服务器在检查点之后对页面的第一次写入时将整个页面写到WAL里面。如果checkpoint发生太频繁，会导致写放大，默认为on，假如调为off，需要确保数据库在压测期间不要崩溃，不然重启后可能发生数据块部分写，导致重启失败。full_page_writes就是为了确保数据页一致性，不发生块折断。而在MySQL中，则是通过double write来预防partial write的。如果你的块设备对齐，并支持原子写(原子写大于或等于一个DATA FILE数据页的大小)，那可以关闭这个参数\n\n# background writer\n## 功能描述\n\n1、数据库在进行查询处理时若发现要读取的数据不在缓冲区中时要先从磁盘中读入需要的页面，此时如果缓冲区已满，则需要遵从类似于LRU算法先选择部分缓冲区中的页面置换出去。如果被替换的页面没有被修改过，则可以直接丢弃；但如果已经被修改过，则需要先将这些页面写出到磁盘后才能置换，通过使用BgWriter定期写出缓冲区中的部分脏页，为缓冲区腾出空间，就可以降低查询处理被阻塞的可能性；\n\n2、PostgreSQL在定期做检查点时需要把所有脏页写出到磁盘，通过BgWriter预先写出一些脏页，可以减少检查点时要进行的IO动作，使系统的IO更加平稳。通过BgWriter对共享缓冲区写操作的管理，避免了其他服务进程在需要读入新的页面到缓冲区时，不得不先进行写盘的操作。\n\n## 参数\n\nwriter_delay\nbackground writer每次扫描之间的时间间隔，也就是刷shared buffer脏页的进程调度间隔，尽量高频调度，减少用户进程申请不到内存而需要主动刷脏页的可能(导致RT升高)\n\nbgwriter_lru_maxpages\n一次最多刷多少脏页\n\nbgwriter_lru_multiplier\n写出至多bgwriter_lru_multiplier * N个脏页，并且不超过bgwriter_lru_maxpages值的限制。其中N是最近一段时间在两次BgWriter运行期间系统新申请的缓冲区页数。后台写进程根据最近服务进程需要的buffer数量乘上这个比率估算出下次服务进程需要的buffer数量，再使用后台写进程刷脏页面，使缓冲区能使用的干净页面达到这个估计值\n\nbgwriter_flush_after\n每当bgwriter写入的字节数超过bgwriter_flush_after时，就会强制OS从page cache中写出。这样做将限制page cache中脏数据量，从而减少在检查点末尾发出fsync或操作系统在后台大批量写回数据时出现停顿的可能性\n","slug":"PostgreSQL_backend_process","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzh60003pieb50bo1pzp","content":"<h1 id=\"整体架构图\"><a href=\"#整体架构图\" class=\"headerlink\" title=\"整体架构图\"></a>整体架构图</h1><p><img data-src=\"/images/A_example_of_the_process_architecture_in_PostgreSQL.png\" alt=\" An example of the process architecture in PostgreSQL \"></p>\n<a id=\"more\"></a>\n<h1 id=\"checkpoint\"><a href=\"#checkpoint\" class=\"headerlink\" title=\"checkpoint\"></a>checkpoint</h1><h2 id=\"功能描述\"><a href=\"#功能描述\" class=\"headerlink\" title=\"功能描述\"></a>功能描述</h2><p>其保证了数据库的一致性状态，定期执行检查点是很重要的，确保数据变化持久保存到磁盘中并且数据库的状态是一致的。</p>\n<h2 id=\"参数\"><a href=\"#参数\" class=\"headerlink\" title=\"参数\"></a>参数</h2><p>checkpoint_timeout<br>系统自动执行checkpoint之间的最大时间间隔。系统默认值是5分钟，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO</p>\n<p>max_wal_size<br>写满多少个WAL时执行checkpoint，也是同理，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO</p>\n<p>min_wal_size<br>只要wal日志目录使用空间小于该值，那么旧的wal日志就会循环使用而不是进行删除。这个参数是为了确保足够的wal空间预留给突发情况，比如大的跑批操作。</p>\n<p>checkpoint_completion_target<br>分散检查点，默认为0.5，即表示每个checkpoint需要在checkpoints间隔时间的50%内完成，然后立马进行fsync，fsync执行是很快的(为了平滑fsync，以防尖锐的IO请求，PostgreSQL9.6以后加了checkpoint_flush_after、wal_writer_flush_after、bgwriter_flush_after和backend_flush_after这些参数来缓解)看如下一个场景。<br>| 场景                             | 数据量 | 数据写入速度( 1gb/ s )          |<br>| -                                | -      | -                               |<br>| checkpoint_completion_target=0.5 | 100G   | 100/ ( 0.53060 ) 1024 ≈ 114 M/s |<br>| checkpoint_timeout = 30min       | 100G   | 100/ ( 0.8 3060 ) 1024 ≈ 71 M/s |</p>\n<p>full_page_writes<br>PostgreSQL服务器在检查点之后对页面的第一次写入时将整个页面写到WAL里面。如果checkpoint发生太频繁，会导致写放大，默认为on，假如调为off，需要确保数据库在压测期间不要崩溃，不然重启后可能发生数据块部分写，导致重启失败。full_page_writes就是为了确保数据页一致性，不发生块折断。而在MySQL中，则是通过double write来预防partial write的。如果你的块设备对齐，并支持原子写(原子写大于或等于一个DATA FILE数据页的大小)，那可以关闭这个参数</p>\n<h1 id=\"background-writer\"><a href=\"#background-writer\" class=\"headerlink\" title=\"background writer\"></a>background writer</h1><h2 id=\"功能描述-1\"><a href=\"#功能描述-1\" class=\"headerlink\" title=\"功能描述\"></a>功能描述</h2><p>1、数据库在进行查询处理时若发现要读取的数据不在缓冲区中时要先从磁盘中读入需要的页面，此时如果缓冲区已满，则需要遵从类似于LRU算法先选择部分缓冲区中的页面置换出去。如果被替换的页面没有被修改过，则可以直接丢弃；但如果已经被修改过，则需要先将这些页面写出到磁盘后才能置换，通过使用BgWriter定期写出缓冲区中的部分脏页，为缓冲区腾出空间，就可以降低查询处理被阻塞的可能性；</p>\n<p>2、PostgreSQL在定期做检查点时需要把所有脏页写出到磁盘，通过BgWriter预先写出一些脏页，可以减少检查点时要进行的IO动作，使系统的IO更加平稳。通过BgWriter对共享缓冲区写操作的管理，避免了其他服务进程在需要读入新的页面到缓冲区时，不得不先进行写盘的操作。</p>\n<h2 id=\"参数-1\"><a href=\"#参数-1\" class=\"headerlink\" title=\"参数\"></a>参数</h2><p>writer_delay<br>background writer每次扫描之间的时间间隔，也就是刷shared buffer脏页的进程调度间隔，尽量高频调度，减少用户进程申请不到内存而需要主动刷脏页的可能(导致RT升高)</p>\n<p>bgwriter_lru_maxpages<br>一次最多刷多少脏页</p>\n<p>bgwriter_lru_multiplier<br>写出至多bgwriter_lru_multiplier * N个脏页，并且不超过bgwriter_lru_maxpages值的限制。其中N是最近一段时间在两次BgWriter运行期间系统新申请的缓冲区页数。后台写进程根据最近服务进程需要的buffer数量乘上这个比率估算出下次服务进程需要的buffer数量，再使用后台写进程刷脏页面，使缓冲区能使用的干净页面达到这个估计值</p>\n<p>bgwriter_flush_after<br>每当bgwriter写入的字节数超过bgwriter_flush_after时，就会强制OS从page cache中写出。这样做将限制page cache中脏数据量，从而减少在检查点末尾发出fsync或操作系统在后台大批量写回数据时出现停顿的可能性</p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"整体架构图\"><a href=\"#整体架构图\" class=\"headerlink\" title=\"整体架构图\"></a>整体架构图</h1><p><img data-src=\"/images/A_example_of_the_process_architecture_in_PostgreSQL.png\" alt=\" An example of the process architecture in PostgreSQL \"></p>","more":"<h1 id=\"checkpoint\"><a href=\"#checkpoint\" class=\"headerlink\" title=\"checkpoint\"></a>checkpoint</h1><h2 id=\"功能描述\"><a href=\"#功能描述\" class=\"headerlink\" title=\"功能描述\"></a>功能描述</h2><p>其保证了数据库的一致性状态，定期执行检查点是很重要的，确保数据变化持久保存到磁盘中并且数据库的状态是一致的。</p>\n<h2 id=\"参数\"><a href=\"#参数\" class=\"headerlink\" title=\"参数\"></a>参数</h2><p>checkpoint_timeout<br>系统自动执行checkpoint之间的最大时间间隔。系统默认值是5分钟，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO</p>\n<p>max_wal_size<br>写满多少个WAL时执行checkpoint，也是同理，这个值可以在压测过程中调大，尽量避免执行checkpoint争抢IO</p>\n<p>min_wal_size<br>只要wal日志目录使用空间小于该值，那么旧的wal日志就会循环使用而不是进行删除。这个参数是为了确保足够的wal空间预留给突发情况，比如大的跑批操作。</p>\n<p>checkpoint_completion_target<br>分散检查点，默认为0.5，即表示每个checkpoint需要在checkpoints间隔时间的50%内完成，然后立马进行fsync，fsync执行是很快的(为了平滑fsync，以防尖锐的IO请求，PostgreSQL9.6以后加了checkpoint_flush_after、wal_writer_flush_after、bgwriter_flush_after和backend_flush_after这些参数来缓解)看如下一个场景。<br>| 场景                             | 数据量 | 数据写入速度( 1gb/ s )          |<br>| -                                | -      | -                               |<br>| checkpoint_completion_target=0.5 | 100G   | 100/ ( 0.53060 ) 1024 ≈ 114 M/s |<br>| checkpoint_timeout = 30min       | 100G   | 100/ ( 0.8 3060 ) 1024 ≈ 71 M/s |</p>\n<p>full_page_writes<br>PostgreSQL服务器在检查点之后对页面的第一次写入时将整个页面写到WAL里面。如果checkpoint发生太频繁，会导致写放大，默认为on，假如调为off，需要确保数据库在压测期间不要崩溃，不然重启后可能发生数据块部分写，导致重启失败。full_page_writes就是为了确保数据页一致性，不发生块折断。而在MySQL中，则是通过double write来预防partial write的。如果你的块设备对齐，并支持原子写(原子写大于或等于一个DATA FILE数据页的大小)，那可以关闭这个参数</p>\n<h1 id=\"background-writer\"><a href=\"#background-writer\" class=\"headerlink\" title=\"background writer\"></a>background writer</h1><h2 id=\"功能描述-1\"><a href=\"#功能描述-1\" class=\"headerlink\" title=\"功能描述\"></a>功能描述</h2><p>1、数据库在进行查询处理时若发现要读取的数据不在缓冲区中时要先从磁盘中读入需要的页面，此时如果缓冲区已满，则需要遵从类似于LRU算法先选择部分缓冲区中的页面置换出去。如果被替换的页面没有被修改过，则可以直接丢弃；但如果已经被修改过，则需要先将这些页面写出到磁盘后才能置换，通过使用BgWriter定期写出缓冲区中的部分脏页，为缓冲区腾出空间，就可以降低查询处理被阻塞的可能性；</p>\n<p>2、PostgreSQL在定期做检查点时需要把所有脏页写出到磁盘，通过BgWriter预先写出一些脏页，可以减少检查点时要进行的IO动作，使系统的IO更加平稳。通过BgWriter对共享缓冲区写操作的管理，避免了其他服务进程在需要读入新的页面到缓冲区时，不得不先进行写盘的操作。</p>\n<h2 id=\"参数-1\"><a href=\"#参数-1\" class=\"headerlink\" title=\"参数\"></a>参数</h2><p>writer_delay<br>background writer每次扫描之间的时间间隔，也就是刷shared buffer脏页的进程调度间隔，尽量高频调度，减少用户进程申请不到内存而需要主动刷脏页的可能(导致RT升高)</p>\n<p>bgwriter_lru_maxpages<br>一次最多刷多少脏页</p>\n<p>bgwriter_lru_multiplier<br>写出至多bgwriter_lru_multiplier * N个脏页，并且不超过bgwriter_lru_maxpages值的限制。其中N是最近一段时间在两次BgWriter运行期间系统新申请的缓冲区页数。后台写进程根据最近服务进程需要的buffer数量乘上这个比率估算出下次服务进程需要的buffer数量，再使用后台写进程刷脏页面，使缓冲区能使用的干净页面达到这个估计值</p>\n<p>bgwriter_flush_after<br>每当bgwriter写入的字节数超过bgwriter_flush_after时，就会强制OS从page cache中写出。这样做将限制page cache中脏数据量，从而减少在检查点末尾发出fsync或操作系统在后台大批量写回数据时出现停顿的可能性</p>"},{"title":"PostgreSQL git commit 阅读记录","date":"2021-01-22T03:43:14.000Z","top":30,"description":null,"password":null,"_content":"\n\n记录阅读PostgreSQL git 提交记录, 觉得好的记录一下.\n\n<!-- more -->\n\n# PG14\n\n## Enable parallel SELECT for \"INSERT INTO ... SELECT ...\"\n\n```\ncommit 05c8482f7f69a954fd65fce85f896e848fc48197\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Wed Mar 10 07:38:58 2021 +0530\n\n    Enable parallel SELECT for \"INSERT INTO ... SELECT ...\".\n\n    Parallel SELECT can't be utilized for INSERT in the following cases:\n    - INSERT statement uses the ON CONFLICT DO UPDATE clause\n    - Target table has a parallel-unsafe: trigger, index expression or\n      predicate, column default expression or check constraint\n    - Target table has a parallel-unsafe domain constraint on any column\n    - Target table is a partitioned table with a parallel-unsafe partition key\n      expression or support function\n\n    The planner is updated to perform additional parallel-safety checks for\n    the cases listed above, for determining whether it is safe to run INSERT\n    in parallel-mode with an underlying parallel SELECT. The planner will\n    consider using parallel SELECT for \"INSERT INTO ... SELECT ...\", provided\n    nothing unsafe is found from the additional parallel-safety checks, or\n    from the existing parallel-safety checks for SELECT.\n\n    While checking parallel-safety, we need to check it for all the partitions\n    on the table which can be costly especially when we decide not to use a\n    parallel plan. So, in a separate patch, we will introduce a GUC and or a\n    reloption to enable/disable parallelism for Insert statements.\n\n    Prior to entering parallel-mode for the execution of INSERT with parallel\n    SELECT, a TransactionId is acquired and assigned to the current\n    transaction state. This is necessary to prevent the INSERT from attempting\n    to assign the TransactionId whilst in parallel-mode, which is not allowed.\n    This approach has a disadvantage in that if the underlying SELECT does not\n    return any rows, then the TransactionId is not used, however that\n    shouldn't happen in practice in many cases.\n\n    Author: Greg Nancarrow, Amit Langote, Amit Kapila\n    Reviewed-by: Amit Langote, Hou Zhijie, Takayuki Tsunakawa, Antonin Houska, Bharath Rupireddy, Dilip Kumar, Vignesh C, Zhihong Yu, Amit Kapila\n    Tested-by: Tang, Haiying\n    Discussion: https://postgr.es/m/CAJcOf-cXnB5cnMKqWEp2E2z7Mvcd04iLVmV=qpFJrR3AcrTS3g@mail.gmail.com\n    Discussion: https://postgr.es/m/CAJcOf-fAdj=nDKMsRhQzndm-O13NY4dL6xGcEvdX5Xvbbi0V7g@mail.gmail.com\n\ncommit 0ba71107efeeccde9158f47118f95043afdca0bb\n\n```\n\n## Add --tablespace option to reindexd\n```\n    Add --tablespace option to reindexdb\n\n    This option provides REINDEX (TABLESPACE) for reindexdb, applying the\n    tablespace value given by the caller to all the REINDEX queries\n    generated.\n\n    While on it, this commit adds some tests for REINDEX TABLESPACE, with\n    and without CONCURRENTLY, when run on toast indexes and tables.  Such\n    operations are not allowed, and toast relation names are not stable\n    enough to be part of the main regression test suite (even if using a PL\n    function with a TRY/CATCH logic, as CONCURRENTLY could not be tested).\n\n    Author: Michael Paquier\n\n```\n\n## target_session_attrs 增加　read-only primary standby prefer-standby 支持\n```\n    Extend the abilities of libpq's target_session_attrs parameter.\n\n    In addition to the existing options of \"any\" and \"read-write\", we\n    now support \"read-only\", \"primary\", \"standby\", and \"prefer-standby\".\n    \"read-write\" retains its previous meaning of \"transactions are\n    read-write by default\", and \"read-only\" inverts that.  The other\n    three modes test specifically for hot-standby status, which is not\n    quite the same thing.  (Setting default_transaction_read_only on\n    a primary server renders it read-only to this logic, but not a\n    standby.)\n\n    Furthermore, if talking to a v14 or later server, no extra network\n    round trip is needed to detect the session's status; the GUC_REPORT\n    variables delivered by the server are enough.  When talking to an\n    older server, a SHOW or SELECT query is issued to detect session\n    read-only-ness or server hot-standby state, as needed.\n\n    Haribabu Kommi, Greg Nancarrow, Vignesh C, Tom Lane; reviewed at\n    various times by Laurenz Albe, Takayuki Tsunakawa, Peter Smith.\n\n    Discussion: https://postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com\n\n```\n\n## Add option PROCESS_TOAST to VACUUM\n```\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Tue Feb 9 14:13:57 2021 +0900\n\n    Add option PROCESS_TOAST to VACUUM\n\n    This option controls if toast tables associated with a relation are\n    vacuumed or not when running a manual VACUUM.  It was already possible\n    to trigger a manual VACUUM on a toast relation without processing its\n    main relation, but a manual vacuum on a main relation always forced a\n    vacuum on its toast table.  This is useful in scenarios where the level\n    of bloat or transaction age of the main and toast relations differs a\n    lot.\n\n    This option is an extension of the existing VACOPT_SKIPTOAST that was\n    used by autovacuum to control if toast relations should be skipped or\n    not.  This internal flag is renamed to VACOPT_PROCESS_TOAST for\n    consistency with the new option.\n\n    A new option switch, called --no-process-toast, is added to vacuumdb.\n\n    Author: Nathan Bossart\n    Reviewed-by: Kirk Jamison, Michael Paquier, Justin Pryzby\n    Discussion: https://postgr.es/m/BA8951E9-1524-48C5-94AF-73B1F0D7857F@amazon.com\n\n```\n\n## added \"hostgssenc\" type HBA entries\n```\ncommit 3995c424984e991b1069a2869af972dc07574c0b\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Mon Dec 28 17:58:58 2020 -0500\n\n    Improve log messages related to pg_hba.conf not matching a connection.\n\n    Include details on whether GSS encryption has been activated;\n    since we added \"hostgssenc\" type HBA entries, that's relevant info.\n\n    Kyotaro Horiguchi and Tom Lane.  Back-patch to v12 where\n    GSS encryption was introduced.\n\n    Discussion: https://postgr.es/m/e5b0b6ed05764324a2f3fe7acfc766d5@smhi.se\n\n```\n\n## Introduce a new GUC_REPORT setting \"in_hot_standby\"\n```\ncommit bf8a662c9afad6fd07b42cdc5e71416c51f75d31\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Tue Jan 5 16:18:01 2021 -0500\n\n    Introduce a new GUC_REPORT setting \"in_hot_standby\".\n\n    Aside from being queriable via SHOW, this value is sent to the client\n    immediately at session startup, and again later on if the server gets\n    promoted to primary during the session.  The immediate report will be\n    used in an upcoming patch to avoid an extra round trip when trying to\n    connect to a primary server.\n\n    Haribabu Kommi, Greg Nancarrow, Tom Lane; reviewed at various times\n    by Laurenz Albe, Takayuki Tsunakawa, Peter Smith.\n\n    Discussion: https://postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com\n\n```\n\n## Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀\n```\ncommit 9877374bef76ef03923f6aa8b955f2dbcbe6c2c7\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Wed Jan 6 18:28:42 2021 -0500\n\n    Add idle_session_timeout.\n\n    This GUC variable works much like idle_in_transaction_session_timeout,\n    in that it kills sessions that have waited too long for a new client\n    query.  But it applies when we're not in a transaction, rather than\n    when we are.\n\n    Li Japin, reviewed by David Johnston and Hayato Kuroda, some\n    fixes by me\n\n    Discussion: https://postgr.es/m/763A0689-F189-459E-946F-F0EC4458980B@hotmail.com\n\n\n```\n\n## Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟\n```\ncommit 0650ff23038bc3eb8d8fd851744db837d921e285\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Fri Jan 8 00:47:03 2021 +0900\n\n    Add GUC to log long wait times on recovery conflicts.\n\n    This commit adds GUC log_recovery_conflict_waits that controls whether\n    a log message is produced when the startup process is waiting longer than\n    deadlock_timeout for recovery conflicts. This is useful in determining\n    if recovery conflicts prevent the recovery from applying WAL.\n\n    Note that currently a log message is produced only when recovery conflict\n    has not been resolved yet even after deadlock_timeout passes, i.e.,\n    only when the startup process is still waiting for recovery conflict\n    even after deadlock_timeout.\n\n    Author: Bertrand Drouvot, Masahiko Sawada\n    Reviewed-by: Alvaro Herrera, Kyotaro Horiguchi, Fujii Masao\n    Discussion: https://postgr.es/m/9a60178c-a853-1440-2cdc-c3af916cff59@amazon.com\n\n```\n\n## Add pg_stat_database counters for sessions and session time\n```\ncommit 960869da0803427d14335bba24393f414b476e2c\nAuthor: Magnus Hagander <magnus@hagander.net>\nDate:   Sun Jan 17 13:34:09 2021 +0100\n\n    Add pg_stat_database counters for sessions and session time\n\n    This add counters for number of sessions, the different kind of session\n    termination types, and timers for how much time is spent in active vs\n    idle in a database to pg_stat_database.\n\n    Internally this also renames the parameter \"force\" to disconnect. This\n    was the only use-case for the parameter before, so repurposing it to\n    this mroe narrow usecase makes things cleaner than inventing something\n    new.\n\n    Author: Laurenz Albe\n    Reviewed-By: Magnus Hagander, Soumyadeep Chakraborty, Masahiro Ikeda\n    Discussion: https://postgr.es/m/b07e1f9953701b90c66ed368656f2aef40cac4fb.camel@cybertec.at\n\n```\n\n## psql \\dX: list extended statistics objects\n```\ncommit 891a1d0bca262ca78564e0fea1eaa5ae544ea5ee\nAuthor: Tomas Vondra <tomas.vondra@postgresql.org>\nDate:   Sun Jan 17 00:16:25 2021 +0100\n\n    psql \\dX: list extended statistics objects\n\n    The new command lists extended statistics objects, possibly with their\n    sizes. All past releases with extended statistics are supported.\n\n    Author: Tatsuro Yamada\n    Reviewed-by: Julien Rouhaud, Alvaro Herrera, Tomas Vondra\n    Discussion: https://postgr.es/m/c027a541-5856-75a5-0868-341301e1624b%40nttcom.co.jp_1\n```\n```\ncommit 1db0d173a2201119f297ea35edfb41579893dd8c\nAuthor: Tomas Vondra <tomas.vondra@postgresql.org>\nDate:   Sun Jan 17 15:11:14 2021 +0100\n\n    Revert \"psql \\dX: list extended statistics objects\"\n\n    Reverts 891a1d0bca, because the new  psql command \\dX only worked for\n    users users who can read pg_statistic_ext_data catalog, and most regular\n    users lack that privilege (the catalog may contain sensitive user data).\n\n    Reported-by: Noriyoshi Shinoda\n    Discussion: https://postgr.es/m/c027a541-5856-75a5-0868-341301e1624b%40nttcom.co.jp_1\n```\n\n## 感觉14版本做了很多FDW的优化，是为集群模式做准备?\n\n```\ncommit 8e396a773b80c72e5d5a0ca9755dffe043c97a05\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Thu Jan 14 16:19:38 2021 -0500\n\n    pg_dump: label PUBLICATION TABLE ArchiveEntries with an owner.\n\n    This is the same fix as commit 9eabfe300 applied to INDEX ATTACH\n    entries, but for table-to-publication attachments.  As in that\n    case, even though the backend doesn't record \"ownership\" of the\n    attachment, we still ought to label it in the dump archive with\n    the role name that should run the ALTER PUBLICATION command.\n    The existing behavior causes the ALTER to be done by the original\n    role that started the restore; that will usually work fine, but\n    there may be corner cases where it fails.\n\n    The bulk of the patch is concerned with changing struct\n    PublicationRelInfo to include a pointer to the associated\n    PublicationInfo object, so that we can get the owner's name\n    out of that when the time comes.  While at it, I rewrote\n    getPublicationTables() to do just one query of pg_publication_rel,\n    not one per table.\n\n    Back-patch to v10 where this code was introduced.\n\n    Discussion: https://postgr.es/m/1165710.1610473242@sss.pgh.pa.us\n```\n\n```\ncommit 708d165ddb92c54077a372acf6417e258dcb5fef\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jan 18 15:11:08 2021 +0900\n\n    postgres_fdw: Add function to list cached connections to foreign servers.\n\n    This commit adds function postgres_fdw_get_connections() to return\n    the foreign server names of all the open connections that postgres_fdw\n    established from the local session to the foreign servers. This function\n    also returns whether each connection is valid or not.\n\n    This function is useful when checking all the open foreign server connections.\n    If we found some connection to drop, from the result of function, probably\n    we can explicitly close them by the function that upcoming commit will add.\n\n    This commit bumps the version of postgres_fdw to 1.1 since it adds\n    new function.\n\n    Author: Bharath Rupireddy, tweaked by Fujii Masao\n    Reviewed-by: Zhijie Hou, Alexey Kondratov, Zhihong Yu, Fujii Masao\n    Discussion: https://postgr.es/m/2d5cb0b3-a6e8-9bbb-953f-879f47128faa@oss.nttdata.com\n\n```\n\n```\ncommit ee79a548e746da9a99df0cac70a3ddc095f2829a\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Tue Jan 19 00:56:10 2021 +0900\n\n    doc: Add note about the server name of postgres_fdw_get_connections() returns.\n\n    Previously the document didn't mention the case where\n    postgres_fdw_get_connections() returns NULL in server_name column.\n    Users might be confused about why NULL was returned.\n\n    This commit adds the note that, in postgres_fdw_get_connections(),\n    the server name of an invalid connection will be NULL if the server is dropped.\n\n    Suggested-by: Zhijie Hou\n    Author: Bharath Rupireddy\n    Reviewed-by: Zhijie Hou, Fujii Masao\n    Discussion: https://postgr.es/m/e7ddd14e96444fce88e47a709c196537@G08CNEXMBPEKD05.g08.fujitsu.local\n```\n\n```\ncommit e3ebcca843a4703938b9f40a4811f43c4b315753\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Dec 28 19:56:13 2020 +0900\n\n    postgres_fdw: Fix connection leak.\n\n    In postgres_fdw, the cached connections to foreign servers will not be\n    closed until the local session exits if the user mappings or foreign servers\n    that those connections depend on are dropped. Those connections can be\n    leaked.\n\n    To fix that connection leak issue, after a change to a pg_foreign_server\n    or pg_user_mapping catalog entry, this commit makes postgres_fdw close\n    the connections depending on that entry immediately if current\n    transaction has not used those connections yet. Otherwise, mark those\n    connections as invalid and then close them at the end of current transaction,\n    since they cannot be closed in the midst of the transaction using them.\n    Closed connections will be remade at the next opportunity if necessary.\n\n    Back-patch to all supported branches.\n\n    Author: Bharath Rupireddy\n    Reviewed-by: Zhihong Yu, Zhijie Hou, Fujii Masao\n    Discussion: https://postgr.es/m/CALj2ACVNcGH_6qLY-4_tXz8JLvA+4yeBThRfxMz7Oxbk1aHcpQ@mail.gmail.com\n\n```\n","source":"_posts/PostgreSQL_git_log.md","raw":"---\ntitle: PostgreSQL git commit 阅读记录\ndate: 2021-01-22 11:43:14\ntags: \n- PostgreSQL\n- git \n- commit log\ncategories: \n- PostgreSQL\ntop: 30\ndescription: \npassword: \n\n---\n\n\n记录阅读PostgreSQL git 提交记录, 觉得好的记录一下.\n\n<!-- more -->\n\n# PG14\n\n## Enable parallel SELECT for \"INSERT INTO ... SELECT ...\"\n\n```\ncommit 05c8482f7f69a954fd65fce85f896e848fc48197\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Wed Mar 10 07:38:58 2021 +0530\n\n    Enable parallel SELECT for \"INSERT INTO ... SELECT ...\".\n\n    Parallel SELECT can't be utilized for INSERT in the following cases:\n    - INSERT statement uses the ON CONFLICT DO UPDATE clause\n    - Target table has a parallel-unsafe: trigger, index expression or\n      predicate, column default expression or check constraint\n    - Target table has a parallel-unsafe domain constraint on any column\n    - Target table is a partitioned table with a parallel-unsafe partition key\n      expression or support function\n\n    The planner is updated to perform additional parallel-safety checks for\n    the cases listed above, for determining whether it is safe to run INSERT\n    in parallel-mode with an underlying parallel SELECT. The planner will\n    consider using parallel SELECT for \"INSERT INTO ... SELECT ...\", provided\n    nothing unsafe is found from the additional parallel-safety checks, or\n    from the existing parallel-safety checks for SELECT.\n\n    While checking parallel-safety, we need to check it for all the partitions\n    on the table which can be costly especially when we decide not to use a\n    parallel plan. So, in a separate patch, we will introduce a GUC and or a\n    reloption to enable/disable parallelism for Insert statements.\n\n    Prior to entering parallel-mode for the execution of INSERT with parallel\n    SELECT, a TransactionId is acquired and assigned to the current\n    transaction state. This is necessary to prevent the INSERT from attempting\n    to assign the TransactionId whilst in parallel-mode, which is not allowed.\n    This approach has a disadvantage in that if the underlying SELECT does not\n    return any rows, then the TransactionId is not used, however that\n    shouldn't happen in practice in many cases.\n\n    Author: Greg Nancarrow, Amit Langote, Amit Kapila\n    Reviewed-by: Amit Langote, Hou Zhijie, Takayuki Tsunakawa, Antonin Houska, Bharath Rupireddy, Dilip Kumar, Vignesh C, Zhihong Yu, Amit Kapila\n    Tested-by: Tang, Haiying\n    Discussion: https://postgr.es/m/CAJcOf-cXnB5cnMKqWEp2E2z7Mvcd04iLVmV=qpFJrR3AcrTS3g@mail.gmail.com\n    Discussion: https://postgr.es/m/CAJcOf-fAdj=nDKMsRhQzndm-O13NY4dL6xGcEvdX5Xvbbi0V7g@mail.gmail.com\n\ncommit 0ba71107efeeccde9158f47118f95043afdca0bb\n\n```\n\n## Add --tablespace option to reindexd\n```\n    Add --tablespace option to reindexdb\n\n    This option provides REINDEX (TABLESPACE) for reindexdb, applying the\n    tablespace value given by the caller to all the REINDEX queries\n    generated.\n\n    While on it, this commit adds some tests for REINDEX TABLESPACE, with\n    and without CONCURRENTLY, when run on toast indexes and tables.  Such\n    operations are not allowed, and toast relation names are not stable\n    enough to be part of the main regression test suite (even if using a PL\n    function with a TRY/CATCH logic, as CONCURRENTLY could not be tested).\n\n    Author: Michael Paquier\n\n```\n\n## target_session_attrs 增加　read-only primary standby prefer-standby 支持\n```\n    Extend the abilities of libpq's target_session_attrs parameter.\n\n    In addition to the existing options of \"any\" and \"read-write\", we\n    now support \"read-only\", \"primary\", \"standby\", and \"prefer-standby\".\n    \"read-write\" retains its previous meaning of \"transactions are\n    read-write by default\", and \"read-only\" inverts that.  The other\n    three modes test specifically for hot-standby status, which is not\n    quite the same thing.  (Setting default_transaction_read_only on\n    a primary server renders it read-only to this logic, but not a\n    standby.)\n\n    Furthermore, if talking to a v14 or later server, no extra network\n    round trip is needed to detect the session's status; the GUC_REPORT\n    variables delivered by the server are enough.  When talking to an\n    older server, a SHOW or SELECT query is issued to detect session\n    read-only-ness or server hot-standby state, as needed.\n\n    Haribabu Kommi, Greg Nancarrow, Vignesh C, Tom Lane; reviewed at\n    various times by Laurenz Albe, Takayuki Tsunakawa, Peter Smith.\n\n    Discussion: https://postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com\n\n```\n\n## Add option PROCESS_TOAST to VACUUM\n```\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Tue Feb 9 14:13:57 2021 +0900\n\n    Add option PROCESS_TOAST to VACUUM\n\n    This option controls if toast tables associated with a relation are\n    vacuumed or not when running a manual VACUUM.  It was already possible\n    to trigger a manual VACUUM on a toast relation without processing its\n    main relation, but a manual vacuum on a main relation always forced a\n    vacuum on its toast table.  This is useful in scenarios where the level\n    of bloat or transaction age of the main and toast relations differs a\n    lot.\n\n    This option is an extension of the existing VACOPT_SKIPTOAST that was\n    used by autovacuum to control if toast relations should be skipped or\n    not.  This internal flag is renamed to VACOPT_PROCESS_TOAST for\n    consistency with the new option.\n\n    A new option switch, called --no-process-toast, is added to vacuumdb.\n\n    Author: Nathan Bossart\n    Reviewed-by: Kirk Jamison, Michael Paquier, Justin Pryzby\n    Discussion: https://postgr.es/m/BA8951E9-1524-48C5-94AF-73B1F0D7857F@amazon.com\n\n```\n\n## added \"hostgssenc\" type HBA entries\n```\ncommit 3995c424984e991b1069a2869af972dc07574c0b\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Mon Dec 28 17:58:58 2020 -0500\n\n    Improve log messages related to pg_hba.conf not matching a connection.\n\n    Include details on whether GSS encryption has been activated;\n    since we added \"hostgssenc\" type HBA entries, that's relevant info.\n\n    Kyotaro Horiguchi and Tom Lane.  Back-patch to v12 where\n    GSS encryption was introduced.\n\n    Discussion: https://postgr.es/m/e5b0b6ed05764324a2f3fe7acfc766d5@smhi.se\n\n```\n\n## Introduce a new GUC_REPORT setting \"in_hot_standby\"\n```\ncommit bf8a662c9afad6fd07b42cdc5e71416c51f75d31\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Tue Jan 5 16:18:01 2021 -0500\n\n    Introduce a new GUC_REPORT setting \"in_hot_standby\".\n\n    Aside from being queriable via SHOW, this value is sent to the client\n    immediately at session startup, and again later on if the server gets\n    promoted to primary during the session.  The immediate report will be\n    used in an upcoming patch to avoid an extra round trip when trying to\n    connect to a primary server.\n\n    Haribabu Kommi, Greg Nancarrow, Tom Lane; reviewed at various times\n    by Laurenz Albe, Takayuki Tsunakawa, Peter Smith.\n\n    Discussion: https://postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com\n\n```\n\n## Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀\n```\ncommit 9877374bef76ef03923f6aa8b955f2dbcbe6c2c7\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Wed Jan 6 18:28:42 2021 -0500\n\n    Add idle_session_timeout.\n\n    This GUC variable works much like idle_in_transaction_session_timeout,\n    in that it kills sessions that have waited too long for a new client\n    query.  But it applies when we're not in a transaction, rather than\n    when we are.\n\n    Li Japin, reviewed by David Johnston and Hayato Kuroda, some\n    fixes by me\n\n    Discussion: https://postgr.es/m/763A0689-F189-459E-946F-F0EC4458980B@hotmail.com\n\n\n```\n\n## Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟\n```\ncommit 0650ff23038bc3eb8d8fd851744db837d921e285\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Fri Jan 8 00:47:03 2021 +0900\n\n    Add GUC to log long wait times on recovery conflicts.\n\n    This commit adds GUC log_recovery_conflict_waits that controls whether\n    a log message is produced when the startup process is waiting longer than\n    deadlock_timeout for recovery conflicts. This is useful in determining\n    if recovery conflicts prevent the recovery from applying WAL.\n\n    Note that currently a log message is produced only when recovery conflict\n    has not been resolved yet even after deadlock_timeout passes, i.e.,\n    only when the startup process is still waiting for recovery conflict\n    even after deadlock_timeout.\n\n    Author: Bertrand Drouvot, Masahiko Sawada\n    Reviewed-by: Alvaro Herrera, Kyotaro Horiguchi, Fujii Masao\n    Discussion: https://postgr.es/m/9a60178c-a853-1440-2cdc-c3af916cff59@amazon.com\n\n```\n\n## Add pg_stat_database counters for sessions and session time\n```\ncommit 960869da0803427d14335bba24393f414b476e2c\nAuthor: Magnus Hagander <magnus@hagander.net>\nDate:   Sun Jan 17 13:34:09 2021 +0100\n\n    Add pg_stat_database counters for sessions and session time\n\n    This add counters for number of sessions, the different kind of session\n    termination types, and timers for how much time is spent in active vs\n    idle in a database to pg_stat_database.\n\n    Internally this also renames the parameter \"force\" to disconnect. This\n    was the only use-case for the parameter before, so repurposing it to\n    this mroe narrow usecase makes things cleaner than inventing something\n    new.\n\n    Author: Laurenz Albe\n    Reviewed-By: Magnus Hagander, Soumyadeep Chakraborty, Masahiro Ikeda\n    Discussion: https://postgr.es/m/b07e1f9953701b90c66ed368656f2aef40cac4fb.camel@cybertec.at\n\n```\n\n## psql \\dX: list extended statistics objects\n```\ncommit 891a1d0bca262ca78564e0fea1eaa5ae544ea5ee\nAuthor: Tomas Vondra <tomas.vondra@postgresql.org>\nDate:   Sun Jan 17 00:16:25 2021 +0100\n\n    psql \\dX: list extended statistics objects\n\n    The new command lists extended statistics objects, possibly with their\n    sizes. All past releases with extended statistics are supported.\n\n    Author: Tatsuro Yamada\n    Reviewed-by: Julien Rouhaud, Alvaro Herrera, Tomas Vondra\n    Discussion: https://postgr.es/m/c027a541-5856-75a5-0868-341301e1624b%40nttcom.co.jp_1\n```\n```\ncommit 1db0d173a2201119f297ea35edfb41579893dd8c\nAuthor: Tomas Vondra <tomas.vondra@postgresql.org>\nDate:   Sun Jan 17 15:11:14 2021 +0100\n\n    Revert \"psql \\dX: list extended statistics objects\"\n\n    Reverts 891a1d0bca, because the new  psql command \\dX only worked for\n    users users who can read pg_statistic_ext_data catalog, and most regular\n    users lack that privilege (the catalog may contain sensitive user data).\n\n    Reported-by: Noriyoshi Shinoda\n    Discussion: https://postgr.es/m/c027a541-5856-75a5-0868-341301e1624b%40nttcom.co.jp_1\n```\n\n## 感觉14版本做了很多FDW的优化，是为集群模式做准备?\n\n```\ncommit 8e396a773b80c72e5d5a0ca9755dffe043c97a05\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Thu Jan 14 16:19:38 2021 -0500\n\n    pg_dump: label PUBLICATION TABLE ArchiveEntries with an owner.\n\n    This is the same fix as commit 9eabfe300 applied to INDEX ATTACH\n    entries, but for table-to-publication attachments.  As in that\n    case, even though the backend doesn't record \"ownership\" of the\n    attachment, we still ought to label it in the dump archive with\n    the role name that should run the ALTER PUBLICATION command.\n    The existing behavior causes the ALTER to be done by the original\n    role that started the restore; that will usually work fine, but\n    there may be corner cases where it fails.\n\n    The bulk of the patch is concerned with changing struct\n    PublicationRelInfo to include a pointer to the associated\n    PublicationInfo object, so that we can get the owner's name\n    out of that when the time comes.  While at it, I rewrote\n    getPublicationTables() to do just one query of pg_publication_rel,\n    not one per table.\n\n    Back-patch to v10 where this code was introduced.\n\n    Discussion: https://postgr.es/m/1165710.1610473242@sss.pgh.pa.us\n```\n\n```\ncommit 708d165ddb92c54077a372acf6417e258dcb5fef\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jan 18 15:11:08 2021 +0900\n\n    postgres_fdw: Add function to list cached connections to foreign servers.\n\n    This commit adds function postgres_fdw_get_connections() to return\n    the foreign server names of all the open connections that postgres_fdw\n    established from the local session to the foreign servers. This function\n    also returns whether each connection is valid or not.\n\n    This function is useful when checking all the open foreign server connections.\n    If we found some connection to drop, from the result of function, probably\n    we can explicitly close them by the function that upcoming commit will add.\n\n    This commit bumps the version of postgres_fdw to 1.1 since it adds\n    new function.\n\n    Author: Bharath Rupireddy, tweaked by Fujii Masao\n    Reviewed-by: Zhijie Hou, Alexey Kondratov, Zhihong Yu, Fujii Masao\n    Discussion: https://postgr.es/m/2d5cb0b3-a6e8-9bbb-953f-879f47128faa@oss.nttdata.com\n\n```\n\n```\ncommit ee79a548e746da9a99df0cac70a3ddc095f2829a\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Tue Jan 19 00:56:10 2021 +0900\n\n    doc: Add note about the server name of postgres_fdw_get_connections() returns.\n\n    Previously the document didn't mention the case where\n    postgres_fdw_get_connections() returns NULL in server_name column.\n    Users might be confused about why NULL was returned.\n\n    This commit adds the note that, in postgres_fdw_get_connections(),\n    the server name of an invalid connection will be NULL if the server is dropped.\n\n    Suggested-by: Zhijie Hou\n    Author: Bharath Rupireddy\n    Reviewed-by: Zhijie Hou, Fujii Masao\n    Discussion: https://postgr.es/m/e7ddd14e96444fce88e47a709c196537@G08CNEXMBPEKD05.g08.fujitsu.local\n```\n\n```\ncommit e3ebcca843a4703938b9f40a4811f43c4b315753\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Dec 28 19:56:13 2020 +0900\n\n    postgres_fdw: Fix connection leak.\n\n    In postgres_fdw, the cached connections to foreign servers will not be\n    closed until the local session exits if the user mappings or foreign servers\n    that those connections depend on are dropped. Those connections can be\n    leaked.\n\n    To fix that connection leak issue, after a change to a pg_foreign_server\n    or pg_user_mapping catalog entry, this commit makes postgres_fdw close\n    the connections depending on that entry immediately if current\n    transaction has not used those connections yet. Otherwise, mark those\n    connections as invalid and then close them at the end of current transaction,\n    since they cannot be closed in the midst of the transaction using them.\n    Closed connections will be remade at the next opportunity if necessary.\n\n    Back-patch to all supported branches.\n\n    Author: Bharath Rupireddy\n    Reviewed-by: Zhihong Yu, Zhijie Hou, Fujii Masao\n    Discussion: https://postgr.es/m/CALj2ACVNcGH_6qLY-4_tXz8JLvA+4yeBThRfxMz7Oxbk1aHcpQ@mail.gmail.com\n\n```\n","slug":"PostgreSQL_git_log","published":1,"updated":"2021-03-11T07:25:27.103Z","_id":"cklw1fzh80005piebh6xmf5u8","comments":1,"layout":"post","photos":[],"link":"","content":"<p>记录阅读PostgreSQL git 提交记录, 觉得好的记录一下.</p>\n<a id=\"more\"></a>\n<h1 id=\"PG14\"><a href=\"#PG14\" class=\"headerlink\" title=\"PG14\"></a>PG14</h1><h2 id=\"Enable-parallel-SELECT-for-“INSERT-INTO-…-SELECT-…”\"><a href=\"#Enable-parallel-SELECT-for-“INSERT-INTO-…-SELECT-…”\" class=\"headerlink\" title=\"Enable parallel SELECT for “INSERT INTO … SELECT …”\"></a>Enable parallel SELECT for “INSERT INTO … SELECT …”</h2><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vhdl\">commit <span class=\"hljs-number\">05</span>c8482f7f69a954fd65fce85f896e848fc48197<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br>Date:   Wed Mar <span class=\"hljs-number\">10</span> <span class=\"hljs-number\">07</span>:<span class=\"hljs-number\">38</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0530</span><br><br>    Enable parallel <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&quot;INSERT INTO ... SELECT ...&quot;</span>.<br><br>    Parallel <span class=\"hljs-keyword\">SELECT</span> can<span class=\"hljs-symbol\">&#x27;t</span> be utilized <span class=\"hljs-keyword\">for</span> INSERT <span class=\"hljs-keyword\">in</span> the following cases:<br>    - INSERT statement uses the <span class=\"hljs-keyword\">ON</span> CONFLICT DO UPDATE clause<br>    - Target table has a parallel-unsafe: trigger, index expression <span class=\"hljs-keyword\">or</span><br>      predicate, column <span class=\"hljs-keyword\">default</span> expression <span class=\"hljs-keyword\">or</span> check constraint<br>    - Target table has a parallel-unsafe domain constraint <span class=\"hljs-keyword\">on</span> any column<br>    - Target table <span class=\"hljs-keyword\">is</span> a partitioned table <span class=\"hljs-keyword\">with</span> a parallel-unsafe partition key<br>      expression <span class=\"hljs-keyword\">or</span> support <span class=\"hljs-keyword\">function</span><br><br>    The planner <span class=\"hljs-keyword\">is</span> updated <span class=\"hljs-keyword\">to</span> perform additional parallel-safety checks <span class=\"hljs-keyword\">for</span><br>    the cases listed above, <span class=\"hljs-keyword\">for</span> determining whether it <span class=\"hljs-keyword\">is</span> safe <span class=\"hljs-keyword\">to</span> run INSERT<br>    <span class=\"hljs-keyword\">in</span> parallel-mode <span class=\"hljs-keyword\">with</span> an underlying parallel <span class=\"hljs-keyword\">SELECT</span>. The planner will<br>    consider using parallel <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&quot;INSERT INTO ... SELECT ...&quot;</span>, provided<br>    nothing unsafe <span class=\"hljs-keyword\">is</span> found from the additional parallel-safety checks, <span class=\"hljs-keyword\">or</span><br>    from the existing parallel-safety checks <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">SELECT</span>.<br><br>    <span class=\"hljs-keyword\">While</span> checking parallel-safety, we need <span class=\"hljs-keyword\">to</span> check it <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">all</span> the partitions<br>    <span class=\"hljs-keyword\">on</span> the table which can be costly especially <span class=\"hljs-keyword\">when</span> we decide <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">use</span> a<br>    parallel plan. So, <span class=\"hljs-keyword\">in</span> a separate patch, we will introduce a GUC <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">or</span> a<br>    reloption <span class=\"hljs-keyword\">to</span> enable/disable parallelism <span class=\"hljs-keyword\">for</span> Insert statements.<br><br>    Prior <span class=\"hljs-keyword\">to</span> entering parallel-mode <span class=\"hljs-keyword\">for</span> the execution <span class=\"hljs-keyword\">of</span> INSERT <span class=\"hljs-keyword\">with</span> parallel<br>    <span class=\"hljs-keyword\">SELECT</span>, a TransactionId <span class=\"hljs-keyword\">is</span> acquired <span class=\"hljs-keyword\">and</span> assigned <span class=\"hljs-keyword\">to</span> the current<br>    transaction state. This <span class=\"hljs-keyword\">is</span> necessary <span class=\"hljs-keyword\">to</span> prevent the INSERT from attempting<br>    <span class=\"hljs-keyword\">to</span> assign the TransactionId whilst <span class=\"hljs-keyword\">in</span> parallel-mode, which <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> allowed.<br>    This approach has a disadvantage <span class=\"hljs-keyword\">in</span> that <span class=\"hljs-keyword\">if</span> the underlying <span class=\"hljs-keyword\">SELECT</span> does <span class=\"hljs-keyword\">not</span><br>    <span class=\"hljs-keyword\">return</span> any rows, <span class=\"hljs-keyword\">then</span> the TransactionId <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> used, however that<br>    shouldn<span class=\"hljs-symbol\">&#x27;t</span> happen <span class=\"hljs-keyword\">in</span> practice <span class=\"hljs-keyword\">in</span> many cases.<br><br>    Author: Greg Nancarrow, Amit Langote, Amit Kapila<br>    Reviewed-by: Amit Langote, Hou Zhijie, Takayuki Tsunakawa, Antonin Houska, Bharath Rupireddy, Dilip Kumar, Vignesh C, Zhihong Yu, Amit Kapila<br>    Tested-by: Tang, Haiying<br>    Discussion: https://postgr.es/m/CAJcOf-cXnB5cnMKqWEp2E2z7Mvcd04iLVmV=qpFJrR3AcrTS3g@mail.gmail.com<br>    Discussion: https://postgr.es/m/CAJcOf-fAdj=nDKMsRhQzndm-O13NY4dL6xGcEvdX5Xvbbi0V7g@mail.gmail.com<br><br>commit <span class=\"hljs-number\">0</span>ba71107efeeccde9158f47118f95043afdca0bb<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-—tablespace-option-to-reindexd\"><a href=\"#Add-—tablespace-option-to-reindexd\" class=\"headerlink\" title=\"Add —tablespace option to reindexd\"></a>Add —tablespace option to reindexd</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">Add</span> <span class=\"hljs-comment\">--tablespace option to reindexdb</span><br><br>This <span class=\"hljs-keyword\">option</span> provides <span class=\"hljs-keyword\">REINDEX</span> (<span class=\"hljs-keyword\">TABLESPACE</span>) <span class=\"hljs-keyword\">for</span> reindexdb, applying the<br><span class=\"hljs-keyword\">tablespace</span> <span class=\"hljs-keyword\">value</span> given <span class=\"hljs-keyword\">by</span> the caller <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">REINDEX</span> queries<br><span class=\"hljs-keyword\">generated</span>.<br><br><span class=\"hljs-keyword\">While</span> <span class=\"hljs-keyword\">on</span> it, this <span class=\"hljs-keyword\">commit</span> adds <span class=\"hljs-keyword\">some</span> tests <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">REINDEX</span> <span class=\"hljs-keyword\">TABLESPACE</span>, <span class=\"hljs-keyword\">with</span><br><span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">without</span> <span class=\"hljs-keyword\">CONCURRENTLY</span>, <span class=\"hljs-keyword\">when</span> run <span class=\"hljs-keyword\">on</span> toast indexes <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">tables</span>.  Such<br>operations are <span class=\"hljs-keyword\">not</span> allowed, <span class=\"hljs-keyword\">and</span> toast relation names are <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">stable</span><br>enough <span class=\"hljs-keyword\">to</span> be part <span class=\"hljs-keyword\">of</span> the main regression test suite (even <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">using</span> a PL<br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">with</span> a TRY/CATCH logic, <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> could <span class=\"hljs-keyword\">not</span> be tested).<br><br>Author: Michael Paquier<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"target-session-attrs-增加-read-only-primary-standby-prefer-standby-支持\"><a href=\"#target-session-attrs-增加-read-only-primary-standby-prefer-standby-支持\" class=\"headerlink\" title=\"target_session_attrs 增加　read-only primary standby prefer-standby 支持\"></a>target_session_attrs 增加　read-only primary standby prefer-standby 支持</h2><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">Extend the abilities of libpq&#x27;s target_session_attrs parameter.<br><br><span class=\"hljs-keyword\">In</span> addition to the existing options of <span class=\"hljs-string\">&quot;any&quot;</span> and <span class=\"hljs-string\">&quot;read-write&quot;</span>, we<br>now support <span class=\"hljs-string\">&quot;read-only&quot;</span>, <span class=\"hljs-string\">&quot;primary&quot;</span>, <span class=\"hljs-string\">&quot;standby&quot;</span>, and <span class=\"hljs-string\">&quot;prefer-standby&quot;</span>.<br><span class=\"hljs-string\">&quot;read-write&quot;</span> retains its previous meaning of &quot;transactions are<br><span class=\"hljs-keyword\">read</span>-write <span class=\"hljs-keyword\">by</span> default<span class=\"hljs-string\">&quot;, and &quot;</span><span class=\"hljs-keyword\">read</span>-only&quot; inverts that.  The other<br>three modes <span class=\"hljs-keyword\">test</span> specifically <span class=\"hljs-keyword\">for</span> hot-standby status, <span class=\"hljs-keyword\">which</span> is not<br>quite the same thing.  (Setting default_transaction_read_only <span class=\"hljs-keyword\">on</span><br>a primary server renders it <span class=\"hljs-keyword\">read</span>-only to this logic, but not a<br>standby.)<br><br>Furthermore, <span class=\"hljs-keyword\">if</span> talking to a v14 or later server, <span class=\"hljs-keyword\">no</span> extra network<br>round trip is needed to detect the session&#x27;s status; the GUC_REPORT<br>variables delivered <span class=\"hljs-keyword\">by</span> the server are enough.  When talking to <span class=\"hljs-keyword\">an</span><br>older server, a SHOW or SELECT <span class=\"hljs-keyword\">query</span> is issued to detect session<br><span class=\"hljs-keyword\">read</span>-only-ness or server hot-standby state, <span class=\"hljs-keyword\">as</span> needed.<br><br>Haribabu Kommi, Greg Nancarrow, Vignesh C, Tom Lane; reviewed at<br>various times <span class=\"hljs-keyword\">by</span> Laurenz Albe, Takayuki Tsunakawa, Peter Smith.<br><br>Discussion: https:<span class=\"hljs-comment\">//postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com</span><br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-option-PROCESS-TOAST-to-VACUUM\"><a href=\"#Add-option-PROCESS-TOAST-to-VACUUM\" class=\"headerlink\" title=\"Add option PROCESS_TOAST to VACUUM\"></a>Add option PROCESS_TOAST to VACUUM</h2><figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-attribute\">Author</span>: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Feb 9 14:13:57 2021 +0900<br><br>    Add option PROCESS_TOAST to VACUUM<br><br>    This option controls if toast tables associated with a relation are<br>    vacuumed or not when running a manual VACUUM.  It was already possible<br>    to trigger a manual VACUUM on a toast relation without processing its<br>    main relation, but a manual vacuum on a main relation always forced a<br>    vacuum on its toast table.  This is useful in scenarios where the level<br>    of bloat or transaction age of the main and toast relations differs a<br>    lot.<br><br>    This option is an extension of the existing VACOPT_SKIPTOAST that was<br>    used by autovacuum to control if toast relations should be skipped or<br>    not.  This internal flag is renamed to VACOPT_PROCESS_TOAST for<br>    consistency with the new option.<br><br>    A new option switch, called --no-process-toast, is added to vacuumdb.<br><br>    Author: Nathan Bossart<br>    Reviewed-by: Kirk Jamison, Michael Paquier, Justin Pryzby<br>    Discussion: https://postgr.es/m/BA8951E9-1524-48C5-94AF-73B1F0D7857F@amazon.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"added-“hostgssenc”-type-HBA-entries\"><a href=\"#added-“hostgssenc”-type-HBA-entries\" class=\"headerlink\" title=\"added “hostgssenc” type HBA entries\"></a>added “hostgssenc” type HBA entries</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">3995</span>c<span class=\"hljs-number\">424984</span>e<span class=\"hljs-number\">991</span>b<span class=\"hljs-number\">1069</span>a<span class=\"hljs-number\">2869</span>af<span class=\"hljs-number\">972</span>dc<span class=\"hljs-number\">07574</span>c<span class=\"hljs-number\">0</span>b<br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Mon Dec <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">17</span>:<span class=\"hljs-number\">58</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2020</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Improve</span> log messages related to pg_hba.conf not matching a connection.<br><br>    <span class=\"hljs-attribute\">Include</span> details <span class=\"hljs-literal\">on</span> whether GSS encryption has been activated;<br>    <span class=\"hljs-attribute\">since</span> we added <span class=\"hljs-string\">&quot;hostgssenc&quot;</span> type HBA entries, that&#x27;s relevant info.<br><br>    <span class=\"hljs-attribute\">Kyotaro</span> Horiguchi and Tom Lane.  Back-patch to v<span class=\"hljs-number\">12</span> where<br>    <span class=\"hljs-attribute\">GSS</span> encryption was introduced.<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/e<span class=\"hljs-number\">5</span>b<span class=\"hljs-number\">0</span>b<span class=\"hljs-number\">6</span>ed<span class=\"hljs-number\">05764324</span>a<span class=\"hljs-number\">2</span>f<span class=\"hljs-number\">3</span>fe<span class=\"hljs-number\">7</span>acfc<span class=\"hljs-number\">766</span>d<span class=\"hljs-number\">5</span>@smhi.se<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Introduce-a-new-GUC-REPORT-setting-“in-hot-standby”\"><a href=\"#Introduce-a-new-GUC-REPORT-setting-“in-hot-standby”\" class=\"headerlink\" title=\"Introduce a new GUC_REPORT setting “in_hot_standby”\"></a>Introduce a new GUC_REPORT setting “in_hot_standby”</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> bf<span class=\"hljs-number\">8</span>a<span class=\"hljs-number\">662</span>c<span class=\"hljs-number\">9</span>afad<span class=\"hljs-number\">6</span>fd<span class=\"hljs-number\">07</span>b<span class=\"hljs-number\">42</span>cdc<span class=\"hljs-number\">5</span>e<span class=\"hljs-number\">71416</span>c<span class=\"hljs-number\">51</span>f<span class=\"hljs-number\">75</span>d<span class=\"hljs-number\">31</span><br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Jan <span class=\"hljs-number\">5</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span> <span class=\"hljs-number\">2021</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Introduce</span> a new GUC_REPORT setting <span class=\"hljs-string\">&quot;in_hot_standby&quot;</span>.<br><br>    <span class=\"hljs-attribute\">Aside</span> from being queriable via SHOW, this value is sent to the client<br>    <span class=\"hljs-attribute\">immediately</span> at session startup, and again later <span class=\"hljs-literal\">on</span> if the server gets<br>    <span class=\"hljs-attribute\">promoted</span> to primary during the session.  The immediate report will be<br>    <span class=\"hljs-attribute\">used</span> in an upcoming patch to avoid an extra round trip when trying to<br>    <span class=\"hljs-attribute\">connect</span> to a primary server.<br><br>    <span class=\"hljs-attribute\">Haribabu</span> Kommi, Greg Nancarrow, Tom Lane; reviewed at various times<br>    <span class=\"hljs-attribute\">by</span> Laurenz Albe, Takayuki Tsunakawa, Peter Smith.<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/CAF<span class=\"hljs-number\">3</span>+xM+<span class=\"hljs-number\">8</span>-ztOkaV<span class=\"hljs-number\">9</span>gHiJ<span class=\"hljs-number\">3</span>wfgENTq<span class=\"hljs-number\">97</span>QcjXQt+rbFQ<span class=\"hljs-number\">6</span>F<span class=\"hljs-number\">7</span>oNzt<span class=\"hljs-number\">9</span>A@mail.gmail.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-idle-session-timeout-GUC-好东西-不听话的应用连接就得杀\"><a href=\"#Add-idle-session-timeout-GUC-好东西-不听话的应用连接就得杀\" class=\"headerlink\" title=\"Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀\"></a>Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">9877374</span>bef<span class=\"hljs-number\">76</span>ef<span class=\"hljs-number\">03923</span>f<span class=\"hljs-number\">6</span>aa<span class=\"hljs-number\">8</span>b<span class=\"hljs-number\">955</span>f<span class=\"hljs-number\">2</span>dbcbe<span class=\"hljs-number\">6</span>c<span class=\"hljs-number\">2</span>c<span class=\"hljs-number\">7</span><br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Wed Jan <span class=\"hljs-number\">6</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">28</span>:<span class=\"hljs-number\">42</span> <span class=\"hljs-number\">2021</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Add</span> idle_session_timeout.<br><br>    <span class=\"hljs-attribute\">This</span> GUC variable works much like idle_in_transaction_session_timeout,<br>    <span class=\"hljs-attribute\">in</span> that it kills sessions that have waited too long for a new client<br>    <span class=\"hljs-attribute\">query</span>.  But it applies when we&#x27;re not in a transaction, rather than<br>    <span class=\"hljs-attribute\">when</span> we are.<br><br>    <span class=\"hljs-attribute\">Li</span> Japin, reviewed by David Johnston and Hayato Kuroda, some<br>    <span class=\"hljs-attribute\">fixes</span> by me<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">763</span>A<span class=\"hljs-number\">0689</span>-F<span class=\"hljs-number\">189</span>-<span class=\"hljs-number\">459</span>E-<span class=\"hljs-number\">946</span>F-F<span class=\"hljs-number\">0</span>EC<span class=\"hljs-number\">4458980</span>B@hotmail.com<br><br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-GUC-to-log-long-wait-times-on-recovery-conflicts-好东西，一定要开哟\"><a href=\"#Add-GUC-to-log-long-wait-times-on-recovery-conflicts-好东西，一定要开哟\" class=\"headerlink\" title=\"Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟\"></a>Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">0650</span>ff23038bc3eb8d8fd851744db837d921e285<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Fri Jan <span class=\"hljs-number\">8</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">47</span>:<span class=\"hljs-number\">03</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> GUC <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">log</span> long wait times <span class=\"hljs-keyword\">on</span> recovery conflicts.<br><br>    This <span class=\"hljs-keyword\">commit</span> adds GUC log_recovery_conflict_waits that controls whether<br>    a <span class=\"hljs-keyword\">log</span> message <span class=\"hljs-keyword\">is</span> produced <span class=\"hljs-keyword\">when</span> the startup process <span class=\"hljs-keyword\">is</span> waiting longer than<br>    deadlock_timeout <span class=\"hljs-keyword\">for</span> recovery conflicts. This <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">in</span> determining<br>    <span class=\"hljs-keyword\">if</span> recovery conflicts prevent the recovery <span class=\"hljs-keyword\">from</span> applying WAL.<br><br>    Note that currently a <span class=\"hljs-keyword\">log</span> message <span class=\"hljs-keyword\">is</span> produced <span class=\"hljs-keyword\">only</span> <span class=\"hljs-keyword\">when</span> recovery <span class=\"hljs-keyword\">conflict</span><br>    has <span class=\"hljs-keyword\">not</span> been resolved yet even <span class=\"hljs-keyword\">after</span> deadlock_timeout passes, i.e.,<br>    <span class=\"hljs-keyword\">only</span> <span class=\"hljs-keyword\">when</span> the startup process <span class=\"hljs-keyword\">is</span> still waiting <span class=\"hljs-keyword\">for</span> recovery <span class=\"hljs-keyword\">conflict</span><br>    even <span class=\"hljs-keyword\">after</span> deadlock_timeout.<br><br>    Author: Bertrand Drouvot, Masahiko Sawada<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Alvaro Herrera, Kyotaro Horiguchi, Fujii Masao<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">9</span>a60178c-a853<span class=\"hljs-number\">-1440</span><span class=\"hljs-number\">-2</span>cdc-c3af916cff59@amazon.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-pg-stat-database-counters-for-sessions-and-session-time\"><a href=\"#Add-pg-stat-database-counters-for-sessions-and-session-time\" class=\"headerlink\" title=\"Add pg_stat_database counters for sessions and session time\"></a>Add pg_stat_database counters for sessions and session time</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">960869</span>da0803427d14335bba24393f414b476e2c<br>Author: Magnus Hagander &lt;magnus@hagander.net&gt;<br><span class=\"hljs-type\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">34</span>:<span class=\"hljs-number\">09</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-keyword\">Add</span> pg_stat_database counters <span class=\"hljs-keyword\">for</span> sessions <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">session</span> <span class=\"hljs-type\">time</span><br><br>    This <span class=\"hljs-keyword\">add</span> counters <span class=\"hljs-keyword\">for</span> number <span class=\"hljs-keyword\">of</span> sessions, the different kind <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">session</span><br>    termination <span class=\"hljs-keyword\">types</span>, <span class=\"hljs-keyword\">and</span> timers <span class=\"hljs-keyword\">for</span> how much <span class=\"hljs-type\">time</span> <span class=\"hljs-keyword\">is</span> spent <span class=\"hljs-keyword\">in</span> active vs<br>    idle <span class=\"hljs-keyword\">in</span> a <span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">to</span> pg_stat_database.<br><br>    Internally this <span class=\"hljs-keyword\">also</span> renames the parameter &quot;force&quot; <span class=\"hljs-keyword\">to</span> disconnect. This<br>    was the <span class=\"hljs-keyword\">only</span> use-<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">for</span> the parameter <span class=\"hljs-keyword\">before</span>, so repurposing it <span class=\"hljs-keyword\">to</span><br>    this mroe narrow usecase makes things cleaner than inventing something<br>    <span class=\"hljs-built_in\">new</span>.<br><br>    Author: Laurenz Albe<br>    Reviewed-<span class=\"hljs-keyword\">By</span>: Magnus Hagander, Soumyadeep Chakraborty, Masahiro Ikeda<br>    Discussion: https://postgr.es/m/b07e1f9953701b90c66ed368656f2aef40cac4fb.camel@cybertec.at<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"psql-dX-list-extended-statistics-objects\"><a href=\"#psql-dX-list-extended-statistics-objects\" class=\"headerlink\" title=\"psql \\dX: list extended statistics objects\"></a>psql \\dX: list extended statistics objects</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">891</span>a<span class=\"hljs-number\">1</span>d<span class=\"hljs-number\">0</span>bca<span class=\"hljs-number\">262</span>ca<span class=\"hljs-number\">78564</span>e<span class=\"hljs-number\">0</span>fea<span class=\"hljs-number\">1</span>eaa<span class=\"hljs-number\">5</span>ae<span class=\"hljs-number\">544</span>ea<span class=\"hljs-number\">5</span>ee<br><span class=\"hljs-attribute\">Author</span>: Tomas Vondra &lt;tomas.vondra@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">25</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-attribute\">psql</span> \\dX: list extended statistics objects<br><br>    <span class=\"hljs-attribute\">The</span> new command lists extended statistics objects, possibly with their<br>    <span class=\"hljs-attribute\">sizes</span>. <span class=\"hljs-literal\">All</span> past releases with extended statistics are supported.<br><br>    <span class=\"hljs-attribute\">Author</span>: Tatsuro Yamada<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Julien Rouhaud, Alvaro Herrera, Tomas Vondra<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/c<span class=\"hljs-number\">027</span>a<span class=\"hljs-number\">541</span>-<span class=\"hljs-number\">5856</span>-<span class=\"hljs-number\">75</span>a<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">0868</span>-<span class=\"hljs-number\">341301</span>e<span class=\"hljs-number\">1624</span>b%<span class=\"hljs-number\">40</span>nttcom.co.jp_<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">1</span>db<span class=\"hljs-number\">0</span>d<span class=\"hljs-number\">173</span>a<span class=\"hljs-number\">2201119</span>f<span class=\"hljs-number\">297</span>ea<span class=\"hljs-number\">35</span>edfb<span class=\"hljs-number\">41579893</span>dd<span class=\"hljs-number\">8</span>c<br><span class=\"hljs-attribute\">Author</span>: Tomas Vondra &lt;tomas.vondra@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">14</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-attribute\">Revert</span> <span class=\"hljs-string\">&quot;psql \\dX: list extended statistics objects&quot;</span><br><br>    <span class=\"hljs-attribute\">Reverts</span> <span class=\"hljs-number\">891</span>a<span class=\"hljs-number\">1</span>d<span class=\"hljs-number\">0</span>bca, because the new  psql command \\dX only worked for<br>    <span class=\"hljs-attribute\">users</span> users who can read pg_statistic_ext_data catalog, and most regular<br>    <span class=\"hljs-attribute\">users</span> lack that privilege (the catalog may contain sensitive user data).<br><br>    <span class=\"hljs-attribute\">Reported</span>-by: Noriyoshi Shinoda<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/c<span class=\"hljs-number\">027</span>a<span class=\"hljs-number\">541</span>-<span class=\"hljs-number\">5856</span>-<span class=\"hljs-number\">75</span>a<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">0868</span>-<span class=\"hljs-number\">341301</span>e<span class=\"hljs-number\">1624</span>b%<span class=\"hljs-number\">40</span>nttcom.co.jp_<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"感觉14版本做了很多FDW的优化，是为集群模式做准备\"><a href=\"#感觉14版本做了很多FDW的优化，是为集群模式做准备\" class=\"headerlink\" title=\"感觉14版本做了很多FDW的优化，是为集群模式做准备?\"></a>感觉14版本做了很多FDW的优化，是为集群模式做准备?</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">8e396</span>a773b80c72e5d5a0ca9755dffe043c97a05<br>Author: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-type\">Date</span>:   Thu Jan <span class=\"hljs-number\">14</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">38</span> <span class=\"hljs-number\">2021</span> <span class=\"hljs-number\">-0500</span><br><br>    pg_dump: label <span class=\"hljs-keyword\">PUBLICATION</span> <span class=\"hljs-keyword\">TABLE</span> ArchiveEntries <span class=\"hljs-keyword\">with</span> an <span class=\"hljs-keyword\">owner</span>.<br><br>    This <span class=\"hljs-keyword\">is</span> the same fix <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">9</span>eabfe300 applied <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">INDEX</span> ATTACH<br>    entries, but <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span>-<span class=\"hljs-keyword\">to</span>-<span class=\"hljs-keyword\">publication</span> attachments.  <span class=\"hljs-keyword\">As</span> <span class=\"hljs-keyword\">in</span> that<br>    <span class=\"hljs-keyword\">case</span>, even though the backend doesn<span class=\"hljs-string\">&#x27;t record &quot;ownership&quot; of the</span><br><span class=\"hljs-string\">    attachment, we still ought to label it in the dump archive with</span><br><span class=\"hljs-string\">    the role name that should run the ALTER PUBLICATION command.</span><br><span class=\"hljs-string\">    The existing behavior causes the ALTER to be done by the original</span><br><span class=\"hljs-string\">    role that started the restore; that will usually work fine, but</span><br><span class=\"hljs-string\">    there may be corner cases where it fails.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    The bulk of the patch is concerned with changing struct</span><br><span class=\"hljs-string\">    PublicationRelInfo to include a pointer to the associated</span><br><span class=\"hljs-string\">    PublicationInfo object, so that we can get the owner&#x27;</span>s <span class=\"hljs-type\">name</span><br>    <span class=\"hljs-keyword\">out</span> <span class=\"hljs-keyword\">of</span> that <span class=\"hljs-keyword\">when</span> the <span class=\"hljs-type\">time</span> comes.  <span class=\"hljs-keyword\">While</span> at it, I rewrote<br>    getPublicationTables() <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">do</span> just one query <span class=\"hljs-keyword\">of</span> pg_publication_rel,<br>    <span class=\"hljs-keyword\">not</span> one per <span class=\"hljs-keyword\">table</span>.<br><br>    Back-patch <span class=\"hljs-keyword\">to</span> v10 <span class=\"hljs-keyword\">where</span> this code was introduced.<br><br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">1165710.1610473242</span>@sss.pgh.pa.us<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">708</span>d165ddb92c54077a372acf6417e258dcb5fef<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Jan <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">08</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    postgres_fdw: <span class=\"hljs-keyword\">Add</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">to</span> list cached connections <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">foreign</span> servers.<br><br>    This <span class=\"hljs-keyword\">commit</span> adds <span class=\"hljs-keyword\">function</span> postgres_fdw_get_connections() <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">return</span><br>    the <span class=\"hljs-keyword\">foreign</span> <span class=\"hljs-keyword\">server</span> names <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">open</span> connections that postgres_fdw<br>    established <span class=\"hljs-keyword\">from</span> the <span class=\"hljs-keyword\">local</span> <span class=\"hljs-keyword\">session</span> <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">foreign</span> servers. This <span class=\"hljs-keyword\">function</span><br>    <span class=\"hljs-keyword\">also</span> <span class=\"hljs-keyword\">returns</span> whether <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">valid</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">not</span>.<br><br>    This <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">when</span> checking <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">open</span> <span class=\"hljs-keyword\">foreign</span> <span class=\"hljs-keyword\">server</span> connections.<br>    <span class=\"hljs-keyword\">If</span> we <span class=\"hljs-built_in\">found</span> <span class=\"hljs-keyword\">some</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">drop</span>, <span class=\"hljs-keyword\">from</span> the result <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">function</span>, probably<br>    we can explicitly <span class=\"hljs-keyword\">close</span> them <span class=\"hljs-keyword\">by</span> the <span class=\"hljs-keyword\">function</span> that upcoming <span class=\"hljs-keyword\">commit</span> will <span class=\"hljs-keyword\">add</span>.<br><br>    This <span class=\"hljs-keyword\">commit</span> bumps the <span class=\"hljs-keyword\">version</span> <span class=\"hljs-keyword\">of</span> postgres_fdw <span class=\"hljs-keyword\">to</span> <span class=\"hljs-number\">1.1</span> since it adds<br>    <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">function</span>.<br><br>    Author: Bharath Rupireddy, tweaked <span class=\"hljs-keyword\">by</span> Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Zhijie Hou, Alexey Kondratov, Zhihong Yu, Fujii Masao<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">2</span>d5cb0b3-a6e8<span class=\"hljs-number\">-9</span>bbb<span class=\"hljs-number\">-953</span>f<span class=\"hljs-number\">-879</span>f47128faa@oss.nttdata.com<br><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> ee<span class=\"hljs-number\">79</span>a<span class=\"hljs-number\">548</span>e<span class=\"hljs-number\">746</span>da<span class=\"hljs-number\">9</span>a<span class=\"hljs-number\">99</span>df<span class=\"hljs-number\">0</span>cac<span class=\"hljs-number\">70</span>a<span class=\"hljs-number\">3</span>ddc<span class=\"hljs-number\">095</span>f<span class=\"hljs-number\">2829</span>a<br><span class=\"hljs-attribute\">Author</span>: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Jan <span class=\"hljs-number\">19</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">56</span>:<span class=\"hljs-number\">10</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-attribute\">doc</span>: Add note about the server name of postgres_fdw_get_connections() returns.<br><br>    <span class=\"hljs-attribute\">Previously</span> the document didn&#x27;t mention the case where<br>    <span class=\"hljs-attribute\">postgres_fdw_get_connections</span>() returns NULL in server_name column.<br>    <span class=\"hljs-attribute\">Users</span> might be confused about why NULL was returned.<br><br>    <span class=\"hljs-attribute\">This</span> commit adds the note that, in postgres_fdw_get_connections(),<br>    <span class=\"hljs-attribute\">the</span> server name of an invalid connection will be NULL if the server is dropped.<br><br>    <span class=\"hljs-attribute\">Suggested</span>-by: Zhijie Hou<br>    <span class=\"hljs-attribute\">Author</span>: Bharath Rupireddy<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Zhijie Hou, Fujii Masao<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/e<span class=\"hljs-number\">7</span>ddd<span class=\"hljs-number\">14</span>e<span class=\"hljs-number\">96444</span>fce<span class=\"hljs-number\">88</span>e<span class=\"hljs-number\">47</span>a<span class=\"hljs-number\">709</span>c<span class=\"hljs-number\">196537</span>@G<span class=\"hljs-number\">08</span>CNEXMBPEKD<span class=\"hljs-number\">05</span>.g<span class=\"hljs-number\">08</span>.fujitsu.local<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> e3ebcca843a4703938b9f40a4811f43c4b315753<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon <span class=\"hljs-type\">Dec</span> <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">56</span>:<span class=\"hljs-number\">13</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    postgres_fdw: Fix <span class=\"hljs-keyword\">connection</span> leak.<br><br>    <span class=\"hljs-keyword\">In</span> postgres_fdw, the cached connections <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">foreign</span> servers will <span class=\"hljs-keyword\">not</span> be<br>    closed <span class=\"hljs-keyword\">until</span> the <span class=\"hljs-keyword\">local</span> <span class=\"hljs-keyword\">session</span> exits <span class=\"hljs-keyword\">if</span> the <span class=\"hljs-keyword\">user</span> mappings <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">foreign</span> servers<br>    that those connections depend <span class=\"hljs-keyword\">on</span> are dropped. Those connections can be<br>    leaked.<br><br>    <span class=\"hljs-keyword\">To</span> fix that <span class=\"hljs-keyword\">connection</span> leak issue, <span class=\"hljs-keyword\">after</span> a change <span class=\"hljs-keyword\">to</span> a pg_foreign_server<br>    <span class=\"hljs-keyword\">or</span> pg_user_mapping catalog entry, this <span class=\"hljs-keyword\">commit</span> makes postgres_fdw <span class=\"hljs-keyword\">close</span><br>    the connections depending <span class=\"hljs-keyword\">on</span> that entry immediately <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">current</span><br>    <span class=\"hljs-keyword\">transaction</span> has <span class=\"hljs-keyword\">not</span> used those connections yet. Otherwise, mark those<br>    connections <span class=\"hljs-keyword\">as</span> invalid <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">close</span> them at the <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">current</span> <span class=\"hljs-keyword\">transaction</span>,<br>    since they cannot be closed <span class=\"hljs-keyword\">in</span> the midst <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">transaction</span> <span class=\"hljs-keyword\">using</span> them.<br>    Closed connections will be remade at the next opportunity <span class=\"hljs-keyword\">if</span> necessary.<br><br>    Back-patch <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">all</span> supported branches.<br><br>    Author: Bharath Rupireddy<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Zhihong Yu, Zhijie Hou, Fujii Masao<br>    Discussion: https://postgr.es/m/CALj2ACVNcGH_6qLY<span class=\"hljs-number\">-4</span>_tXz8JLvA+<span class=\"hljs-number\">4</span>yeBThRfxMz7Oxbk1aHcpQ@mail.gmail.com<br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>记录阅读PostgreSQL git 提交记录, 觉得好的记录一下.</p>","more":"<h1 id=\"PG14\"><a href=\"#PG14\" class=\"headerlink\" title=\"PG14\"></a>PG14</h1><h2 id=\"Enable-parallel-SELECT-for-“INSERT-INTO-…-SELECT-…”\"><a href=\"#Enable-parallel-SELECT-for-“INSERT-INTO-…-SELECT-…”\" class=\"headerlink\" title=\"Enable parallel SELECT for “INSERT INTO … SELECT …”\"></a>Enable parallel SELECT for “INSERT INTO … SELECT …”</h2><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vhdl\">commit <span class=\"hljs-number\">05</span>c8482f7f69a954fd65fce85f896e848fc48197<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br>Date:   Wed Mar <span class=\"hljs-number\">10</span> <span class=\"hljs-number\">07</span>:<span class=\"hljs-number\">38</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0530</span><br><br>    Enable parallel <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&quot;INSERT INTO ... SELECT ...&quot;</span>.<br><br>    Parallel <span class=\"hljs-keyword\">SELECT</span> can<span class=\"hljs-symbol\">&#x27;t</span> be utilized <span class=\"hljs-keyword\">for</span> INSERT <span class=\"hljs-keyword\">in</span> the following cases:<br>    - INSERT statement uses the <span class=\"hljs-keyword\">ON</span> CONFLICT DO UPDATE clause<br>    - Target table has a parallel-unsafe: trigger, index expression <span class=\"hljs-keyword\">or</span><br>      predicate, column <span class=\"hljs-keyword\">default</span> expression <span class=\"hljs-keyword\">or</span> check constraint<br>    - Target table has a parallel-unsafe domain constraint <span class=\"hljs-keyword\">on</span> any column<br>    - Target table <span class=\"hljs-keyword\">is</span> a partitioned table <span class=\"hljs-keyword\">with</span> a parallel-unsafe partition key<br>      expression <span class=\"hljs-keyword\">or</span> support <span class=\"hljs-keyword\">function</span><br><br>    The planner <span class=\"hljs-keyword\">is</span> updated <span class=\"hljs-keyword\">to</span> perform additional parallel-safety checks <span class=\"hljs-keyword\">for</span><br>    the cases listed above, <span class=\"hljs-keyword\">for</span> determining whether it <span class=\"hljs-keyword\">is</span> safe <span class=\"hljs-keyword\">to</span> run INSERT<br>    <span class=\"hljs-keyword\">in</span> parallel-mode <span class=\"hljs-keyword\">with</span> an underlying parallel <span class=\"hljs-keyword\">SELECT</span>. The planner will<br>    consider using parallel <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">&quot;INSERT INTO ... SELECT ...&quot;</span>, provided<br>    nothing unsafe <span class=\"hljs-keyword\">is</span> found from the additional parallel-safety checks, <span class=\"hljs-keyword\">or</span><br>    from the existing parallel-safety checks <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">SELECT</span>.<br><br>    <span class=\"hljs-keyword\">While</span> checking parallel-safety, we need <span class=\"hljs-keyword\">to</span> check it <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">all</span> the partitions<br>    <span class=\"hljs-keyword\">on</span> the table which can be costly especially <span class=\"hljs-keyword\">when</span> we decide <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">use</span> a<br>    parallel plan. So, <span class=\"hljs-keyword\">in</span> a separate patch, we will introduce a GUC <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">or</span> a<br>    reloption <span class=\"hljs-keyword\">to</span> enable/disable parallelism <span class=\"hljs-keyword\">for</span> Insert statements.<br><br>    Prior <span class=\"hljs-keyword\">to</span> entering parallel-mode <span class=\"hljs-keyword\">for</span> the execution <span class=\"hljs-keyword\">of</span> INSERT <span class=\"hljs-keyword\">with</span> parallel<br>    <span class=\"hljs-keyword\">SELECT</span>, a TransactionId <span class=\"hljs-keyword\">is</span> acquired <span class=\"hljs-keyword\">and</span> assigned <span class=\"hljs-keyword\">to</span> the current<br>    transaction state. This <span class=\"hljs-keyword\">is</span> necessary <span class=\"hljs-keyword\">to</span> prevent the INSERT from attempting<br>    <span class=\"hljs-keyword\">to</span> assign the TransactionId whilst <span class=\"hljs-keyword\">in</span> parallel-mode, which <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> allowed.<br>    This approach has a disadvantage <span class=\"hljs-keyword\">in</span> that <span class=\"hljs-keyword\">if</span> the underlying <span class=\"hljs-keyword\">SELECT</span> does <span class=\"hljs-keyword\">not</span><br>    <span class=\"hljs-keyword\">return</span> any rows, <span class=\"hljs-keyword\">then</span> the TransactionId <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> used, however that<br>    shouldn<span class=\"hljs-symbol\">&#x27;t</span> happen <span class=\"hljs-keyword\">in</span> practice <span class=\"hljs-keyword\">in</span> many cases.<br><br>    Author: Greg Nancarrow, Amit Langote, Amit Kapila<br>    Reviewed-by: Amit Langote, Hou Zhijie, Takayuki Tsunakawa, Antonin Houska, Bharath Rupireddy, Dilip Kumar, Vignesh C, Zhihong Yu, Amit Kapila<br>    Tested-by: Tang, Haiying<br>    Discussion: https://postgr.es/m/CAJcOf-cXnB5cnMKqWEp2E2z7Mvcd04iLVmV=qpFJrR3AcrTS3g@mail.gmail.com<br>    Discussion: https://postgr.es/m/CAJcOf-fAdj=nDKMsRhQzndm-O13NY4dL6xGcEvdX5Xvbbi0V7g@mail.gmail.com<br><br>commit <span class=\"hljs-number\">0</span>ba71107efeeccde9158f47118f95043afdca0bb<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-—tablespace-option-to-reindexd\"><a href=\"#Add-—tablespace-option-to-reindexd\" class=\"headerlink\" title=\"Add —tablespace option to reindexd\"></a>Add —tablespace option to reindexd</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">Add</span> <span class=\"hljs-comment\">--tablespace option to reindexdb</span><br><br>This <span class=\"hljs-keyword\">option</span> provides <span class=\"hljs-keyword\">REINDEX</span> (<span class=\"hljs-keyword\">TABLESPACE</span>) <span class=\"hljs-keyword\">for</span> reindexdb, applying the<br><span class=\"hljs-keyword\">tablespace</span> <span class=\"hljs-keyword\">value</span> given <span class=\"hljs-keyword\">by</span> the caller <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">REINDEX</span> queries<br><span class=\"hljs-keyword\">generated</span>.<br><br><span class=\"hljs-keyword\">While</span> <span class=\"hljs-keyword\">on</span> it, this <span class=\"hljs-keyword\">commit</span> adds <span class=\"hljs-keyword\">some</span> tests <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">REINDEX</span> <span class=\"hljs-keyword\">TABLESPACE</span>, <span class=\"hljs-keyword\">with</span><br><span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">without</span> <span class=\"hljs-keyword\">CONCURRENTLY</span>, <span class=\"hljs-keyword\">when</span> run <span class=\"hljs-keyword\">on</span> toast indexes <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">tables</span>.  Such<br>operations are <span class=\"hljs-keyword\">not</span> allowed, <span class=\"hljs-keyword\">and</span> toast relation names are <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">stable</span><br>enough <span class=\"hljs-keyword\">to</span> be part <span class=\"hljs-keyword\">of</span> the main regression test suite (even <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">using</span> a PL<br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">with</span> a TRY/CATCH logic, <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> could <span class=\"hljs-keyword\">not</span> be tested).<br><br>Author: Michael Paquier<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"target-session-attrs-增加-read-only-primary-standby-prefer-standby-支持\"><a href=\"#target-session-attrs-增加-read-only-primary-standby-prefer-standby-支持\" class=\"headerlink\" title=\"target_session_attrs 增加　read-only primary standby prefer-standby 支持\"></a>target_session_attrs 增加　read-only primary standby prefer-standby 支持</h2><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stata\">Extend the abilities of libpq&#x27;s target_session_attrs parameter.<br><br><span class=\"hljs-keyword\">In</span> addition to the existing options of <span class=\"hljs-string\">&quot;any&quot;</span> and <span class=\"hljs-string\">&quot;read-write&quot;</span>, we<br>now support <span class=\"hljs-string\">&quot;read-only&quot;</span>, <span class=\"hljs-string\">&quot;primary&quot;</span>, <span class=\"hljs-string\">&quot;standby&quot;</span>, and <span class=\"hljs-string\">&quot;prefer-standby&quot;</span>.<br><span class=\"hljs-string\">&quot;read-write&quot;</span> retains its previous meaning of &quot;transactions are<br><span class=\"hljs-keyword\">read</span>-write <span class=\"hljs-keyword\">by</span> default<span class=\"hljs-string\">&quot;, and &quot;</span><span class=\"hljs-keyword\">read</span>-only&quot; inverts that.  The other<br>three modes <span class=\"hljs-keyword\">test</span> specifically <span class=\"hljs-keyword\">for</span> hot-standby status, <span class=\"hljs-keyword\">which</span> is not<br>quite the same thing.  (Setting default_transaction_read_only <span class=\"hljs-keyword\">on</span><br>a primary server renders it <span class=\"hljs-keyword\">read</span>-only to this logic, but not a<br>standby.)<br><br>Furthermore, <span class=\"hljs-keyword\">if</span> talking to a v14 or later server, <span class=\"hljs-keyword\">no</span> extra network<br>round trip is needed to detect the session&#x27;s status; the GUC_REPORT<br>variables delivered <span class=\"hljs-keyword\">by</span> the server are enough.  When talking to <span class=\"hljs-keyword\">an</span><br>older server, a SHOW or SELECT <span class=\"hljs-keyword\">query</span> is issued to detect session<br><span class=\"hljs-keyword\">read</span>-only-ness or server hot-standby state, <span class=\"hljs-keyword\">as</span> needed.<br><br>Haribabu Kommi, Greg Nancarrow, Vignesh C, Tom Lane; reviewed at<br>various times <span class=\"hljs-keyword\">by</span> Laurenz Albe, Takayuki Tsunakawa, Peter Smith.<br><br>Discussion: https:<span class=\"hljs-comment\">//postgr.es/m/CAF3+xM+8-ztOkaV9gHiJ3wfgENTq97QcjXQt+rbFQ6F7oNzt9A@mail.gmail.com</span><br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-option-PROCESS-TOAST-to-VACUUM\"><a href=\"#Add-option-PROCESS-TOAST-to-VACUUM\" class=\"headerlink\" title=\"Add option PROCESS_TOAST to VACUUM\"></a>Add option PROCESS_TOAST to VACUUM</h2><figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-attribute\">Author</span>: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Feb 9 14:13:57 2021 +0900<br><br>    Add option PROCESS_TOAST to VACUUM<br><br>    This option controls if toast tables associated with a relation are<br>    vacuumed or not when running a manual VACUUM.  It was already possible<br>    to trigger a manual VACUUM on a toast relation without processing its<br>    main relation, but a manual vacuum on a main relation always forced a<br>    vacuum on its toast table.  This is useful in scenarios where the level<br>    of bloat or transaction age of the main and toast relations differs a<br>    lot.<br><br>    This option is an extension of the existing VACOPT_SKIPTOAST that was<br>    used by autovacuum to control if toast relations should be skipped or<br>    not.  This internal flag is renamed to VACOPT_PROCESS_TOAST for<br>    consistency with the new option.<br><br>    A new option switch, called --no-process-toast, is added to vacuumdb.<br><br>    Author: Nathan Bossart<br>    Reviewed-by: Kirk Jamison, Michael Paquier, Justin Pryzby<br>    Discussion: https://postgr.es/m/BA8951E9-1524-48C5-94AF-73B1F0D7857F@amazon.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"added-“hostgssenc”-type-HBA-entries\"><a href=\"#added-“hostgssenc”-type-HBA-entries\" class=\"headerlink\" title=\"added “hostgssenc” type HBA entries\"></a>added “hostgssenc” type HBA entries</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">3995</span>c<span class=\"hljs-number\">424984</span>e<span class=\"hljs-number\">991</span>b<span class=\"hljs-number\">1069</span>a<span class=\"hljs-number\">2869</span>af<span class=\"hljs-number\">972</span>dc<span class=\"hljs-number\">07574</span>c<span class=\"hljs-number\">0</span>b<br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Mon Dec <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">17</span>:<span class=\"hljs-number\">58</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2020</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Improve</span> log messages related to pg_hba.conf not matching a connection.<br><br>    <span class=\"hljs-attribute\">Include</span> details <span class=\"hljs-literal\">on</span> whether GSS encryption has been activated;<br>    <span class=\"hljs-attribute\">since</span> we added <span class=\"hljs-string\">&quot;hostgssenc&quot;</span> type HBA entries, that&#x27;s relevant info.<br><br>    <span class=\"hljs-attribute\">Kyotaro</span> Horiguchi and Tom Lane.  Back-patch to v<span class=\"hljs-number\">12</span> where<br>    <span class=\"hljs-attribute\">GSS</span> encryption was introduced.<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/e<span class=\"hljs-number\">5</span>b<span class=\"hljs-number\">0</span>b<span class=\"hljs-number\">6</span>ed<span class=\"hljs-number\">05764324</span>a<span class=\"hljs-number\">2</span>f<span class=\"hljs-number\">3</span>fe<span class=\"hljs-number\">7</span>acfc<span class=\"hljs-number\">766</span>d<span class=\"hljs-number\">5</span>@smhi.se<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Introduce-a-new-GUC-REPORT-setting-“in-hot-standby”\"><a href=\"#Introduce-a-new-GUC-REPORT-setting-“in-hot-standby”\" class=\"headerlink\" title=\"Introduce a new GUC_REPORT setting “in_hot_standby”\"></a>Introduce a new GUC_REPORT setting “in_hot_standby”</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> bf<span class=\"hljs-number\">8</span>a<span class=\"hljs-number\">662</span>c<span class=\"hljs-number\">9</span>afad<span class=\"hljs-number\">6</span>fd<span class=\"hljs-number\">07</span>b<span class=\"hljs-number\">42</span>cdc<span class=\"hljs-number\">5</span>e<span class=\"hljs-number\">71416</span>c<span class=\"hljs-number\">51</span>f<span class=\"hljs-number\">75</span>d<span class=\"hljs-number\">31</span><br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Jan <span class=\"hljs-number\">5</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span> <span class=\"hljs-number\">2021</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Introduce</span> a new GUC_REPORT setting <span class=\"hljs-string\">&quot;in_hot_standby&quot;</span>.<br><br>    <span class=\"hljs-attribute\">Aside</span> from being queriable via SHOW, this value is sent to the client<br>    <span class=\"hljs-attribute\">immediately</span> at session startup, and again later <span class=\"hljs-literal\">on</span> if the server gets<br>    <span class=\"hljs-attribute\">promoted</span> to primary during the session.  The immediate report will be<br>    <span class=\"hljs-attribute\">used</span> in an upcoming patch to avoid an extra round trip when trying to<br>    <span class=\"hljs-attribute\">connect</span> to a primary server.<br><br>    <span class=\"hljs-attribute\">Haribabu</span> Kommi, Greg Nancarrow, Tom Lane; reviewed at various times<br>    <span class=\"hljs-attribute\">by</span> Laurenz Albe, Takayuki Tsunakawa, Peter Smith.<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/CAF<span class=\"hljs-number\">3</span>+xM+<span class=\"hljs-number\">8</span>-ztOkaV<span class=\"hljs-number\">9</span>gHiJ<span class=\"hljs-number\">3</span>wfgENTq<span class=\"hljs-number\">97</span>QcjXQt+rbFQ<span class=\"hljs-number\">6</span>F<span class=\"hljs-number\">7</span>oNzt<span class=\"hljs-number\">9</span>A@mail.gmail.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-idle-session-timeout-GUC-好东西-不听话的应用连接就得杀\"><a href=\"#Add-idle-session-timeout-GUC-好东西-不听话的应用连接就得杀\" class=\"headerlink\" title=\"Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀\"></a>Add idle_session_timeout　GUC 好东西, 不听话的应用连接就得杀</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">9877374</span>bef<span class=\"hljs-number\">76</span>ef<span class=\"hljs-number\">03923</span>f<span class=\"hljs-number\">6</span>aa<span class=\"hljs-number\">8</span>b<span class=\"hljs-number\">955</span>f<span class=\"hljs-number\">2</span>dbcbe<span class=\"hljs-number\">6</span>c<span class=\"hljs-number\">2</span>c<span class=\"hljs-number\">7</span><br><span class=\"hljs-attribute\">Author</span>: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-attribute\">Date</span>:   Wed Jan <span class=\"hljs-number\">6</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">28</span>:<span class=\"hljs-number\">42</span> <span class=\"hljs-number\">2021</span> -<span class=\"hljs-number\">0500</span><br><br>    <span class=\"hljs-attribute\">Add</span> idle_session_timeout.<br><br>    <span class=\"hljs-attribute\">This</span> GUC variable works much like idle_in_transaction_session_timeout,<br>    <span class=\"hljs-attribute\">in</span> that it kills sessions that have waited too long for a new client<br>    <span class=\"hljs-attribute\">query</span>.  But it applies when we&#x27;re not in a transaction, rather than<br>    <span class=\"hljs-attribute\">when</span> we are.<br><br>    <span class=\"hljs-attribute\">Li</span> Japin, reviewed by David Johnston and Hayato Kuroda, some<br>    <span class=\"hljs-attribute\">fixes</span> by me<br><br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">763</span>A<span class=\"hljs-number\">0689</span>-F<span class=\"hljs-number\">189</span>-<span class=\"hljs-number\">459</span>E-<span class=\"hljs-number\">946</span>F-F<span class=\"hljs-number\">0</span>EC<span class=\"hljs-number\">4458980</span>B@hotmail.com<br><br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-GUC-to-log-long-wait-times-on-recovery-conflicts-好东西，一定要开哟\"><a href=\"#Add-GUC-to-log-long-wait-times-on-recovery-conflicts-好东西，一定要开哟\" class=\"headerlink\" title=\"Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟\"></a>Add GUC to log long wait times on recovery conflicts. 好东西，一定要开哟</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">0650</span>ff23038bc3eb8d8fd851744db837d921e285<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Fri Jan <span class=\"hljs-number\">8</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">47</span>:<span class=\"hljs-number\">03</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> GUC <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">log</span> long wait times <span class=\"hljs-keyword\">on</span> recovery conflicts.<br><br>    This <span class=\"hljs-keyword\">commit</span> adds GUC log_recovery_conflict_waits that controls whether<br>    a <span class=\"hljs-keyword\">log</span> message <span class=\"hljs-keyword\">is</span> produced <span class=\"hljs-keyword\">when</span> the startup process <span class=\"hljs-keyword\">is</span> waiting longer than<br>    deadlock_timeout <span class=\"hljs-keyword\">for</span> recovery conflicts. This <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">in</span> determining<br>    <span class=\"hljs-keyword\">if</span> recovery conflicts prevent the recovery <span class=\"hljs-keyword\">from</span> applying WAL.<br><br>    Note that currently a <span class=\"hljs-keyword\">log</span> message <span class=\"hljs-keyword\">is</span> produced <span class=\"hljs-keyword\">only</span> <span class=\"hljs-keyword\">when</span> recovery <span class=\"hljs-keyword\">conflict</span><br>    has <span class=\"hljs-keyword\">not</span> been resolved yet even <span class=\"hljs-keyword\">after</span> deadlock_timeout passes, i.e.,<br>    <span class=\"hljs-keyword\">only</span> <span class=\"hljs-keyword\">when</span> the startup process <span class=\"hljs-keyword\">is</span> still waiting <span class=\"hljs-keyword\">for</span> recovery <span class=\"hljs-keyword\">conflict</span><br>    even <span class=\"hljs-keyword\">after</span> deadlock_timeout.<br><br>    Author: Bertrand Drouvot, Masahiko Sawada<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Alvaro Herrera, Kyotaro Horiguchi, Fujii Masao<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">9</span>a60178c-a853<span class=\"hljs-number\">-1440</span><span class=\"hljs-number\">-2</span>cdc-c3af916cff59@amazon.com<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"Add-pg-stat-database-counters-for-sessions-and-session-time\"><a href=\"#Add-pg-stat-database-counters-for-sessions-and-session-time\" class=\"headerlink\" title=\"Add pg_stat_database counters for sessions and session time\"></a>Add pg_stat_database counters for sessions and session time</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">960869</span>da0803427d14335bba24393f414b476e2c<br>Author: Magnus Hagander &lt;magnus@hagander.net&gt;<br><span class=\"hljs-type\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">34</span>:<span class=\"hljs-number\">09</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-keyword\">Add</span> pg_stat_database counters <span class=\"hljs-keyword\">for</span> sessions <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">session</span> <span class=\"hljs-type\">time</span><br><br>    This <span class=\"hljs-keyword\">add</span> counters <span class=\"hljs-keyword\">for</span> number <span class=\"hljs-keyword\">of</span> sessions, the different kind <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">session</span><br>    termination <span class=\"hljs-keyword\">types</span>, <span class=\"hljs-keyword\">and</span> timers <span class=\"hljs-keyword\">for</span> how much <span class=\"hljs-type\">time</span> <span class=\"hljs-keyword\">is</span> spent <span class=\"hljs-keyword\">in</span> active vs<br>    idle <span class=\"hljs-keyword\">in</span> a <span class=\"hljs-keyword\">database</span> <span class=\"hljs-keyword\">to</span> pg_stat_database.<br><br>    Internally this <span class=\"hljs-keyword\">also</span> renames the parameter &quot;force&quot; <span class=\"hljs-keyword\">to</span> disconnect. This<br>    was the <span class=\"hljs-keyword\">only</span> use-<span class=\"hljs-keyword\">case</span> <span class=\"hljs-keyword\">for</span> the parameter <span class=\"hljs-keyword\">before</span>, so repurposing it <span class=\"hljs-keyword\">to</span><br>    this mroe narrow usecase makes things cleaner than inventing something<br>    <span class=\"hljs-built_in\">new</span>.<br><br>    Author: Laurenz Albe<br>    Reviewed-<span class=\"hljs-keyword\">By</span>: Magnus Hagander, Soumyadeep Chakraborty, Masahiro Ikeda<br>    Discussion: https://postgr.es/m/b07e1f9953701b90c66ed368656f2aef40cac4fb.camel@cybertec.at<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"psql-dX-list-extended-statistics-objects\"><a href=\"#psql-dX-list-extended-statistics-objects\" class=\"headerlink\" title=\"psql \\dX: list extended statistics objects\"></a>psql \\dX: list extended statistics objects</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">891</span>a<span class=\"hljs-number\">1</span>d<span class=\"hljs-number\">0</span>bca<span class=\"hljs-number\">262</span>ca<span class=\"hljs-number\">78564</span>e<span class=\"hljs-number\">0</span>fea<span class=\"hljs-number\">1</span>eaa<span class=\"hljs-number\">5</span>ae<span class=\"hljs-number\">544</span>ea<span class=\"hljs-number\">5</span>ee<br><span class=\"hljs-attribute\">Author</span>: Tomas Vondra &lt;tomas.vondra@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">25</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-attribute\">psql</span> \\dX: list extended statistics objects<br><br>    <span class=\"hljs-attribute\">The</span> new command lists extended statistics objects, possibly with their<br>    <span class=\"hljs-attribute\">sizes</span>. <span class=\"hljs-literal\">All</span> past releases with extended statistics are supported.<br><br>    <span class=\"hljs-attribute\">Author</span>: Tatsuro Yamada<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Julien Rouhaud, Alvaro Herrera, Tomas Vondra<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/c<span class=\"hljs-number\">027</span>a<span class=\"hljs-number\">541</span>-<span class=\"hljs-number\">5856</span>-<span class=\"hljs-number\">75</span>a<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">0868</span>-<span class=\"hljs-number\">341301</span>e<span class=\"hljs-number\">1624</span>b%<span class=\"hljs-number\">40</span>nttcom.co.jp_<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> <span class=\"hljs-number\">1</span>db<span class=\"hljs-number\">0</span>d<span class=\"hljs-number\">173</span>a<span class=\"hljs-number\">2201119</span>f<span class=\"hljs-number\">297</span>ea<span class=\"hljs-number\">35</span>edfb<span class=\"hljs-number\">41579893</span>dd<span class=\"hljs-number\">8</span>c<br><span class=\"hljs-attribute\">Author</span>: Tomas Vondra &lt;tomas.vondra@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sun Jan <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">14</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0100</span><br><br>    <span class=\"hljs-attribute\">Revert</span> <span class=\"hljs-string\">&quot;psql \\dX: list extended statistics objects&quot;</span><br><br>    <span class=\"hljs-attribute\">Reverts</span> <span class=\"hljs-number\">891</span>a<span class=\"hljs-number\">1</span>d<span class=\"hljs-number\">0</span>bca, because the new  psql command \\dX only worked for<br>    <span class=\"hljs-attribute\">users</span> users who can read pg_statistic_ext_data catalog, and most regular<br>    <span class=\"hljs-attribute\">users</span> lack that privilege (the catalog may contain sensitive user data).<br><br>    <span class=\"hljs-attribute\">Reported</span>-by: Noriyoshi Shinoda<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/c<span class=\"hljs-number\">027</span>a<span class=\"hljs-number\">541</span>-<span class=\"hljs-number\">5856</span>-<span class=\"hljs-number\">75</span>a<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">0868</span>-<span class=\"hljs-number\">341301</span>e<span class=\"hljs-number\">1624</span>b%<span class=\"hljs-number\">40</span>nttcom.co.jp_<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"感觉14版本做了很多FDW的优化，是为集群模式做准备\"><a href=\"#感觉14版本做了很多FDW的优化，是为集群模式做准备\" class=\"headerlink\" title=\"感觉14版本做了很多FDW的优化，是为集群模式做准备?\"></a>感觉14版本做了很多FDW的优化，是为集群模式做准备?</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">8e396</span>a773b80c72e5d5a0ca9755dffe043c97a05<br>Author: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-type\">Date</span>:   Thu Jan <span class=\"hljs-number\">14</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">38</span> <span class=\"hljs-number\">2021</span> <span class=\"hljs-number\">-0500</span><br><br>    pg_dump: label <span class=\"hljs-keyword\">PUBLICATION</span> <span class=\"hljs-keyword\">TABLE</span> ArchiveEntries <span class=\"hljs-keyword\">with</span> an <span class=\"hljs-keyword\">owner</span>.<br><br>    This <span class=\"hljs-keyword\">is</span> the same fix <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">9</span>eabfe300 applied <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">INDEX</span> ATTACH<br>    entries, but <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span>-<span class=\"hljs-keyword\">to</span>-<span class=\"hljs-keyword\">publication</span> attachments.  <span class=\"hljs-keyword\">As</span> <span class=\"hljs-keyword\">in</span> that<br>    <span class=\"hljs-keyword\">case</span>, even though the backend doesn<span class=\"hljs-string\">&#x27;t record &quot;ownership&quot; of the</span><br><span class=\"hljs-string\">    attachment, we still ought to label it in the dump archive with</span><br><span class=\"hljs-string\">    the role name that should run the ALTER PUBLICATION command.</span><br><span class=\"hljs-string\">    The existing behavior causes the ALTER to be done by the original</span><br><span class=\"hljs-string\">    role that started the restore; that will usually work fine, but</span><br><span class=\"hljs-string\">    there may be corner cases where it fails.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    The bulk of the patch is concerned with changing struct</span><br><span class=\"hljs-string\">    PublicationRelInfo to include a pointer to the associated</span><br><span class=\"hljs-string\">    PublicationInfo object, so that we can get the owner&#x27;</span>s <span class=\"hljs-type\">name</span><br>    <span class=\"hljs-keyword\">out</span> <span class=\"hljs-keyword\">of</span> that <span class=\"hljs-keyword\">when</span> the <span class=\"hljs-type\">time</span> comes.  <span class=\"hljs-keyword\">While</span> at it, I rewrote<br>    getPublicationTables() <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">do</span> just one query <span class=\"hljs-keyword\">of</span> pg_publication_rel,<br>    <span class=\"hljs-keyword\">not</span> one per <span class=\"hljs-keyword\">table</span>.<br><br>    Back-patch <span class=\"hljs-keyword\">to</span> v10 <span class=\"hljs-keyword\">where</span> this code was introduced.<br><br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">1165710.1610473242</span>@sss.pgh.pa.us<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">708</span>d165ddb92c54077a372acf6417e258dcb5fef<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Jan <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">08</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    postgres_fdw: <span class=\"hljs-keyword\">Add</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">to</span> list cached connections <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">foreign</span> servers.<br><br>    This <span class=\"hljs-keyword\">commit</span> adds <span class=\"hljs-keyword\">function</span> postgres_fdw_get_connections() <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">return</span><br>    the <span class=\"hljs-keyword\">foreign</span> <span class=\"hljs-keyword\">server</span> names <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">open</span> connections that postgres_fdw<br>    established <span class=\"hljs-keyword\">from</span> the <span class=\"hljs-keyword\">local</span> <span class=\"hljs-keyword\">session</span> <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">foreign</span> servers. This <span class=\"hljs-keyword\">function</span><br>    <span class=\"hljs-keyword\">also</span> <span class=\"hljs-keyword\">returns</span> whether <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">valid</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">not</span>.<br><br>    This <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">when</span> checking <span class=\"hljs-keyword\">all</span> the <span class=\"hljs-keyword\">open</span> <span class=\"hljs-keyword\">foreign</span> <span class=\"hljs-keyword\">server</span> connections.<br>    <span class=\"hljs-keyword\">If</span> we <span class=\"hljs-built_in\">found</span> <span class=\"hljs-keyword\">some</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">drop</span>, <span class=\"hljs-keyword\">from</span> the result <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">function</span>, probably<br>    we can explicitly <span class=\"hljs-keyword\">close</span> them <span class=\"hljs-keyword\">by</span> the <span class=\"hljs-keyword\">function</span> that upcoming <span class=\"hljs-keyword\">commit</span> will <span class=\"hljs-keyword\">add</span>.<br><br>    This <span class=\"hljs-keyword\">commit</span> bumps the <span class=\"hljs-keyword\">version</span> <span class=\"hljs-keyword\">of</span> postgres_fdw <span class=\"hljs-keyword\">to</span> <span class=\"hljs-number\">1.1</span> since it adds<br>    <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">function</span>.<br><br>    Author: Bharath Rupireddy, tweaked <span class=\"hljs-keyword\">by</span> Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Zhijie Hou, Alexey Kondratov, Zhihong Yu, Fujii Masao<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">2</span>d5cb0b3-a6e8<span class=\"hljs-number\">-9</span>bbb<span class=\"hljs-number\">-953</span>f<span class=\"hljs-number\">-879</span>f47128faa@oss.nttdata.com<br><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> ee<span class=\"hljs-number\">79</span>a<span class=\"hljs-number\">548</span>e<span class=\"hljs-number\">746</span>da<span class=\"hljs-number\">9</span>a<span class=\"hljs-number\">99</span>df<span class=\"hljs-number\">0</span>cac<span class=\"hljs-number\">70</span>a<span class=\"hljs-number\">3</span>ddc<span class=\"hljs-number\">095</span>f<span class=\"hljs-number\">2829</span>a<br><span class=\"hljs-attribute\">Author</span>: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Tue Jan <span class=\"hljs-number\">19</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">56</span>:<span class=\"hljs-number\">10</span> <span class=\"hljs-number\">2021</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-attribute\">doc</span>: Add note about the server name of postgres_fdw_get_connections() returns.<br><br>    <span class=\"hljs-attribute\">Previously</span> the document didn&#x27;t mention the case where<br>    <span class=\"hljs-attribute\">postgres_fdw_get_connections</span>() returns NULL in server_name column.<br>    <span class=\"hljs-attribute\">Users</span> might be confused about why NULL was returned.<br><br>    <span class=\"hljs-attribute\">This</span> commit adds the note that, in postgres_fdw_get_connections(),<br>    <span class=\"hljs-attribute\">the</span> server name of an invalid connection will be NULL if the server is dropped.<br><br>    <span class=\"hljs-attribute\">Suggested</span>-by: Zhijie Hou<br>    <span class=\"hljs-attribute\">Author</span>: Bharath Rupireddy<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Zhijie Hou, Fujii Masao<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/e<span class=\"hljs-number\">7</span>ddd<span class=\"hljs-number\">14</span>e<span class=\"hljs-number\">96444</span>fce<span class=\"hljs-number\">88</span>e<span class=\"hljs-number\">47</span>a<span class=\"hljs-number\">709</span>c<span class=\"hljs-number\">196537</span>@G<span class=\"hljs-number\">08</span>CNEXMBPEKD<span class=\"hljs-number\">05</span>.g<span class=\"hljs-number\">08</span>.fujitsu.local<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> e3ebcca843a4703938b9f40a4811f43c4b315753<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon <span class=\"hljs-type\">Dec</span> <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">56</span>:<span class=\"hljs-number\">13</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    postgres_fdw: Fix <span class=\"hljs-keyword\">connection</span> leak.<br><br>    <span class=\"hljs-keyword\">In</span> postgres_fdw, the cached connections <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">foreign</span> servers will <span class=\"hljs-keyword\">not</span> be<br>    closed <span class=\"hljs-keyword\">until</span> the <span class=\"hljs-keyword\">local</span> <span class=\"hljs-keyword\">session</span> exits <span class=\"hljs-keyword\">if</span> the <span class=\"hljs-keyword\">user</span> mappings <span class=\"hljs-keyword\">or</span> <span class=\"hljs-keyword\">foreign</span> servers<br>    that those connections depend <span class=\"hljs-keyword\">on</span> are dropped. Those connections can be<br>    leaked.<br><br>    <span class=\"hljs-keyword\">To</span> fix that <span class=\"hljs-keyword\">connection</span> leak issue, <span class=\"hljs-keyword\">after</span> a change <span class=\"hljs-keyword\">to</span> a pg_foreign_server<br>    <span class=\"hljs-keyword\">or</span> pg_user_mapping catalog entry, this <span class=\"hljs-keyword\">commit</span> makes postgres_fdw <span class=\"hljs-keyword\">close</span><br>    the connections depending <span class=\"hljs-keyword\">on</span> that entry immediately <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">current</span><br>    <span class=\"hljs-keyword\">transaction</span> has <span class=\"hljs-keyword\">not</span> used those connections yet. Otherwise, mark those<br>    connections <span class=\"hljs-keyword\">as</span> invalid <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">then</span> <span class=\"hljs-keyword\">close</span> them at the <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">current</span> <span class=\"hljs-keyword\">transaction</span>,<br>    since they cannot be closed <span class=\"hljs-keyword\">in</span> the midst <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">transaction</span> <span class=\"hljs-keyword\">using</span> them.<br>    Closed connections will be remade at the next opportunity <span class=\"hljs-keyword\">if</span> necessary.<br><br>    Back-patch <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">all</span> supported branches.<br><br>    Author: Bharath Rupireddy<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Zhihong Yu, Zhijie Hou, Fujii Masao<br>    Discussion: https://postgr.es/m/CALj2ACVNcGH_6qLY<span class=\"hljs-number\">-4</span>_tXz8JLvA+<span class=\"hljs-number\">4</span>yeBThRfxMz7Oxbk1aHcpQ@mail.gmail.com<br><br></code></pre></td></tr></table></figure>"},{"title":"Linux ubuntu postgresql 源码搭建主从","date":"2020-08-11T04:04:03.000Z","top":12,"description":null,"password":null,"_content":"\n# 搭建主节点PostgreSQL实例\n## 下载\n\n[官网下载地址](https://www.postgresql.org/ftp/source/v12.3/)\n\n```\nsudo groupadd postgres\nsudo useradd -a -G postgres postgres\nsu - postgres\nwget https://ftp.postgresql.org/pub/source/v12.3/postgresql-12.3.tar.gz\n```\n<!-- more -->\n\n## 解压 && 编译 && 安装\n\n需要带哪些编译选项看个人需求\n```\ntar -zxvf postgresql-12.3.tar.gz\ncd postgresql-12.3\n./configure CFLAGS=-O0 -g' '--prefix=/home/postgres/pg12' '--with-perl' '--with-libxml' '--with-libxslt' '--with-ossp-uuid' '--with-blocksize=32' '--with-segsize=2' '--with-wal-blocksize=64' '--with-llvm' --with-python\nmake -j10 world       # 带插件一起编译\nmake install-world    # 带插件一起安装\n```\nmake install-world 出现\"PostgreSQL, contrib, and documentation installation complete.\"时， 即为成功\n\n\n## 配置环境变量\n\nvim ~/.bashrc 追加如下内容\n```\nexport PGHOME=/home/postgres/pg12\nexport PGDATA=/home/postgres/pg120_data\nexport PGUSER=postgres\nexport PGPORT=5432\nexport PGDATABASE=postgres\nexport LD_LIBRARY_PATH=/home/postgres/pg12/lib:$LD_LIBRARY_PATH\nexport PATH=/home/postgres/pg12/bin:$PATH\n```\n重新打开窗口，或者执行 . ~/.bashrc 使之生效\n\n## 初始化\n```\npostgres@pgserver1:~/postgresql-12.3$ initdb\nThe files belonging to this database system will be owned by user \"postgres\".\nThis user must also own the server process.\n\nThe database cluster will be initialized with locales\n  COLLATE:  en_US.UTF-8\n  CTYPE:    en_US.UTF-8\n  MESSAGES: en_US.UTF-8\n  MONETARY: zh_CN.UTF-8\n  NUMERIC:  zh_CN.UTF-8\n  TIME:     zh_CN.UTF-8\nThe default database encoding has accordingly been set to \"UTF8\".\nThe default text search configuration will be set to \"english\".\n\nData page checksums are disabled.\n\ncreating directory /home/postgres/pg120_data ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Asia/Shanghai\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\n\ninitdb: warning: enabling \"trust\" authentication for local connections\nYou can change this by editing pg_hba.conf or using the option -A, or\n--auth-local and --auth-host, the next time you run initdb.\n\nSuccess. You can now start the database server using:\n\n    pg_ctl -D /home/postgres/pg120_data -l logfile start\n\n```\n\n## 修改参数, 记录数据库日志\n```\nwal_level = replica             # minimal, replica, or logical\n                                # (change requires restart)\n\nlisten_addresses = '*'          # what IP address(es) to listen on;\n                                        # comma-separated list of addresses;\n                                        # defaults to 'localhost'; use '*' for all\n                                        # (change requires restart)\nport = 5432                             # (change requires restart)\n\nlogging_collector = on          # Enable capturing of stderr and csvlog\n                                        # into log files. Required to be on for\n                                        # csvlogs.\n                                        # (change requires restart)\n\n# These are only used if logging_collector is on:\nlog_directory = 'log'                   # directory where log files are written,\n                                        # can be absolute or relative to PGDATA\nlog_filename = 'postgresql-%a.log'      # log file name pattern,\n                                        # can include strftime() escapes\n#log_file_mode = 0600                   # creation mode for log files,\n                                        # begin with 0 to use octal notation\nlog_truncate_on_rotation = on           # If on, an existing log file with the\n                                        # same name as the new log file will be\n                                        # truncated rather than appended to.\n                                        # But such truncation only occurs on\n                                        # time-driven rotation, not on restarts\n                                        # or size-driven rotation.  Default is\n                                        # off, meaning append to existing files\n```\n\n## 启动数据库\n```\npostgres@pgserver1:~/postgresql-12.3$ pg_ctl start\nwaiting for server to start....2020-08-11 14:39:44.004 CST [3608866] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit\n2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv4 address \"0.0.0.0\", port 5432\n2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv6 address \"::\", port 5432\n2020-08-11 14:39:44.006 CST [3608866] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n2020-08-11 14:39:44.012 CST [3608866] LOG:  redirecting log output to logging collector process\n2020-08-11 14:39:44.012 CST [3608866] HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n# 搭建主节点PostgreSQL实例\n## 下载 \n\n** 步骤同1.1 **\n\n## 解压 && 编译 && 安装 \n\n** 步骤同1.2 **\n\n## 配置环境变量\n\n** 步骤同1.3 **\n\n## 主节点创建流复制用户\n```\npostgres@pgserver1:~/postgresql-12.3$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# \\! uuidgen\n7089bae5-c467-492a-a402-aaba388e6826\npostgres=# create user replicator Replication password '7089bae5-c467-492a-a402-aaba388e6826';\nCREATE ROLE\npostgres=#\n```\n\n## 增加用户replicator ACL\n主库 vim $PGDATA/pg_hba.conf 新增, x.x.x.x为从节点IP\n```\nhost    replication     replicator      x.x.x.x/32            trust\n```\n\n使之生效\n```\npostgres@pgserver1:~$ psql \npsql (12.3)\nType \"help\" for help.\n\npostgres=# select pg_reload_conf();\n pg_reload_conf \n----------------\n t\n(1 row)\n```\n## 使用pg_basebackup生成从库数据目录\n```\npostgres@pgserver2:~$ pg_basebackup -D /home/postgres/pg120_data -R -X stream -c fast -P -h pgserver1 -p 5432 -Ureplicator\n65984/65984 kB (100%), 1/1 tablespace\n```\n## 启动从库\n\n```\npostgres@pgserver2:~$ pg_ctl -D /home/postgres/pg120_data start\nwaiting for server to start....2020-08-14 15:12:31.552 CST [817489] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit\n2020-08-14 15:12:31.552 CST [817489] LOG:  listening on IPv4 address \"x.x.x.x\", port 5432\n2020-08-14 15:12:31.555 CST [817489] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n2020-08-14 15:12:31.566 CST [817489] LOG:  redirecting log output to logging collector process\n2020-08-14 15:12:31.566 CST [817489] HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n## 主节点确认流复制\n```\npostgres@pgserver1:~$ psql \npsql (12.3)\nType \"help\" for help.\npostgres=# select * from pg_stat_replication ;\n  pid   | usesysid | usename  | application_name | client_addr | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn |   writ\ne_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state |          reply_time           \n--------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-------\n---------+-----------------+-----------------+---------------+------------+-------------------------------\n 817497 |       10 | replicator | walreceiver      | x.x.x.x   |                 |       50850 | 2020-08-14 15:12:31.612261+08 |              | streaming | 0/4000B60 | 0/4000B60 | 0/4000B60 | 0/4000B60  | 00:00:\n00.02204 | 00:00:00.022362 | 00:00:00.022769 |             0 | async      | 2020-08-14 15:12:31.636213+08\n(1 row)\n\npostgres=# \n```\n\n## 从节点确认流复制\n```\npostgres@pgserver2:~$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# select * from pg_stat_wal_receiver ;\n  pid   |  status   | receive_start_lsn | receive_start_tli | received_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |        latest_end_time        | slot_n\name | sender_host | sender_port |                                                                                                             conninfo                                                             \n                                                \n--------+-----------+-------------------+-------------------+--------------+--------------+-------------------------------+-------------------------------+----------------+-------------------------------+-------\n----+-------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n------------------------------------------------\n 817496 | streaming | 0/4000000         |                 1 | 0/4000B60    |            1 | 2020-08-14 15:15:01.924922+08 | 2020-08-14 15:15:01.924989+08 | 0/4000B60      | 2020-08-14 15:12:31.613519+08 |       \n    | x.x.x.x   |        5432 | user=replicator passfile=/home/postgres/.pgpass dbname=replication host=x.x.x.x port=5432 fallback_application_name=walreceiver sslmode=disable sslcompression=0 gssencmode=disab\nle krbsrvname=replicator target_session_attrs=any\n(1 row)\n\npostgres=# \n```\n\n# 结束\n\n主从搭建so easy.\n\n# FAQ\n\n[PostgreSQL：编译安装常见问题](https://postgres.fun/20131118144309.html)\n[RedHat Enterprise 5上安装 Postgresql](https://postgres.fun/20100731115100.html)\n","source":"_posts/PostgreSQL_install_from_source.md","raw":"---\ntitle: Linux ubuntu postgresql 源码搭建主从 \ndate: 2020-08-11 12:04:03\ntags: \n- postgres\n- pg\n- install\n- source\n- postgresql\n- PostgreSQL\ncategories:\n- PostgreSQL\ntop: 12\ndescription: \npassword: \n\n---\n\n# 搭建主节点PostgreSQL实例\n## 下载\n\n[官网下载地址](https://www.postgresql.org/ftp/source/v12.3/)\n\n```\nsudo groupadd postgres\nsudo useradd -a -G postgres postgres\nsu - postgres\nwget https://ftp.postgresql.org/pub/source/v12.3/postgresql-12.3.tar.gz\n```\n<!-- more -->\n\n## 解压 && 编译 && 安装\n\n需要带哪些编译选项看个人需求\n```\ntar -zxvf postgresql-12.3.tar.gz\ncd postgresql-12.3\n./configure CFLAGS=-O0 -g' '--prefix=/home/postgres/pg12' '--with-perl' '--with-libxml' '--with-libxslt' '--with-ossp-uuid' '--with-blocksize=32' '--with-segsize=2' '--with-wal-blocksize=64' '--with-llvm' --with-python\nmake -j10 world       # 带插件一起编译\nmake install-world    # 带插件一起安装\n```\nmake install-world 出现\"PostgreSQL, contrib, and documentation installation complete.\"时， 即为成功\n\n\n## 配置环境变量\n\nvim ~/.bashrc 追加如下内容\n```\nexport PGHOME=/home/postgres/pg12\nexport PGDATA=/home/postgres/pg120_data\nexport PGUSER=postgres\nexport PGPORT=5432\nexport PGDATABASE=postgres\nexport LD_LIBRARY_PATH=/home/postgres/pg12/lib:$LD_LIBRARY_PATH\nexport PATH=/home/postgres/pg12/bin:$PATH\n```\n重新打开窗口，或者执行 . ~/.bashrc 使之生效\n\n## 初始化\n```\npostgres@pgserver1:~/postgresql-12.3$ initdb\nThe files belonging to this database system will be owned by user \"postgres\".\nThis user must also own the server process.\n\nThe database cluster will be initialized with locales\n  COLLATE:  en_US.UTF-8\n  CTYPE:    en_US.UTF-8\n  MESSAGES: en_US.UTF-8\n  MONETARY: zh_CN.UTF-8\n  NUMERIC:  zh_CN.UTF-8\n  TIME:     zh_CN.UTF-8\nThe default database encoding has accordingly been set to \"UTF8\".\nThe default text search configuration will be set to \"english\".\n\nData page checksums are disabled.\n\ncreating directory /home/postgres/pg120_data ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... Asia/Shanghai\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\n\ninitdb: warning: enabling \"trust\" authentication for local connections\nYou can change this by editing pg_hba.conf or using the option -A, or\n--auth-local and --auth-host, the next time you run initdb.\n\nSuccess. You can now start the database server using:\n\n    pg_ctl -D /home/postgres/pg120_data -l logfile start\n\n```\n\n## 修改参数, 记录数据库日志\n```\nwal_level = replica             # minimal, replica, or logical\n                                # (change requires restart)\n\nlisten_addresses = '*'          # what IP address(es) to listen on;\n                                        # comma-separated list of addresses;\n                                        # defaults to 'localhost'; use '*' for all\n                                        # (change requires restart)\nport = 5432                             # (change requires restart)\n\nlogging_collector = on          # Enable capturing of stderr and csvlog\n                                        # into log files. Required to be on for\n                                        # csvlogs.\n                                        # (change requires restart)\n\n# These are only used if logging_collector is on:\nlog_directory = 'log'                   # directory where log files are written,\n                                        # can be absolute or relative to PGDATA\nlog_filename = 'postgresql-%a.log'      # log file name pattern,\n                                        # can include strftime() escapes\n#log_file_mode = 0600                   # creation mode for log files,\n                                        # begin with 0 to use octal notation\nlog_truncate_on_rotation = on           # If on, an existing log file with the\n                                        # same name as the new log file will be\n                                        # truncated rather than appended to.\n                                        # But such truncation only occurs on\n                                        # time-driven rotation, not on restarts\n                                        # or size-driven rotation.  Default is\n                                        # off, meaning append to existing files\n```\n\n## 启动数据库\n```\npostgres@pgserver1:~/postgresql-12.3$ pg_ctl start\nwaiting for server to start....2020-08-11 14:39:44.004 CST [3608866] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit\n2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv4 address \"0.0.0.0\", port 5432\n2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv6 address \"::\", port 5432\n2020-08-11 14:39:44.006 CST [3608866] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n2020-08-11 14:39:44.012 CST [3608866] LOG:  redirecting log output to logging collector process\n2020-08-11 14:39:44.012 CST [3608866] HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n# 搭建主节点PostgreSQL实例\n## 下载 \n\n** 步骤同1.1 **\n\n## 解压 && 编译 && 安装 \n\n** 步骤同1.2 **\n\n## 配置环境变量\n\n** 步骤同1.3 **\n\n## 主节点创建流复制用户\n```\npostgres@pgserver1:~/postgresql-12.3$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# \\! uuidgen\n7089bae5-c467-492a-a402-aaba388e6826\npostgres=# create user replicator Replication password '7089bae5-c467-492a-a402-aaba388e6826';\nCREATE ROLE\npostgres=#\n```\n\n## 增加用户replicator ACL\n主库 vim $PGDATA/pg_hba.conf 新增, x.x.x.x为从节点IP\n```\nhost    replication     replicator      x.x.x.x/32            trust\n```\n\n使之生效\n```\npostgres@pgserver1:~$ psql \npsql (12.3)\nType \"help\" for help.\n\npostgres=# select pg_reload_conf();\n pg_reload_conf \n----------------\n t\n(1 row)\n```\n## 使用pg_basebackup生成从库数据目录\n```\npostgres@pgserver2:~$ pg_basebackup -D /home/postgres/pg120_data -R -X stream -c fast -P -h pgserver1 -p 5432 -Ureplicator\n65984/65984 kB (100%), 1/1 tablespace\n```\n## 启动从库\n\n```\npostgres@pgserver2:~$ pg_ctl -D /home/postgres/pg120_data start\nwaiting for server to start....2020-08-14 15:12:31.552 CST [817489] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit\n2020-08-14 15:12:31.552 CST [817489] LOG:  listening on IPv4 address \"x.x.x.x\", port 5432\n2020-08-14 15:12:31.555 CST [817489] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n2020-08-14 15:12:31.566 CST [817489] LOG:  redirecting log output to logging collector process\n2020-08-14 15:12:31.566 CST [817489] HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n## 主节点确认流复制\n```\npostgres@pgserver1:~$ psql \npsql (12.3)\nType \"help\" for help.\npostgres=# select * from pg_stat_replication ;\n  pid   | usesysid | usename  | application_name | client_addr | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn |   writ\ne_lag    |    flush_lag    |   replay_lag    | sync_priority | sync_state |          reply_time           \n--------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-------\n---------+-----------------+-----------------+---------------+------------+-------------------------------\n 817497 |       10 | replicator | walreceiver      | x.x.x.x   |                 |       50850 | 2020-08-14 15:12:31.612261+08 |              | streaming | 0/4000B60 | 0/4000B60 | 0/4000B60 | 0/4000B60  | 00:00:\n00.02204 | 00:00:00.022362 | 00:00:00.022769 |             0 | async      | 2020-08-14 15:12:31.636213+08\n(1 row)\n\npostgres=# \n```\n\n## 从节点确认流复制\n```\npostgres@pgserver2:~$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# select * from pg_stat_wal_receiver ;\n  pid   |  status   | receive_start_lsn | receive_start_tli | received_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |        latest_end_time        | slot_n\name | sender_host | sender_port |                                                                                                             conninfo                                                             \n                                                \n--------+-----------+-------------------+-------------------+--------------+--------------+-------------------------------+-------------------------------+----------------+-------------------------------+-------\n----+-------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n------------------------------------------------\n 817496 | streaming | 0/4000000         |                 1 | 0/4000B60    |            1 | 2020-08-14 15:15:01.924922+08 | 2020-08-14 15:15:01.924989+08 | 0/4000B60      | 2020-08-14 15:12:31.613519+08 |       \n    | x.x.x.x   |        5432 | user=replicator passfile=/home/postgres/.pgpass dbname=replication host=x.x.x.x port=5432 fallback_application_name=walreceiver sslmode=disable sslcompression=0 gssencmode=disab\nle krbsrvname=replicator target_session_attrs=any\n(1 row)\n\npostgres=# \n```\n\n# 结束\n\n主从搭建so easy.\n\n# FAQ\n\n[PostgreSQL：编译安装常见问题](https://postgres.fun/20131118144309.html)\n[RedHat Enterprise 5上安装 Postgresql](https://postgres.fun/20100731115100.html)\n","slug":"PostgreSQL_install_from_source","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzh90008pieb7nd12adz","content":"<h1 id=\"搭建主节点PostgreSQL实例\"><a href=\"#搭建主节点PostgreSQL实例\" class=\"headerlink\" title=\"搭建主节点PostgreSQL实例\"></a>搭建主节点PostgreSQL实例</h1><h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p><a href=\"https://www.postgresql.org/ftp/source/v12.3/\">官网下载地址</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">sudo groupadd postgres<br>sudo useradd -a -G postgres postgres<br>su - postgres<br>wget https:<span class=\"hljs-regexp\">//</span>ftp.postgresql.org<span class=\"hljs-regexp\">/pub/</span>source<span class=\"hljs-regexp\">/v12.3/</span>postgresql-<span class=\"hljs-number\">12.3</span>.tar.gz<br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"解压-amp-amp-编译-amp-amp-安装\"><a href=\"#解压-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"解压 &amp;&amp; 编译 &amp;&amp; 安装\"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p>需要带哪些编译选项看个人需求<br><figure class=\"highlight flix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs flix\">tar -zxvf postgresql<span class=\"hljs-number\">-12.3</span>.tar.gz<br>cd postgresql<span class=\"hljs-number\">-12.3</span><br>./configure CFLAGS=-O0 -g<span class=\"hljs-string\">&#x27; &#x27;</span>--prefix=/home/postgres/pg12<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-perl<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-libxml<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-libxslt<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-ossp-uuid<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-blocksize=<span class=\"hljs-number\">32</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-segsize=<span class=\"hljs-number\">2</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-wal-blocksize=<span class=\"hljs-number\">64</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-llvm&#x27; --<span class=\"hljs-keyword\">with</span>-python<br>make -j10 world       # 带插件一起编译<br>make install-world    # 带插件一起安装<br></code></pre></td></tr></table></figure><br>make install-world 出现”PostgreSQL, contrib, and documentation installation complete.”时， 即为成功</p>\n<h2 id=\"配置环境变量\"><a href=\"#配置环境变量\" class=\"headerlink\" title=\"配置环境变量\"></a>配置环境变量</h2><p>vim ~/.bashrc 追加如下内容<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGHOME</span>=/home/postgres/pg12<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGDATA</span>=/home/postgres/pg120_data<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGUSER</span>=postgres<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGPORT</span>=5432<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGDATABASE</span>=postgres<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">LD_LIBRARY_PATH</span>=/home/postgres/pg12/lib:$LD_LIBRARY_PATH<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PATH</span>=/home/postgres/pg12/bin:$PATH<br></code></pre></td></tr></table></figure><br>重新打开窗口，或者执行 . ~/.bashrc 使之生效</p>\n<h2 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ initdb<br>The files belonging <span class=\"hljs-keyword\">to</span> this database<span class=\"hljs-built_in\"> system </span>will be owned by<span class=\"hljs-built_in\"> user </span><span class=\"hljs-string\">&quot;postgres&quot;</span>.<br>This<span class=\"hljs-built_in\"> user </span>must also own the<span class=\"hljs-built_in\"> server </span>process.<br><br>The database cluster will be initialized with locales<br>  COLLATE:  en_US.UTF-8<br>  CTYPE:    en_US.UTF-8<br>  MESSAGES: en_US.UTF-8<br>  MONETARY: zh_CN.UTF-8<br>  NUMERIC:  zh_CN.UTF-8<br>  TIME:     zh_CN.UTF-8<br>The<span class=\"hljs-built_in\"> default </span>database encoding has accordingly been <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;UTF8&quot;</span>.<br>The<span class=\"hljs-built_in\"> default </span>text search configuration will be <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;english&quot;</span>.<br><br>Data<span class=\"hljs-built_in\"> page </span>checksums are disabled.<br><br>creating directory /home/postgres/pg120_data <span class=\"hljs-built_in\">..</span>. ok<br>creating subdirectories <span class=\"hljs-built_in\">..</span>. ok<br>selecting dynamic shared memory implementation <span class=\"hljs-built_in\">..</span>. posix<br>selecting<span class=\"hljs-built_in\"> default </span>max_connections <span class=\"hljs-built_in\">..</span>. 100<br>selecting<span class=\"hljs-built_in\"> default </span>shared_buffers <span class=\"hljs-built_in\">..</span>. 128MB<br>selecting<span class=\"hljs-built_in\"> default </span>time zone <span class=\"hljs-built_in\">..</span>. Asia/Shanghai<br>creating configuration files <span class=\"hljs-built_in\">..</span>. ok<br>running bootstrap<span class=\"hljs-built_in\"> script </span><span class=\"hljs-built_in\">..</span>. ok<br>performing post-bootstrap initialization <span class=\"hljs-built_in\">..</span>. ok<br>syncing data <span class=\"hljs-keyword\">to</span> disk <span class=\"hljs-built_in\">..</span>. ok<br><br>initdb: warning: enabling <span class=\"hljs-string\">&quot;trust&quot;</span> authentication <span class=\"hljs-keyword\">for</span> local connections<br>You can change this by editing pg_hba.conf <span class=\"hljs-keyword\">or</span> using the option -A, <span class=\"hljs-keyword\">or</span><br>--auth-local <span class=\"hljs-keyword\">and</span> --auth-host, the next time you <span class=\"hljs-builtin-name\">run</span> initdb.<br><br>Success. You can now start the database<span class=\"hljs-built_in\"> server </span>using:<br><br>    pg_ctl -D /home/postgres/pg120_data -l logfile start<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"修改参数-记录数据库日志\"><a href=\"#修改参数-记录数据库日志\" class=\"headerlink\" title=\"修改参数, 记录数据库日志\"></a>修改参数, 记录数据库日志</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">wal_level</span> = replica             <span class=\"hljs-comment\"># minimal, replica, or logical</span><br>                                <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-attr\">listen_addresses</span> = <span class=\"hljs-string\">&#x27;*&#x27;</span>          <span class=\"hljs-comment\"># what IP address(es) to listen on;</span><br>                                        <span class=\"hljs-comment\"># comma-separated list of addresses;</span><br>                                        <span class=\"hljs-comment\"># defaults to &#x27;localhost&#x27;; use &#x27;*&#x27; for all</span><br>                                        <span class=\"hljs-comment\"># (change requires restart)</span><br><span class=\"hljs-attr\">port</span> = <span class=\"hljs-number\">5432</span>                             <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-attr\">logging_collector</span> = <span class=\"hljs-literal\">on</span>          <span class=\"hljs-comment\"># Enable capturing of stderr and csvlog</span><br>                                        <span class=\"hljs-comment\"># into log files. Required to be on for</span><br>                                        <span class=\"hljs-comment\"># csvlogs.</span><br>                                        <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-comment\"># These are only used if logging_collector is on:</span><br><span class=\"hljs-attr\">log_directory</span> = <span class=\"hljs-string\">&#x27;log&#x27;</span>                   <span class=\"hljs-comment\"># directory where log files are written,</span><br>                                        <span class=\"hljs-comment\"># can be absolute or relative to PGDATA</span><br><span class=\"hljs-attr\">log_filename</span> = <span class=\"hljs-string\">&#x27;postgresql-%a.log&#x27;</span>      <span class=\"hljs-comment\"># log file name pattern,</span><br>                                        <span class=\"hljs-comment\"># can include strftime() escapes</span><br><span class=\"hljs-comment\">#log_file_mode = 0600                   # creation mode for log files,</span><br>                                        <span class=\"hljs-comment\"># begin with 0 to use octal notation</span><br><span class=\"hljs-attr\">log_truncate_on_rotation</span> = <span class=\"hljs-literal\">on</span>           <span class=\"hljs-comment\"># If on, an existing log file with the</span><br>                                        <span class=\"hljs-comment\"># same name as the new log file will be</span><br>                                        <span class=\"hljs-comment\"># truncated rather than appended to.</span><br>                                        <span class=\"hljs-comment\"># But such truncation only occurs on</span><br>                                        <span class=\"hljs-comment\"># time-driven rotation, not on restarts</span><br>                                        <span class=\"hljs-comment\"># or size-driven rotation.  Default is</span><br>                                        <span class=\"hljs-comment\"># off, meaning append to existing files</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"启动数据库\"><a href=\"#启动数据库\" class=\"headerlink\" title=\"启动数据库\"></a>启动数据库</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ pg_ctl start<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>2020-08-11 14:39:44.004 CST [3608866] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;0.0.0.0&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on<span class=\"hljs-built_in\"> IPv6 address </span><span class=\"hljs-string\">&quot;::&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-11 14:39:44.006 CST [3608866] LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-11 14:39:44.012 CST [3608866] LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>2020-08-11 14:39:44.012 CST [3608866] HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h1 id=\"搭建主节点PostgreSQL实例-1\"><a href=\"#搭建主节点PostgreSQL实例-1\" class=\"headerlink\" title=\"搭建主节点PostgreSQL实例\"></a>搭建主节点PostgreSQL实例</h1><h2 id=\"下载-1\"><a href=\"#下载-1\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p><strong> 步骤同1.1 </strong></p>\n<h2 id=\"解压-amp-amp-编译-amp-amp-安装-1\"><a href=\"#解压-amp-amp-编译-amp-amp-安装-1\" class=\"headerlink\" title=\"解压 &amp;&amp; 编译 &amp;&amp; 安装\"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p><strong> 步骤同1.2 </strong></p>\n<h2 id=\"配置环境变量-1\"><a href=\"#配置环境变量-1\" class=\"headerlink\" title=\"配置环境变量\"></a>配置环境变量</h2><p><strong> 步骤同1.3 </strong></p>\n<h2 id=\"主节点创建流复制用户\"><a href=\"#主节点创建流复制用户\" class=\"headerlink\" title=\"主节点创建流复制用户\"></a>主节点创建流复制用户</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# \\! uuidgen<br>7089bae5-c467-492a-a402-aaba388e6826<br><span class=\"hljs-attribute\">postgres</span>=# create<span class=\"hljs-built_in\"> user </span>replicator Replication password <span class=\"hljs-string\">&#x27;7089bae5-c467-492a-a402-aaba388e6826&#x27;</span>;<br>CREATE ROLE<br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<h2 id=\"增加用户replicator-ACL\"><a href=\"#增加用户replicator-ACL\" class=\"headerlink\" title=\"增加用户replicator ACL\"></a>增加用户replicator ACL</h2><p>主库 vim $PGDATA/pg_hba.conf 新增, x.x.x.x为从节点IP<br><figure class=\"highlight gml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gml\">host    replication     replicator      <span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>/<span class=\"hljs-number\">32</span>            trust<br></code></pre></td></tr></table></figure></p>\n<p>使之生效<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres@pgserver1:~$ psql <br>psql (<span class=\"hljs-number\">12.3</span>)<br><span class=\"hljs-keyword\">Type</span> &quot;help&quot; <span class=\"hljs-keyword\">for</span> help.<br><br>postgres=# <span class=\"hljs-keyword\">select</span> pg_reload_conf();<br> pg_reload_conf <br><span class=\"hljs-comment\">----------------</span><br> t<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"使用pg-basebackup生成从库数据目录\"><a href=\"#使用pg-basebackup生成从库数据目录\" class=\"headerlink\" title=\"使用pg_basebackup生成从库数据目录\"></a>使用pg_basebackup生成从库数据目录</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres@pgserver2:~$ pg_basebackup -D /home/postgres/pg120_data -R -X stream -c fast -P -h pgserver1 -p <span class=\"hljs-number\">5432</span> -Ureplicator<br><span class=\"hljs-number\">65984</span>/<span class=\"hljs-number\">65984</span> kB (<span class=\"hljs-number\">100</span>%), <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">tablespace</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"启动从库\"><a href=\"#启动从库\" class=\"headerlink\" title=\"启动从库\"></a>启动从库</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver2:~$ pg_ctl -D /home/postgres/pg120_data start<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>2020-08-14 15:12:31.552 CST [817489] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-14 15:12:31.552 CST [817489] LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;x.x.x.x&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-14 15:12:31.555 CST [817489] LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-14 15:12:31.566 CST [817489] LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>2020-08-14 15:12:31.566 CST [817489] HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h2 id=\"主节点确认流复制\"><a href=\"#主节点确认流复制\" class=\"headerlink\" title=\"主节点确认流复制\"></a>主节点确认流复制</h2><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gherkin\">postgres<span class=\"hljs-meta\">@pgserver1:~$</span> psql <br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> for help.<br>postgres=<span class=\"hljs-comment\"># select * from pg_stat_replication ;</span><br>  pid   |<span class=\"hljs-string\"> usesysid </span>|<span class=\"hljs-string\"> usename  </span>|<span class=\"hljs-string\"> application_name </span>|<span class=\"hljs-string\"> client_addr </span>|<span class=\"hljs-string\"> client_hostname </span>|<span class=\"hljs-string\"> client_port </span>|<span class=\"hljs-string\">         backend_start         </span>|<span class=\"hljs-string\"> backend_xmin </span>|<span class=\"hljs-string\">   state   </span>|<span class=\"hljs-string\"> sent_lsn  </span>|<span class=\"hljs-string\"> write_lsn </span>|<span class=\"hljs-string\"> flush_lsn </span>|<span class=\"hljs-string\"> replay_lsn </span>|<span class=\"hljs-string\">   writ</span><br><span class=\"hljs-string\">e_lag    </span>|<span class=\"hljs-string\">    flush_lag    </span>|<span class=\"hljs-string\">   replay_lag    </span>|<span class=\"hljs-string\"> sync_priority </span>|<span class=\"hljs-string\"> sync_state </span>|<span class=\"hljs-string\">          reply_time           </span><br><span class=\"hljs-string\">--------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-------</span><br><span class=\"hljs-string\">---------+-----------------+-----------------+---------------+------------+-------------------------------</span><br><span class=\"hljs-string\"> 817497 </span>|<span class=\"hljs-string\">       10 </span>|<span class=\"hljs-string\"> replicator </span>|<span class=\"hljs-string\"> walreceiver      </span>|<span class=\"hljs-string\"> x.x.x.x   </span>|<span class=\"hljs-string\">                 </span>|<span class=\"hljs-string\">       50850 </span>|<span class=\"hljs-string\"> 2020-08-14 15:12:31.612261+08 </span>|<span class=\"hljs-string\">              </span>|<span class=\"hljs-string\"> streaming </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60  </span>|<span class=\"hljs-string\"> 00:00:</span><br><span class=\"hljs-string\">00.02204 </span>|<span class=\"hljs-string\"> 00:00:00.022362 </span>|<span class=\"hljs-string\"> 00:00:00.022769 </span>|<span class=\"hljs-string\">             0 </span>|<span class=\"hljs-string\"> async      </span>|<span class=\"hljs-string\"> 2020-08-14 15:12:31.636213+08</span><br><span class=\"hljs-string\">(1 row)</span><br><br><span class=\"hljs-string\">postgres=# </span><br></code></pre></td></tr></table></figure>\n<h2 id=\"从节点确认流复制\"><a href=\"#从节点确认流复制\" class=\"headerlink\" title=\"从节点确认流复制\"></a>从节点确认流复制</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver2:~$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# select * <span class=\"hljs-keyword\">from</span> pg_stat_wal_receiver ;<br>  pid   |  status   | receive_start_lsn | receive_start_tli | received_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |        latest_end_time        | slot_n<br>ame | sender_host | sender_port |                                                                                                             conninfo                                                             <br>                                                <br>--------+-----------+-------------------+-------------------+--------------+--------------+-------------------------------+-------------------------------+----------------+-------------------------------+-------<br>----+-------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------<br> 817496 | streaming | 0/4000000         |                 1 | 0/4000B60    |            1 | 2020-08-14 15:15:01.924922+08 | 2020-08-14 15:15:01.924989+08 | 0/4000B60      | 2020-08-14 15:12:31.613519+08 |       <br>    | x.x.x.x   |        5432 | <span class=\"hljs-attribute\">user</span>=replicator <span class=\"hljs-attribute\">passfile</span>=/home/postgres/.pgpass <span class=\"hljs-attribute\">dbname</span>=replication <span class=\"hljs-attribute\">host</span>=x.x.x.x <span class=\"hljs-attribute\">port</span>=5432 <span class=\"hljs-attribute\">fallback_application_name</span>=walreceiver <span class=\"hljs-attribute\">sslmode</span>=disable <span class=\"hljs-attribute\">sslcompression</span>=0 <span class=\"hljs-attribute\">gssencmode</span>=disab<br>le <span class=\"hljs-attribute\">krbsrvname</span>=replicator <span class=\"hljs-attribute\">target_session_attrs</span>=any<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=# <br></code></pre></td></tr></table></figure>\n<h1 id=\"结束\"><a href=\"#结束\" class=\"headerlink\" title=\"结束\"></a>结束</h1><p>主从搭建so easy.</p>\n<h1 id=\"FAQ\"><a href=\"#FAQ\" class=\"headerlink\" title=\"FAQ\"></a>FAQ</h1><p><a href=\"https://postgres.fun/20131118144309.html\">PostgreSQL：编译安装常见问题</a><br><a href=\"https://postgres.fun/20100731115100.html\">RedHat Enterprise 5上安装 Postgresql</a></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"搭建主节点PostgreSQL实例\"><a href=\"#搭建主节点PostgreSQL实例\" class=\"headerlink\" title=\"搭建主节点PostgreSQL实例\"></a>搭建主节点PostgreSQL实例</h1><h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p><a href=\"https://www.postgresql.org/ftp/source/v12.3/\">官网下载地址</a></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">sudo groupadd postgres<br>sudo useradd -a -G postgres postgres<br>su - postgres<br>wget https:<span class=\"hljs-regexp\">//</span>ftp.postgresql.org<span class=\"hljs-regexp\">/pub/</span>source<span class=\"hljs-regexp\">/v12.3/</span>postgresql-<span class=\"hljs-number\">12.3</span>.tar.gz<br></code></pre></td></tr></table></figure>","more":"<h2 id=\"解压-amp-amp-编译-amp-amp-安装\"><a href=\"#解压-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"解压 &amp;&amp; 编译 &amp;&amp; 安装\"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p>需要带哪些编译选项看个人需求<br><figure class=\"highlight flix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs flix\">tar -zxvf postgresql<span class=\"hljs-number\">-12.3</span>.tar.gz<br>cd postgresql<span class=\"hljs-number\">-12.3</span><br>./configure CFLAGS=-O0 -g<span class=\"hljs-string\">&#x27; &#x27;</span>--prefix=/home/postgres/pg12<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-perl<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-libxml<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-libxslt<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-ossp-uuid<span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-blocksize=<span class=\"hljs-number\">32</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-segsize=<span class=\"hljs-number\">2</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-wal-blocksize=<span class=\"hljs-number\">64</span><span class=\"hljs-string\">&#x27; &#x27;</span>--<span class=\"hljs-keyword\">with</span>-llvm&#x27; --<span class=\"hljs-keyword\">with</span>-python<br>make -j10 world       # 带插件一起编译<br>make install-world    # 带插件一起安装<br></code></pre></td></tr></table></figure><br>make install-world 出现”PostgreSQL, contrib, and documentation installation complete.”时， 即为成功</p>\n<h2 id=\"配置环境变量\"><a href=\"#配置环境变量\" class=\"headerlink\" title=\"配置环境变量\"></a>配置环境变量</h2><p>vim ~/.bashrc 追加如下内容<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGHOME</span>=/home/postgres/pg12<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGDATA</span>=/home/postgres/pg120_data<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGUSER</span>=postgres<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGPORT</span>=5432<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PGDATABASE</span>=postgres<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">LD_LIBRARY_PATH</span>=/home/postgres/pg12/lib:$LD_LIBRARY_PATH<br><span class=\"hljs-builtin-name\">export</span> <span class=\"hljs-attribute\">PATH</span>=/home/postgres/pg12/bin:$PATH<br></code></pre></td></tr></table></figure><br>重新打开窗口，或者执行 . ~/.bashrc 使之生效</p>\n<h2 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ initdb<br>The files belonging <span class=\"hljs-keyword\">to</span> this database<span class=\"hljs-built_in\"> system </span>will be owned by<span class=\"hljs-built_in\"> user </span><span class=\"hljs-string\">&quot;postgres&quot;</span>.<br>This<span class=\"hljs-built_in\"> user </span>must also own the<span class=\"hljs-built_in\"> server </span>process.<br><br>The database cluster will be initialized with locales<br>  COLLATE:  en_US.UTF-8<br>  CTYPE:    en_US.UTF-8<br>  MESSAGES: en_US.UTF-8<br>  MONETARY: zh_CN.UTF-8<br>  NUMERIC:  zh_CN.UTF-8<br>  TIME:     zh_CN.UTF-8<br>The<span class=\"hljs-built_in\"> default </span>database encoding has accordingly been <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;UTF8&quot;</span>.<br>The<span class=\"hljs-built_in\"> default </span>text search configuration will be <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;english&quot;</span>.<br><br>Data<span class=\"hljs-built_in\"> page </span>checksums are disabled.<br><br>creating directory /home/postgres/pg120_data <span class=\"hljs-built_in\">..</span>. ok<br>creating subdirectories <span class=\"hljs-built_in\">..</span>. ok<br>selecting dynamic shared memory implementation <span class=\"hljs-built_in\">..</span>. posix<br>selecting<span class=\"hljs-built_in\"> default </span>max_connections <span class=\"hljs-built_in\">..</span>. 100<br>selecting<span class=\"hljs-built_in\"> default </span>shared_buffers <span class=\"hljs-built_in\">..</span>. 128MB<br>selecting<span class=\"hljs-built_in\"> default </span>time zone <span class=\"hljs-built_in\">..</span>. Asia/Shanghai<br>creating configuration files <span class=\"hljs-built_in\">..</span>. ok<br>running bootstrap<span class=\"hljs-built_in\"> script </span><span class=\"hljs-built_in\">..</span>. ok<br>performing post-bootstrap initialization <span class=\"hljs-built_in\">..</span>. ok<br>syncing data <span class=\"hljs-keyword\">to</span> disk <span class=\"hljs-built_in\">..</span>. ok<br><br>initdb: warning: enabling <span class=\"hljs-string\">&quot;trust&quot;</span> authentication <span class=\"hljs-keyword\">for</span> local connections<br>You can change this by editing pg_hba.conf <span class=\"hljs-keyword\">or</span> using the option -A, <span class=\"hljs-keyword\">or</span><br>--auth-local <span class=\"hljs-keyword\">and</span> --auth-host, the next time you <span class=\"hljs-builtin-name\">run</span> initdb.<br><br>Success. You can now start the database<span class=\"hljs-built_in\"> server </span>using:<br><br>    pg_ctl -D /home/postgres/pg120_data -l logfile start<br><br></code></pre></td></tr></table></figure>\n<h2 id=\"修改参数-记录数据库日志\"><a href=\"#修改参数-记录数据库日志\" class=\"headerlink\" title=\"修改参数, 记录数据库日志\"></a>修改参数, 记录数据库日志</h2><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">wal_level</span> = replica             <span class=\"hljs-comment\"># minimal, replica, or logical</span><br>                                <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-attr\">listen_addresses</span> = <span class=\"hljs-string\">&#x27;*&#x27;</span>          <span class=\"hljs-comment\"># what IP address(es) to listen on;</span><br>                                        <span class=\"hljs-comment\"># comma-separated list of addresses;</span><br>                                        <span class=\"hljs-comment\"># defaults to &#x27;localhost&#x27;; use &#x27;*&#x27; for all</span><br>                                        <span class=\"hljs-comment\"># (change requires restart)</span><br><span class=\"hljs-attr\">port</span> = <span class=\"hljs-number\">5432</span>                             <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-attr\">logging_collector</span> = <span class=\"hljs-literal\">on</span>          <span class=\"hljs-comment\"># Enable capturing of stderr and csvlog</span><br>                                        <span class=\"hljs-comment\"># into log files. Required to be on for</span><br>                                        <span class=\"hljs-comment\"># csvlogs.</span><br>                                        <span class=\"hljs-comment\"># (change requires restart)</span><br><br><span class=\"hljs-comment\"># These are only used if logging_collector is on:</span><br><span class=\"hljs-attr\">log_directory</span> = <span class=\"hljs-string\">&#x27;log&#x27;</span>                   <span class=\"hljs-comment\"># directory where log files are written,</span><br>                                        <span class=\"hljs-comment\"># can be absolute or relative to PGDATA</span><br><span class=\"hljs-attr\">log_filename</span> = <span class=\"hljs-string\">&#x27;postgresql-%a.log&#x27;</span>      <span class=\"hljs-comment\"># log file name pattern,</span><br>                                        <span class=\"hljs-comment\"># can include strftime() escapes</span><br><span class=\"hljs-comment\">#log_file_mode = 0600                   # creation mode for log files,</span><br>                                        <span class=\"hljs-comment\"># begin with 0 to use octal notation</span><br><span class=\"hljs-attr\">log_truncate_on_rotation</span> = <span class=\"hljs-literal\">on</span>           <span class=\"hljs-comment\"># If on, an existing log file with the</span><br>                                        <span class=\"hljs-comment\"># same name as the new log file will be</span><br>                                        <span class=\"hljs-comment\"># truncated rather than appended to.</span><br>                                        <span class=\"hljs-comment\"># But such truncation only occurs on</span><br>                                        <span class=\"hljs-comment\"># time-driven rotation, not on restarts</span><br>                                        <span class=\"hljs-comment\"># or size-driven rotation.  Default is</span><br>                                        <span class=\"hljs-comment\"># off, meaning append to existing files</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"启动数据库\"><a href=\"#启动数据库\" class=\"headerlink\" title=\"启动数据库\"></a>启动数据库</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ pg_ctl start<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>2020-08-11 14:39:44.004 CST [3608866] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;0.0.0.0&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on<span class=\"hljs-built_in\"> IPv6 address </span><span class=\"hljs-string\">&quot;::&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-11 14:39:44.006 CST [3608866] LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-11 14:39:44.012 CST [3608866] LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>2020-08-11 14:39:44.012 CST [3608866] HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h1 id=\"搭建主节点PostgreSQL实例-1\"><a href=\"#搭建主节点PostgreSQL实例-1\" class=\"headerlink\" title=\"搭建主节点PostgreSQL实例\"></a>搭建主节点PostgreSQL实例</h1><h2 id=\"下载-1\"><a href=\"#下载-1\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p><strong> 步骤同1.1 </strong></p>\n<h2 id=\"解压-amp-amp-编译-amp-amp-安装-1\"><a href=\"#解压-amp-amp-编译-amp-amp-安装-1\" class=\"headerlink\" title=\"解压 &amp;&amp; 编译 &amp;&amp; 安装\"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p><strong> 步骤同1.2 </strong></p>\n<h2 id=\"配置环境变量-1\"><a href=\"#配置环境变量-1\" class=\"headerlink\" title=\"配置环境变量\"></a>配置环境变量</h2><p><strong> 步骤同1.3 </strong></p>\n<h2 id=\"主节点创建流复制用户\"><a href=\"#主节点创建流复制用户\" class=\"headerlink\" title=\"主节点创建流复制用户\"></a>主节点创建流复制用户</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver1:~/postgresql-12.3$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# \\! uuidgen<br>7089bae5-c467-492a-a402-aaba388e6826<br><span class=\"hljs-attribute\">postgres</span>=# create<span class=\"hljs-built_in\"> user </span>replicator Replication password <span class=\"hljs-string\">&#x27;7089bae5-c467-492a-a402-aaba388e6826&#x27;</span>;<br>CREATE ROLE<br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<h2 id=\"增加用户replicator-ACL\"><a href=\"#增加用户replicator-ACL\" class=\"headerlink\" title=\"增加用户replicator ACL\"></a>增加用户replicator ACL</h2><p>主库 vim $PGDATA/pg_hba.conf 新增, x.x.x.x为从节点IP<br><figure class=\"highlight gml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gml\">host    replication     replicator      <span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>.<span class=\"hljs-symbol\">x</span>/<span class=\"hljs-number\">32</span>            trust<br></code></pre></td></tr></table></figure></p>\n<p>使之生效<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres@pgserver1:~$ psql <br>psql (<span class=\"hljs-number\">12.3</span>)<br><span class=\"hljs-keyword\">Type</span> &quot;help&quot; <span class=\"hljs-keyword\">for</span> help.<br><br>postgres=# <span class=\"hljs-keyword\">select</span> pg_reload_conf();<br> pg_reload_conf <br><span class=\"hljs-comment\">----------------</span><br> t<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"使用pg-basebackup生成从库数据目录\"><a href=\"#使用pg-basebackup生成从库数据目录\" class=\"headerlink\" title=\"使用pg_basebackup生成从库数据目录\"></a>使用pg_basebackup生成从库数据目录</h2><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres@pgserver2:~$ pg_basebackup -D /home/postgres/pg120_data -R -X stream -c fast -P -h pgserver1 -p <span class=\"hljs-number\">5432</span> -Ureplicator<br><span class=\"hljs-number\">65984</span>/<span class=\"hljs-number\">65984</span> kB (<span class=\"hljs-number\">100</span>%), <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">tablespace</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"启动从库\"><a href=\"#启动从库\" class=\"headerlink\" title=\"启动从库\"></a>启动从库</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver2:~$ pg_ctl -D /home/postgres/pg120_data start<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>2020-08-14 15:12:31.552 CST [817489] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-14 15:12:31.552 CST [817489] LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;x.x.x.x&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>2020-08-14 15:12:31.555 CST [817489] LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-14 15:12:31.566 CST [817489] LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>2020-08-14 15:12:31.566 CST [817489] HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h2 id=\"主节点确认流复制\"><a href=\"#主节点确认流复制\" class=\"headerlink\" title=\"主节点确认流复制\"></a>主节点确认流复制</h2><figure class=\"highlight gherkin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gherkin\">postgres<span class=\"hljs-meta\">@pgserver1:~$</span> psql <br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> for help.<br>postgres=<span class=\"hljs-comment\"># select * from pg_stat_replication ;</span><br>  pid   |<span class=\"hljs-string\"> usesysid </span>|<span class=\"hljs-string\"> usename  </span>|<span class=\"hljs-string\"> application_name </span>|<span class=\"hljs-string\"> client_addr </span>|<span class=\"hljs-string\"> client_hostname </span>|<span class=\"hljs-string\"> client_port </span>|<span class=\"hljs-string\">         backend_start         </span>|<span class=\"hljs-string\"> backend_xmin </span>|<span class=\"hljs-string\">   state   </span>|<span class=\"hljs-string\"> sent_lsn  </span>|<span class=\"hljs-string\"> write_lsn </span>|<span class=\"hljs-string\"> flush_lsn </span>|<span class=\"hljs-string\"> replay_lsn </span>|<span class=\"hljs-string\">   writ</span><br><span class=\"hljs-string\">e_lag    </span>|<span class=\"hljs-string\">    flush_lag    </span>|<span class=\"hljs-string\">   replay_lag    </span>|<span class=\"hljs-string\"> sync_priority </span>|<span class=\"hljs-string\"> sync_state </span>|<span class=\"hljs-string\">          reply_time           </span><br><span class=\"hljs-string\">--------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-------</span><br><span class=\"hljs-string\">---------+-----------------+-----------------+---------------+------------+-------------------------------</span><br><span class=\"hljs-string\"> 817497 </span>|<span class=\"hljs-string\">       10 </span>|<span class=\"hljs-string\"> replicator </span>|<span class=\"hljs-string\"> walreceiver      </span>|<span class=\"hljs-string\"> x.x.x.x   </span>|<span class=\"hljs-string\">                 </span>|<span class=\"hljs-string\">       50850 </span>|<span class=\"hljs-string\"> 2020-08-14 15:12:31.612261+08 </span>|<span class=\"hljs-string\">              </span>|<span class=\"hljs-string\"> streaming </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60 </span>|<span class=\"hljs-string\"> 0/4000B60  </span>|<span class=\"hljs-string\"> 00:00:</span><br><span class=\"hljs-string\">00.02204 </span>|<span class=\"hljs-string\"> 00:00:00.022362 </span>|<span class=\"hljs-string\"> 00:00:00.022769 </span>|<span class=\"hljs-string\">             0 </span>|<span class=\"hljs-string\"> async      </span>|<span class=\"hljs-string\"> 2020-08-14 15:12:31.636213+08</span><br><span class=\"hljs-string\">(1 row)</span><br><br><span class=\"hljs-string\">postgres=# </span><br></code></pre></td></tr></table></figure>\n<h2 id=\"从节点确认流复制\"><a href=\"#从节点确认流复制\" class=\"headerlink\" title=\"从节点确认流复制\"></a>从节点确认流复制</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@pgserver2:~$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# select * <span class=\"hljs-keyword\">from</span> pg_stat_wal_receiver ;<br>  pid   |  status   | receive_start_lsn | receive_start_tli | received_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |        latest_end_time        | slot_n<br>ame | sender_host | sender_port |                                                                                                             conninfo                                                             <br>                                                <br>--------+-----------+-------------------+-------------------+--------------+--------------+-------------------------------+-------------------------------+----------------+-------------------------------+-------<br>----+-------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------<br> 817496 | streaming | 0/4000000         |                 1 | 0/4000B60    |            1 | 2020-08-14 15:15:01.924922+08 | 2020-08-14 15:15:01.924989+08 | 0/4000B60      | 2020-08-14 15:12:31.613519+08 |       <br>    | x.x.x.x   |        5432 | <span class=\"hljs-attribute\">user</span>=replicator <span class=\"hljs-attribute\">passfile</span>=/home/postgres/.pgpass <span class=\"hljs-attribute\">dbname</span>=replication <span class=\"hljs-attribute\">host</span>=x.x.x.x <span class=\"hljs-attribute\">port</span>=5432 <span class=\"hljs-attribute\">fallback_application_name</span>=walreceiver <span class=\"hljs-attribute\">sslmode</span>=disable <span class=\"hljs-attribute\">sslcompression</span>=0 <span class=\"hljs-attribute\">gssencmode</span>=disab<br>le <span class=\"hljs-attribute\">krbsrvname</span>=replicator <span class=\"hljs-attribute\">target_session_attrs</span>=any<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=# <br></code></pre></td></tr></table></figure>\n<h1 id=\"结束\"><a href=\"#结束\" class=\"headerlink\" title=\"结束\"></a>结束</h1><p>主从搭建so easy.</p>\n<h1 id=\"FAQ\"><a href=\"#FAQ\" class=\"headerlink\" title=\"FAQ\"></a>FAQ</h1><p><a href=\"https://postgres.fun/20131118144309.html\">PostgreSQL：编译安装常见问题</a><br><a href=\"https://postgres.fun/20100731115100.html\">RedHat Enterprise 5上安装 Postgresql</a></p>"},{"title":"PostgreSQL vacuum","date":"2020-08-20T09:30:29.000Z","top":21,"description":null,"password":null,"_content":"vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are briefly mentioned in Section 5.10.\n\nTo remove dead tuples, vacuum processing provides two modes, i.e. Concurrent VACUUM and Full VACUUM. Concurrent VACUUM, often simply called VACUUM, removes dead tuples for each page of the table file, and other transactions can read the table while this process is running. In contrast, Full VACUUM removes dead tuples and defragments live tuples the whole file, and other transactions cannot access tables while Full VACUUM is running.\n\nDespite the fact that vacuum processing is essential for PostgreSQL, improving its functionality has been slow compared to other functions. For example, until version 8.0, this process had to be executed manually (with the psql utility or using the cron daemon). It was automated in 2005 when the autovacuum daemon was implemented.\n\nSince vacuum processing involves scanning whole tables, it is a costly process. In version 8.4 (2009), the Visibility Map (VM) was introduced to improve the efficiency of removing dead tuples. In version 9.6 (2016), the freeze process was improved by enhancing the VM. \n\n<!-- more -->\n\n# Concurrent VACUUM\n```\n(1)  FOR each table\n(2)       Acquire ShareUpdateExclusiveLock lock for the target table\n\n          /* The first block */\n(3)       Scan all pages to get all dead tuples, and freeze old tuples if necessary\n          PostgreSQL scans a target table to build a list of dead tuples and freeze old tuples if possible. The list is stored in maintenance_work_mem in local memory\n(4)       Remove the index tuples that point to the respective dead tuples if exists\n\n          /* The second block */\n(5)       FOR each page of the table\n(6)            Remove the dead tuples, and Reallocate the live tuples in the page\n(7)            Update FSM and VM\n           END FOR\n\n          /* The third block */\n(8)       Clean up indexes\n(9)       Truncate the last page if possible\n(10       Update both the statistics and system catalogs of the target table\n          Release ShareUpdateExclusiveLock lock\n       END FOR\n\n        /* Post-processing */\n(11)  Update statistics and system catalogs\n(12)  Remove both unnecessary files and pages of the clog if possible\n\n```\n\n(1) Get each table from the specified tables.\n(2) Acquire ShareUpdateExclusiveLock lock for the table. This lock allows reading from other transactions.\n(3) Scan all pages to get all dead tuples, and freeze old tuples if necessary.\n(4) Remove the index tuples that point to the respective dead tuples if exists.\n(5) Do the following tasks, step (6) and (7), for each page of the table.\n(6) Remove the dead tuples and Reallocate the live tuples in the page.\n(7) Update both the respective FSM and VM of the target table.\n(8) Clean up the indexes by the index_vacuum_cleanup()@indexam.c function.\n(9) Truncate the last page if the last one does not have any tuple.\n(10) Update both the statistics and the system catalogs related to vacuum processing for the target table.\n(11) Update both the statistics and the system catalogs related to vacuum processing.\n(12) Remove both unnecessary files and pages of the clog if possible.\n\n\n# Full VACUUM\n\n```\n(1)  FOR each table\n(2)       Acquire AccessExclusiveLock lock for the table\n(3)       Create a new table file\n(4)       FOR each live tuple in the old table\n(5)            Copy the live tuple to the new table file\n(6)            Freeze the tuple IF necessary\n            END FOR\n(7)        Remove the old table file\n(8)        Rebuild all indexes\n(9)        Update FSM and VM\n(10)      Update statistics\n            Release AccessExclusiveLock lock\n       END FOR\n(11)  Remove unnecessary clog files and pages if possible\n```\n\n## When should I do VACUUM FULL?\nThere is unfortunately no best practice when you should execute ‘VACUUM FULL’. However, the extension pg_freespacemap may give you good suggestions.\n\nThe following query shows the average freespace ratio of the table you want to know.\n```\ntestdb=# CREATE EXTENSION pg_freespacemap;\nCREATE EXTENSION\n\ntestdb=# SELECT count(*) as \"number of pages\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n            1640 | 99 bytes           |                1.21\n(1 row)\n```\n\nAs the result above, You can find that there are few free spaces.\n\nIf you delete almost tuples and execute VACUUM command, you can find that almost pages are spaces ones.\n```\ntestdb=# DELETE FROM accounts WHERE aid %10 != 0 OR aid < 100;\nDELETE 90009\n\ntestdb=# VACUUM accounts;\nVACUUM\n\ntestdb=# SELECT count(*) as \"number of pages\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n            1640 | 7124 bytes         |               86.97\n(1 row)\n```\n\nThe following query inspects the freespace ratio of each page of the specified table.\n```\ntestdb=# SELECT *, round(100 * avail/8192 ,2) as \"freespace ratio\"\n                FROM pg_freespace('accounts');\n blkno | avail | freespace ratio\n-------+-------+-----------------\n     0 |  7904 |           96.00\n     1 |  7520 |           91.00\n     2 |  7136 |           87.00\n     3 |  7136 |           87.00\n     4 |  7136 |           87.00\n     5 |  7136 |           87.00\n....\n```\nAfter executing VACUUM FULL, you can find that the table file has been compacted. \n```\ntestdb=# VACUUM FULL accounts;\nVACUUM\ntestdb=# SELECT count(*) as \"number of blocks\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n             164 | 0 bytes            |                0.00\n(1 row)\n```\n","source":"_posts/PostgreSQL_vacuum.md","raw":"---\ntitle: PostgreSQL vacuum\ndate: 2020-08-20 17:30:29\ntags: \n- PostgreSQL\n- vacuum\ncategories: \n- PostgreSQL\ntop: 21\ndescription: \npassword: \n\n---\nvacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are briefly mentioned in Section 5.10.\n\nTo remove dead tuples, vacuum processing provides two modes, i.e. Concurrent VACUUM and Full VACUUM. Concurrent VACUUM, often simply called VACUUM, removes dead tuples for each page of the table file, and other transactions can read the table while this process is running. In contrast, Full VACUUM removes dead tuples and defragments live tuples the whole file, and other transactions cannot access tables while Full VACUUM is running.\n\nDespite the fact that vacuum processing is essential for PostgreSQL, improving its functionality has been slow compared to other functions. For example, until version 8.0, this process had to be executed manually (with the psql utility or using the cron daemon). It was automated in 2005 when the autovacuum daemon was implemented.\n\nSince vacuum processing involves scanning whole tables, it is a costly process. In version 8.4 (2009), the Visibility Map (VM) was introduced to improve the efficiency of removing dead tuples. In version 9.6 (2016), the freeze process was improved by enhancing the VM. \n\n<!-- more -->\n\n# Concurrent VACUUM\n```\n(1)  FOR each table\n(2)       Acquire ShareUpdateExclusiveLock lock for the target table\n\n          /* The first block */\n(3)       Scan all pages to get all dead tuples, and freeze old tuples if necessary\n          PostgreSQL scans a target table to build a list of dead tuples and freeze old tuples if possible. The list is stored in maintenance_work_mem in local memory\n(4)       Remove the index tuples that point to the respective dead tuples if exists\n\n          /* The second block */\n(5)       FOR each page of the table\n(6)            Remove the dead tuples, and Reallocate the live tuples in the page\n(7)            Update FSM and VM\n           END FOR\n\n          /* The third block */\n(8)       Clean up indexes\n(9)       Truncate the last page if possible\n(10       Update both the statistics and system catalogs of the target table\n          Release ShareUpdateExclusiveLock lock\n       END FOR\n\n        /* Post-processing */\n(11)  Update statistics and system catalogs\n(12)  Remove both unnecessary files and pages of the clog if possible\n\n```\n\n(1) Get each table from the specified tables.\n(2) Acquire ShareUpdateExclusiveLock lock for the table. This lock allows reading from other transactions.\n(3) Scan all pages to get all dead tuples, and freeze old tuples if necessary.\n(4) Remove the index tuples that point to the respective dead tuples if exists.\n(5) Do the following tasks, step (6) and (7), for each page of the table.\n(6) Remove the dead tuples and Reallocate the live tuples in the page.\n(7) Update both the respective FSM and VM of the target table.\n(8) Clean up the indexes by the index_vacuum_cleanup()@indexam.c function.\n(9) Truncate the last page if the last one does not have any tuple.\n(10) Update both the statistics and the system catalogs related to vacuum processing for the target table.\n(11) Update both the statistics and the system catalogs related to vacuum processing.\n(12) Remove both unnecessary files and pages of the clog if possible.\n\n\n# Full VACUUM\n\n```\n(1)  FOR each table\n(2)       Acquire AccessExclusiveLock lock for the table\n(3)       Create a new table file\n(4)       FOR each live tuple in the old table\n(5)            Copy the live tuple to the new table file\n(6)            Freeze the tuple IF necessary\n            END FOR\n(7)        Remove the old table file\n(8)        Rebuild all indexes\n(9)        Update FSM and VM\n(10)      Update statistics\n            Release AccessExclusiveLock lock\n       END FOR\n(11)  Remove unnecessary clog files and pages if possible\n```\n\n## When should I do VACUUM FULL?\nThere is unfortunately no best practice when you should execute ‘VACUUM FULL’. However, the extension pg_freespacemap may give you good suggestions.\n\nThe following query shows the average freespace ratio of the table you want to know.\n```\ntestdb=# CREATE EXTENSION pg_freespacemap;\nCREATE EXTENSION\n\ntestdb=# SELECT count(*) as \"number of pages\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n            1640 | 99 bytes           |                1.21\n(1 row)\n```\n\nAs the result above, You can find that there are few free spaces.\n\nIf you delete almost tuples and execute VACUUM command, you can find that almost pages are spaces ones.\n```\ntestdb=# DELETE FROM accounts WHERE aid %10 != 0 OR aid < 100;\nDELETE 90009\n\ntestdb=# VACUUM accounts;\nVACUUM\n\ntestdb=# SELECT count(*) as \"number of pages\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n            1640 | 7124 bytes         |               86.97\n(1 row)\n```\n\nThe following query inspects the freespace ratio of each page of the specified table.\n```\ntestdb=# SELECT *, round(100 * avail/8192 ,2) as \"freespace ratio\"\n                FROM pg_freespace('accounts');\n blkno | avail | freespace ratio\n-------+-------+-----------------\n     0 |  7904 |           96.00\n     1 |  7520 |           91.00\n     2 |  7136 |           87.00\n     3 |  7136 |           87.00\n     4 |  7136 |           87.00\n     5 |  7136 |           87.00\n....\n```\nAfter executing VACUUM FULL, you can find that the table file has been compacted. \n```\ntestdb=# VACUUM FULL accounts;\nVACUUM\ntestdb=# SELECT count(*) as \"number of blocks\",\n       pg_size_pretty(cast(avg(avail) as bigint)) as \"Av. freespace size\",\n       round(100 * avg(avail)/8192 ,2) as \"Av. freespace ratio\"\n       FROM pg_freespace('accounts');\n number of pages | Av. freespace size | Av. freespace ratio\n-----------------+--------------------+---------------------\n             164 | 0 bytes            |                0.00\n(1 row)\n```\n","slug":"PostgreSQL_vacuum","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhb000bpieb2f9ya2xw","content":"<p>vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are briefly mentioned in Section 5.10.</p>\n<p>To remove dead tuples, vacuum processing provides two modes, i.e. Concurrent VACUUM and Full VACUUM. Concurrent VACUUM, often simply called VACUUM, removes dead tuples for each page of the table file, and other transactions can read the table while this process is running. In contrast, Full VACUUM removes dead tuples and defragments live tuples the whole file, and other transactions cannot access tables while Full VACUUM is running.</p>\n<p>Despite the fact that vacuum processing is essential for PostgreSQL, improving its functionality has been slow compared to other functions. For example, until version 8.0, this process had to be executed manually (with the psql utility or using the cron daemon). It was automated in 2005 when the autovacuum daemon was implemented.</p>\n<p>Since vacuum processing involves scanning whole tables, it is a costly process. In version 8.4 (2009), the Visibility Map (VM) was introduced to improve the efficiency of removing dead tuples. In version 9.6 (2016), the freeze process was improved by enhancing the VM. </p>\n<a id=\"more\"></a>\n<h1 id=\"Concurrent-VACUUM\"><a href=\"#Concurrent-VACUUM\" class=\"headerlink\" title=\"Concurrent VACUUM\"></a>Concurrent VACUUM</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">(<span class=\"hljs-number\">1</span>)  <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">2</span>)       Acquire ShareUpdateExclusiveLock <span class=\"hljs-keyword\">lock</span> <span class=\"hljs-keyword\">for</span> the target <span class=\"hljs-keyword\">table</span><br><br>          <span class=\"hljs-comment\">/* The first block */</span><br>(<span class=\"hljs-number\">3</span>)       Scan <span class=\"hljs-keyword\">all</span> pages <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> <span class=\"hljs-keyword\">all</span> dead tuples, <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">freeze</span> <span class=\"hljs-built_in\">old</span> tuples <span class=\"hljs-keyword\">if</span> necessary<br>          PostgreSQL scans a target <span class=\"hljs-keyword\">table</span> <span class=\"hljs-keyword\">to</span> build a list <span class=\"hljs-keyword\">of</span> dead tuples <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">freeze</span> <span class=\"hljs-built_in\">old</span> tuples <span class=\"hljs-keyword\">if</span> possible. The list <span class=\"hljs-keyword\">is</span> stored <span class=\"hljs-keyword\">in</span> maintenance_work_mem <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">local</span> memory<br>(<span class=\"hljs-number\">4</span>)       Remove the <span class=\"hljs-keyword\">index</span> tuples that <span class=\"hljs-type\">point</span> <span class=\"hljs-keyword\">to</span> the respective dead tuples <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">exists</span><br><br>          <span class=\"hljs-comment\">/* The second block */</span><br>(<span class=\"hljs-number\">5</span>)       <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> page <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">6</span>)            Remove the dead tuples, <span class=\"hljs-keyword\">and</span> Reallocate the live tuples <span class=\"hljs-keyword\">in</span> the page<br>(<span class=\"hljs-number\">7</span>)            <span class=\"hljs-keyword\">Update</span> FSM <span class=\"hljs-keyword\">and</span> VM<br>           <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br><br>          <span class=\"hljs-comment\">/* The third block */</span><br>(<span class=\"hljs-number\">8</span>)       Clean up indexes<br>(<span class=\"hljs-number\">9</span>)       <span class=\"hljs-keyword\">Truncate</span> the last page <span class=\"hljs-keyword\">if</span> possible<br>(<span class=\"hljs-number\">10</span>       <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">both</span> the <span class=\"hljs-keyword\">statistics</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">system</span> catalogs <span class=\"hljs-keyword\">of</span> the target <span class=\"hljs-keyword\">table</span><br>          <span class=\"hljs-keyword\">Release</span> ShareUpdateExclusiveLock <span class=\"hljs-keyword\">lock</span><br>       <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br><br>        <span class=\"hljs-comment\">/* Post-processing */</span><br>(<span class=\"hljs-number\">11</span>)  <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">statistics</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">system</span> catalogs<br>(<span class=\"hljs-number\">12</span>)  Remove <span class=\"hljs-keyword\">both</span> unnecessary files <span class=\"hljs-keyword\">and</span> pages <span class=\"hljs-keyword\">of</span> the clog <span class=\"hljs-keyword\">if</span> possible<br><br></code></pre></td></tr></table></figure>\n<p>(1) Get each table from the specified tables.<br>(2) Acquire ShareUpdateExclusiveLock lock for the table. This lock allows reading from other transactions.<br>(3) Scan all pages to get all dead tuples, and freeze old tuples if necessary.<br>(4) Remove the index tuples that point to the respective dead tuples if exists.<br>(5) Do the following tasks, step (6) and (7), for each page of the table.<br>(6) Remove the dead tuples and Reallocate the live tuples in the page.<br>(7) Update both the respective FSM and VM of the target table.<br>(8) Clean up the indexes by the index_vacuum_cleanup()@indexam.c function.<br>(9) Truncate the last page if the last one does not have any tuple.<br>(10) Update both the statistics and the system catalogs related to vacuum processing for the target table.<br>(11) Update both the statistics and the system catalogs related to vacuum processing.<br>(12) Remove both unnecessary files and pages of the clog if possible.</p>\n<h1 id=\"Full-VACUUM\"><a href=\"#Full-VACUUM\" class=\"headerlink\" title=\"Full VACUUM\"></a>Full VACUUM</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">(<span class=\"hljs-number\">1</span>)  <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">2</span>)       Acquire AccessExclusiveLock <span class=\"hljs-keyword\">lock</span> <span class=\"hljs-keyword\">for</span> the <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">3</span>)       <span class=\"hljs-keyword\">Create</span> a <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">4</span>)       <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> live tuple <span class=\"hljs-keyword\">in</span> the <span class=\"hljs-built_in\">old</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">5</span>)            <span class=\"hljs-keyword\">Copy</span> the live tuple <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">6</span>)            <span class=\"hljs-keyword\">Freeze</span> the tuple <span class=\"hljs-keyword\">IF</span> necessary<br>            <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br>(<span class=\"hljs-number\">7</span>)        Remove the <span class=\"hljs-built_in\">old</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">8</span>)        Rebuild <span class=\"hljs-keyword\">all</span> indexes<br>(<span class=\"hljs-number\">9</span>)        <span class=\"hljs-keyword\">Update</span> FSM <span class=\"hljs-keyword\">and</span> VM<br>(<span class=\"hljs-number\">10</span>)      <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">statistics</span><br>            <span class=\"hljs-keyword\">Release</span> AccessExclusiveLock <span class=\"hljs-keyword\">lock</span><br>       <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br>(<span class=\"hljs-number\">11</span>)  Remove unnecessary clog files <span class=\"hljs-keyword\">and</span> pages <span class=\"hljs-keyword\">if</span> possible<br></code></pre></td></tr></table></figure>\n<h2 id=\"When-should-I-do-VACUUM-FULL\"><a href=\"#When-should-I-do-VACUUM-FULL\" class=\"headerlink\" title=\"When should I do VACUUM FULL?\"></a>When should I do VACUUM FULL?</h2><p>There is unfortunately no best practice when you should execute ‘VACUUM FULL’. However, the extension pg_freespacemap may give you good suggestions.</p>\n<p>The following query shows the average freespace ratio of the table you want to know.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">EXTENSION</span> pg_freespacemap;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">EXTENSION</span><br><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>            <span class=\"hljs-number\">1640</span> | <span class=\"hljs-number\">99</span> bytes           |                <span class=\"hljs-number\">1.21</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<p>As the result above, You can find that there are few free spaces.</p>\n<p>If you delete almost tuples and execute VACUUM command, you can find that almost pages are spaces ones.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">DELETE</span> <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> aid %<span class=\"hljs-number\">10</span> != <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> aid &lt; <span class=\"hljs-number\">100</span>;<br><span class=\"hljs-keyword\">DELETE</span> <span class=\"hljs-number\">90009</span><br><br>testdb=# <span class=\"hljs-keyword\">VACUUM</span> accounts;<br><span class=\"hljs-keyword\">VACUUM</span><br><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>            <span class=\"hljs-number\">1640</span> | <span class=\"hljs-number\">7124</span> bytes         |               <span class=\"hljs-number\">86.97</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<p>The following query inspects the freespace ratio of each page of the specified table.<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">testdb=# SELECT *, round(<span class=\"hljs-number\">100</span> * avail/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) as <span class=\"hljs-string\">&quot;freespace ratio&quot;</span><br>                FROM pg_freespace(&#x27;accounts&#x27;);<br> blkno | avail | freespace ratio<br>-------+-------+-----------------<br>     <span class=\"hljs-number\">0</span> |  <span class=\"hljs-number\">7904</span> |           <span class=\"hljs-number\">96.00</span><br>     <span class=\"hljs-number\">1</span> |  <span class=\"hljs-number\">7520</span> |           <span class=\"hljs-number\">91.00</span><br>     <span class=\"hljs-number\">2</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">3</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">4</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">5</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>....<br></code></pre></td></tr></table></figure><br>After executing VACUUM FULL, you can find that the table file has been compacted.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">VACUUM</span> <span class=\"hljs-keyword\">FULL</span> accounts;<br><span class=\"hljs-keyword\">VACUUM</span><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of blocks&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>             <span class=\"hljs-number\">164</span> | <span class=\"hljs-number\">0</span> bytes            |                <span class=\"hljs-number\">0.00</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are briefly mentioned in Section 5.10.</p>\n<p>To remove dead tuples, vacuum processing provides two modes, i.e. Concurrent VACUUM and Full VACUUM. Concurrent VACUUM, often simply called VACUUM, removes dead tuples for each page of the table file, and other transactions can read the table while this process is running. In contrast, Full VACUUM removes dead tuples and defragments live tuples the whole file, and other transactions cannot access tables while Full VACUUM is running.</p>\n<p>Despite the fact that vacuum processing is essential for PostgreSQL, improving its functionality has been slow compared to other functions. For example, until version 8.0, this process had to be executed manually (with the psql utility or using the cron daemon). It was automated in 2005 when the autovacuum daemon was implemented.</p>\n<p>Since vacuum processing involves scanning whole tables, it is a costly process. In version 8.4 (2009), the Visibility Map (VM) was introduced to improve the efficiency of removing dead tuples. In version 9.6 (2016), the freeze process was improved by enhancing the VM. </p>","more":"<h1 id=\"Concurrent-VACUUM\"><a href=\"#Concurrent-VACUUM\" class=\"headerlink\" title=\"Concurrent VACUUM\"></a>Concurrent VACUUM</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">(<span class=\"hljs-number\">1</span>)  <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">2</span>)       Acquire ShareUpdateExclusiveLock <span class=\"hljs-keyword\">lock</span> <span class=\"hljs-keyword\">for</span> the target <span class=\"hljs-keyword\">table</span><br><br>          <span class=\"hljs-comment\">/* The first block */</span><br>(<span class=\"hljs-number\">3</span>)       Scan <span class=\"hljs-keyword\">all</span> pages <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> <span class=\"hljs-keyword\">all</span> dead tuples, <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">freeze</span> <span class=\"hljs-built_in\">old</span> tuples <span class=\"hljs-keyword\">if</span> necessary<br>          PostgreSQL scans a target <span class=\"hljs-keyword\">table</span> <span class=\"hljs-keyword\">to</span> build a list <span class=\"hljs-keyword\">of</span> dead tuples <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">freeze</span> <span class=\"hljs-built_in\">old</span> tuples <span class=\"hljs-keyword\">if</span> possible. The list <span class=\"hljs-keyword\">is</span> stored <span class=\"hljs-keyword\">in</span> maintenance_work_mem <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">local</span> memory<br>(<span class=\"hljs-number\">4</span>)       Remove the <span class=\"hljs-keyword\">index</span> tuples that <span class=\"hljs-type\">point</span> <span class=\"hljs-keyword\">to</span> the respective dead tuples <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">exists</span><br><br>          <span class=\"hljs-comment\">/* The second block */</span><br>(<span class=\"hljs-number\">5</span>)       <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> page <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">6</span>)            Remove the dead tuples, <span class=\"hljs-keyword\">and</span> Reallocate the live tuples <span class=\"hljs-keyword\">in</span> the page<br>(<span class=\"hljs-number\">7</span>)            <span class=\"hljs-keyword\">Update</span> FSM <span class=\"hljs-keyword\">and</span> VM<br>           <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br><br>          <span class=\"hljs-comment\">/* The third block */</span><br>(<span class=\"hljs-number\">8</span>)       Clean up indexes<br>(<span class=\"hljs-number\">9</span>)       <span class=\"hljs-keyword\">Truncate</span> the last page <span class=\"hljs-keyword\">if</span> possible<br>(<span class=\"hljs-number\">10</span>       <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">both</span> the <span class=\"hljs-keyword\">statistics</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">system</span> catalogs <span class=\"hljs-keyword\">of</span> the target <span class=\"hljs-keyword\">table</span><br>          <span class=\"hljs-keyword\">Release</span> ShareUpdateExclusiveLock <span class=\"hljs-keyword\">lock</span><br>       <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br><br>        <span class=\"hljs-comment\">/* Post-processing */</span><br>(<span class=\"hljs-number\">11</span>)  <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">statistics</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">system</span> catalogs<br>(<span class=\"hljs-number\">12</span>)  Remove <span class=\"hljs-keyword\">both</span> unnecessary files <span class=\"hljs-keyword\">and</span> pages <span class=\"hljs-keyword\">of</span> the clog <span class=\"hljs-keyword\">if</span> possible<br><br></code></pre></td></tr></table></figure>\n<p>(1) Get each table from the specified tables.<br>(2) Acquire ShareUpdateExclusiveLock lock for the table. This lock allows reading from other transactions.<br>(3) Scan all pages to get all dead tuples, and freeze old tuples if necessary.<br>(4) Remove the index tuples that point to the respective dead tuples if exists.<br>(5) Do the following tasks, step (6) and (7), for each page of the table.<br>(6) Remove the dead tuples and Reallocate the live tuples in the page.<br>(7) Update both the respective FSM and VM of the target table.<br>(8) Clean up the indexes by the index_vacuum_cleanup()@indexam.c function.<br>(9) Truncate the last page if the last one does not have any tuple.<br>(10) Update both the statistics and the system catalogs related to vacuum processing for the target table.<br>(11) Update both the statistics and the system catalogs related to vacuum processing.<br>(12) Remove both unnecessary files and pages of the clog if possible.</p>\n<h1 id=\"Full-VACUUM\"><a href=\"#Full-VACUUM\" class=\"headerlink\" title=\"Full VACUUM\"></a>Full VACUUM</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">(<span class=\"hljs-number\">1</span>)  <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">2</span>)       Acquire AccessExclusiveLock <span class=\"hljs-keyword\">lock</span> <span class=\"hljs-keyword\">for</span> the <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">3</span>)       <span class=\"hljs-keyword\">Create</span> a <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">4</span>)       <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">each</span> live tuple <span class=\"hljs-keyword\">in</span> the <span class=\"hljs-built_in\">old</span> <span class=\"hljs-keyword\">table</span><br>(<span class=\"hljs-number\">5</span>)            <span class=\"hljs-keyword\">Copy</span> the live tuple <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-built_in\">new</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">6</span>)            <span class=\"hljs-keyword\">Freeze</span> the tuple <span class=\"hljs-keyword\">IF</span> necessary<br>            <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br>(<span class=\"hljs-number\">7</span>)        Remove the <span class=\"hljs-built_in\">old</span> <span class=\"hljs-keyword\">table</span> file<br>(<span class=\"hljs-number\">8</span>)        Rebuild <span class=\"hljs-keyword\">all</span> indexes<br>(<span class=\"hljs-number\">9</span>)        <span class=\"hljs-keyword\">Update</span> FSM <span class=\"hljs-keyword\">and</span> VM<br>(<span class=\"hljs-number\">10</span>)      <span class=\"hljs-keyword\">Update</span> <span class=\"hljs-keyword\">statistics</span><br>            <span class=\"hljs-keyword\">Release</span> AccessExclusiveLock <span class=\"hljs-keyword\">lock</span><br>       <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">FOR</span><br>(<span class=\"hljs-number\">11</span>)  Remove unnecessary clog files <span class=\"hljs-keyword\">and</span> pages <span class=\"hljs-keyword\">if</span> possible<br></code></pre></td></tr></table></figure>\n<h2 id=\"When-should-I-do-VACUUM-FULL\"><a href=\"#When-should-I-do-VACUUM-FULL\" class=\"headerlink\" title=\"When should I do VACUUM FULL?\"></a>When should I do VACUUM FULL?</h2><p>There is unfortunately no best practice when you should execute ‘VACUUM FULL’. However, the extension pg_freespacemap may give you good suggestions.</p>\n<p>The following query shows the average freespace ratio of the table you want to know.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">EXTENSION</span> pg_freespacemap;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">EXTENSION</span><br><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>            <span class=\"hljs-number\">1640</span> | <span class=\"hljs-number\">99</span> bytes           |                <span class=\"hljs-number\">1.21</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<p>As the result above, You can find that there are few free spaces.</p>\n<p>If you delete almost tuples and execute VACUUM command, you can find that almost pages are spaces ones.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">DELETE</span> <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> aid %<span class=\"hljs-number\">10</span> != <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">OR</span> aid &lt; <span class=\"hljs-number\">100</span>;<br><span class=\"hljs-keyword\">DELETE</span> <span class=\"hljs-number\">90009</span><br><br>testdb=# <span class=\"hljs-keyword\">VACUUM</span> accounts;<br><span class=\"hljs-keyword\">VACUUM</span><br><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>            <span class=\"hljs-number\">1640</span> | <span class=\"hljs-number\">7124</span> bytes         |               <span class=\"hljs-number\">86.97</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>\n<p>The following query inspects the freespace ratio of each page of the specified table.<br><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">testdb=# SELECT *, round(<span class=\"hljs-number\">100</span> * avail/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) as <span class=\"hljs-string\">&quot;freespace ratio&quot;</span><br>                FROM pg_freespace(&#x27;accounts&#x27;);<br> blkno | avail | freespace ratio<br>-------+-------+-----------------<br>     <span class=\"hljs-number\">0</span> |  <span class=\"hljs-number\">7904</span> |           <span class=\"hljs-number\">96.00</span><br>     <span class=\"hljs-number\">1</span> |  <span class=\"hljs-number\">7520</span> |           <span class=\"hljs-number\">91.00</span><br>     <span class=\"hljs-number\">2</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">3</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">4</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>     <span class=\"hljs-number\">5</span> |  <span class=\"hljs-number\">7136</span> |           <span class=\"hljs-number\">87.00</span><br>....<br></code></pre></td></tr></table></figure><br>After executing VACUUM FULL, you can find that the table file has been compacted.<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">testdb=# <span class=\"hljs-keyword\">VACUUM</span> <span class=\"hljs-keyword\">FULL</span> accounts;<br><span class=\"hljs-keyword\">VACUUM</span><br>testdb=# <span class=\"hljs-keyword\">SELECT</span> count(*) <span class=\"hljs-keyword\">as</span> &quot;number of blocks&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-type\">bigint</span>)) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class=\"hljs-number\">100</span> * avg(avail)/<span class=\"hljs-number\">8192</span> ,<span class=\"hljs-number\">2</span>) <span class=\"hljs-keyword\">as</span> &quot;Av. freespace ratio&quot;<br>       <span class=\"hljs-keyword\">FROM</span> pg_freespace(<span class=\"hljs-string\">&#x27;accounts&#x27;</span>);<br> number <span class=\"hljs-keyword\">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class=\"hljs-comment\">-----------------+--------------------+---------------------</span><br>             <span class=\"hljs-number\">164</span> | <span class=\"hljs-number\">0</span> bytes            |                <span class=\"hljs-number\">0.00</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br></code></pre></td></tr></table></figure></p>"},{"title":"PostgreSQL开发指南","date":"2021-02-25T09:16:23.000Z","top":null,"description":null,"password":"jintao1023..","_content":"\n# 命名规范\n\n```\n1. DB object: database, schema, table, column, view, index, sequence, function, trigger等名称\n(1) 建议使用小写字母、数字、下划线的组合\n(2) 建议不使用双引号即\"包围，除非必须包含大写字母或空格等特殊字符\n(3) [强制]长度不能超过63个字符\n(4) 不建议以pg开头(避免与系统DB object混淆), 不建议以数字开头\n(5) 禁止使用 SQL 关键字中保留类型的(reserved)，例如 user, type, order 等, 非保留类型的(unreserved)也不建议使用.\n--判断是否是关键字的方法:\n\nselect * from pg_get_keywords() where word = 'order';;\n word  | catcode | catdesc\n-------+---------+----------\n order | R       | reserved\n(1 row)\n\n-- 查看已经存在的table中的关键字\nselect\n    table_schema, table_name, column_name, b.word, b.catdesc\nfrom\n     information_schema.columns a\njoin (select word, catcode, catdesc from pg_get_keywords()) b\n  on  a.column_name = b.word\nwhere table_schema = 'public'\n  and table_name =  'student';\n\n table_schema |     table_name     | column_name | word |  catdesc\n--------------+--------------------+-------------+------+------------\n public       | student            | name        | name | unreserved\n\n(1 row)\n\n\n2. table能包含的column数目,根据字段类型的不同，数目在 250 到 1600 之间\n\n3. 临时或备份的DB object:table,view 等,建议加上日期, 如dba_ops.b2c_product_summay_2014_07_12 (其中dba_ops 为DBA专用schema)\n\n4. index命名规则为: 表名_列名_idx, 如student_name_idx, 建议不显式给出index name, 使用DBMS默认给出的index name, 如create index ON student (name),则默认给出的index名称为student_name_idx\n\n5. 建议table中的创建和更新时间字段统一命名为create_time, update_time, 不建议使用created_at, gmt_created, operate_at, optime, operate_time,  gmt_modified,  updated_at 等\n```\n\n# Column设计\n\n```\n1. [强制]建议能用数值类型的，就不用字符类型\n\n2. [强制]建议能用varchar(N) 就不用char(N),以利于节省存储空间\n\n3. 建议能用varchar(N) 就不用text,varchar\n\n4. 建议使用default NULL,而不用default '',以节省存储空间, 原理请见: 老何的1001夜\n\n5. 建议使用ip4,ip4r,ip6,ip6r,ipaddress,iprange 来存储IP,IP范围；使用macaddr来存储MAC (Media Access Control) address\n\n6. [强制]建议使用timestamp with time zone(timestamptz),而不用timestamp without time zone,避免时间函数在对于不同时区的时间点返回值不同,也为业务国际化扫清障碍\n\n7. [强制]建议使用NUMERIC(precision, scale)来存储货币金额和其它要求精确计算的数值, 而不建议使用real, double precision\n\n8. 建议使用hstore 来存储非结构化,key-value 键值型,对数不定的数据\n\n9. 建议使用ltree 来存储 Top.中国.北京.海淀区.苏州街 这种 树状层次结构 数据\n\n10. 建议使用jsonb(比json更有优势)来存储JSON (JavaScript Object Notation) data\n\n11. 建议使用Geometric Types 结合PostGIS来实现地理信息数据存储及操作\n\n12. 建议使用如下range类型代替字符串或多列来实现范围的存储\nint4range — Range of integer\n\nint8range — Range of bigint\n\nnumrange — Range of numeric\n\ntsrange — Range of timestamp without time zone\n\ntstzrange — Range of timestamp with time zone\n\ndaterange — Range of date\n\n13. 建议在给 date, timestamp with time zone (timestamptz)字段设置default值时,使用now(), 而不使用timeofday(), 避免因时区不通导致的字段值错误\nselect now()::timestamp, now()::timestamptz, timeofday()::timestamp, timeofday()::timestamptz;\n            now             |              now              |         timeofday          |           timeofday\n----------------------------+-------------------------------+----------------------------+-------------------------------\n 2017-09-16 18:01:50.179549 | 2017-09-16 18:01:50.179549+08 | 2017-09-16 18:01:50.179718 | 2017-09-17 08:01:50.179733+08\n(1 row)\n\n```\n\n# Constraints 设计\n\n```\n1. [强制]建议每个table都有主键;\n\n2. [强制]建议不要用有业务含义的名称作为主键,比如身份证或者国家名称,尽管其是unique的\n\n3. 建议主键的一步到位的写法:id serial primary key 或id bigserial primary key\n\n4. 建议内容系统中size较大的table主键的等效写法如下,便于后续维护\ncreate table test(id serial not null );\n\ncreate unique index CONCURRENTLY ON test (id);\n```\n\n# Index 设计\n\n```\n1. PostgreSQL 提供的index类型: B-tree, Hash, GiST (Generalized Search Tree), SP-GiST (space-partitioned GiST), GIN (Generalized Inverted Index), BRIN (Block Range Index), PostgreSQL 10 之前版本不建议使用Hash Index\n\n2. [强制]建议create 或 drop index 时,加 CONCURRENTLY参数,这是个好习惯，达到与写入数据并发的效果\n\n3. 建议对于频繁update, delete的包含于index 定义中的column的table, 用create index CONCURRENTLY , drop index CONCURRENTLY 的方式进行维护其对应index\n\n4. 建议用unique index 代替unique constraints,便于后续维护\n\n5. 建议对where 中带多个字段and条件的高频 query，参考数据分布情况，建多个字段的联合index\n\n6. 建议对固定条件的（一般有特定业务含义）且选择比好（数据占比低）的query，建带where的Partial Indexes\nselect * from test where status=1 and col=?; -- 其中status=1为固定的条件\ncreate index on test (col) where status=1;\n\n7. 建议对经常使用表达式作为查询条件的query，可以使用表达式或函数索引加速query\nselect * from test where exp(xxx);\ncreate index on test ( exp(xxx) );\n\n8. 建议不要建过多index，一般不要超过6个，核心table（产品，订单）可适当增加index个数\n```\n\n# 关于NULL\n\n```\n1. NULL 的判断：IS NULL ，IS NOT NULL\n\n2. 注意boolean 类型取值 true，false， NULL\n\n3. 小心NOT IN 集合中带有NULL元素\nmydb=# SELECT * FROM (VALUES(1),(2)) v(a) ;\n a\n---\n 1\n 2\n(2 rows)\n\n\nmydb=# select 1 NOT IN (1, NULL);\n ?column?\n----------\n f\n(1 row)\n\n\nmydb=# select 2 NOT IN (1, NULL);\n ?column?\n----------\n\n(1 row)\n\nmydb=# SELECT * FROM (VALUES(1),(2)) v(a) WHERE a NOT IN (1, NULL);\n a\n---\n(0 rows)\n\n--可见，出现这种情况的根本原因在于SELECT只返回WHERE中判断条件结果为true的数据\n\n4. 建议对字符串型NULL值处理后，进行 || 操作\nmydb=# select NULL||'PostgreSQL';\n ?column?\n----------\n\n(1 row)\n\nmydb=# select coalesce(NULL,'')||'PostgreSQL';\n  ?column?\n------------\n PostgreSQL\n(1 row)\n\n5. 建议对hstore 类型进行处理后，进行 || 操作，避免被NULL吃掉\nmydb=# select  NULL::hstore || ('key=>value') ;\n ?column?\n----------\n\n(1 row)\n\nmydb=# select  coalesce(NULL::hstore, hstore(array[]::varchar[])) || ('key=>value') ;\n    ?column?\n----------------\n \"key\"=>\"value\"\n(1 row)\n\nmydb=# select  coalesce(NULL::hstore,''::hstore) || ('key=>value') ;\n    ?column?\n----------------\n \"key\"=>\"value\"\n(1 row)\n\n6. 建议使用count(1) 或count(*) 来统计行数，而不建议使用count(col) 来统计行数，因为NULL值不会计入\n\n注意: count(多列列名)时，多列列名必须使用括号，例如count( (col1,col2,col3) ); 注意多列的count，即使所有列都为NULL，该行也被计数，所以效果与count(*) 一致\n\n7. count(distinct col) 计算某列的非NULL不重复数量，NULL不被计数\n\n注意: count(distinct (col1,col2,...) ) 计算多列的唯一值时，NULL会被计数，同时NULL与NULL会被认为是相同的\n\n8. NULL 的count与sum\nselect count(1), count(a), sum(a)  from (SELECT * FROM (VALUES (NULL), (2) ) v(a)) as foo where a is NULL;\n count | count | sum\n-------+-------+-----\n     1 |     0 |\n(1 row)\n\n9. 判断两个值是否相同（将NULL视为相同的值）\nselect null is distinct from null;\n ?column?\n----------\n f\n(1 row)\n\n select null is distinct from 1;\n ?column?\n----------\n t\n(1 row)\n\nselect null is not  distinct from null;\n ?column?\n----------\n t\n(1 row)\n\nmydb=#  select null is not distinct from 1;\n ?column?\n----------\n f\n(1 row)\n```\n\n# 开发相关规范\n\n```\n1. [强制]建议对DB object 尤其是COLUMN 加COMMENT，便于后续新人了解业务及维护\n\n2. [强制]建议非必须时避免select *，只取所需字段，以减少包括不限于网络带宽消耗，避免表结构变更对程序的影响（比如某些prepare query）\n\n3. 建议update 时尽量做 <> 判断,比如update table_a set column_b = c where column_b <> c\n\n4. [强制]建议将单个事务的多条SQL操作,分解、拆分，或者不放在一个事务里，让每个事务的粒度尽可能小，尽量lock少的资源，避免lock 、dead lock的产生\n\n5. 建议 大批量的数据入库时， 使用copy ，不建议使用insert，以提高写入速度\n\n6. 建议对报表类的或生成基础数据的查询，使用物化视图(MATERIALIZED VIEW)定期固化数据快照， 避免对多表（尤其读写频繁的表）重复跑相同的查询，且物化视图支持 REFRESH MATERIALIZED VIEW CONCURRENTLY, 支持并发更新\n\n7. 建议复杂的统计查询可以尝试窗口函数 Window Functions\n\n8. state 为 idle in transaction 的连接，如果出现在Master, 会无谓的lock住相应的资源, 可导致后续产生lock,甚至deadlock; 出现在Slave, 可导致卡住主从同步\n常见的触发方式有：\na. 应用程序类：比如python，psycopg2 模块中postgresql的连接参数autocommit默认为false, 经常导致出现这种情况,特别是在slave 这种读取数据时，完全没必要开transaction, 建议将该参数设置为true\n\nb. 其他用psql 或 pgadmin等工具连接DB, 在不是必须的情况下，显式的开启了begin;  xxx; 然后不执行commit;\n\nc. 本机使用图形化连接工具,误碰了某个默认开事务的按钮, 导致即使select也开了不必要的事务,执行后,在DB端产生的idle in transaction的连接,导致报警.\n\n9. 建议在 MyBatis框架中使用SQL语句时，不要写 useGeneratedKeys=\"true\"， 或直接设置 useGeneratedKeys=\"false\"，避免returning *的产生，从而浪费带宽，如果需要返回某个字段，比如id，可以按照如下设置\n在StatementHandler为PreparedStatementHandle时，\n\nuseGeneratedKeys=\"true\"; keyColumn=\"id\"; keyProperty=\"id\"\n```\n\n# 管理相关规范\n\n```\n1. [强制]建议清空表时，使用truncate，不建议使用delete\n\n2. [强制]建议向大size的table中add column时，PostgreSQL 11之前，需将 alter table t add column col datatype not null default xxx；分解为如下，避免填充default值导致的过长时间锁表（ddl需加高粒度的lock）\nalter table t add column col datatype ；\n\nalter table t alter column col set default xxx；\n\nupdate t set column = default where id = 1;\n\n......\n......\n......\n\nupdate t set column = default where id = N;\n\n------此处,可以用先进的\\watch来刷\n------即 update t  set column= DEFAULT where id in ( select id from t where column is null limit 1000 ) ; \\watch 3\n\nalter table t alter column col set not null；\n\n3. [强制]建议执行DDL,比如CRAETE、DROP、ALTER 等, 尤其多条， 不要显式的开transaction, 因为加lock的mode非常高,极易产生deadlock\n\n4. 建议对频繁更新的表，建表时指定fillfactor，一般建议值为85\ncreate table test(id int ) with(fillfactor=85);\n\n5. 建议在需要使用explain analyze 查看实际真正执行计划与时间时，如果是写入 query，强烈建议先开启事务， 然后回滚\n```\n\n# 需求申请规范\n\n```\n1. 建议发给PostgrSQL DBA review 及 执行的SQL，无论是使用pgadmin这种图形化工具，还是pg_dump 这种命令行工具生成的SQL，都去掉注释(--之后的部分)，双引号\"及alter owner等冗余或不应该带到线上生产的dev/beta DB中的信息\n\n2. 不建议发到pg-request的同一个需求，大家（不仅仅PostgreSQL DBA）在review给出建议后，没有反馈的悄无声息的另起新邮件，避免没有close的需求产生，进而给DBA造成困扰\n\n3. 建议DB Beta/dev 环境同步线上生产(production)或其他环境(beta/dev)数据的pg-request规范\nDB beta的数据的同步及更改,需要由QA同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作\nDB dev的数据的同步及更改,需要由dev同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作\n\n邮件中需要写清楚源DB及目标DB的 hostname  port  dbname  schemaname 及需要特殊处理的数据\n\n4. 建议发给PostgreSQL DBA 发布的DDL，附带常用DML: SELECT, INSERT ,DELETE, UPDATE，便于DBA给出create index CONCURRENTLY 等其他优化建议\n\n```\n\n# 参考\n[阿里云PostgreSQL 数据库开发规范](https://developer.aliyun.com/article/60899)\n","source":"_posts/PostgreSQL开发指南.md","raw":"---\ntitle: PostgreSQL开发指南 \ndate: 2021-02-25 17:16:23\ntags: \n- PostgreSQL\n- 开发指南\ncategories: \n- PostgreSQL\ntop: \ndescription: \npassword: jintao1023..\n\n---\n\n# 命名规范\n\n```\n1. DB object: database, schema, table, column, view, index, sequence, function, trigger等名称\n(1) 建议使用小写字母、数字、下划线的组合\n(2) 建议不使用双引号即\"包围，除非必须包含大写字母或空格等特殊字符\n(3) [强制]长度不能超过63个字符\n(4) 不建议以pg开头(避免与系统DB object混淆), 不建议以数字开头\n(5) 禁止使用 SQL 关键字中保留类型的(reserved)，例如 user, type, order 等, 非保留类型的(unreserved)也不建议使用.\n--判断是否是关键字的方法:\n\nselect * from pg_get_keywords() where word = 'order';;\n word  | catcode | catdesc\n-------+---------+----------\n order | R       | reserved\n(1 row)\n\n-- 查看已经存在的table中的关键字\nselect\n    table_schema, table_name, column_name, b.word, b.catdesc\nfrom\n     information_schema.columns a\njoin (select word, catcode, catdesc from pg_get_keywords()) b\n  on  a.column_name = b.word\nwhere table_schema = 'public'\n  and table_name =  'student';\n\n table_schema |     table_name     | column_name | word |  catdesc\n--------------+--------------------+-------------+------+------------\n public       | student            | name        | name | unreserved\n\n(1 row)\n\n\n2. table能包含的column数目,根据字段类型的不同，数目在 250 到 1600 之间\n\n3. 临时或备份的DB object:table,view 等,建议加上日期, 如dba_ops.b2c_product_summay_2014_07_12 (其中dba_ops 为DBA专用schema)\n\n4. index命名规则为: 表名_列名_idx, 如student_name_idx, 建议不显式给出index name, 使用DBMS默认给出的index name, 如create index ON student (name),则默认给出的index名称为student_name_idx\n\n5. 建议table中的创建和更新时间字段统一命名为create_time, update_time, 不建议使用created_at, gmt_created, operate_at, optime, operate_time,  gmt_modified,  updated_at 等\n```\n\n# Column设计\n\n```\n1. [强制]建议能用数值类型的，就不用字符类型\n\n2. [强制]建议能用varchar(N) 就不用char(N),以利于节省存储空间\n\n3. 建议能用varchar(N) 就不用text,varchar\n\n4. 建议使用default NULL,而不用default '',以节省存储空间, 原理请见: 老何的1001夜\n\n5. 建议使用ip4,ip4r,ip6,ip6r,ipaddress,iprange 来存储IP,IP范围；使用macaddr来存储MAC (Media Access Control) address\n\n6. [强制]建议使用timestamp with time zone(timestamptz),而不用timestamp without time zone,避免时间函数在对于不同时区的时间点返回值不同,也为业务国际化扫清障碍\n\n7. [强制]建议使用NUMERIC(precision, scale)来存储货币金额和其它要求精确计算的数值, 而不建议使用real, double precision\n\n8. 建议使用hstore 来存储非结构化,key-value 键值型,对数不定的数据\n\n9. 建议使用ltree 来存储 Top.中国.北京.海淀区.苏州街 这种 树状层次结构 数据\n\n10. 建议使用jsonb(比json更有优势)来存储JSON (JavaScript Object Notation) data\n\n11. 建议使用Geometric Types 结合PostGIS来实现地理信息数据存储及操作\n\n12. 建议使用如下range类型代替字符串或多列来实现范围的存储\nint4range — Range of integer\n\nint8range — Range of bigint\n\nnumrange — Range of numeric\n\ntsrange — Range of timestamp without time zone\n\ntstzrange — Range of timestamp with time zone\n\ndaterange — Range of date\n\n13. 建议在给 date, timestamp with time zone (timestamptz)字段设置default值时,使用now(), 而不使用timeofday(), 避免因时区不通导致的字段值错误\nselect now()::timestamp, now()::timestamptz, timeofday()::timestamp, timeofday()::timestamptz;\n            now             |              now              |         timeofday          |           timeofday\n----------------------------+-------------------------------+----------------------------+-------------------------------\n 2017-09-16 18:01:50.179549 | 2017-09-16 18:01:50.179549+08 | 2017-09-16 18:01:50.179718 | 2017-09-17 08:01:50.179733+08\n(1 row)\n\n```\n\n# Constraints 设计\n\n```\n1. [强制]建议每个table都有主键;\n\n2. [强制]建议不要用有业务含义的名称作为主键,比如身份证或者国家名称,尽管其是unique的\n\n3. 建议主键的一步到位的写法:id serial primary key 或id bigserial primary key\n\n4. 建议内容系统中size较大的table主键的等效写法如下,便于后续维护\ncreate table test(id serial not null );\n\ncreate unique index CONCURRENTLY ON test (id);\n```\n\n# Index 设计\n\n```\n1. PostgreSQL 提供的index类型: B-tree, Hash, GiST (Generalized Search Tree), SP-GiST (space-partitioned GiST), GIN (Generalized Inverted Index), BRIN (Block Range Index), PostgreSQL 10 之前版本不建议使用Hash Index\n\n2. [强制]建议create 或 drop index 时,加 CONCURRENTLY参数,这是个好习惯，达到与写入数据并发的效果\n\n3. 建议对于频繁update, delete的包含于index 定义中的column的table, 用create index CONCURRENTLY , drop index CONCURRENTLY 的方式进行维护其对应index\n\n4. 建议用unique index 代替unique constraints,便于后续维护\n\n5. 建议对where 中带多个字段and条件的高频 query，参考数据分布情况，建多个字段的联合index\n\n6. 建议对固定条件的（一般有特定业务含义）且选择比好（数据占比低）的query，建带where的Partial Indexes\nselect * from test where status=1 and col=?; -- 其中status=1为固定的条件\ncreate index on test (col) where status=1;\n\n7. 建议对经常使用表达式作为查询条件的query，可以使用表达式或函数索引加速query\nselect * from test where exp(xxx);\ncreate index on test ( exp(xxx) );\n\n8. 建议不要建过多index，一般不要超过6个，核心table（产品，订单）可适当增加index个数\n```\n\n# 关于NULL\n\n```\n1. NULL 的判断：IS NULL ，IS NOT NULL\n\n2. 注意boolean 类型取值 true，false， NULL\n\n3. 小心NOT IN 集合中带有NULL元素\nmydb=# SELECT * FROM (VALUES(1),(2)) v(a) ;\n a\n---\n 1\n 2\n(2 rows)\n\n\nmydb=# select 1 NOT IN (1, NULL);\n ?column?\n----------\n f\n(1 row)\n\n\nmydb=# select 2 NOT IN (1, NULL);\n ?column?\n----------\n\n(1 row)\n\nmydb=# SELECT * FROM (VALUES(1),(2)) v(a) WHERE a NOT IN (1, NULL);\n a\n---\n(0 rows)\n\n--可见，出现这种情况的根本原因在于SELECT只返回WHERE中判断条件结果为true的数据\n\n4. 建议对字符串型NULL值处理后，进行 || 操作\nmydb=# select NULL||'PostgreSQL';\n ?column?\n----------\n\n(1 row)\n\nmydb=# select coalesce(NULL,'')||'PostgreSQL';\n  ?column?\n------------\n PostgreSQL\n(1 row)\n\n5. 建议对hstore 类型进行处理后，进行 || 操作，避免被NULL吃掉\nmydb=# select  NULL::hstore || ('key=>value') ;\n ?column?\n----------\n\n(1 row)\n\nmydb=# select  coalesce(NULL::hstore, hstore(array[]::varchar[])) || ('key=>value') ;\n    ?column?\n----------------\n \"key\"=>\"value\"\n(1 row)\n\nmydb=# select  coalesce(NULL::hstore,''::hstore) || ('key=>value') ;\n    ?column?\n----------------\n \"key\"=>\"value\"\n(1 row)\n\n6. 建议使用count(1) 或count(*) 来统计行数，而不建议使用count(col) 来统计行数，因为NULL值不会计入\n\n注意: count(多列列名)时，多列列名必须使用括号，例如count( (col1,col2,col3) ); 注意多列的count，即使所有列都为NULL，该行也被计数，所以效果与count(*) 一致\n\n7. count(distinct col) 计算某列的非NULL不重复数量，NULL不被计数\n\n注意: count(distinct (col1,col2,...) ) 计算多列的唯一值时，NULL会被计数，同时NULL与NULL会被认为是相同的\n\n8. NULL 的count与sum\nselect count(1), count(a), sum(a)  from (SELECT * FROM (VALUES (NULL), (2) ) v(a)) as foo where a is NULL;\n count | count | sum\n-------+-------+-----\n     1 |     0 |\n(1 row)\n\n9. 判断两个值是否相同（将NULL视为相同的值）\nselect null is distinct from null;\n ?column?\n----------\n f\n(1 row)\n\n select null is distinct from 1;\n ?column?\n----------\n t\n(1 row)\n\nselect null is not  distinct from null;\n ?column?\n----------\n t\n(1 row)\n\nmydb=#  select null is not distinct from 1;\n ?column?\n----------\n f\n(1 row)\n```\n\n# 开发相关规范\n\n```\n1. [强制]建议对DB object 尤其是COLUMN 加COMMENT，便于后续新人了解业务及维护\n\n2. [强制]建议非必须时避免select *，只取所需字段，以减少包括不限于网络带宽消耗，避免表结构变更对程序的影响（比如某些prepare query）\n\n3. 建议update 时尽量做 <> 判断,比如update table_a set column_b = c where column_b <> c\n\n4. [强制]建议将单个事务的多条SQL操作,分解、拆分，或者不放在一个事务里，让每个事务的粒度尽可能小，尽量lock少的资源，避免lock 、dead lock的产生\n\n5. 建议 大批量的数据入库时， 使用copy ，不建议使用insert，以提高写入速度\n\n6. 建议对报表类的或生成基础数据的查询，使用物化视图(MATERIALIZED VIEW)定期固化数据快照， 避免对多表（尤其读写频繁的表）重复跑相同的查询，且物化视图支持 REFRESH MATERIALIZED VIEW CONCURRENTLY, 支持并发更新\n\n7. 建议复杂的统计查询可以尝试窗口函数 Window Functions\n\n8. state 为 idle in transaction 的连接，如果出现在Master, 会无谓的lock住相应的资源, 可导致后续产生lock,甚至deadlock; 出现在Slave, 可导致卡住主从同步\n常见的触发方式有：\na. 应用程序类：比如python，psycopg2 模块中postgresql的连接参数autocommit默认为false, 经常导致出现这种情况,特别是在slave 这种读取数据时，完全没必要开transaction, 建议将该参数设置为true\n\nb. 其他用psql 或 pgadmin等工具连接DB, 在不是必须的情况下，显式的开启了begin;  xxx; 然后不执行commit;\n\nc. 本机使用图形化连接工具,误碰了某个默认开事务的按钮, 导致即使select也开了不必要的事务,执行后,在DB端产生的idle in transaction的连接,导致报警.\n\n9. 建议在 MyBatis框架中使用SQL语句时，不要写 useGeneratedKeys=\"true\"， 或直接设置 useGeneratedKeys=\"false\"，避免returning *的产生，从而浪费带宽，如果需要返回某个字段，比如id，可以按照如下设置\n在StatementHandler为PreparedStatementHandle时，\n\nuseGeneratedKeys=\"true\"; keyColumn=\"id\"; keyProperty=\"id\"\n```\n\n# 管理相关规范\n\n```\n1. [强制]建议清空表时，使用truncate，不建议使用delete\n\n2. [强制]建议向大size的table中add column时，PostgreSQL 11之前，需将 alter table t add column col datatype not null default xxx；分解为如下，避免填充default值导致的过长时间锁表（ddl需加高粒度的lock）\nalter table t add column col datatype ；\n\nalter table t alter column col set default xxx；\n\nupdate t set column = default where id = 1;\n\n......\n......\n......\n\nupdate t set column = default where id = N;\n\n------此处,可以用先进的\\watch来刷\n------即 update t  set column= DEFAULT where id in ( select id from t where column is null limit 1000 ) ; \\watch 3\n\nalter table t alter column col set not null；\n\n3. [强制]建议执行DDL,比如CRAETE、DROP、ALTER 等, 尤其多条， 不要显式的开transaction, 因为加lock的mode非常高,极易产生deadlock\n\n4. 建议对频繁更新的表，建表时指定fillfactor，一般建议值为85\ncreate table test(id int ) with(fillfactor=85);\n\n5. 建议在需要使用explain analyze 查看实际真正执行计划与时间时，如果是写入 query，强烈建议先开启事务， 然后回滚\n```\n\n# 需求申请规范\n\n```\n1. 建议发给PostgrSQL DBA review 及 执行的SQL，无论是使用pgadmin这种图形化工具，还是pg_dump 这种命令行工具生成的SQL，都去掉注释(--之后的部分)，双引号\"及alter owner等冗余或不应该带到线上生产的dev/beta DB中的信息\n\n2. 不建议发到pg-request的同一个需求，大家（不仅仅PostgreSQL DBA）在review给出建议后，没有反馈的悄无声息的另起新邮件，避免没有close的需求产生，进而给DBA造成困扰\n\n3. 建议DB Beta/dev 环境同步线上生产(production)或其他环境(beta/dev)数据的pg-request规范\nDB beta的数据的同步及更改,需要由QA同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作\nDB dev的数据的同步及更改,需要由dev同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作\n\n邮件中需要写清楚源DB及目标DB的 hostname  port  dbname  schemaname 及需要特殊处理的数据\n\n4. 建议发给PostgreSQL DBA 发布的DDL，附带常用DML: SELECT, INSERT ,DELETE, UPDATE，便于DBA给出create index CONCURRENTLY 等其他优化建议\n\n```\n\n# 参考\n[阿里云PostgreSQL 数据库开发规范](https://developer.aliyun.com/article/60899)\n","slug":"PostgreSQL开发指南","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhe000gpieb18fpcc1l","content":"<h1 id=\"命名规范\"><a href=\"#命名规范\" class=\"headerlink\" title=\"命名规范\"></a>命名规范</h1><figure class=\"highlight oxygene\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs oxygene\"><span class=\"hljs-number\">1</span>. DB object: database, schema, table, column, view, <span class=\"hljs-keyword\">index</span>, <span class=\"hljs-keyword\">sequence</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>, <span class=\"hljs-title\">trigger</span>等名称</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(1)</span> 建议使用小写字母、数字、下划线的组合</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(2)</span> 建议不使用双引号即&quot;包围，除非必须包含大写字母或空格等特殊字符</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(3)</span> [强制]长度不能超过63个字符</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(4)</span> 不建议以<span class=\"hljs-title\">pg</span>开头<span class=\"hljs-params\">(避免与系统DB object混淆)</span>, 不建议以数字开头</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(5)</span> 禁止使用 <span class=\"hljs-title\">SQL</span> 关键字中保留类型的<span class=\"hljs-params\">(reserved)</span>，例如 <span class=\"hljs-title\">user</span>, <span class=\"hljs-title\">type</span>, <span class=\"hljs-title\">order</span> 等, 非保留类型的<span class=\"hljs-params\">(unreserved)</span>也不建议使用.</span><br><span class=\"hljs-function\">--判断是否是关键字的方法:</span><br><br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_get_keywords() <span class=\"hljs-keyword\">where</span> word = <span class=\"hljs-string\">&#x27;order&#x27;</span>;;<br> word  | catcode | catdesc<br>-------+---------+----------<br> <span class=\"hljs-keyword\">order</span> | R       | reserved<br>(<span class=\"hljs-number\">1</span> row)<br><br>-- 查看已经存在的table中的关键字<br><span class=\"hljs-keyword\">select</span><br>    table_schema, table_name, column_name, b.word, b.catdesc<br><span class=\"hljs-keyword\">from</span><br>     information_schema.columns a<br><span class=\"hljs-keyword\">join</span> (<span class=\"hljs-keyword\">select</span> word, catcode, catdesc <span class=\"hljs-keyword\">from</span> pg_get_keywords()) b<br>  <span class=\"hljs-keyword\">on</span>  a.column_name = b.word<br><span class=\"hljs-keyword\">where</span> table_schema = <span class=\"hljs-string\">&#x27;public&#x27;</span><br>  <span class=\"hljs-keyword\">and</span> table_name =  <span class=\"hljs-string\">&#x27;student&#x27;</span>;<br><br> table_schema |     table_name     | column_name | word |  catdesc<br>--------------+--------------------+-------------+------+------------<br> <span class=\"hljs-keyword\">public</span>       | student            | name        | name | unreserved<br><br>(<span class=\"hljs-number\">1</span> row)<br><br><br><span class=\"hljs-number\">2</span>. table能包含的column数目,根据字段类型的不同，数目在 <span class=\"hljs-number\">250</span> 到 <span class=\"hljs-number\">1600</span> 之间<br><br><span class=\"hljs-number\">3</span>. 临时或备份的DB object:table,view 等,建议加上日期, 如dba_ops.b2c_product_summay_2014_07_12 (其中dba_ops 为DBA专用schema)<br><br><span class=\"hljs-number\">4</span>. <span class=\"hljs-keyword\">index</span>命名规则为: 表名_列名_idx, 如student_name_idx, 建议不显式给出<span class=\"hljs-keyword\">index</span> name, 使用DBMS默认给出的<span class=\"hljs-keyword\">index</span> name, 如<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">ON</span> student (name),则默认给出的<span class=\"hljs-keyword\">index</span>名称为student_name_idx<br><br><span class=\"hljs-number\">5</span>. 建议table中的创建和更新时间字段统一命名为create_time, update_time, 不建议使用created_at, gmt_created, operate_at, optime, operate_time,  gmt_modified,  updated_at 等<br></code></pre></td></tr></table></figure>\n<h1 id=\"Column设计\"><a href=\"#Column设计\" class=\"headerlink\" title=\"Column设计\"></a>Column设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议能用数值类型的，就不用字符类型<br><br><span class=\"hljs-number\">2.</span> [强制]建议能用<span class=\"hljs-type\">varchar</span>(N) 就不用<span class=\"hljs-type\">char</span>(N),以利于节省存储空间<br><br><span class=\"hljs-number\">3.</span> 建议能用<span class=\"hljs-type\">varchar</span>(N) 就不用<span class=\"hljs-type\">text</span>,<span class=\"hljs-type\">varchar</span><br><br><span class=\"hljs-number\">4.</span> 建议使用<span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">NULL</span>,而不用<span class=\"hljs-keyword\">default</span> <span class=\"hljs-string\">&#x27;&#x27;</span>,以节省存储空间, 原理请见: 老何的<span class=\"hljs-number\">1001</span>夜<br><br><span class=\"hljs-number\">5.</span> 建议使用ip4,ip4r,ip6,ip6r,ipaddress,iprange 来存储IP,IP范围；使用<span class=\"hljs-type\">macaddr</span>来存储MAC (Media <span class=\"hljs-keyword\">Access</span> Control) address<br><br><span class=\"hljs-number\">6.</span> [强制]建议使用<span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span>(<span class=\"hljs-type\">timestamptz</span>),而不用<span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">without time zone</span>,避免时间函数在对于不同时区的时间点返回值不同,也为业务国际化扫清障碍<br><br><span class=\"hljs-number\">7.</span> [强制]建议使用<span class=\"hljs-type\">NUMERIC</span>(<span class=\"hljs-type\">precision</span>, scale)来存储货币金额和其它要求精确计算的数值, 而不建议使用<span class=\"hljs-type\">real</span>, <span class=\"hljs-type\">double</span> <span class=\"hljs-type\">precision</span><br><br><span class=\"hljs-number\">8.</span> 建议使用hstore 来存储非结构化,key-<span class=\"hljs-keyword\">value</span> 键值型,对数不定的数据<br><br><span class=\"hljs-number\">9.</span> 建议使用ltree 来存储 Top.中国.北京.海淀区.苏州街 这种 树状层次结构 数据<br><br><span class=\"hljs-number\">10.</span> 建议使用<span class=\"hljs-type\">jsonb</span>(比<span class=\"hljs-type\">json</span>更有优势)来存储<span class=\"hljs-type\">JSON</span> (JavaScript <span class=\"hljs-keyword\">Object</span> Notation) data<br><br><span class=\"hljs-number\">11.</span> 建议使用Geometric <span class=\"hljs-keyword\">Types</span> 结合PostGIS来实现地理信息数据存储及操作<br><br><span class=\"hljs-number\">12.</span> 建议使用如下range类型代替字符串或多列来实现范围的存储<br><span class=\"hljs-type\">int4range</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">integer</span><br><br><span class=\"hljs-type\">int8range</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">bigint</span><br><br><span class=\"hljs-type\">numrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">numeric</span><br><br><span class=\"hljs-type\">tsrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">without time zone</span><br><br><span class=\"hljs-type\">tstzrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span><br><br><span class=\"hljs-type\">daterange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">date</span><br><br><span class=\"hljs-number\">13.</span> 建议在给 <span class=\"hljs-type\">date</span>, <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span> (<span class=\"hljs-type\">timestamptz</span>)字段设置<span class=\"hljs-keyword\">default</span>值时,使用now(), 而不使用timeofday(), 避免因时区不通导致的字段值错误<br><span class=\"hljs-keyword\">select</span> now()::<span class=\"hljs-type\">timestamp</span>, now()::<span class=\"hljs-type\">timestamptz</span>, timeofday()::<span class=\"hljs-type\">timestamp</span>, timeofday()::<span class=\"hljs-type\">timestamptz</span>;<br>            now             |              now              |         timeofday          |           timeofday<br><span class=\"hljs-comment\">----------------------------+-------------------------------+----------------------------+-------------------------------</span><br> <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179549</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179549</span>+<span class=\"hljs-number\">08</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179718</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-17</span> <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179733</span>+<span class=\"hljs-number\">08</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"Constraints-设计\"><a href=\"#Constraints-设计\" class=\"headerlink\" title=\"Constraints 设计\"></a>Constraints 设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议每个<span class=\"hljs-keyword\">table</span>都有主键;<br><br><span class=\"hljs-number\">2.</span> [强制]建议不要用有业务含义的名称作为主键,比如身份证或者国家名称,尽管其是<span class=\"hljs-keyword\">unique</span>的<br><br><span class=\"hljs-number\">3.</span> 建议主键的一步到位的写法:id <span class=\"hljs-type\">serial</span> <span class=\"hljs-keyword\">primary key</span> 或id <span class=\"hljs-type\">bigserial</span> <span class=\"hljs-keyword\">primary key</span><br><br><span class=\"hljs-number\">4.</span> 建议内容系统中size较大的<span class=\"hljs-keyword\">table</span>主键的等效写法如下,便于后续维护<br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test(id <span class=\"hljs-type\">serial</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> );<br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">unique</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> <span class=\"hljs-keyword\">ON</span> test (id);<br></code></pre></td></tr></table></figure>\n<h1 id=\"Index-设计\"><a href=\"#Index-设计\" class=\"headerlink\" title=\"Index 设计\"></a>Index 设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> PostgreSQL 提供的<span class=\"hljs-keyword\">index</span>类型: B-tree, Hash, GiST (Generalized <span class=\"hljs-keyword\">Search</span> Tree), SP-GiST (space-partitioned GiST), GIN (Generalized Inverted <span class=\"hljs-keyword\">Index</span>), BRIN (Block Range <span class=\"hljs-keyword\">Index</span>), PostgreSQL <span class=\"hljs-number\">10</span> 之前版本不建议使用Hash <span class=\"hljs-keyword\">Index</span><br><br><span class=\"hljs-number\">2.</span> [强制]建议<span class=\"hljs-keyword\">create</span> 或 <span class=\"hljs-keyword\">drop</span> <span class=\"hljs-keyword\">index</span> 时,加 <span class=\"hljs-keyword\">CONCURRENTLY</span>参数,这是个好习惯，达到与写入数据并发的效果<br><br><span class=\"hljs-number\">3.</span> 建议对于频繁<span class=\"hljs-keyword\">update</span>, <span class=\"hljs-keyword\">delete</span>的包含于<span class=\"hljs-keyword\">index</span> 定义中的<span class=\"hljs-keyword\">column</span>的<span class=\"hljs-keyword\">table</span>, 用<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> , <span class=\"hljs-keyword\">drop</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> 的方式进行维护其对应<span class=\"hljs-keyword\">index</span><br><br><span class=\"hljs-number\">4.</span> 建议用<span class=\"hljs-keyword\">unique</span> <span class=\"hljs-keyword\">index</span> 代替<span class=\"hljs-keyword\">unique</span> constraints,便于后续维护<br><br><span class=\"hljs-number\">5.</span> 建议对<span class=\"hljs-keyword\">where</span> 中带多个字段<span class=\"hljs-keyword\">and</span>条件的高频 query，参考数据分布情况，建多个字段的联合<span class=\"hljs-keyword\">index</span><br><br><span class=\"hljs-number\">6.</span> 建议对固定条件的（一般有特定业务含义）且选择比好（数据占比低）的query，建带<span class=\"hljs-keyword\">where</span>的Partial Indexes<br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test <span class=\"hljs-keyword\">where</span> status=<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">and</span> col=?; <span class=\"hljs-comment\">-- 其中status=1为固定的条件</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">on</span> test (col) <span class=\"hljs-keyword\">where</span> status=<span class=\"hljs-number\">1</span>;<br><br><span class=\"hljs-number\">7.</span> 建议对经常使用表达式作为查询条件的query，可以使用表达式或函数索引加速query<br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test <span class=\"hljs-keyword\">where</span> exp(xxx);<br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">on</span> test ( exp(xxx) );<br><br><span class=\"hljs-number\">8.</span> 建议不要建过多<span class=\"hljs-keyword\">index</span>，一般不要超过<span class=\"hljs-number\">6</span>个，核心<span class=\"hljs-keyword\">table</span>（产品，订单）可适当增加<span class=\"hljs-keyword\">index</span>个数<br></code></pre></td></tr></table></figure>\n<h1 id=\"关于NULL\"><a href=\"#关于NULL\" class=\"headerlink\" title=\"关于NULL\"></a>关于NULL</h1><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\">1. NULL 的判断：IS NULL ，IS NOT NULL<br><br>2. 注意boolean 类型取值 true，false， NULL<br><br>3. 小心NOT IN 集合中带有NULL元素<br>mydb=# SELECT * FROM (VALUES(1),(2)) v(a) ;<br><span class=\"hljs-code\"> a</span><br>---<br><span class=\"hljs-code\"> 1</span><br><span class=\"hljs-code\"> 2</span><br>(2 rows)<br><br><br>mydb=# select 1 NOT IN (1, NULL);<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br><br><br>mydb=# select 2 NOT IN (1, NULL);<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# SELECT * FROM (VALUES(1),(2)) v(a) WHERE a NOT IN (1, NULL);<br><span class=\"hljs-code\"> a</span><br>---<br>(0 rows)<br><br>--可见，出现这种情况的根本原因在于SELECT只返回WHERE中判断条件结果为true的数据<br><br>4. 建议对字符串型NULL值处理后，进行 || 操作<br>mydb=# select NULL||<span class=\"hljs-emphasis\">&#x27;PostgreSQL&#x27;</span>;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# select coalesce(NULL,&#x27;<span class=\"hljs-emphasis\">&#x27;)||&#x27;</span>PostgreSQL&#x27;;<br><span class=\"hljs-code\">  ?column?</span><br>------------<br><span class=\"hljs-code\"> PostgreSQL</span><br>(1 row)<br><br>5. 建议对hstore 类型进行处理后，进行 || 操作，避免被NULL吃掉<br>mydb=# select  NULL::hstore || (<span class=\"hljs-emphasis\">&#x27;key=&gt;value&#x27;</span>) ;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# select  coalesce(NULL::hstore, hstore(array[]::varchar[])) || (<span class=\"hljs-emphasis\">&#x27;key=&gt;value&#x27;</span>) ;<br><span class=\"hljs-code\">    ?column?</span><br>----------------<br><span class=\"hljs-code\"> &quot;key&quot;=&gt;&quot;value&quot;</span><br>(1 row)<br><br>mydb=# select  coalesce(NULL::hstore,&#x27;<span class=\"hljs-emphasis\">&#x27;::hstore) || (&#x27;</span>key=&gt;value&#x27;) ;<br><span class=\"hljs-code\">    ?column?</span><br>----------------<br><span class=\"hljs-code\"> &quot;key&quot;=&gt;&quot;value&quot;</span><br>(1 row)<br><br>6. 建议使用count(1) 或count(<span class=\"hljs-strong\">*) 来统计行数，而不建议使用count(col) 来统计行数，因为NULL值不会计入</span><br><span class=\"hljs-strong\"></span><br><span class=\"hljs-strong\">注意: count(多列列名)时，多列列名必须使用括号，例如count( (col1,col2,col3) ); 注意多列的count，即使所有列都为NULL，该行也被计数，所以效果与count(*</span>) 一致<br><br>7. count(distinct col) 计算某列的非NULL不重复数量，NULL不被计数<br><br>注意: count(distinct (col1,col2,...) ) 计算多列的唯一值时，NULL会被计数，同时NULL与NULL会被认为是相同的<br><br>8. NULL 的count与sum<br>select count(1), count(a), sum(a)  from (SELECT * FROM (VALUES (NULL), (2) ) v(a)) as foo where a is NULL;<br><span class=\"hljs-code\"> count | count | sum</span><br>-------<span class=\"hljs-code\">+-------+</span>-----<br><span class=\"hljs-code\">     1 |     0 |</span><br>(1 row)<br><br>9. 判断两个值是否相同（将NULL视为相同的值）<br>select null is distinct from null;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br><br><span class=\"hljs-code\"> select null is distinct from 1;</span><br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> t</span><br>(1 row)<br><br>select null is not  distinct from null;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> t</span><br>(1 row)<br><br>mydb=#  select null is not distinct from 1;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br></code></pre></td></tr></table></figure>\n<h1 id=\"开发相关规范\"><a href=\"#开发相关规范\" class=\"headerlink\" title=\"开发相关规范\"></a>开发相关规范</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议对DB <span class=\"hljs-keyword\">object</span> 尤其是<span class=\"hljs-keyword\">COLUMN</span> 加<span class=\"hljs-keyword\">COMMENT</span>，便于后续新人了解业务及维护<br><br><span class=\"hljs-number\">2.</span> [强制]建议非必须时避免<span class=\"hljs-keyword\">select</span> *，只取所需字段，以减少包括不限于网络带宽消耗，避免表结构变更对程序的影响（比如某些<span class=\"hljs-keyword\">prepare</span> query）<br><br><span class=\"hljs-number\">3.</span> 建议<span class=\"hljs-keyword\">update</span> 时尽量做 &lt;&gt; 判断,比如<span class=\"hljs-keyword\">update</span> table_a <span class=\"hljs-keyword\">set</span> column_b = c <span class=\"hljs-keyword\">where</span> column_b &lt;&gt; c<br><br><span class=\"hljs-number\">4.</span> [强制]建议将单个事务的多条<span class=\"hljs-keyword\">SQL</span>操作,分解、拆分，或者不放在一个事务里，让每个事务的粒度尽可能小，尽量<span class=\"hljs-keyword\">lock</span>少的资源，避免<span class=\"hljs-keyword\">lock</span> 、dead <span class=\"hljs-keyword\">lock</span>的产生<br><br><span class=\"hljs-number\">5.</span> 建议 大批量的数据入库时， 使用<span class=\"hljs-keyword\">copy</span> ，不建议使用<span class=\"hljs-keyword\">insert</span>，以提高写入速度<br><br><span class=\"hljs-number\">6.</span> 建议对报表类的或生成基础数据的查询，使用物化视图(<span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span>)定期固化数据快照， 避免对多表（尤其读写频繁的表）重复跑相同的查询，且物化视图支持 <span class=\"hljs-keyword\">REFRESH</span> <span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span> <span class=\"hljs-keyword\">CONCURRENTLY</span>, 支持并发更新<br><br><span class=\"hljs-number\">7.</span> 建议复杂的统计查询可以尝试窗口函数 <span class=\"hljs-keyword\">Window</span> <span class=\"hljs-keyword\">Functions</span><br><br><span class=\"hljs-number\">8.</span> state 为 idle <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">transaction</span> 的连接，如果出现在Master, 会无谓的<span class=\"hljs-keyword\">lock</span>住相应的资源, 可导致后续产生<span class=\"hljs-keyword\">lock</span>,甚至deadlock; 出现在Slave, 可导致卡住主从同步<br>常见的触发方式有：<br>a. 应用程序类：比如python，psycopg2 模块中postgresql的连接参数autocommit默认为<span class=\"hljs-keyword\">false</span>, 经常导致出现这种情况,特别是在slave 这种读取数据时，完全没必要开<span class=\"hljs-keyword\">transaction</span>, 建议将该参数设置为<span class=\"hljs-keyword\">true</span><br><br>b. 其他用psql 或 pgadmin等工具连接DB, 在不是必须的情况下，显式的开启了<span class=\"hljs-keyword\">begin</span>;  xxx; 然后不执行<span class=\"hljs-keyword\">commit</span>;<br><br>c. 本机使用图形化连接工具,误碰了某个默认开事务的按钮, 导致即使<span class=\"hljs-keyword\">select</span>也开了不必要的事务,执行后,在DB端产生的idle <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">transaction</span>的连接,导致报警.<br><br><span class=\"hljs-number\">9.</span> 建议在 MyBatis框架中使用<span class=\"hljs-keyword\">SQL</span>语句时，不要写 useGeneratedKeys=&quot;true&quot;， 或直接设置 useGeneratedKeys=&quot;false&quot;，避免<span class=\"hljs-keyword\">returning</span> *的产生，从而浪费带宽，如果需要返回某个字段，比如id，可以按照如下设置<br>在StatementHandler为PreparedStatementHandle时，<br><br>useGeneratedKeys=&quot;true&quot;; keyColumn=&quot;id&quot;; keyProperty=&quot;id&quot;<br></code></pre></td></tr></table></figure>\n<h1 id=\"管理相关规范\"><a href=\"#管理相关规范\" class=\"headerlink\" title=\"管理相关规范\"></a>管理相关规范</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">1. [强制]建议清空表时，使用truncate，不建议使用delete<br><br>2. [强制]建议向大size的table中<span class=\"hljs-builtin-name\">add</span> column时，PostgreSQL 11之前，需将 alter table t <span class=\"hljs-builtin-name\">add</span> column col datatype <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">null</span><span class=\"hljs-built_in\"> default </span>xxx；分解为如下，避免填充default值导致的过长时间锁表（ddl需加高粒度的lock）<br>alter table t <span class=\"hljs-builtin-name\">add</span> column col datatype ；<br><br>alter table t alter column col <span class=\"hljs-builtin-name\">set</span><span class=\"hljs-built_in\"> default </span>xxx；<br><br>update t <span class=\"hljs-builtin-name\">set</span> column =<span class=\"hljs-built_in\"> default </span>where id = 1;<br><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><br>update t <span class=\"hljs-builtin-name\">set</span> column =<span class=\"hljs-built_in\"> default </span>where id = N;<br><br>------此处,可以用先进的\\watch来刷<br>------即 update t  <span class=\"hljs-builtin-name\">set</span> column=<span class=\"hljs-built_in\"> DEFAULT </span>where id <span class=\"hljs-keyword\">in</span> ( select id <span class=\"hljs-keyword\">from</span> t where column is <span class=\"hljs-literal\">null</span> limit 1000 ) ; \\watch 3<br><br>alter table t alter column col <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">null</span>；<br><br>3. [强制]建议执行DDL,比如CRAETE、DROP、ALTER 等, 尤其多条， 不要显式的开transaction, 因为加lock的mode非常高,极易产生deadlock<br><br>4. 建议对频繁更新的表，建表时指定fillfactor，一般建议值为85<br>create table test(id int ) with(<span class=\"hljs-attribute\">fillfactor</span>=85);<br><br>5. 建议在需要使用explain analyze 查看实际真正执行计划与时间时，如果是写入 query，强烈建议先开启事务， 然后回滚<br></code></pre></td></tr></table></figure>\n<h1 id=\"需求申请规范\"><a href=\"#需求申请规范\" class=\"headerlink\" title=\"需求申请规范\"></a>需求申请规范</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> 建议发给PostgrSQL DBA review 及 执行的<span class=\"hljs-keyword\">SQL</span>，无论是使用pgadmin这种图形化工具，还是pg_dump 这种命令行工具生成的<span class=\"hljs-keyword\">SQL</span>，都去掉注释(<span class=\"hljs-comment\">--之后的部分)，双引号&quot;及alter owner等冗余或不应该带到线上生产的dev/beta DB中的信息</span><br><br><span class=\"hljs-number\">2.</span> 不建议发到pg-request的同一个需求，大家（不仅仅PostgreSQL DBA）在review给出建议后，没有反馈的悄无声息的另起新邮件，避免没有<span class=\"hljs-keyword\">close</span>的需求产生，进而给DBA造成困扰<br><br><span class=\"hljs-number\">3.</span> 建议DB Beta/dev 环境同步线上生产(production)或其他环境(beta/dev)数据的pg-request规范<br>DB beta的数据的同步及更改,需要由QA同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作<br>DB dev的数据的同步及更改,需要由dev同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作<br><br>邮件中需要写清楚源DB及目标DB的 hostname  port  dbname  schemaname 及需要特殊处理的数据<br><br><span class=\"hljs-number\">4.</span> 建议发给PostgreSQL DBA 发布的DDL，附带常用DML: <span class=\"hljs-keyword\">SELECT</span>, <span class=\"hljs-keyword\">INSERT</span> ,<span class=\"hljs-keyword\">DELETE</span>, <span class=\"hljs-keyword\">UPDATE</span>，便于DBA给出<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> 等其他优化建议<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://developer.aliyun.com/article/60899\">阿里云PostgreSQL 数据库开发规范</a></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"命名规范\"><a href=\"#命名规范\" class=\"headerlink\" title=\"命名规范\"></a>命名规范</h1><figure class=\"highlight oxygene\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs oxygene\"><span class=\"hljs-number\">1</span>. DB object: database, schema, table, column, view, <span class=\"hljs-keyword\">index</span>, <span class=\"hljs-keyword\">sequence</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>, <span class=\"hljs-title\">trigger</span>等名称</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(1)</span> 建议使用小写字母、数字、下划线的组合</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(2)</span> 建议不使用双引号即&quot;包围，除非必须包含大写字母或空格等特殊字符</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(3)</span> [强制]长度不能超过63个字符</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(4)</span> 不建议以<span class=\"hljs-title\">pg</span>开头<span class=\"hljs-params\">(避免与系统DB object混淆)</span>, 不建议以数字开头</span><br><span class=\"hljs-function\"><span class=\"hljs-params\">(5)</span> 禁止使用 <span class=\"hljs-title\">SQL</span> 关键字中保留类型的<span class=\"hljs-params\">(reserved)</span>，例如 <span class=\"hljs-title\">user</span>, <span class=\"hljs-title\">type</span>, <span class=\"hljs-title\">order</span> 等, 非保留类型的<span class=\"hljs-params\">(unreserved)</span>也不建议使用.</span><br><span class=\"hljs-function\">--判断是否是关键字的方法:</span><br><br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> pg_get_keywords() <span class=\"hljs-keyword\">where</span> word = <span class=\"hljs-string\">&#x27;order&#x27;</span>;;<br> word  | catcode | catdesc<br>-------+---------+----------<br> <span class=\"hljs-keyword\">order</span> | R       | reserved<br>(<span class=\"hljs-number\">1</span> row)<br><br>-- 查看已经存在的table中的关键字<br><span class=\"hljs-keyword\">select</span><br>    table_schema, table_name, column_name, b.word, b.catdesc<br><span class=\"hljs-keyword\">from</span><br>     information_schema.columns a<br><span class=\"hljs-keyword\">join</span> (<span class=\"hljs-keyword\">select</span> word, catcode, catdesc <span class=\"hljs-keyword\">from</span> pg_get_keywords()) b<br>  <span class=\"hljs-keyword\">on</span>  a.column_name = b.word<br><span class=\"hljs-keyword\">where</span> table_schema = <span class=\"hljs-string\">&#x27;public&#x27;</span><br>  <span class=\"hljs-keyword\">and</span> table_name =  <span class=\"hljs-string\">&#x27;student&#x27;</span>;<br><br> table_schema |     table_name     | column_name | word |  catdesc<br>--------------+--------------------+-------------+------+------------<br> <span class=\"hljs-keyword\">public</span>       | student            | name        | name | unreserved<br><br>(<span class=\"hljs-number\">1</span> row)<br><br><br><span class=\"hljs-number\">2</span>. table能包含的column数目,根据字段类型的不同，数目在 <span class=\"hljs-number\">250</span> 到 <span class=\"hljs-number\">1600</span> 之间<br><br><span class=\"hljs-number\">3</span>. 临时或备份的DB object:table,view 等,建议加上日期, 如dba_ops.b2c_product_summay_2014_07_12 (其中dba_ops 为DBA专用schema)<br><br><span class=\"hljs-number\">4</span>. <span class=\"hljs-keyword\">index</span>命名规则为: 表名_列名_idx, 如student_name_idx, 建议不显式给出<span class=\"hljs-keyword\">index</span> name, 使用DBMS默认给出的<span class=\"hljs-keyword\">index</span> name, 如<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">ON</span> student (name),则默认给出的<span class=\"hljs-keyword\">index</span>名称为student_name_idx<br><br><span class=\"hljs-number\">5</span>. 建议table中的创建和更新时间字段统一命名为create_time, update_time, 不建议使用created_at, gmt_created, operate_at, optime, operate_time,  gmt_modified,  updated_at 等<br></code></pre></td></tr></table></figure>\n<h1 id=\"Column设计\"><a href=\"#Column设计\" class=\"headerlink\" title=\"Column设计\"></a>Column设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议能用数值类型的，就不用字符类型<br><br><span class=\"hljs-number\">2.</span> [强制]建议能用<span class=\"hljs-type\">varchar</span>(N) 就不用<span class=\"hljs-type\">char</span>(N),以利于节省存储空间<br><br><span class=\"hljs-number\">3.</span> 建议能用<span class=\"hljs-type\">varchar</span>(N) 就不用<span class=\"hljs-type\">text</span>,<span class=\"hljs-type\">varchar</span><br><br><span class=\"hljs-number\">4.</span> 建议使用<span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">NULL</span>,而不用<span class=\"hljs-keyword\">default</span> <span class=\"hljs-string\">&#x27;&#x27;</span>,以节省存储空间, 原理请见: 老何的<span class=\"hljs-number\">1001</span>夜<br><br><span class=\"hljs-number\">5.</span> 建议使用ip4,ip4r,ip6,ip6r,ipaddress,iprange 来存储IP,IP范围；使用<span class=\"hljs-type\">macaddr</span>来存储MAC (Media <span class=\"hljs-keyword\">Access</span> Control) address<br><br><span class=\"hljs-number\">6.</span> [强制]建议使用<span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span>(<span class=\"hljs-type\">timestamptz</span>),而不用<span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">without time zone</span>,避免时间函数在对于不同时区的时间点返回值不同,也为业务国际化扫清障碍<br><br><span class=\"hljs-number\">7.</span> [强制]建议使用<span class=\"hljs-type\">NUMERIC</span>(<span class=\"hljs-type\">precision</span>, scale)来存储货币金额和其它要求精确计算的数值, 而不建议使用<span class=\"hljs-type\">real</span>, <span class=\"hljs-type\">double</span> <span class=\"hljs-type\">precision</span><br><br><span class=\"hljs-number\">8.</span> 建议使用hstore 来存储非结构化,key-<span class=\"hljs-keyword\">value</span> 键值型,对数不定的数据<br><br><span class=\"hljs-number\">9.</span> 建议使用ltree 来存储 Top.中国.北京.海淀区.苏州街 这种 树状层次结构 数据<br><br><span class=\"hljs-number\">10.</span> 建议使用<span class=\"hljs-type\">jsonb</span>(比<span class=\"hljs-type\">json</span>更有优势)来存储<span class=\"hljs-type\">JSON</span> (JavaScript <span class=\"hljs-keyword\">Object</span> Notation) data<br><br><span class=\"hljs-number\">11.</span> 建议使用Geometric <span class=\"hljs-keyword\">Types</span> 结合PostGIS来实现地理信息数据存储及操作<br><br><span class=\"hljs-number\">12.</span> 建议使用如下range类型代替字符串或多列来实现范围的存储<br><span class=\"hljs-type\">int4range</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">integer</span><br><br><span class=\"hljs-type\">int8range</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">bigint</span><br><br><span class=\"hljs-type\">numrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">numeric</span><br><br><span class=\"hljs-type\">tsrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">without time zone</span><br><br><span class=\"hljs-type\">tstzrange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span><br><br><span class=\"hljs-type\">daterange</span> — Range <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">date</span><br><br><span class=\"hljs-number\">13.</span> 建议在给 <span class=\"hljs-type\">date</span>, <span class=\"hljs-type\">timestamp</span> <span class=\"hljs-type\">with time zone</span> (<span class=\"hljs-type\">timestamptz</span>)字段设置<span class=\"hljs-keyword\">default</span>值时,使用now(), 而不使用timeofday(), 避免因时区不通导致的字段值错误<br><span class=\"hljs-keyword\">select</span> now()::<span class=\"hljs-type\">timestamp</span>, now()::<span class=\"hljs-type\">timestamptz</span>, timeofday()::<span class=\"hljs-type\">timestamp</span>, timeofday()::<span class=\"hljs-type\">timestamptz</span>;<br>            now             |              now              |         timeofday          |           timeofday<br><span class=\"hljs-comment\">----------------------------+-------------------------------+----------------------------+-------------------------------</span><br> <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179549</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179549</span>+<span class=\"hljs-number\">08</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-16</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179718</span> | <span class=\"hljs-number\">2017</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-17</span> <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">50.179733</span>+<span class=\"hljs-number\">08</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"Constraints-设计\"><a href=\"#Constraints-设计\" class=\"headerlink\" title=\"Constraints 设计\"></a>Constraints 设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议每个<span class=\"hljs-keyword\">table</span>都有主键;<br><br><span class=\"hljs-number\">2.</span> [强制]建议不要用有业务含义的名称作为主键,比如身份证或者国家名称,尽管其是<span class=\"hljs-keyword\">unique</span>的<br><br><span class=\"hljs-number\">3.</span> 建议主键的一步到位的写法:id <span class=\"hljs-type\">serial</span> <span class=\"hljs-keyword\">primary key</span> 或id <span class=\"hljs-type\">bigserial</span> <span class=\"hljs-keyword\">primary key</span><br><br><span class=\"hljs-number\">4.</span> 建议内容系统中size较大的<span class=\"hljs-keyword\">table</span>主键的等效写法如下,便于后续维护<br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test(id <span class=\"hljs-type\">serial</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">null</span> );<br><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">unique</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> <span class=\"hljs-keyword\">ON</span> test (id);<br></code></pre></td></tr></table></figure>\n<h1 id=\"Index-设计\"><a href=\"#Index-设计\" class=\"headerlink\" title=\"Index 设计\"></a>Index 设计</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> PostgreSQL 提供的<span class=\"hljs-keyword\">index</span>类型: B-tree, Hash, GiST (Generalized <span class=\"hljs-keyword\">Search</span> Tree), SP-GiST (space-partitioned GiST), GIN (Generalized Inverted <span class=\"hljs-keyword\">Index</span>), BRIN (Block Range <span class=\"hljs-keyword\">Index</span>), PostgreSQL <span class=\"hljs-number\">10</span> 之前版本不建议使用Hash <span class=\"hljs-keyword\">Index</span><br><br><span class=\"hljs-number\">2.</span> [强制]建议<span class=\"hljs-keyword\">create</span> 或 <span class=\"hljs-keyword\">drop</span> <span class=\"hljs-keyword\">index</span> 时,加 <span class=\"hljs-keyword\">CONCURRENTLY</span>参数,这是个好习惯，达到与写入数据并发的效果<br><br><span class=\"hljs-number\">3.</span> 建议对于频繁<span class=\"hljs-keyword\">update</span>, <span class=\"hljs-keyword\">delete</span>的包含于<span class=\"hljs-keyword\">index</span> 定义中的<span class=\"hljs-keyword\">column</span>的<span class=\"hljs-keyword\">table</span>, 用<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> , <span class=\"hljs-keyword\">drop</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> 的方式进行维护其对应<span class=\"hljs-keyword\">index</span><br><br><span class=\"hljs-number\">4.</span> 建议用<span class=\"hljs-keyword\">unique</span> <span class=\"hljs-keyword\">index</span> 代替<span class=\"hljs-keyword\">unique</span> constraints,便于后续维护<br><br><span class=\"hljs-number\">5.</span> 建议对<span class=\"hljs-keyword\">where</span> 中带多个字段<span class=\"hljs-keyword\">and</span>条件的高频 query，参考数据分布情况，建多个字段的联合<span class=\"hljs-keyword\">index</span><br><br><span class=\"hljs-number\">6.</span> 建议对固定条件的（一般有特定业务含义）且选择比好（数据占比低）的query，建带<span class=\"hljs-keyword\">where</span>的Partial Indexes<br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test <span class=\"hljs-keyword\">where</span> status=<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">and</span> col=?; <span class=\"hljs-comment\">-- 其中status=1为固定的条件</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">on</span> test (col) <span class=\"hljs-keyword\">where</span> status=<span class=\"hljs-number\">1</span>;<br><br><span class=\"hljs-number\">7.</span> 建议对经常使用表达式作为查询条件的query，可以使用表达式或函数索引加速query<br><span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test <span class=\"hljs-keyword\">where</span> exp(xxx);<br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">on</span> test ( exp(xxx) );<br><br><span class=\"hljs-number\">8.</span> 建议不要建过多<span class=\"hljs-keyword\">index</span>，一般不要超过<span class=\"hljs-number\">6</span>个，核心<span class=\"hljs-keyword\">table</span>（产品，订单）可适当增加<span class=\"hljs-keyword\">index</span>个数<br></code></pre></td></tr></table></figure>\n<h1 id=\"关于NULL\"><a href=\"#关于NULL\" class=\"headerlink\" title=\"关于NULL\"></a>关于NULL</h1><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\">1. NULL 的判断：IS NULL ，IS NOT NULL<br><br>2. 注意boolean 类型取值 true，false， NULL<br><br>3. 小心NOT IN 集合中带有NULL元素<br>mydb=# SELECT * FROM (VALUES(1),(2)) v(a) ;<br><span class=\"hljs-code\"> a</span><br>---<br><span class=\"hljs-code\"> 1</span><br><span class=\"hljs-code\"> 2</span><br>(2 rows)<br><br><br>mydb=# select 1 NOT IN (1, NULL);<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br><br><br>mydb=# select 2 NOT IN (1, NULL);<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# SELECT * FROM (VALUES(1),(2)) v(a) WHERE a NOT IN (1, NULL);<br><span class=\"hljs-code\"> a</span><br>---<br>(0 rows)<br><br>--可见，出现这种情况的根本原因在于SELECT只返回WHERE中判断条件结果为true的数据<br><br>4. 建议对字符串型NULL值处理后，进行 || 操作<br>mydb=# select NULL||<span class=\"hljs-emphasis\">&#x27;PostgreSQL&#x27;</span>;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# select coalesce(NULL,&#x27;<span class=\"hljs-emphasis\">&#x27;)||&#x27;</span>PostgreSQL&#x27;;<br><span class=\"hljs-code\">  ?column?</span><br>------------<br><span class=\"hljs-code\"> PostgreSQL</span><br>(1 row)<br><br>5. 建议对hstore 类型进行处理后，进行 || 操作，避免被NULL吃掉<br>mydb=# select  NULL::hstore || (<span class=\"hljs-emphasis\">&#x27;key=&gt;value&#x27;</span>) ;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><br>(1 row)<br><br>mydb=# select  coalesce(NULL::hstore, hstore(array[]::varchar[])) || (<span class=\"hljs-emphasis\">&#x27;key=&gt;value&#x27;</span>) ;<br><span class=\"hljs-code\">    ?column?</span><br>----------------<br><span class=\"hljs-code\"> &quot;key&quot;=&gt;&quot;value&quot;</span><br>(1 row)<br><br>mydb=# select  coalesce(NULL::hstore,&#x27;<span class=\"hljs-emphasis\">&#x27;::hstore) || (&#x27;</span>key=&gt;value&#x27;) ;<br><span class=\"hljs-code\">    ?column?</span><br>----------------<br><span class=\"hljs-code\"> &quot;key&quot;=&gt;&quot;value&quot;</span><br>(1 row)<br><br>6. 建议使用count(1) 或count(<span class=\"hljs-strong\">*) 来统计行数，而不建议使用count(col) 来统计行数，因为NULL值不会计入</span><br><span class=\"hljs-strong\"></span><br><span class=\"hljs-strong\">注意: count(多列列名)时，多列列名必须使用括号，例如count( (col1,col2,col3) ); 注意多列的count，即使所有列都为NULL，该行也被计数，所以效果与count(*</span>) 一致<br><br>7. count(distinct col) 计算某列的非NULL不重复数量，NULL不被计数<br><br>注意: count(distinct (col1,col2,...) ) 计算多列的唯一值时，NULL会被计数，同时NULL与NULL会被认为是相同的<br><br>8. NULL 的count与sum<br>select count(1), count(a), sum(a)  from (SELECT * FROM (VALUES (NULL), (2) ) v(a)) as foo where a is NULL;<br><span class=\"hljs-code\"> count | count | sum</span><br>-------<span class=\"hljs-code\">+-------+</span>-----<br><span class=\"hljs-code\">     1 |     0 |</span><br>(1 row)<br><br>9. 判断两个值是否相同（将NULL视为相同的值）<br>select null is distinct from null;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br><br><span class=\"hljs-code\"> select null is distinct from 1;</span><br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> t</span><br>(1 row)<br><br>select null is not  distinct from null;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> t</span><br>(1 row)<br><br>mydb=#  select null is not distinct from 1;<br><span class=\"hljs-code\"> ?column?</span><br>----------<br><span class=\"hljs-code\"> f</span><br>(1 row)<br></code></pre></td></tr></table></figure>\n<h1 id=\"开发相关规范\"><a href=\"#开发相关规范\" class=\"headerlink\" title=\"开发相关规范\"></a>开发相关规范</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> [强制]建议对DB <span class=\"hljs-keyword\">object</span> 尤其是<span class=\"hljs-keyword\">COLUMN</span> 加<span class=\"hljs-keyword\">COMMENT</span>，便于后续新人了解业务及维护<br><br><span class=\"hljs-number\">2.</span> [强制]建议非必须时避免<span class=\"hljs-keyword\">select</span> *，只取所需字段，以减少包括不限于网络带宽消耗，避免表结构变更对程序的影响（比如某些<span class=\"hljs-keyword\">prepare</span> query）<br><br><span class=\"hljs-number\">3.</span> 建议<span class=\"hljs-keyword\">update</span> 时尽量做 &lt;&gt; 判断,比如<span class=\"hljs-keyword\">update</span> table_a <span class=\"hljs-keyword\">set</span> column_b = c <span class=\"hljs-keyword\">where</span> column_b &lt;&gt; c<br><br><span class=\"hljs-number\">4.</span> [强制]建议将单个事务的多条<span class=\"hljs-keyword\">SQL</span>操作,分解、拆分，或者不放在一个事务里，让每个事务的粒度尽可能小，尽量<span class=\"hljs-keyword\">lock</span>少的资源，避免<span class=\"hljs-keyword\">lock</span> 、dead <span class=\"hljs-keyword\">lock</span>的产生<br><br><span class=\"hljs-number\">5.</span> 建议 大批量的数据入库时， 使用<span class=\"hljs-keyword\">copy</span> ，不建议使用<span class=\"hljs-keyword\">insert</span>，以提高写入速度<br><br><span class=\"hljs-number\">6.</span> 建议对报表类的或生成基础数据的查询，使用物化视图(<span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span>)定期固化数据快照， 避免对多表（尤其读写频繁的表）重复跑相同的查询，且物化视图支持 <span class=\"hljs-keyword\">REFRESH</span> <span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span> <span class=\"hljs-keyword\">CONCURRENTLY</span>, 支持并发更新<br><br><span class=\"hljs-number\">7.</span> 建议复杂的统计查询可以尝试窗口函数 <span class=\"hljs-keyword\">Window</span> <span class=\"hljs-keyword\">Functions</span><br><br><span class=\"hljs-number\">8.</span> state 为 idle <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">transaction</span> 的连接，如果出现在Master, 会无谓的<span class=\"hljs-keyword\">lock</span>住相应的资源, 可导致后续产生<span class=\"hljs-keyword\">lock</span>,甚至deadlock; 出现在Slave, 可导致卡住主从同步<br>常见的触发方式有：<br>a. 应用程序类：比如python，psycopg2 模块中postgresql的连接参数autocommit默认为<span class=\"hljs-keyword\">false</span>, 经常导致出现这种情况,特别是在slave 这种读取数据时，完全没必要开<span class=\"hljs-keyword\">transaction</span>, 建议将该参数设置为<span class=\"hljs-keyword\">true</span><br><br>b. 其他用psql 或 pgadmin等工具连接DB, 在不是必须的情况下，显式的开启了<span class=\"hljs-keyword\">begin</span>;  xxx; 然后不执行<span class=\"hljs-keyword\">commit</span>;<br><br>c. 本机使用图形化连接工具,误碰了某个默认开事务的按钮, 导致即使<span class=\"hljs-keyword\">select</span>也开了不必要的事务,执行后,在DB端产生的idle <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">transaction</span>的连接,导致报警.<br><br><span class=\"hljs-number\">9.</span> 建议在 MyBatis框架中使用<span class=\"hljs-keyword\">SQL</span>语句时，不要写 useGeneratedKeys=&quot;true&quot;， 或直接设置 useGeneratedKeys=&quot;false&quot;，避免<span class=\"hljs-keyword\">returning</span> *的产生，从而浪费带宽，如果需要返回某个字段，比如id，可以按照如下设置<br>在StatementHandler为PreparedStatementHandle时，<br><br>useGeneratedKeys=&quot;true&quot;; keyColumn=&quot;id&quot;; keyProperty=&quot;id&quot;<br></code></pre></td></tr></table></figure>\n<h1 id=\"管理相关规范\"><a href=\"#管理相关规范\" class=\"headerlink\" title=\"管理相关规范\"></a>管理相关规范</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">1. [强制]建议清空表时，使用truncate，不建议使用delete<br><br>2. [强制]建议向大size的table中<span class=\"hljs-builtin-name\">add</span> column时，PostgreSQL 11之前，需将 alter table t <span class=\"hljs-builtin-name\">add</span> column col datatype <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">null</span><span class=\"hljs-built_in\"> default </span>xxx；分解为如下，避免填充default值导致的过长时间锁表（ddl需加高粒度的lock）<br>alter table t <span class=\"hljs-builtin-name\">add</span> column col datatype ；<br><br>alter table t alter column col <span class=\"hljs-builtin-name\">set</span><span class=\"hljs-built_in\"> default </span>xxx；<br><br>update t <span class=\"hljs-builtin-name\">set</span> column =<span class=\"hljs-built_in\"> default </span>where id = 1;<br><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span><br><br>update t <span class=\"hljs-builtin-name\">set</span> column =<span class=\"hljs-built_in\"> default </span>where id = N;<br><br>------此处,可以用先进的\\watch来刷<br>------即 update t  <span class=\"hljs-builtin-name\">set</span> column=<span class=\"hljs-built_in\"> DEFAULT </span>where id <span class=\"hljs-keyword\">in</span> ( select id <span class=\"hljs-keyword\">from</span> t where column is <span class=\"hljs-literal\">null</span> limit 1000 ) ; \\watch 3<br><br>alter table t alter column col <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">null</span>；<br><br>3. [强制]建议执行DDL,比如CRAETE、DROP、ALTER 等, 尤其多条， 不要显式的开transaction, 因为加lock的mode非常高,极易产生deadlock<br><br>4. 建议对频繁更新的表，建表时指定fillfactor，一般建议值为85<br>create table test(id int ) with(<span class=\"hljs-attribute\">fillfactor</span>=85);<br><br>5. 建议在需要使用explain analyze 查看实际真正执行计划与时间时，如果是写入 query，强烈建议先开启事务， 然后回滚<br></code></pre></td></tr></table></figure>\n<h1 id=\"需求申请规范\"><a href=\"#需求申请规范\" class=\"headerlink\" title=\"需求申请规范\"></a>需求申请规范</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-number\">1.</span> 建议发给PostgrSQL DBA review 及 执行的<span class=\"hljs-keyword\">SQL</span>，无论是使用pgadmin这种图形化工具，还是pg_dump 这种命令行工具生成的<span class=\"hljs-keyword\">SQL</span>，都去掉注释(<span class=\"hljs-comment\">--之后的部分)，双引号&quot;及alter owner等冗余或不应该带到线上生产的dev/beta DB中的信息</span><br><br><span class=\"hljs-number\">2.</span> 不建议发到pg-request的同一个需求，大家（不仅仅PostgreSQL DBA）在review给出建议后，没有反馈的悄无声息的另起新邮件，避免没有<span class=\"hljs-keyword\">close</span>的需求产生，进而给DBA造成困扰<br><br><span class=\"hljs-number\">3.</span> 建议DB Beta/dev 环境同步线上生产(production)或其他环境(beta/dev)数据的pg-request规范<br>DB beta的数据的同步及更改,需要由QA同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作<br>DB dev的数据的同步及更改,需要由dev同学周知本组同学且确认可以操作后, 加Team Leader, 发pg-request@,DBA会跟进操作<br><br>邮件中需要写清楚源DB及目标DB的 hostname  port  dbname  schemaname 及需要特殊处理的数据<br><br><span class=\"hljs-number\">4.</span> 建议发给PostgreSQL DBA 发布的DDL，附带常用DML: <span class=\"hljs-keyword\">SELECT</span>, <span class=\"hljs-keyword\">INSERT</span> ,<span class=\"hljs-keyword\">DELETE</span>, <span class=\"hljs-keyword\">UPDATE</span>，便于DBA给出<span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">index</span> <span class=\"hljs-keyword\">CONCURRENTLY</span> 等其他优化建议<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><p><a href=\"https://developer.aliyun.com/article/60899\">阿里云PostgreSQL 数据库开发规范</a></p>\n"},{"title":"PostgreSQL用户权限","date":"2020-08-05T08:41:08.000Z","top":8,"password":null,"_content":"\nPostgreSQL中role是权限的集合，没有区分用户和角色的概念，\"CREATE USER\" 为 \"CREATE ROLE\" 的别名，这两个命令几乎是完全相同的,唯一的区别是\"CREATE USER\" 命令创建的用户默认带有LOGIN属性，而\"CREATE ROLE\" 命令创建的用户默认不带LOGIN属性(CREATE USER is equivalent to CREATE ROLE except that CREATE USER assumes LOGIN by default, while CREATE ROLE does not)\n\n\n为了方便用role的方式管理用户， 而不是每新建一个用户就授予权限一次.\n\n<!-- more -->\n\n#  准备\n收回PUBLIC用户组对模式public的所有权限， 并创建测试用表\n\n```\njintao@jintao-ThinkPad-L490:~$ psql \npsql (14devel)\nType \"help\" for help.\n\nmydb=# revoke ALL on SCHEMA public from PUBLIC;\nREVOKE\nmydb=# create table test1(id int);\nCREATE TABLE\nmydb=# insert into test1 select 1;\nINSERT 0 1\nmydb=# select * from test1;\n id \n----\n  1\n(1 row)\n\nmydb=# \n\n```\n#  创建只读角色  \n  \n只对table, sequence, function 做了处理， 如type, procedure等类似\n```\nmydb=# create role readonly;                                                 \nCREATE ROLE\nmydb=# grant SELECT on ALL tables in schema public to readonly ;    -- 赋予readonly对public模式下当前存在的表可读\nGRANT\nmydb=# grant EXECUTE on ALL functions in schema public to readonly ;    -- 赋予readonly对public模式下当前函数可执行\nGRANT\nmydb=# grant SELECT on ALL sequences in schema public to readonly ;      -- 赋予readonly对public模式下当前序列的可读\nGRANT\nmydb=# alter default privileges for role postgres in schema public grant select on tables to readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的表可读\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres  in schema public grant execute on functions to readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的函数可执行\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres  in schema public grant select on sequences to readonly;    - 赋予readonly对public模式下之后对postgres用户新建的序列可读\nALTER DEFAULT PRIVILEGES\n```\n#  创建读写角色  \n  \n只对table, sequence, function 做了处理， 如type, procedure等类似\n```\nmydb=# grant all on SCHEMA public to readwrite ;            -- 赋予readwrite对public模式下当前存在的表可读写\nGRANT\nmydb=# grant ALL  on ALL tables in schema public to readwrite ;\nGRANT\nmydb=# grant ALL on ALL sequences in schema public to readwrite ;\nGRANT\nmydb=# grant ALL on ALL functions in schema public to readwrite ;\nGRANT\nmydb=# alter default privileges for role postgres  in schema public grant all on tables to readwrite;\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres in schema public grant all on sequences to readwrite;\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres in schema public grant all on functions to readwrite;\nALTER DEFAULT PRIVILEGES\n\n```\n#  readonly 权限测试\n```\nmydb=# create user user1;\nCREATE ROLE\nmydb=# set role user1;\nSET\nmydb=> select * from public.test1;\nERROR:  permission denied for schema public\nLINE 1: select * from public.test1;\n                      ^\nmydb=> insert into public.test1 select 2;\nERROR:  permission denied for schema public\nLINE 1: insert into public.test1 select 2;\n                    ^\nmydb=> set role postgres;\nSET\nmydb=# grant readonly to user1 ;\nGRANT ROLE\nmydb=# set role user1;\nSET\nmydb=> select * from public.test1;\n id \n----\n  1\n(1 row)\n\nmydb=> insert into public.test1 select 2;\nERROR:  permission denied for table test1\nmydb=> \nmydb=# select 2 into test2;\nSELECT 1\nmydb=# set role user1;\nSET\nmydb=> select * from test2;\n ?column? \n----------\n        2\n(1 row)\n\nmydb=> insert into test2 select 3;\nERROR:  permission denied for table test2\nmydb=> \n\n```\n#   readwrite权限测试\n```\nmydb=# create user user2;\nCREATE ROLE\nmydb=# set role user2;\nSET\nmydb=> select * from public.test1;\nERROR:  permission denied for schema public\nLINE 1: select * from public.test1;\n                      ^\nmydb=> insert into public.test2 select 2;\nERROR:  permission denied for schema public\nLINE 1: insert into public.test2 select 2;\n                    ^\nmydb=> set role postgres;\nSET\nmydb=# grant readwrite to user2;\nGRANT ROLE\nmydb=# set role user2;\nSET\nmydb=> select * from public.test1;\n id \n----\n  1\n(1 row)\n\nmydb=> insert into public.test2 select 2;\nINSERT 0 1\nmydb=> set role postgres;\nSET\nmydb=# create table test3(id int);\nCREATE TABLE\nmydb=# set role user2;\nSET\nmydb=> select * from test3;\n id \n----\n(0 rows)\n\nmydb=> insert into test3 select 1;\nINSERT 0 1\nmydb=> \n\n```\n","source":"_posts/PostgreSQL用户权限.md","raw":"---\ntitle: PostgreSQL用户权限 \ndate: 2020-08-05 16:41:08\ntags: \n- PostgreSQL\n- role\n- 权限\ncategories: PostgreSQL\ntop: 8\npassword: \n\n---\n\nPostgreSQL中role是权限的集合，没有区分用户和角色的概念，\"CREATE USER\" 为 \"CREATE ROLE\" 的别名，这两个命令几乎是完全相同的,唯一的区别是\"CREATE USER\" 命令创建的用户默认带有LOGIN属性，而\"CREATE ROLE\" 命令创建的用户默认不带LOGIN属性(CREATE USER is equivalent to CREATE ROLE except that CREATE USER assumes LOGIN by default, while CREATE ROLE does not)\n\n\n为了方便用role的方式管理用户， 而不是每新建一个用户就授予权限一次.\n\n<!-- more -->\n\n#  准备\n收回PUBLIC用户组对模式public的所有权限， 并创建测试用表\n\n```\njintao@jintao-ThinkPad-L490:~$ psql \npsql (14devel)\nType \"help\" for help.\n\nmydb=# revoke ALL on SCHEMA public from PUBLIC;\nREVOKE\nmydb=# create table test1(id int);\nCREATE TABLE\nmydb=# insert into test1 select 1;\nINSERT 0 1\nmydb=# select * from test1;\n id \n----\n  1\n(1 row)\n\nmydb=# \n\n```\n#  创建只读角色  \n  \n只对table, sequence, function 做了处理， 如type, procedure等类似\n```\nmydb=# create role readonly;                                                 \nCREATE ROLE\nmydb=# grant SELECT on ALL tables in schema public to readonly ;    -- 赋予readonly对public模式下当前存在的表可读\nGRANT\nmydb=# grant EXECUTE on ALL functions in schema public to readonly ;    -- 赋予readonly对public模式下当前函数可执行\nGRANT\nmydb=# grant SELECT on ALL sequences in schema public to readonly ;      -- 赋予readonly对public模式下当前序列的可读\nGRANT\nmydb=# alter default privileges for role postgres in schema public grant select on tables to readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的表可读\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres  in schema public grant execute on functions to readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的函数可执行\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres  in schema public grant select on sequences to readonly;    - 赋予readonly对public模式下之后对postgres用户新建的序列可读\nALTER DEFAULT PRIVILEGES\n```\n#  创建读写角色  \n  \n只对table, sequence, function 做了处理， 如type, procedure等类似\n```\nmydb=# grant all on SCHEMA public to readwrite ;            -- 赋予readwrite对public模式下当前存在的表可读写\nGRANT\nmydb=# grant ALL  on ALL tables in schema public to readwrite ;\nGRANT\nmydb=# grant ALL on ALL sequences in schema public to readwrite ;\nGRANT\nmydb=# grant ALL on ALL functions in schema public to readwrite ;\nGRANT\nmydb=# alter default privileges for role postgres  in schema public grant all on tables to readwrite;\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres in schema public grant all on sequences to readwrite;\nALTER DEFAULT PRIVILEGES\nmydb=# alter default privileges for role postgres in schema public grant all on functions to readwrite;\nALTER DEFAULT PRIVILEGES\n\n```\n#  readonly 权限测试\n```\nmydb=# create user user1;\nCREATE ROLE\nmydb=# set role user1;\nSET\nmydb=> select * from public.test1;\nERROR:  permission denied for schema public\nLINE 1: select * from public.test1;\n                      ^\nmydb=> insert into public.test1 select 2;\nERROR:  permission denied for schema public\nLINE 1: insert into public.test1 select 2;\n                    ^\nmydb=> set role postgres;\nSET\nmydb=# grant readonly to user1 ;\nGRANT ROLE\nmydb=# set role user1;\nSET\nmydb=> select * from public.test1;\n id \n----\n  1\n(1 row)\n\nmydb=> insert into public.test1 select 2;\nERROR:  permission denied for table test1\nmydb=> \nmydb=# select 2 into test2;\nSELECT 1\nmydb=# set role user1;\nSET\nmydb=> select * from test2;\n ?column? \n----------\n        2\n(1 row)\n\nmydb=> insert into test2 select 3;\nERROR:  permission denied for table test2\nmydb=> \n\n```\n#   readwrite权限测试\n```\nmydb=# create user user2;\nCREATE ROLE\nmydb=# set role user2;\nSET\nmydb=> select * from public.test1;\nERROR:  permission denied for schema public\nLINE 1: select * from public.test1;\n                      ^\nmydb=> insert into public.test2 select 2;\nERROR:  permission denied for schema public\nLINE 1: insert into public.test2 select 2;\n                    ^\nmydb=> set role postgres;\nSET\nmydb=# grant readwrite to user2;\nGRANT ROLE\nmydb=# set role user2;\nSET\nmydb=> select * from public.test1;\n id \n----\n  1\n(1 row)\n\nmydb=> insert into public.test2 select 2;\nINSERT 0 1\nmydb=> set role postgres;\nSET\nmydb=# create table test3(id int);\nCREATE TABLE\nmydb=# set role user2;\nSET\nmydb=> select * from test3;\n id \n----\n(0 rows)\n\nmydb=> insert into test3 select 1;\nINSERT 0 1\nmydb=> \n\n```\n","slug":"PostgreSQL用户权限","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhg000jpieb1ia09cop","content":"<p>PostgreSQL中role是权限的集合，没有区分用户和角色的概念，”CREATE USER” 为 “CREATE ROLE” 的别名，这两个命令几乎是完全相同的,唯一的区别是”CREATE USER” 命令创建的用户默认带有LOGIN属性，而”CREATE ROLE” 命令创建的用户默认不带LOGIN属性(CREATE USER is equivalent to CREATE ROLE except that CREATE USER assumes LOGIN by default, while CREATE ROLE does not)</p>\n<p>为了方便用role的方式管理用户， 而不是每新建一个用户就授予权限一次.</p>\n<a id=\"more\"></a>\n<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><p>收回PUBLIC用户组对模式public的所有权限， 并创建测试用表</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">jintao@jintao-ThinkPad-L490:~$ psql <br>psql (<span class=\"hljs-number\">14</span>devel)<br><span class=\"hljs-keyword\">Type</span> &quot;help&quot; <span class=\"hljs-keyword\">for</span> help.<br><br>mydb=# <span class=\"hljs-keyword\">revoke</span> <span class=\"hljs-keyword\">ALL</span> <span class=\"hljs-keyword\">on</span> <span class=\"hljs-keyword\">SCHEMA</span> <span class=\"hljs-built_in\">public</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">PUBLIC</span>;<br><span class=\"hljs-keyword\">REVOKE</span><br>mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test1(id <span class=\"hljs-type\">int</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>mydb=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=# <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=# <br><br></code></pre></td></tr></table></figure>\n<h1 id=\"创建只读角色\"><a href=\"#创建只读角色\" class=\"headerlink\" title=\"创建只读角色\"></a>创建只读角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create role readonly;                                                 <br>CREATE ROLE<br><span class=\"hljs-attribute\">mydb</span>=# grant SELECT on ALL tables <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;    -- 赋予readonly对public模式下当前存在的表可读<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant EXECUTE on ALL functions <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;    -- 赋予readonly对public模式下当前函数可执行<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant SELECT on ALL sequences <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;      -- 赋予readonly对public模式下当前序列的可读<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant select on tables <span class=\"hljs-keyword\">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的表可读<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant execute on functions <span class=\"hljs-keyword\">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的函数可执行<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant select on sequences <span class=\"hljs-keyword\">to</span> readonly;    - 赋予readonly对public模式下之后对postgres用户新建的序列可读<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"创建读写角色\"><a href=\"#创建读写角色\" class=\"headerlink\" title=\"创建读写角色\"></a>创建读写角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# grant all on SCHEMA public <span class=\"hljs-keyword\">to</span> readwrite ;            -- 赋予readwrite对public模式下当前存在的表可读写<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL  on ALL tables <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL on ALL sequences <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL on ALL functions <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant all on tables <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant all on sequences <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant all on functions <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"readonly-权限测试\"><a href=\"#readonly-权限测试\" class=\"headerlink\" title=\"readonly 权限测试\"></a>readonly 权限测试</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">user</span> user1;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>                    ^<br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">grant</span> readonly <span class=\"hljs-keyword\">to</span> user1 ;<br><span class=\"hljs-keyword\">GRANT</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span> test1<br>mydb=&gt; <br>mydb=# <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">into</span> test2;<br><span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test2;<br> ?<span class=\"hljs-keyword\">column</span>? <br><span class=\"hljs-comment\">----------</span><br>        <span class=\"hljs-number\">2</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">3</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span> test2<br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>\n<h1 id=\"readwrite权限测试\"><a href=\"#readwrite权限测试\" class=\"headerlink\" title=\"readwrite权限测试\"></a>readwrite权限测试</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">user</span> user2;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>                    ^<br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">grant</span> readwrite <span class=\"hljs-keyword\">to</span> user2;<br><span class=\"hljs-keyword\">GRANT</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test3(id <span class=\"hljs-type\">int</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test3;<br> id <br><span class=\"hljs-comment\">----</span><br>(<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">rows</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test3 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>PostgreSQL中role是权限的集合，没有区分用户和角色的概念，”CREATE USER” 为 “CREATE ROLE” 的别名，这两个命令几乎是完全相同的,唯一的区别是”CREATE USER” 命令创建的用户默认带有LOGIN属性，而”CREATE ROLE” 命令创建的用户默认不带LOGIN属性(CREATE USER is equivalent to CREATE ROLE except that CREATE USER assumes LOGIN by default, while CREATE ROLE does not)</p>\n<p>为了方便用role的方式管理用户， 而不是每新建一个用户就授予权限一次.</p>","more":"<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><p>收回PUBLIC用户组对模式public的所有权限， 并创建测试用表</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">jintao@jintao-ThinkPad-L490:~$ psql <br>psql (<span class=\"hljs-number\">14</span>devel)<br><span class=\"hljs-keyword\">Type</span> &quot;help&quot; <span class=\"hljs-keyword\">for</span> help.<br><br>mydb=# <span class=\"hljs-keyword\">revoke</span> <span class=\"hljs-keyword\">ALL</span> <span class=\"hljs-keyword\">on</span> <span class=\"hljs-keyword\">SCHEMA</span> <span class=\"hljs-built_in\">public</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">PUBLIC</span>;<br><span class=\"hljs-keyword\">REVOKE</span><br>mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test1(id <span class=\"hljs-type\">int</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>mydb=# <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=# <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=# <br><br></code></pre></td></tr></table></figure>\n<h1 id=\"创建只读角色\"><a href=\"#创建只读角色\" class=\"headerlink\" title=\"创建只读角色\"></a>创建只读角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# create role readonly;                                                 <br>CREATE ROLE<br><span class=\"hljs-attribute\">mydb</span>=# grant SELECT on ALL tables <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;    -- 赋予readonly对public模式下当前存在的表可读<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant EXECUTE on ALL functions <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;    -- 赋予readonly对public模式下当前函数可执行<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant SELECT on ALL sequences <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readonly ;      -- 赋予readonly对public模式下当前序列的可读<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant select on tables <span class=\"hljs-keyword\">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的表可读<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant execute on functions <span class=\"hljs-keyword\">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的函数可执行<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant select on sequences <span class=\"hljs-keyword\">to</span> readonly;    - 赋予readonly对public模式下之后对postgres用户新建的序列可读<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"创建读写角色\"><a href=\"#创建读写角色\" class=\"headerlink\" title=\"创建读写角色\"></a>创建读写角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# grant all on SCHEMA public <span class=\"hljs-keyword\">to</span> readwrite ;            -- 赋予readwrite对public模式下当前存在的表可读写<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL  on ALL tables <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL on ALL sequences <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# grant ALL on ALL functions <span class=\"hljs-keyword\">in</span> schema public <span class=\"hljs-keyword\">to</span> readwrite ;<br>GRANT<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres  <span class=\"hljs-keyword\">in</span> schema public grant all on tables <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant all on sequences <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><span class=\"hljs-attribute\">mydb</span>=# alter<span class=\"hljs-built_in\"> default </span>privileges <span class=\"hljs-keyword\">for</span> role postgres <span class=\"hljs-keyword\">in</span> schema public grant all on functions <span class=\"hljs-keyword\">to</span> readwrite;<br>ALTER<span class=\"hljs-built_in\"> DEFAULT </span>PRIVILEGES<br><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"readonly-权限测试\"><a href=\"#readonly-权限测试\" class=\"headerlink\" title=\"readonly 权限测试\"></a>readonly 权限测试</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">user</span> user1;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>                    ^<br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">grant</span> readonly <span class=\"hljs-keyword\">to</span> user1 ;<br><span class=\"hljs-keyword\">GRANT</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test1 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span> test1<br>mydb=&gt; <br>mydb=# <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-keyword\">into</span> test2;<br><span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user1;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test2;<br> ?<span class=\"hljs-keyword\">column</span>? <br><span class=\"hljs-comment\">----------</span><br>        <span class=\"hljs-number\">2</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">3</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">table</span> test2<br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>\n<h1 id=\"readwrite权限测试\"><a href=\"#readwrite权限测试\" class=\"headerlink\" title=\"readwrite权限测试\"></a>readwrite权限测试</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">user</span> user2;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>ERROR:  permission denied <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">schema</span> <span class=\"hljs-built_in\">public</span><br><span class=\"hljs-type\">LINE</span> <span class=\"hljs-number\">1</span>: <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br>                    ^<br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">grant</span> readwrite <span class=\"hljs-keyword\">to</span> user2;<br><span class=\"hljs-keyword\">GRANT</span> <span class=\"hljs-keyword\">ROLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> <span class=\"hljs-built_in\">public</span>.test1;<br> id <br><span class=\"hljs-comment\">----</span><br>  <span class=\"hljs-number\">1</span><br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> <span class=\"hljs-built_in\">public</span>.test2 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">2</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=&gt; <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> postgres;<br><span class=\"hljs-keyword\">SET</span><br>mydb=# <span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">table</span> test3(id <span class=\"hljs-type\">int</span>);<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>mydb=# <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">role</span> user2;<br><span class=\"hljs-keyword\">SET</span><br>mydb=&gt; <span class=\"hljs-keyword\">select</span> * <span class=\"hljs-keyword\">from</span> test3;<br> id <br><span class=\"hljs-comment\">----</span><br>(<span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">rows</span>)<br><br>mydb=&gt; <span class=\"hljs-keyword\">insert</span> <span class=\"hljs-keyword\">into</span> test3 <span class=\"hljs-keyword\">select</span> <span class=\"hljs-number\">1</span>;<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span><br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>"},{"title":"利用PostgreSQL LATERAL完成行列转换","date":"2020-08-04T16:00:00.000Z","top":1,"password":null,"_content":"\n利用PostgreSQL LATERAL完成行列转换.\n\n<!-- more -->\n\n# 需求\n```\n原始表数据如下：\n\nname| English | Physics | Math\n------+---------+---------+------\nSimon |      90 |      76 |   79\nLucy  |     100 |      90 |   85\nLily  |      95 |      81 |   84\nDavid |     100 |      86 |   89\n\n转换为\n  name  | subject | score\n--------+---------+-------\n Simon  | english |    90\n Simon  | physics |    76\n Simon  | math    |    79\n Lucy   | english |   100\n Lucy   | physics |    90\n Lucy   | math    |    85\n Lily   | english |    95\n Lily   | physics |    81\n Lily   | math    |    84\n David  | english |   100\n David  | physics |    86\n David  | math    |    89\n```\n\n# 测试\n```\ncreate table test(name text, english int, physics int, math int);\n\\copy test from stdin with delimiter '|'\n Simon  |      90 |      76 |   79\n Lucy   |     100 |      90 |   85\n Lily   |      95 |      81 |   84\n David  |     100 |      86 |   89\n\\.\n```\n\n# 使用union all\n```\nmydb=# explain analyze  select name, max(english) from test group by name union all select name, max(physics) from test group by name union all select name, max(math) from test group by name;\n                                                      QUERY PLAN\n----------------------------------------------------------------------------------------------------------------------\n Append  (cost=78.10..249.30 rows=600 width=36) (actual time=0.071..0.151 rows=12 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.069..0.078 rows=4 loops=1)\n         Group Key: test.name\n         ->  Seq Scan on test  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.029..0.033 rows=4 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.027..0.035 rows=4 loops=1)\n         Group Key: test_1.name\n         ->  Seq Scan on test test_1  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.009..0.012 rows=4 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.022..0.029 rows=4 loops=1)\n         Group Key: test_2.name\n         ->  Seq Scan on test test_2  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.007..0.010 rows=4 loops=1)\n Planning Time: 0.511 ms\n Execution Time: 0.378 ms\n(12 rows)\n\nmydb=#\n```\n\n# 自连接\n```\nmydb=# explain analyze SELECT t.name,s.* from test t JOIN LATERAL(VALUES('english',t.english ), ('physics',t.physics), ('math',t.math)) s(subject, score) on true;\n                                                  QUERY PLAN\n--------------------------------------------------------------------------------------------------------------\n Nested Loop  (cost=0.00..361.85 rows=13620 width=68) (actual time=0.038..0.073 rows=12 loops=1)\n   ->  Seq Scan on test t  (cost=0.00..55.40 rows=4540 width=44) (actual time=0.021..0.025 rows=4 loops=1)\n   ->  Values Scan on \"*VALUES*\"  (cost=0.00..0.04 rows=3 width=36) (actual time=0.003..0.007 rows=3 loops=4)\n Planning Time: 0.209 ms\n Execution Time: 0.128 ms\n(5 rows)\n```\n","source":"_posts/PostgreSQL行列转换.md","raw":"---\ntitle: 利用PostgreSQL LATERAL完成行列转换 \ndate: 2020-08-05\ntags: \n- PostgreSQL\n- 行列转换\n- LATERAL\n- 自连接\ncategories: PostgreSQL\ntop: 1\npassword: \n\n---\n\n利用PostgreSQL LATERAL完成行列转换.\n\n<!-- more -->\n\n# 需求\n```\n原始表数据如下：\n\nname| English | Physics | Math\n------+---------+---------+------\nSimon |      90 |      76 |   79\nLucy  |     100 |      90 |   85\nLily  |      95 |      81 |   84\nDavid |     100 |      86 |   89\n\n转换为\n  name  | subject | score\n--------+---------+-------\n Simon  | english |    90\n Simon  | physics |    76\n Simon  | math    |    79\n Lucy   | english |   100\n Lucy   | physics |    90\n Lucy   | math    |    85\n Lily   | english |    95\n Lily   | physics |    81\n Lily   | math    |    84\n David  | english |   100\n David  | physics |    86\n David  | math    |    89\n```\n\n# 测试\n```\ncreate table test(name text, english int, physics int, math int);\n\\copy test from stdin with delimiter '|'\n Simon  |      90 |      76 |   79\n Lucy   |     100 |      90 |   85\n Lily   |      95 |      81 |   84\n David  |     100 |      86 |   89\n\\.\n```\n\n# 使用union all\n```\nmydb=# explain analyze  select name, max(english) from test group by name union all select name, max(physics) from test group by name union all select name, max(math) from test group by name;\n                                                      QUERY PLAN\n----------------------------------------------------------------------------------------------------------------------\n Append  (cost=78.10..249.30 rows=600 width=36) (actual time=0.071..0.151 rows=12 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.069..0.078 rows=4 loops=1)\n         Group Key: test.name\n         ->  Seq Scan on test  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.029..0.033 rows=4 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.027..0.035 rows=4 loops=1)\n         Group Key: test_1.name\n         ->  Seq Scan on test test_1  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.009..0.012 rows=4 loops=1)\n   ->  HashAggregate  (cost=78.10..80.10 rows=200 width=36) (actual time=0.022..0.029 rows=4 loops=1)\n         Group Key: test_2.name\n         ->  Seq Scan on test test_2  (cost=0.00..55.40 rows=4540 width=36) (actual time=0.007..0.010 rows=4 loops=1)\n Planning Time: 0.511 ms\n Execution Time: 0.378 ms\n(12 rows)\n\nmydb=#\n```\n\n# 自连接\n```\nmydb=# explain analyze SELECT t.name,s.* from test t JOIN LATERAL(VALUES('english',t.english ), ('physics',t.physics), ('math',t.math)) s(subject, score) on true;\n                                                  QUERY PLAN\n--------------------------------------------------------------------------------------------------------------\n Nested Loop  (cost=0.00..361.85 rows=13620 width=68) (actual time=0.038..0.073 rows=12 loops=1)\n   ->  Seq Scan on test t  (cost=0.00..55.40 rows=4540 width=44) (actual time=0.021..0.025 rows=4 loops=1)\n   ->  Values Scan on \"*VALUES*\"  (cost=0.00..0.04 rows=3 width=36) (actual time=0.003..0.007 rows=3 loops=4)\n Planning Time: 0.209 ms\n Execution Time: 0.128 ms\n(5 rows)\n```\n","slug":"PostgreSQL行列转换","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhh000mpieb2wfkh6h4","content":"<p>利用PostgreSQL LATERAL完成行列转换.</p>\n<a id=\"more\"></a>\n<h1 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h1><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs coq\">原始表数据如下：<br><br>name| <span class=\"hljs-type\">English</span> | <span class=\"hljs-type\">Physics</span> | <span class=\"hljs-type\">Math</span><br>------+---------+---------+------<br>Simon |      <span class=\"hljs-type\">90</span> |      <span class=\"hljs-type\">76</span> |   <span class=\"hljs-type\">79</span><br>Lucy  |     <span class=\"hljs-type\">100</span> |      <span class=\"hljs-type\">90</span> |   <span class=\"hljs-type\">85</span><br>Lily  |      <span class=\"hljs-type\">95</span> |      <span class=\"hljs-type\">81</span> |   <span class=\"hljs-type\">84</span><br>David |     <span class=\"hljs-type\">100</span> |      <span class=\"hljs-type\">86</span> |   <span class=\"hljs-type\">89</span><br><br>转换为<br>  name  | <span class=\"hljs-type\">subject</span> | <span class=\"hljs-type\">score</span><br>--------+---------+-------<br> Simon  | <span class=\"hljs-type\">english</span> |    <span class=\"hljs-type\">90</span><br> Simon  | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">76</span><br> Simon  | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">79</span><br> Lucy   | <span class=\"hljs-type\">english</span> |   <span class=\"hljs-type\">100</span><br> Lucy   | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">90</span><br> Lucy   | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">85</span><br> Lily   | <span class=\"hljs-type\">english</span> |    <span class=\"hljs-type\">95</span><br> Lily   | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">81</span><br> Lily   | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">84</span><br> David  | <span class=\"hljs-type\">english</span> |   <span class=\"hljs-type\">100</span><br> David  | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">86</span><br> David  | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">89</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">create table test(name text, english <span class=\"hljs-built_in\">int</span>, physics <span class=\"hljs-built_in\">int</span>, math <span class=\"hljs-built_in\">int</span>);<br>\\copy test <span class=\"hljs-keyword\">from</span> stdin with delimiter <span class=\"hljs-string\">&#x27;|&#x27;</span><br> Simon  |      <span class=\"hljs-number\">90</span> |      <span class=\"hljs-number\">76</span> |   <span class=\"hljs-number\">79</span><br> Lucy   |     <span class=\"hljs-number\">100</span> |      <span class=\"hljs-number\">90</span> |   <span class=\"hljs-number\">85</span><br> Lily   |      <span class=\"hljs-number\">95</span> |      <span class=\"hljs-number\">81</span> |   <span class=\"hljs-number\">84</span><br> David  |     <span class=\"hljs-number\">100</span> |      <span class=\"hljs-number\">86</span> |   <span class=\"hljs-number\">89</span><br>\\.<br></code></pre></td></tr></table></figure>\n<h1 id=\"使用union-all\"><a href=\"#使用union-all\" class=\"headerlink\" title=\"使用union all\"></a>使用union all</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# explain analyze  select name, max(english) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name union all select name, max(physics) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name union all select name, max(math) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name;<br>                                                      QUERY PLAN<br>----------------------------------------------------------------------------------------------------------------------<br> Append  (<span class=\"hljs-attribute\">cost</span>=78.10..249.30 <span class=\"hljs-attribute\">rows</span>=600 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.071..0.151 <span class=\"hljs-attribute\">rows</span>=12 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.069..0.078 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test.name<br>         -&gt;  Seq Scan on test  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.029..0.033 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.027..0.035 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test_1.name<br>         -&gt;  Seq Scan on test test_1  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.009..0.012 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.022..0.029 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test_2.name<br>         -&gt;  Seq Scan on test test_2  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.007..0.010 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br> Planning Time: 0.511 ms<br> Execution Time: 0.378 ms<br>(12 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br></code></pre></td></tr></table></figure>\n<h1 id=\"自连接\"><a href=\"#自连接\" class=\"headerlink\" title=\"自连接\"></a>自连接</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# explain analyze SELECT t.name,s.* <span class=\"hljs-keyword\">from</span> test t JOIN LATERAL(VALUES(<span class=\"hljs-string\">&#x27;english&#x27;</span>,t.english ), (<span class=\"hljs-string\">&#x27;physics&#x27;</span>,t.physics), (<span class=\"hljs-string\">&#x27;math&#x27;</span>,t.math)) s(subject, score) on <span class=\"hljs-literal\">true</span>;<br>                                                  QUERY PLAN<br>--------------------------------------------------------------------------------------------------------------<br> Nested Loop  (<span class=\"hljs-attribute\">cost</span>=0.00..361.85 <span class=\"hljs-attribute\">rows</span>=13620 <span class=\"hljs-attribute\">width</span>=68) (actual <span class=\"hljs-attribute\">time</span>=0.038..0.073 <span class=\"hljs-attribute\">rows</span>=12 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  Seq Scan on test t  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=44) (actual <span class=\"hljs-attribute\">time</span>=0.021..0.025 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  Values Scan on <span class=\"hljs-string\">&quot;*VALUES*&quot;</span>  (<span class=\"hljs-attribute\">cost</span>=0.00..0.04 <span class=\"hljs-attribute\">rows</span>=3 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.003..0.007 <span class=\"hljs-attribute\">rows</span>=3 <span class=\"hljs-attribute\">loops</span>=4)<br> Planning Time: 0.209 ms<br> Execution Time: 0.128 ms<br>(5 rows)<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>利用PostgreSQL LATERAL完成行列转换.</p>","more":"<h1 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h1><figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs coq\">原始表数据如下：<br><br>name| <span class=\"hljs-type\">English</span> | <span class=\"hljs-type\">Physics</span> | <span class=\"hljs-type\">Math</span><br>------+---------+---------+------<br>Simon |      <span class=\"hljs-type\">90</span> |      <span class=\"hljs-type\">76</span> |   <span class=\"hljs-type\">79</span><br>Lucy  |     <span class=\"hljs-type\">100</span> |      <span class=\"hljs-type\">90</span> |   <span class=\"hljs-type\">85</span><br>Lily  |      <span class=\"hljs-type\">95</span> |      <span class=\"hljs-type\">81</span> |   <span class=\"hljs-type\">84</span><br>David |     <span class=\"hljs-type\">100</span> |      <span class=\"hljs-type\">86</span> |   <span class=\"hljs-type\">89</span><br><br>转换为<br>  name  | <span class=\"hljs-type\">subject</span> | <span class=\"hljs-type\">score</span><br>--------+---------+-------<br> Simon  | <span class=\"hljs-type\">english</span> |    <span class=\"hljs-type\">90</span><br> Simon  | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">76</span><br> Simon  | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">79</span><br> Lucy   | <span class=\"hljs-type\">english</span> |   <span class=\"hljs-type\">100</span><br> Lucy   | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">90</span><br> Lucy   | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">85</span><br> Lily   | <span class=\"hljs-type\">english</span> |    <span class=\"hljs-type\">95</span><br> Lily   | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">81</span><br> Lily   | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">84</span><br> David  | <span class=\"hljs-type\">english</span> |   <span class=\"hljs-type\">100</span><br> David  | <span class=\"hljs-type\">physics</span> |    <span class=\"hljs-type\">86</span><br> David  | <span class=\"hljs-type\">math</span>    |    <span class=\"hljs-type\">89</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">create table test(name text, english <span class=\"hljs-built_in\">int</span>, physics <span class=\"hljs-built_in\">int</span>, math <span class=\"hljs-built_in\">int</span>);<br>\\copy test <span class=\"hljs-keyword\">from</span> stdin with delimiter <span class=\"hljs-string\">&#x27;|&#x27;</span><br> Simon  |      <span class=\"hljs-number\">90</span> |      <span class=\"hljs-number\">76</span> |   <span class=\"hljs-number\">79</span><br> Lucy   |     <span class=\"hljs-number\">100</span> |      <span class=\"hljs-number\">90</span> |   <span class=\"hljs-number\">85</span><br> Lily   |      <span class=\"hljs-number\">95</span> |      <span class=\"hljs-number\">81</span> |   <span class=\"hljs-number\">84</span><br> David  |     <span class=\"hljs-number\">100</span> |      <span class=\"hljs-number\">86</span> |   <span class=\"hljs-number\">89</span><br>\\.<br></code></pre></td></tr></table></figure>\n<h1 id=\"使用union-all\"><a href=\"#使用union-all\" class=\"headerlink\" title=\"使用union all\"></a>使用union all</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# explain analyze  select name, max(english) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name union all select name, max(physics) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name union all select name, max(math) <span class=\"hljs-keyword\">from</span> test<span class=\"hljs-built_in\"> group </span>by name;<br>                                                      QUERY PLAN<br>----------------------------------------------------------------------------------------------------------------------<br> Append  (<span class=\"hljs-attribute\">cost</span>=78.10..249.30 <span class=\"hljs-attribute\">rows</span>=600 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.071..0.151 <span class=\"hljs-attribute\">rows</span>=12 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.069..0.078 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test.name<br>         -&gt;  Seq Scan on test  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.029..0.033 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.027..0.035 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test_1.name<br>         -&gt;  Seq Scan on test test_1  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.009..0.012 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class=\"hljs-attribute\">cost</span>=78.10..80.10 <span class=\"hljs-attribute\">rows</span>=200 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.022..0.029 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>        <span class=\"hljs-built_in\"> Group </span>Key: test_2.name<br>         -&gt;  Seq Scan on test test_2  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.007..0.010 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br> Planning Time: 0.511 ms<br> Execution Time: 0.378 ms<br>(12 rows)<br><br><span class=\"hljs-attribute\">mydb</span>=#<br></code></pre></td></tr></table></figure>\n<h1 id=\"自连接\"><a href=\"#自连接\" class=\"headerlink\" title=\"自连接\"></a>自连接</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">mydb</span>=# explain analyze SELECT t.name,s.* <span class=\"hljs-keyword\">from</span> test t JOIN LATERAL(VALUES(<span class=\"hljs-string\">&#x27;english&#x27;</span>,t.english ), (<span class=\"hljs-string\">&#x27;physics&#x27;</span>,t.physics), (<span class=\"hljs-string\">&#x27;math&#x27;</span>,t.math)) s(subject, score) on <span class=\"hljs-literal\">true</span>;<br>                                                  QUERY PLAN<br>--------------------------------------------------------------------------------------------------------------<br> Nested Loop  (<span class=\"hljs-attribute\">cost</span>=0.00..361.85 <span class=\"hljs-attribute\">rows</span>=13620 <span class=\"hljs-attribute\">width</span>=68) (actual <span class=\"hljs-attribute\">time</span>=0.038..0.073 <span class=\"hljs-attribute\">rows</span>=12 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  Seq Scan on test t  (<span class=\"hljs-attribute\">cost</span>=0.00..55.40 <span class=\"hljs-attribute\">rows</span>=4540 <span class=\"hljs-attribute\">width</span>=44) (actual <span class=\"hljs-attribute\">time</span>=0.021..0.025 <span class=\"hljs-attribute\">rows</span>=4 <span class=\"hljs-attribute\">loops</span>=1)<br>   -&gt;  Values Scan on <span class=\"hljs-string\">&quot;*VALUES*&quot;</span>  (<span class=\"hljs-attribute\">cost</span>=0.00..0.04 <span class=\"hljs-attribute\">rows</span>=3 <span class=\"hljs-attribute\">width</span>=36) (actual <span class=\"hljs-attribute\">time</span>=0.003..0.007 <span class=\"hljs-attribute\">rows</span>=3 <span class=\"hljs-attribute\">loops</span>=4)<br> Planning Time: 0.209 ms<br> Execution Time: 0.128 ms<br>(5 rows)<br></code></pre></td></tr></table></figure>"},{"title":"Python小技巧","date":"2020-08-04T16:00:00.000Z","top":11,"description":"列举一些python使用过程中用到的小技巧.","password":null,"_content":"\n记录一些工作中用到的python小技巧.\n\n<!-- more -->\n\n# list中dict按某一列排序\n```Python\n>>> from operator import itemgetter\n>>>\n>>> sorted(result, key=itemgetter('b'), reverse=True)\n[{'c': 1, 'a': 2, 'b': 5}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 9, 'b': 0}]\n>>> sorted(result, key=itemgetter('b'))\n[{'c': 5, 'a': 9, 'b': 0}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 2, 'b': 5}]\n>>> sorted(result, key=itemgetter('b'))\n[{'c': 5, 'a': 9, 'b': 0}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 2, 'b': 5}]\n>>>\n```\n\n# 两个list生成dict\n```Python\n>>> list1=[\"a\",\"b\",\"c\",\"d\"]\n>>> list2=[1,2,3,4]\n>>>\n>>> dict(zip(list1, list2))\n{'c': 3, 'd': 4, 'a': 1, 'b': 2}\n>>>\n>>> dict(zip(list2, list1))\n{1: 'a', 2: 'b', 3: 'c', 4: 'd'}\n>>>\n>>> list1=[\"a\",\"b\",\"c\",\"d\"]\n>>> list2=[1,2,3,4,5]\n>>>\n>>> dict(zip(list2, list1))\n{1: 'a', 2: 'b', 3: 'c', 4: 'd'}\n>>>\n>>> dict(zip(list1, list2))\n{'c': 3, 'd': 4, 'a': 1, 'b': 2}\n>>>\n\n```\n\n# List去重\n## 方法1\n```Python\n>>> list1 = [2, 1, 3, 4, 1]\n>>> list(set(list1))\n```\n\n## 方法2\n```\n>>> list1 = [2, 1, 3, 4, 1]\n>>> {}.fromkeys(list1).keys()\ndict_keys([2, 1, 3, 4])\n```\n## 方法3\n```\n>>> list1 = [2, 1, 3, 4, 1]\n>>> {}.fromkeys(list1).keys()\ndict_keys([2, 1, 3, 4])\n>>> sorted(set(list1), key=list1.index)\n[2, 1, 3, 4]\n>>> sorted(set(list1))\n[1, 2, 3, 4]\n```\n\n# List删除重复项\n```\n>>> # 方法一:\n>>> list1 = [2, 1, 3, 4, 1]\n>>> [item for item in list1 if list1.count(item) == 1]\n[2, 3, 4]\n>>> # 方法二:\n>>> list1 = [2, 1, 3, 4, 1]\n>>> list(filter(lambda x:list1.count(x) == 1, list1))\n[2, 3, 4]\n```\n\n","source":"_posts/Python小技巧.md","raw":"---\ntitle: Python小技巧 \ndate: 2020-08-05\ntags: python\ncategories: python\ntop: 11\ndescription: 列举一些python使用过程中用到的小技巧.\npassword: \n\n---\n\n记录一些工作中用到的python小技巧.\n\n<!-- more -->\n\n# list中dict按某一列排序\n```Python\n>>> from operator import itemgetter\n>>>\n>>> sorted(result, key=itemgetter('b'), reverse=True)\n[{'c': 1, 'a': 2, 'b': 5}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 9, 'b': 0}]\n>>> sorted(result, key=itemgetter('b'))\n[{'c': 5, 'a': 9, 'b': 0}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 2, 'b': 5}]\n>>> sorted(result, key=itemgetter('b'))\n[{'c': 5, 'a': 9, 'b': 0}, {'c': 1, 'a': 1, 'b': 1}, {'c': 5, 'a': 3, 'b': 4}, {'c': 1, 'a': 2, 'b': 5}]\n>>>\n```\n\n# 两个list生成dict\n```Python\n>>> list1=[\"a\",\"b\",\"c\",\"d\"]\n>>> list2=[1,2,3,4]\n>>>\n>>> dict(zip(list1, list2))\n{'c': 3, 'd': 4, 'a': 1, 'b': 2}\n>>>\n>>> dict(zip(list2, list1))\n{1: 'a', 2: 'b', 3: 'c', 4: 'd'}\n>>>\n>>> list1=[\"a\",\"b\",\"c\",\"d\"]\n>>> list2=[1,2,3,4,5]\n>>>\n>>> dict(zip(list2, list1))\n{1: 'a', 2: 'b', 3: 'c', 4: 'd'}\n>>>\n>>> dict(zip(list1, list2))\n{'c': 3, 'd': 4, 'a': 1, 'b': 2}\n>>>\n\n```\n\n# List去重\n## 方法1\n```Python\n>>> list1 = [2, 1, 3, 4, 1]\n>>> list(set(list1))\n```\n\n## 方法2\n```\n>>> list1 = [2, 1, 3, 4, 1]\n>>> {}.fromkeys(list1).keys()\ndict_keys([2, 1, 3, 4])\n```\n## 方法3\n```\n>>> list1 = [2, 1, 3, 4, 1]\n>>> {}.fromkeys(list1).keys()\ndict_keys([2, 1, 3, 4])\n>>> sorted(set(list1), key=list1.index)\n[2, 1, 3, 4]\n>>> sorted(set(list1))\n[1, 2, 3, 4]\n```\n\n# List删除重复项\n```\n>>> # 方法一:\n>>> list1 = [2, 1, 3, 4, 1]\n>>> [item for item in list1 if list1.count(item) == 1]\n[2, 3, 4]\n>>> # 方法二:\n>>> list1 = [2, 1, 3, 4, 1]\n>>> list(filter(lambda x:list1.count(x) == 1, list1))\n[2, 3, 4]\n```\n\n","slug":"Python小技巧","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhi000ppieb6unphkrg","content":"<p>记录一些工作中用到的python小技巧.</p>\n<a id=\"more\"></a>\n<h1 id=\"list中dict按某一列排序\"><a href=\"#list中dict按某一列排序\" class=\"headerlink\" title=\"list中dict按某一列排序\"></a>list中dict按某一列排序</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span><span class=\"hljs-keyword\">from</span> operator <span class=\"hljs-keyword\">import</span> itemgetter<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>), reverse=<span class=\"hljs-literal\">True</span>)<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>))<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>))<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;]<br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure>\n<h1 id=\"两个list生成dict\"><a href=\"#两个list生成dict\" class=\"headerlink\" title=\"两个list生成dict\"></a>两个list生成dict</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1=[<span class=\"hljs-string\">&quot;a&quot;</span>,<span class=\"hljs-string\">&quot;b&quot;</span>,<span class=\"hljs-string\">&quot;c&quot;</span>,<span class=\"hljs-string\">&quot;d&quot;</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list2=[<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>]<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;d&#x27;</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">2</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class=\"hljs-number\">1</span>: <span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-number\">2</span>: <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-number\">3</span>: <span class=\"hljs-string\">&#x27;c&#x27;</span>, <span class=\"hljs-number\">4</span>: <span class=\"hljs-string\">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1=[<span class=\"hljs-string\">&quot;a&quot;</span>,<span class=\"hljs-string\">&quot;b&quot;</span>,<span class=\"hljs-string\">&quot;c&quot;</span>,<span class=\"hljs-string\">&quot;d&quot;</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list2=[<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>]<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class=\"hljs-number\">1</span>: <span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-number\">2</span>: <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-number\">3</span>: <span class=\"hljs-string\">&#x27;c&#x27;</span>, <span class=\"hljs-number\">4</span>: <span class=\"hljs-string\">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;d&#x27;</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">2</span>&#125;<br>&gt;&gt;&gt;<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"List去重\"><a href=\"#List去重\" class=\"headerlink\" title=\"List去重\"></a>List去重</h1><h2 id=\"方法1\"><a href=\"#方法1\" class=\"headerlink\" title=\"方法1\"></a>方法1</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list(set(list1))<br></code></pre></td></tr></table></figure>\n<h2 id=\"方法2\"><a href=\"#方法2\" class=\"headerlink\" title=\"方法2\"></a>方法2</h2><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">&gt;&gt;&gt; list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br>&gt;&gt;&gt; &#123;&#125;.fromkeys(list1).keys()<br>dict_keys([<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>])<br></code></pre></td></tr></table></figure>\n<h2 id=\"方法3\"><a href=\"#方法3\" class=\"headerlink\" title=\"方法3\"></a>方法3</h2><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">&gt;&gt;&gt; list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br>&gt;&gt;&gt; &#123;&#125;.fromkeys(list1).keys()<br>dict_keys([<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>])<br>&gt;&gt;&gt; sorted(set(list1), <span class=\"hljs-type\">key</span>=list1.index)<br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br>&gt;&gt;&gt; sorted(set(list1))<br>[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br></code></pre></td></tr></table></figure>\n<h1 id=\"List删除重复项\"><a href=\"#List删除重复项\" class=\"headerlink\" title=\"List删除重复项\"></a>List删除重复项</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-comment\"># 方法一:</span><br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">=</span> [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> [<span class=\"hljs-string\">item</span> <span class=\"hljs-string\">for</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">if</span> <span class=\"hljs-string\">list1.count(item)</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">1</span>]<br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-comment\"># 方法二:</span><br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">=</span> [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list(filter(lambda</span> <span class=\"hljs-string\">x:list1.count(x)</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">1</span><span class=\"hljs-string\">,</span> <span class=\"hljs-string\">list1))</span><br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>记录一些工作中用到的python小技巧.</p>","more":"<h1 id=\"list中dict按某一列排序\"><a href=\"#list中dict按某一列排序\" class=\"headerlink\" title=\"list中dict按某一列排序\"></a>list中dict按某一列排序</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span><span class=\"hljs-keyword\">from</span> operator <span class=\"hljs-keyword\">import</span> itemgetter<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>), reverse=<span class=\"hljs-literal\">True</span>)<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>))<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class=\"hljs-string\">&#x27;b&#x27;</span>))<br>[&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">0</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">1</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">4</span>&#125;, &#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">5</span>&#125;]<br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure>\n<h1 id=\"两个list生成dict\"><a href=\"#两个list生成dict\" class=\"headerlink\" title=\"两个list生成dict\"></a>两个list生成dict</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1=[<span class=\"hljs-string\">&quot;a&quot;</span>,<span class=\"hljs-string\">&quot;b&quot;</span>,<span class=\"hljs-string\">&quot;c&quot;</span>,<span class=\"hljs-string\">&quot;d&quot;</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list2=[<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>]<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;d&#x27;</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">2</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class=\"hljs-number\">1</span>: <span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-number\">2</span>: <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-number\">3</span>: <span class=\"hljs-string\">&#x27;c&#x27;</span>, <span class=\"hljs-number\">4</span>: <span class=\"hljs-string\">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1=[<span class=\"hljs-string\">&quot;a&quot;</span>,<span class=\"hljs-string\">&quot;b&quot;</span>,<span class=\"hljs-string\">&quot;c&quot;</span>,<span class=\"hljs-string\">&quot;d&quot;</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list2=[<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">4</span>,<span class=\"hljs-number\">5</span>]<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class=\"hljs-number\">1</span>: <span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-number\">2</span>: <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-number\">3</span>: <span class=\"hljs-string\">&#x27;c&#x27;</span>, <span class=\"hljs-number\">4</span>: <span class=\"hljs-string\">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class=\"hljs-string\">&#x27;c&#x27;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&#x27;d&#x27;</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>: <span class=\"hljs-number\">2</span>&#125;<br>&gt;&gt;&gt;<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"List去重\"><a href=\"#List去重\" class=\"headerlink\" title=\"List去重\"></a>List去重</h1><h2 id=\"方法1\"><a href=\"#方法1\" class=\"headerlink\" title=\"方法1\"></a>方法1</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Python\"><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-meta\">&gt;&gt;&gt; </span>list(set(list1))<br></code></pre></td></tr></table></figure>\n<h2 id=\"方法2\"><a href=\"#方法2\" class=\"headerlink\" title=\"方法2\"></a>方法2</h2><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">&gt;&gt;&gt; list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br>&gt;&gt;&gt; &#123;&#125;.fromkeys(list1).keys()<br>dict_keys([<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>])<br></code></pre></td></tr></table></figure>\n<h2 id=\"方法3\"><a href=\"#方法3\" class=\"headerlink\" title=\"方法3\"></a>方法3</h2><figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lsl\">&gt;&gt;&gt; list1 = [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br>&gt;&gt;&gt; &#123;&#125;.fromkeys(list1).keys()<br>dict_keys([<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>])<br>&gt;&gt;&gt; sorted(set(list1), <span class=\"hljs-type\">key</span>=list1.index)<br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br>&gt;&gt;&gt; sorted(set(list1))<br>[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br></code></pre></td></tr></table></figure>\n<h1 id=\"List删除重复项\"><a href=\"#List删除重复项\" class=\"headerlink\" title=\"List删除重复项\"></a>List删除重复项</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-comment\"># 方法一:</span><br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">=</span> [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> [<span class=\"hljs-string\">item</span> <span class=\"hljs-string\">for</span> <span class=\"hljs-string\">item</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">if</span> <span class=\"hljs-string\">list1.count(item)</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">1</span>]<br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-comment\"># 方法二:</span><br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list1</span> <span class=\"hljs-string\">=</span> [<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>]<br><span class=\"hljs-string\">&gt;&gt;&gt;</span> <span class=\"hljs-string\">list(filter(lambda</span> <span class=\"hljs-string\">x:list1.count(x)</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-number\">1</span><span class=\"hljs-string\">,</span> <span class=\"hljs-string\">list1))</span><br>[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>]<br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL的两种统计信息","date":"2020-08-17T06:16:10.000Z","top":15,"description":null,"password":null,"_content":"\n时不时地，有人对重置PostgreSQL中的统计信息, 以及重置统计信息对执行计划和数据库其他部分的影响感到困惑。也许文档对此描述的会更清晰一些，但是对于那些以前从未在PostgreSQL中处理过统计信息的人来说无疑是令人困惑的。但这不仅是关于新手的问题-我在9.3中为该区域编写了一个补丁，而且我有时也会感到困惑。对于大多数用户而言，最令人惊讶的事实是“统计信息”实际上可能意味着两件事, 描述数据分布的统计信息，以及监视统计信息，跟踪有关数据库系统本身操作的计数器。每种都有不同的用途，存储方式也不同，丢失数据时的影响也大不相同。因此，让我们看看这两种统计数据的目的是什么，常见的问题是什么，当数据由于某种原因丢失时会发生什么。\n<!-- more -->\n\n# 数据分布统计信息\n\n第一种统计信息跟踪数据的分布-不同值的数量，列中最常见的值，数据的直方图等。\n这是规划查询时使用的信息, 用来解决以下问题:\n    - 有多少行符合条件？ （选择性估计）\n    - 联接产生多少行？ （选择性估计）\n    - 聚合需要多少内存？\n\n本质上，这些统计信息，决定了planner/optimizer使用了那一种最好的方式去执行。这种统计信息是由ANALYZE（或autovacuum）收集的，并存储在“常规”表中，并像常规数据一样受事务日志保护。检查pg_statistic系统目录，或者查看pg_stats，它是pg_statistic之上的视图，使统计信息更易于阅读。很多情况下会引发统计信息不准确，导致选择了较差的计划和糟糕的查询性能。发生这种情况的原因有多种（错误的统计信息，复杂的条件，相关的列...）\n\n据我所知，没有命令/函数可以重置此类统计信息，因为完全没有必要，不觉得可以通过删除此类统计信息来解决该任何问题。当然尝试使用简单的DELETE从目录中删除数据（但我从未尝试过）。\n\n# 监控统计信息\n\n另一种统计信息是被statistics collector进程收集的，文档中的第一段\n```\n    PostgreSQL's statistics collector is a subsystem that supports collection and reporting of information about server activity. \nPresently, the collector can count accesses to tables and indexes in both disk-block and individual-row terms. It also tracks the \ntotal number of rows in each table, and information about vacuum and analyze actions for each table. It can also count calls to \nuser-defined functions and the total time spent in each one.\n```\n\n因此，当您需要了解特定表的访问频率，是顺序读取表还是使用索引访问表等时，这就是统计信息收集器收集的统计信息。如果要查看此类统计信息，则有很多系统视图：\n\n```\n    pg_stat_activity\n    pg_stat_archiver\n    pg_stat_bgwriter\n    pg_stat_database\n    pg_stat_all_tables\n    pg_stat_sys_tables\n    ...\n    pg_statio_all_tables\n    pg_statio_sys_tables\n    pg_statio_user_tables\n    pg_statio_all_indexes\n    pg_statio_sys_indexes\n    ...\n```\n\n命名方案很明显（以pg_stat_或pg_statio_开头），其名称很不言而喻。例如，当您需要有关当前用户拥有的表的信息时，您可以转到pg_stat_user_tables或pg_statio_user_tables，这取决于您是否需要简单的统计信息（seq扫描，索引扫描的数量...）还是与IO相关的统计信息（数量读取的块数，点击率等）。对于与复制和数据库系统其他部分有关的其他对象（索引，函数等）和统计信息，也是如此。\n\n# 总结\n## 数据分布统计信息\n-  描述数据分布的统计数据，由ANALYZE / autovacuum收集\n-  planner/optimizer在规划查询时使用\n-  存储在数据库中，受WAL保护的常规表\n-  没有官方方法可以重置此类统计信息\n-  这些问题通常会导致选择错误的查询计划\n\n## 监控统计信息\n-  统计信息跟踪数据库系统本身的运行情况\n-  用于监视目的和autovacuum（以识别需要维护的对象)\n-  存储在数据库外部，二进制文件（pgstat.stat）或每个数据库文件的集合中（从9.3开始）\n-  这就是使用pg_stat_reset()重置的统计信息\n-  最常见的问题是pgstat.stat文件变大时（由于跟踪许多数据库对象), I/O负载较高\n-  重置统计信息不是解决方案-不会解决问题，并且会对autovacuum产生负面影响\n-  9.3之前的解决方案：将pgstat.stat文件移动到tmpfs文件系统，考虑升级到9.3\n","source":"_posts/The_two_kinds_of_stats_in_PostgreSQL.md","raw":"---\ntitle: PostgreSQL的两种统计信息 \ndate: 2020-08-17 14:16:10\ntags: \n- PostgreSQL\n- stat\ncategories: \n- PostgreSQL\ntop: 15\ndescription: \npassword: \n\n---\n\n时不时地，有人对重置PostgreSQL中的统计信息, 以及重置统计信息对执行计划和数据库其他部分的影响感到困惑。也许文档对此描述的会更清晰一些，但是对于那些以前从未在PostgreSQL中处理过统计信息的人来说无疑是令人困惑的。但这不仅是关于新手的问题-我在9.3中为该区域编写了一个补丁，而且我有时也会感到困惑。对于大多数用户而言，最令人惊讶的事实是“统计信息”实际上可能意味着两件事, 描述数据分布的统计信息，以及监视统计信息，跟踪有关数据库系统本身操作的计数器。每种都有不同的用途，存储方式也不同，丢失数据时的影响也大不相同。因此，让我们看看这两种统计数据的目的是什么，常见的问题是什么，当数据由于某种原因丢失时会发生什么。\n<!-- more -->\n\n# 数据分布统计信息\n\n第一种统计信息跟踪数据的分布-不同值的数量，列中最常见的值，数据的直方图等。\n这是规划查询时使用的信息, 用来解决以下问题:\n    - 有多少行符合条件？ （选择性估计）\n    - 联接产生多少行？ （选择性估计）\n    - 聚合需要多少内存？\n\n本质上，这些统计信息，决定了planner/optimizer使用了那一种最好的方式去执行。这种统计信息是由ANALYZE（或autovacuum）收集的，并存储在“常规”表中，并像常规数据一样受事务日志保护。检查pg_statistic系统目录，或者查看pg_stats，它是pg_statistic之上的视图，使统计信息更易于阅读。很多情况下会引发统计信息不准确，导致选择了较差的计划和糟糕的查询性能。发生这种情况的原因有多种（错误的统计信息，复杂的条件，相关的列...）\n\n据我所知，没有命令/函数可以重置此类统计信息，因为完全没有必要，不觉得可以通过删除此类统计信息来解决该任何问题。当然尝试使用简单的DELETE从目录中删除数据（但我从未尝试过）。\n\n# 监控统计信息\n\n另一种统计信息是被statistics collector进程收集的，文档中的第一段\n```\n    PostgreSQL's statistics collector is a subsystem that supports collection and reporting of information about server activity. \nPresently, the collector can count accesses to tables and indexes in both disk-block and individual-row terms. It also tracks the \ntotal number of rows in each table, and information about vacuum and analyze actions for each table. It can also count calls to \nuser-defined functions and the total time spent in each one.\n```\n\n因此，当您需要了解特定表的访问频率，是顺序读取表还是使用索引访问表等时，这就是统计信息收集器收集的统计信息。如果要查看此类统计信息，则有很多系统视图：\n\n```\n    pg_stat_activity\n    pg_stat_archiver\n    pg_stat_bgwriter\n    pg_stat_database\n    pg_stat_all_tables\n    pg_stat_sys_tables\n    ...\n    pg_statio_all_tables\n    pg_statio_sys_tables\n    pg_statio_user_tables\n    pg_statio_all_indexes\n    pg_statio_sys_indexes\n    ...\n```\n\n命名方案很明显（以pg_stat_或pg_statio_开头），其名称很不言而喻。例如，当您需要有关当前用户拥有的表的信息时，您可以转到pg_stat_user_tables或pg_statio_user_tables，这取决于您是否需要简单的统计信息（seq扫描，索引扫描的数量...）还是与IO相关的统计信息（数量读取的块数，点击率等）。对于与复制和数据库系统其他部分有关的其他对象（索引，函数等）和统计信息，也是如此。\n\n# 总结\n## 数据分布统计信息\n-  描述数据分布的统计数据，由ANALYZE / autovacuum收集\n-  planner/optimizer在规划查询时使用\n-  存储在数据库中，受WAL保护的常规表\n-  没有官方方法可以重置此类统计信息\n-  这些问题通常会导致选择错误的查询计划\n\n## 监控统计信息\n-  统计信息跟踪数据库系统本身的运行情况\n-  用于监视目的和autovacuum（以识别需要维护的对象)\n-  存储在数据库外部，二进制文件（pgstat.stat）或每个数据库文件的集合中（从9.3开始）\n-  这就是使用pg_stat_reset()重置的统计信息\n-  最常见的问题是pgstat.stat文件变大时（由于跟踪许多数据库对象), I/O负载较高\n-  重置统计信息不是解决方案-不会解决问题，并且会对autovacuum产生负面影响\n-  9.3之前的解决方案：将pgstat.stat文件移动到tmpfs文件系统，考虑升级到9.3\n","slug":"The_two_kinds_of_stats_in_PostgreSQL","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhj000spieb5hf61d5c","content":"<p>时不时地，有人对重置PostgreSQL中的统计信息, 以及重置统计信息对执行计划和数据库其他部分的影响感到困惑。也许文档对此描述的会更清晰一些，但是对于那些以前从未在PostgreSQL中处理过统计信息的人来说无疑是令人困惑的。但这不仅是关于新手的问题-我在9.3中为该区域编写了一个补丁，而且我有时也会感到困惑。对于大多数用户而言，最令人惊讶的事实是“统计信息”实际上可能意味着两件事, 描述数据分布的统计信息，以及监视统计信息，跟踪有关数据库系统本身操作的计数器。每种都有不同的用途，存储方式也不同，丢失数据时的影响也大不相同。因此，让我们看看这两种统计数据的目的是什么，常见的问题是什么，当数据由于某种原因丢失时会发生什么。<br><a id=\"more\"></a></p>\n<h1 id=\"数据分布统计信息\"><a href=\"#数据分布统计信息\" class=\"headerlink\" title=\"数据分布统计信息\"></a>数据分布统计信息</h1><p>第一种统计信息跟踪数据的分布-不同值的数量，列中最常见的值，数据的直方图等。<br>这是规划查询时使用的信息, 用来解决以下问题:</p>\n<pre><code>- 有多少行符合条件？ （选择性估计）\n- 联接产生多少行？ （选择性估计）\n- 聚合需要多少内存？\n</code></pre><p>本质上，这些统计信息，决定了planner/optimizer使用了那一种最好的方式去执行。这种统计信息是由ANALYZE（或autovacuum）收集的，并存储在“常规”表中，并像常规数据一样受事务日志保护。检查pg_statistic系统目录，或者查看pg_stats，它是pg_statistic之上的视图，使统计信息更易于阅读。很多情况下会引发统计信息不准确，导致选择了较差的计划和糟糕的查询性能。发生这种情况的原因有多种（错误的统计信息，复杂的条件，相关的列…）</p>\n<p>据我所知，没有命令/函数可以重置此类统计信息，因为完全没有必要，不觉得可以通过删除此类统计信息来解决该任何问题。当然尝试使用简单的DELETE从目录中删除数据（但我从未尝试过）。</p>\n<h1 id=\"监控统计信息\"><a href=\"#监控统计信息\" class=\"headerlink\" title=\"监控统计信息\"></a>监控统计信息</h1><p>另一种统计信息是被statistics collector进程收集的，文档中的第一段<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">    PostgreSQL&#x27;s statistics collector <span class=\"hljs-keyword\">is</span> a subsystem <span class=\"hljs-keyword\">that</span> supports collection <span class=\"hljs-keyword\">and</span> reporting <span class=\"hljs-keyword\">of</span> information <span class=\"hljs-keyword\">about</span> server activity. <br>Presently, <span class=\"hljs-keyword\">the</span> collector can <span class=\"hljs-built_in\">count</span> accesses <span class=\"hljs-keyword\">to</span> tables <span class=\"hljs-keyword\">and</span> indexes <span class=\"hljs-keyword\">in</span> both disk-block <span class=\"hljs-keyword\">and</span> individual-row terms. It also tracks <span class=\"hljs-keyword\">the</span> <br>total <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> rows <span class=\"hljs-keyword\">in</span> each table, <span class=\"hljs-keyword\">and</span> information <span class=\"hljs-keyword\">about</span> vacuum <span class=\"hljs-keyword\">and</span> analyze actions <span class=\"hljs-keyword\">for</span> each table. It can also <span class=\"hljs-built_in\">count</span> calls <span class=\"hljs-keyword\">to</span> <br>user-defined functions <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">the</span> total <span class=\"hljs-built_in\">time</span> spent <span class=\"hljs-keyword\">in</span> each one.<br></code></pre></td></tr></table></figure></p>\n<p>因此，当您需要了解特定表的访问频率，是顺序读取表还是使用索引访问表等时，这就是统计信息收集器收集的统计信息。如果要查看此类统计信息，则有很多系统视图：</p>\n<figure class=\"highlight python-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python-repl\">pg_stat_activity<br>pg_stat_archiver<br>pg_stat_bgwriter<br>pg_stat_database<br>pg_stat_all_tables<br>pg_stat_sys_tables<br><span class=\"hljs-meta\">...</span><br>pg_statio_all_tables<br>pg_statio_sys_tables<br>pg_statio_user_tables<br>pg_statio_all_indexes<br>pg_statio_sys_indexes<br><span class=\"hljs-meta\">...</span><br></code></pre></td></tr></table></figure>\n<p>命名方案很明显（以pg_stat_或pg_statio_开头），其名称很不言而喻。例如，当您需要有关当前用户拥有的表的信息时，您可以转到pg_stat_user_tables或pg_statio_user_tables，这取决于您是否需要简单的统计信息（seq扫描，索引扫描的数量…）还是与IO相关的统计信息（数量读取的块数，点击率等）。对于与复制和数据库系统其他部分有关的其他对象（索引，函数等）和统计信息，也是如此。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><h2 id=\"数据分布统计信息-1\"><a href=\"#数据分布统计信息-1\" class=\"headerlink\" title=\"数据分布统计信息\"></a>数据分布统计信息</h2><ul>\n<li>描述数据分布的统计数据，由ANALYZE / autovacuum收集</li>\n<li>planner/optimizer在规划查询时使用</li>\n<li>存储在数据库中，受WAL保护的常规表</li>\n<li>没有官方方法可以重置此类统计信息</li>\n<li>这些问题通常会导致选择错误的查询计划</li>\n</ul>\n<h2 id=\"监控统计信息-1\"><a href=\"#监控统计信息-1\" class=\"headerlink\" title=\"监控统计信息\"></a>监控统计信息</h2><ul>\n<li>统计信息跟踪数据库系统本身的运行情况</li>\n<li>用于监视目的和autovacuum（以识别需要维护的对象)</li>\n<li>存储在数据库外部，二进制文件（pgstat.stat）或每个数据库文件的集合中（从9.3开始）</li>\n<li>这就是使用pg_stat_reset()重置的统计信息</li>\n<li>最常见的问题是pgstat.stat文件变大时（由于跟踪许多数据库对象), I/O负载较高</li>\n<li>重置统计信息不是解决方案-不会解决问题，并且会对autovacuum产生负面影响</li>\n<li>9.3之前的解决方案：将pgstat.stat文件移动到tmpfs文件系统，考虑升级到9.3</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>时不时地，有人对重置PostgreSQL中的统计信息, 以及重置统计信息对执行计划和数据库其他部分的影响感到困惑。也许文档对此描述的会更清晰一些，但是对于那些以前从未在PostgreSQL中处理过统计信息的人来说无疑是令人困惑的。但这不仅是关于新手的问题-我在9.3中为该区域编写了一个补丁，而且我有时也会感到困惑。对于大多数用户而言，最令人惊讶的事实是“统计信息”实际上可能意味着两件事, 描述数据分布的统计信息，以及监视统计信息，跟踪有关数据库系统本身操作的计数器。每种都有不同的用途，存储方式也不同，丢失数据时的影响也大不相同。因此，让我们看看这两种统计数据的目的是什么，常见的问题是什么，当数据由于某种原因丢失时会发生什么。<br>","more":"</p>\n<h1 id=\"数据分布统计信息\"><a href=\"#数据分布统计信息\" class=\"headerlink\" title=\"数据分布统计信息\"></a>数据分布统计信息</h1><p>第一种统计信息跟踪数据的分布-不同值的数量，列中最常见的值，数据的直方图等。<br>这是规划查询时使用的信息, 用来解决以下问题:</p>\n<pre><code>- 有多少行符合条件？ （选择性估计）\n- 联接产生多少行？ （选择性估计）\n- 聚合需要多少内存？\n</code></pre><p>本质上，这些统计信息，决定了planner/optimizer使用了那一种最好的方式去执行。这种统计信息是由ANALYZE（或autovacuum）收集的，并存储在“常规”表中，并像常规数据一样受事务日志保护。检查pg_statistic系统目录，或者查看pg_stats，它是pg_statistic之上的视图，使统计信息更易于阅读。很多情况下会引发统计信息不准确，导致选择了较差的计划和糟糕的查询性能。发生这种情况的原因有多种（错误的统计信息，复杂的条件，相关的列…）</p>\n<p>据我所知，没有命令/函数可以重置此类统计信息，因为完全没有必要，不觉得可以通过删除此类统计信息来解决该任何问题。当然尝试使用简单的DELETE从目录中删除数据（但我从未尝试过）。</p>\n<h1 id=\"监控统计信息\"><a href=\"#监控统计信息\" class=\"headerlink\" title=\"监控统计信息\"></a>监控统计信息</h1><p>另一种统计信息是被statistics collector进程收集的，文档中的第一段<br><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">    PostgreSQL&#x27;s statistics collector <span class=\"hljs-keyword\">is</span> a subsystem <span class=\"hljs-keyword\">that</span> supports collection <span class=\"hljs-keyword\">and</span> reporting <span class=\"hljs-keyword\">of</span> information <span class=\"hljs-keyword\">about</span> server activity. <br>Presently, <span class=\"hljs-keyword\">the</span> collector can <span class=\"hljs-built_in\">count</span> accesses <span class=\"hljs-keyword\">to</span> tables <span class=\"hljs-keyword\">and</span> indexes <span class=\"hljs-keyword\">in</span> both disk-block <span class=\"hljs-keyword\">and</span> individual-row terms. It also tracks <span class=\"hljs-keyword\">the</span> <br>total <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> rows <span class=\"hljs-keyword\">in</span> each table, <span class=\"hljs-keyword\">and</span> information <span class=\"hljs-keyword\">about</span> vacuum <span class=\"hljs-keyword\">and</span> analyze actions <span class=\"hljs-keyword\">for</span> each table. It can also <span class=\"hljs-built_in\">count</span> calls <span class=\"hljs-keyword\">to</span> <br>user-defined functions <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">the</span> total <span class=\"hljs-built_in\">time</span> spent <span class=\"hljs-keyword\">in</span> each one.<br></code></pre></td></tr></table></figure></p>\n<p>因此，当您需要了解特定表的访问频率，是顺序读取表还是使用索引访问表等时，这就是统计信息收集器收集的统计信息。如果要查看此类统计信息，则有很多系统视图：</p>\n<figure class=\"highlight python-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python-repl\">pg_stat_activity<br>pg_stat_archiver<br>pg_stat_bgwriter<br>pg_stat_database<br>pg_stat_all_tables<br>pg_stat_sys_tables<br><span class=\"hljs-meta\">...</span><br>pg_statio_all_tables<br>pg_statio_sys_tables<br>pg_statio_user_tables<br>pg_statio_all_indexes<br>pg_statio_sys_indexes<br><span class=\"hljs-meta\">...</span><br></code></pre></td></tr></table></figure>\n<p>命名方案很明显（以pg_stat_或pg_statio_开头），其名称很不言而喻。例如，当您需要有关当前用户拥有的表的信息时，您可以转到pg_stat_user_tables或pg_statio_user_tables，这取决于您是否需要简单的统计信息（seq扫描，索引扫描的数量…）还是与IO相关的统计信息（数量读取的块数，点击率等）。对于与复制和数据库系统其他部分有关的其他对象（索引，函数等）和统计信息，也是如此。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><h2 id=\"数据分布统计信息-1\"><a href=\"#数据分布统计信息-1\" class=\"headerlink\" title=\"数据分布统计信息\"></a>数据分布统计信息</h2><ul>\n<li>描述数据分布的统计数据，由ANALYZE / autovacuum收集</li>\n<li>planner/optimizer在规划查询时使用</li>\n<li>存储在数据库中，受WAL保护的常规表</li>\n<li>没有官方方法可以重置此类统计信息</li>\n<li>这些问题通常会导致选择错误的查询计划</li>\n</ul>\n<h2 id=\"监控统计信息-1\"><a href=\"#监控统计信息-1\" class=\"headerlink\" title=\"监控统计信息\"></a>监控统计信息</h2><ul>\n<li>统计信息跟踪数据库系统本身的运行情况</li>\n<li>用于监视目的和autovacuum（以识别需要维护的对象)</li>\n<li>存储在数据库外部，二进制文件（pgstat.stat）或每个数据库文件的集合中（从9.3开始）</li>\n<li>这就是使用pg_stat_reset()重置的统计信息</li>\n<li>最常见的问题是pgstat.stat文件变大时（由于跟踪许多数据库对象), I/O负载较高</li>\n<li>重置统计信息不是解决方案-不会解决问题，并且会对autovacuum产生负面影响</li>\n<li>9.3之前的解决方案：将pgstat.stat文件移动到tmpfs文件系统，考虑升级到9.3</li>\n</ul>"},{"title":"获取PostgreSQL hash table value","date":"2020-09-07T11:23:12.000Z","top":30,"description":null,"password":null,"_content":"\n简单的修改了postgresql-12.3/src/backend/partitioning/partbounds.c代码， 创建C函数获取PostgreSQL hash 分区表hash value\n<!-- more -->\n\n# 表结构\n\n```\npostgres=# \\d+ userinfo\n                                        Partitioned table \"public.userinfo\"\n  Column  |              Type              | Collation | Nullable | Default | Storage  | Stats target | Description\n----------+--------------------------------+-----------+----------+---------+----------+--------------+-------------\n userid   | integer                        |           |          |         | plain    |              |\n username | character varying(64)          |           |          |         | extended |              |\n ctime    | timestamp(6) without time zone |           |          |         | plain    |              |\nPartition key: HASH (userid)\nIndexes:\n    \"idx_userinfo_userid\" btree (userid)\n    \"idx_userinfo_username\" btree (username)\nPartitions: userinfo_0 FOR VALUES WITH (modulus 16, remainder 0),\n            userinfo_1 FOR VALUES WITH (modulus 16, remainder 1),\n            userinfo_10 FOR VALUES WITH (modulus 16, remainder 10),\n            userinfo_11 FOR VALUES WITH (modulus 16, remainder 11),\n            userinfo_12 FOR VALUES WITH (modulus 16, remainder 12),\n            userinfo_13 FOR VALUES WITH (modulus 16, remainder 13),\n            userinfo_14 FOR VALUES WITH (modulus 16, remainder 14),\n            userinfo_15 FOR VALUES WITH (modulus 16, remainder 15),\n            userinfo_2 FOR VALUES WITH (modulus 16, remainder 2),\n            userinfo_3 FOR VALUES WITH (modulus 16, remainder 3),\n            userinfo_4 FOR VALUES WITH (modulus 16, remainder 4),\n            userinfo_5 FOR VALUES WITH (modulus 16, remainder 5),\n            userinfo_6 FOR VALUES WITH (modulus 16, remainder 6),\n            userinfo_7 FOR VALUES WITH (modulus 16, remainder 7),\n            userinfo_8 FOR VALUES WITH (modulus 16, remainder 8),\n            userinfo_9 FOR VALUES WITH (modulus 16, remainder 9)\n\npostgres=#\n```\n\n# 代码\nvim partvalue.c\n```\n#include \"postgres.h\"\n#include \"fmgr.h\"\n#include \"funcapi.h\"\n#include \"access/relation.h\"\n#include \"access/table.h\"\n#include \"access/tableam.h\"\n#include \"catalog/partition.h\"\n#include \"catalog/pg_inherits.h\"\n#include \"catalog/pg_type.h\"\n#include \"commands/tablecmds.h\"\n#include \"executor/executor.h\"\n#include \"miscadmin.h\"\n#include \"nodes/makefuncs.h\"\n#include \"nodes/nodeFuncs.h\"\n#include \"parser/parse_coerce.h\"\n#include \"partitioning/partbounds.h\"\n#include \"partitioning/partdesc.h\"\n#include \"partitioning/partprune.h\"\n#include \"utils/builtins.h\"\n#include \"utils/datum.h\"\n#include \"utils/fmgroids.h\"\n#include \"utils/hashutils.h\"\n#include \"utils/lsyscache.h\"\n#include \"utils/partcache.h\"\n#include \"utils/rel.h\"\n#include \"utils/snapmgr.h\"\n#include \"utils/ruleutils.h\"\n#include \"utils/syscache.h\"\n\n\n\nPG_MODULE_MAGIC;\n\nPG_FUNCTION_INFO_V1(satisfies_hash_partition_value);\n/*\n * satisfies_hash_partition\n *\n * This is an SQL-callable function for use in hash partition constraints.\n * The first three arguments are the parent table OID, modulus, and remainder.\n * The remaining arguments are the value of the partitioning columns (or\n * expressions); these are hashed and the results are combined into a single\n * hash value by calling hash_combine64.\n *\n * Returns true if remainder produced when this computed single hash value is\n * divided by the given modulus is equal to given remainder, otherwise false.\n *\n * See get_qual_for_hash() for usage.\n */\nDatum\nsatisfies_hash_partition_value(PG_FUNCTION_ARGS)\n{\n\ttypedef struct ColumnsHashData\n\t{\n\t\tOid\t\t\trelid;\n\t\tint\t\t\tnkeys;\n\t\tOid\t\t\tvariadic_type;\n\t\tint16\t\tvariadic_typlen;\n\t\tbool\t\tvariadic_typbyval;\n\t\tchar\t\tvariadic_typalign;\n\t\tOid\t\t\tpartcollid[PARTITION_MAX_KEYS];\n\t\tFmgrInfo\tpartsupfunc[FLEXIBLE_ARRAY_MEMBER];\n\t} ColumnsHashData;\n\tOid\t\t\tparentId;\n\tint\t\t\tmodulus;\n\tint\t\t\tremainder;\n\tDatum\t\tseed = UInt64GetDatum(HASH_PARTITION_SEED);\n\tColumnsHashData *my_extra;\n\tuint64\t\trowHash = 0;\n\n\t/* Return null if the parent OID, modulus, or remainder is NULL. */\n\tif (PG_ARGISNULL(0) || PG_ARGISNULL(1) || PG_ARGISNULL(2))\n\t\tPG_RETURN_NULL();\n\tparentId = PG_GETARG_OID(0);\n\tmodulus = PG_GETARG_INT32(1);\n\tremainder = PG_GETARG_INT32(2);\n\n\t/* Sanity check modulus and remainder. */\n\tif (modulus <= 0)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"modulus for hash partition must be a positive integer\")));\n\tif (remainder < 0)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"remainder for hash partition must be a non-negative integer\")));\n\tif (remainder >= modulus)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"remainder for hash partition must be less than modulus\")));\n\n\t/*\n\t * Cache hash function information.\n\t */\n\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\tif (my_extra == NULL || my_extra->relid != parentId)\n\t{\n\t\tRelation\tparent;\n\t\tPartitionKey key;\n\t\tint\t\t\tj;\n\n\t\t/* Open parent relation and fetch partition keyinfo */\n\t\tparent = try_relation_open(parentId, AccessShareLock);\n\t\tif (parent == NULL)\n\t\t\tPG_RETURN_NULL();\n\t\tkey = RelationGetPartitionKey(parent);\n\n\t\t/* Reject parent table that is not hash-partitioned. */\n\t\tif (parent->rd_rel->relkind != RELKIND_PARTITIONED_TABLE ||\n\t\t\tkey->strategy != PARTITION_STRATEGY_HASH)\n\t\t\tereport(ERROR,\n\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t errmsg(\"\\\"%s\\\" is not a hash partitioned table\",\n\t\t\t\t\t\t\tget_rel_name(parentId))));\n\n\t\tif (!get_fn_expr_variadic(fcinfo->flinfo))\n\t\t{\n\t\t\tint\t\t\tnargs = PG_NARGS() - 3;\n\n\t\t\t/* complain if wrong number of column values */\n\t\t\tif (key->partnatts != nargs)\n\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t errmsg(\"number of partitioning columns (%d) does not match number of partition keys provided (%d)\",\n\t\t\t\t\t\t\t\tkey->partnatts, nargs)));\n\n\t\t\t/* allocate space for our cache */\n\t\t\tfcinfo->flinfo->fn_extra =\n\t\t\t\tMemoryContextAllocZero(fcinfo->flinfo->fn_mcxt,\n\t\t\t\t\t\t\t\t\t   offsetof(ColumnsHashData, partsupfunc) +\n\t\t\t\t\t\t\t\t\t   sizeof(FmgrInfo) * nargs);\n\t\t\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\t\t\tmy_extra->relid = parentId;\n\t\t\tmy_extra->nkeys = key->partnatts;\n\t\t\tmemcpy(my_extra->partcollid, key->partcollation,\n\t\t\t\t   key->partnatts * sizeof(Oid));\n\n\t\t\t/* check argument types and save fmgr_infos */\n\t\t\tfor (j = 0; j < key->partnatts; ++j)\n\t\t\t{\n\t\t\t\tOid\t\t\targtype = get_fn_expr_argtype(fcinfo->flinfo, j + 3);\n\n\t\t\t\tif (argtype != key->parttypid[j] && !IsBinaryCoercible(argtype, key->parttypid[j]))\n\t\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t\t errmsg(\"column %d of the partition key has type \\\"%s\\\", but supplied value is of type \\\"%s\\\"\",\n\t\t\t\t\t\t\t\t\tj + 1, format_type_be(key->parttypid[j]), format_type_be(argtype))));\n\n\t\t\t\tfmgr_info_copy(&my_extra->partsupfunc[j],\n\t\t\t\t\t\t\t   &key->partsupfunc[j],\n\t\t\t\t\t\t\t   fcinfo->flinfo->fn_mcxt);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(3);\n\n\t\t\t/* allocate space for our cache -- just one FmgrInfo in this case */\n\t\t\tfcinfo->flinfo->fn_extra =\n\t\t\t\tMemoryContextAllocZero(fcinfo->flinfo->fn_mcxt,\n\t\t\t\t\t\t\t\t\t   offsetof(ColumnsHashData, partsupfunc) +\n\t\t\t\t\t\t\t\t\t   sizeof(FmgrInfo));\n\t\t\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\t\t\tmy_extra->relid = parentId;\n\t\t\tmy_extra->nkeys = key->partnatts;\n\t\t\tmy_extra->variadic_type = ARR_ELEMTYPE(variadic_array);\n\t\t\tget_typlenbyvalalign(my_extra->variadic_type,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typlen,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typbyval,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typalign);\n\t\t\tmy_extra->partcollid[0] = key->partcollation[0];\n\n\t\t\t/* check argument types */\n\t\t\tfor (j = 0; j < key->partnatts; ++j)\n\t\t\t\tif (key->parttypid[j] != my_extra->variadic_type)\n\t\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t\t errmsg(\"column %d of the partition key has type \\\"%s\\\", but supplied value is of type \\\"%s\\\"\",\n\t\t\t\t\t\t\t\t\tj + 1,\n\t\t\t\t\t\t\t\t\tformat_type_be(key->parttypid[j]),\n\t\t\t\t\t\t\t\t\tformat_type_be(my_extra->variadic_type))));\n\n\t\t\tfmgr_info_copy(&my_extra->partsupfunc[0],\n\t\t\t\t\t\t   &key->partsupfunc[0],\n\t\t\t\t\t\t   fcinfo->flinfo->fn_mcxt);\n\t\t}\n\n\t\t/* Hold lock until commit */\n\t\trelation_close(parent, NoLock);\n\t}\n\n\tif (!OidIsValid(my_extra->variadic_type))\n\t{\n\t\tint\t\t\tnkeys = my_extra->nkeys;\n\t\tint\t\t\ti;\n\n\t\t/*\n\t\t * For a non-variadic call, neither the number of arguments nor their\n\t\t * types can change across calls, so avoid the expense of rechecking\n\t\t * here.\n\t\t */\n\n\t\tfor (i = 0; i < nkeys; i++)\n\t\t{\n\t\t\tDatum\t\thash;\n\n\t\t\t/* keys start from fourth argument of function. */\n\t\t\tint\t\t\targno = i + 3;\n\n\t\t\tif (PG_ARGISNULL(argno))\n\t\t\t\tcontinue;\n\n\t\t\thash = FunctionCall2Coll(&my_extra->partsupfunc[i],\n\t\t\t\t\t\t\t\t\t my_extra->partcollid[i],\n\t\t\t\t\t\t\t\t\t PG_GETARG_DATUM(argno),\n\t\t\t\t\t\t\t\t\t seed);\n\n\t\t\t/* Form a single 64-bit hash value */\n\t\t\trowHash = hash_combine64(rowHash, DatumGetUInt64(hash));\n\t\t}\n\t}\n\telse\n\t{\n\t\tArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(3);\n\t\tint\t\t\ti;\n\t\tint\t\t\tnelems;\n\t\tDatum\t   *datum;\n\t\tbool\t   *isnull;\n\n\t\tdeconstruct_array(variadic_array,\n\t\t\t\t\t\t  my_extra->variadic_type,\n\t\t\t\t\t\t  my_extra->variadic_typlen,\n\t\t\t\t\t\t  my_extra->variadic_typbyval,\n\t\t\t\t\t\t  my_extra->variadic_typalign,\n\t\t\t\t\t\t  &datum, &isnull, &nelems);\n\n\t\t/* complain if wrong number of column values */\n\t\tif (nelems != my_extra->nkeys)\n\t\t\tereport(ERROR,\n\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t errmsg(\"number of partitioning columns (%d) does not match number of partition keys provided (%d)\",\n\t\t\t\t\t\t\tmy_extra->nkeys, nelems)));\n\n\t\tfor (i = 0; i < nelems; i++)\n\t\t{\n\t\t\tDatum\t\thash;\n\n\t\t\tif (isnull[i])\n\t\t\t\tcontinue;\n\n\t\t\thash = FunctionCall2Coll(&my_extra->partsupfunc[0],\n\t\t\t\t\t\t\t\t\t my_extra->partcollid[0],\n\t\t\t\t\t\t\t\t\t datum[i],\n\t\t\t\t\t\t\t\t\t seed);\n\n\t\t\t/* Form a single 64-bit hash value */\n\t\t\trowHash = hash_combine64(rowHash, DatumGetUInt64(hash));\n\t\t}\n\t}\n\n\tPG_RETURN_UINT64(rowHash % modulus);\n}\n\n```\n\n# 编译\n\n```\ngcc -fPIC -c partvalue.c -I /home/postgres/pg12/include/server ; cc -shared -o partvalue.so partvalue.o\n```\n\n# 创建函数\n```\npostgres=# CREATE or replace FUNCTION satisfies_hash_partition_value(oid, integer, integer, VARIADIC \"any\") RETURNS bigint\n     AS '/home/postgres/partvalue', 'satisfies_hash_partition_value'\n     LANGUAGE C STRICT;\nCREATE FUNCTION\npostgres=# \\df+ satisfies_hash_partition_value\n                                                                                                           List of functions\n Schema |              Name              | Result data type |          Argument data types          | Type | Volatility | Parallel |  Owner   | Security | Access privileges | Language |          Source code           | Description\n--------+--------------------------------+------------------+---------------------------------------+------+------------+----------+----------+----------+-------------------+----------+--------------------------------+-------------\n public | satisfies_hash_partition_value | bigint           | oid, integer, integer, VARIADIC \"any\" | func | volatile   | unsafe   | postgres | invoker  |                   | c        | satisfies_hash_partition_value |\n(1 row)\n\npostgres=#\n\n```\n\n# 测试\n```\npostgres=# insert into userinfo select id, 'userinfo_'|| satisfies_hash_partition_value('18544'::oid, 16, 0, id),  now() - (id || ' sec')::interval from generate_series(1,50) id;\nINSERT 0 50\npostgres=# select * from userinfo;\n userid |  username   |           ctime\n--------+-------------+----------------------------\n     14 | userinfo_0  | 2020-09-07 19:29:55.519518\n     26 | userinfo_0  | 2020-09-07 19:29:43.519518\n     34 | userinfo_0  | 2020-09-07 19:29:35.519518\n     11 | userinfo_1  | 2020-09-07 19:29:58.519518\n     19 | userinfo_1  | 2020-09-07 19:29:50.519518\n     21 | userinfo_1  | 2020-09-07 19:29:48.519518\n     36 | userinfo_1  | 2020-09-07 19:29:33.519518\n     42 | userinfo_2  | 2020-09-07 19:29:27.519518\n      4 | userinfo_3  | 2020-09-07 19:30:05.519518\n      6 | userinfo_3  | 2020-09-07 19:30:03.519518\n     24 | userinfo_3  | 2020-09-07 19:29:45.519518\n     29 | userinfo_3  | 2020-09-07 19:29:40.519518\n     44 | userinfo_4  | 2020-09-07 19:29:25.519518\n     50 | userinfo_4  | 2020-09-07 19:29:19.519518\n      8 | userinfo_5  | 2020-09-07 19:30:01.519518\n     13 | userinfo_6  | 2020-09-07 19:29:56.519518\n     23 | userinfo_6  | 2020-09-07 19:29:46.519518\n     39 | userinfo_6  | 2020-09-07 19:29:30.519518\n     48 | userinfo_6  | 2020-09-07 19:29:21.519518\n     49 | userinfo_6  | 2020-09-07 19:29:20.519518\n      7 | userinfo_7  | 2020-09-07 19:30:02.519518\n     10 | userinfo_7  | 2020-09-07 19:29:59.519518\n     22 | userinfo_7  | 2020-09-07 19:29:47.519518\n      1 | userinfo_8  | 2020-09-07 19:30:08.519518\n     16 | userinfo_8  | 2020-09-07 19:29:53.519518\n     28 | userinfo_8  | 2020-09-07 19:29:41.519518\n     30 | userinfo_8  | 2020-09-07 19:29:39.519518\n     32 | userinfo_8  | 2020-09-07 19:29:37.519518\n      3 | userinfo_9  | 2020-09-07 19:30:06.519518\n     31 | userinfo_9  | 2020-09-07 19:29:38.519518\n     35 | userinfo_9  | 2020-09-07 19:29:34.519518\n     37 | userinfo_9  | 2020-09-07 19:29:32.519518\n     38 | userinfo_9  | 2020-09-07 19:29:31.519518\n      2 | userinfo_10 | 2020-09-07 19:30:07.519518\n     47 | userinfo_10 | 2020-09-07 19:29:22.519518\n     15 | userinfo_11 | 2020-09-07 19:29:54.519518\n     12 | userinfo_12 | 2020-09-07 19:29:57.519518\n     17 | userinfo_12 | 2020-09-07 19:29:52.519518\n     45 | userinfo_12 | 2020-09-07 19:29:24.519518\n      5 | userinfo_13 | 2020-09-07 19:30:04.519518\n      9 | userinfo_13 | 2020-09-07 19:30:00.519518\n     20 | userinfo_13 | 2020-09-07 19:29:49.519518\n     41 | userinfo_13 | 2020-09-07 19:29:28.519518\n     46 | userinfo_13 | 2020-09-07 19:29:23.519518\n     18 | userinfo_14 | 2020-09-07 19:29:51.519518\n     25 | userinfo_14 | 2020-09-07 19:29:44.519518\n     27 | userinfo_14 | 2020-09-07 19:29:42.519518\n     43 | userinfo_14 | 2020-09-07 19:29:26.519518\n     33 | userinfo_15 | 2020-09-07 19:29:36.519518\n     40 | userinfo_15 | 2020-09-07 19:29:29.519518\n(50 rows)\n\npostgres=# select * from userinfo_0;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     14 | userinfo_0 | 2020-09-07 19:29:55.519518\n     26 | userinfo_0 | 2020-09-07 19:29:43.519518\n     34 | userinfo_0 | 2020-09-07 19:29:35.519518\n(3 rows)\n\npostgres=# select * from userinfo_1;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     11 | userinfo_1 | 2020-09-07 19:29:58.519518\n     19 | userinfo_1 | 2020-09-07 19:29:50.519518\n     21 | userinfo_1 | 2020-09-07 19:29:48.519518\n     36 | userinfo_1 | 2020-09-07 19:29:33.519518\n(4 rows)\n\npostgres=# select * from userinfo_2;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     42 | userinfo_2 | 2020-09-07 19:29:27.519518\n(1 row)\n\npostgres=# select * from userinfo_3;\n userid |  username  |           ctime\n--------+------------+----------------------------\n      4 | userinfo_3 | 2020-09-07 19:30:05.519518\n      6 | userinfo_3 | 2020-09-07 19:30:03.519518\n     24 | userinfo_3 | 2020-09-07 19:29:45.519518\n     29 | userinfo_3 | 2020-09-07 19:29:40.519518\n(4 rows)\n\n```\n","source":"_posts/get_partition_table_value.md","raw":"---\ntitle: 获取PostgreSQL hash table value \ndate: 2020-09-07 19:23:12\ntags: \n- PostgreSQL\n- hash key\n- partition table\ncategories: \n- PostgreSQL\ntop: 30 \ndescription: \npassword: \n\n---\n\n简单的修改了postgresql-12.3/src/backend/partitioning/partbounds.c代码， 创建C函数获取PostgreSQL hash 分区表hash value\n<!-- more -->\n\n# 表结构\n\n```\npostgres=# \\d+ userinfo\n                                        Partitioned table \"public.userinfo\"\n  Column  |              Type              | Collation | Nullable | Default | Storage  | Stats target | Description\n----------+--------------------------------+-----------+----------+---------+----------+--------------+-------------\n userid   | integer                        |           |          |         | plain    |              |\n username | character varying(64)          |           |          |         | extended |              |\n ctime    | timestamp(6) without time zone |           |          |         | plain    |              |\nPartition key: HASH (userid)\nIndexes:\n    \"idx_userinfo_userid\" btree (userid)\n    \"idx_userinfo_username\" btree (username)\nPartitions: userinfo_0 FOR VALUES WITH (modulus 16, remainder 0),\n            userinfo_1 FOR VALUES WITH (modulus 16, remainder 1),\n            userinfo_10 FOR VALUES WITH (modulus 16, remainder 10),\n            userinfo_11 FOR VALUES WITH (modulus 16, remainder 11),\n            userinfo_12 FOR VALUES WITH (modulus 16, remainder 12),\n            userinfo_13 FOR VALUES WITH (modulus 16, remainder 13),\n            userinfo_14 FOR VALUES WITH (modulus 16, remainder 14),\n            userinfo_15 FOR VALUES WITH (modulus 16, remainder 15),\n            userinfo_2 FOR VALUES WITH (modulus 16, remainder 2),\n            userinfo_3 FOR VALUES WITH (modulus 16, remainder 3),\n            userinfo_4 FOR VALUES WITH (modulus 16, remainder 4),\n            userinfo_5 FOR VALUES WITH (modulus 16, remainder 5),\n            userinfo_6 FOR VALUES WITH (modulus 16, remainder 6),\n            userinfo_7 FOR VALUES WITH (modulus 16, remainder 7),\n            userinfo_8 FOR VALUES WITH (modulus 16, remainder 8),\n            userinfo_9 FOR VALUES WITH (modulus 16, remainder 9)\n\npostgres=#\n```\n\n# 代码\nvim partvalue.c\n```\n#include \"postgres.h\"\n#include \"fmgr.h\"\n#include \"funcapi.h\"\n#include \"access/relation.h\"\n#include \"access/table.h\"\n#include \"access/tableam.h\"\n#include \"catalog/partition.h\"\n#include \"catalog/pg_inherits.h\"\n#include \"catalog/pg_type.h\"\n#include \"commands/tablecmds.h\"\n#include \"executor/executor.h\"\n#include \"miscadmin.h\"\n#include \"nodes/makefuncs.h\"\n#include \"nodes/nodeFuncs.h\"\n#include \"parser/parse_coerce.h\"\n#include \"partitioning/partbounds.h\"\n#include \"partitioning/partdesc.h\"\n#include \"partitioning/partprune.h\"\n#include \"utils/builtins.h\"\n#include \"utils/datum.h\"\n#include \"utils/fmgroids.h\"\n#include \"utils/hashutils.h\"\n#include \"utils/lsyscache.h\"\n#include \"utils/partcache.h\"\n#include \"utils/rel.h\"\n#include \"utils/snapmgr.h\"\n#include \"utils/ruleutils.h\"\n#include \"utils/syscache.h\"\n\n\n\nPG_MODULE_MAGIC;\n\nPG_FUNCTION_INFO_V1(satisfies_hash_partition_value);\n/*\n * satisfies_hash_partition\n *\n * This is an SQL-callable function for use in hash partition constraints.\n * The first three arguments are the parent table OID, modulus, and remainder.\n * The remaining arguments are the value of the partitioning columns (or\n * expressions); these are hashed and the results are combined into a single\n * hash value by calling hash_combine64.\n *\n * Returns true if remainder produced when this computed single hash value is\n * divided by the given modulus is equal to given remainder, otherwise false.\n *\n * See get_qual_for_hash() for usage.\n */\nDatum\nsatisfies_hash_partition_value(PG_FUNCTION_ARGS)\n{\n\ttypedef struct ColumnsHashData\n\t{\n\t\tOid\t\t\trelid;\n\t\tint\t\t\tnkeys;\n\t\tOid\t\t\tvariadic_type;\n\t\tint16\t\tvariadic_typlen;\n\t\tbool\t\tvariadic_typbyval;\n\t\tchar\t\tvariadic_typalign;\n\t\tOid\t\t\tpartcollid[PARTITION_MAX_KEYS];\n\t\tFmgrInfo\tpartsupfunc[FLEXIBLE_ARRAY_MEMBER];\n\t} ColumnsHashData;\n\tOid\t\t\tparentId;\n\tint\t\t\tmodulus;\n\tint\t\t\tremainder;\n\tDatum\t\tseed = UInt64GetDatum(HASH_PARTITION_SEED);\n\tColumnsHashData *my_extra;\n\tuint64\t\trowHash = 0;\n\n\t/* Return null if the parent OID, modulus, or remainder is NULL. */\n\tif (PG_ARGISNULL(0) || PG_ARGISNULL(1) || PG_ARGISNULL(2))\n\t\tPG_RETURN_NULL();\n\tparentId = PG_GETARG_OID(0);\n\tmodulus = PG_GETARG_INT32(1);\n\tremainder = PG_GETARG_INT32(2);\n\n\t/* Sanity check modulus and remainder. */\n\tif (modulus <= 0)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"modulus for hash partition must be a positive integer\")));\n\tif (remainder < 0)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"remainder for hash partition must be a non-negative integer\")));\n\tif (remainder >= modulus)\n\t\tereport(ERROR,\n\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t errmsg(\"remainder for hash partition must be less than modulus\")));\n\n\t/*\n\t * Cache hash function information.\n\t */\n\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\tif (my_extra == NULL || my_extra->relid != parentId)\n\t{\n\t\tRelation\tparent;\n\t\tPartitionKey key;\n\t\tint\t\t\tj;\n\n\t\t/* Open parent relation and fetch partition keyinfo */\n\t\tparent = try_relation_open(parentId, AccessShareLock);\n\t\tif (parent == NULL)\n\t\t\tPG_RETURN_NULL();\n\t\tkey = RelationGetPartitionKey(parent);\n\n\t\t/* Reject parent table that is not hash-partitioned. */\n\t\tif (parent->rd_rel->relkind != RELKIND_PARTITIONED_TABLE ||\n\t\t\tkey->strategy != PARTITION_STRATEGY_HASH)\n\t\t\tereport(ERROR,\n\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t errmsg(\"\\\"%s\\\" is not a hash partitioned table\",\n\t\t\t\t\t\t\tget_rel_name(parentId))));\n\n\t\tif (!get_fn_expr_variadic(fcinfo->flinfo))\n\t\t{\n\t\t\tint\t\t\tnargs = PG_NARGS() - 3;\n\n\t\t\t/* complain if wrong number of column values */\n\t\t\tif (key->partnatts != nargs)\n\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t errmsg(\"number of partitioning columns (%d) does not match number of partition keys provided (%d)\",\n\t\t\t\t\t\t\t\tkey->partnatts, nargs)));\n\n\t\t\t/* allocate space for our cache */\n\t\t\tfcinfo->flinfo->fn_extra =\n\t\t\t\tMemoryContextAllocZero(fcinfo->flinfo->fn_mcxt,\n\t\t\t\t\t\t\t\t\t   offsetof(ColumnsHashData, partsupfunc) +\n\t\t\t\t\t\t\t\t\t   sizeof(FmgrInfo) * nargs);\n\t\t\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\t\t\tmy_extra->relid = parentId;\n\t\t\tmy_extra->nkeys = key->partnatts;\n\t\t\tmemcpy(my_extra->partcollid, key->partcollation,\n\t\t\t\t   key->partnatts * sizeof(Oid));\n\n\t\t\t/* check argument types and save fmgr_infos */\n\t\t\tfor (j = 0; j < key->partnatts; ++j)\n\t\t\t{\n\t\t\t\tOid\t\t\targtype = get_fn_expr_argtype(fcinfo->flinfo, j + 3);\n\n\t\t\t\tif (argtype != key->parttypid[j] && !IsBinaryCoercible(argtype, key->parttypid[j]))\n\t\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t\t errmsg(\"column %d of the partition key has type \\\"%s\\\", but supplied value is of type \\\"%s\\\"\",\n\t\t\t\t\t\t\t\t\tj + 1, format_type_be(key->parttypid[j]), format_type_be(argtype))));\n\n\t\t\t\tfmgr_info_copy(&my_extra->partsupfunc[j],\n\t\t\t\t\t\t\t   &key->partsupfunc[j],\n\t\t\t\t\t\t\t   fcinfo->flinfo->fn_mcxt);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(3);\n\n\t\t\t/* allocate space for our cache -- just one FmgrInfo in this case */\n\t\t\tfcinfo->flinfo->fn_extra =\n\t\t\t\tMemoryContextAllocZero(fcinfo->flinfo->fn_mcxt,\n\t\t\t\t\t\t\t\t\t   offsetof(ColumnsHashData, partsupfunc) +\n\t\t\t\t\t\t\t\t\t   sizeof(FmgrInfo));\n\t\t\tmy_extra = (ColumnsHashData *) fcinfo->flinfo->fn_extra;\n\t\t\tmy_extra->relid = parentId;\n\t\t\tmy_extra->nkeys = key->partnatts;\n\t\t\tmy_extra->variadic_type = ARR_ELEMTYPE(variadic_array);\n\t\t\tget_typlenbyvalalign(my_extra->variadic_type,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typlen,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typbyval,\n\t\t\t\t\t\t\t\t &my_extra->variadic_typalign);\n\t\t\tmy_extra->partcollid[0] = key->partcollation[0];\n\n\t\t\t/* check argument types */\n\t\t\tfor (j = 0; j < key->partnatts; ++j)\n\t\t\t\tif (key->parttypid[j] != my_extra->variadic_type)\n\t\t\t\t\tereport(ERROR,\n\t\t\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t\t\t errmsg(\"column %d of the partition key has type \\\"%s\\\", but supplied value is of type \\\"%s\\\"\",\n\t\t\t\t\t\t\t\t\tj + 1,\n\t\t\t\t\t\t\t\t\tformat_type_be(key->parttypid[j]),\n\t\t\t\t\t\t\t\t\tformat_type_be(my_extra->variadic_type))));\n\n\t\t\tfmgr_info_copy(&my_extra->partsupfunc[0],\n\t\t\t\t\t\t   &key->partsupfunc[0],\n\t\t\t\t\t\t   fcinfo->flinfo->fn_mcxt);\n\t\t}\n\n\t\t/* Hold lock until commit */\n\t\trelation_close(parent, NoLock);\n\t}\n\n\tif (!OidIsValid(my_extra->variadic_type))\n\t{\n\t\tint\t\t\tnkeys = my_extra->nkeys;\n\t\tint\t\t\ti;\n\n\t\t/*\n\t\t * For a non-variadic call, neither the number of arguments nor their\n\t\t * types can change across calls, so avoid the expense of rechecking\n\t\t * here.\n\t\t */\n\n\t\tfor (i = 0; i < nkeys; i++)\n\t\t{\n\t\t\tDatum\t\thash;\n\n\t\t\t/* keys start from fourth argument of function. */\n\t\t\tint\t\t\targno = i + 3;\n\n\t\t\tif (PG_ARGISNULL(argno))\n\t\t\t\tcontinue;\n\n\t\t\thash = FunctionCall2Coll(&my_extra->partsupfunc[i],\n\t\t\t\t\t\t\t\t\t my_extra->partcollid[i],\n\t\t\t\t\t\t\t\t\t PG_GETARG_DATUM(argno),\n\t\t\t\t\t\t\t\t\t seed);\n\n\t\t\t/* Form a single 64-bit hash value */\n\t\t\trowHash = hash_combine64(rowHash, DatumGetUInt64(hash));\n\t\t}\n\t}\n\telse\n\t{\n\t\tArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(3);\n\t\tint\t\t\ti;\n\t\tint\t\t\tnelems;\n\t\tDatum\t   *datum;\n\t\tbool\t   *isnull;\n\n\t\tdeconstruct_array(variadic_array,\n\t\t\t\t\t\t  my_extra->variadic_type,\n\t\t\t\t\t\t  my_extra->variadic_typlen,\n\t\t\t\t\t\t  my_extra->variadic_typbyval,\n\t\t\t\t\t\t  my_extra->variadic_typalign,\n\t\t\t\t\t\t  &datum, &isnull, &nelems);\n\n\t\t/* complain if wrong number of column values */\n\t\tif (nelems != my_extra->nkeys)\n\t\t\tereport(ERROR,\n\t\t\t\t\t(errcode(ERRCODE_INVALID_PARAMETER_VALUE),\n\t\t\t\t\t errmsg(\"number of partitioning columns (%d) does not match number of partition keys provided (%d)\",\n\t\t\t\t\t\t\tmy_extra->nkeys, nelems)));\n\n\t\tfor (i = 0; i < nelems; i++)\n\t\t{\n\t\t\tDatum\t\thash;\n\n\t\t\tif (isnull[i])\n\t\t\t\tcontinue;\n\n\t\t\thash = FunctionCall2Coll(&my_extra->partsupfunc[0],\n\t\t\t\t\t\t\t\t\t my_extra->partcollid[0],\n\t\t\t\t\t\t\t\t\t datum[i],\n\t\t\t\t\t\t\t\t\t seed);\n\n\t\t\t/* Form a single 64-bit hash value */\n\t\t\trowHash = hash_combine64(rowHash, DatumGetUInt64(hash));\n\t\t}\n\t}\n\n\tPG_RETURN_UINT64(rowHash % modulus);\n}\n\n```\n\n# 编译\n\n```\ngcc -fPIC -c partvalue.c -I /home/postgres/pg12/include/server ; cc -shared -o partvalue.so partvalue.o\n```\n\n# 创建函数\n```\npostgres=# CREATE or replace FUNCTION satisfies_hash_partition_value(oid, integer, integer, VARIADIC \"any\") RETURNS bigint\n     AS '/home/postgres/partvalue', 'satisfies_hash_partition_value'\n     LANGUAGE C STRICT;\nCREATE FUNCTION\npostgres=# \\df+ satisfies_hash_partition_value\n                                                                                                           List of functions\n Schema |              Name              | Result data type |          Argument data types          | Type | Volatility | Parallel |  Owner   | Security | Access privileges | Language |          Source code           | Description\n--------+--------------------------------+------------------+---------------------------------------+------+------------+----------+----------+----------+-------------------+----------+--------------------------------+-------------\n public | satisfies_hash_partition_value | bigint           | oid, integer, integer, VARIADIC \"any\" | func | volatile   | unsafe   | postgres | invoker  |                   | c        | satisfies_hash_partition_value |\n(1 row)\n\npostgres=#\n\n```\n\n# 测试\n```\npostgres=# insert into userinfo select id, 'userinfo_'|| satisfies_hash_partition_value('18544'::oid, 16, 0, id),  now() - (id || ' sec')::interval from generate_series(1,50) id;\nINSERT 0 50\npostgres=# select * from userinfo;\n userid |  username   |           ctime\n--------+-------------+----------------------------\n     14 | userinfo_0  | 2020-09-07 19:29:55.519518\n     26 | userinfo_0  | 2020-09-07 19:29:43.519518\n     34 | userinfo_0  | 2020-09-07 19:29:35.519518\n     11 | userinfo_1  | 2020-09-07 19:29:58.519518\n     19 | userinfo_1  | 2020-09-07 19:29:50.519518\n     21 | userinfo_1  | 2020-09-07 19:29:48.519518\n     36 | userinfo_1  | 2020-09-07 19:29:33.519518\n     42 | userinfo_2  | 2020-09-07 19:29:27.519518\n      4 | userinfo_3  | 2020-09-07 19:30:05.519518\n      6 | userinfo_3  | 2020-09-07 19:30:03.519518\n     24 | userinfo_3  | 2020-09-07 19:29:45.519518\n     29 | userinfo_3  | 2020-09-07 19:29:40.519518\n     44 | userinfo_4  | 2020-09-07 19:29:25.519518\n     50 | userinfo_4  | 2020-09-07 19:29:19.519518\n      8 | userinfo_5  | 2020-09-07 19:30:01.519518\n     13 | userinfo_6  | 2020-09-07 19:29:56.519518\n     23 | userinfo_6  | 2020-09-07 19:29:46.519518\n     39 | userinfo_6  | 2020-09-07 19:29:30.519518\n     48 | userinfo_6  | 2020-09-07 19:29:21.519518\n     49 | userinfo_6  | 2020-09-07 19:29:20.519518\n      7 | userinfo_7  | 2020-09-07 19:30:02.519518\n     10 | userinfo_7  | 2020-09-07 19:29:59.519518\n     22 | userinfo_7  | 2020-09-07 19:29:47.519518\n      1 | userinfo_8  | 2020-09-07 19:30:08.519518\n     16 | userinfo_8  | 2020-09-07 19:29:53.519518\n     28 | userinfo_8  | 2020-09-07 19:29:41.519518\n     30 | userinfo_8  | 2020-09-07 19:29:39.519518\n     32 | userinfo_8  | 2020-09-07 19:29:37.519518\n      3 | userinfo_9  | 2020-09-07 19:30:06.519518\n     31 | userinfo_9  | 2020-09-07 19:29:38.519518\n     35 | userinfo_9  | 2020-09-07 19:29:34.519518\n     37 | userinfo_9  | 2020-09-07 19:29:32.519518\n     38 | userinfo_9  | 2020-09-07 19:29:31.519518\n      2 | userinfo_10 | 2020-09-07 19:30:07.519518\n     47 | userinfo_10 | 2020-09-07 19:29:22.519518\n     15 | userinfo_11 | 2020-09-07 19:29:54.519518\n     12 | userinfo_12 | 2020-09-07 19:29:57.519518\n     17 | userinfo_12 | 2020-09-07 19:29:52.519518\n     45 | userinfo_12 | 2020-09-07 19:29:24.519518\n      5 | userinfo_13 | 2020-09-07 19:30:04.519518\n      9 | userinfo_13 | 2020-09-07 19:30:00.519518\n     20 | userinfo_13 | 2020-09-07 19:29:49.519518\n     41 | userinfo_13 | 2020-09-07 19:29:28.519518\n     46 | userinfo_13 | 2020-09-07 19:29:23.519518\n     18 | userinfo_14 | 2020-09-07 19:29:51.519518\n     25 | userinfo_14 | 2020-09-07 19:29:44.519518\n     27 | userinfo_14 | 2020-09-07 19:29:42.519518\n     43 | userinfo_14 | 2020-09-07 19:29:26.519518\n     33 | userinfo_15 | 2020-09-07 19:29:36.519518\n     40 | userinfo_15 | 2020-09-07 19:29:29.519518\n(50 rows)\n\npostgres=# select * from userinfo_0;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     14 | userinfo_0 | 2020-09-07 19:29:55.519518\n     26 | userinfo_0 | 2020-09-07 19:29:43.519518\n     34 | userinfo_0 | 2020-09-07 19:29:35.519518\n(3 rows)\n\npostgres=# select * from userinfo_1;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     11 | userinfo_1 | 2020-09-07 19:29:58.519518\n     19 | userinfo_1 | 2020-09-07 19:29:50.519518\n     21 | userinfo_1 | 2020-09-07 19:29:48.519518\n     36 | userinfo_1 | 2020-09-07 19:29:33.519518\n(4 rows)\n\npostgres=# select * from userinfo_2;\n userid |  username  |           ctime\n--------+------------+----------------------------\n     42 | userinfo_2 | 2020-09-07 19:29:27.519518\n(1 row)\n\npostgres=# select * from userinfo_3;\n userid |  username  |           ctime\n--------+------------+----------------------------\n      4 | userinfo_3 | 2020-09-07 19:30:05.519518\n      6 | userinfo_3 | 2020-09-07 19:30:03.519518\n     24 | userinfo_3 | 2020-09-07 19:29:45.519518\n     29 | userinfo_3 | 2020-09-07 19:29:40.519518\n(4 rows)\n\n```\n","slug":"get_partition_table_value","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhk000vpieb7wgochws","content":"<p>简单的修改了postgresql-12.3/src/backend/partitioning/partbounds.c代码， 创建C函数获取PostgreSQL hash 分区表hash value<br><a id=\"more\"></a></p>\n<h1 id=\"表结构\"><a href=\"#表结构\" class=\"headerlink\" title=\"表结构\"></a>表结构</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">postgres=<span class=\"hljs-comment\"># \\d+ userinfo</span><br>                                        Partitioned table &quot;public.userinfo&quot;<br>  Column  |              Type              | Collation | Nullable | Default | Storage  | Stats target | Description<br><span class=\"hljs-comment\">----------+--------------------------------+-----------+----------+---------+----------+--------------+-------------</span><br> userid   | integer                        |           |          |         | plain    |              |<br> username | character varying(64)          |           |          |         | extended |              |<br> ctime    | timestamp(6) without time zone |           |          |         | plain    |              |<br>Partition key: HASH (userid)<br>Indexes:<br>    &quot;idx_userinfo_userid&quot; btree (userid)<br>    &quot;idx_userinfo_username&quot; btree (username)<br>Partitions: userinfo_0 FOR <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">0</span>),<br>            userinfo_1 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">1</span>),<br>            userinfo_10 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">10</span>),<br>            userinfo_11 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">11</span>),<br>            userinfo_12 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">12</span>),<br>            userinfo_13 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">13</span>),<br>            userinfo_14 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">14</span>),<br>            userinfo_15 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">15</span>),<br>            userinfo_2 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">2</span>),<br>            userinfo_3 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">3</span>),<br>            userinfo_4 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">4</span>),<br>            userinfo_5 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">5</span>),<br>            userinfo_6 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">6</span>),<br>            userinfo_7 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">7</span>),<br>            userinfo_8 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">8</span>),<br>            userinfo_9 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">9</span>)<br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h1><p>vim partvalue.c<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-meta\">#include &quot;postgres.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;fmgr.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;funcapi.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/relation.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/table.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/tableam.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/partition.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/pg_inherits.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/pg_type.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;commands/tablecmds.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;executor/executor.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;miscadmin.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;nodes/makefuncs.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;nodes/nodeFuncs.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;parser/parse_coerce.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partbounds.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partdesc.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partprune.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/builtins.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/datum.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/fmgroids.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/hashutils.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/lsyscache.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/partcache.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/rel.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/snapmgr.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/ruleutils.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/syscache.h&quot;</span><br><br><br><br>PG_MODULE_MAGIC;<br><br>PG_FUNCTION_INFO_V1(satisfies_hash_partition_value);<br><span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\"> * satisfies_hash_partition</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * This is an SQL-callable function for use in hash partition constraints.</span><br><span class=\"hljs-comment\"> * The first three arguments are the parent table OID, modulus, and remainder.</span><br><span class=\"hljs-comment\"> * The remaining arguments are the value of the partitioning columns (or</span><br><span class=\"hljs-comment\"> * expressions); these are hashed and the results are combined into a single</span><br><span class=\"hljs-comment\"> * hash value by calling hash_combine64.</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * Returns true if remainder produced when this computed single hash value is</span><br><span class=\"hljs-comment\"> * divided by the given modulus is equal to given remainder, otherwise false.</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * See get_qual_for_hash() for usage.</span><br><span class=\"hljs-comment\"> */</span><br>Datum<br>satisfies_hash_partition_value(PG_FUNCTION_ARGS)<br>&#123;<br>    typedef struct ColumnsHashData<br>    &#123;<br>        <span class=\"hljs-type\">Oid</span>            relid;<br>        <span class=\"hljs-type\">int</span>            nkeys;<br>        <span class=\"hljs-type\">Oid</span>            variadic_type;<br>        int16        variadic_typlen;<br>        <span class=\"hljs-type\">bool</span>        variadic_typbyval;<br>        <span class=\"hljs-type\">char</span>        variadic_typalign;<br>        <span class=\"hljs-type\">Oid</span>            partcollid[PARTITION_MAX_KEYS];<br>        FmgrInfo    partsupfunc[FLEXIBLE_ARRAY_MEMBER];<br>    &#125; ColumnsHashData;<br>    <span class=\"hljs-type\">Oid</span>            parentId;<br>    <span class=\"hljs-type\">int</span>            modulus;<br>    <span class=\"hljs-type\">int</span>            remainder;<br>    Datum        seed = UInt64GetDatum(HASH_PARTITION_SEED);<br>    ColumnsHashData *my_extra;<br>    uint64        rowHash = <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-comment\">/* Return null if the parent OID, modulus, or remainder is NULL. */</span><br>    <span class=\"hljs-keyword\">if</span> (PG_ARGISNULL(<span class=\"hljs-number\">0</span>) || PG_ARGISNULL(<span class=\"hljs-number\">1</span>) || PG_ARGISNULL(<span class=\"hljs-number\">2</span>))<br>        PG_RETURN_NULL();<br>    parentId = PG_GETARG_OID(<span class=\"hljs-number\">0</span>);<br>    modulus = PG_GETARG_INT32(<span class=\"hljs-number\">1</span>);<br>    remainder = PG_GETARG_INT32(<span class=\"hljs-number\">2</span>);<br><br>    <span class=\"hljs-comment\">/* Sanity check modulus and remainder. */</span><br>    <span class=\"hljs-keyword\">if</span> (modulus &lt;= <span class=\"hljs-number\">0</span>)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;modulus for hash partition must be a positive integer&quot;)));<br>    <span class=\"hljs-keyword\">if</span> (remainder &lt; <span class=\"hljs-number\">0</span>)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;remainder for hash partition must be a non-negative integer&quot;)));<br>    <span class=\"hljs-keyword\">if</span> (remainder &gt;= modulus)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;remainder for hash partition must be less than modulus&quot;)));<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     * Cache hash function information.</span><br><span class=\"hljs-comment\">     */</span><br>    my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>    <span class=\"hljs-keyword\">if</span> (my_extra == <span class=\"hljs-keyword\">NULL</span> || my_extra-&gt;relid != parentId)<br>    &#123;<br>        Relation    parent;<br>        PartitionKey key;<br>        <span class=\"hljs-type\">int</span>            j;<br><br>        <span class=\"hljs-comment\">/* Open parent relation and fetch partition keyinfo */</span><br>        parent = try_relation_open(parentId, AccessShareLock);<br>        <span class=\"hljs-keyword\">if</span> (parent == <span class=\"hljs-keyword\">NULL</span>)<br>            PG_RETURN_NULL();<br>        key = RelationGetPartitionKey(parent);<br><br>        <span class=\"hljs-comment\">/* Reject parent table that is not hash-partitioned. */</span><br>        <span class=\"hljs-keyword\">if</span> (parent-&gt;rd_rel-&gt;relkind != RELKIND_PARTITIONED_TABLE ||<br>            key-&gt;strategy != PARTITION_STRATEGY_HASH)<br>            ereport(ERROR,<br>                    (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                     errmsg(&quot;\\&quot;%s\\&quot; is not a hash partitioned table&quot;,<br>                            get_rel_name(parentId))));<br><br>        <span class=\"hljs-keyword\">if</span> (!get_fn_expr_variadic(fcinfo-&gt;flinfo))<br>        &#123;<br>            <span class=\"hljs-type\">int</span>            nargs = PG_NARGS() - <span class=\"hljs-number\">3</span>;<br><br>            <span class=\"hljs-comment\">/* complain if wrong number of column values */</span><br>            <span class=\"hljs-keyword\">if</span> (key-&gt;partnatts != nargs)<br>                ereport(ERROR,<br>                        (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                         errmsg(&quot;number of partitioning columns (%d) does not match number of partition keys provided (%d)&quot;,<br>                                key-&gt;partnatts, nargs)));<br><br>            <span class=\"hljs-comment\">/* allocate space for our cache */</span><br>            fcinfo-&gt;flinfo-&gt;fn_extra =<br>                MemoryContextAllocZero(fcinfo-&gt;flinfo-&gt;fn_mcxt,<br>                                       offsetof(ColumnsHashData, partsupfunc) +<br>                                       sizeof(FmgrInfo) * nargs);<br>            my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>            my_extra-&gt;relid = parentId;<br>            my_extra-&gt;nkeys = key-&gt;partnatts;<br>            memcpy(my_extra-&gt;partcollid, key-&gt;partcollation,<br>                   key-&gt;partnatts * sizeof(<span class=\"hljs-type\">Oid</span>));<br><br>            <span class=\"hljs-comment\">/* check argument types and save fmgr_infos */</span><br>            <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; key-&gt;partnatts; ++j)<br>            &#123;<br>                <span class=\"hljs-type\">Oid</span>            argtype = get_fn_expr_argtype(fcinfo-&gt;flinfo, j + <span class=\"hljs-number\">3</span>);<br><br>                <span class=\"hljs-keyword\">if</span> (argtype != key-&gt;parttypid[j] &amp;&amp; !IsBinaryCoercible(argtype, key-&gt;parttypid[j]))<br>                    ereport(ERROR,<br>                            (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                             errmsg(&quot;column %d of the partition key has type \\&quot;%s\\&quot;, but supplied value is of type \\&quot;%s\\&quot;&quot;,<br>                                    j + <span class=\"hljs-number\">1</span>, format_type_be(key-&gt;parttypid[j]), format_type_be(argtype))));<br><br>                fmgr_info_copy(&amp;my_extra-&gt;partsupfunc[j],<br>                               &amp;key-&gt;partsupfunc[j],<br>                               fcinfo-&gt;flinfo-&gt;fn_mcxt);<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-keyword\">else</span><br>        &#123;<br>            ArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(<span class=\"hljs-number\">3</span>);<br><br>            <span class=\"hljs-comment\">/* allocate space for our cache -- just one FmgrInfo in this case */</span><br>            fcinfo-&gt;flinfo-&gt;fn_extra =<br>                MemoryContextAllocZero(fcinfo-&gt;flinfo-&gt;fn_mcxt,<br>                                       offsetof(ColumnsHashData, partsupfunc) +<br>                                       sizeof(FmgrInfo));<br>            my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>            my_extra-&gt;relid = parentId;<br>            my_extra-&gt;nkeys = key-&gt;partnatts;<br>            my_extra-&gt;variadic_type = ARR_ELEMTYPE(variadic_array);<br>            get_typlenbyvalalign(my_extra-&gt;variadic_type,<br>                                 &amp;my_extra-&gt;variadic_typlen,<br>                                 &amp;my_extra-&gt;variadic_typbyval,<br>                                 &amp;my_extra-&gt;variadic_typalign);<br>            my_extra-&gt;partcollid[<span class=\"hljs-number\">0</span>] = key-&gt;partcollation[<span class=\"hljs-number\">0</span>];<br><br>            <span class=\"hljs-comment\">/* check argument types */</span><br>            <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; key-&gt;partnatts; ++j)<br>                <span class=\"hljs-keyword\">if</span> (key-&gt;parttypid[j] != my_extra-&gt;variadic_type)<br>                    ereport(ERROR,<br>                            (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                             errmsg(&quot;column %d of the partition key has type \\&quot;%s\\&quot;, but supplied value is of type \\&quot;%s\\&quot;&quot;,<br>                                    j + <span class=\"hljs-number\">1</span>,<br>                                    format_type_be(key-&gt;parttypid[j]),<br>                                    format_type_be(my_extra-&gt;variadic_type))));<br><br>            fmgr_info_copy(&amp;my_extra-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                           &amp;key-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                           fcinfo-&gt;flinfo-&gt;fn_mcxt);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* Hold lock until commit */</span><br>        relation_close(parent, NoLock);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">if</span> (!OidIsValid(my_extra-&gt;variadic_type))<br>    &#123;<br>        <span class=\"hljs-type\">int</span>            nkeys = my_extra-&gt;nkeys;<br>        <span class=\"hljs-type\">int</span>            i;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         * For a non-variadic call, neither the number of arguments nor their</span><br><span class=\"hljs-comment\">         * types can change across calls, so avoid the expense of rechecking</span><br><span class=\"hljs-comment\">         * here.</span><br><span class=\"hljs-comment\">         */</span><br><br>        <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nkeys; i++)<br>        &#123;<br>            Datum        hash;<br><br>            <span class=\"hljs-comment\">/* keys start from fourth argument of function. */</span><br>            <span class=\"hljs-type\">int</span>            argno = i + <span class=\"hljs-number\">3</span>;<br><br>            <span class=\"hljs-keyword\">if</span> (PG_ARGISNULL(argno))<br>                <span class=\"hljs-keyword\">continue</span>;<br><br>            hash = FunctionCall2Coll(&amp;my_extra-&gt;partsupfunc[i],<br>                                     my_extra-&gt;partcollid[i],<br>                                     PG_GETARG_DATUM(argno),<br>                                     seed);<br><br>            <span class=\"hljs-comment\">/* Form a single 64-bit hash value */</span><br>            rowHash = hash_combine64(rowHash, DatumGetUInt64(hash));<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span><br>    &#123;<br>        ArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(<span class=\"hljs-number\">3</span>);<br>        <span class=\"hljs-type\">int</span>            i;<br>        <span class=\"hljs-type\">int</span>            nelems;<br>        Datum       *datum;<br>        <span class=\"hljs-type\">bool</span>       *<span class=\"hljs-keyword\">isnull</span>;<br><br>        deconstruct_array(variadic_array,<br>                          my_extra-&gt;variadic_type,<br>                          my_extra-&gt;variadic_typlen,<br>                          my_extra-&gt;variadic_typbyval,<br>                          my_extra-&gt;variadic_typalign,<br>                          &amp;datum, &amp;<span class=\"hljs-keyword\">isnull</span>, &amp;nelems);<br><br>        <span class=\"hljs-comment\">/* complain if wrong number of column values */</span><br>        <span class=\"hljs-keyword\">if</span> (nelems != my_extra-&gt;nkeys)<br>            ereport(ERROR,<br>                    (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                     errmsg(&quot;number of partitioning columns (%d) does not match number of partition keys provided (%d)&quot;,<br>                            my_extra-&gt;nkeys, nelems)));<br><br>        <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nelems; i++)<br>        &#123;<br>            Datum        hash;<br><br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">isnull</span>[i])<br>                <span class=\"hljs-keyword\">continue</span>;<br><br>            hash = FunctionCall2Coll(&amp;my_extra-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                                     my_extra-&gt;partcollid[<span class=\"hljs-number\">0</span>],<br>                                     datum[i],<br>                                     seed);<br><br>            <span class=\"hljs-comment\">/* Form a single 64-bit hash value */</span><br>            rowHash = hash_combine64(rowHash, DatumGetUInt64(hash));<br>        &#125;<br>    &#125;<br><br>    PG_RETURN_UINT64(rowHash % modulus);<br>&#125;<br><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">gcc -fPIC -c partvalue.c -I /home/postgres/pg12/include<span class=\"hljs-built_in\">/server </span>; cc -shared -o partvalue.so partvalue.o<br></code></pre></td></tr></table></figure>\n<h1 id=\"创建函数\"><a href=\"#创建函数\" class=\"headerlink\" title=\"创建函数\"></a>创建函数</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">FUNCTION</span> satisfies_hash_partition_value(<span class=\"hljs-type\">oid</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-keyword\">VARIADIC</span> &quot;any&quot;) <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-type\">bigint</span><br>     <span class=\"hljs-keyword\">AS</span> <span class=\"hljs-string\">&#x27;/home/postgres/partvalue&#x27;</span>, <span class=\"hljs-string\">&#x27;satisfies_hash_partition_value&#x27;</span><br>     <span class=\"hljs-keyword\">LANGUAGE</span> C <span class=\"hljs-keyword\">STRICT</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">FUNCTION</span><br>postgres=# \\df+ satisfies_hash_partition_value<br>                                                                                                           List <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">functions</span><br> <span class=\"hljs-keyword\">Schema</span> |              <span class=\"hljs-type\">Name</span>              | Result data <span class=\"hljs-keyword\">type</span> |          Argument data <span class=\"hljs-keyword\">types</span>          | <span class=\"hljs-keyword\">Type</span> | Volatility | Parallel |  <span class=\"hljs-keyword\">Owner</span>   | <span class=\"hljs-keyword\">Security</span> | <span class=\"hljs-keyword\">Access</span> <span class=\"hljs-keyword\">privileges</span> | <span class=\"hljs-keyword\">Language</span> |          Source code           | Description<br><span class=\"hljs-comment\">--------+--------------------------------+------------------+---------------------------------------+------+------------+----------+----------+----------+-------------------+----------+--------------------------------+-------------</span><br> <span class=\"hljs-built_in\">public</span> | satisfies_hash_partition_value | <span class=\"hljs-type\">bigint</span>           | <span class=\"hljs-type\">oid</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-keyword\">VARIADIC</span> &quot;any&quot; | func | <span class=\"hljs-keyword\">volatile</span>   | unsafe   | postgres | <span class=\"hljs-keyword\">invoker</span>  |                   | c        | satisfies_hash_partition_value |<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>postgres=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# insert <span class=\"hljs-built_in\">int</span>o userinfo select id, <span class=\"hljs-string\">&#x27;userinfo_&#x27;</span>|| satisfies_hash_partition_value(<span class=\"hljs-string\">&#x27;18544&#x27;</span>::oid, <span class=\"hljs-number\">16</span>, <span class=\"hljs-number\">0</span>, id),  now() - (id || <span class=\"hljs-string\">&#x27; sec&#x27;</span>)::<span class=\"hljs-built_in\">int</span>erval <span class=\"hljs-keyword\">from</span> generate_series(<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">50</span>) id;<br>INSERT <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">50</span><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo;<br> userid |  username   |           ctime<br>--------+-------------+----------------------------<br>     <span class=\"hljs-number\">14</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">55.519518</span><br>     <span class=\"hljs-number\">26</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">43.519518</span><br>     <span class=\"hljs-number\">34</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">35.519518</span><br>     <span class=\"hljs-number\">11</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">58.519518</span><br>     <span class=\"hljs-number\">19</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">50.519518</span><br>     <span class=\"hljs-number\">21</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">48.519518</span><br>     <span class=\"hljs-number\">36</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">33.519518</span><br>     <span class=\"hljs-number\">42</span> | userinfo_2  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">27.519518</span><br>      <span class=\"hljs-number\">4</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">05.519518</span><br>      <span class=\"hljs-number\">6</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">03.519518</span><br>     <span class=\"hljs-number\">24</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">45.519518</span><br>     <span class=\"hljs-number\">29</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">40.519518</span><br>     <span class=\"hljs-number\">44</span> | userinfo_4  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">25.519518</span><br>     <span class=\"hljs-number\">50</span> | userinfo_4  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">19.519518</span><br>      <span class=\"hljs-number\">8</span> | userinfo_5  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">01.519518</span><br>     <span class=\"hljs-number\">13</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">56.519518</span><br>     <span class=\"hljs-number\">23</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">46.519518</span><br>     <span class=\"hljs-number\">39</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">30.519518</span><br>     <span class=\"hljs-number\">48</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">21.519518</span><br>     <span class=\"hljs-number\">49</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">20.519518</span><br>      <span class=\"hljs-number\">7</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">02.519518</span><br>     <span class=\"hljs-number\">10</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">59.519518</span><br>     <span class=\"hljs-number\">22</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">47.519518</span><br>      <span class=\"hljs-number\">1</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">08.519518</span><br>     <span class=\"hljs-number\">16</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">53.519518</span><br>     <span class=\"hljs-number\">28</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">41.519518</span><br>     <span class=\"hljs-number\">30</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">39.519518</span><br>     <span class=\"hljs-number\">32</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">37.519518</span><br>      <span class=\"hljs-number\">3</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">06.519518</span><br>     <span class=\"hljs-number\">31</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">38.519518</span><br>     <span class=\"hljs-number\">35</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">34.519518</span><br>     <span class=\"hljs-number\">37</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">32.519518</span><br>     <span class=\"hljs-number\">38</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">31.519518</span><br>      <span class=\"hljs-number\">2</span> | userinfo_10 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">07.519518</span><br>     <span class=\"hljs-number\">47</span> | userinfo_10 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">22.519518</span><br>     <span class=\"hljs-number\">15</span> | userinfo_11 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">54.519518</span><br>     <span class=\"hljs-number\">12</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">57.519518</span><br>     <span class=\"hljs-number\">17</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">52.519518</span><br>     <span class=\"hljs-number\">45</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">24.519518</span><br>      <span class=\"hljs-number\">5</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">04.519518</span><br>      <span class=\"hljs-number\">9</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">00.519518</span><br>     <span class=\"hljs-number\">20</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">49.519518</span><br>     <span class=\"hljs-number\">41</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">28.519518</span><br>     <span class=\"hljs-number\">46</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">23.519518</span><br>     <span class=\"hljs-number\">18</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">51.519518</span><br>     <span class=\"hljs-number\">25</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">44.519518</span><br>     <span class=\"hljs-number\">27</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">42.519518</span><br>     <span class=\"hljs-number\">43</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">26.519518</span><br>     <span class=\"hljs-number\">33</span> | userinfo_15 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">36.519518</span><br>     <span class=\"hljs-number\">40</span> | userinfo_15 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">29.519518</span><br>(<span class=\"hljs-number\">50</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_0;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">14</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">55.519518</span><br>     <span class=\"hljs-number\">26</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">43.519518</span><br>     <span class=\"hljs-number\">34</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">35.519518</span><br>(<span class=\"hljs-number\">3</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_1;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">11</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">58.519518</span><br>     <span class=\"hljs-number\">19</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">50.519518</span><br>     <span class=\"hljs-number\">21</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">48.519518</span><br>     <span class=\"hljs-number\">36</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">33.519518</span><br>(<span class=\"hljs-number\">4</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_2;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">42</span> | userinfo_2 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">27.519518</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_3;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>      <span class=\"hljs-number\">4</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">05.519518</span><br>      <span class=\"hljs-number\">6</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">03.519518</span><br>     <span class=\"hljs-number\">24</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">45.519518</span><br>     <span class=\"hljs-number\">29</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">40.519518</span><br>(<span class=\"hljs-number\">4</span> rows)<br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>简单的修改了postgresql-12.3/src/backend/partitioning/partbounds.c代码， 创建C函数获取PostgreSQL hash 分区表hash value<br>","more":"</p>\n<h1 id=\"表结构\"><a href=\"#表结构\" class=\"headerlink\" title=\"表结构\"></a>表结构</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">postgres=<span class=\"hljs-comment\"># \\d+ userinfo</span><br>                                        Partitioned table &quot;public.userinfo&quot;<br>  Column  |              Type              | Collation | Nullable | Default | Storage  | Stats target | Description<br><span class=\"hljs-comment\">----------+--------------------------------+-----------+----------+---------+----------+--------------+-------------</span><br> userid   | integer                        |           |          |         | plain    |              |<br> username | character varying(64)          |           |          |         | extended |              |<br> ctime    | timestamp(6) without time zone |           |          |         | plain    |              |<br>Partition key: HASH (userid)<br>Indexes:<br>    &quot;idx_userinfo_userid&quot; btree (userid)<br>    &quot;idx_userinfo_username&quot; btree (username)<br>Partitions: userinfo_0 FOR <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">0</span>),<br>            userinfo_1 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">1</span>),<br>            userinfo_10 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">10</span>),<br>            userinfo_11 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">11</span>),<br>            userinfo_12 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">12</span>),<br>            userinfo_13 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">13</span>),<br>            userinfo_14 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">14</span>),<br>            userinfo_15 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">15</span>),<br>            userinfo_2 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">2</span>),<br>            userinfo_3 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">3</span>),<br>            userinfo_4 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">4</span>),<br>            userinfo_5 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">5</span>),<br>            userinfo_6 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">6</span>),<br>            userinfo_7 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">7</span>),<br>            userinfo_8 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">8</span>),<br>            userinfo_9 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">VALUES</span> <span class=\"hljs-keyword\">WITH</span> (modulus <span class=\"hljs-number\">16</span>, <span class=\"hljs-keyword\">remainder</span> <span class=\"hljs-number\">9</span>)<br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h1><p>vim partvalue.c<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-meta\">#include &quot;postgres.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;fmgr.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;funcapi.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/relation.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/table.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;access/tableam.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/partition.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/pg_inherits.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;catalog/pg_type.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;commands/tablecmds.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;executor/executor.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;miscadmin.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;nodes/makefuncs.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;nodes/nodeFuncs.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;parser/parse_coerce.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partbounds.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partdesc.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;partitioning/partprune.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/builtins.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/datum.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/fmgroids.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/hashutils.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/lsyscache.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/partcache.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/rel.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/snapmgr.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/ruleutils.h&quot;</span><br><span class=\"hljs-meta\">#include &quot;utils/syscache.h&quot;</span><br><br><br><br>PG_MODULE_MAGIC;<br><br>PG_FUNCTION_INFO_V1(satisfies_hash_partition_value);<br><span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\"> * satisfies_hash_partition</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * This is an SQL-callable function for use in hash partition constraints.</span><br><span class=\"hljs-comment\"> * The first three arguments are the parent table OID, modulus, and remainder.</span><br><span class=\"hljs-comment\"> * The remaining arguments are the value of the partitioning columns (or</span><br><span class=\"hljs-comment\"> * expressions); these are hashed and the results are combined into a single</span><br><span class=\"hljs-comment\"> * hash value by calling hash_combine64.</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * Returns true if remainder produced when this computed single hash value is</span><br><span class=\"hljs-comment\"> * divided by the given modulus is equal to given remainder, otherwise false.</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * See get_qual_for_hash() for usage.</span><br><span class=\"hljs-comment\"> */</span><br>Datum<br>satisfies_hash_partition_value(PG_FUNCTION_ARGS)<br>&#123;<br>    typedef struct ColumnsHashData<br>    &#123;<br>        <span class=\"hljs-type\">Oid</span>            relid;<br>        <span class=\"hljs-type\">int</span>            nkeys;<br>        <span class=\"hljs-type\">Oid</span>            variadic_type;<br>        int16        variadic_typlen;<br>        <span class=\"hljs-type\">bool</span>        variadic_typbyval;<br>        <span class=\"hljs-type\">char</span>        variadic_typalign;<br>        <span class=\"hljs-type\">Oid</span>            partcollid[PARTITION_MAX_KEYS];<br>        FmgrInfo    partsupfunc[FLEXIBLE_ARRAY_MEMBER];<br>    &#125; ColumnsHashData;<br>    <span class=\"hljs-type\">Oid</span>            parentId;<br>    <span class=\"hljs-type\">int</span>            modulus;<br>    <span class=\"hljs-type\">int</span>            remainder;<br>    Datum        seed = UInt64GetDatum(HASH_PARTITION_SEED);<br>    ColumnsHashData *my_extra;<br>    uint64        rowHash = <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-comment\">/* Return null if the parent OID, modulus, or remainder is NULL. */</span><br>    <span class=\"hljs-keyword\">if</span> (PG_ARGISNULL(<span class=\"hljs-number\">0</span>) || PG_ARGISNULL(<span class=\"hljs-number\">1</span>) || PG_ARGISNULL(<span class=\"hljs-number\">2</span>))<br>        PG_RETURN_NULL();<br>    parentId = PG_GETARG_OID(<span class=\"hljs-number\">0</span>);<br>    modulus = PG_GETARG_INT32(<span class=\"hljs-number\">1</span>);<br>    remainder = PG_GETARG_INT32(<span class=\"hljs-number\">2</span>);<br><br>    <span class=\"hljs-comment\">/* Sanity check modulus and remainder. */</span><br>    <span class=\"hljs-keyword\">if</span> (modulus &lt;= <span class=\"hljs-number\">0</span>)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;modulus for hash partition must be a positive integer&quot;)));<br>    <span class=\"hljs-keyword\">if</span> (remainder &lt; <span class=\"hljs-number\">0</span>)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;remainder for hash partition must be a non-negative integer&quot;)));<br>    <span class=\"hljs-keyword\">if</span> (remainder &gt;= modulus)<br>        ereport(ERROR,<br>                (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                 errmsg(&quot;remainder for hash partition must be less than modulus&quot;)));<br><br>    <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">     * Cache hash function information.</span><br><span class=\"hljs-comment\">     */</span><br>    my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>    <span class=\"hljs-keyword\">if</span> (my_extra == <span class=\"hljs-keyword\">NULL</span> || my_extra-&gt;relid != parentId)<br>    &#123;<br>        Relation    parent;<br>        PartitionKey key;<br>        <span class=\"hljs-type\">int</span>            j;<br><br>        <span class=\"hljs-comment\">/* Open parent relation and fetch partition keyinfo */</span><br>        parent = try_relation_open(parentId, AccessShareLock);<br>        <span class=\"hljs-keyword\">if</span> (parent == <span class=\"hljs-keyword\">NULL</span>)<br>            PG_RETURN_NULL();<br>        key = RelationGetPartitionKey(parent);<br><br>        <span class=\"hljs-comment\">/* Reject parent table that is not hash-partitioned. */</span><br>        <span class=\"hljs-keyword\">if</span> (parent-&gt;rd_rel-&gt;relkind != RELKIND_PARTITIONED_TABLE ||<br>            key-&gt;strategy != PARTITION_STRATEGY_HASH)<br>            ereport(ERROR,<br>                    (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                     errmsg(&quot;\\&quot;%s\\&quot; is not a hash partitioned table&quot;,<br>                            get_rel_name(parentId))));<br><br>        <span class=\"hljs-keyword\">if</span> (!get_fn_expr_variadic(fcinfo-&gt;flinfo))<br>        &#123;<br>            <span class=\"hljs-type\">int</span>            nargs = PG_NARGS() - <span class=\"hljs-number\">3</span>;<br><br>            <span class=\"hljs-comment\">/* complain if wrong number of column values */</span><br>            <span class=\"hljs-keyword\">if</span> (key-&gt;partnatts != nargs)<br>                ereport(ERROR,<br>                        (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                         errmsg(&quot;number of partitioning columns (%d) does not match number of partition keys provided (%d)&quot;,<br>                                key-&gt;partnatts, nargs)));<br><br>            <span class=\"hljs-comment\">/* allocate space for our cache */</span><br>            fcinfo-&gt;flinfo-&gt;fn_extra =<br>                MemoryContextAllocZero(fcinfo-&gt;flinfo-&gt;fn_mcxt,<br>                                       offsetof(ColumnsHashData, partsupfunc) +<br>                                       sizeof(FmgrInfo) * nargs);<br>            my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>            my_extra-&gt;relid = parentId;<br>            my_extra-&gt;nkeys = key-&gt;partnatts;<br>            memcpy(my_extra-&gt;partcollid, key-&gt;partcollation,<br>                   key-&gt;partnatts * sizeof(<span class=\"hljs-type\">Oid</span>));<br><br>            <span class=\"hljs-comment\">/* check argument types and save fmgr_infos */</span><br>            <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; key-&gt;partnatts; ++j)<br>            &#123;<br>                <span class=\"hljs-type\">Oid</span>            argtype = get_fn_expr_argtype(fcinfo-&gt;flinfo, j + <span class=\"hljs-number\">3</span>);<br><br>                <span class=\"hljs-keyword\">if</span> (argtype != key-&gt;parttypid[j] &amp;&amp; !IsBinaryCoercible(argtype, key-&gt;parttypid[j]))<br>                    ereport(ERROR,<br>                            (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                             errmsg(&quot;column %d of the partition key has type \\&quot;%s\\&quot;, but supplied value is of type \\&quot;%s\\&quot;&quot;,<br>                                    j + <span class=\"hljs-number\">1</span>, format_type_be(key-&gt;parttypid[j]), format_type_be(argtype))));<br><br>                fmgr_info_copy(&amp;my_extra-&gt;partsupfunc[j],<br>                               &amp;key-&gt;partsupfunc[j],<br>                               fcinfo-&gt;flinfo-&gt;fn_mcxt);<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-keyword\">else</span><br>        &#123;<br>            ArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(<span class=\"hljs-number\">3</span>);<br><br>            <span class=\"hljs-comment\">/* allocate space for our cache -- just one FmgrInfo in this case */</span><br>            fcinfo-&gt;flinfo-&gt;fn_extra =<br>                MemoryContextAllocZero(fcinfo-&gt;flinfo-&gt;fn_mcxt,<br>                                       offsetof(ColumnsHashData, partsupfunc) +<br>                                       sizeof(FmgrInfo));<br>            my_extra = (ColumnsHashData *) fcinfo-&gt;flinfo-&gt;fn_extra;<br>            my_extra-&gt;relid = parentId;<br>            my_extra-&gt;nkeys = key-&gt;partnatts;<br>            my_extra-&gt;variadic_type = ARR_ELEMTYPE(variadic_array);<br>            get_typlenbyvalalign(my_extra-&gt;variadic_type,<br>                                 &amp;my_extra-&gt;variadic_typlen,<br>                                 &amp;my_extra-&gt;variadic_typbyval,<br>                                 &amp;my_extra-&gt;variadic_typalign);<br>            my_extra-&gt;partcollid[<span class=\"hljs-number\">0</span>] = key-&gt;partcollation[<span class=\"hljs-number\">0</span>];<br><br>            <span class=\"hljs-comment\">/* check argument types */</span><br>            <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; key-&gt;partnatts; ++j)<br>                <span class=\"hljs-keyword\">if</span> (key-&gt;parttypid[j] != my_extra-&gt;variadic_type)<br>                    ereport(ERROR,<br>                            (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                             errmsg(&quot;column %d of the partition key has type \\&quot;%s\\&quot;, but supplied value is of type \\&quot;%s\\&quot;&quot;,<br>                                    j + <span class=\"hljs-number\">1</span>,<br>                                    format_type_be(key-&gt;parttypid[j]),<br>                                    format_type_be(my_extra-&gt;variadic_type))));<br><br>            fmgr_info_copy(&amp;my_extra-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                           &amp;key-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                           fcinfo-&gt;flinfo-&gt;fn_mcxt);<br>        &#125;<br><br>        <span class=\"hljs-comment\">/* Hold lock until commit */</span><br>        relation_close(parent, NoLock);<br>    &#125;<br><br>    <span class=\"hljs-keyword\">if</span> (!OidIsValid(my_extra-&gt;variadic_type))<br>    &#123;<br>        <span class=\"hljs-type\">int</span>            nkeys = my_extra-&gt;nkeys;<br>        <span class=\"hljs-type\">int</span>            i;<br><br>        <span class=\"hljs-comment\">/*</span><br><span class=\"hljs-comment\">         * For a non-variadic call, neither the number of arguments nor their</span><br><span class=\"hljs-comment\">         * types can change across calls, so avoid the expense of rechecking</span><br><span class=\"hljs-comment\">         * here.</span><br><span class=\"hljs-comment\">         */</span><br><br>        <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nkeys; i++)<br>        &#123;<br>            Datum        hash;<br><br>            <span class=\"hljs-comment\">/* keys start from fourth argument of function. */</span><br>            <span class=\"hljs-type\">int</span>            argno = i + <span class=\"hljs-number\">3</span>;<br><br>            <span class=\"hljs-keyword\">if</span> (PG_ARGISNULL(argno))<br>                <span class=\"hljs-keyword\">continue</span>;<br><br>            hash = FunctionCall2Coll(&amp;my_extra-&gt;partsupfunc[i],<br>                                     my_extra-&gt;partcollid[i],<br>                                     PG_GETARG_DATUM(argno),<br>                                     seed);<br><br>            <span class=\"hljs-comment\">/* Form a single 64-bit hash value */</span><br>            rowHash = hash_combine64(rowHash, DatumGetUInt64(hash));<br>        &#125;<br>    &#125;<br>    <span class=\"hljs-keyword\">else</span><br>    &#123;<br>        ArrayType  *variadic_array = PG_GETARG_ARRAYTYPE_P(<span class=\"hljs-number\">3</span>);<br>        <span class=\"hljs-type\">int</span>            i;<br>        <span class=\"hljs-type\">int</span>            nelems;<br>        Datum       *datum;<br>        <span class=\"hljs-type\">bool</span>       *<span class=\"hljs-keyword\">isnull</span>;<br><br>        deconstruct_array(variadic_array,<br>                          my_extra-&gt;variadic_type,<br>                          my_extra-&gt;variadic_typlen,<br>                          my_extra-&gt;variadic_typbyval,<br>                          my_extra-&gt;variadic_typalign,<br>                          &amp;datum, &amp;<span class=\"hljs-keyword\">isnull</span>, &amp;nelems);<br><br>        <span class=\"hljs-comment\">/* complain if wrong number of column values */</span><br>        <span class=\"hljs-keyword\">if</span> (nelems != my_extra-&gt;nkeys)<br>            ereport(ERROR,<br>                    (errcode(ERRCODE_INVALID_PARAMETER_VALUE),<br>                     errmsg(&quot;number of partitioning columns (%d) does not match number of partition keys provided (%d)&quot;,<br>                            my_extra-&gt;nkeys, nelems)));<br><br>        <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; nelems; i++)<br>        &#123;<br>            Datum        hash;<br><br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">isnull</span>[i])<br>                <span class=\"hljs-keyword\">continue</span>;<br><br>            hash = FunctionCall2Coll(&amp;my_extra-&gt;partsupfunc[<span class=\"hljs-number\">0</span>],<br>                                     my_extra-&gt;partcollid[<span class=\"hljs-number\">0</span>],<br>                                     datum[i],<br>                                     seed);<br><br>            <span class=\"hljs-comment\">/* Form a single 64-bit hash value */</span><br>            rowHash = hash_combine64(rowHash, DatumGetUInt64(hash));<br>        &#125;<br>    &#125;<br><br>    PG_RETURN_UINT64(rowHash % modulus);<br>&#125;<br><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">gcc -fPIC -c partvalue.c -I /home/postgres/pg12/include<span class=\"hljs-built_in\">/server </span>; cc -shared -o partvalue.so partvalue.o<br></code></pre></td></tr></table></figure>\n<h1 id=\"创建函数\"><a href=\"#创建函数\" class=\"headerlink\" title=\"创建函数\"></a>创建函数</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">or replace</span> <span class=\"hljs-keyword\">FUNCTION</span> satisfies_hash_partition_value(<span class=\"hljs-type\">oid</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-keyword\">VARIADIC</span> &quot;any&quot;) <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-type\">bigint</span><br>     <span class=\"hljs-keyword\">AS</span> <span class=\"hljs-string\">&#x27;/home/postgres/partvalue&#x27;</span>, <span class=\"hljs-string\">&#x27;satisfies_hash_partition_value&#x27;</span><br>     <span class=\"hljs-keyword\">LANGUAGE</span> C <span class=\"hljs-keyword\">STRICT</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">FUNCTION</span><br>postgres=# \\df+ satisfies_hash_partition_value<br>                                                                                                           List <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">functions</span><br> <span class=\"hljs-keyword\">Schema</span> |              <span class=\"hljs-type\">Name</span>              | Result data <span class=\"hljs-keyword\">type</span> |          Argument data <span class=\"hljs-keyword\">types</span>          | <span class=\"hljs-keyword\">Type</span> | Volatility | Parallel |  <span class=\"hljs-keyword\">Owner</span>   | <span class=\"hljs-keyword\">Security</span> | <span class=\"hljs-keyword\">Access</span> <span class=\"hljs-keyword\">privileges</span> | <span class=\"hljs-keyword\">Language</span> |          Source code           | Description<br><span class=\"hljs-comment\">--------+--------------------------------+------------------+---------------------------------------+------+------------+----------+----------+----------+-------------------+----------+--------------------------------+-------------</span><br> <span class=\"hljs-built_in\">public</span> | satisfies_hash_partition_value | <span class=\"hljs-type\">bigint</span>           | <span class=\"hljs-type\">oid</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-type\">integer</span>, <span class=\"hljs-keyword\">VARIADIC</span> &quot;any&quot; | func | <span class=\"hljs-keyword\">volatile</span>   | unsafe   | postgres | <span class=\"hljs-keyword\">invoker</span>  |                   | c        | satisfies_hash_partition_value |<br>(<span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">row</span>)<br><br>postgres=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# insert <span class=\"hljs-built_in\">int</span>o userinfo select id, <span class=\"hljs-string\">&#x27;userinfo_&#x27;</span>|| satisfies_hash_partition_value(<span class=\"hljs-string\">&#x27;18544&#x27;</span>::oid, <span class=\"hljs-number\">16</span>, <span class=\"hljs-number\">0</span>, id),  now() - (id || <span class=\"hljs-string\">&#x27; sec&#x27;</span>)::<span class=\"hljs-built_in\">int</span>erval <span class=\"hljs-keyword\">from</span> generate_series(<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">50</span>) id;<br>INSERT <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">50</span><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo;<br> userid |  username   |           ctime<br>--------+-------------+----------------------------<br>     <span class=\"hljs-number\">14</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">55.519518</span><br>     <span class=\"hljs-number\">26</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">43.519518</span><br>     <span class=\"hljs-number\">34</span> | userinfo_0  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">35.519518</span><br>     <span class=\"hljs-number\">11</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">58.519518</span><br>     <span class=\"hljs-number\">19</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">50.519518</span><br>     <span class=\"hljs-number\">21</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">48.519518</span><br>     <span class=\"hljs-number\">36</span> | userinfo_1  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">33.519518</span><br>     <span class=\"hljs-number\">42</span> | userinfo_2  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">27.519518</span><br>      <span class=\"hljs-number\">4</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">05.519518</span><br>      <span class=\"hljs-number\">6</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">03.519518</span><br>     <span class=\"hljs-number\">24</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">45.519518</span><br>     <span class=\"hljs-number\">29</span> | userinfo_3  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">40.519518</span><br>     <span class=\"hljs-number\">44</span> | userinfo_4  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">25.519518</span><br>     <span class=\"hljs-number\">50</span> | userinfo_4  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">19.519518</span><br>      <span class=\"hljs-number\">8</span> | userinfo_5  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">01.519518</span><br>     <span class=\"hljs-number\">13</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">56.519518</span><br>     <span class=\"hljs-number\">23</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">46.519518</span><br>     <span class=\"hljs-number\">39</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">30.519518</span><br>     <span class=\"hljs-number\">48</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">21.519518</span><br>     <span class=\"hljs-number\">49</span> | userinfo_6  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">20.519518</span><br>      <span class=\"hljs-number\">7</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">02.519518</span><br>     <span class=\"hljs-number\">10</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">59.519518</span><br>     <span class=\"hljs-number\">22</span> | userinfo_7  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">47.519518</span><br>      <span class=\"hljs-number\">1</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">08.519518</span><br>     <span class=\"hljs-number\">16</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">53.519518</span><br>     <span class=\"hljs-number\">28</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">41.519518</span><br>     <span class=\"hljs-number\">30</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">39.519518</span><br>     <span class=\"hljs-number\">32</span> | userinfo_8  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">37.519518</span><br>      <span class=\"hljs-number\">3</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">06.519518</span><br>     <span class=\"hljs-number\">31</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">38.519518</span><br>     <span class=\"hljs-number\">35</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">34.519518</span><br>     <span class=\"hljs-number\">37</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">32.519518</span><br>     <span class=\"hljs-number\">38</span> | userinfo_9  | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">31.519518</span><br>      <span class=\"hljs-number\">2</span> | userinfo_10 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">07.519518</span><br>     <span class=\"hljs-number\">47</span> | userinfo_10 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">22.519518</span><br>     <span class=\"hljs-number\">15</span> | userinfo_11 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">54.519518</span><br>     <span class=\"hljs-number\">12</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">57.519518</span><br>     <span class=\"hljs-number\">17</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">52.519518</span><br>     <span class=\"hljs-number\">45</span> | userinfo_12 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">24.519518</span><br>      <span class=\"hljs-number\">5</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">04.519518</span><br>      <span class=\"hljs-number\">9</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">00.519518</span><br>     <span class=\"hljs-number\">20</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">49.519518</span><br>     <span class=\"hljs-number\">41</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">28.519518</span><br>     <span class=\"hljs-number\">46</span> | userinfo_13 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">23.519518</span><br>     <span class=\"hljs-number\">18</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">51.519518</span><br>     <span class=\"hljs-number\">25</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">44.519518</span><br>     <span class=\"hljs-number\">27</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">42.519518</span><br>     <span class=\"hljs-number\">43</span> | userinfo_14 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">26.519518</span><br>     <span class=\"hljs-number\">33</span> | userinfo_15 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">36.519518</span><br>     <span class=\"hljs-number\">40</span> | userinfo_15 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">29.519518</span><br>(<span class=\"hljs-number\">50</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_0;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">14</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">55.519518</span><br>     <span class=\"hljs-number\">26</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">43.519518</span><br>     <span class=\"hljs-number\">34</span> | userinfo_0 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">35.519518</span><br>(<span class=\"hljs-number\">3</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_1;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">11</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">58.519518</span><br>     <span class=\"hljs-number\">19</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">50.519518</span><br>     <span class=\"hljs-number\">21</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">48.519518</span><br>     <span class=\"hljs-number\">36</span> | userinfo_1 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">33.519518</span><br>(<span class=\"hljs-number\">4</span> rows)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_2;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>     <span class=\"hljs-number\">42</span> | userinfo_2 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">27.519518</span><br>(<span class=\"hljs-number\">1</span> row)<br><br>postgres=# select * <span class=\"hljs-keyword\">from</span> userinfo_3;<br> userid |  username  |           ctime<br>--------+------------+----------------------------<br>      <span class=\"hljs-number\">4</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">05.519518</span><br>      <span class=\"hljs-number\">6</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">03.519518</span><br>     <span class=\"hljs-number\">24</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">45.519518</span><br>     <span class=\"hljs-number\">29</span> | userinfo_3 | <span class=\"hljs-number\">2020</span><span class=\"hljs-number\">-09</span><span class=\"hljs-number\">-07</span> <span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">29</span>:<span class=\"hljs-number\">40.519518</span><br>(<span class=\"hljs-number\">4</span> rows)<br><br></code></pre></td></tr></table></figure>"},{"title":"psql显示风格设置","date":"2020-08-05T09:11:24.000Z","top":null,"description":" ","password":null,"_content":"\n# MySQL风格\n```\n\\pset border 2\n \npostgres=# select * from test;\n+----+----+\n| id | c1 |\n+----+----+\n|  1 |  1 |\n|  2 |  2 |\n+----+----+\n(2 rows)\n \npostgres=#\n \n--------------------------------------\n \nmysql> select * from t;\n+------+\n| id   |\n+------+\n|    1 |\n+------+\n1 row in set (0.01 sec)\n \nmysql>\n```\n","source":"_posts/psql显示风格设置.md","raw":"---\ntitle: psql显示风格设置\ndate: 2020-08-05 17:11:24\ntags: psql\ncategories: PostgreSQL\ntop: \ndescription: \" \"\npassword: \n\n---\n\n# MySQL风格\n```\n\\pset border 2\n \npostgres=# select * from test;\n+----+----+\n| id | c1 |\n+----+----+\n|  1 |  1 |\n|  2 |  2 |\n+----+----+\n(2 rows)\n \npostgres=#\n \n--------------------------------------\n \nmysql> select * from t;\n+------+\n| id   |\n+------+\n|    1 |\n+------+\n1 row in set (0.01 sec)\n \nmysql>\n```\n","slug":"psql显示风格设置","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhn0010pieba0mh2ns6","content":"<h1 id=\"MySQL风格\"><a href=\"#MySQL风格\" class=\"headerlink\" title=\"MySQL风格\"></a>MySQL风格</h1><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\">\\pset border 2<br><span class=\"hljs-code\"> </span><br>postgres=# select * from test;<br><span class=\"hljs-code\">+----+</span>----+<br>| id | c1 |<br><span class=\"hljs-code\">+----+</span>----+<br>|  1 |  1 |<br>|  2 |  2 |<br><span class=\"hljs-code\">+----+</span>----+<br>(2 rows)<br><span class=\"hljs-code\"> </span><br>postgres=#<br><span class=\"hljs-code\"> </span><br>--------------------------------------<br><span class=\"hljs-code\"> </span><br>mysql&gt; select * from t;<br><span class=\"hljs-code\">+------+</span><br>| id   |<br><span class=\"hljs-code\">+------+</span><br>|    1 |<br><span class=\"hljs-code\">+------+</span><br>1 row in set (0.01 sec)<br><span class=\"hljs-code\"> </span><br>mysql&gt;<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"MySQL风格\"><a href=\"#MySQL风格\" class=\"headerlink\" title=\"MySQL风格\"></a>MySQL风格</h1><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\">\\pset border 2<br><span class=\"hljs-code\"> </span><br>postgres=# select * from test;<br><span class=\"hljs-code\">+----+</span>----+<br>| id | c1 |<br><span class=\"hljs-code\">+----+</span>----+<br>|  1 |  1 |<br>|  2 |  2 |<br><span class=\"hljs-code\">+----+</span>----+<br>(2 rows)<br><span class=\"hljs-code\"> </span><br>postgres=#<br><span class=\"hljs-code\"> </span><br>--------------------------------------<br><span class=\"hljs-code\"> </span><br>mysql&gt; select * from t;<br><span class=\"hljs-code\">+------+</span><br>| id   |<br><span class=\"hljs-code\">+------+</span><br>|    1 |<br><span class=\"hljs-code\">+------+</span><br>1 row in set (0.01 sec)<br><span class=\"hljs-code\"> </span><br>mysql&gt;<br></code></pre></td></tr></table></figure>\n"},{"title":"python3 ldap3 NTLM验证用户","date":"2020-12-18T09:40:54.000Z","top":1,"description":null,"password":null,"_content":"```\nfrom ldap3 import Server, Connection, NTLM, ALL\n\nserver = Server(\"xxx.xxx.xxx.xxx\", 389, use_ssl=False, get_info=ALL)\nprint(server)\nconn = Connection(server, user=\"Domain\\\\username\", password=\"password\", authentication=NTLM)\nprint(conn.bind())\nprint(conn.extend.standard.who_am_i())\n\n```\n\n","source":"_posts/python3_ldap验证.md","raw":"---\ntitle: python3 ldap3 NTLM验证用户\ndate: 2020-12-18 17:40:54\ntags: \n- python3\n- ldap\ncategories: \n- python\ntop: 1\ndescription: \npassword: \n\n---\n```\nfrom ldap3 import Server, Connection, NTLM, ALL\n\nserver = Server(\"xxx.xxx.xxx.xxx\", 389, use_ssl=False, get_info=ALL)\nprint(server)\nconn = Connection(server, user=\"Domain\\\\username\", password=\"password\", authentication=NTLM)\nprint(conn.bind())\nprint(conn.extend.standard.who_am_i())\n\n```\n\n","slug":"python3_ldap验证","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzho0013piebbsfa7bco","content":"<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-keyword\">from</span> ldap3 import Server, Connection, NTLM, ALL<br><br>server = Server(<span class=\"hljs-string\">&quot;xxx.xxx.xxx.xxx&quot;</span>, 389, <span class=\"hljs-attribute\">use_ssl</span>=<span class=\"hljs-literal\">False</span>, <span class=\"hljs-attribute\">get_info</span>=ALL)<br><span class=\"hljs-builtin-name\">print</span>(server)<br>conn = Connection(server, <span class=\"hljs-attribute\">user</span>=<span class=\"hljs-string\">&quot;Domain\\\\username&quot;</span>, <span class=\"hljs-attribute\">password</span>=<span class=\"hljs-string\">&quot;password&quot;</span>, <span class=\"hljs-attribute\">authentication</span>=NTLM)<br><span class=\"hljs-builtin-name\">print</span>(conn.bind())<br><span class=\"hljs-builtin-name\">print</span>(conn.extend.standard.who_am_i())<br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"","more":"<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-keyword\">from</span> ldap3 import Server, Connection, NTLM, ALL<br><br>server = Server(<span class=\"hljs-string\">&quot;xxx.xxx.xxx.xxx&quot;</span>, 389, <span class=\"hljs-attribute\">use_ssl</span>=<span class=\"hljs-literal\">False</span>, <span class=\"hljs-attribute\">get_info</span>=ALL)<br><span class=\"hljs-builtin-name\">print</span>(server)<br>conn = Connection(server, <span class=\"hljs-attribute\">user</span>=<span class=\"hljs-string\">&quot;Domain\\\\username&quot;</span>, <span class=\"hljs-attribute\">password</span>=<span class=\"hljs-string\">&quot;password&quot;</span>, <span class=\"hljs-attribute\">authentication</span>=NTLM)<br><span class=\"hljs-builtin-name\">print</span>(conn.bind())<br><span class=\"hljs-builtin-name\">print</span>(conn.extend.standard.who_am_i())<br><br></code></pre></td></tr></table></figure>\n"},{"title":"内核Softdog测试","date":"2020-08-04T16:00:00.000Z","top":10,"description":"Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统","password":null,"_content":"\n# Watchdog的功能\n    Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统。\n\n    看门狗模块特依赖所使用的硬件或芯片。个人计算机用户通常不需要看门狗，因为他们可以手动重置系统。但是，watchdog对于任务关键型系统和需要无需人工干预即可自行重启的系统很有用。\n例如，需要自动硬件重置功能的远程位置的服务器。\n\n<!-- more -->\n\n\n\n# Watchdog的实现\n    看门狗功能设置了一个计时器在预定时间后超时。然后看门狗软件定期喂狗(刷新硬件计时器)。如果停止喂狗，到达设定时间后，将会出现狗咬人(执行设备的硬件重置)。\n可以分为hardware watchdog 和 software watchdog。\n    hardware watchdog 是主板芯片的功能。不同的芯片使用不同的模块，例如：Intel 主板使用 “iTCO_wdt”， HP 通常使用 “hpwdt”，IBM 使用 “vmwatchdog”，Xen VM 使用 “xen_wdt”。\n    software watchdog 是Linux内核提供使用内核计时器实现的软件监视程序。\n\n# 测试Linux自带watchdog\n```\n[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件\n/dev/watchdog  /dev/watchdog0\n[root@server6 ~]# lsmod |grep -i soft            #查看softdog是否加载\n[root@server6 ~]# modinfo softdog                #查看softdog模块信息\nfilename:       /lib/modules/3.10.0-957.10.1.el7.x86_64/kernel/drivers/watchdog/softdog.ko.xz\nalias:          char-major-10-130\nlicense:        GPL\ndescription:    Software Watchdog Device Driver\nauthor:         Alan Cox\nretpoline:      Y\nrhelversion:    7.6\nsrcversion:     250C077ED39E75BF25AD8D1\ndepends:\nintree:         Y\nvermagic:       3.10.0-957.10.1.el7.x86_64 SMP mod_unload modversions\nsigner:         CentOS Linux kernel signing key\nsig_key:        17:EA:5F:B9:16:4B:C2:26:55:5C:00:43:FA:D4:E5:86:CC:E8:A2:05\nsig_hashalgo:   sha256\nparm:           soft_margin:Watchdog soft_margin in seconds. (0 < soft_margin < 65536, default=60) (uint)\nparm:           nowayout:Watchdog cannot be stopped once started (default=0) (bool)\nparm:           soft_noboot:Softdog action, set to 1 to ignore reboots, 0 to reboot (default=0) (int)\nparm:           soft_panic:Softdog action, set to 1 to panic, 0 to reboot (default=0) (int)\n\n[root@server6 ~]# modprobe softdog               #加载softdog 可以设置 soft_margin soft_noboot   soft_panic   nowayout等参数\n[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件\n/dev/watchdog  /dev/watchdog0  /dev/watchdog1\n[root@server6 ~]# wdctl /dev/watchdog1           #查看softdog设备文件信息\nDevice:        /dev/watchdog1\nIdentity:      Software Watchdog [version 0]\nTimeout:       60 seconds\nPre-timeout:    0 seconds\nFLAG           DESCRIPTION               STATUS BOOT-STATUS\nKEEPALIVEPING  Keep alive ping reply          1           0\nMAGICCLOSE     Supports magic close char      0           0\nSETTIMEOUT     Set timeout (in seconds)       0           0\n[root@server6 ~]# ehco a >/dev/watchdog          #追加除V以外任意字符到softdog  60秒后系统将重启\nwatchdog   watchdog0  watchdog1\n[root@server6 ~]# echo V >/dev/watchdog1         #取消测试\n```\n# 警告\n\n```\n错误的watchdog配置可能导致以下情形\n    无限重启\n    硬重置导致文件损坏\n    不可预测的重启\n线上服务器慎用。\n```\n#  参考\n```\n    https://linuxhint.com/linux-kernel-watchdog-explained/\n```\n","source":"_posts/softdog.md","raw":"---\ntitle: 内核Softdog测试\ndate: 2020-08-05\ntags: [ Linux, softdog, watchdog ]\ncategories: Linux\ntop: 10\ndescription: Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统\npassword: \n\n---\n\n# Watchdog的功能\n    Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统。\n\n    看门狗模块特依赖所使用的硬件或芯片。个人计算机用户通常不需要看门狗，因为他们可以手动重置系统。但是，watchdog对于任务关键型系统和需要无需人工干预即可自行重启的系统很有用。\n例如，需要自动硬件重置功能的远程位置的服务器。\n\n<!-- more -->\n\n\n\n# Watchdog的实现\n    看门狗功能设置了一个计时器在预定时间后超时。然后看门狗软件定期喂狗(刷新硬件计时器)。如果停止喂狗，到达设定时间后，将会出现狗咬人(执行设备的硬件重置)。\n可以分为hardware watchdog 和 software watchdog。\n    hardware watchdog 是主板芯片的功能。不同的芯片使用不同的模块，例如：Intel 主板使用 “iTCO_wdt”， HP 通常使用 “hpwdt”，IBM 使用 “vmwatchdog”，Xen VM 使用 “xen_wdt”。\n    software watchdog 是Linux内核提供使用内核计时器实现的软件监视程序。\n\n# 测试Linux自带watchdog\n```\n[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件\n/dev/watchdog  /dev/watchdog0\n[root@server6 ~]# lsmod |grep -i soft            #查看softdog是否加载\n[root@server6 ~]# modinfo softdog                #查看softdog模块信息\nfilename:       /lib/modules/3.10.0-957.10.1.el7.x86_64/kernel/drivers/watchdog/softdog.ko.xz\nalias:          char-major-10-130\nlicense:        GPL\ndescription:    Software Watchdog Device Driver\nauthor:         Alan Cox\nretpoline:      Y\nrhelversion:    7.6\nsrcversion:     250C077ED39E75BF25AD8D1\ndepends:\nintree:         Y\nvermagic:       3.10.0-957.10.1.el7.x86_64 SMP mod_unload modversions\nsigner:         CentOS Linux kernel signing key\nsig_key:        17:EA:5F:B9:16:4B:C2:26:55:5C:00:43:FA:D4:E5:86:CC:E8:A2:05\nsig_hashalgo:   sha256\nparm:           soft_margin:Watchdog soft_margin in seconds. (0 < soft_margin < 65536, default=60) (uint)\nparm:           nowayout:Watchdog cannot be stopped once started (default=0) (bool)\nparm:           soft_noboot:Softdog action, set to 1 to ignore reboots, 0 to reboot (default=0) (int)\nparm:           soft_panic:Softdog action, set to 1 to panic, 0 to reboot (default=0) (int)\n\n[root@server6 ~]# modprobe softdog               #加载softdog 可以设置 soft_margin soft_noboot   soft_panic   nowayout等参数\n[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件\n/dev/watchdog  /dev/watchdog0  /dev/watchdog1\n[root@server6 ~]# wdctl /dev/watchdog1           #查看softdog设备文件信息\nDevice:        /dev/watchdog1\nIdentity:      Software Watchdog [version 0]\nTimeout:       60 seconds\nPre-timeout:    0 seconds\nFLAG           DESCRIPTION               STATUS BOOT-STATUS\nKEEPALIVEPING  Keep alive ping reply          1           0\nMAGICCLOSE     Supports magic close char      0           0\nSETTIMEOUT     Set timeout (in seconds)       0           0\n[root@server6 ~]# ehco a >/dev/watchdog          #追加除V以外任意字符到softdog  60秒后系统将重启\nwatchdog   watchdog0  watchdog1\n[root@server6 ~]# echo V >/dev/watchdog1         #取消测试\n```\n# 警告\n\n```\n错误的watchdog配置可能导致以下情形\n    无限重启\n    硬重置导致文件损坏\n    不可预测的重启\n线上服务器慎用。\n```\n#  参考\n```\n    https://linuxhint.com/linux-kernel-watchdog-explained/\n```\n","slug":"softdog","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhp0016pieb3c0910na","content":"<h1 id=\"Watchdog的功能\"><a href=\"#Watchdog的功能\" class=\"headerlink\" title=\"Watchdog的功能\"></a>Watchdog的功能</h1><pre><code>Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统。\n\n看门狗模块特依赖所使用的硬件或芯片。个人计算机用户通常不需要看门狗，因为他们可以手动重置系统。但是，watchdog对于任务关键型系统和需要无需人工干预即可自行重启的系统很有用。\n</code></pre><p>例如，需要自动硬件重置功能的远程位置的服务器。</p>\n<a id=\"more\"></a>\n<h1 id=\"Watchdog的实现\"><a href=\"#Watchdog的实现\" class=\"headerlink\" title=\"Watchdog的实现\"></a>Watchdog的实现</h1><pre><code>看门狗功能设置了一个计时器在预定时间后超时。然后看门狗软件定期喂狗(刷新硬件计时器)。如果停止喂狗，到达设定时间后，将会出现狗咬人(执行设备的硬件重置)。\n</code></pre><p>可以分为hardware watchdog 和 software watchdog。<br>    hardware watchdog 是主板芯片的功能。不同的芯片使用不同的模块，例如：Intel 主板使用 “iTCO_wdt”， HP 通常使用 “hpwdt”，IBM 使用 “vmwatchdog”，Xen VM 使用 “xen_wdt”。<br>    software watchdog 是Linux内核提供使用内核计时器实现的软件监视程序。</p>\n<h1 id=\"测试Linux自带watchdog\"><a href=\"#测试Linux自带watchdog\" class=\"headerlink\" title=\"测试Linux自带watchdog\"></a>测试Linux自带watchdog</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class=\"hljs-built_in\">/watchdog </span> /dev/watchdog0<br>[root@server6 ~]# lsmod |grep -i soft            #查看softdog是否加载<br>[root@server6 ~]# modinfo softdog                #查看softdog模块信息<br>filename:       /lib/modules/3.10.0-957.10.1.el7.x86_64/kernel/drivers/watchdog/softdog.ko.xz<br>alias:          char-major-10-130<br>license:        GPL<br>description:    Software<span class=\"hljs-built_in\"> Watchdog </span>Device Driver<br>author:         Alan Cox<br>retpoline:      Y<br>rhelversion:    7.6<br>srcversion:     250C077ED39E75BF25AD8D1<br>depends:<br>intree:         Y<br>vermagic:       3.10.0-957.10.1.el7.x86_64 SMP mod_unload modversions<br>signer:         CentOS Linux kernel signing key<br>sig_key:        17:EA:5F:B9:16:4B:C2:26:55:5C:00:43:FA:D4:E5:86:CC:E8:A2:05<br>sig_hashalgo:   sha256<br>parm:           soft_margin:Watchdog soft_margin <span class=\"hljs-keyword\">in</span> seconds. (0 &lt; soft_margin &lt; 65536, <span class=\"hljs-attribute\">default</span>=60) (uint)<br>parm:           nowayout:Watchdog cannot be stopped once started (<span class=\"hljs-attribute\">default</span>=0) (bool)<br>parm:           soft_noboot:Softdog action, <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> 1 <span class=\"hljs-keyword\">to</span> ignore reboots, 0 <span class=\"hljs-keyword\">to</span> reboot (<span class=\"hljs-attribute\">default</span>=0) (int)<br>parm:           soft_panic:Softdog action, <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> 1 <span class=\"hljs-keyword\">to</span> panic, 0 <span class=\"hljs-keyword\">to</span> reboot (<span class=\"hljs-attribute\">default</span>=0) (int)<br><br>[root@server6 ~]# modprobe softdog               #加载softdog 可以设置 soft_margin soft_noboot   soft_panic   nowayout等参数<br>[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class=\"hljs-built_in\">/watchdog </span> /dev/watchdog0  /dev/watchdog1<br>[root@server6 ~]# wdctl /dev/watchdog1           #查看softdog设备文件信息<br>Device:        /dev/watchdog1<br>Identity:      Software<span class=\"hljs-built_in\"> Watchdog </span>[version 0]<br>Timeout:       60 seconds<br>Pre-timeout:    0 seconds<br>FLAG           DESCRIPTION               STATUS BOOT-STATUS<br>KEEPALIVEPING  Keep alive<span class=\"hljs-built_in\"> ping </span>reply          1           0<br>MAGICCLOSE     Supports magic close char      0           0<br>SETTIMEOUT     <span class=\"hljs-builtin-name\">Set</span> timeout (<span class=\"hljs-keyword\">in</span> seconds)       0           0<br>[root@server6 ~]# ehco a &gt;/dev<span class=\"hljs-built_in\">/watchdog </span>         #追加除V以外任意字符到softdog  60秒后系统将重启<br>watchdog   watchdog0  watchdog1<br>[root@server6 ~]# echo V &gt;/dev/watchdog1         #取消测试<br></code></pre></td></tr></table></figure>\n<h1 id=\"警告\"><a href=\"#警告\" class=\"headerlink\" title=\"警告\"></a>警告</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs plain\">错误的watchdog配置可能导致以下情形<br>    无限重启<br>    硬重置导致文件损坏<br>    不可预测的重启<br>线上服务器慎用。<br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>linuxhint.com<span class=\"hljs-regexp\">/linux-kernel-watchdog-explained/</span><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"Watchdog的功能\"><a href=\"#Watchdog的功能\" class=\"headerlink\" title=\"Watchdog的功能\"></a>Watchdog的功能</h1><pre><code>Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统。\n\n看门狗模块特依赖所使用的硬件或芯片。个人计算机用户通常不需要看门狗，因为他们可以手动重置系统。但是，watchdog对于任务关键型系统和需要无需人工干预即可自行重启的系统很有用。\n</code></pre><p>例如，需要自动硬件重置功能的远程位置的服务器。</p>","more":"<h1 id=\"Watchdog的实现\"><a href=\"#Watchdog的实现\" class=\"headerlink\" title=\"Watchdog的实现\"></a>Watchdog的实现</h1><pre><code>看门狗功能设置了一个计时器在预定时间后超时。然后看门狗软件定期喂狗(刷新硬件计时器)。如果停止喂狗，到达设定时间后，将会出现狗咬人(执行设备的硬件重置)。\n</code></pre><p>可以分为hardware watchdog 和 software watchdog。<br>    hardware watchdog 是主板芯片的功能。不同的芯片使用不同的模块，例如：Intel 主板使用 “iTCO_wdt”， HP 通常使用 “hpwdt”，IBM 使用 “vmwatchdog”，Xen VM 使用 “xen_wdt”。<br>    software watchdog 是Linux内核提供使用内核计时器实现的软件监视程序。</p>\n<h1 id=\"测试Linux自带watchdog\"><a href=\"#测试Linux自带watchdog\" class=\"headerlink\" title=\"测试Linux自带watchdog\"></a>测试Linux自带watchdog</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class=\"hljs-built_in\">/watchdog </span> /dev/watchdog0<br>[root@server6 ~]# lsmod |grep -i soft            #查看softdog是否加载<br>[root@server6 ~]# modinfo softdog                #查看softdog模块信息<br>filename:       /lib/modules/3.10.0-957.10.1.el7.x86_64/kernel/drivers/watchdog/softdog.ko.xz<br>alias:          char-major-10-130<br>license:        GPL<br>description:    Software<span class=\"hljs-built_in\"> Watchdog </span>Device Driver<br>author:         Alan Cox<br>retpoline:      Y<br>rhelversion:    7.6<br>srcversion:     250C077ED39E75BF25AD8D1<br>depends:<br>intree:         Y<br>vermagic:       3.10.0-957.10.1.el7.x86_64 SMP mod_unload modversions<br>signer:         CentOS Linux kernel signing key<br>sig_key:        17:EA:5F:B9:16:4B:C2:26:55:5C:00:43:FA:D4:E5:86:CC:E8:A2:05<br>sig_hashalgo:   sha256<br>parm:           soft_margin:Watchdog soft_margin <span class=\"hljs-keyword\">in</span> seconds. (0 &lt; soft_margin &lt; 65536, <span class=\"hljs-attribute\">default</span>=60) (uint)<br>parm:           nowayout:Watchdog cannot be stopped once started (<span class=\"hljs-attribute\">default</span>=0) (bool)<br>parm:           soft_noboot:Softdog action, <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> 1 <span class=\"hljs-keyword\">to</span> ignore reboots, 0 <span class=\"hljs-keyword\">to</span> reboot (<span class=\"hljs-attribute\">default</span>=0) (int)<br>parm:           soft_panic:Softdog action, <span class=\"hljs-builtin-name\">set</span> <span class=\"hljs-keyword\">to</span> 1 <span class=\"hljs-keyword\">to</span> panic, 0 <span class=\"hljs-keyword\">to</span> reboot (<span class=\"hljs-attribute\">default</span>=0) (int)<br><br>[root@server6 ~]# modprobe softdog               #加载softdog 可以设置 soft_margin soft_noboot   soft_panic   nowayout等参数<br>[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class=\"hljs-built_in\">/watchdog </span> /dev/watchdog0  /dev/watchdog1<br>[root@server6 ~]# wdctl /dev/watchdog1           #查看softdog设备文件信息<br>Device:        /dev/watchdog1<br>Identity:      Software<span class=\"hljs-built_in\"> Watchdog </span>[version 0]<br>Timeout:       60 seconds<br>Pre-timeout:    0 seconds<br>FLAG           DESCRIPTION               STATUS BOOT-STATUS<br>KEEPALIVEPING  Keep alive<span class=\"hljs-built_in\"> ping </span>reply          1           0<br>MAGICCLOSE     Supports magic close char      0           0<br>SETTIMEOUT     <span class=\"hljs-builtin-name\">Set</span> timeout (<span class=\"hljs-keyword\">in</span> seconds)       0           0<br>[root@server6 ~]# ehco a &gt;/dev<span class=\"hljs-built_in\">/watchdog </span>         #追加除V以外任意字符到softdog  60秒后系统将重启<br>watchdog   watchdog0  watchdog1<br>[root@server6 ~]# echo V &gt;/dev/watchdog1         #取消测试<br></code></pre></td></tr></table></figure>\n<h1 id=\"警告\"><a href=\"#警告\" class=\"headerlink\" title=\"警告\"></a>警告</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs plain\">错误的watchdog配置可能导致以下情形<br>    无限重启<br>    硬重置导致文件损坏<br>    不可预测的重启<br>线上服务器慎用。<br></code></pre></td></tr></table></figure>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>linuxhint.com<span class=\"hljs-regexp\">/linux-kernel-watchdog-explained/</span><br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL Postgis 源码安装","date":"2020-08-11T06:56:15.000Z","top":15,"description":null,"password":null,"_content":"\n为PostgreSQL 12.3 安装Postgis 2.5.4\n\n# postgis 源码下载\n\n巨慢, 耐心等待吧\n```\npostgres@jintao-ThinkPad-L490:~/download$ wget https://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\n--2020-08-11 14:57:46--  https://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\nResolving download.osgeo.org (download.osgeo.org)... 140.211.15.30\nConnecting to download.osgeo.org (download.osgeo.org)|140.211.15.30|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 16041872 (15M) [application/octet-stream]\nSaving to: ‘postgis-2.5.4.tar.gz’\n\npostgis-2.5.4.tar.gz       6%[======>                                                    ]   1016K  5.72KB/s    eta 43m 7s\n```\n[其他版本下载地址](https://git.osgeo.org/gitea/postgis/postgis/branches/)\n<!-- more -->\n\n# 依赖下载 && 编译 && 安装\n\n安装postgis2.5.4需要对应的包及其版本详见[install_requirements](https://postgis.net/docs/manual-2.5/postgis_installation.html#install_requirements)\n\n## zlib1g-dev和libxml2\n```\nsudo apt-get install zlib1g-dev\nsudo apt-get install libxml2-dev\n```\n\n## geos\n\n编译时间很长\n```\n wget http://download.osgeo.org/geos/geos-3.7.2.tar.bz2\n tar -jxvf geos-3.7.2.tar.bz2\n cd geos-3.7.2\n ./configure prefix=/home/postgres/pg12/geos\n make -j10\n make install\n```\n\n## proj\n\n```\n wget  http://download.osgeo.org/proj/proj-4.9.2.tar.gz\n tar -zxvf proj-4.9.2.tar.gz\n cd proj-4.9.2/\n ./configure prefix=/home/postgres/pg12/proj\n make -j10\n make install\n```\n\n## gdal\n\n编译时间很长\n```\n wget http://download.osgeo.org/gdal/2.2.3/gdal-2.2.3.tar.gz\n tar -zxvf gdal-2.2.3.tar.gz\n cd gdal-2.2.3\n ./configure prefix=/home/postgres/pg12/gdal\n make -j10\n make install\n```\n\n## json-c\n\n```\n wget  https://s3.amazonaws.com/json-c_releases/releases/json-c-0.15.tar.gz\n mkdir build\n cd build\n ../cmake-configure --prefix=/home/postgres/pg12/jsonc\n make -j10\n make install\n```\n\n## protobuf-c\n不是必须, 需要使用ST_AsMVT则需要。\n```\nwget https://github.com/protocolbuffers/protobuf/releases/download/v3.12.4/protobuf-all-3.12.4.tar.gz\ntar -zxvf protobuf-all-3.12.4.tar.gz\ncd protobuf-all-3.12.4\n./configure\nsudo make -j10\nsudo make install\nwget https://github.com/protobuf-c/protobuf-c/archive/v1.3.3.tar.gz\ntar -zxvf v1.3.3.tar.gz\nsudo vim /etc/ld.so.conf\n/usr/local/protobuf-3.11.4/lib\n/usr/local/protobuf-c-1.3.2/lib\nexport LD_LIBRARY_PATH=/usr/local/lib/:$LD_LIBRARY_PATH\ncd protobuf-c-1.3.3\n./configure --prefix=/home/postgres/pg12/protobuf\nmake -j10\nmake install\n```\n\n# 更新动态库\nsudo vim /etc/ld.so.conf 追加以下内容\n\n```\n/home/postgres/pg12/lib/\n/home/postgres/pg12/jsonc/lib/\n/home/postgres/pg12/geos/lib/\n/home/postgres/pg12/proj/lib/\n/home/postgres/pg12/gdal/lib/\n/home/postgres/pg12/protobuf/lib/\n```\n\n# Postgis下载 && 编译 && 安装\n```\n wget [http://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\n tar -zxvf postgis-2.5.4.tar.gz\n cd postgis-2.5.4\n ./configure --with-pgconfig=/home/postgres/pg12/bin/pg_config --with-xml2config=/usr/bin/xml2-config --with-geosconfig=/home/postgres/pg12/geos/bin/geos-config --with-gdalconfig=/home/postgres/pg12/gdal/bin/gdal-config --with-projdir=/home/postgres/pg12/proj  --with-jsondir=/home/postgres/pg12/jsonc --with-protobufdir=/home/postgres/pg12/protobuf --with-gui --with-topology --with-raster\n make -j10 \n make install \n```\n\n# 创建extension\n\n```\npostgres@jintao-ThinkPad-L490:~/download/postgis-2.5.4$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# create extension postgis;\nCREATE EXTENSION\npostgres=# create extension postgis_t;\npostgis_tiger_geocoder  postgis_topology\npostgres=# create extension postgis_tiger_geocoder;\nERROR:  required extension \"fuzzystrmatch\" is not installed\nHINT:  Use CREATE EXTENSION ... CASCADE to install required extensions too.\npostgres=# create extension postgis_tiger_geocoder cascade;\nNOTICE:  installing required extension \"fuzzystrmatch\"\nCREATE EXTENSION\npostgres=# create extension postgis_topology;\npostgis_topology\npostgres=# create extension postgis_topology;\nCREATE EXTENSION\npostgres=# \\dx\n                                            List of installed extensions\n          Name          | Version |   Schema   |                             Description\n------------------------+---------+------------+---------------------------------------------------------------------\n fuzzystrmatch          | 1.1     | public     | determine similarities and distance between strings\n plpgsql                | 1.0     | pg_catalog | PL/pgSQL procedural language\n postgis                | 2.5.4   | public     | PostGIS geometry, geography, and raster spatial types and functions\n postgis_tiger_geocoder | 2.5.4   | tiger      | PostGIS tiger geocoder and reverse geocoder\n postgis_topology       | 2.5.4   | topology   | PostGIS topology spatial types and functions\n(5 rows)\n\npostgres=# select postgis_full_version();\n                                                                                                   postgis_full_version\n\n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n-------\n POSTGIS=\"2.5.4\" [EXTENSION] PGSQL=\"120\" GEOS=\"3.7.2-CAPI-1.11.2 b55d2125\" PROJ=\"Rel. 4.9.2, 08 September 2015\" GDAL=\"GDAL 2.2.3, released 2017/11/20\" LIBXML=\"2.9.10\" LIBJSON=\"0.15\" LIBPROTOBUF=\"1.3.3\" TOPOLOGY\nRASTER\n(1 row)\n\npostgres=#\npostgres=# select st_geographyfromtext('SRID=4326;POINT(121 23)');\n                st_geographyfromtext\n----------------------------------------------------\n 0101000020E61000000000000000405E400000000000003740\n(1 row)\n\npostgres=#\n```\n**Note:**\n最新的CREATE EXTENSION 详见 http://postgis.net/install/\n","source":"_posts/unbutu_PostgreSQL_postgis_install.md","raw":"---\ntitle: PostgreSQL Postgis 源码安装\ndate: 2020-08-11 14:56:15\ntags: \n- postgres\n- postgis\n- pg\n- PostgreSQL\n- postgresql\n- geo\n- gis\ncategories: \n- PostgreSQL\ntop: 15\ndescription: \npassword: \n\n---\n\n为PostgreSQL 12.3 安装Postgis 2.5.4\n\n# postgis 源码下载\n\n巨慢, 耐心等待吧\n```\npostgres@jintao-ThinkPad-L490:~/download$ wget https://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\n--2020-08-11 14:57:46--  https://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\nResolving download.osgeo.org (download.osgeo.org)... 140.211.15.30\nConnecting to download.osgeo.org (download.osgeo.org)|140.211.15.30|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 16041872 (15M) [application/octet-stream]\nSaving to: ‘postgis-2.5.4.tar.gz’\n\npostgis-2.5.4.tar.gz       6%[======>                                                    ]   1016K  5.72KB/s    eta 43m 7s\n```\n[其他版本下载地址](https://git.osgeo.org/gitea/postgis/postgis/branches/)\n<!-- more -->\n\n# 依赖下载 && 编译 && 安装\n\n安装postgis2.5.4需要对应的包及其版本详见[install_requirements](https://postgis.net/docs/manual-2.5/postgis_installation.html#install_requirements)\n\n## zlib1g-dev和libxml2\n```\nsudo apt-get install zlib1g-dev\nsudo apt-get install libxml2-dev\n```\n\n## geos\n\n编译时间很长\n```\n wget http://download.osgeo.org/geos/geos-3.7.2.tar.bz2\n tar -jxvf geos-3.7.2.tar.bz2\n cd geos-3.7.2\n ./configure prefix=/home/postgres/pg12/geos\n make -j10\n make install\n```\n\n## proj\n\n```\n wget  http://download.osgeo.org/proj/proj-4.9.2.tar.gz\n tar -zxvf proj-4.9.2.tar.gz\n cd proj-4.9.2/\n ./configure prefix=/home/postgres/pg12/proj\n make -j10\n make install\n```\n\n## gdal\n\n编译时间很长\n```\n wget http://download.osgeo.org/gdal/2.2.3/gdal-2.2.3.tar.gz\n tar -zxvf gdal-2.2.3.tar.gz\n cd gdal-2.2.3\n ./configure prefix=/home/postgres/pg12/gdal\n make -j10\n make install\n```\n\n## json-c\n\n```\n wget  https://s3.amazonaws.com/json-c_releases/releases/json-c-0.15.tar.gz\n mkdir build\n cd build\n ../cmake-configure --prefix=/home/postgres/pg12/jsonc\n make -j10\n make install\n```\n\n## protobuf-c\n不是必须, 需要使用ST_AsMVT则需要。\n```\nwget https://github.com/protocolbuffers/protobuf/releases/download/v3.12.4/protobuf-all-3.12.4.tar.gz\ntar -zxvf protobuf-all-3.12.4.tar.gz\ncd protobuf-all-3.12.4\n./configure\nsudo make -j10\nsudo make install\nwget https://github.com/protobuf-c/protobuf-c/archive/v1.3.3.tar.gz\ntar -zxvf v1.3.3.tar.gz\nsudo vim /etc/ld.so.conf\n/usr/local/protobuf-3.11.4/lib\n/usr/local/protobuf-c-1.3.2/lib\nexport LD_LIBRARY_PATH=/usr/local/lib/:$LD_LIBRARY_PATH\ncd protobuf-c-1.3.3\n./configure --prefix=/home/postgres/pg12/protobuf\nmake -j10\nmake install\n```\n\n# 更新动态库\nsudo vim /etc/ld.so.conf 追加以下内容\n\n```\n/home/postgres/pg12/lib/\n/home/postgres/pg12/jsonc/lib/\n/home/postgres/pg12/geos/lib/\n/home/postgres/pg12/proj/lib/\n/home/postgres/pg12/gdal/lib/\n/home/postgres/pg12/protobuf/lib/\n```\n\n# Postgis下载 && 编译 && 安装\n```\n wget [http://download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz\n tar -zxvf postgis-2.5.4.tar.gz\n cd postgis-2.5.4\n ./configure --with-pgconfig=/home/postgres/pg12/bin/pg_config --with-xml2config=/usr/bin/xml2-config --with-geosconfig=/home/postgres/pg12/geos/bin/geos-config --with-gdalconfig=/home/postgres/pg12/gdal/bin/gdal-config --with-projdir=/home/postgres/pg12/proj  --with-jsondir=/home/postgres/pg12/jsonc --with-protobufdir=/home/postgres/pg12/protobuf --with-gui --with-topology --with-raster\n make -j10 \n make install \n```\n\n# 创建extension\n\n```\npostgres@jintao-ThinkPad-L490:~/download/postgis-2.5.4$ psql\npsql (12.3)\nType \"help\" for help.\n\npostgres=# create extension postgis;\nCREATE EXTENSION\npostgres=# create extension postgis_t;\npostgis_tiger_geocoder  postgis_topology\npostgres=# create extension postgis_tiger_geocoder;\nERROR:  required extension \"fuzzystrmatch\" is not installed\nHINT:  Use CREATE EXTENSION ... CASCADE to install required extensions too.\npostgres=# create extension postgis_tiger_geocoder cascade;\nNOTICE:  installing required extension \"fuzzystrmatch\"\nCREATE EXTENSION\npostgres=# create extension postgis_topology;\npostgis_topology\npostgres=# create extension postgis_topology;\nCREATE EXTENSION\npostgres=# \\dx\n                                            List of installed extensions\n          Name          | Version |   Schema   |                             Description\n------------------------+---------+------------+---------------------------------------------------------------------\n fuzzystrmatch          | 1.1     | public     | determine similarities and distance between strings\n plpgsql                | 1.0     | pg_catalog | PL/pgSQL procedural language\n postgis                | 2.5.4   | public     | PostGIS geometry, geography, and raster spatial types and functions\n postgis_tiger_geocoder | 2.5.4   | tiger      | PostGIS tiger geocoder and reverse geocoder\n postgis_topology       | 2.5.4   | topology   | PostGIS topology spatial types and functions\n(5 rows)\n\npostgres=# select postgis_full_version();\n                                                                                                   postgis_full_version\n\n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n-------\n POSTGIS=\"2.5.4\" [EXTENSION] PGSQL=\"120\" GEOS=\"3.7.2-CAPI-1.11.2 b55d2125\" PROJ=\"Rel. 4.9.2, 08 September 2015\" GDAL=\"GDAL 2.2.3, released 2017/11/20\" LIBXML=\"2.9.10\" LIBJSON=\"0.15\" LIBPROTOBUF=\"1.3.3\" TOPOLOGY\nRASTER\n(1 row)\n\npostgres=#\npostgres=# select st_geographyfromtext('SRID=4326;POINT(121 23)');\n                st_geographyfromtext\n----------------------------------------------------\n 0101000020E61000000000000000405E400000000000003740\n(1 row)\n\npostgres=#\n```\n**Note:**\n最新的CREATE EXTENSION 详见 http://postgis.net/install/\n","slug":"unbutu_PostgreSQL_postgis_install","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhq0019pieb2mu80zb9","content":"<p>为PostgreSQL 12.3 安装Postgis 2.5.4</p>\n<h1 id=\"postgis-源码下载\"><a href=\"#postgis-源码下载\" class=\"headerlink\" title=\"postgis 源码下载\"></a>postgis 源码下载</h1><p>巨慢, 耐心等待吧<br><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"><span class=\"hljs-symbol\">postgres@</span>jintao-ThinkPad-L490:~/download$ wget https:<span class=\"hljs-comment\">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>-<span class=\"hljs-number\">-2020</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-11</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">46</span>--  https:<span class=\"hljs-comment\">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>Resolving download.osgeo.org (download.osgeo.org)... <span class=\"hljs-number\">140.211</span><span class=\"hljs-number\">.15</span><span class=\"hljs-number\">.30</span><br>Connecting to download.osgeo.org (download.osgeo.org)|<span class=\"hljs-number\">140.211</span><span class=\"hljs-number\">.15</span><span class=\"hljs-number\">.30</span>|:<span class=\"hljs-number\">443.</span>.. connected.<br>HTTP request sent, awaiting response... <span class=\"hljs-number\">200</span> OK<br>Length: <span class=\"hljs-number\">16041872</span> (<span class=\"hljs-number\">15</span>M) [application/octet-stream]<br>Saving to: ‘postgis<span class=\"hljs-number\">-2.5</span><span class=\"hljs-number\">.4</span>.tar.gz’<br><br>postgis<span class=\"hljs-number\">-2.5</span><span class=\"hljs-number\">.4</span>.tar.gz       <span class=\"hljs-number\">6</span>%[======&gt;                                                    ]   <span class=\"hljs-number\">1016</span>K  <span class=\"hljs-number\">5.72</span>KB/s    eta <span class=\"hljs-number\">43</span>m <span class=\"hljs-number\">7</span>s<br></code></pre></td></tr></table></figure><br><a href=\"https://git.osgeo.org/gitea/postgis/postgis/branches/\">其他版本下载地址</a><br><a id=\"more\"></a></p>\n<h1 id=\"依赖下载-amp-amp-编译-amp-amp-安装\"><a href=\"#依赖下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"依赖下载 &amp;&amp; 编译 &amp;&amp; 安装\"></a>依赖下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><p>安装postgis2.5.4需要对应的包及其版本详见<a href=\"https://postgis.net/docs/manual-2.5/postgis_installation.html#install_requirements\">install_requirements</a></p>\n<h2 id=\"zlib1g-dev和libxml2\"><a href=\"#zlib1g-dev和libxml2\" class=\"headerlink\" title=\"zlib1g-dev和libxml2\"></a>zlib1g-dev和libxml2</h2><figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs q\">sudo apt-<span class=\"hljs-built_in\">get</span> install zlib1g-<span class=\"hljs-built_in\">dev</span><br>sudo apt-<span class=\"hljs-built_in\">get</span> install libxml2-<span class=\"hljs-built_in\">dev</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"geos\"><a href=\"#geos\" class=\"headerlink\" title=\"geos\"></a>geos</h2><p>编译时间很长<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/geos/g</span>eos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span>.tar.bz2<br>tar -jxvf geos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span>.tar.bz2<br>cd geos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span><br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/geos<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"proj\"><a href=\"#proj\" class=\"headerlink\" title=\"proj\"></a>proj</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget  http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/proj/</span>proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>.tar.gz<br>tar -zxvf proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>.tar.gz<br>cd proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>/<br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/proj<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>\n<h2 id=\"gdal\"><a href=\"#gdal\" class=\"headerlink\" title=\"gdal\"></a>gdal</h2><p>编译时间很长<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/gdal/</span><span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>/gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>.tar.gz<br>tar -zxvf gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>.tar.gz<br>cd gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span><br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/gdal<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"json-c\"><a href=\"#json-c\" class=\"headerlink\" title=\"json-c\"></a>json-c</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget  https:<span class=\"hljs-regexp\">//</span>s3.amazonaws.com<span class=\"hljs-regexp\">/json-c_releases/</span>releases/json-c-<span class=\"hljs-number\">0.15</span>.tar.gz<br>mkdir build<br>cd build<br>..<span class=\"hljs-regexp\">/cmake-configure --prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/jsonc<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>\n<h2 id=\"protobuf-c\"><a href=\"#protobuf-c\" class=\"headerlink\" title=\"protobuf-c\"></a>protobuf-c</h2><p>不是必须, 需要使用ST_AsMVT则需要。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/protocolbuffers/</span>protobuf<span class=\"hljs-regexp\">/releases/</span>download<span class=\"hljs-regexp\">/v3.12.4/</span>protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>tar -zxvf protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>cd protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span><br>./configure<br>sudo make -j10<br>sudo make install<br>wget https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/protobuf-c/</span>protobuf-c<span class=\"hljs-regexp\">/archive/</span>v1.<span class=\"hljs-number\">3.3</span>.tar.gz<br>tar -zxvf v1.<span class=\"hljs-number\">3.3</span>.tar.gz<br>sudo vim <span class=\"hljs-regexp\">/etc/</span>ld.so.conf<br><span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/protobuf-3.11.4/</span>lib<br><span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/protobuf-c-1.3.2/</span>lib<br>export LD_LIBRARY_PATH=<span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/lib/</span>:<span class=\"hljs-variable\">$LD_LIBRARY_PATH</span><br>cd protobuf-c-<span class=\"hljs-number\">1.3</span>.<span class=\"hljs-number\">3</span><br>.<span class=\"hljs-regexp\">/configure --prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/protobuf<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"更新动态库\"><a href=\"#更新动态库\" class=\"headerlink\" title=\"更新动态库\"></a>更新动态库</h1><p>sudo vim /etc/ld.so.conf 追加以下内容</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>lib/<br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>jsonc<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/g</span>eos<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>proj<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/g</span>dal<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>protobuf<span class=\"hljs-regexp\">/lib/</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"Postgis下载-amp-amp-编译-amp-amp-安装\"><a href=\"#Postgis下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装\"></a>Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget [http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/postgis/</span>source/postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>tar -zxvf postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>cd postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span><br>.<span class=\"hljs-regexp\">/configure --with-pgconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/bin/</span>pg_config --with-xml2config=<span class=\"hljs-regexp\">/usr/</span>bin<span class=\"hljs-regexp\">/xml2-config --with-geosconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/geos/</span>bin<span class=\"hljs-regexp\">/geos-config --with-gdalconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/gdal/</span>bin<span class=\"hljs-regexp\">/gdal-config --with-projdir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/proj  --with-jsondir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/jsonc --with-protobufdir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/protobuf --with-gui --with-topology --with-raster<br>make -j10 <br>make install <br></code></pre></td></tr></table></figure>\n<h1 id=\"创建extension\"><a href=\"#创建extension\" class=\"headerlink\" title=\"创建extension\"></a>创建extension</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@jintao-ThinkPad-L490:~/download/postgis-2.5.4$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis;<br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_t;<br>postgis_tiger_geocoder  postgis_topology<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_tiger_geocoder;<br>ERROR:  required extension <span class=\"hljs-string\">&quot;fuzzystrmatch&quot;</span> is <span class=\"hljs-keyword\">not</span> installed<br>HINT:  Use CREATE EXTENSION <span class=\"hljs-built_in\">..</span>. CASCADE <span class=\"hljs-keyword\">to</span> install required extensions too.<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_tiger_geocoder cascade;<br>NOTICE:  installing required extension <span class=\"hljs-string\">&quot;fuzzystrmatch&quot;</span><br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_topology;<br>postgis_topology<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_topology;<br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# \\dx<br>                                            List of installed extensions<br>          Name          | Version |   Schema   |                             Description<br>------------------------+---------+------------+---------------------------------------------------------------------<br> fuzzystrmatch          | 1.1     | public     | determine similarities <span class=\"hljs-keyword\">and</span> distance between strings<br> plpgsql                | 1.0     | pg_catalog | PL/pgSQL procedural language<br> postgis                | 2.5.4   | public     | PostGIS geometry, geography, <span class=\"hljs-keyword\">and</span> raster spatial types <span class=\"hljs-keyword\">and</span> functions<br> postgis_tiger_geocoder | 2.5.4   | tiger      | PostGIS tiger geocoder <span class=\"hljs-keyword\">and</span> reverse geocoder<br> postgis_topology       | 2.5.4   | topology   | PostGIS topology spatial types <span class=\"hljs-keyword\">and</span> functions<br>(5 rows)<br><br><span class=\"hljs-attribute\">postgres</span>=# select postgis_full_version();<br>                                                                                                   postgis_full_version<br><br>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>-------<br> <span class=\"hljs-attribute\">POSTGIS</span>=<span class=\"hljs-string\">&quot;2.5.4&quot;</span> [EXTENSION] <span class=\"hljs-attribute\">PGSQL</span>=<span class=\"hljs-string\">&quot;120&quot;</span> <span class=\"hljs-attribute\">GEOS</span>=<span class=\"hljs-string\">&quot;3.7.2-CAPI-1.11.2 b55d2125&quot;</span> <span class=\"hljs-attribute\">PROJ</span>=<span class=\"hljs-string\">&quot;Rel. 4.9.2, 08 September 2015&quot;</span> <span class=\"hljs-attribute\">GDAL</span>=<span class=\"hljs-string\">&quot;GDAL 2.2.3, released 2017/11/20&quot;</span> <span class=\"hljs-attribute\">LIBXML</span>=<span class=\"hljs-string\">&quot;2.9.10&quot;</span> <span class=\"hljs-attribute\">LIBJSON</span>=<span class=\"hljs-string\">&quot;0.15&quot;</span> <span class=\"hljs-attribute\">LIBPROTOBUF</span>=<span class=\"hljs-string\">&quot;1.3.3&quot;</span> TOPOLOGY<br>RASTER<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=#<br><span class=\"hljs-attribute\">postgres</span>=# select st_geographyfromtext(<span class=\"hljs-string\">&#x27;SRID=4326;POINT(121 23)&#x27;</span>);<br>                st_geographyfromtext<br>----------------------------------------------------<br> 0101000020E61000000000000000405E400000000000003740<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<p><strong>Note:</strong><br>最新的CREATE EXTENSION 详见 <a href=\"http://postgis.net/install/\">http://postgis.net/install/</a></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>为PostgreSQL 12.3 安装Postgis 2.5.4</p>\n<h1 id=\"postgis-源码下载\"><a href=\"#postgis-源码下载\" class=\"headerlink\" title=\"postgis 源码下载\"></a>postgis 源码下载</h1><p>巨慢, 耐心等待吧<br><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"><span class=\"hljs-symbol\">postgres@</span>jintao-ThinkPad-L490:~/download$ wget https:<span class=\"hljs-comment\">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>-<span class=\"hljs-number\">-2020</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-11</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">46</span>--  https:<span class=\"hljs-comment\">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>Resolving download.osgeo.org (download.osgeo.org)... <span class=\"hljs-number\">140.211</span><span class=\"hljs-number\">.15</span><span class=\"hljs-number\">.30</span><br>Connecting to download.osgeo.org (download.osgeo.org)|<span class=\"hljs-number\">140.211</span><span class=\"hljs-number\">.15</span><span class=\"hljs-number\">.30</span>|:<span class=\"hljs-number\">443.</span>.. connected.<br>HTTP request sent, awaiting response... <span class=\"hljs-number\">200</span> OK<br>Length: <span class=\"hljs-number\">16041872</span> (<span class=\"hljs-number\">15</span>M) [application/octet-stream]<br>Saving to: ‘postgis<span class=\"hljs-number\">-2.5</span><span class=\"hljs-number\">.4</span>.tar.gz’<br><br>postgis<span class=\"hljs-number\">-2.5</span><span class=\"hljs-number\">.4</span>.tar.gz       <span class=\"hljs-number\">6</span>%[======&gt;                                                    ]   <span class=\"hljs-number\">1016</span>K  <span class=\"hljs-number\">5.72</span>KB/s    eta <span class=\"hljs-number\">43</span>m <span class=\"hljs-number\">7</span>s<br></code></pre></td></tr></table></figure><br><a href=\"https://git.osgeo.org/gitea/postgis/postgis/branches/\">其他版本下载地址</a><br>","more":"</p>\n<h1 id=\"依赖下载-amp-amp-编译-amp-amp-安装\"><a href=\"#依赖下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"依赖下载 &amp;&amp; 编译 &amp;&amp; 安装\"></a>依赖下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><p>安装postgis2.5.4需要对应的包及其版本详见<a href=\"https://postgis.net/docs/manual-2.5/postgis_installation.html#install_requirements\">install_requirements</a></p>\n<h2 id=\"zlib1g-dev和libxml2\"><a href=\"#zlib1g-dev和libxml2\" class=\"headerlink\" title=\"zlib1g-dev和libxml2\"></a>zlib1g-dev和libxml2</h2><figure class=\"highlight q\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs q\">sudo apt-<span class=\"hljs-built_in\">get</span> install zlib1g-<span class=\"hljs-built_in\">dev</span><br>sudo apt-<span class=\"hljs-built_in\">get</span> install libxml2-<span class=\"hljs-built_in\">dev</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"geos\"><a href=\"#geos\" class=\"headerlink\" title=\"geos\"></a>geos</h2><p>编译时间很长<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/geos/g</span>eos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span>.tar.bz2<br>tar -jxvf geos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span>.tar.bz2<br>cd geos-<span class=\"hljs-number\">3.7</span>.<span class=\"hljs-number\">2</span><br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/geos<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"proj\"><a href=\"#proj\" class=\"headerlink\" title=\"proj\"></a>proj</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget  http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/proj/</span>proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>.tar.gz<br>tar -zxvf proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>.tar.gz<br>cd proj-<span class=\"hljs-number\">4.9</span>.<span class=\"hljs-number\">2</span>/<br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/proj<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>\n<h2 id=\"gdal\"><a href=\"#gdal\" class=\"headerlink\" title=\"gdal\"></a>gdal</h2><p>编译时间很长<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/gdal/</span><span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>/gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>.tar.gz<br>tar -zxvf gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span>.tar.gz<br>cd gdal-<span class=\"hljs-number\">2.2</span>.<span class=\"hljs-number\">3</span><br>.<span class=\"hljs-regexp\">/configure prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/gdal<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"json-c\"><a href=\"#json-c\" class=\"headerlink\" title=\"json-c\"></a>json-c</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget  https:<span class=\"hljs-regexp\">//</span>s3.amazonaws.com<span class=\"hljs-regexp\">/json-c_releases/</span>releases/json-c-<span class=\"hljs-number\">0.15</span>.tar.gz<br>mkdir build<br>cd build<br>..<span class=\"hljs-regexp\">/cmake-configure --prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/jsonc<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>\n<h2 id=\"protobuf-c\"><a href=\"#protobuf-c\" class=\"headerlink\" title=\"protobuf-c\"></a>protobuf-c</h2><p>不是必须, 需要使用ST_AsMVT则需要。<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/protocolbuffers/</span>protobuf<span class=\"hljs-regexp\">/releases/</span>download<span class=\"hljs-regexp\">/v3.12.4/</span>protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>tar -zxvf protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>cd protobuf-all-<span class=\"hljs-number\">3.12</span>.<span class=\"hljs-number\">4</span><br>./configure<br>sudo make -j10<br>sudo make install<br>wget https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/protobuf-c/</span>protobuf-c<span class=\"hljs-regexp\">/archive/</span>v1.<span class=\"hljs-number\">3.3</span>.tar.gz<br>tar -zxvf v1.<span class=\"hljs-number\">3.3</span>.tar.gz<br>sudo vim <span class=\"hljs-regexp\">/etc/</span>ld.so.conf<br><span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/protobuf-3.11.4/</span>lib<br><span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/protobuf-c-1.3.2/</span>lib<br>export LD_LIBRARY_PATH=<span class=\"hljs-regexp\">/usr/</span>local<span class=\"hljs-regexp\">/lib/</span>:<span class=\"hljs-variable\">$LD_LIBRARY_PATH</span><br>cd protobuf-c-<span class=\"hljs-number\">1.3</span>.<span class=\"hljs-number\">3</span><br>.<span class=\"hljs-regexp\">/configure --prefix=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/protobuf<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>\n<h1 id=\"更新动态库\"><a href=\"#更新动态库\" class=\"headerlink\" title=\"更新动态库\"></a>更新动态库</h1><p>sudo vim /etc/ld.so.conf 追加以下内容</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>lib/<br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>jsonc<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/g</span>eos<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>proj<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/g</span>dal<span class=\"hljs-regexp\">/lib/</span><br><span class=\"hljs-regexp\">/home/</span>postgres<span class=\"hljs-regexp\">/pg12/</span>protobuf<span class=\"hljs-regexp\">/lib/</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"Postgis下载-amp-amp-编译-amp-amp-安装\"><a href=\"#Postgis下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装\"></a>Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">wget [http:<span class=\"hljs-regexp\">//</span>download.osgeo.org<span class=\"hljs-regexp\">/postgis/</span>source/postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>tar -zxvf postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span>.tar.gz<br>cd postgis-<span class=\"hljs-number\">2.5</span>.<span class=\"hljs-number\">4</span><br>.<span class=\"hljs-regexp\">/configure --with-pgconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/bin/</span>pg_config --with-xml2config=<span class=\"hljs-regexp\">/usr/</span>bin<span class=\"hljs-regexp\">/xml2-config --with-geosconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/geos/</span>bin<span class=\"hljs-regexp\">/geos-config --with-gdalconfig=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/gdal/</span>bin<span class=\"hljs-regexp\">/gdal-config --with-projdir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/proj  --with-jsondir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12<span class=\"hljs-regexp\">/jsonc --with-protobufdir=/</span>home<span class=\"hljs-regexp\">/postgres/</span>pg12/protobuf --with-gui --with-topology --with-raster<br>make -j10 <br>make install <br></code></pre></td></tr></table></figure>\n<h1 id=\"创建extension\"><a href=\"#创建extension\" class=\"headerlink\" title=\"创建extension\"></a>创建extension</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">postgres@jintao-ThinkPad-L490:~/download/postgis-2.5.4$ psql<br>psql (12.3)<br>Type <span class=\"hljs-string\">&quot;help&quot;</span> <span class=\"hljs-keyword\">for</span> help.<br><br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis;<br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_t;<br>postgis_tiger_geocoder  postgis_topology<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_tiger_geocoder;<br>ERROR:  required extension <span class=\"hljs-string\">&quot;fuzzystrmatch&quot;</span> is <span class=\"hljs-keyword\">not</span> installed<br>HINT:  Use CREATE EXTENSION <span class=\"hljs-built_in\">..</span>. CASCADE <span class=\"hljs-keyword\">to</span> install required extensions too.<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_tiger_geocoder cascade;<br>NOTICE:  installing required extension <span class=\"hljs-string\">&quot;fuzzystrmatch&quot;</span><br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_topology;<br>postgis_topology<br><span class=\"hljs-attribute\">postgres</span>=# create extension postgis_topology;<br>CREATE EXTENSION<br><span class=\"hljs-attribute\">postgres</span>=# \\dx<br>                                            List of installed extensions<br>          Name          | Version |   Schema   |                             Description<br>------------------------+---------+------------+---------------------------------------------------------------------<br> fuzzystrmatch          | 1.1     | public     | determine similarities <span class=\"hljs-keyword\">and</span> distance between strings<br> plpgsql                | 1.0     | pg_catalog | PL/pgSQL procedural language<br> postgis                | 2.5.4   | public     | PostGIS geometry, geography, <span class=\"hljs-keyword\">and</span> raster spatial types <span class=\"hljs-keyword\">and</span> functions<br> postgis_tiger_geocoder | 2.5.4   | tiger      | PostGIS tiger geocoder <span class=\"hljs-keyword\">and</span> reverse geocoder<br> postgis_topology       | 2.5.4   | topology   | PostGIS topology spatial types <span class=\"hljs-keyword\">and</span> functions<br>(5 rows)<br><br><span class=\"hljs-attribute\">postgres</span>=# select postgis_full_version();<br>                                                                                                   postgis_full_version<br><br>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>-------<br> <span class=\"hljs-attribute\">POSTGIS</span>=<span class=\"hljs-string\">&quot;2.5.4&quot;</span> [EXTENSION] <span class=\"hljs-attribute\">PGSQL</span>=<span class=\"hljs-string\">&quot;120&quot;</span> <span class=\"hljs-attribute\">GEOS</span>=<span class=\"hljs-string\">&quot;3.7.2-CAPI-1.11.2 b55d2125&quot;</span> <span class=\"hljs-attribute\">PROJ</span>=<span class=\"hljs-string\">&quot;Rel. 4.9.2, 08 September 2015&quot;</span> <span class=\"hljs-attribute\">GDAL</span>=<span class=\"hljs-string\">&quot;GDAL 2.2.3, released 2017/11/20&quot;</span> <span class=\"hljs-attribute\">LIBXML</span>=<span class=\"hljs-string\">&quot;2.9.10&quot;</span> <span class=\"hljs-attribute\">LIBJSON</span>=<span class=\"hljs-string\">&quot;0.15&quot;</span> <span class=\"hljs-attribute\">LIBPROTOBUF</span>=<span class=\"hljs-string\">&quot;1.3.3&quot;</span> TOPOLOGY<br>RASTER<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=#<br><span class=\"hljs-attribute\">postgres</span>=# select st_geographyfromtext(<span class=\"hljs-string\">&#x27;SRID=4326;POINT(121 23)&#x27;</span>);<br>                st_geographyfromtext<br>----------------------------------------------------<br> 0101000020E61000000000000000405E400000000000003740<br>(1 row)<br><br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<p><strong>Note:</strong><br>最新的CREATE EXTENSION 详见 <a href=\"http://postgis.net/install/\">http://postgis.net/install/</a></p>"},{"title":"利用Github分支备份Hexo博客源文件","date":"2020-08-04T16:00:00.000Z","top":10,"password":null,"_content":"\n# 场景\nHexo 部署博客很方便，我的这个博客也是用 Hexo 部署在 GitHub Pages 上的，有得人可能在多台电脑上写博客，这个时候需要把博客\n的源文件备份在一个地方，这样只需把博客源文件复制下来就可以在另一个地方写博客并部署到 GitHub Pages上了.\n\n本篇介绍的就是利用博客的 repo 分支（ master 分支的必须用来存放你博客网站文件）托管 Hexo 源文件和配置达到备份的目的，\n下面开始正题.\n\n<!-- more -->\n\n# 把博客目录的源文件push到repo分支上\ncd 进入博客目录，Git 初始化：\n```\ngit init\n```\n\n完成之后，添加修改的文件，Hexo 就自带了 .gitignore 文件需要忽略的文件 都已经默认配置好了，add 全部文件：\n\n```\ngit add .\n```\n然后commit\n```\ngit commit -m \"commit first time\"\n```\n\n提交成功之后，接下来就是 push 到github了，需要先把这 Hexo 源文件映射到远程 repo 上：\n```\ngit remote add origin https://github.com/your-name/your-name.github.io.git\n```\n\n接下来就是把Hexo源文件 push 上去，但是关键的地方到了，master上是 Hexo 生成博客网页的代码，而我们 Hexo 源文件是要 push 到一个分支上面的，所以接下来先要在 repo 上新建一个分支\n新建一个叫做hexo分支：\n```\ngit branch hexo\n```\n\n查看本地分支，并且切换到 hexo 分支\n```\ngit branch\ngit checkout hexo\n```\n\n再把刚才添加的 Hexo 源文件代码 push 到hexo这个分支\n```\ngit push -u origin hexo\n```\n\n然后就可以在 repo 上看到分支里面已经有博客的源文件了\n\n\n# 日常更新博客源文件\n\n以后你本地的博客源文件的修改就可以直接用 git 命令 push 到 repo 的 hexo 分支上了:\n```\ngit add .  //添加修改内容到本地仓储\ngit commit -m 'modify blog'  //提交修改内容到本地仓库\ngit push --set-upstream origin hexo //配置push，以方便后期直接git push推送\ngit push  //将本地分支和分支下的内容推送到远程\n\n```\n\n注意：执行 git push --set-upstream origin hexo 命令之后，以后修改博客源文件代码之后，直接使用 git push 不用再指定分支，就可以把代码 push 到 hexo 分支上了\n\n# 更换地点使用 repo 分支上的博客源文件\n\n换一台电脑，配置好 Hexo 的环境，配置 Git SSH key，把博客源文件代码克隆下来:\n```\ngit clone xxxxxxxxx.xx (你的 github page 的 repo 地址)\n```\n\n博客源文件下载下来之后，默认的分支是 master，需要切换到 hexo 分支\n```\ngit checkout hexo\n```\n\n然后cd到博客目录依次执行以下命令：\n```\nnpm install hexo\nnpm install\nnpm install hexo-deployer-git --save\n```\n\n接下来就可以开始愉快的写博客了，写完之后记得把源文件代码 push 到 Github 上，然后用 Hexo 部署到自己博客上面\n\n","source":"_posts/利用Github分支备份Hexo博客源文件.md","raw":"---\ntitle: 利用Github分支备份Hexo博客源文件  \ndate: 2020-08-05\ntags: [ hexo, github ]\ncategories: hexo\ntop: 10\npassword: \n\n---\n\n# 场景\nHexo 部署博客很方便，我的这个博客也是用 Hexo 部署在 GitHub Pages 上的，有得人可能在多台电脑上写博客，这个时候需要把博客\n的源文件备份在一个地方，这样只需把博客源文件复制下来就可以在另一个地方写博客并部署到 GitHub Pages上了.\n\n本篇介绍的就是利用博客的 repo 分支（ master 分支的必须用来存放你博客网站文件）托管 Hexo 源文件和配置达到备份的目的，\n下面开始正题.\n\n<!-- more -->\n\n# 把博客目录的源文件push到repo分支上\ncd 进入博客目录，Git 初始化：\n```\ngit init\n```\n\n完成之后，添加修改的文件，Hexo 就自带了 .gitignore 文件需要忽略的文件 都已经默认配置好了，add 全部文件：\n\n```\ngit add .\n```\n然后commit\n```\ngit commit -m \"commit first time\"\n```\n\n提交成功之后，接下来就是 push 到github了，需要先把这 Hexo 源文件映射到远程 repo 上：\n```\ngit remote add origin https://github.com/your-name/your-name.github.io.git\n```\n\n接下来就是把Hexo源文件 push 上去，但是关键的地方到了，master上是 Hexo 生成博客网页的代码，而我们 Hexo 源文件是要 push 到一个分支上面的，所以接下来先要在 repo 上新建一个分支\n新建一个叫做hexo分支：\n```\ngit branch hexo\n```\n\n查看本地分支，并且切换到 hexo 分支\n```\ngit branch\ngit checkout hexo\n```\n\n再把刚才添加的 Hexo 源文件代码 push 到hexo这个分支\n```\ngit push -u origin hexo\n```\n\n然后就可以在 repo 上看到分支里面已经有博客的源文件了\n\n\n# 日常更新博客源文件\n\n以后你本地的博客源文件的修改就可以直接用 git 命令 push 到 repo 的 hexo 分支上了:\n```\ngit add .  //添加修改内容到本地仓储\ngit commit -m 'modify blog'  //提交修改内容到本地仓库\ngit push --set-upstream origin hexo //配置push，以方便后期直接git push推送\ngit push  //将本地分支和分支下的内容推送到远程\n\n```\n\n注意：执行 git push --set-upstream origin hexo 命令之后，以后修改博客源文件代码之后，直接使用 git push 不用再指定分支，就可以把代码 push 到 hexo 分支上了\n\n# 更换地点使用 repo 分支上的博客源文件\n\n换一台电脑，配置好 Hexo 的环境，配置 Git SSH key，把博客源文件代码克隆下来:\n```\ngit clone xxxxxxxxx.xx (你的 github page 的 repo 地址)\n```\n\n博客源文件下载下来之后，默认的分支是 master，需要切换到 hexo 分支\n```\ngit checkout hexo\n```\n\n然后cd到博客目录依次执行以下命令：\n```\nnpm install hexo\nnpm install\nnpm install hexo-deployer-git --save\n```\n\n接下来就可以开始愉快的写博客了，写完之后记得把源文件代码 push 到 Github 上，然后用 Hexo 部署到自己博客上面\n\n","slug":"利用Github分支备份Hexo博客源文件","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhr001cpieba93y5tzv","content":"<h1 id=\"场景\"><a href=\"#场景\" class=\"headerlink\" title=\"场景\"></a>场景</h1><p>Hexo 部署博客很方便，我的这个博客也是用 Hexo 部署在 GitHub Pages 上的，有得人可能在多台电脑上写博客，这个时候需要把博客<br>的源文件备份在一个地方，这样只需把博客源文件复制下来就可以在另一个地方写博客并部署到 GitHub Pages上了.</p>\n<p>本篇介绍的就是利用博客的 repo 分支（ master 分支的必须用来存放你博客网站文件）托管 Hexo 源文件和配置达到备份的目的，<br>下面开始正题.</p>\n<a id=\"more\"></a>\n<h1 id=\"把博客目录的源文件push到repo分支上\"><a href=\"#把博客目录的源文件push到repo分支上\" class=\"headerlink\" title=\"把博客目录的源文件push到repo分支上\"></a>把博客目录的源文件push到repo分支上</h1><p>cd 进入博客目录，Git 初始化：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git init</span><br></code></pre></td></tr></table></figure></p>\n<p>完成之后，添加修改的文件，Hexo 就自带了 .gitignore 文件需要忽略的文件 都已经默认配置好了，add 全部文件：</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\">git <span class=\"hljs-keyword\">add</span><span class=\"bash\"> .</span><br></code></pre></td></tr></table></figure>\n<p>然后commit<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">git</span> commit -m <span class=\"hljs-string\">&quot;commit first time&quot;</span><br></code></pre></td></tr></table></figure></p>\n<p>提交成功之后，接下来就是 push 到github了，需要先把这 Hexo 源文件映射到远程 repo 上：<br><figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs armasm\"><span class=\"hljs-symbol\">git</span> remote <span class=\"hljs-keyword\">add</span> origin https:<span class=\"hljs-comment\">//github.com/your-name/your-name.github.io.git</span><br></code></pre></td></tr></table></figure></p>\n<p>接下来就是把Hexo源文件 push 上去，但是关键的地方到了，master上是 Hexo 生成博客网页的代码，而我们 Hexo 源文件是要 push 到一个分支上面的，所以接下来先要在 repo 上新建一个分支<br>新建一个叫做hexo分支：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git branch hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>查看本地分支，并且切换到 hexo 分支<br><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs properties\"><span class=\"hljs-attr\">git</span> <span class=\"hljs-string\">branch</span><br><span class=\"hljs-attr\">git</span> <span class=\"hljs-string\">checkout hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>再把刚才添加的 Hexo 源文件代码 push 到hexo这个分支<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs maxima\">git <span class=\"hljs-built_in\">push</span> -u <span class=\"hljs-built_in\">origin</span> hexo<br></code></pre></td></tr></table></figure></p>\n<p>然后就可以在 repo 上看到分支里面已经有博客的源文件了</p>\n<h1 id=\"日常更新博客源文件\"><a href=\"#日常更新博客源文件\" class=\"headerlink\" title=\"日常更新博客源文件\"></a>日常更新博客源文件</h1><p>以后你本地的博客源文件的修改就可以直接用 git 命令 push 到 repo 的 hexo 分支上了:<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">git add .  <span class=\"hljs-regexp\">//</span>添加修改内容到本地仓储<br>git commit -m <span class=\"hljs-string\">&#x27;modify blog&#x27;</span>  <span class=\"hljs-regexp\">//</span>提交修改内容到本地仓库<br>git push --set-upstream origin hexo <span class=\"hljs-regexp\">//</span>配置push，以方便后期直接git push推送<br>git push  <span class=\"hljs-regexp\">//</span>将本地分支和分支下的内容推送到远程<br><br></code></pre></td></tr></table></figure></p>\n<p>注意：执行 git push —set-upstream origin hexo 命令之后，以后修改博客源文件代码之后，直接使用 git push 不用再指定分支，就可以把代码 push 到 hexo 分支上了</p>\n<h1 id=\"更换地点使用-repo-分支上的博客源文件\"><a href=\"#更换地点使用-repo-分支上的博客源文件\" class=\"headerlink\" title=\"更换地点使用 repo 分支上的博客源文件\"></a>更换地点使用 repo 分支上的博客源文件</h1><p>换一台电脑，配置好 Hexo 的环境，配置 Git SSH key，把博客源文件代码克隆下来:<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">git clone xxxxxxxxx.xx (你的 github<span class=\"hljs-built_in\"> page </span>的 repo 地址)<br></code></pre></td></tr></table></figure></p>\n<p>博客源文件下载下来之后，默认的分支是 master，需要切换到 hexo 分支<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git checkout hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>然后cd到博客目录依次执行以下命令：<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">npm <span class=\"hljs-keyword\">install</span> hexo<br>npm <span class=\"hljs-keyword\">install</span><br>npm <span class=\"hljs-keyword\">install</span> hexo-deployer-git <span class=\"hljs-comment\">--save</span><br></code></pre></td></tr></table></figure></p>\n<p>接下来就可以开始愉快的写博客了，写完之后记得把源文件代码 push 到 Github 上，然后用 Hexo 部署到自己博客上面</p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"场景\"><a href=\"#场景\" class=\"headerlink\" title=\"场景\"></a>场景</h1><p>Hexo 部署博客很方便，我的这个博客也是用 Hexo 部署在 GitHub Pages 上的，有得人可能在多台电脑上写博客，这个时候需要把博客<br>的源文件备份在一个地方，这样只需把博客源文件复制下来就可以在另一个地方写博客并部署到 GitHub Pages上了.</p>\n<p>本篇介绍的就是利用博客的 repo 分支（ master 分支的必须用来存放你博客网站文件）托管 Hexo 源文件和配置达到备份的目的，<br>下面开始正题.</p>","more":"<h1 id=\"把博客目录的源文件push到repo分支上\"><a href=\"#把博客目录的源文件push到repo分支上\" class=\"headerlink\" title=\"把博客目录的源文件push到repo分支上\"></a>把博客目录的源文件push到repo分支上</h1><p>cd 进入博客目录，Git 初始化：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git init</span><br></code></pre></td></tr></table></figure></p>\n<p>完成之后，添加修改的文件，Hexo 就自带了 .gitignore 文件需要忽略的文件 都已经默认配置好了，add 全部文件：</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\">git <span class=\"hljs-keyword\">add</span><span class=\"bash\"> .</span><br></code></pre></td></tr></table></figure>\n<p>然后commit<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">git</span> commit -m <span class=\"hljs-string\">&quot;commit first time&quot;</span><br></code></pre></td></tr></table></figure></p>\n<p>提交成功之后，接下来就是 push 到github了，需要先把这 Hexo 源文件映射到远程 repo 上：<br><figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs armasm\"><span class=\"hljs-symbol\">git</span> remote <span class=\"hljs-keyword\">add</span> origin https:<span class=\"hljs-comment\">//github.com/your-name/your-name.github.io.git</span><br></code></pre></td></tr></table></figure></p>\n<p>接下来就是把Hexo源文件 push 上去，但是关键的地方到了，master上是 Hexo 生成博客网页的代码，而我们 Hexo 源文件是要 push 到一个分支上面的，所以接下来先要在 repo 上新建一个分支<br>新建一个叫做hexo分支：<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git branch hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>查看本地分支，并且切换到 hexo 分支<br><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs properties\"><span class=\"hljs-attr\">git</span> <span class=\"hljs-string\">branch</span><br><span class=\"hljs-attr\">git</span> <span class=\"hljs-string\">checkout hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>再把刚才添加的 Hexo 源文件代码 push 到hexo这个分支<br><figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs maxima\">git <span class=\"hljs-built_in\">push</span> -u <span class=\"hljs-built_in\">origin</span> hexo<br></code></pre></td></tr></table></figure></p>\n<p>然后就可以在 repo 上看到分支里面已经有博客的源文件了</p>\n<h1 id=\"日常更新博客源文件\"><a href=\"#日常更新博客源文件\" class=\"headerlink\" title=\"日常更新博客源文件\"></a>日常更新博客源文件</h1><p>以后你本地的博客源文件的修改就可以直接用 git 命令 push 到 repo 的 hexo 分支上了:<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">git add .  <span class=\"hljs-regexp\">//</span>添加修改内容到本地仓储<br>git commit -m <span class=\"hljs-string\">&#x27;modify blog&#x27;</span>  <span class=\"hljs-regexp\">//</span>提交修改内容到本地仓库<br>git push --set-upstream origin hexo <span class=\"hljs-regexp\">//</span>配置push，以方便后期直接git push推送<br>git push  <span class=\"hljs-regexp\">//</span>将本地分支和分支下的内容推送到远程<br><br></code></pre></td></tr></table></figure></p>\n<p>注意：执行 git push —set-upstream origin hexo 命令之后，以后修改博客源文件代码之后，直接使用 git push 不用再指定分支，就可以把代码 push 到 hexo 分支上了</p>\n<h1 id=\"更换地点使用-repo-分支上的博客源文件\"><a href=\"#更换地点使用-repo-分支上的博客源文件\" class=\"headerlink\" title=\"更换地点使用 repo 分支上的博客源文件\"></a>更换地点使用 repo 分支上的博客源文件</h1><p>换一台电脑，配置好 Hexo 的环境，配置 Git SSH key，把博客源文件代码克隆下来:<br><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">git clone xxxxxxxxx.xx (你的 github<span class=\"hljs-built_in\"> page </span>的 repo 地址)<br></code></pre></td></tr></table></figure></p>\n<p>博客源文件下载下来之后，默认的分支是 master，需要切换到 hexo 分支<br><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ebnf\"><span class=\"hljs-attribute\">git checkout hexo</span><br></code></pre></td></tr></table></figure></p>\n<p>然后cd到博客目录依次执行以下命令：<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\">npm <span class=\"hljs-keyword\">install</span> hexo<br>npm <span class=\"hljs-keyword\">install</span><br>npm <span class=\"hljs-keyword\">install</span> hexo-deployer-git <span class=\"hljs-comment\">--save</span><br></code></pre></td></tr></table></figure></p>\n<p>接下来就可以开始愉快的写博客了，写完之后记得把源文件代码 push 到 Github 上，然后用 Hexo 部署到自己博客上面</p>"},{"title":"Zabbix编译安装","date":"2020-08-11T03:16:08.000Z","top":1,"description":null,"password":null,"_content":"# 新建帐号\n\n```\ngroupadd zabbix\nuseradd -g zabbix zabbix\n```\n\n<!-- more -->\n\n# 安装依赖\n\n```\nsudo apt install libsnmp-dev\nsudo apt install libssh2-1*\nsudo apt install libopenipmi-dev\nsudo apt install libldap2-dev\nsudo apt install libevent-dev\nsudo apt install curl\nsudo apt install php-pgsql\nsudo apt install php7.2-xml\nsudo apt install apache2\nsudo apt install php7.2-bcmath\nsudo apt install php7.2-mbstring\nsudo apt install php7.2-ldap\nsudo apt install php7.0-snmp\n```\n\n# 下载  && 编译 && 安装\n\n```\nuseradd -m zabbix -d /home/zabbix\nsu - zabbix\nwget https://cdn.zabbix.com/zabbix/sources/stable/4.0/zabbix-4.0.2.tar.gz\ntar -zxvf zabbix-4.0.2.tar.gz\ncd zabbix-4.0.2/\n./configure --prefix=/home/zabbix/release --enable-server --enable-proxy --enable-agent --enable-ipv6 --with-postgresql=/opt/pg11/bin/pg_config --with-net-snmp --with-ssh2 --with-openipmi --with-ldap --with-libcurl --with-iconv --enable-bcmath --enable-mbstring  --with-gd  --with-png-dir --with-jpeg-dir --with-freetype-dir\nmake && make install\n```\n\n# 配置zabbix\n\ncd /home/zabbix/release/sbin\nvim ../etc/zabbix_server.conf 填写正确DB内容\n```\nDBHost=DBHost\nDBName=DBName\nDBUser=DBUser\nDBPassword='DBPassword'\n```\n\n\n# 启动服务\n\n```\n./zabbix_server\n/etc/init.d/apache2 start\nsudo mkdir /var/www/html/zabbix\nsudo chown -R zabbix:zabbix\ncp -fr /home/zabbix/zabbix-4.0.2/frontends/php/* /var/www/html/zabbix\n\n```\n页面就可以登陆了。\n\n# 配置zabbix\n\n```\nhttp://hostname/zabbix/setup.php\n```\n![zabbix01](/images/zabbix01.png)\n\n\n下一步，修改php配置保证所有状态直到OK\n\n![zabbix02](/images/zabbix02.png)\n\n\n# FAQ\n\nPHP databases support off Fail\n```\nextension=/opt/remi/php72/root/usr/lib64/php/modules/pgsql.so\n```\n","source":"_posts/zabbix编译安装.md","raw":"---\ntitle: Zabbix编译安装 \ndate: 2020-08-11 11:16:08\ntags: \n- zabbix\ncategories: \n- zabbix\ntop: 1\ndescription: \npassword: \n\n---\n# 新建帐号\n\n```\ngroupadd zabbix\nuseradd -g zabbix zabbix\n```\n\n<!-- more -->\n\n# 安装依赖\n\n```\nsudo apt install libsnmp-dev\nsudo apt install libssh2-1*\nsudo apt install libopenipmi-dev\nsudo apt install libldap2-dev\nsudo apt install libevent-dev\nsudo apt install curl\nsudo apt install php-pgsql\nsudo apt install php7.2-xml\nsudo apt install apache2\nsudo apt install php7.2-bcmath\nsudo apt install php7.2-mbstring\nsudo apt install php7.2-ldap\nsudo apt install php7.0-snmp\n```\n\n# 下载  && 编译 && 安装\n\n```\nuseradd -m zabbix -d /home/zabbix\nsu - zabbix\nwget https://cdn.zabbix.com/zabbix/sources/stable/4.0/zabbix-4.0.2.tar.gz\ntar -zxvf zabbix-4.0.2.tar.gz\ncd zabbix-4.0.2/\n./configure --prefix=/home/zabbix/release --enable-server --enable-proxy --enable-agent --enable-ipv6 --with-postgresql=/opt/pg11/bin/pg_config --with-net-snmp --with-ssh2 --with-openipmi --with-ldap --with-libcurl --with-iconv --enable-bcmath --enable-mbstring  --with-gd  --with-png-dir --with-jpeg-dir --with-freetype-dir\nmake && make install\n```\n\n# 配置zabbix\n\ncd /home/zabbix/release/sbin\nvim ../etc/zabbix_server.conf 填写正确DB内容\n```\nDBHost=DBHost\nDBName=DBName\nDBUser=DBUser\nDBPassword='DBPassword'\n```\n\n\n# 启动服务\n\n```\n./zabbix_server\n/etc/init.d/apache2 start\nsudo mkdir /var/www/html/zabbix\nsudo chown -R zabbix:zabbix\ncp -fr /home/zabbix/zabbix-4.0.2/frontends/php/* /var/www/html/zabbix\n\n```\n页面就可以登陆了。\n\n# 配置zabbix\n\n```\nhttp://hostname/zabbix/setup.php\n```\n![zabbix01](/images/zabbix01.png)\n\n\n下一步，修改php配置保证所有状态直到OK\n\n![zabbix02](/images/zabbix02.png)\n\n\n# FAQ\n\nPHP databases support off Fail\n```\nextension=/opt/remi/php72/root/usr/lib64/php/modules/pgsql.so\n```\n","slug":"zabbix编译安装","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzht001fpieb1lrk5qtf","content":"<h1 id=\"新建帐号\"><a href=\"#新建帐号\" class=\"headerlink\" title=\"新建帐号\"></a>新建帐号</h1><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs properties\"><span class=\"hljs-attr\">groupadd</span> <span class=\"hljs-string\">zabbix</span><br><span class=\"hljs-attr\">useradd</span> <span class=\"hljs-string\">-g zabbix zabbix</span><br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h1 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sudo</span> apt install libsnmp-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libssh<span class=\"hljs-number\">2</span>-<span class=\"hljs-number\">1</span>*<br><span class=\"hljs-attribute\">sudo</span> apt install libopenipmi-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libldap<span class=\"hljs-number\">2</span>-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libevent-dev<br><span class=\"hljs-attribute\">sudo</span> apt install curl<br><span class=\"hljs-attribute\">sudo</span> apt install php-pgsql<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-xml<br><span class=\"hljs-attribute\">sudo</span> apt install apache<span class=\"hljs-number\">2</span><br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-bcmath<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-mbstring<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-ldap<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">0</span>-snmp<br></code></pre></td></tr></table></figure>\n<h1 id=\"下载-amp-amp-编译-amp-amp-安装\"><a href=\"#下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"下载  &amp;&amp; 编译 &amp;&amp; 安装\"></a>下载  &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">useradd -m zabbix -d <span class=\"hljs-string\">/home/zabbix</span><br>su - zabbix<br>wget https:<span class=\"hljs-string\">//cdn.zabbix.com/zabbix/sources/stable/4.0/zabbix-4.0.2.tar.gz</span><br>tar -zxvf zabbix-4.0.2.tar.gz<br><span class=\"hljs-keyword\">cd</span> zabbix-4.0.2/<br><span class=\"hljs-string\">./configure</span> <span class=\"hljs-params\">--prefix=/home/zabbix/release</span> <span class=\"hljs-params\">--enable-server</span> <span class=\"hljs-params\">--enable-proxy</span> <span class=\"hljs-params\">--enable-agent</span> <span class=\"hljs-params\">--enable-ipv6</span> <span class=\"hljs-params\">--with-postgresql=/opt/pg11/bin/pg_config</span> <span class=\"hljs-params\">--with-net-snmp</span> <span class=\"hljs-params\">--with-ssh2</span> <span class=\"hljs-params\">--with-openipmi</span> <span class=\"hljs-params\">--with-ldap</span> <span class=\"hljs-params\">--with-libcurl</span> <span class=\"hljs-params\">--with-iconv</span> <span class=\"hljs-params\">--enable-bcmath</span> <span class=\"hljs-params\">--enable-mbstring</span>  <span class=\"hljs-params\">--with-gd</span>  <span class=\"hljs-params\">--with-png-dir</span> <span class=\"hljs-params\">--with-jpeg-dir</span> <span class=\"hljs-params\">--with-freetype-dir</span><br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure>\n<h1 id=\"配置zabbix\"><a href=\"#配置zabbix\" class=\"headerlink\" title=\"配置zabbix\"></a>配置zabbix</h1><p>cd /home/zabbix/release/sbin<br>vim ../etc/zabbix_server.conf 填写正确DB内容<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">DBHost</span>=DBHost<br><span class=\"hljs-attr\">DBName</span>=DBName<br><span class=\"hljs-attr\">DBUser</span>=DBUser<br><span class=\"hljs-attr\">DBPassword</span>=<span class=\"hljs-string\">&#x27;DBPassword&#x27;</span><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">./zabbix_server<br><span class=\"hljs-regexp\">/etc/i</span>nit.d/apache2 start<br>sudo mkdir <span class=\"hljs-regexp\">/var/</span>www<span class=\"hljs-regexp\">/html/</span>zabbix<br>sudo chown -R zabbix:zabbix<br>cp -fr <span class=\"hljs-regexp\">/home/</span>zabbix<span class=\"hljs-regexp\">/zabbix-4.0.2/</span>frontends<span class=\"hljs-regexp\">/php/</span>* <span class=\"hljs-regexp\">/var/</span>www<span class=\"hljs-regexp\">/html/</span>zabbix<br><br></code></pre></td></tr></table></figure>\n<p>页面就可以登陆了。</p>\n<h1 id=\"配置zabbix-1\"><a href=\"#配置zabbix-1\" class=\"headerlink\" title=\"配置zabbix\"></a>配置zabbix</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>hostname<span class=\"hljs-regexp\">/zabbix/</span>setup.php<br></code></pre></td></tr></table></figure>\n<p><img data-src=\"/images/zabbix01.png\" alt=\"zabbix01\"></p>\n<p>下一步，修改php配置保证所有状态直到OK</p>\n<p><img data-src=\"/images/zabbix02.png\" alt=\"zabbix02\"></p>\n<h1 id=\"FAQ\"><a href=\"#FAQ\" class=\"headerlink\" title=\"FAQ\"></a>FAQ</h1><p>PHP databases support off Fail<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">extension=<span class=\"hljs-regexp\">/opt/</span>remi<span class=\"hljs-regexp\">/php72/</span>root<span class=\"hljs-regexp\">/usr/</span>lib64<span class=\"hljs-regexp\">/php/m</span>odules/pgsql.so<br></code></pre></td></tr></table></figure></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"新建帐号\"><a href=\"#新建帐号\" class=\"headerlink\" title=\"新建帐号\"></a>新建帐号</h1><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs properties\"><span class=\"hljs-attr\">groupadd</span> <span class=\"hljs-string\">zabbix</span><br><span class=\"hljs-attr\">useradd</span> <span class=\"hljs-string\">-g zabbix zabbix</span><br></code></pre></td></tr></table></figure>","more":"<h1 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sudo</span> apt install libsnmp-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libssh<span class=\"hljs-number\">2</span>-<span class=\"hljs-number\">1</span>*<br><span class=\"hljs-attribute\">sudo</span> apt install libopenipmi-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libldap<span class=\"hljs-number\">2</span>-dev<br><span class=\"hljs-attribute\">sudo</span> apt install libevent-dev<br><span class=\"hljs-attribute\">sudo</span> apt install curl<br><span class=\"hljs-attribute\">sudo</span> apt install php-pgsql<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-xml<br><span class=\"hljs-attribute\">sudo</span> apt install apache<span class=\"hljs-number\">2</span><br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-bcmath<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-mbstring<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">2</span>-ldap<br><span class=\"hljs-attribute\">sudo</span> apt install php<span class=\"hljs-number\">7</span>.<span class=\"hljs-number\">0</span>-snmp<br></code></pre></td></tr></table></figure>\n<h1 id=\"下载-amp-amp-编译-amp-amp-安装\"><a href=\"#下载-amp-amp-编译-amp-amp-安装\" class=\"headerlink\" title=\"下载  &amp;&amp; 编译 &amp;&amp; 安装\"></a>下载  &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">useradd -m zabbix -d <span class=\"hljs-string\">/home/zabbix</span><br>su - zabbix<br>wget https:<span class=\"hljs-string\">//cdn.zabbix.com/zabbix/sources/stable/4.0/zabbix-4.0.2.tar.gz</span><br>tar -zxvf zabbix-4.0.2.tar.gz<br><span class=\"hljs-keyword\">cd</span> zabbix-4.0.2/<br><span class=\"hljs-string\">./configure</span> <span class=\"hljs-params\">--prefix=/home/zabbix/release</span> <span class=\"hljs-params\">--enable-server</span> <span class=\"hljs-params\">--enable-proxy</span> <span class=\"hljs-params\">--enable-agent</span> <span class=\"hljs-params\">--enable-ipv6</span> <span class=\"hljs-params\">--with-postgresql=/opt/pg11/bin/pg_config</span> <span class=\"hljs-params\">--with-net-snmp</span> <span class=\"hljs-params\">--with-ssh2</span> <span class=\"hljs-params\">--with-openipmi</span> <span class=\"hljs-params\">--with-ldap</span> <span class=\"hljs-params\">--with-libcurl</span> <span class=\"hljs-params\">--with-iconv</span> <span class=\"hljs-params\">--enable-bcmath</span> <span class=\"hljs-params\">--enable-mbstring</span>  <span class=\"hljs-params\">--with-gd</span>  <span class=\"hljs-params\">--with-png-dir</span> <span class=\"hljs-params\">--with-jpeg-dir</span> <span class=\"hljs-params\">--with-freetype-dir</span><br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure>\n<h1 id=\"配置zabbix\"><a href=\"#配置zabbix\" class=\"headerlink\" title=\"配置zabbix\"></a>配置zabbix</h1><p>cd /home/zabbix/release/sbin<br>vim ../etc/zabbix_server.conf 填写正确DB内容<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">DBHost</span>=DBHost<br><span class=\"hljs-attr\">DBName</span>=DBName<br><span class=\"hljs-attr\">DBUser</span>=DBUser<br><span class=\"hljs-attr\">DBPassword</span>=<span class=\"hljs-string\">&#x27;DBPassword&#x27;</span><br></code></pre></td></tr></table></figure></p>\n<h1 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">./zabbix_server<br><span class=\"hljs-regexp\">/etc/i</span>nit.d/apache2 start<br>sudo mkdir <span class=\"hljs-regexp\">/var/</span>www<span class=\"hljs-regexp\">/html/</span>zabbix<br>sudo chown -R zabbix:zabbix<br>cp -fr <span class=\"hljs-regexp\">/home/</span>zabbix<span class=\"hljs-regexp\">/zabbix-4.0.2/</span>frontends<span class=\"hljs-regexp\">/php/</span>* <span class=\"hljs-regexp\">/var/</span>www<span class=\"hljs-regexp\">/html/</span>zabbix<br><br></code></pre></td></tr></table></figure>\n<p>页面就可以登陆了。</p>\n<h1 id=\"配置zabbix-1\"><a href=\"#配置zabbix-1\" class=\"headerlink\" title=\"配置zabbix\"></a>配置zabbix</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>hostname<span class=\"hljs-regexp\">/zabbix/</span>setup.php<br></code></pre></td></tr></table></figure>\n<p><img data-src=\"/images/zabbix01.png\" alt=\"zabbix01\"></p>\n<p>下一步，修改php配置保证所有状态直到OK</p>\n<p><img data-src=\"/images/zabbix02.png\" alt=\"zabbix02\"></p>\n<h1 id=\"FAQ\"><a href=\"#FAQ\" class=\"headerlink\" title=\"FAQ\"></a>FAQ</h1><p>PHP databases support off Fail<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">extension=<span class=\"hljs-regexp\">/opt/</span>remi<span class=\"hljs-regexp\">/php72/</span>root<span class=\"hljs-regexp\">/usr/</span>lib64<span class=\"hljs-regexp\">/php/m</span>odules/pgsql.so<br></code></pre></td></tr></table></figure></p>"},{"title":"微信聊天自动回复机器人代码","date":"2020-08-04T16:00:00.000Z","top":9,"password":null,"_content":"\n微信聊天自动回复小程序, 输入指定内容控制开关，以及添加附加内容等小功能,\n\n<!-- more -->\n\n\n# 完整代码\n```\n#!/usr/bin/python\n# -*- coding: utf-8 -*-\n\nimport itchat\nimport re,requests\nfrom urllib.parse import quote,unquote\n\nAUTO_REPLAY=0\nBASEMSG = ''\n\ndef robot(data):\n    global AUTO_REPLAY\n    ini=\"{'sessionId':'09e2aca4d0a541f88eecc77c03a8b393','robotId':'webbot','userId':'462d49d3742745bb98f7538c42f9f874','body':{'content':'\" + data + \"'},'type':'txt'}&ts=1529917589648\"\n    url = \"http://i.xiaoi.com/robot/webrobot?&callback=__webrobot_processMsg&data=\" + quote(ini)\n    cookie = {\"cnonce\": \"808116\", \"sig\": \"0c3021aa5552fe597bb55448b40ad2a90d2dead5\",\"XISESSIONID\": \"hlbnd1oiwar01dfje825gavcn\", \"nonce\": \"273765\", \"hibext_instdsigdip2\": \"1\"}\n    r = requests.get(url, cookies=cookie)\n    #print(type(r))\n    #json_r = r.json()\n    #print(json_r)\n    pattern = re.compile(r'\\\"fontColor\\\":0,\\\"content\\\":\\\"(.*?)\\\"')\n    result = pattern.findall(r.text)\n        #return result[1].replace(\"\\\\r\\\\n\",'')\n        #return result[1].replace(\"\\\\n\",'')\n    return result[1].replace(\"\\\\r\\\\n\",'')\n\nimport re,requests\ntry:\n    from urllib import quote,unquote\nexcept ImportError:\n    from urllib.parse import quote,unquote\n\nimport json\n\n\ndef qingke_robot(msg):\n    #ssl._create_default_https_context = ssl._create_unverified_context\n    url = r\"http://api.qingyunke.com/api.php?key=free&appid=0&msg=%s\" % (quote(msg))\n\n    try:\n            from urllib.request import urlopen\n    except ImportError:\n            from urllib2 import urlopen\n\n    result = urlopen(url)\n    response = json.loads(result.read().decode(\"utf-8\"))\n    code = response['result']\n    if code != 0:\n        return \"error\"\n    content = response['content'].replace('{br}','\\n')\n    return content\n\n\n# 自动回复\n# 封装好的装饰器，当接收到的消息是Text，即文字消息\n@itchat.msg_register('Text')\ndef text_reply(msg):\n    global BASEMSG\n    global AUTO_REPLAY\n    # 当消息不是由自己发出的时候\n    #return  u\"[主人暂时不在，我是周小秘]{}\".format(tulin_robot(msg['Text']))\n    #return  u\"[主人暂时不在，我是周小秘]{}\".format(robot(msg['Text']))\n\n    if msg['Text'].lower() == \"open\":\n        AUTO_REPLAY=1\n        return \"自动聊天功能已打开.\"\n    elif msg['Text'].lower() == \"close\":\n        AUTO_REPLAY=0\n        return \"自动聊天功能已关闭.\"\n    elif msg['Text'].lower() == \"add\":\n        BASEMSG = \"[主人暂时不在，我是周小秘 ]:\"\n        return \"添加附加内容成功\"\n    elif msg['Text'].lower() == \"del\":\n        BASEMSG = \"\"\n        AUTO_REPLAY=0\n        return \"取消附加内容成功\"\n\n    # 回复给好友\n    if AUTO_REPLAY > 0 :\n        if BASEMSG != \"\":\n            return BASEMSG + qingke_robot(msg['Text'])\n        return qingke_robot(msg['Text'])\n\nif __name__ == '__main__':\n    itchat.auto_login(enableCmdQR=2)\n\n    # 获取自己的UserName\n    myUserName = itchat.get_friends(update=True)[0][\"UserName\"]\n    itchat.run(debug=True)\n    #print(qingke_robot(\"你好\"))\n\n```\n","source":"_posts/微信聊天自动回复机器人.md","raw":"---\ntitle: 微信聊天自动回复机器人代码\ndate: 2020-08-05\ntags: [ robot, 微信自动回复, python ]\ncategories: python\ntop: 9\npassword: \n\n---\n\n微信聊天自动回复小程序, 输入指定内容控制开关，以及添加附加内容等小功能,\n\n<!-- more -->\n\n\n# 完整代码\n```\n#!/usr/bin/python\n# -*- coding: utf-8 -*-\n\nimport itchat\nimport re,requests\nfrom urllib.parse import quote,unquote\n\nAUTO_REPLAY=0\nBASEMSG = ''\n\ndef robot(data):\n    global AUTO_REPLAY\n    ini=\"{'sessionId':'09e2aca4d0a541f88eecc77c03a8b393','robotId':'webbot','userId':'462d49d3742745bb98f7538c42f9f874','body':{'content':'\" + data + \"'},'type':'txt'}&ts=1529917589648\"\n    url = \"http://i.xiaoi.com/robot/webrobot?&callback=__webrobot_processMsg&data=\" + quote(ini)\n    cookie = {\"cnonce\": \"808116\", \"sig\": \"0c3021aa5552fe597bb55448b40ad2a90d2dead5\",\"XISESSIONID\": \"hlbnd1oiwar01dfje825gavcn\", \"nonce\": \"273765\", \"hibext_instdsigdip2\": \"1\"}\n    r = requests.get(url, cookies=cookie)\n    #print(type(r))\n    #json_r = r.json()\n    #print(json_r)\n    pattern = re.compile(r'\\\"fontColor\\\":0,\\\"content\\\":\\\"(.*?)\\\"')\n    result = pattern.findall(r.text)\n        #return result[1].replace(\"\\\\r\\\\n\",'')\n        #return result[1].replace(\"\\\\n\",'')\n    return result[1].replace(\"\\\\r\\\\n\",'')\n\nimport re,requests\ntry:\n    from urllib import quote,unquote\nexcept ImportError:\n    from urllib.parse import quote,unquote\n\nimport json\n\n\ndef qingke_robot(msg):\n    #ssl._create_default_https_context = ssl._create_unverified_context\n    url = r\"http://api.qingyunke.com/api.php?key=free&appid=0&msg=%s\" % (quote(msg))\n\n    try:\n            from urllib.request import urlopen\n    except ImportError:\n            from urllib2 import urlopen\n\n    result = urlopen(url)\n    response = json.loads(result.read().decode(\"utf-8\"))\n    code = response['result']\n    if code != 0:\n        return \"error\"\n    content = response['content'].replace('{br}','\\n')\n    return content\n\n\n# 自动回复\n# 封装好的装饰器，当接收到的消息是Text，即文字消息\n@itchat.msg_register('Text')\ndef text_reply(msg):\n    global BASEMSG\n    global AUTO_REPLAY\n    # 当消息不是由自己发出的时候\n    #return  u\"[主人暂时不在，我是周小秘]{}\".format(tulin_robot(msg['Text']))\n    #return  u\"[主人暂时不在，我是周小秘]{}\".format(robot(msg['Text']))\n\n    if msg['Text'].lower() == \"open\":\n        AUTO_REPLAY=1\n        return \"自动聊天功能已打开.\"\n    elif msg['Text'].lower() == \"close\":\n        AUTO_REPLAY=0\n        return \"自动聊天功能已关闭.\"\n    elif msg['Text'].lower() == \"add\":\n        BASEMSG = \"[主人暂时不在，我是周小秘 ]:\"\n        return \"添加附加内容成功\"\n    elif msg['Text'].lower() == \"del\":\n        BASEMSG = \"\"\n        AUTO_REPLAY=0\n        return \"取消附加内容成功\"\n\n    # 回复给好友\n    if AUTO_REPLAY > 0 :\n        if BASEMSG != \"\":\n            return BASEMSG + qingke_robot(msg['Text'])\n        return qingke_robot(msg['Text'])\n\nif __name__ == '__main__':\n    itchat.auto_login(enableCmdQR=2)\n\n    # 获取自己的UserName\n    myUserName = itchat.get_friends(update=True)[0][\"UserName\"]\n    itchat.run(debug=True)\n    #print(qingke_robot(\"你好\"))\n\n```\n","slug":"微信聊天自动回复机器人","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhx001ipiebaclaebpw","content":"<p>微信聊天自动回复小程序, 输入指定内容控制开关，以及添加附加内容等小功能,</p>\n<a id=\"more\"></a>\n<h1 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\">#!/usr/bin/python</span><br><span class=\"hljs-comment\"># -*- coding: utf-8 -*-</span><br><br><span class=\"hljs-keyword\">import</span> itchat<br><span class=\"hljs-keyword\">import</span> re,requests<br><span class=\"hljs-keyword\">from</span> urllib.parse <span class=\"hljs-keyword\">import</span> quote,unquote<br><br>AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>BASEMSG = <span class=\"hljs-string\">&#x27;&#x27;</span><br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">robot</span>(<span class=\"hljs-params\">data</span>):</span><br>    <span class=\"hljs-keyword\">global</span> AUTO_REPLAY<br>    ini=<span class=\"hljs-string\">&quot;&#123;&#x27;sessionId&#x27;:&#x27;09e2aca4d0a541f88eecc77c03a8b393&#x27;,&#x27;robotId&#x27;:&#x27;webbot&#x27;,&#x27;userId&#x27;:&#x27;462d49d3742745bb98f7538c42f9f874&#x27;,&#x27;body&#x27;:&#123;&#x27;content&#x27;:&#x27;&quot;</span> + data + <span class=\"hljs-string\">&quot;&#x27;&#125;,&#x27;type&#x27;:&#x27;txt&#x27;&#125;&amp;ts=1529917589648&quot;</span><br>    url = <span class=\"hljs-string\">&quot;http://i.xiaoi.com/robot/webrobot?&amp;callback=__webrobot_processMsg&amp;data=&quot;</span> + quote(ini)<br>    cookie = &#123;<span class=\"hljs-string\">&quot;cnonce&quot;</span>: <span class=\"hljs-string\">&quot;808116&quot;</span>, <span class=\"hljs-string\">&quot;sig&quot;</span>: <span class=\"hljs-string\">&quot;0c3021aa5552fe597bb55448b40ad2a90d2dead5&quot;</span>,<span class=\"hljs-string\">&quot;XISESSIONID&quot;</span>: <span class=\"hljs-string\">&quot;hlbnd1oiwar01dfje825gavcn&quot;</span>, <span class=\"hljs-string\">&quot;nonce&quot;</span>: <span class=\"hljs-string\">&quot;273765&quot;</span>, <span class=\"hljs-string\">&quot;hibext_instdsigdip2&quot;</span>: <span class=\"hljs-string\">&quot;1&quot;</span>&#125;<br>    r = requests.get(url, cookies=cookie)<br>    <span class=\"hljs-comment\">#print(type(r))</span><br>    <span class=\"hljs-comment\">#json_r = r.json()</span><br>    <span class=\"hljs-comment\">#print(json_r)</span><br>    pattern = re.compile(<span class=\"hljs-string\">r&#x27;\\&quot;fontColor\\&quot;:0,\\&quot;content\\&quot;:\\&quot;(.*?)\\&quot;&#x27;</span>)<br>    result = pattern.findall(r.text)<br>        <span class=\"hljs-comment\">#return result[1].replace(&quot;\\\\r\\\\n&quot;,&#x27;&#x27;)</span><br>        <span class=\"hljs-comment\">#return result[1].replace(&quot;\\\\n&quot;,&#x27;&#x27;)</span><br>    <span class=\"hljs-keyword\">return</span> result[<span class=\"hljs-number\">1</span>].replace(<span class=\"hljs-string\">&quot;\\\\r\\\\n&quot;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)<br><br><span class=\"hljs-keyword\">import</span> re,requests<br><span class=\"hljs-keyword\">try</span>:<br>    <span class=\"hljs-keyword\">from</span> urllib <span class=\"hljs-keyword\">import</span> quote,unquote<br><span class=\"hljs-keyword\">except</span> ImportError:<br>    <span class=\"hljs-keyword\">from</span> urllib.parse <span class=\"hljs-keyword\">import</span> quote,unquote<br><br><span class=\"hljs-keyword\">import</span> json<br><br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">qingke_robot</span>(<span class=\"hljs-params\">msg</span>):</span><br>    <span class=\"hljs-comment\">#ssl._create_default_https_context = ssl._create_unverified_context</span><br>    url = <span class=\"hljs-string\">r&quot;http://api.qingyunke.com/api.php?key=free&amp;appid=0&amp;msg=%s&quot;</span> % (quote(msg))<br><br>    <span class=\"hljs-keyword\">try</span>:<br>            <span class=\"hljs-keyword\">from</span> urllib.request <span class=\"hljs-keyword\">import</span> urlopen<br>    <span class=\"hljs-keyword\">except</span> ImportError:<br>            <span class=\"hljs-keyword\">from</span> urllib2 <span class=\"hljs-keyword\">import</span> urlopen<br><br>    result = urlopen(url)<br>    response = json.loads(result.read().decode(<span class=\"hljs-string\">&quot;utf-8&quot;</span>))<br>    code = response[<span class=\"hljs-string\">&#x27;result&#x27;</span>]<br>    <span class=\"hljs-keyword\">if</span> code != <span class=\"hljs-number\">0</span>:<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;error&quot;</span><br>    content = response[<span class=\"hljs-string\">&#x27;content&#x27;</span>].replace(<span class=\"hljs-string\">&#x27;&#123;br&#125;&#x27;</span>,<span class=\"hljs-string\">&#x27;\\n&#x27;</span>)<br>    <span class=\"hljs-keyword\">return</span> content<br><br><br><span class=\"hljs-comment\"># 自动回复</span><br><span class=\"hljs-comment\"># 封装好的装饰器，当接收到的消息是Text，即文字消息</span><br><span class=\"hljs-meta\">@itchat.msg_register(&#x27;Text&#x27;)</span><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">text_reply</span>(<span class=\"hljs-params\">msg</span>):</span><br>    <span class=\"hljs-keyword\">global</span> BASEMSG<br>    <span class=\"hljs-keyword\">global</span> AUTO_REPLAY<br>    <span class=\"hljs-comment\"># 当消息不是由自己发出的时候</span><br>    <span class=\"hljs-comment\">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(tulin_robot(msg[&#x27;Text&#x27;]))</span><br>    <span class=\"hljs-comment\">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(robot(msg[&#x27;Text&#x27;]))</span><br><br>    <span class=\"hljs-keyword\">if</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;open&quot;</span>:<br>        AUTO_REPLAY=<span class=\"hljs-number\">1</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;自动聊天功能已打开.&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;close&quot;</span>:<br>        AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;自动聊天功能已关闭.&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;add&quot;</span>:<br>        BASEMSG = <span class=\"hljs-string\">&quot;[主人暂时不在，我是周小秘 ]:&quot;</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;添加附加内容成功&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;del&quot;</span>:<br>        BASEMSG = <span class=\"hljs-string\">&quot;&quot;</span><br>        AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;取消附加内容成功&quot;</span><br><br>    <span class=\"hljs-comment\"># 回复给好友</span><br>    <span class=\"hljs-keyword\">if</span> AUTO_REPLAY &gt; <span class=\"hljs-number\">0</span> :<br>        <span class=\"hljs-keyword\">if</span> BASEMSG != <span class=\"hljs-string\">&quot;&quot;</span>:<br>            <span class=\"hljs-keyword\">return</span> BASEMSG + qingke_robot(msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>])<br>        <span class=\"hljs-keyword\">return</span> qingke_robot(msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>])<br><br><span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&#x27;__main__&#x27;</span>:<br>    itchat.auto_login(enableCmdQR=<span class=\"hljs-number\">2</span>)<br><br>    <span class=\"hljs-comment\"># 获取自己的UserName</span><br>    myUserName = itchat.get_friends(update=<span class=\"hljs-literal\">True</span>)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-string\">&quot;UserName&quot;</span>]<br>    itchat.run(debug=<span class=\"hljs-literal\">True</span>)<br>    <span class=\"hljs-comment\">#print(qingke_robot(&quot;你好&quot;))</span><br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>微信聊天自动回复小程序, 输入指定内容控制开关，以及添加附加内容等小功能,</p>","more":"<h1 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\">#!/usr/bin/python</span><br><span class=\"hljs-comment\"># -*- coding: utf-8 -*-</span><br><br><span class=\"hljs-keyword\">import</span> itchat<br><span class=\"hljs-keyword\">import</span> re,requests<br><span class=\"hljs-keyword\">from</span> urllib.parse <span class=\"hljs-keyword\">import</span> quote,unquote<br><br>AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>BASEMSG = <span class=\"hljs-string\">&#x27;&#x27;</span><br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">robot</span>(<span class=\"hljs-params\">data</span>):</span><br>    <span class=\"hljs-keyword\">global</span> AUTO_REPLAY<br>    ini=<span class=\"hljs-string\">&quot;&#123;&#x27;sessionId&#x27;:&#x27;09e2aca4d0a541f88eecc77c03a8b393&#x27;,&#x27;robotId&#x27;:&#x27;webbot&#x27;,&#x27;userId&#x27;:&#x27;462d49d3742745bb98f7538c42f9f874&#x27;,&#x27;body&#x27;:&#123;&#x27;content&#x27;:&#x27;&quot;</span> + data + <span class=\"hljs-string\">&quot;&#x27;&#125;,&#x27;type&#x27;:&#x27;txt&#x27;&#125;&amp;ts=1529917589648&quot;</span><br>    url = <span class=\"hljs-string\">&quot;http://i.xiaoi.com/robot/webrobot?&amp;callback=__webrobot_processMsg&amp;data=&quot;</span> + quote(ini)<br>    cookie = &#123;<span class=\"hljs-string\">&quot;cnonce&quot;</span>: <span class=\"hljs-string\">&quot;808116&quot;</span>, <span class=\"hljs-string\">&quot;sig&quot;</span>: <span class=\"hljs-string\">&quot;0c3021aa5552fe597bb55448b40ad2a90d2dead5&quot;</span>,<span class=\"hljs-string\">&quot;XISESSIONID&quot;</span>: <span class=\"hljs-string\">&quot;hlbnd1oiwar01dfje825gavcn&quot;</span>, <span class=\"hljs-string\">&quot;nonce&quot;</span>: <span class=\"hljs-string\">&quot;273765&quot;</span>, <span class=\"hljs-string\">&quot;hibext_instdsigdip2&quot;</span>: <span class=\"hljs-string\">&quot;1&quot;</span>&#125;<br>    r = requests.get(url, cookies=cookie)<br>    <span class=\"hljs-comment\">#print(type(r))</span><br>    <span class=\"hljs-comment\">#json_r = r.json()</span><br>    <span class=\"hljs-comment\">#print(json_r)</span><br>    pattern = re.compile(<span class=\"hljs-string\">r&#x27;\\&quot;fontColor\\&quot;:0,\\&quot;content\\&quot;:\\&quot;(.*?)\\&quot;&#x27;</span>)<br>    result = pattern.findall(r.text)<br>        <span class=\"hljs-comment\">#return result[1].replace(&quot;\\\\r\\\\n&quot;,&#x27;&#x27;)</span><br>        <span class=\"hljs-comment\">#return result[1].replace(&quot;\\\\n&quot;,&#x27;&#x27;)</span><br>    <span class=\"hljs-keyword\">return</span> result[<span class=\"hljs-number\">1</span>].replace(<span class=\"hljs-string\">&quot;\\\\r\\\\n&quot;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)<br><br><span class=\"hljs-keyword\">import</span> re,requests<br><span class=\"hljs-keyword\">try</span>:<br>    <span class=\"hljs-keyword\">from</span> urllib <span class=\"hljs-keyword\">import</span> quote,unquote<br><span class=\"hljs-keyword\">except</span> ImportError:<br>    <span class=\"hljs-keyword\">from</span> urllib.parse <span class=\"hljs-keyword\">import</span> quote,unquote<br><br><span class=\"hljs-keyword\">import</span> json<br><br><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">qingke_robot</span>(<span class=\"hljs-params\">msg</span>):</span><br>    <span class=\"hljs-comment\">#ssl._create_default_https_context = ssl._create_unverified_context</span><br>    url = <span class=\"hljs-string\">r&quot;http://api.qingyunke.com/api.php?key=free&amp;appid=0&amp;msg=%s&quot;</span> % (quote(msg))<br><br>    <span class=\"hljs-keyword\">try</span>:<br>            <span class=\"hljs-keyword\">from</span> urllib.request <span class=\"hljs-keyword\">import</span> urlopen<br>    <span class=\"hljs-keyword\">except</span> ImportError:<br>            <span class=\"hljs-keyword\">from</span> urllib2 <span class=\"hljs-keyword\">import</span> urlopen<br><br>    result = urlopen(url)<br>    response = json.loads(result.read().decode(<span class=\"hljs-string\">&quot;utf-8&quot;</span>))<br>    code = response[<span class=\"hljs-string\">&#x27;result&#x27;</span>]<br>    <span class=\"hljs-keyword\">if</span> code != <span class=\"hljs-number\">0</span>:<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;error&quot;</span><br>    content = response[<span class=\"hljs-string\">&#x27;content&#x27;</span>].replace(<span class=\"hljs-string\">&#x27;&#123;br&#125;&#x27;</span>,<span class=\"hljs-string\">&#x27;\\n&#x27;</span>)<br>    <span class=\"hljs-keyword\">return</span> content<br><br><br><span class=\"hljs-comment\"># 自动回复</span><br><span class=\"hljs-comment\"># 封装好的装饰器，当接收到的消息是Text，即文字消息</span><br><span class=\"hljs-meta\">@itchat.msg_register(&#x27;Text&#x27;)</span><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">text_reply</span>(<span class=\"hljs-params\">msg</span>):</span><br>    <span class=\"hljs-keyword\">global</span> BASEMSG<br>    <span class=\"hljs-keyword\">global</span> AUTO_REPLAY<br>    <span class=\"hljs-comment\"># 当消息不是由自己发出的时候</span><br>    <span class=\"hljs-comment\">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(tulin_robot(msg[&#x27;Text&#x27;]))</span><br>    <span class=\"hljs-comment\">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(robot(msg[&#x27;Text&#x27;]))</span><br><br>    <span class=\"hljs-keyword\">if</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;open&quot;</span>:<br>        AUTO_REPLAY=<span class=\"hljs-number\">1</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;自动聊天功能已打开.&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;close&quot;</span>:<br>        AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;自动聊天功能已关闭.&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;add&quot;</span>:<br>        BASEMSG = <span class=\"hljs-string\">&quot;[主人暂时不在，我是周小秘 ]:&quot;</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;添加附加内容成功&quot;</span><br>    <span class=\"hljs-keyword\">elif</span> msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>].lower() == <span class=\"hljs-string\">&quot;del&quot;</span>:<br>        BASEMSG = <span class=\"hljs-string\">&quot;&quot;</span><br>        AUTO_REPLAY=<span class=\"hljs-number\">0</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;取消附加内容成功&quot;</span><br><br>    <span class=\"hljs-comment\"># 回复给好友</span><br>    <span class=\"hljs-keyword\">if</span> AUTO_REPLAY &gt; <span class=\"hljs-number\">0</span> :<br>        <span class=\"hljs-keyword\">if</span> BASEMSG != <span class=\"hljs-string\">&quot;&quot;</span>:<br>            <span class=\"hljs-keyword\">return</span> BASEMSG + qingke_robot(msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>])<br>        <span class=\"hljs-keyword\">return</span> qingke_robot(msg[<span class=\"hljs-string\">&#x27;Text&#x27;</span>])<br><br><span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&#x27;__main__&#x27;</span>:<br>    itchat.auto_login(enableCmdQR=<span class=\"hljs-number\">2</span>)<br><br>    <span class=\"hljs-comment\"># 获取自己的UserName</span><br>    myUserName = itchat.get_friends(update=<span class=\"hljs-literal\">True</span>)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-string\">&quot;UserName&quot;</span>]<br>    itchat.run(debug=<span class=\"hljs-literal\">True</span>)<br>    <span class=\"hljs-comment\">#print(qingke_robot(&quot;你好&quot;))</span><br><br></code></pre></td></tr></table></figure>"},{"title":"有用的连接","date":"2020-08-11T03:39:59.000Z","top":12,"description":null,"password":null,"_content":"\n## gis教程\n```\nhttps://www.zhihu.com/column/c_1253365661696491520\n```\n\n## 刑法准则\n```\nhttp://www.npc.gov.cn/wxzl/wxzl/2000-12/17/content_4680.htm\n```\n\n## 各种数据库SQL标准实现对比\n```\nhttps://www.sql-workbench.eu/dbms_comparison.html\n```\n\n## PostgreSQL RPMS\n```\nhttps://github.com/cybertec-postgresql/\n```\n\n## PostgreSQL MVCC\n```\nhttp://www.interdb.jp/pg/pgsql05.html\n```\n\n## 生成随即背景图片\n```\nhttps://source.unsplash.com/\n```\n\n## SQL格式化\n```\nhttp://sqlformat.darold.net/\n```\n\n<!-- more -->\n\n## PG11中文手册\n```\nhttps://www.docs4dev.com/docs/zh/postgre-sql/11.2/reference/release-11-2.html\n```\n\n## JSON格式化\n```\nhttps://www.json.cn/\n```\n\n## PostgreSQL特性矩阵\n```\nhttps://www.postgresql.org/about/featurematrix/\n```\n\n## Converting from other Databases to PostgreSQL\n```\nhttps://wiki.postgresql.org/wiki/Converting_from_other_Databases_to_PostgreSQL#Utilities.2C_tools.2C_scripts_etc\n```\n","source":"_posts/有用的连接.md","raw":"---\ntitle:  有用的连接\ndate: 2020-08-11 11:39:59\ntags: \n- Linux \n- python\n- personal\n\ncategories: \n- 个人记录\n\ntop: 12\ndescription: \npassword: \n\n---\n\n## gis教程\n```\nhttps://www.zhihu.com/column/c_1253365661696491520\n```\n\n## 刑法准则\n```\nhttp://www.npc.gov.cn/wxzl/wxzl/2000-12/17/content_4680.htm\n```\n\n## 各种数据库SQL标准实现对比\n```\nhttps://www.sql-workbench.eu/dbms_comparison.html\n```\n\n## PostgreSQL RPMS\n```\nhttps://github.com/cybertec-postgresql/\n```\n\n## PostgreSQL MVCC\n```\nhttp://www.interdb.jp/pg/pgsql05.html\n```\n\n## 生成随即背景图片\n```\nhttps://source.unsplash.com/\n```\n\n## SQL格式化\n```\nhttp://sqlformat.darold.net/\n```\n\n<!-- more -->\n\n## PG11中文手册\n```\nhttps://www.docs4dev.com/docs/zh/postgre-sql/11.2/reference/release-11-2.html\n```\n\n## JSON格式化\n```\nhttps://www.json.cn/\n```\n\n## PostgreSQL特性矩阵\n```\nhttps://www.postgresql.org/about/featurematrix/\n```\n\n## Converting from other Databases to PostgreSQL\n```\nhttps://wiki.postgresql.org/wiki/Converting_from_other_Databases_to_PostgreSQL#Utilities.2C_tools.2C_scripts_etc\n```\n","slug":"有用的连接","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzhy001lpieb5g2n9ckx","content":"<h2 id=\"gis教程\"><a href=\"#gis教程\" class=\"headerlink\" title=\"gis教程\"></a>gis教程</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.zhihu.com<span class=\"hljs-regexp\">/column/</span>c_1253365661696491520<br></code></pre></td></tr></table></figure>\n<h2 id=\"刑法准则\"><a href=\"#刑法准则\" class=\"headerlink\" title=\"刑法准则\"></a>刑法准则</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>www.npc.gov.cn<span class=\"hljs-regexp\">/wxzl/</span>wxzl<span class=\"hljs-regexp\">/2000-12/</span><span class=\"hljs-number\">17</span>/content_4680.htm<br></code></pre></td></tr></table></figure>\n<h2 id=\"各种数据库SQL标准实现对比\"><a href=\"#各种数据库SQL标准实现对比\" class=\"headerlink\" title=\"各种数据库SQL标准实现对比\"></a>各种数据库SQL标准实现对比</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.sql-workbench.eu/dbms_comparison.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL-RPMS\"><a href=\"#PostgreSQL-RPMS\" class=\"headerlink\" title=\"PostgreSQL RPMS\"></a>PostgreSQL RPMS</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/cybertec-postgresql/</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL-MVCC\"><a href=\"#PostgreSQL-MVCC\" class=\"headerlink\" title=\"PostgreSQL MVCC\"></a>PostgreSQL MVCC</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>www.interdb.jp<span class=\"hljs-regexp\">/pg/</span>pgsql05.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"生成随即背景图片\"><a href=\"#生成随即背景图片\" class=\"headerlink\" title=\"生成随即背景图片\"></a>生成随即背景图片</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">http<span class=\"hljs-variable\">s:</span>//<span class=\"hljs-keyword\">source</span>.unsplash.<span class=\"hljs-keyword\">com</span>/<br></code></pre></td></tr></table></figure>\n<h2 id=\"SQL格式化\"><a href=\"#SQL格式化\" class=\"headerlink\" title=\"SQL格式化\"></a>SQL格式化</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>sqlformat.darold.net/<br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"PG11中文手册\"><a href=\"#PG11中文手册\" class=\"headerlink\" title=\"PG11中文手册\"></a>PG11中文手册</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.docs4dev.com<span class=\"hljs-regexp\">/docs/</span>zh<span class=\"hljs-regexp\">/postgre-sql/</span><span class=\"hljs-number\">11.2</span><span class=\"hljs-regexp\">/reference/</span>release-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">2</span>.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"JSON格式化\"><a href=\"#JSON格式化\" class=\"headerlink\" title=\"JSON格式化\"></a>JSON格式化</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.json.cn/<br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL特性矩阵\"><a href=\"#PostgreSQL特性矩阵\" class=\"headerlink\" title=\"PostgreSQL特性矩阵\"></a>PostgreSQL特性矩阵</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.postgresql.org<span class=\"hljs-regexp\">/about/</span>featurematrix/<br></code></pre></td></tr></table></figure>\n<h2 id=\"Converting-from-other-Databases-to-PostgreSQL\"><a href=\"#Converting-from-other-Databases-to-PostgreSQL\" class=\"headerlink\" title=\"Converting from other Databases to PostgreSQL\"></a>Converting from other Databases to PostgreSQL</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>wiki.postgresql.org<span class=\"hljs-regexp\">/wiki/</span>Converting_from_other_Databases_to_PostgreSQL<span class=\"hljs-comment\">#Utilities.2C_tools.2C_scripts_etc</span><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h2 id=\"gis教程\"><a href=\"#gis教程\" class=\"headerlink\" title=\"gis教程\"></a>gis教程</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.zhihu.com<span class=\"hljs-regexp\">/column/</span>c_1253365661696491520<br></code></pre></td></tr></table></figure>\n<h2 id=\"刑法准则\"><a href=\"#刑法准则\" class=\"headerlink\" title=\"刑法准则\"></a>刑法准则</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>www.npc.gov.cn<span class=\"hljs-regexp\">/wxzl/</span>wxzl<span class=\"hljs-regexp\">/2000-12/</span><span class=\"hljs-number\">17</span>/content_4680.htm<br></code></pre></td></tr></table></figure>\n<h2 id=\"各种数据库SQL标准实现对比\"><a href=\"#各种数据库SQL标准实现对比\" class=\"headerlink\" title=\"各种数据库SQL标准实现对比\"></a>各种数据库SQL标准实现对比</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.sql-workbench.eu/dbms_comparison.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL-RPMS\"><a href=\"#PostgreSQL-RPMS\" class=\"headerlink\" title=\"PostgreSQL RPMS\"></a>PostgreSQL RPMS</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//gi</span>thub.com<span class=\"hljs-regexp\">/cybertec-postgresql/</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL-MVCC\"><a href=\"#PostgreSQL-MVCC\" class=\"headerlink\" title=\"PostgreSQL MVCC\"></a>PostgreSQL MVCC</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>www.interdb.jp<span class=\"hljs-regexp\">/pg/</span>pgsql05.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"生成随即背景图片\"><a href=\"#生成随即背景图片\" class=\"headerlink\" title=\"生成随即背景图片\"></a>生成随即背景图片</h2><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\">http<span class=\"hljs-variable\">s:</span>//<span class=\"hljs-keyword\">source</span>.unsplash.<span class=\"hljs-keyword\">com</span>/<br></code></pre></td></tr></table></figure>\n<h2 id=\"SQL格式化\"><a href=\"#SQL格式化\" class=\"headerlink\" title=\"SQL格式化\"></a>SQL格式化</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span>sqlformat.darold.net/<br></code></pre></td></tr></table></figure>","more":"<h2 id=\"PG11中文手册\"><a href=\"#PG11中文手册\" class=\"headerlink\" title=\"PG11中文手册\"></a>PG11中文手册</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.docs4dev.com<span class=\"hljs-regexp\">/docs/</span>zh<span class=\"hljs-regexp\">/postgre-sql/</span><span class=\"hljs-number\">11.2</span><span class=\"hljs-regexp\">/reference/</span>release-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">2</span>.html<br></code></pre></td></tr></table></figure>\n<h2 id=\"JSON格式化\"><a href=\"#JSON格式化\" class=\"headerlink\" title=\"JSON格式化\"></a>JSON格式化</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.json.cn/<br></code></pre></td></tr></table></figure>\n<h2 id=\"PostgreSQL特性矩阵\"><a href=\"#PostgreSQL特性矩阵\" class=\"headerlink\" title=\"PostgreSQL特性矩阵\"></a>PostgreSQL特性矩阵</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.postgresql.org<span class=\"hljs-regexp\">/about/</span>featurematrix/<br></code></pre></td></tr></table></figure>\n<h2 id=\"Converting-from-other-Databases-to-PostgreSQL\"><a href=\"#Converting-from-other-Databases-to-PostgreSQL\" class=\"headerlink\" title=\"Converting from other Databases to PostgreSQL\"></a>Converting from other Databases to PostgreSQL</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>wiki.postgresql.org<span class=\"hljs-regexp\">/wiki/</span>Converting_from_other_Databases_to_PostgreSQL<span class=\"hljs-comment\">#Utilities.2C_tools.2C_scripts_etc</span><br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL 缓冲区管理","date":"2020-08-20T03:21:12.000Z","top":20,"description":null,"password":null,"_content":"\n缓冲区管理器管理共享内存和持久性存储之间的数据传输，并且可能对DBMS的性能产生重大影响。 PostgreSQL缓冲区管理器非常高效。\n在本章中，将介绍PostgreSQL缓冲区管理器。第一部分提供了概述，随后的部分描述了以下主题：\n- Buffer manager structure\n- Buffer manager locks\n- How the buffer manager works\n- Ring buffer\n- Flushing of dirty pages\n<!-- more -->\n![Relations between buffer manager, storage, and backend processes.](/images/pg_buffer_manager.png?150x100)\n\n# Overview\n本节介绍了有助于在后续各节中进行描述的关键概念。\n\n## Buffer Manager Structure\nPostgreSQL缓冲区管理器包含一个缓冲区表，缓冲区描述符和缓冲池，这将在下一节中介绍。缓冲池层存储数据文件页面，例如表和索引，以及自由空间映射和可见性映射。缓冲池是一个数组，即每个插槽存储一个数据文件的一页。缓冲池阵列的索引称为buffer_id。\n\n## Buffer Tag\n在PostgreSQL中，每一个数据文件的每一个页面分配了一个唯一的标签，即buffer tag。当缓冲区管理器收到请求时，PostgreSQL会使用目标页面的buffer_tag\n\nbuffer_tag包含三个值：其页面所属relation的RelFileNode和fork number，以及其页面的块编号。表，空闲空间映射和可见性映射的派生编号分别在0、1和2中定义。\n\n例如，buffer_tag'{（16821，16384，37721），0，7}' 表示这个页面位于relation中数据页面的第七块页面，relation的OID和派生编号分别为37721和0；在OID为16821的表空间下，其OID为16384的数据库中。\n类似地，buffer_tag'{（16821，16384，37721），1，3}' 表示这个页面位于relation中的freespace map页面第三个页面，relation的OID和派生编号分别为37721和1; 在OID为16821的表空间下，其OID为16384的数据库中。\n\n## How a Backend Process Reads Pages\n本小节描述了后端进程如何从缓冲区管理器读取页面\n![How a backend reads a page from the buffer manager..](/images/pg_buffer_manager_2.png)\n\n- 读取表或索引页时，后端进程会将包含页面的buffer_tag的请求发送到缓冲区管理器.\n- 缓冲区管理器返回存储请求页面的插槽的buffer_ID。如果请求的页面未存储在缓冲池中，则缓冲管理器将页面从持久性存储加载到缓冲池插槽之一，然后返回buffer_ID的插槽\n- 后端进程访问buffer_ID的插槽（以读取所需的页面\n\n当后端进程修改缓冲池中的页面（例如，通过插入元组）时，尚未刷新到存储的修改后的页面称为脏页面。\n\n## Page Replacement Algorithm\n当所有缓冲池插槽均被占用但未存储请求的页面时，缓冲管理器必须在缓冲池中选择一个页面，该页面将由请求的页面替换。通常，在计算机科学领域中，页面选择算法称为页面替换算法，而所选页面称为受害者页面\n自计算机科学问世以来，一直在进行页面替换算法的研究。因此，先前已经提出了许多替换算法。从8.1版开始，PostgreSQL使用了clock-sweep，因为它比以前版本中使用的LRU算法更简单，更高效。\n4.4节详细介绍了时钟扫描\n\n## Flushing Dirty Pages\n脏页最终应刷新到存储中；但是，缓冲区管理器需要帮助才能执行此任务。在PostgreSQL中，两个后台进程（checkpointer和background writer）负责此任务。\n\n第6节介绍了checkpointer和background writer\n\n**Direct I/O**\nPostgreSQL不支持direct I/O，尽管已经讨论过了。如果您想了解更多详细信息，请参考[pgsql-ML](https://www.postgresql.org/message-id/529E267F.4050700@agliodbs.com)和这篇[文章](https://lwn.net/Articles/580542/)。\n\n# Buffer Manager Structure\nPostgreSQL缓冲区管理器包括三层，即缓冲区表(buffer table)，缓冲区描述符(buffer descriptors)和缓冲池(buffer pool)\n\n![Fig. 8.3. Buffer manager's three-layer structure.](/images/pg_buffer_manager_3.png)\n\n- 缓冲池是一个数组。每个插槽存储一个数据文件页面。阵列插槽的索引称为bufferids \n- 缓冲区描述符层是缓冲区描述符的数组。每个描述符与缓冲池插槽一一对应，并在相应的插槽中保存存储页面的元数据。\n\n   ---\n   **Note**\n\n   为方便起见，采用术语“缓冲区描述符层”，并且仅在本文档中使用。\n\n   ---\n\n- 缓冲区表是一个哈希表，用于存储存储页的buffer_tags与保存存储页各自元数据的描述符的buffer_id之间的关系。\n\n这些层将在以下章节中详细介绍\n\n## Buffer Table\n\n缓冲区表在逻辑上可以分为三个部分：哈希函数(a hash function)，哈希存储桶插槽(hash bucket slots)和数据条目(data entries) (Fig. 8.4)\n内置的哈希函数将buffer_tags映射到哈希存储桶插槽。由于哈希桶插槽的数量大于缓冲池插槽的数量，会发生冲突。因此，缓冲区表使用单独的链表链接方法来解决冲突。当数据条目(data entries)映射到相同的存储桶插槽(bucket slot)时，此方法将条目存储在相同的链表中，如图8.4所示。\n\n![Fig. 8.4. Buffer table.](/images/pg_buffer_manager_4.png)\n\n数据条目包含两个值：页面的buffer_tag和保存页面元数据的描述符的buffer_id。例如，数据条目'Tag_A，id = 1'表示具有buffer_id 1的缓冲区描述符存储带有Tag_A标签的页面的元数据。\n\n**Hash function**\n哈希函数是calc_bucket()和hash()的复合函数。以下是其作为伪函数的表示。\n```\nuint32 bucket_slot = calc_bucket(unsigned hash(BufferTag buffer_tag), uint32 bucket_size)\n```\n\n---\n\nNOTE\n\n基本操作（查找，插入和删除数据条目）在此不作解释。这些是非常常见的操作，将在以下各节中进行说明。\n\n---\n\n## Buffer Descriptor\n\n缓冲区描述符的结构在本小节中描述，缓冲区描述符层在下一个小节中\n\n缓冲区描述符将存储的页面的元数据保存在相应的缓冲池插槽中。缓冲区描述符结构由结构BufferDesc定义。虽然此结构有很多字段，但主要显示在以下字段中：\n\n- tag 将存储页面的buffer_tag保存在相应的缓冲池插槽中（缓冲区标记在第1.2节中定义）\n- buffer_id 标识描述符（等效于相应缓冲池插槽的buffer_id）\n- refcount 保存当前正在访问关联的存储页面的PostgreSQL进程数。也称为引脚数(pin count)。 PostgreSQL进程访问存储的页面时，其引用计数必须增加1（refcount ++）。访问该页面后，其引用计数必须减少1（refcount--）。\n    当refcount为零时，即当前未访问关联的存储页面，则该页面被取消固定(unpinned)；否则将其固定(pinned.)。\n- usage_count 保存关联的存储页面自加载到相应的缓冲池插槽以来已被访问的次数。注意在页面替换算法(page replacement algorithm)中使用了usage_count (Section 4.4).\n- context_lock和io_in_progress_lock是轻量级锁，用于控制对关联的存储页面的访问。这些字段在第3.2节中描述。\n- flags 保存关联的存储页面的几种状态。主要状态如下:\n    - dirty bit 指示存储的页面是否脏.\n    - valid bit 指示是否可以读取或写入存储的页面（有效）。例如，如果该位有效，则相应的缓冲池插槽将存储一个页面，并且此描述符（有效位）将保存页面元数据；因此，可以读取或写入存储的页面。如果该位无效，则此描述符不包含任何元数据；这意味着无法读取或写入存储的页面，或者缓冲区管理器正在替换存储的页面。\n    - io_in_progress bit 指示缓冲区管理器是否正在从存储中读取/写入关联页面。换句话说，该位指示单个进程是否持有此描述符的\n- freeNext 指向下一个描述符以生成空闲列表的指针，这将在下一个小节中进行描述。\n\n---\n**NOTE**\n\n结构 BufferDesc 定义在 src/include/storage/buf_internals.h.\n\n---\n\nTo simplify the following descriptions, three descriptor states are defined:\n\nEmpty: When the corresponding buffer pool slot does not store a page (i.e. refcount and usage_count are 0), the state of this descriptor is empty.\nPinned: When the corresponding buffer pool slot stores a page and any PostgreSQL processes are accessing the page (i.e. refcount and usage_count are greater than or equal to 1), the state of this buffer descriptor is pinned.\nUnpinned: When the corresponding buffer pool slot stores a page but no PostgreSQL processes are accessing the page (i.e. usage_count is greater than or equal to 1, but refcount is 0), the state of this buffer descriptor is unpinned.\n\nEach descriptor will have one of the above states. The descriptor state changes relative to particular conditions, which are described in the next subsection.\n\nIn the following figures, buffer descriptors’ states are represented by coloured boxes.\n\n(white) Empty\n(blue) Pinned\n(aqua blue) Unpinned\n\nIn addition, a dirty page is denoted as ‘X’. For example, an unpinned dirty descriptor is represented by  X .\n\n## Buffer Descriptors Layer\nA collection of buffer descriptors forms an array. In this document, the array is referred to as the buffer descriptors layer.\n\nWhen the PostgreSQL server starts, the state of all buffer descriptors is empty. In PostgreSQL, those descriptors comprise a linked list called freelist (Fig. 8.5).\n\n![Fig. 8.5. Buffer manager initial state.](/images/pg_buffer_manager_5.png)\n\n---\n**NOTE*\n\nPlease note that the freelist in PostgreSQL is completely different concept from the freelists in Oracle. PostgreSQL's freelist is only linked list of empty buffer descriptors. In PostgreSQL freespace maps, which are described in Section 5.3.4, act as the same role of the freelists in Oracle. \n\n---\n\nFigure 8.6 shows that how the first page is loaded.\n\n- Retrieve an empty descriptor from the top of the freelist, and pin it (i.e. increase its refcount and usage_count by 1).\n- Insert the new entry, which holds the relation between the tag of the first page and the buffer_id of the retrieved descriptor, in the buffer table.\n- Load the new page from storage to the corresponding buffer pool slot.\n- Save the metadata of the new page to the retrieved descriptor.\n\nThe second and subsequent pages are loaded in a similar manner. Additional details are provided in Section 8.4.2.\n\n![Fig. 8.6. Loading the first page.](/images/pg_buffer_manager_6.png)\n\nDescriptors that have been retrieved from the freelist always hold page's metadata. In other words, non-empty descriptors continue to be used do not return to the freelist. However, related descriptors are added to the freelist again and the descriptor state becomes ‘empty’ when one of the following occurs:\n\n- Tables or indexes have been dropped.\n- Databases have been dropped.\n- Tables or indexes have been cleaned up using the VACUUM FULL command.\n\n---\n**Why empty descriptors comprise the freelist?**\n\nThe reason why the freelist be made is to get the first descriptor immediately. This is a usual practice for dynamic memory resource allocation. Refer to this description. \n\n---\n\nThe buffer descriptors layer contains an unsigned 32-bit integer variable, i.e. nextVictimBuffer. This variable is used in the page replacement algorithm described in Section 8.4.4.\n\n## Buffer Pool\n\nThe buffer pool is a simple array that stores data file pages, such as tables and indexes. Indices of the buffer pool array are referred to as buffer_ids.\n\nThe buffer pool slot size is 8 KB, which is equal to the size of a page. Thus, each slot can store an entire page.\n\n\n# Buffer Manager Locks\nThe buffer manager uses many locks for many different purposes. This section describes the locks necessary for the explanations in the subsequent sections.\n\n\n---\n**NOTE**\n\nPlease note that the locks described in this section are parts of a synchronization mechanism for the buffer manager; they do not relate to any SQL statements and SQL options. \n\n---\n\n## Buffer Table Locks\n\nBufMappingLock protects the data integrity of the entire buffer table. It is a light-weight lock that can be used in both shared and exclusive modes. When searching an entry in the buffer table, a backend process holds a shared BufMappingLock. When inserting or deleting entries, a backend process holds an exclusive lock.\n\nThe BufMappingLock is split into partitions to reduce the contention in the buffer table (the default is 128 partitions). Each BufMappingLock partition guards the portion of the corresponding hash bucket slots.\n\nFigure 8.7 shows a typical example of the effect of splitting BufMappingLock. Two backend processes can simultaneously hold respective BufMappingLock partitions in exclusive mode in order to insert new data entries. If the BufMappingLock is a single system-wide lock, both processes should wait for the processing of another process, depending on which started processing.\n\n\n![Two processes simultaneously acquire the respective partitions of BufMappingLock in exclusive mode to insert new data entries.](/images/pg_buffer_manager_7.png)\n\nThe buffer table requires many other locks. For example, the buffer table internally uses a spin lock to delete an entry. However, descriptions of these other locks are omitted because they are not required in this document.\n\n---\n**NOTE**\n\nThe BufMappingLock had been split into 16 separate locks by default until version 9.4.\n\n---\n\n## Locks for Each Buffer Descriptor\nEach buffer descriptor uses two light-weight locks, content_lock and io_in_progress_lock, to control access to the stored page in the corresponding buffer pool slot. When the values of own fields are checked or changed, a spinlock is used. \n\n### content_lock\n\n\nThe content_lock is a typical lock that enforces access limits. It can be used in shared and exclusive modes.\n\nWhen reading a page, a backend process acquires a shared content_lock of the buffer descriptor that stores the page.\n\nHowever, an exclusive content_lock is acquired when doing one of the following:\n\n- Inserting rows (i.e. tuples) into the stored page or changing the t_xmin/t_xmax fields of tuples within the stored page (t_xmin and t_xmax are described in Section 5.2; simply, when deleting or updating rows, these fields of the associated tuples are changed).\n- Removing tuples physically or compacting free space on the stored page (performed by vacuum processing and HOT, which are described in Chapters 6 and 7, respectively).\n- Freezing tuples within the stored page (freezing is described in Section 5.10.1 and Section 6.3).\n\nThe official [README](https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README) file shows more details.\n\n### io_in_progress_lock\nThe io_in_progress lock is used to wait for I/O on a buffer to complete. When a PostgreSQL process loads/writes page data from/to storage, the process holds an exclusive io_in_progress lock of the corresponding descriptor while accessing the storage.\n\n### spinlock\nWhen the flags or other fields (e.g. refcount and usage_count) are checked or changed, a spinlock is used. Two specific examples of spinlock usage are given below:\n\n- The following shows how to pin the buffer descriptor:\n  - Acquire a spinlock of the buffer descriptor.\n  - Increase the values of its refcount and usage_count by 1.\n  - Release the spinlock.\n  ```\n    LockBufHdr(bufferdesc);    /* Acquire a spinlock */\n    bufferdesc->refcont++;\n    bufferdesc->usage_count++;\n    UnlockBufHdr(bufferdesc); /* Release the spinlock */\n  ```\n- The following shows how to set the dirty bit to '1': \n  - Acquire a spinlock of the buffer descriptor. \n  - Set the dirty bit to '1' using a bitwise operation.\n  - Release the spinlock.\n  ```\n    #define BM_DIRTY             (1 << 0)    /* data needs writing */\n    #define BM_VALID             (1 << 1)    /* data is valid */\n    #define BM_TAG_VALID         (1 << 2)    /* tag is assigned */\n    #define BM_IO_IN_PROGRESS    (1 << 3)    /* read or write in progress */\n    #define BM_JUST_DIRTIED      (1 << 5)    /* dirtied since write started */\n\n    LockBufHdr(bufferdesc);\n    bufferdesc->flags |= BM_DIRTY;\n    UnlockBufHdr(bufferdesc);\n  ```\n\nChanging other bits is performed in the same manner. \n\n---\n**NOTE**\n\nIn version 9.6, the spinlocks of buffer manager will be replaced to atomic operations. See this result of [commitfest](https://commitfest.postgresql.org/9/408/). If you want to know the details, refer to this [discussion](https://www.postgresql.org/message-id/flat/2400449.GjM57CE0Yg@dinodell#2400449.GjM57CE0Yg@dinodell). \n\n---\n\n# How the Buffer Manager Works\n\nThis section describes how the buffer manager works. When a backend process wants to access a desired page, it calls the ReadBufferExtended function.\n\nThe behavior of the ReadBufferExtended function depends on three logical cases. Each case is described in the following subsections. In addition, the PostgreSQL clock sweep page replacement algorithm is described in the final subsection.\n\n## Accessing a Page Stored in the Buffer Pool\nFirst, the simplest case is described, i.e. the desired page is already stored in the buffer pool. In this case, the buffer manager performs the following steps:\n\n- Create the buffer_tag of the desired page (in this example, the buffer_tag is 'Tag_C') and compute the hash bucket slot, which contains the associated entry of the created buffer_tag, using the hash function.\n- Acquire the BufMappingLock partition that covers the obtained hash bucket slot in shared mode (this lock will be released in step (5)).\n- Look up the entry whose tag is 'Tag_C' and obtain the buffer_id from the entry. In this example, the buffer_id is 2.\n- Pin the buffer descriptor for buffer_id 2, i.e. the refcount and usage_count of the descriptor are increased by 1 ( Section 8.3.2 describes pinning).\n- Release the BufMappingLock.\n- Access the buffer pool slot with buffer_id 2.\n\n![Fig. 8.8. Accessing a page stored in the buffer pool.](/images/pg_buffer_manager_8.png)\n\nThen, when reading rows from the page in the buffer pool slot, the PostgreSQL process acquires the shared content_lock of the corresponding buffer descriptor. Thus, buffer pool slots can be read by multiple processes simultaneously.\n\nWhen inserting (and updating or deleting) rows to the page, a Postgres process acquires the exclusive content_lock of the corresponding buffer descriptor (note that the dirty bit of the page must be set to '1').\n\nAfter accessing the pages, the refcount values of the corresponding buffer descriptors are decreased by 1.\n\n## Loading a Page from Storage to Empty Slot\nIn this second case, assume that the desired page is not in the buffer pool and the freelist has free elements (empty descriptors). In this case, the buffer manager performs the following steps:\n\n- Look up the buffer table (we assume it is not found).\n- Create the buffer_tag of the desired page (in this example, the buffer_tag is 'Tag_E') and compute the hash bucket slot.\n- Acquire the BufMappingLock partition in shared mode.\n  - Look up the buffer table (not found according to the assumption).\n  - Release the BufMappingLock.\n- Obtain the empty buffer descriptor from the freelist, and pin it. In this example, the buffer_id of the obtained descriptor is 4.\n- Acquire the BufMappingLock partition in exclusive mode (this lock will be released in step (6)).\n- Create a new data entry that comprises the buffer_tag 'Tag_E' and buffer_id 4; insert the created entry to the buffer table.\n- Load the desired page data from storage to the buffer pool slot with buffer_id 4 as follows:\n- Acquire the exclusive io_in_progress_lock of the corresponding descriptor.\n  - Set the io_in_progress bit of the corresponding descriptor to '1 to prevent access by other processes.\n  - Load the desired page data from storage to the buffer pool slot.\n  - Change the states of the corresponding descriptor; the io_in_progress bit is set to '0', and the valid bit is set to '1'.\n  - Release the io_in_progress_lock.\n- Release the BufMappingLock.\n- Access the buffer pool slot with buffer_id 4.\n\n![Fig. 8.9. Loading a page from storage to an empty slot.](/images/pg_buffer_manager_9.png)\n\n## Loading a Page from Storage to a Victim Buffer Pool Slot\nIn this case, assume that all buffer pool slots are occupied by pages but the desired page is not stored. The buffer manager performs the following steps:\n\n- Create the buffer_tag of the desired page and look up the buffer table. In this example, we assume that the buffer_tag is 'Tag_M' (the desired page is not found).\n- Select a victim buffer pool slot using the clock-sweep algorithm, obtain the old entry, which contains the buffer_id of the victim pool slot, from the buffer table and pin the victim pool slot in the buffer descriptors layer. In this example, the buffer_id of the victim slot is 5 and the old entry is ‘Tag_F, id=5’. The clock sweep is described in the next subsection.\n- Flush (write and fsync) the victim page data if it is dirty; otherwise proceed to step (4).\n   The dirty page must be written to storage before overwriting with new data. Flushing a dirty page is performed as follows:\n   - Acquire the shared content_lock and the exclusive io_in_progress lock of the descriptor with buffer_id 5 (released in step 6).\n   - Change the states of the corresponding descriptor; the io_in_progress bit is set to '1' and the just_dirtied bit is set to '0'.\n   - Depending on the situation, the XLogFlush() function is invoked to write WAL data on the WAL buffer to the current WAL segment file (details are omitted; WAL and the XLogFlush function are described in Chapter 9).\n   - Flush the victim page data to storage.\n   - Change the states of the corresponding descriptor; the io_in_progress bit is set to '0' and the valid bit is set to '1'.\n   - Release the io_in_progress and content_lock locks.\n- Acquire the old BufMappingLock partition that covers the slot that contains the old entry, in exclusive mode.\n- Acquire the new BufMappingLock partition and insert the new entry to the buffer table:\n   - Create the new entry comprised of the new buffer_tag 'Tag_M' and the victim's buffer_id.\n   - Acquire the new BufMappingLock partition that covers the slot containing the new entry in exclusive mode.\n   - Insert the new entry to the buffer table.\n- Delete the old entry from the buffer table, and release the old BufMappingLock partition.\n- Load the desired page data from the storage to the victim buffer slot. Then, update the flags of the descriptor with buffer_id 5; the dirty bit is set to '0 and initialize other bits.\n- Release the new BufMappingLock partition.\n- Access the buffer pool slot with buffer_id 5.\n\n![Fig. 8.10. Loading a page from storage to a victim buffer pool slot.](/images/pg_buffer_manager_10.png)\n\n## Page Replacement Algorithm: Clock Sweep\nThe rest of this section describes the clock-sweep algorithm. This algorithm is a variant of NFU (Not Frequently Used) with low overhead; it selects less frequently used pages efficiently.\n\nImagine buffer descriptors as a circular list (Fig. 8.12). The nextVictimBuffer, an unsigned 32-bit integer, is always pointing to one of the buffer descriptors and rotates clockwise. The pseudocode and description of the algorithm are follows: \n\n---\n**Pseudocode: clock-sweep**\n\n```\n     WHILE true\n(1)     Obtain the candidate buffer descriptor pointed by the nextVictimBuffer\n(2)     IF the candidate descriptor is unpinned THEN\n(3)\t       IF the candidate descriptor's usage_count == 0 THEN\n\t            BREAK WHILE LOOP  /* the corresponding slot of this descriptor is victim slot. */\n\t       ELSE\n\t\t    Decrease the candidate descriptpor's usage_count by 1\n               END IF\n         END IF\n(4)     Advance nextVictimBuffer to the next one\n      END WHILE \n(5) RETURN buffer_id of the victim\n```\n---\n\nA specific example is shown in Fig. 8.12. The buffer descriptors are shown as blue or cyan boxes, and the numbers in the boxes show the usage_count of each descriptor. \n\n# Ring Buffer\n\nWhen reading or writing a huge table, PostgreSQL uses a ring buffer rather than the buffer pool. The ring buffer is a small and temporary buffer area. When any condition listed below is met, a ring buffer is allocated to shared memory:\n\n- Bulk-reading\nWhen a relation whose size exceeds one-quarter of the buffer pool size (shared_buffers/4) is scanned. In this case, the ring buffer size is 256 KB.\n- Bulk-writing\nWhen the SQL commands listed below are executed. In this case, the ring buffer size is 16 MB.\n  - COPY FROM command.\n  - CREATE TABLE AS command.\n  - CREATE MATERIALIZED VIEW or REFRESH MATERIALIZED VIEW command.\n  - ALTER TABLE command.\n- Vacuum-processing\nWhen an autovacuum performs a vacuum processing. In this case, the ring buffer size is 256 KB.\n\nThe allocated ring buffer is released immediately after use.\n\nThe benefit of the ring buffer is obvious. If a backend process reads a huge table without using a ring buffer, all stored pages in the buffer pool are removed (kicked out); therefore, the cache hit ratio decreases. The ring buffer avoids this issue. \n\n---\n**Why the default ring buffer size for bulk-reading and vacuum processing is 256 KB?**\n\nWhy 256 KB? The answer is explained in the [README](https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README) located under the buffer manager's source directory. \n  For sequential scans, a 256 KB ring is used. That's small enough to fit in L2 cache, which makes transferring pages from OS cache to shared buffer cache efficient. Even less would often be enough, but the ring must be big enough to accommodate all pages in the scan that are pinned concurrently. (snip) \n\n---\n\n# Flushing Dirty Pages\nIn addition to replacing victim pages, the checkpointer and background writer processes flush dirty pages to storage. Both processes have the same function (flushing dirty pages); however, they have different roles and behaviours.\n\nThe checkpointer process writes a checkpoint record to the WAL segment file and flushes dirty pages whenever checkpointing starts. Section 9.7 describes checkpointing and when it begins.\n\nThe role of the background writer is to reduce the influence of the intensive writing of checkpointing. The background writer continues to flush dirty pages little by little with minimal impact on database activity. By default, the background writer wakes every 200 msec (defined by bgwriter_delay) and flushes bgwriter_lru_maxpages (the default is 100 pages) at maximum. \n\n---\n\n**为什么要从background writer分离出checkpointer?**\n\n在9.1或更早版本中，background writer定期执行checkpoint处理。在版本9.2中，checkpointer进程已与background writer进程分离。在[\"Separating bgwriter and checkpointer\"](https://www.postgresql.org/message-id/CA%2BU5nMLv2ah-HNHaQ%3D2rxhp_hDJ9jcf-LL2kW3sE4msfnUw9gA%40mail.gmail.com) 提案中描述了原因。\n\n```\nCurrently(in 2011) the bgwriter process performs both background writing, checkpointing and some other duties. This means that we can't perform the final checkpoint fsync without stopping background writing, so there is a negative performance effect from doing both things in one process.\nAdditionally, our aim in 9.2 is to replace polling loops with latches for power reduction. The complexity of the bgwriter loops is high and it seems unlikely to come up with a clean approach using latches.\n```\n---\n\n","source":"_posts/PostgreSQL_Buffer_Manager.md","raw":"---\ntitle: PostgreSQL 缓冲区管理 \ndate: 2020-08-20 11:21:12\ntags: \n- PostgreSQL\n- buffer\ncategories: \n- PostgreSQL\ntop: 20\ndescription: \npassword: \n\n---\n\n缓冲区管理器管理共享内存和持久性存储之间的数据传输，并且可能对DBMS的性能产生重大影响。 PostgreSQL缓冲区管理器非常高效。\n在本章中，将介绍PostgreSQL缓冲区管理器。第一部分提供了概述，随后的部分描述了以下主题：\n- Buffer manager structure\n- Buffer manager locks\n- How the buffer manager works\n- Ring buffer\n- Flushing of dirty pages\n<!-- more -->\n![Relations between buffer manager, storage, and backend processes.](/images/pg_buffer_manager.png?150x100)\n\n# Overview\n本节介绍了有助于在后续各节中进行描述的关键概念。\n\n## Buffer Manager Structure\nPostgreSQL缓冲区管理器包含一个缓冲区表，缓冲区描述符和缓冲池，这将在下一节中介绍。缓冲池层存储数据文件页面，例如表和索引，以及自由空间映射和可见性映射。缓冲池是一个数组，即每个插槽存储一个数据文件的一页。缓冲池阵列的索引称为buffer_id。\n\n## Buffer Tag\n在PostgreSQL中，每一个数据文件的每一个页面分配了一个唯一的标签，即buffer tag。当缓冲区管理器收到请求时，PostgreSQL会使用目标页面的buffer_tag\n\nbuffer_tag包含三个值：其页面所属relation的RelFileNode和fork number，以及其页面的块编号。表，空闲空间映射和可见性映射的派生编号分别在0、1和2中定义。\n\n例如，buffer_tag'{（16821，16384，37721），0，7}' 表示这个页面位于relation中数据页面的第七块页面，relation的OID和派生编号分别为37721和0；在OID为16821的表空间下，其OID为16384的数据库中。\n类似地，buffer_tag'{（16821，16384，37721），1，3}' 表示这个页面位于relation中的freespace map页面第三个页面，relation的OID和派生编号分别为37721和1; 在OID为16821的表空间下，其OID为16384的数据库中。\n\n## How a Backend Process Reads Pages\n本小节描述了后端进程如何从缓冲区管理器读取页面\n![How a backend reads a page from the buffer manager..](/images/pg_buffer_manager_2.png)\n\n- 读取表或索引页时，后端进程会将包含页面的buffer_tag的请求发送到缓冲区管理器.\n- 缓冲区管理器返回存储请求页面的插槽的buffer_ID。如果请求的页面未存储在缓冲池中，则缓冲管理器将页面从持久性存储加载到缓冲池插槽之一，然后返回buffer_ID的插槽\n- 后端进程访问buffer_ID的插槽（以读取所需的页面\n\n当后端进程修改缓冲池中的页面（例如，通过插入元组）时，尚未刷新到存储的修改后的页面称为脏页面。\n\n## Page Replacement Algorithm\n当所有缓冲池插槽均被占用但未存储请求的页面时，缓冲管理器必须在缓冲池中选择一个页面，该页面将由请求的页面替换。通常，在计算机科学领域中，页面选择算法称为页面替换算法，而所选页面称为受害者页面\n自计算机科学问世以来，一直在进行页面替换算法的研究。因此，先前已经提出了许多替换算法。从8.1版开始，PostgreSQL使用了clock-sweep，因为它比以前版本中使用的LRU算法更简单，更高效。\n4.4节详细介绍了时钟扫描\n\n## Flushing Dirty Pages\n脏页最终应刷新到存储中；但是，缓冲区管理器需要帮助才能执行此任务。在PostgreSQL中，两个后台进程（checkpointer和background writer）负责此任务。\n\n第6节介绍了checkpointer和background writer\n\n**Direct I/O**\nPostgreSQL不支持direct I/O，尽管已经讨论过了。如果您想了解更多详细信息，请参考[pgsql-ML](https://www.postgresql.org/message-id/529E267F.4050700@agliodbs.com)和这篇[文章](https://lwn.net/Articles/580542/)。\n\n# Buffer Manager Structure\nPostgreSQL缓冲区管理器包括三层，即缓冲区表(buffer table)，缓冲区描述符(buffer descriptors)和缓冲池(buffer pool)\n\n![Fig. 8.3. Buffer manager's three-layer structure.](/images/pg_buffer_manager_3.png)\n\n- 缓冲池是一个数组。每个插槽存储一个数据文件页面。阵列插槽的索引称为bufferids \n- 缓冲区描述符层是缓冲区描述符的数组。每个描述符与缓冲池插槽一一对应，并在相应的插槽中保存存储页面的元数据。\n\n   ---\n   **Note**\n\n   为方便起见，采用术语“缓冲区描述符层”，并且仅在本文档中使用。\n\n   ---\n\n- 缓冲区表是一个哈希表，用于存储存储页的buffer_tags与保存存储页各自元数据的描述符的buffer_id之间的关系。\n\n这些层将在以下章节中详细介绍\n\n## Buffer Table\n\n缓冲区表在逻辑上可以分为三个部分：哈希函数(a hash function)，哈希存储桶插槽(hash bucket slots)和数据条目(data entries) (Fig. 8.4)\n内置的哈希函数将buffer_tags映射到哈希存储桶插槽。由于哈希桶插槽的数量大于缓冲池插槽的数量，会发生冲突。因此，缓冲区表使用单独的链表链接方法来解决冲突。当数据条目(data entries)映射到相同的存储桶插槽(bucket slot)时，此方法将条目存储在相同的链表中，如图8.4所示。\n\n![Fig. 8.4. Buffer table.](/images/pg_buffer_manager_4.png)\n\n数据条目包含两个值：页面的buffer_tag和保存页面元数据的描述符的buffer_id。例如，数据条目'Tag_A，id = 1'表示具有buffer_id 1的缓冲区描述符存储带有Tag_A标签的页面的元数据。\n\n**Hash function**\n哈希函数是calc_bucket()和hash()的复合函数。以下是其作为伪函数的表示。\n```\nuint32 bucket_slot = calc_bucket(unsigned hash(BufferTag buffer_tag), uint32 bucket_size)\n```\n\n---\n\nNOTE\n\n基本操作（查找，插入和删除数据条目）在此不作解释。这些是非常常见的操作，将在以下各节中进行说明。\n\n---\n\n## Buffer Descriptor\n\n缓冲区描述符的结构在本小节中描述，缓冲区描述符层在下一个小节中\n\n缓冲区描述符将存储的页面的元数据保存在相应的缓冲池插槽中。缓冲区描述符结构由结构BufferDesc定义。虽然此结构有很多字段，但主要显示在以下字段中：\n\n- tag 将存储页面的buffer_tag保存在相应的缓冲池插槽中（缓冲区标记在第1.2节中定义）\n- buffer_id 标识描述符（等效于相应缓冲池插槽的buffer_id）\n- refcount 保存当前正在访问关联的存储页面的PostgreSQL进程数。也称为引脚数(pin count)。 PostgreSQL进程访问存储的页面时，其引用计数必须增加1（refcount ++）。访问该页面后，其引用计数必须减少1（refcount--）。\n    当refcount为零时，即当前未访问关联的存储页面，则该页面被取消固定(unpinned)；否则将其固定(pinned.)。\n- usage_count 保存关联的存储页面自加载到相应的缓冲池插槽以来已被访问的次数。注意在页面替换算法(page replacement algorithm)中使用了usage_count (Section 4.4).\n- context_lock和io_in_progress_lock是轻量级锁，用于控制对关联的存储页面的访问。这些字段在第3.2节中描述。\n- flags 保存关联的存储页面的几种状态。主要状态如下:\n    - dirty bit 指示存储的页面是否脏.\n    - valid bit 指示是否可以读取或写入存储的页面（有效）。例如，如果该位有效，则相应的缓冲池插槽将存储一个页面，并且此描述符（有效位）将保存页面元数据；因此，可以读取或写入存储的页面。如果该位无效，则此描述符不包含任何元数据；这意味着无法读取或写入存储的页面，或者缓冲区管理器正在替换存储的页面。\n    - io_in_progress bit 指示缓冲区管理器是否正在从存储中读取/写入关联页面。换句话说，该位指示单个进程是否持有此描述符的\n- freeNext 指向下一个描述符以生成空闲列表的指针，这将在下一个小节中进行描述。\n\n---\n**NOTE**\n\n结构 BufferDesc 定义在 src/include/storage/buf_internals.h.\n\n---\n\nTo simplify the following descriptions, three descriptor states are defined:\n\nEmpty: When the corresponding buffer pool slot does not store a page (i.e. refcount and usage_count are 0), the state of this descriptor is empty.\nPinned: When the corresponding buffer pool slot stores a page and any PostgreSQL processes are accessing the page (i.e. refcount and usage_count are greater than or equal to 1), the state of this buffer descriptor is pinned.\nUnpinned: When the corresponding buffer pool slot stores a page but no PostgreSQL processes are accessing the page (i.e. usage_count is greater than or equal to 1, but refcount is 0), the state of this buffer descriptor is unpinned.\n\nEach descriptor will have one of the above states. The descriptor state changes relative to particular conditions, which are described in the next subsection.\n\nIn the following figures, buffer descriptors’ states are represented by coloured boxes.\n\n(white) Empty\n(blue) Pinned\n(aqua blue) Unpinned\n\nIn addition, a dirty page is denoted as ‘X’. For example, an unpinned dirty descriptor is represented by  X .\n\n## Buffer Descriptors Layer\nA collection of buffer descriptors forms an array. In this document, the array is referred to as the buffer descriptors layer.\n\nWhen the PostgreSQL server starts, the state of all buffer descriptors is empty. In PostgreSQL, those descriptors comprise a linked list called freelist (Fig. 8.5).\n\n![Fig. 8.5. Buffer manager initial state.](/images/pg_buffer_manager_5.png)\n\n---\n**NOTE*\n\nPlease note that the freelist in PostgreSQL is completely different concept from the freelists in Oracle. PostgreSQL's freelist is only linked list of empty buffer descriptors. In PostgreSQL freespace maps, which are described in Section 5.3.4, act as the same role of the freelists in Oracle. \n\n---\n\nFigure 8.6 shows that how the first page is loaded.\n\n- Retrieve an empty descriptor from the top of the freelist, and pin it (i.e. increase its refcount and usage_count by 1).\n- Insert the new entry, which holds the relation between the tag of the first page and the buffer_id of the retrieved descriptor, in the buffer table.\n- Load the new page from storage to the corresponding buffer pool slot.\n- Save the metadata of the new page to the retrieved descriptor.\n\nThe second and subsequent pages are loaded in a similar manner. Additional details are provided in Section 8.4.2.\n\n![Fig. 8.6. Loading the first page.](/images/pg_buffer_manager_6.png)\n\nDescriptors that have been retrieved from the freelist always hold page's metadata. In other words, non-empty descriptors continue to be used do not return to the freelist. However, related descriptors are added to the freelist again and the descriptor state becomes ‘empty’ when one of the following occurs:\n\n- Tables or indexes have been dropped.\n- Databases have been dropped.\n- Tables or indexes have been cleaned up using the VACUUM FULL command.\n\n---\n**Why empty descriptors comprise the freelist?**\n\nThe reason why the freelist be made is to get the first descriptor immediately. This is a usual practice for dynamic memory resource allocation. Refer to this description. \n\n---\n\nThe buffer descriptors layer contains an unsigned 32-bit integer variable, i.e. nextVictimBuffer. This variable is used in the page replacement algorithm described in Section 8.4.4.\n\n## Buffer Pool\n\nThe buffer pool is a simple array that stores data file pages, such as tables and indexes. Indices of the buffer pool array are referred to as buffer_ids.\n\nThe buffer pool slot size is 8 KB, which is equal to the size of a page. Thus, each slot can store an entire page.\n\n\n# Buffer Manager Locks\nThe buffer manager uses many locks for many different purposes. This section describes the locks necessary for the explanations in the subsequent sections.\n\n\n---\n**NOTE**\n\nPlease note that the locks described in this section are parts of a synchronization mechanism for the buffer manager; they do not relate to any SQL statements and SQL options. \n\n---\n\n## Buffer Table Locks\n\nBufMappingLock protects the data integrity of the entire buffer table. It is a light-weight lock that can be used in both shared and exclusive modes. When searching an entry in the buffer table, a backend process holds a shared BufMappingLock. When inserting or deleting entries, a backend process holds an exclusive lock.\n\nThe BufMappingLock is split into partitions to reduce the contention in the buffer table (the default is 128 partitions). Each BufMappingLock partition guards the portion of the corresponding hash bucket slots.\n\nFigure 8.7 shows a typical example of the effect of splitting BufMappingLock. Two backend processes can simultaneously hold respective BufMappingLock partitions in exclusive mode in order to insert new data entries. If the BufMappingLock is a single system-wide lock, both processes should wait for the processing of another process, depending on which started processing.\n\n\n![Two processes simultaneously acquire the respective partitions of BufMappingLock in exclusive mode to insert new data entries.](/images/pg_buffer_manager_7.png)\n\nThe buffer table requires many other locks. For example, the buffer table internally uses a spin lock to delete an entry. However, descriptions of these other locks are omitted because they are not required in this document.\n\n---\n**NOTE**\n\nThe BufMappingLock had been split into 16 separate locks by default until version 9.4.\n\n---\n\n## Locks for Each Buffer Descriptor\nEach buffer descriptor uses two light-weight locks, content_lock and io_in_progress_lock, to control access to the stored page in the corresponding buffer pool slot. When the values of own fields are checked or changed, a spinlock is used. \n\n### content_lock\n\n\nThe content_lock is a typical lock that enforces access limits. It can be used in shared and exclusive modes.\n\nWhen reading a page, a backend process acquires a shared content_lock of the buffer descriptor that stores the page.\n\nHowever, an exclusive content_lock is acquired when doing one of the following:\n\n- Inserting rows (i.e. tuples) into the stored page or changing the t_xmin/t_xmax fields of tuples within the stored page (t_xmin and t_xmax are described in Section 5.2; simply, when deleting or updating rows, these fields of the associated tuples are changed).\n- Removing tuples physically or compacting free space on the stored page (performed by vacuum processing and HOT, which are described in Chapters 6 and 7, respectively).\n- Freezing tuples within the stored page (freezing is described in Section 5.10.1 and Section 6.3).\n\nThe official [README](https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README) file shows more details.\n\n### io_in_progress_lock\nThe io_in_progress lock is used to wait for I/O on a buffer to complete. When a PostgreSQL process loads/writes page data from/to storage, the process holds an exclusive io_in_progress lock of the corresponding descriptor while accessing the storage.\n\n### spinlock\nWhen the flags or other fields (e.g. refcount and usage_count) are checked or changed, a spinlock is used. Two specific examples of spinlock usage are given below:\n\n- The following shows how to pin the buffer descriptor:\n  - Acquire a spinlock of the buffer descriptor.\n  - Increase the values of its refcount and usage_count by 1.\n  - Release the spinlock.\n  ```\n    LockBufHdr(bufferdesc);    /* Acquire a spinlock */\n    bufferdesc->refcont++;\n    bufferdesc->usage_count++;\n    UnlockBufHdr(bufferdesc); /* Release the spinlock */\n  ```\n- The following shows how to set the dirty bit to '1': \n  - Acquire a spinlock of the buffer descriptor. \n  - Set the dirty bit to '1' using a bitwise operation.\n  - Release the spinlock.\n  ```\n    #define BM_DIRTY             (1 << 0)    /* data needs writing */\n    #define BM_VALID             (1 << 1)    /* data is valid */\n    #define BM_TAG_VALID         (1 << 2)    /* tag is assigned */\n    #define BM_IO_IN_PROGRESS    (1 << 3)    /* read or write in progress */\n    #define BM_JUST_DIRTIED      (1 << 5)    /* dirtied since write started */\n\n    LockBufHdr(bufferdesc);\n    bufferdesc->flags |= BM_DIRTY;\n    UnlockBufHdr(bufferdesc);\n  ```\n\nChanging other bits is performed in the same manner. \n\n---\n**NOTE**\n\nIn version 9.6, the spinlocks of buffer manager will be replaced to atomic operations. See this result of [commitfest](https://commitfest.postgresql.org/9/408/). If you want to know the details, refer to this [discussion](https://www.postgresql.org/message-id/flat/2400449.GjM57CE0Yg@dinodell#2400449.GjM57CE0Yg@dinodell). \n\n---\n\n# How the Buffer Manager Works\n\nThis section describes how the buffer manager works. When a backend process wants to access a desired page, it calls the ReadBufferExtended function.\n\nThe behavior of the ReadBufferExtended function depends on three logical cases. Each case is described in the following subsections. In addition, the PostgreSQL clock sweep page replacement algorithm is described in the final subsection.\n\n## Accessing a Page Stored in the Buffer Pool\nFirst, the simplest case is described, i.e. the desired page is already stored in the buffer pool. In this case, the buffer manager performs the following steps:\n\n- Create the buffer_tag of the desired page (in this example, the buffer_tag is 'Tag_C') and compute the hash bucket slot, which contains the associated entry of the created buffer_tag, using the hash function.\n- Acquire the BufMappingLock partition that covers the obtained hash bucket slot in shared mode (this lock will be released in step (5)).\n- Look up the entry whose tag is 'Tag_C' and obtain the buffer_id from the entry. In this example, the buffer_id is 2.\n- Pin the buffer descriptor for buffer_id 2, i.e. the refcount and usage_count of the descriptor are increased by 1 ( Section 8.3.2 describes pinning).\n- Release the BufMappingLock.\n- Access the buffer pool slot with buffer_id 2.\n\n![Fig. 8.8. Accessing a page stored in the buffer pool.](/images/pg_buffer_manager_8.png)\n\nThen, when reading rows from the page in the buffer pool slot, the PostgreSQL process acquires the shared content_lock of the corresponding buffer descriptor. Thus, buffer pool slots can be read by multiple processes simultaneously.\n\nWhen inserting (and updating or deleting) rows to the page, a Postgres process acquires the exclusive content_lock of the corresponding buffer descriptor (note that the dirty bit of the page must be set to '1').\n\nAfter accessing the pages, the refcount values of the corresponding buffer descriptors are decreased by 1.\n\n## Loading a Page from Storage to Empty Slot\nIn this second case, assume that the desired page is not in the buffer pool and the freelist has free elements (empty descriptors). In this case, the buffer manager performs the following steps:\n\n- Look up the buffer table (we assume it is not found).\n- Create the buffer_tag of the desired page (in this example, the buffer_tag is 'Tag_E') and compute the hash bucket slot.\n- Acquire the BufMappingLock partition in shared mode.\n  - Look up the buffer table (not found according to the assumption).\n  - Release the BufMappingLock.\n- Obtain the empty buffer descriptor from the freelist, and pin it. In this example, the buffer_id of the obtained descriptor is 4.\n- Acquire the BufMappingLock partition in exclusive mode (this lock will be released in step (6)).\n- Create a new data entry that comprises the buffer_tag 'Tag_E' and buffer_id 4; insert the created entry to the buffer table.\n- Load the desired page data from storage to the buffer pool slot with buffer_id 4 as follows:\n- Acquire the exclusive io_in_progress_lock of the corresponding descriptor.\n  - Set the io_in_progress bit of the corresponding descriptor to '1 to prevent access by other processes.\n  - Load the desired page data from storage to the buffer pool slot.\n  - Change the states of the corresponding descriptor; the io_in_progress bit is set to '0', and the valid bit is set to '1'.\n  - Release the io_in_progress_lock.\n- Release the BufMappingLock.\n- Access the buffer pool slot with buffer_id 4.\n\n![Fig. 8.9. Loading a page from storage to an empty slot.](/images/pg_buffer_manager_9.png)\n\n## Loading a Page from Storage to a Victim Buffer Pool Slot\nIn this case, assume that all buffer pool slots are occupied by pages but the desired page is not stored. The buffer manager performs the following steps:\n\n- Create the buffer_tag of the desired page and look up the buffer table. In this example, we assume that the buffer_tag is 'Tag_M' (the desired page is not found).\n- Select a victim buffer pool slot using the clock-sweep algorithm, obtain the old entry, which contains the buffer_id of the victim pool slot, from the buffer table and pin the victim pool slot in the buffer descriptors layer. In this example, the buffer_id of the victim slot is 5 and the old entry is ‘Tag_F, id=5’. The clock sweep is described in the next subsection.\n- Flush (write and fsync) the victim page data if it is dirty; otherwise proceed to step (4).\n   The dirty page must be written to storage before overwriting with new data. Flushing a dirty page is performed as follows:\n   - Acquire the shared content_lock and the exclusive io_in_progress lock of the descriptor with buffer_id 5 (released in step 6).\n   - Change the states of the corresponding descriptor; the io_in_progress bit is set to '1' and the just_dirtied bit is set to '0'.\n   - Depending on the situation, the XLogFlush() function is invoked to write WAL data on the WAL buffer to the current WAL segment file (details are omitted; WAL and the XLogFlush function are described in Chapter 9).\n   - Flush the victim page data to storage.\n   - Change the states of the corresponding descriptor; the io_in_progress bit is set to '0' and the valid bit is set to '1'.\n   - Release the io_in_progress and content_lock locks.\n- Acquire the old BufMappingLock partition that covers the slot that contains the old entry, in exclusive mode.\n- Acquire the new BufMappingLock partition and insert the new entry to the buffer table:\n   - Create the new entry comprised of the new buffer_tag 'Tag_M' and the victim's buffer_id.\n   - Acquire the new BufMappingLock partition that covers the slot containing the new entry in exclusive mode.\n   - Insert the new entry to the buffer table.\n- Delete the old entry from the buffer table, and release the old BufMappingLock partition.\n- Load the desired page data from the storage to the victim buffer slot. Then, update the flags of the descriptor with buffer_id 5; the dirty bit is set to '0 and initialize other bits.\n- Release the new BufMappingLock partition.\n- Access the buffer pool slot with buffer_id 5.\n\n![Fig. 8.10. Loading a page from storage to a victim buffer pool slot.](/images/pg_buffer_manager_10.png)\n\n## Page Replacement Algorithm: Clock Sweep\nThe rest of this section describes the clock-sweep algorithm. This algorithm is a variant of NFU (Not Frequently Used) with low overhead; it selects less frequently used pages efficiently.\n\nImagine buffer descriptors as a circular list (Fig. 8.12). The nextVictimBuffer, an unsigned 32-bit integer, is always pointing to one of the buffer descriptors and rotates clockwise. The pseudocode and description of the algorithm are follows: \n\n---\n**Pseudocode: clock-sweep**\n\n```\n     WHILE true\n(1)     Obtain the candidate buffer descriptor pointed by the nextVictimBuffer\n(2)     IF the candidate descriptor is unpinned THEN\n(3)\t       IF the candidate descriptor's usage_count == 0 THEN\n\t            BREAK WHILE LOOP  /* the corresponding slot of this descriptor is victim slot. */\n\t       ELSE\n\t\t    Decrease the candidate descriptpor's usage_count by 1\n               END IF\n         END IF\n(4)     Advance nextVictimBuffer to the next one\n      END WHILE \n(5) RETURN buffer_id of the victim\n```\n---\n\nA specific example is shown in Fig. 8.12. The buffer descriptors are shown as blue or cyan boxes, and the numbers in the boxes show the usage_count of each descriptor. \n\n# Ring Buffer\n\nWhen reading or writing a huge table, PostgreSQL uses a ring buffer rather than the buffer pool. The ring buffer is a small and temporary buffer area. When any condition listed below is met, a ring buffer is allocated to shared memory:\n\n- Bulk-reading\nWhen a relation whose size exceeds one-quarter of the buffer pool size (shared_buffers/4) is scanned. In this case, the ring buffer size is 256 KB.\n- Bulk-writing\nWhen the SQL commands listed below are executed. In this case, the ring buffer size is 16 MB.\n  - COPY FROM command.\n  - CREATE TABLE AS command.\n  - CREATE MATERIALIZED VIEW or REFRESH MATERIALIZED VIEW command.\n  - ALTER TABLE command.\n- Vacuum-processing\nWhen an autovacuum performs a vacuum processing. In this case, the ring buffer size is 256 KB.\n\nThe allocated ring buffer is released immediately after use.\n\nThe benefit of the ring buffer is obvious. If a backend process reads a huge table without using a ring buffer, all stored pages in the buffer pool are removed (kicked out); therefore, the cache hit ratio decreases. The ring buffer avoids this issue. \n\n---\n**Why the default ring buffer size for bulk-reading and vacuum processing is 256 KB?**\n\nWhy 256 KB? The answer is explained in the [README](https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README) located under the buffer manager's source directory. \n  For sequential scans, a 256 KB ring is used. That's small enough to fit in L2 cache, which makes transferring pages from OS cache to shared buffer cache efficient. Even less would often be enough, but the ring must be big enough to accommodate all pages in the scan that are pinned concurrently. (snip) \n\n---\n\n# Flushing Dirty Pages\nIn addition to replacing victim pages, the checkpointer and background writer processes flush dirty pages to storage. Both processes have the same function (flushing dirty pages); however, they have different roles and behaviours.\n\nThe checkpointer process writes a checkpoint record to the WAL segment file and flushes dirty pages whenever checkpointing starts. Section 9.7 describes checkpointing and when it begins.\n\nThe role of the background writer is to reduce the influence of the intensive writing of checkpointing. The background writer continues to flush dirty pages little by little with minimal impact on database activity. By default, the background writer wakes every 200 msec (defined by bgwriter_delay) and flushes bgwriter_lru_maxpages (the default is 100 pages) at maximum. \n\n---\n\n**为什么要从background writer分离出checkpointer?**\n\n在9.1或更早版本中，background writer定期执行checkpoint处理。在版本9.2中，checkpointer进程已与background writer进程分离。在[\"Separating bgwriter and checkpointer\"](https://www.postgresql.org/message-id/CA%2BU5nMLv2ah-HNHaQ%3D2rxhp_hDJ9jcf-LL2kW3sE4msfnUw9gA%40mail.gmail.com) 提案中描述了原因。\n\n```\nCurrently(in 2011) the bgwriter process performs both background writing, checkpointing and some other duties. This means that we can't perform the final checkpoint fsync without stopping background writing, so there is a negative performance effect from doing both things in one process.\nAdditionally, our aim in 9.2 is to replace polling loops with latches for power reduction. The complexity of the bgwriter loops is high and it seems unlikely to come up with a clean approach using latches.\n```\n---\n\n","slug":"PostgreSQL_Buffer_Manager","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzj7002qpiebg9tm6le3","content":"<p>缓冲区管理器管理共享内存和持久性存储之间的数据传输，并且可能对DBMS的性能产生重大影响。 PostgreSQL缓冲区管理器非常高效。<br>在本章中，将介绍PostgreSQL缓冲区管理器。第一部分提供了概述，随后的部分描述了以下主题：</p>\n<ul>\n<li>Buffer manager structure</li>\n<li>Buffer manager locks</li>\n<li>How the buffer manager works</li>\n<li>Ring buffer</li>\n<li>Flushing of dirty pages<a id=\"more\"></a>\n<img data-src=\"/images/pg_buffer_manager.png?150x100\" alt=\"Relations between buffer manager, storage, and backend processes.\"></li>\n</ul>\n<h1 id=\"Overview\"><a href=\"#Overview\" class=\"headerlink\" title=\"Overview\"></a>Overview</h1><p>本节介绍了有助于在后续各节中进行描述的关键概念。</p>\n<h2 id=\"Buffer-Manager-Structure\"><a href=\"#Buffer-Manager-Structure\" class=\"headerlink\" title=\"Buffer Manager Structure\"></a>Buffer Manager Structure</h2><p>PostgreSQL缓冲区管理器包含一个缓冲区表，缓冲区描述符和缓冲池，这将在下一节中介绍。缓冲池层存储数据文件页面，例如表和索引，以及自由空间映射和可见性映射。缓冲池是一个数组，即每个插槽存储一个数据文件的一页。缓冲池阵列的索引称为buffer_id。</p>\n<h2 id=\"Buffer-Tag\"><a href=\"#Buffer-Tag\" class=\"headerlink\" title=\"Buffer Tag\"></a>Buffer Tag</h2><p>在PostgreSQL中，每一个数据文件的每一个页面分配了一个唯一的标签，即buffer tag。当缓冲区管理器收到请求时，PostgreSQL会使用目标页面的buffer_tag</p>\n<p>buffer_tag包含三个值：其页面所属relation的RelFileNode和fork number，以及其页面的块编号。表，空闲空间映射和可见性映射的派生编号分别在0、1和2中定义。</p>\n<p>例如，buffer_tag’{（16821，16384，37721），0，7}’ 表示这个页面位于relation中数据页面的第七块页面，relation的OID和派生编号分别为37721和0；在OID为16821的表空间下，其OID为16384的数据库中。<br>类似地，buffer_tag’{（16821，16384，37721），1，3}’ 表示这个页面位于relation中的freespace map页面第三个页面，relation的OID和派生编号分别为37721和1; 在OID为16821的表空间下，其OID为16384的数据库中。</p>\n<h2 id=\"How-a-Backend-Process-Reads-Pages\"><a href=\"#How-a-Backend-Process-Reads-Pages\" class=\"headerlink\" title=\"How a Backend Process Reads Pages\"></a>How a Backend Process Reads Pages</h2><p>本小节描述了后端进程如何从缓冲区管理器读取页面<br><img data-src=\"/images/pg_buffer_manager_2.png\" alt=\"How a backend reads a page from the buffer manager..\"></p>\n<ul>\n<li>读取表或索引页时，后端进程会将包含页面的buffer_tag的请求发送到缓冲区管理器.</li>\n<li>缓冲区管理器返回存储请求页面的插槽的buffer_ID。如果请求的页面未存储在缓冲池中，则缓冲管理器将页面从持久性存储加载到缓冲池插槽之一，然后返回buffer_ID的插槽</li>\n<li>后端进程访问buffer_ID的插槽（以读取所需的页面</li>\n</ul>\n<p>当后端进程修改缓冲池中的页面（例如，通过插入元组）时，尚未刷新到存储的修改后的页面称为脏页面。</p>\n<h2 id=\"Page-Replacement-Algorithm\"><a href=\"#Page-Replacement-Algorithm\" class=\"headerlink\" title=\"Page Replacement Algorithm\"></a>Page Replacement Algorithm</h2><p>当所有缓冲池插槽均被占用但未存储请求的页面时，缓冲管理器必须在缓冲池中选择一个页面，该页面将由请求的页面替换。通常，在计算机科学领域中，页面选择算法称为页面替换算法，而所选页面称为受害者页面<br>自计算机科学问世以来，一直在进行页面替换算法的研究。因此，先前已经提出了许多替换算法。从8.1版开始，PostgreSQL使用了clock-sweep，因为它比以前版本中使用的LRU算法更简单，更高效。<br>4.4节详细介绍了时钟扫描</p>\n<h2 id=\"Flushing-Dirty-Pages\"><a href=\"#Flushing-Dirty-Pages\" class=\"headerlink\" title=\"Flushing Dirty Pages\"></a>Flushing Dirty Pages</h2><p>脏页最终应刷新到存储中；但是，缓冲区管理器需要帮助才能执行此任务。在PostgreSQL中，两个后台进程（checkpointer和background writer）负责此任务。</p>\n<p>第6节介绍了checkpointer和background writer</p>\n<p><strong>Direct I/O</strong><br>PostgreSQL不支持direct I/O，尽管已经讨论过了。如果您想了解更多详细信息，请参考<a href=\"https://www.postgresql.org/message-id/529E267F.4050700@agliodbs.com\">pgsql-ML</a>和这篇<a href=\"https://lwn.net/Articles/580542/\">文章</a>。</p>\n<h1 id=\"Buffer-Manager-Structure-1\"><a href=\"#Buffer-Manager-Structure-1\" class=\"headerlink\" title=\"Buffer Manager Structure\"></a>Buffer Manager Structure</h1><p>PostgreSQL缓冲区管理器包括三层，即缓冲区表(buffer table)，缓冲区描述符(buffer descriptors)和缓冲池(buffer pool)</p>\n<p><img data-src=\"/images/pg_buffer_manager_3.png\" alt=\"Fig. 8.3. Buffer manager&#39;s three-layer structure.\"></p>\n<ul>\n<li>缓冲池是一个数组。每个插槽存储一个数据文件页面。阵列插槽的索引称为bufferids </li>\n<li><p>缓冲区描述符层是缓冲区描述符的数组。每个描述符与缓冲池插槽一一对应，并在相应的插槽中保存存储页面的元数据。</p>\n<hr>\n<p> <strong>Note</strong></p>\n<p> 为方便起见，采用术语“缓冲区描述符层”，并且仅在本文档中使用。</p>\n<hr>\n</li>\n<li><p>缓冲区表是一个哈希表，用于存储存储页的buffer_tags与保存存储页各自元数据的描述符的buffer_id之间的关系。</p>\n</li>\n</ul>\n<p>这些层将在以下章节中详细介绍</p>\n<h2 id=\"Buffer-Table\"><a href=\"#Buffer-Table\" class=\"headerlink\" title=\"Buffer Table\"></a>Buffer Table</h2><p>缓冲区表在逻辑上可以分为三个部分：哈希函数(a hash function)，哈希存储桶插槽(hash bucket slots)和数据条目(data entries) (Fig. 8.4)<br>内置的哈希函数将buffer_tags映射到哈希存储桶插槽。由于哈希桶插槽的数量大于缓冲池插槽的数量，会发生冲突。因此，缓冲区表使用单独的链表链接方法来解决冲突。当数据条目(data entries)映射到相同的存储桶插槽(bucket slot)时，此方法将条目存储在相同的链表中，如图8.4所示。</p>\n<p><img data-src=\"/images/pg_buffer_manager_4.png\" alt=\"Fig. 8.4. Buffer table.\"></p>\n<p>数据条目包含两个值：页面的buffer_tag和保存页面元数据的描述符的buffer_id。例如，数据条目’Tag_A，id = 1’表示具有buffer_id 1的缓冲区描述符存储带有Tag_A标签的页面的元数据。</p>\n<p><strong>Hash function</strong><br>哈希函数是calc_bucket()和hash()的复合函数。以下是其作为伪函数的表示。<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lisp\">uint32 bucket_slot = calc_bucket(<span class=\"hljs-name\">unsigned</span> hash(<span class=\"hljs-name\">BufferTag</span> buffer_tag), uint32 bucket_size)<br></code></pre></td></tr></table></figure></p>\n<hr>\n<p>NOTE</p>\n<p>基本操作（查找，插入和删除数据条目）在此不作解释。这些是非常常见的操作，将在以下各节中进行说明。</p>\n<hr>\n<h2 id=\"Buffer-Descriptor\"><a href=\"#Buffer-Descriptor\" class=\"headerlink\" title=\"Buffer Descriptor\"></a>Buffer Descriptor</h2><p>缓冲区描述符的结构在本小节中描述，缓冲区描述符层在下一个小节中</p>\n<p>缓冲区描述符将存储的页面的元数据保存在相应的缓冲池插槽中。缓冲区描述符结构由结构BufferDesc定义。虽然此结构有很多字段，但主要显示在以下字段中：</p>\n<ul>\n<li>tag 将存储页面的buffer_tag保存在相应的缓冲池插槽中（缓冲区标记在第1.2节中定义）</li>\n<li>buffer_id 标识描述符（等效于相应缓冲池插槽的buffer_id）</li>\n<li>refcount 保存当前正在访问关联的存储页面的PostgreSQL进程数。也称为引脚数(pin count)。 PostgreSQL进程访问存储的页面时，其引用计数必须增加1（refcount ++）。访问该页面后，其引用计数必须减少1（refcount—）。<br>  当refcount为零时，即当前未访问关联的存储页面，则该页面被取消固定(unpinned)；否则将其固定(pinned.)。</li>\n<li>usage_count 保存关联的存储页面自加载到相应的缓冲池插槽以来已被访问的次数。注意在页面替换算法(page replacement algorithm)中使用了usage_count (Section 4.4).</li>\n<li>context_lock和io_in_progress_lock是轻量级锁，用于控制对关联的存储页面的访问。这些字段在第3.2节中描述。</li>\n<li>flags 保存关联的存储页面的几种状态。主要状态如下:<ul>\n<li>dirty bit 指示存储的页面是否脏.</li>\n<li>valid bit 指示是否可以读取或写入存储的页面（有效）。例如，如果该位有效，则相应的缓冲池插槽将存储一个页面，并且此描述符（有效位）将保存页面元数据；因此，可以读取或写入存储的页面。如果该位无效，则此描述符不包含任何元数据；这意味着无法读取或写入存储的页面，或者缓冲区管理器正在替换存储的页面。</li>\n<li>io_in_progress bit 指示缓冲区管理器是否正在从存储中读取/写入关联页面。换句话说，该位指示单个进程是否持有此描述符的</li>\n</ul>\n</li>\n<li>freeNext 指向下一个描述符以生成空闲列表的指针，这将在下一个小节中进行描述。</li>\n</ul>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>结构 BufferDesc 定义在 src/include/storage/buf_internals.h.</p>\n<hr>\n<p>To simplify the following descriptions, three descriptor states are defined:</p>\n<p>Empty: When the corresponding buffer pool slot does not store a page (i.e. refcount and usage_count are 0), the state of this descriptor is empty.<br>Pinned: When the corresponding buffer pool slot stores a page and any PostgreSQL processes are accessing the page (i.e. refcount and usage_count are greater than or equal to 1), the state of this buffer descriptor is pinned.<br>Unpinned: When the corresponding buffer pool slot stores a page but no PostgreSQL processes are accessing the page (i.e. usage_count is greater than or equal to 1, but refcount is 0), the state of this buffer descriptor is unpinned.</p>\n<p>Each descriptor will have one of the above states. The descriptor state changes relative to particular conditions, which are described in the next subsection.</p>\n<p>In the following figures, buffer descriptors’ states are represented by coloured boxes.</p>\n<p>(white) Empty<br>(blue) Pinned<br>(aqua blue) Unpinned</p>\n<p>In addition, a dirty page is denoted as ‘X’. For example, an unpinned dirty descriptor is represented by  X .</p>\n<h2 id=\"Buffer-Descriptors-Layer\"><a href=\"#Buffer-Descriptors-Layer\" class=\"headerlink\" title=\"Buffer Descriptors Layer\"></a>Buffer Descriptors Layer</h2><p>A collection of buffer descriptors forms an array. In this document, the array is referred to as the buffer descriptors layer.</p>\n<p>When the PostgreSQL server starts, the state of all buffer descriptors is empty. In PostgreSQL, those descriptors comprise a linked list called freelist (Fig. 8.5).</p>\n<p><img data-src=\"/images/pg_buffer_manager_5.png\" alt=\"Fig. 8.5. Buffer manager initial state.\"></p>\n<hr>\n<p><em>*NOTE</em></p>\n<p>Please note that the freelist in PostgreSQL is completely different concept from the freelists in Oracle. PostgreSQL’s freelist is only linked list of empty buffer descriptors. In PostgreSQL freespace maps, which are described in Section 5.3.4, act as the same role of the freelists in Oracle. </p>\n<hr>\n<p>Figure 8.6 shows that how the first page is loaded.</p>\n<ul>\n<li>Retrieve an empty descriptor from the top of the freelist, and pin it (i.e. increase its refcount and usage_count by 1).</li>\n<li>Insert the new entry, which holds the relation between the tag of the first page and the buffer_id of the retrieved descriptor, in the buffer table.</li>\n<li>Load the new page from storage to the corresponding buffer pool slot.</li>\n<li>Save the metadata of the new page to the retrieved descriptor.</li>\n</ul>\n<p>The second and subsequent pages are loaded in a similar manner. Additional details are provided in Section 8.4.2.</p>\n<p><img data-src=\"/images/pg_buffer_manager_6.png\" alt=\"Fig. 8.6. Loading the first page.\"></p>\n<p>Descriptors that have been retrieved from the freelist always hold page’s metadata. In other words, non-empty descriptors continue to be used do not return to the freelist. However, related descriptors are added to the freelist again and the descriptor state becomes ‘empty’ when one of the following occurs:</p>\n<ul>\n<li>Tables or indexes have been dropped.</li>\n<li>Databases have been dropped.</li>\n<li>Tables or indexes have been cleaned up using the VACUUM FULL command.</li>\n</ul>\n<hr>\n<p><strong>Why empty descriptors comprise the freelist?</strong></p>\n<p>The reason why the freelist be made is to get the first descriptor immediately. This is a usual practice for dynamic memory resource allocation. Refer to this description. </p>\n<hr>\n<p>The buffer descriptors layer contains an unsigned 32-bit integer variable, i.e. nextVictimBuffer. This variable is used in the page replacement algorithm described in Section 8.4.4.</p>\n<h2 id=\"Buffer-Pool\"><a href=\"#Buffer-Pool\" class=\"headerlink\" title=\"Buffer Pool\"></a>Buffer Pool</h2><p>The buffer pool is a simple array that stores data file pages, such as tables and indexes. Indices of the buffer pool array are referred to as buffer_ids.</p>\n<p>The buffer pool slot size is 8 KB, which is equal to the size of a page. Thus, each slot can store an entire page.</p>\n<h1 id=\"Buffer-Manager-Locks\"><a href=\"#Buffer-Manager-Locks\" class=\"headerlink\" title=\"Buffer Manager Locks\"></a>Buffer Manager Locks</h1><p>The buffer manager uses many locks for many different purposes. This section describes the locks necessary for the explanations in the subsequent sections.</p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>Please note that the locks described in this section are parts of a synchronization mechanism for the buffer manager; they do not relate to any SQL statements and SQL options. </p>\n<hr>\n<h2 id=\"Buffer-Table-Locks\"><a href=\"#Buffer-Table-Locks\" class=\"headerlink\" title=\"Buffer Table Locks\"></a>Buffer Table Locks</h2><p>BufMappingLock protects the data integrity of the entire buffer table. It is a light-weight lock that can be used in both shared and exclusive modes. When searching an entry in the buffer table, a backend process holds a shared BufMappingLock. When inserting or deleting entries, a backend process holds an exclusive lock.</p>\n<p>The BufMappingLock is split into partitions to reduce the contention in the buffer table (the default is 128 partitions). Each BufMappingLock partition guards the portion of the corresponding hash bucket slots.</p>\n<p>Figure 8.7 shows a typical example of the effect of splitting BufMappingLock. Two backend processes can simultaneously hold respective BufMappingLock partitions in exclusive mode in order to insert new data entries. If the BufMappingLock is a single system-wide lock, both processes should wait for the processing of another process, depending on which started processing.</p>\n<p><img data-src=\"/images/pg_buffer_manager_7.png\" alt=\"Two processes simultaneously acquire the respective partitions of BufMappingLock in exclusive mode to insert new data entries.\"></p>\n<p>The buffer table requires many other locks. For example, the buffer table internally uses a spin lock to delete an entry. However, descriptions of these other locks are omitted because they are not required in this document.</p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>The BufMappingLock had been split into 16 separate locks by default until version 9.4.</p>\n<hr>\n<h2 id=\"Locks-for-Each-Buffer-Descriptor\"><a href=\"#Locks-for-Each-Buffer-Descriptor\" class=\"headerlink\" title=\"Locks for Each Buffer Descriptor\"></a>Locks for Each Buffer Descriptor</h2><p>Each buffer descriptor uses two light-weight locks, content_lock and io_in_progress_lock, to control access to the stored page in the corresponding buffer pool slot. When the values of own fields are checked or changed, a spinlock is used. </p>\n<h3 id=\"content-lock\"><a href=\"#content-lock\" class=\"headerlink\" title=\"content_lock\"></a>content_lock</h3><p>The content_lock is a typical lock that enforces access limits. It can be used in shared and exclusive modes.</p>\n<p>When reading a page, a backend process acquires a shared content_lock of the buffer descriptor that stores the page.</p>\n<p>However, an exclusive content_lock is acquired when doing one of the following:</p>\n<ul>\n<li>Inserting rows (i.e. tuples) into the stored page or changing the t_xmin/t_xmax fields of tuples within the stored page (t_xmin and t_xmax are described in Section 5.2; simply, when deleting or updating rows, these fields of the associated tuples are changed).</li>\n<li>Removing tuples physically or compacting free space on the stored page (performed by vacuum processing and HOT, which are described in Chapters 6 and 7, respectively).</li>\n<li>Freezing tuples within the stored page (freezing is described in Section 5.10.1 and Section 6.3).</li>\n</ul>\n<p>The official <a href=\"https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README\">README</a> file shows more details.</p>\n<h3 id=\"io-in-progress-lock\"><a href=\"#io-in-progress-lock\" class=\"headerlink\" title=\"io_in_progress_lock\"></a>io_in_progress_lock</h3><p>The io_in_progress lock is used to wait for I/O on a buffer to complete. When a PostgreSQL process loads/writes page data from/to storage, the process holds an exclusive io_in_progress lock of the corresponding descriptor while accessing the storage.</p>\n<h3 id=\"spinlock\"><a href=\"#spinlock\" class=\"headerlink\" title=\"spinlock\"></a>spinlock</h3><p>When the flags or other fields (e.g. refcount and usage_count) are checked or changed, a spinlock is used. Two specific examples of spinlock usage are given below:</p>\n<ul>\n<li>The following shows how to pin the buffer descriptor:<ul>\n<li>Acquire a spinlock of the buffer descriptor.</li>\n<li>Increase the values of its refcount and usage_count by 1.</li>\n<li>Release the spinlock.<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\">LockBufHdr(<span class=\"hljs-keyword\">bufferdesc); </span>   <span class=\"hljs-comment\">/* Acquire a spinlock */</span><br><span class=\"hljs-keyword\">bufferdesc-&gt;refcont++;</span><br><span class=\"hljs-keyword\">bufferdesc-&gt;usage_count++;</span><br><span class=\"hljs-keyword\">UnlockBufHdr(bufferdesc); </span><span class=\"hljs-comment\">/* Release the spinlock */</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>The following shows how to set the dirty bit to ‘1’: <ul>\n<li>Acquire a spinlock of the buffer descriptor. </li>\n<li>Set the dirty bit to ‘1’ using a bitwise operation.</li>\n<li>Release the spinlock.<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">#define BM_DIRTY             (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">0</span>)    <span class=\"hljs-comment\">/* data needs writing */</span><br>#define BM_VALID             (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">1</span>)    <span class=\"hljs-comment\">/* data is valid */</span><br>#define BM_TAG_VALID         (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">2</span>)    <span class=\"hljs-comment\">/* tag is assigned */</span><br>#define BM_IO_IN_PROGRESS    (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">3</span>)    <span class=\"hljs-comment\">/* read or write in progress */</span><br>#define BM_JUST_DIRTIED      (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">5</span>)    <span class=\"hljs-comment\">/* dirtied since write started */</span><br><br>LockBufHdr(bufferdesc);<br>bufferdesc-&gt;flags |= BM_DIRTY;<br>UnlockBufHdr(bufferdesc);<br></code></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p>Changing other bits is performed in the same manner. </p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>In version 9.6, the spinlocks of buffer manager will be replaced to atomic operations. See this result of <a href=\"https://commitfest.postgresql.org/9/408/\">commitfest</a>. If you want to know the details, refer to this <a href=\"https://www.postgresql.org/message-id/flat/2400449.GjM57CE0Yg@dinodell#2400449.GjM57CE0Yg@dinodell\">discussion</a>. </p>\n<hr>\n<h1 id=\"How-the-Buffer-Manager-Works\"><a href=\"#How-the-Buffer-Manager-Works\" class=\"headerlink\" title=\"How the Buffer Manager Works\"></a>How the Buffer Manager Works</h1><p>This section describes how the buffer manager works. When a backend process wants to access a desired page, it calls the ReadBufferExtended function.</p>\n<p>The behavior of the ReadBufferExtended function depends on three logical cases. Each case is described in the following subsections. In addition, the PostgreSQL clock sweep page replacement algorithm is described in the final subsection.</p>\n<h2 id=\"Accessing-a-Page-Stored-in-the-Buffer-Pool\"><a href=\"#Accessing-a-Page-Stored-in-the-Buffer-Pool\" class=\"headerlink\" title=\"Accessing a Page Stored in the Buffer Pool\"></a>Accessing a Page Stored in the Buffer Pool</h2><p>First, the simplest case is described, i.e. the desired page is already stored in the buffer pool. In this case, the buffer manager performs the following steps:</p>\n<ul>\n<li>Create the buffer_tag of the desired page (in this example, the buffer_tag is ‘Tag_C’) and compute the hash bucket slot, which contains the associated entry of the created buffer_tag, using the hash function.</li>\n<li>Acquire the BufMappingLock partition that covers the obtained hash bucket slot in shared mode (this lock will be released in step (5)).</li>\n<li>Look up the entry whose tag is ‘Tag_C’ and obtain the buffer_id from the entry. In this example, the buffer_id is 2.</li>\n<li>Pin the buffer descriptor for buffer_id 2, i.e. the refcount and usage_count of the descriptor are increased by 1 ( Section 8.3.2 describes pinning).</li>\n<li>Release the BufMappingLock.</li>\n<li>Access the buffer pool slot with buffer_id 2.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_8.png\" alt=\"Fig. 8.8. Accessing a page stored in the buffer pool.\"></p>\n<p>Then, when reading rows from the page in the buffer pool slot, the PostgreSQL process acquires the shared content_lock of the corresponding buffer descriptor. Thus, buffer pool slots can be read by multiple processes simultaneously.</p>\n<p>When inserting (and updating or deleting) rows to the page, a Postgres process acquires the exclusive content_lock of the corresponding buffer descriptor (note that the dirty bit of the page must be set to ‘1’).</p>\n<p>After accessing the pages, the refcount values of the corresponding buffer descriptors are decreased by 1.</p>\n<h2 id=\"Loading-a-Page-from-Storage-to-Empty-Slot\"><a href=\"#Loading-a-Page-from-Storage-to-Empty-Slot\" class=\"headerlink\" title=\"Loading a Page from Storage to Empty Slot\"></a>Loading a Page from Storage to Empty Slot</h2><p>In this second case, assume that the desired page is not in the buffer pool and the freelist has free elements (empty descriptors). In this case, the buffer manager performs the following steps:</p>\n<ul>\n<li>Look up the buffer table (we assume it is not found).</li>\n<li>Create the buffer_tag of the desired page (in this example, the buffer_tag is ‘Tag_E’) and compute the hash bucket slot.</li>\n<li>Acquire the BufMappingLock partition in shared mode.<ul>\n<li>Look up the buffer table (not found according to the assumption).</li>\n<li>Release the BufMappingLock.</li>\n</ul>\n</li>\n<li>Obtain the empty buffer descriptor from the freelist, and pin it. In this example, the buffer_id of the obtained descriptor is 4.</li>\n<li>Acquire the BufMappingLock partition in exclusive mode (this lock will be released in step (6)).</li>\n<li>Create a new data entry that comprises the buffer_tag ‘Tag_E’ and buffer_id 4; insert the created entry to the buffer table.</li>\n<li>Load the desired page data from storage to the buffer pool slot with buffer_id 4 as follows:</li>\n<li>Acquire the exclusive io_in_progress_lock of the corresponding descriptor.<ul>\n<li>Set the io_in_progress bit of the corresponding descriptor to ‘1 to prevent access by other processes.</li>\n<li>Load the desired page data from storage to the buffer pool slot.</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘0’, and the valid bit is set to ‘1’.</li>\n<li>Release the io_in_progress_lock.</li>\n</ul>\n</li>\n<li>Release the BufMappingLock.</li>\n<li>Access the buffer pool slot with buffer_id 4.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_9.png\" alt=\"Fig. 8.9. Loading a page from storage to an empty slot.\"></p>\n<h2 id=\"Loading-a-Page-from-Storage-to-a-Victim-Buffer-Pool-Slot\"><a href=\"#Loading-a-Page-from-Storage-to-a-Victim-Buffer-Pool-Slot\" class=\"headerlink\" title=\"Loading a Page from Storage to a Victim Buffer Pool Slot\"></a>Loading a Page from Storage to a Victim Buffer Pool Slot</h2><p>In this case, assume that all buffer pool slots are occupied by pages but the desired page is not stored. The buffer manager performs the following steps:</p>\n<ul>\n<li>Create the buffer_tag of the desired page and look up the buffer table. In this example, we assume that the buffer_tag is ‘Tag_M’ (the desired page is not found).</li>\n<li>Select a victim buffer pool slot using the clock-sweep algorithm, obtain the old entry, which contains the buffer_id of the victim pool slot, from the buffer table and pin the victim pool slot in the buffer descriptors layer. In this example, the buffer_id of the victim slot is 5 and the old entry is ‘Tag_F, id=5’. The clock sweep is described in the next subsection.</li>\n<li>Flush (write and fsync) the victim page data if it is dirty; otherwise proceed to step (4).<br> The dirty page must be written to storage before overwriting with new data. Flushing a dirty page is performed as follows:<ul>\n<li>Acquire the shared content_lock and the exclusive io_in_progress lock of the descriptor with buffer_id 5 (released in step 6).</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘1’ and the just_dirtied bit is set to ‘0’.</li>\n<li>Depending on the situation, the XLogFlush() function is invoked to write WAL data on the WAL buffer to the current WAL segment file (details are omitted; WAL and the XLogFlush function are described in Chapter 9).</li>\n<li>Flush the victim page data to storage.</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘0’ and the valid bit is set to ‘1’.</li>\n<li>Release the io_in_progress and content_lock locks.</li>\n</ul>\n</li>\n<li>Acquire the old BufMappingLock partition that covers the slot that contains the old entry, in exclusive mode.</li>\n<li>Acquire the new BufMappingLock partition and insert the new entry to the buffer table:<ul>\n<li>Create the new entry comprised of the new buffer_tag ‘Tag_M’ and the victim’s buffer_id.</li>\n<li>Acquire the new BufMappingLock partition that covers the slot containing the new entry in exclusive mode.</li>\n<li>Insert the new entry to the buffer table.</li>\n</ul>\n</li>\n<li>Delete the old entry from the buffer table, and release the old BufMappingLock partition.</li>\n<li>Load the desired page data from the storage to the victim buffer slot. Then, update the flags of the descriptor with buffer_id 5; the dirty bit is set to ‘0 and initialize other bits.</li>\n<li>Release the new BufMappingLock partition.</li>\n<li>Access the buffer pool slot with buffer_id 5.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_10.png\" alt=\"Fig. 8.10. Loading a page from storage to a victim buffer pool slot.\"></p>\n<h2 id=\"Page-Replacement-Algorithm-Clock-Sweep\"><a href=\"#Page-Replacement-Algorithm-Clock-Sweep\" class=\"headerlink\" title=\"Page Replacement Algorithm: Clock Sweep\"></a>Page Replacement Algorithm: Clock Sweep</h2><p>The rest of this section describes the clock-sweep algorithm. This algorithm is a variant of NFU (Not Frequently Used) with low overhead; it selects less frequently used pages efficiently.</p>\n<p>Imagine buffer descriptors as a circular list (Fig. 8.12). The nextVictimBuffer, an unsigned 32-bit integer, is always pointing to one of the buffer descriptors and rotates clockwise. The pseudocode and description of the algorithm are follows: </p>\n<hr>\n<p><strong>Pseudocode: clock-sweep</strong></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vhdl\">     <span class=\"hljs-keyword\">WHILE</span> <span class=\"hljs-literal\">true</span><br>(<span class=\"hljs-number\">1</span>)     Obtain the candidate <span class=\"hljs-keyword\">buffer</span> descriptor pointed by the nextVictimBuffer<br>(<span class=\"hljs-number\">2</span>)     <span class=\"hljs-keyword\">IF</span> the candidate descriptor <span class=\"hljs-keyword\">is</span> unpinned <span class=\"hljs-keyword\">THEN</span><br>(<span class=\"hljs-number\">3</span>)           <span class=\"hljs-keyword\">IF</span> the candidate descriptor<span class=\"hljs-symbol\">&#x27;s</span> usage_count == <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span><br>                BREAK <span class=\"hljs-keyword\">WHILE</span> <span class=\"hljs-keyword\">LOOP</span>  <span class=\"hljs-comment\">/* the corresponding slot of this descriptor is victim slot. */</span><br>           <span class=\"hljs-keyword\">ELSE</span><br>            Decrease the candidate descriptpor<span class=\"hljs-symbol\">&#x27;s</span> usage_count by <span class=\"hljs-number\">1</span><br>               <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span><br>         <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span><br>(<span class=\"hljs-number\">4</span>)     Advance nextVictimBuffer <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">next</span> one<br>      <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">WHILE</span> <br>(<span class=\"hljs-number\">5</span>) <span class=\"hljs-keyword\">RETURN</span> buffer_id <span class=\"hljs-keyword\">of</span> the victim<br></code></pre></td></tr></table></figure></h2><p>A specific example is shown in Fig. 8.12. The buffer descriptors are shown as blue or cyan boxes, and the numbers in the boxes show the usage_count of each descriptor. </p>\n<h1 id=\"Ring-Buffer\"><a href=\"#Ring-Buffer\" class=\"headerlink\" title=\"Ring Buffer\"></a>Ring Buffer</h1><p>When reading or writing a huge table, PostgreSQL uses a ring buffer rather than the buffer pool. The ring buffer is a small and temporary buffer area. When any condition listed below is met, a ring buffer is allocated to shared memory:</p>\n<ul>\n<li>Bulk-reading<br>When a relation whose size exceeds one-quarter of the buffer pool size (shared_buffers/4) is scanned. In this case, the ring buffer size is 256 KB.</li>\n<li>Bulk-writing<br>When the SQL commands listed below are executed. In this case, the ring buffer size is 16 MB.<ul>\n<li>COPY FROM command.</li>\n<li>CREATE TABLE AS command.</li>\n<li>CREATE MATERIALIZED VIEW or REFRESH MATERIALIZED VIEW command.</li>\n<li>ALTER TABLE command.</li>\n</ul>\n</li>\n<li>Vacuum-processing<br>When an autovacuum performs a vacuum processing. In this case, the ring buffer size is 256 KB.</li>\n</ul>\n<p>The allocated ring buffer is released immediately after use.</p>\n<p>The benefit of the ring buffer is obvious. If a backend process reads a huge table without using a ring buffer, all stored pages in the buffer pool are removed (kicked out); therefore, the cache hit ratio decreases. The ring buffer avoids this issue. </p>\n<hr>\n<p><strong>Why the default ring buffer size for bulk-reading and vacuum processing is 256 KB?</strong></p>\n<p>Why 256 KB? The answer is explained in the <a href=\"https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README\">README</a> located under the buffer manager’s source directory.<br>  For sequential scans, a 256 KB ring is used. That’s small enough to fit in L2 cache, which makes transferring pages from OS cache to shared buffer cache efficient. Even less would often be enough, but the ring must be big enough to accommodate all pages in the scan that are pinned concurrently. (snip) </p>\n<hr>\n<h1 id=\"Flushing-Dirty-Pages-1\"><a href=\"#Flushing-Dirty-Pages-1\" class=\"headerlink\" title=\"Flushing Dirty Pages\"></a>Flushing Dirty Pages</h1><p>In addition to replacing victim pages, the checkpointer and background writer processes flush dirty pages to storage. Both processes have the same function (flushing dirty pages); however, they have different roles and behaviours.</p>\n<p>The checkpointer process writes a checkpoint record to the WAL segment file and flushes dirty pages whenever checkpointing starts. Section 9.7 describes checkpointing and when it begins.</p>\n<p>The role of the background writer is to reduce the influence of the intensive writing of checkpointing. The background writer continues to flush dirty pages little by little with minimal impact on database activity. By default, the background writer wakes every 200 msec (defined by bgwriter_delay) and flushes bgwriter_lru_maxpages (the default is 100 pages) at maximum. </p>\n<hr>\n<p><strong>为什么要从background writer分离出checkpointer?</strong></p>\n<p>在9.1或更早版本中，background writer定期执行checkpoint处理。在版本9.2中，checkpointer进程已与background writer进程分离。在<a href=\"https://www.postgresql.org/message-id/CA%2BU5nMLv2ah-HNHaQ%3D2rxhp_hDJ9jcf-LL2kW3sE4msfnUw9gA%40mail.gmail.com\">“Separating bgwriter and checkpointer”</a> 提案中描述了原因。</p>\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">Currently(<span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">2011</span>) <span class=\"hljs-keyword\">the</span> bgwriter process performs both background writing, checkpointing <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">some</span> other duties. This means <span class=\"hljs-keyword\">that</span> we can&#x27;t perform <span class=\"hljs-keyword\">the</span> final checkpoint fsync <span class=\"hljs-keyword\">without</span> stopping background writing, so there <span class=\"hljs-keyword\">is</span> a negative performance effect <span class=\"hljs-keyword\">from</span> doing both things <span class=\"hljs-keyword\">in</span> one process.<br>Additionally, our aim <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">9.2</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">to</span> replace polling loops <span class=\"hljs-keyword\">with</span> latches <span class=\"hljs-keyword\">for</span> power reduction. The complexity <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> bgwriter loops <span class=\"hljs-keyword\">is</span> high <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">it</span> seems unlikely <span class=\"hljs-keyword\">to</span> come up <span class=\"hljs-keyword\">with</span> a clean approach using latches.<br></code></pre></td></tr></table></figure></h2>","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<p>缓冲区管理器管理共享内存和持久性存储之间的数据传输，并且可能对DBMS的性能产生重大影响。 PostgreSQL缓冲区管理器非常高效。<br>在本章中，将介绍PostgreSQL缓冲区管理器。第一部分提供了概述，随后的部分描述了以下主题：</p>\n<ul>\n<li>Buffer manager structure</li>\n<li>Buffer manager locks</li>\n<li>How the buffer manager works</li>\n<li>Ring buffer</li>\n<li>Flushing of dirty pages","more":"<img data-src=\"/images/pg_buffer_manager.png?150x100\" alt=\"Relations between buffer manager, storage, and backend processes.\"></li>\n</ul>\n<h1 id=\"Overview\"><a href=\"#Overview\" class=\"headerlink\" title=\"Overview\"></a>Overview</h1><p>本节介绍了有助于在后续各节中进行描述的关键概念。</p>\n<h2 id=\"Buffer-Manager-Structure\"><a href=\"#Buffer-Manager-Structure\" class=\"headerlink\" title=\"Buffer Manager Structure\"></a>Buffer Manager Structure</h2><p>PostgreSQL缓冲区管理器包含一个缓冲区表，缓冲区描述符和缓冲池，这将在下一节中介绍。缓冲池层存储数据文件页面，例如表和索引，以及自由空间映射和可见性映射。缓冲池是一个数组，即每个插槽存储一个数据文件的一页。缓冲池阵列的索引称为buffer_id。</p>\n<h2 id=\"Buffer-Tag\"><a href=\"#Buffer-Tag\" class=\"headerlink\" title=\"Buffer Tag\"></a>Buffer Tag</h2><p>在PostgreSQL中，每一个数据文件的每一个页面分配了一个唯一的标签，即buffer tag。当缓冲区管理器收到请求时，PostgreSQL会使用目标页面的buffer_tag</p>\n<p>buffer_tag包含三个值：其页面所属relation的RelFileNode和fork number，以及其页面的块编号。表，空闲空间映射和可见性映射的派生编号分别在0、1和2中定义。</p>\n<p>例如，buffer_tag’{（16821，16384，37721），0，7}’ 表示这个页面位于relation中数据页面的第七块页面，relation的OID和派生编号分别为37721和0；在OID为16821的表空间下，其OID为16384的数据库中。<br>类似地，buffer_tag’{（16821，16384，37721），1，3}’ 表示这个页面位于relation中的freespace map页面第三个页面，relation的OID和派生编号分别为37721和1; 在OID为16821的表空间下，其OID为16384的数据库中。</p>\n<h2 id=\"How-a-Backend-Process-Reads-Pages\"><a href=\"#How-a-Backend-Process-Reads-Pages\" class=\"headerlink\" title=\"How a Backend Process Reads Pages\"></a>How a Backend Process Reads Pages</h2><p>本小节描述了后端进程如何从缓冲区管理器读取页面<br><img data-src=\"/images/pg_buffer_manager_2.png\" alt=\"How a backend reads a page from the buffer manager..\"></p>\n<ul>\n<li>读取表或索引页时，后端进程会将包含页面的buffer_tag的请求发送到缓冲区管理器.</li>\n<li>缓冲区管理器返回存储请求页面的插槽的buffer_ID。如果请求的页面未存储在缓冲池中，则缓冲管理器将页面从持久性存储加载到缓冲池插槽之一，然后返回buffer_ID的插槽</li>\n<li>后端进程访问buffer_ID的插槽（以读取所需的页面</li>\n</ul>\n<p>当后端进程修改缓冲池中的页面（例如，通过插入元组）时，尚未刷新到存储的修改后的页面称为脏页面。</p>\n<h2 id=\"Page-Replacement-Algorithm\"><a href=\"#Page-Replacement-Algorithm\" class=\"headerlink\" title=\"Page Replacement Algorithm\"></a>Page Replacement Algorithm</h2><p>当所有缓冲池插槽均被占用但未存储请求的页面时，缓冲管理器必须在缓冲池中选择一个页面，该页面将由请求的页面替换。通常，在计算机科学领域中，页面选择算法称为页面替换算法，而所选页面称为受害者页面<br>自计算机科学问世以来，一直在进行页面替换算法的研究。因此，先前已经提出了许多替换算法。从8.1版开始，PostgreSQL使用了clock-sweep，因为它比以前版本中使用的LRU算法更简单，更高效。<br>4.4节详细介绍了时钟扫描</p>\n<h2 id=\"Flushing-Dirty-Pages\"><a href=\"#Flushing-Dirty-Pages\" class=\"headerlink\" title=\"Flushing Dirty Pages\"></a>Flushing Dirty Pages</h2><p>脏页最终应刷新到存储中；但是，缓冲区管理器需要帮助才能执行此任务。在PostgreSQL中，两个后台进程（checkpointer和background writer）负责此任务。</p>\n<p>第6节介绍了checkpointer和background writer</p>\n<p><strong>Direct I/O</strong><br>PostgreSQL不支持direct I/O，尽管已经讨论过了。如果您想了解更多详细信息，请参考<a href=\"https://www.postgresql.org/message-id/529E267F.4050700@agliodbs.com\">pgsql-ML</a>和这篇<a href=\"https://lwn.net/Articles/580542/\">文章</a>。</p>\n<h1 id=\"Buffer-Manager-Structure-1\"><a href=\"#Buffer-Manager-Structure-1\" class=\"headerlink\" title=\"Buffer Manager Structure\"></a>Buffer Manager Structure</h1><p>PostgreSQL缓冲区管理器包括三层，即缓冲区表(buffer table)，缓冲区描述符(buffer descriptors)和缓冲池(buffer pool)</p>\n<p><img data-src=\"/images/pg_buffer_manager_3.png\" alt=\"Fig. 8.3. Buffer manager&#39;s three-layer structure.\"></p>\n<ul>\n<li>缓冲池是一个数组。每个插槽存储一个数据文件页面。阵列插槽的索引称为bufferids </li>\n<li><p>缓冲区描述符层是缓冲区描述符的数组。每个描述符与缓冲池插槽一一对应，并在相应的插槽中保存存储页面的元数据。</p>\n<hr>\n<p> <strong>Note</strong></p>\n<p> 为方便起见，采用术语“缓冲区描述符层”，并且仅在本文档中使用。</p>\n<hr>\n</li>\n<li><p>缓冲区表是一个哈希表，用于存储存储页的buffer_tags与保存存储页各自元数据的描述符的buffer_id之间的关系。</p>\n</li>\n</ul>\n<p>这些层将在以下章节中详细介绍</p>\n<h2 id=\"Buffer-Table\"><a href=\"#Buffer-Table\" class=\"headerlink\" title=\"Buffer Table\"></a>Buffer Table</h2><p>缓冲区表在逻辑上可以分为三个部分：哈希函数(a hash function)，哈希存储桶插槽(hash bucket slots)和数据条目(data entries) (Fig. 8.4)<br>内置的哈希函数将buffer_tags映射到哈希存储桶插槽。由于哈希桶插槽的数量大于缓冲池插槽的数量，会发生冲突。因此，缓冲区表使用单独的链表链接方法来解决冲突。当数据条目(data entries)映射到相同的存储桶插槽(bucket slot)时，此方法将条目存储在相同的链表中，如图8.4所示。</p>\n<p><img data-src=\"/images/pg_buffer_manager_4.png\" alt=\"Fig. 8.4. Buffer table.\"></p>\n<p>数据条目包含两个值：页面的buffer_tag和保存页面元数据的描述符的buffer_id。例如，数据条目’Tag_A，id = 1’表示具有buffer_id 1的缓冲区描述符存储带有Tag_A标签的页面的元数据。</p>\n<p><strong>Hash function</strong><br>哈希函数是calc_bucket()和hash()的复合函数。以下是其作为伪函数的表示。<br><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs lisp\">uint32 bucket_slot = calc_bucket(<span class=\"hljs-name\">unsigned</span> hash(<span class=\"hljs-name\">BufferTag</span> buffer_tag), uint32 bucket_size)<br></code></pre></td></tr></table></figure></p>\n<hr>\n<p>NOTE</p>\n<p>基本操作（查找，插入和删除数据条目）在此不作解释。这些是非常常见的操作，将在以下各节中进行说明。</p>\n<hr>\n<h2 id=\"Buffer-Descriptor\"><a href=\"#Buffer-Descriptor\" class=\"headerlink\" title=\"Buffer Descriptor\"></a>Buffer Descriptor</h2><p>缓冲区描述符的结构在本小节中描述，缓冲区描述符层在下一个小节中</p>\n<p>缓冲区描述符将存储的页面的元数据保存在相应的缓冲池插槽中。缓冲区描述符结构由结构BufferDesc定义。虽然此结构有很多字段，但主要显示在以下字段中：</p>\n<ul>\n<li>tag 将存储页面的buffer_tag保存在相应的缓冲池插槽中（缓冲区标记在第1.2节中定义）</li>\n<li>buffer_id 标识描述符（等效于相应缓冲池插槽的buffer_id）</li>\n<li>refcount 保存当前正在访问关联的存储页面的PostgreSQL进程数。也称为引脚数(pin count)。 PostgreSQL进程访问存储的页面时，其引用计数必须增加1（refcount ++）。访问该页面后，其引用计数必须减少1（refcount—）。<br>  当refcount为零时，即当前未访问关联的存储页面，则该页面被取消固定(unpinned)；否则将其固定(pinned.)。</li>\n<li>usage_count 保存关联的存储页面自加载到相应的缓冲池插槽以来已被访问的次数。注意在页面替换算法(page replacement algorithm)中使用了usage_count (Section 4.4).</li>\n<li>context_lock和io_in_progress_lock是轻量级锁，用于控制对关联的存储页面的访问。这些字段在第3.2节中描述。</li>\n<li>flags 保存关联的存储页面的几种状态。主要状态如下:<ul>\n<li>dirty bit 指示存储的页面是否脏.</li>\n<li>valid bit 指示是否可以读取或写入存储的页面（有效）。例如，如果该位有效，则相应的缓冲池插槽将存储一个页面，并且此描述符（有效位）将保存页面元数据；因此，可以读取或写入存储的页面。如果该位无效，则此描述符不包含任何元数据；这意味着无法读取或写入存储的页面，或者缓冲区管理器正在替换存储的页面。</li>\n<li>io_in_progress bit 指示缓冲区管理器是否正在从存储中读取/写入关联页面。换句话说，该位指示单个进程是否持有此描述符的</li>\n</ul>\n</li>\n<li>freeNext 指向下一个描述符以生成空闲列表的指针，这将在下一个小节中进行描述。</li>\n</ul>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>结构 BufferDesc 定义在 src/include/storage/buf_internals.h.</p>\n<hr>\n<p>To simplify the following descriptions, three descriptor states are defined:</p>\n<p>Empty: When the corresponding buffer pool slot does not store a page (i.e. refcount and usage_count are 0), the state of this descriptor is empty.<br>Pinned: When the corresponding buffer pool slot stores a page and any PostgreSQL processes are accessing the page (i.e. refcount and usage_count are greater than or equal to 1), the state of this buffer descriptor is pinned.<br>Unpinned: When the corresponding buffer pool slot stores a page but no PostgreSQL processes are accessing the page (i.e. usage_count is greater than or equal to 1, but refcount is 0), the state of this buffer descriptor is unpinned.</p>\n<p>Each descriptor will have one of the above states. The descriptor state changes relative to particular conditions, which are described in the next subsection.</p>\n<p>In the following figures, buffer descriptors’ states are represented by coloured boxes.</p>\n<p>(white) Empty<br>(blue) Pinned<br>(aqua blue) Unpinned</p>\n<p>In addition, a dirty page is denoted as ‘X’. For example, an unpinned dirty descriptor is represented by  X .</p>\n<h2 id=\"Buffer-Descriptors-Layer\"><a href=\"#Buffer-Descriptors-Layer\" class=\"headerlink\" title=\"Buffer Descriptors Layer\"></a>Buffer Descriptors Layer</h2><p>A collection of buffer descriptors forms an array. In this document, the array is referred to as the buffer descriptors layer.</p>\n<p>When the PostgreSQL server starts, the state of all buffer descriptors is empty. In PostgreSQL, those descriptors comprise a linked list called freelist (Fig. 8.5).</p>\n<p><img data-src=\"/images/pg_buffer_manager_5.png\" alt=\"Fig. 8.5. Buffer manager initial state.\"></p>\n<hr>\n<p><em>*NOTE</em></p>\n<p>Please note that the freelist in PostgreSQL is completely different concept from the freelists in Oracle. PostgreSQL’s freelist is only linked list of empty buffer descriptors. In PostgreSQL freespace maps, which are described in Section 5.3.4, act as the same role of the freelists in Oracle. </p>\n<hr>\n<p>Figure 8.6 shows that how the first page is loaded.</p>\n<ul>\n<li>Retrieve an empty descriptor from the top of the freelist, and pin it (i.e. increase its refcount and usage_count by 1).</li>\n<li>Insert the new entry, which holds the relation between the tag of the first page and the buffer_id of the retrieved descriptor, in the buffer table.</li>\n<li>Load the new page from storage to the corresponding buffer pool slot.</li>\n<li>Save the metadata of the new page to the retrieved descriptor.</li>\n</ul>\n<p>The second and subsequent pages are loaded in a similar manner. Additional details are provided in Section 8.4.2.</p>\n<p><img data-src=\"/images/pg_buffer_manager_6.png\" alt=\"Fig. 8.6. Loading the first page.\"></p>\n<p>Descriptors that have been retrieved from the freelist always hold page’s metadata. In other words, non-empty descriptors continue to be used do not return to the freelist. However, related descriptors are added to the freelist again and the descriptor state becomes ‘empty’ when one of the following occurs:</p>\n<ul>\n<li>Tables or indexes have been dropped.</li>\n<li>Databases have been dropped.</li>\n<li>Tables or indexes have been cleaned up using the VACUUM FULL command.</li>\n</ul>\n<hr>\n<p><strong>Why empty descriptors comprise the freelist?</strong></p>\n<p>The reason why the freelist be made is to get the first descriptor immediately. This is a usual practice for dynamic memory resource allocation. Refer to this description. </p>\n<hr>\n<p>The buffer descriptors layer contains an unsigned 32-bit integer variable, i.e. nextVictimBuffer. This variable is used in the page replacement algorithm described in Section 8.4.4.</p>\n<h2 id=\"Buffer-Pool\"><a href=\"#Buffer-Pool\" class=\"headerlink\" title=\"Buffer Pool\"></a>Buffer Pool</h2><p>The buffer pool is a simple array that stores data file pages, such as tables and indexes. Indices of the buffer pool array are referred to as buffer_ids.</p>\n<p>The buffer pool slot size is 8 KB, which is equal to the size of a page. Thus, each slot can store an entire page.</p>\n<h1 id=\"Buffer-Manager-Locks\"><a href=\"#Buffer-Manager-Locks\" class=\"headerlink\" title=\"Buffer Manager Locks\"></a>Buffer Manager Locks</h1><p>The buffer manager uses many locks for many different purposes. This section describes the locks necessary for the explanations in the subsequent sections.</p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>Please note that the locks described in this section are parts of a synchronization mechanism for the buffer manager; they do not relate to any SQL statements and SQL options. </p>\n<hr>\n<h2 id=\"Buffer-Table-Locks\"><a href=\"#Buffer-Table-Locks\" class=\"headerlink\" title=\"Buffer Table Locks\"></a>Buffer Table Locks</h2><p>BufMappingLock protects the data integrity of the entire buffer table. It is a light-weight lock that can be used in both shared and exclusive modes. When searching an entry in the buffer table, a backend process holds a shared BufMappingLock. When inserting or deleting entries, a backend process holds an exclusive lock.</p>\n<p>The BufMappingLock is split into partitions to reduce the contention in the buffer table (the default is 128 partitions). Each BufMappingLock partition guards the portion of the corresponding hash bucket slots.</p>\n<p>Figure 8.7 shows a typical example of the effect of splitting BufMappingLock. Two backend processes can simultaneously hold respective BufMappingLock partitions in exclusive mode in order to insert new data entries. If the BufMappingLock is a single system-wide lock, both processes should wait for the processing of another process, depending on which started processing.</p>\n<p><img data-src=\"/images/pg_buffer_manager_7.png\" alt=\"Two processes simultaneously acquire the respective partitions of BufMappingLock in exclusive mode to insert new data entries.\"></p>\n<p>The buffer table requires many other locks. For example, the buffer table internally uses a spin lock to delete an entry. However, descriptions of these other locks are omitted because they are not required in this document.</p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>The BufMappingLock had been split into 16 separate locks by default until version 9.4.</p>\n<hr>\n<h2 id=\"Locks-for-Each-Buffer-Descriptor\"><a href=\"#Locks-for-Each-Buffer-Descriptor\" class=\"headerlink\" title=\"Locks for Each Buffer Descriptor\"></a>Locks for Each Buffer Descriptor</h2><p>Each buffer descriptor uses two light-weight locks, content_lock and io_in_progress_lock, to control access to the stored page in the corresponding buffer pool slot. When the values of own fields are checked or changed, a spinlock is used. </p>\n<h3 id=\"content-lock\"><a href=\"#content-lock\" class=\"headerlink\" title=\"content_lock\"></a>content_lock</h3><p>The content_lock is a typical lock that enforces access limits. It can be used in shared and exclusive modes.</p>\n<p>When reading a page, a backend process acquires a shared content_lock of the buffer descriptor that stores the page.</p>\n<p>However, an exclusive content_lock is acquired when doing one of the following:</p>\n<ul>\n<li>Inserting rows (i.e. tuples) into the stored page or changing the t_xmin/t_xmax fields of tuples within the stored page (t_xmin and t_xmax are described in Section 5.2; simply, when deleting or updating rows, these fields of the associated tuples are changed).</li>\n<li>Removing tuples physically or compacting free space on the stored page (performed by vacuum processing and HOT, which are described in Chapters 6 and 7, respectively).</li>\n<li>Freezing tuples within the stored page (freezing is described in Section 5.10.1 and Section 6.3).</li>\n</ul>\n<p>The official <a href=\"https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README\">README</a> file shows more details.</p>\n<h3 id=\"io-in-progress-lock\"><a href=\"#io-in-progress-lock\" class=\"headerlink\" title=\"io_in_progress_lock\"></a>io_in_progress_lock</h3><p>The io_in_progress lock is used to wait for I/O on a buffer to complete. When a PostgreSQL process loads/writes page data from/to storage, the process holds an exclusive io_in_progress lock of the corresponding descriptor while accessing the storage.</p>\n<h3 id=\"spinlock\"><a href=\"#spinlock\" class=\"headerlink\" title=\"spinlock\"></a>spinlock</h3><p>When the flags or other fields (e.g. refcount and usage_count) are checked or changed, a spinlock is used. Two specific examples of spinlock usage are given below:</p>\n<ul>\n<li>The following shows how to pin the buffer descriptor:<ul>\n<li>Acquire a spinlock of the buffer descriptor.</li>\n<li>Increase the values of its refcount and usage_count by 1.</li>\n<li>Release the spinlock.<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mipsasm\">LockBufHdr(<span class=\"hljs-keyword\">bufferdesc); </span>   <span class=\"hljs-comment\">/* Acquire a spinlock */</span><br><span class=\"hljs-keyword\">bufferdesc-&gt;refcont++;</span><br><span class=\"hljs-keyword\">bufferdesc-&gt;usage_count++;</span><br><span class=\"hljs-keyword\">UnlockBufHdr(bufferdesc); </span><span class=\"hljs-comment\">/* Release the spinlock */</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li>The following shows how to set the dirty bit to ‘1’: <ul>\n<li>Acquire a spinlock of the buffer descriptor. </li>\n<li>Set the dirty bit to ‘1’ using a bitwise operation.</li>\n<li>Release the spinlock.<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">#define BM_DIRTY             (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">0</span>)    <span class=\"hljs-comment\">/* data needs writing */</span><br>#define BM_VALID             (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">1</span>)    <span class=\"hljs-comment\">/* data is valid */</span><br>#define BM_TAG_VALID         (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">2</span>)    <span class=\"hljs-comment\">/* tag is assigned */</span><br>#define BM_IO_IN_PROGRESS    (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">3</span>)    <span class=\"hljs-comment\">/* read or write in progress */</span><br>#define BM_JUST_DIRTIED      (<span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">5</span>)    <span class=\"hljs-comment\">/* dirtied since write started */</span><br><br>LockBufHdr(bufferdesc);<br>bufferdesc-&gt;flags |= BM_DIRTY;<br>UnlockBufHdr(bufferdesc);<br></code></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<p>Changing other bits is performed in the same manner. </p>\n<hr>\n<p><strong>NOTE</strong></p>\n<p>In version 9.6, the spinlocks of buffer manager will be replaced to atomic operations. See this result of <a href=\"https://commitfest.postgresql.org/9/408/\">commitfest</a>. If you want to know the details, refer to this <a href=\"https://www.postgresql.org/message-id/flat/2400449.GjM57CE0Yg@dinodell#2400449.GjM57CE0Yg@dinodell\">discussion</a>. </p>\n<hr>\n<h1 id=\"How-the-Buffer-Manager-Works\"><a href=\"#How-the-Buffer-Manager-Works\" class=\"headerlink\" title=\"How the Buffer Manager Works\"></a>How the Buffer Manager Works</h1><p>This section describes how the buffer manager works. When a backend process wants to access a desired page, it calls the ReadBufferExtended function.</p>\n<p>The behavior of the ReadBufferExtended function depends on three logical cases. Each case is described in the following subsections. In addition, the PostgreSQL clock sweep page replacement algorithm is described in the final subsection.</p>\n<h2 id=\"Accessing-a-Page-Stored-in-the-Buffer-Pool\"><a href=\"#Accessing-a-Page-Stored-in-the-Buffer-Pool\" class=\"headerlink\" title=\"Accessing a Page Stored in the Buffer Pool\"></a>Accessing a Page Stored in the Buffer Pool</h2><p>First, the simplest case is described, i.e. the desired page is already stored in the buffer pool. In this case, the buffer manager performs the following steps:</p>\n<ul>\n<li>Create the buffer_tag of the desired page (in this example, the buffer_tag is ‘Tag_C’) and compute the hash bucket slot, which contains the associated entry of the created buffer_tag, using the hash function.</li>\n<li>Acquire the BufMappingLock partition that covers the obtained hash bucket slot in shared mode (this lock will be released in step (5)).</li>\n<li>Look up the entry whose tag is ‘Tag_C’ and obtain the buffer_id from the entry. In this example, the buffer_id is 2.</li>\n<li>Pin the buffer descriptor for buffer_id 2, i.e. the refcount and usage_count of the descriptor are increased by 1 ( Section 8.3.2 describes pinning).</li>\n<li>Release the BufMappingLock.</li>\n<li>Access the buffer pool slot with buffer_id 2.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_8.png\" alt=\"Fig. 8.8. Accessing a page stored in the buffer pool.\"></p>\n<p>Then, when reading rows from the page in the buffer pool slot, the PostgreSQL process acquires the shared content_lock of the corresponding buffer descriptor. Thus, buffer pool slots can be read by multiple processes simultaneously.</p>\n<p>When inserting (and updating or deleting) rows to the page, a Postgres process acquires the exclusive content_lock of the corresponding buffer descriptor (note that the dirty bit of the page must be set to ‘1’).</p>\n<p>After accessing the pages, the refcount values of the corresponding buffer descriptors are decreased by 1.</p>\n<h2 id=\"Loading-a-Page-from-Storage-to-Empty-Slot\"><a href=\"#Loading-a-Page-from-Storage-to-Empty-Slot\" class=\"headerlink\" title=\"Loading a Page from Storage to Empty Slot\"></a>Loading a Page from Storage to Empty Slot</h2><p>In this second case, assume that the desired page is not in the buffer pool and the freelist has free elements (empty descriptors). In this case, the buffer manager performs the following steps:</p>\n<ul>\n<li>Look up the buffer table (we assume it is not found).</li>\n<li>Create the buffer_tag of the desired page (in this example, the buffer_tag is ‘Tag_E’) and compute the hash bucket slot.</li>\n<li>Acquire the BufMappingLock partition in shared mode.<ul>\n<li>Look up the buffer table (not found according to the assumption).</li>\n<li>Release the BufMappingLock.</li>\n</ul>\n</li>\n<li>Obtain the empty buffer descriptor from the freelist, and pin it. In this example, the buffer_id of the obtained descriptor is 4.</li>\n<li>Acquire the BufMappingLock partition in exclusive mode (this lock will be released in step (6)).</li>\n<li>Create a new data entry that comprises the buffer_tag ‘Tag_E’ and buffer_id 4; insert the created entry to the buffer table.</li>\n<li>Load the desired page data from storage to the buffer pool slot with buffer_id 4 as follows:</li>\n<li>Acquire the exclusive io_in_progress_lock of the corresponding descriptor.<ul>\n<li>Set the io_in_progress bit of the corresponding descriptor to ‘1 to prevent access by other processes.</li>\n<li>Load the desired page data from storage to the buffer pool slot.</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘0’, and the valid bit is set to ‘1’.</li>\n<li>Release the io_in_progress_lock.</li>\n</ul>\n</li>\n<li>Release the BufMappingLock.</li>\n<li>Access the buffer pool slot with buffer_id 4.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_9.png\" alt=\"Fig. 8.9. Loading a page from storage to an empty slot.\"></p>\n<h2 id=\"Loading-a-Page-from-Storage-to-a-Victim-Buffer-Pool-Slot\"><a href=\"#Loading-a-Page-from-Storage-to-a-Victim-Buffer-Pool-Slot\" class=\"headerlink\" title=\"Loading a Page from Storage to a Victim Buffer Pool Slot\"></a>Loading a Page from Storage to a Victim Buffer Pool Slot</h2><p>In this case, assume that all buffer pool slots are occupied by pages but the desired page is not stored. The buffer manager performs the following steps:</p>\n<ul>\n<li>Create the buffer_tag of the desired page and look up the buffer table. In this example, we assume that the buffer_tag is ‘Tag_M’ (the desired page is not found).</li>\n<li>Select a victim buffer pool slot using the clock-sweep algorithm, obtain the old entry, which contains the buffer_id of the victim pool slot, from the buffer table and pin the victim pool slot in the buffer descriptors layer. In this example, the buffer_id of the victim slot is 5 and the old entry is ‘Tag_F, id=5’. The clock sweep is described in the next subsection.</li>\n<li>Flush (write and fsync) the victim page data if it is dirty; otherwise proceed to step (4).<br> The dirty page must be written to storage before overwriting with new data. Flushing a dirty page is performed as follows:<ul>\n<li>Acquire the shared content_lock and the exclusive io_in_progress lock of the descriptor with buffer_id 5 (released in step 6).</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘1’ and the just_dirtied bit is set to ‘0’.</li>\n<li>Depending on the situation, the XLogFlush() function is invoked to write WAL data on the WAL buffer to the current WAL segment file (details are omitted; WAL and the XLogFlush function are described in Chapter 9).</li>\n<li>Flush the victim page data to storage.</li>\n<li>Change the states of the corresponding descriptor; the io_in_progress bit is set to ‘0’ and the valid bit is set to ‘1’.</li>\n<li>Release the io_in_progress and content_lock locks.</li>\n</ul>\n</li>\n<li>Acquire the old BufMappingLock partition that covers the slot that contains the old entry, in exclusive mode.</li>\n<li>Acquire the new BufMappingLock partition and insert the new entry to the buffer table:<ul>\n<li>Create the new entry comprised of the new buffer_tag ‘Tag_M’ and the victim’s buffer_id.</li>\n<li>Acquire the new BufMappingLock partition that covers the slot containing the new entry in exclusive mode.</li>\n<li>Insert the new entry to the buffer table.</li>\n</ul>\n</li>\n<li>Delete the old entry from the buffer table, and release the old BufMappingLock partition.</li>\n<li>Load the desired page data from the storage to the victim buffer slot. Then, update the flags of the descriptor with buffer_id 5; the dirty bit is set to ‘0 and initialize other bits.</li>\n<li>Release the new BufMappingLock partition.</li>\n<li>Access the buffer pool slot with buffer_id 5.</li>\n</ul>\n<p><img data-src=\"/images/pg_buffer_manager_10.png\" alt=\"Fig. 8.10. Loading a page from storage to a victim buffer pool slot.\"></p>\n<h2 id=\"Page-Replacement-Algorithm-Clock-Sweep\"><a href=\"#Page-Replacement-Algorithm-Clock-Sweep\" class=\"headerlink\" title=\"Page Replacement Algorithm: Clock Sweep\"></a>Page Replacement Algorithm: Clock Sweep</h2><p>The rest of this section describes the clock-sweep algorithm. This algorithm is a variant of NFU (Not Frequently Used) with low overhead; it selects less frequently used pages efficiently.</p>\n<p>Imagine buffer descriptors as a circular list (Fig. 8.12). The nextVictimBuffer, an unsigned 32-bit integer, is always pointing to one of the buffer descriptors and rotates clockwise. The pseudocode and description of the algorithm are follows: </p>\n<hr>\n<p><strong>Pseudocode: clock-sweep</strong></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><figure class=\"highlight vhdl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vhdl\">     <span class=\"hljs-keyword\">WHILE</span> <span class=\"hljs-literal\">true</span><br>(<span class=\"hljs-number\">1</span>)     Obtain the candidate <span class=\"hljs-keyword\">buffer</span> descriptor pointed by the nextVictimBuffer<br>(<span class=\"hljs-number\">2</span>)     <span class=\"hljs-keyword\">IF</span> the candidate descriptor <span class=\"hljs-keyword\">is</span> unpinned <span class=\"hljs-keyword\">THEN</span><br>(<span class=\"hljs-number\">3</span>)           <span class=\"hljs-keyword\">IF</span> the candidate descriptor<span class=\"hljs-symbol\">&#x27;s</span> usage_count == <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span><br>                BREAK <span class=\"hljs-keyword\">WHILE</span> <span class=\"hljs-keyword\">LOOP</span>  <span class=\"hljs-comment\">/* the corresponding slot of this descriptor is victim slot. */</span><br>           <span class=\"hljs-keyword\">ELSE</span><br>            Decrease the candidate descriptpor<span class=\"hljs-symbol\">&#x27;s</span> usage_count by <span class=\"hljs-number\">1</span><br>               <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span><br>         <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">IF</span><br>(<span class=\"hljs-number\">4</span>)     Advance nextVictimBuffer <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">next</span> one<br>      <span class=\"hljs-keyword\">END</span> <span class=\"hljs-keyword\">WHILE</span> <br>(<span class=\"hljs-number\">5</span>) <span class=\"hljs-keyword\">RETURN</span> buffer_id <span class=\"hljs-keyword\">of</span> the victim<br></code></pre></td></tr></table></figure></h2><p>A specific example is shown in Fig. 8.12. The buffer descriptors are shown as blue or cyan boxes, and the numbers in the boxes show the usage_count of each descriptor. </p>\n<h1 id=\"Ring-Buffer\"><a href=\"#Ring-Buffer\" class=\"headerlink\" title=\"Ring Buffer\"></a>Ring Buffer</h1><p>When reading or writing a huge table, PostgreSQL uses a ring buffer rather than the buffer pool. The ring buffer is a small and temporary buffer area. When any condition listed below is met, a ring buffer is allocated to shared memory:</p>\n<ul>\n<li>Bulk-reading<br>When a relation whose size exceeds one-quarter of the buffer pool size (shared_buffers/4) is scanned. In this case, the ring buffer size is 256 KB.</li>\n<li>Bulk-writing<br>When the SQL commands listed below are executed. In this case, the ring buffer size is 16 MB.<ul>\n<li>COPY FROM command.</li>\n<li>CREATE TABLE AS command.</li>\n<li>CREATE MATERIALIZED VIEW or REFRESH MATERIALIZED VIEW command.</li>\n<li>ALTER TABLE command.</li>\n</ul>\n</li>\n<li>Vacuum-processing<br>When an autovacuum performs a vacuum processing. In this case, the ring buffer size is 256 KB.</li>\n</ul>\n<p>The allocated ring buffer is released immediately after use.</p>\n<p>The benefit of the ring buffer is obvious. If a backend process reads a huge table without using a ring buffer, all stored pages in the buffer pool are removed (kicked out); therefore, the cache hit ratio decreases. The ring buffer avoids this issue. </p>\n<hr>\n<p><strong>Why the default ring buffer size for bulk-reading and vacuum processing is 256 KB?</strong></p>\n<p>Why 256 KB? The answer is explained in the <a href=\"https://github.com/postgres/postgres/blob/master/src/backend/storage/buffer/README\">README</a> located under the buffer manager’s source directory.<br>  For sequential scans, a 256 KB ring is used. That’s small enough to fit in L2 cache, which makes transferring pages from OS cache to shared buffer cache efficient. Even less would often be enough, but the ring must be big enough to accommodate all pages in the scan that are pinned concurrently. (snip) </p>\n<hr>\n<h1 id=\"Flushing-Dirty-Pages-1\"><a href=\"#Flushing-Dirty-Pages-1\" class=\"headerlink\" title=\"Flushing Dirty Pages\"></a>Flushing Dirty Pages</h1><p>In addition to replacing victim pages, the checkpointer and background writer processes flush dirty pages to storage. Both processes have the same function (flushing dirty pages); however, they have different roles and behaviours.</p>\n<p>The checkpointer process writes a checkpoint record to the WAL segment file and flushes dirty pages whenever checkpointing starts. Section 9.7 describes checkpointing and when it begins.</p>\n<p>The role of the background writer is to reduce the influence of the intensive writing of checkpointing. The background writer continues to flush dirty pages little by little with minimal impact on database activity. By default, the background writer wakes every 200 msec (defined by bgwriter_delay) and flushes bgwriter_lru_maxpages (the default is 100 pages) at maximum. </p>\n<hr>\n<p><strong>为什么要从background writer分离出checkpointer?</strong></p>\n<p>在9.1或更早版本中，background writer定期执行checkpoint处理。在版本9.2中，checkpointer进程已与background writer进程分离。在<a href=\"https://www.postgresql.org/message-id/CA%2BU5nMLv2ah-HNHaQ%3D2rxhp_hDJ9jcf-LL2kW3sE4msfnUw9gA%40mail.gmail.com\">“Separating bgwriter and checkpointer”</a> 提案中描述了原因。</p>\n<h2 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a><figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs applescript\">Currently(<span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">2011</span>) <span class=\"hljs-keyword\">the</span> bgwriter process performs both background writing, checkpointing <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">some</span> other duties. This means <span class=\"hljs-keyword\">that</span> we can&#x27;t perform <span class=\"hljs-keyword\">the</span> final checkpoint fsync <span class=\"hljs-keyword\">without</span> stopping background writing, so there <span class=\"hljs-keyword\">is</span> a negative performance effect <span class=\"hljs-keyword\">from</span> doing both things <span class=\"hljs-keyword\">in</span> one process.<br>Additionally, our aim <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">9.2</span> <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">to</span> replace polling loops <span class=\"hljs-keyword\">with</span> latches <span class=\"hljs-keyword\">for</span> power reduction. The complexity <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">the</span> bgwriter loops <span class=\"hljs-keyword\">is</span> high <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">it</span> seems unlikely <span class=\"hljs-keyword\">to</span> come up <span class=\"hljs-keyword\">with</span> a clean approach using latches.<br></code></pre></td></tr></table></figure></h2>"},{"title":"postgresql.git log 阅读记录","date":"2020-08-14T11:41:25.000Z","top":3,"description":null,"password":null,"_content":"\n#  psql增加\\d[i|m|t]+\n```\ncommit 07f386ede026ae8c3f2adeba0c22139df19bf2ff\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Wed Sep 2 16:59:22 2020 +0900\n\n    Add access method names to \\d[i|m|t]+ in psql\n\n    Listing a full set of relations with those psql meta-commands, without a\n    matching pattern, has never showed the access method associated with\n    each relation.  This commit adds the access method of tables, indexes\n    and matviews, masking it for relation kinds where it does not apply.\n\n    Note that when HIDE_TABLEAM is enabled, the information does not show\n    up.  This is available when connecting to a backend version of at least\n    12, where table AMs have been introduced.\n\n    Author: Georgios Kokolatos\n    Reviewed-by: Vignesh C, Michael Paquier, Justin Pryzby\n    Discussion: https://postgr.es/m/svaS1VTOEscES9CLKVTeKItjJP1EEJuBhTsA0ESOdlnbXeQSgycYwVlliL5zt8Jwcfo4ATYDXtEqsExxjkSkkhCSTCL8fnRgaCAJdr0unUg=@protonmail.com\n\n```\n\n# 新增函数string_to_table\n```\nAdd string_to_table() function.\n    This splits a string at occurrences of a delimiter.  It is exactly like\n    string_to_array() except for producing a set of values instead of an\n    array of values.  Thus, the relationship of these two functions is\n    the same as between regexp_split_to_table() and regexp_split_to_array().\n\n    Although the same results could be had from unnest(string_to_array()),\n    this is somewhat faster than that, and anyway it seems reasonable to\n    have it for symmetry with the regexp functions.\n\n    Pavel Stehule, reviewed by Peter Smith\n\n\n```\n\n# 逻辑复制增加正在处理的事物中的复制\n```\ncommit 464824323e57dc4b397e8b05854d779908b55304\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Thu Sep 3 07:54:07 2020 +0530\n\n    Add support for streaming to built-in logical replication.\n\n    To add support for streaming of in-progress transactions into the\n    built-in logical replication, we need to do three things:\n\n    * Extend the logical replication protocol, so identify in-progress\n    transactions, and allow adding additional bits of information (e.g.\n    XID of subtransactions).\n\n    * Modify the output plugin (pgoutput) to implement the new stream\n    API callbacks, by leveraging the extended replication protocol.\n\n    * Modify the replication apply worker, to properly handle streamed\n    in-progress transaction by spilling the data to disk and then\n    replaying them on commit.\n\n    We however must explicitly disable streaming replication during\n    replication slot creation, even if the plugin supports it. We\n    don't need to replicate the changes accumulated during this phase,\n    and moreover we don't have a replication connection open so we\n    don't have where to send the data anyway.\n\n    Author: Tomas Vondra, Dilip Kumar and Amit Kapila\n    Reviewed-by: Amit Kapila, Kuntal Ghosh and Ajin Cherian\n    Tested-by: Neha Sharma, Mahendra Singh Thalor and Ajin Cherian\n    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com\n\n```\n\n# 新增视图pg_backend_memory_contexts\n```\ncommit 3e98c0bafb28de87ae095b341687dc082371af54 (HEAD -> master, origin/master, origin/HEAD)\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Wed Aug 19 15:34:43 2020 +0900\n\n    Add pg_backend_memory_contexts system view.\n\n    This view displays the usages of all the memory contexts of the server\n    process attached to the current session. This information is useful to\n    investigate the cause of backend-local memory bloat.\n\n    This information can be also collected by calling\n    MemoryContextStats(TopMemoryContext) via a debugger. But this technique\n    cannot be uesd in some environments because no debugger is available there.\n    And it outputs lots of text messages and it's not easy to analyze them.\n    So, pg_backend_memory_contexts view allows us to access to backend-local\n    memory contexts information more easily.\n\n    Bump catalog version.\n\n    Author: Atsushi Torikoshi, Fujii Masao\n    Reviewed-by: Tatsuhito Kasahara, Andres Freund, Daniel Gustafsson, Robert Haas, Michael Paquier\n    Discussion: https://postgr.es/m/72a656e0f71d0860161e0b3f67e4d771@oss.nttdata.com\n\n```\n\n# log_line_prefix 增加 %P 显示并行leader\n```\ncommit b8fdee7d0ca8bd2165d46fb1468f75571b706a01\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Mon Aug 3 13:38:48 2020 +0900\n\n    Add %P to log_line_prefix for parallel group leader\n\n    This is useful for monitoring purposes with log parsing.  Similarly to\n    pg_stat_activity, the leader's PID is shown only for active parallel\n    workers, minimizing the log footprint for the leaders as the equivalent\n    shared memory field is set as long as a backend is alive.\n\n    Author: Justin Pryzby\n    Reviewed-by: Álvaro Herrera, Michael Paquier, Julien Rouhaud, Tom Lane\n    Discussion: https://postgr.es/m/20200315111831.GA21492@telsasoft.com\n\n```\n\n<!-- more -->\n\n# 增加GUC hash_mem_multiplier\n```\ncommit d6c08e29e7bc8bc3bf49764192c4a9c71fc0b097\nAuthor: Peter Geoghegan <pg@bowt.ie>\nDate:   Wed Jul 29 14:14:58 2020 -0700\n\n    Add hash_mem_multiplier GUC.\n\n    Add a GUC that acts as a multiplier on work_mem.  It gets applied when\n    sizing executor node hash tables that were previously size constrained\n    using work_mem alone.\n\n    The new GUC can be used to preferentially give hash-based nodes more\n    memory than the generic work_mem limit.  It is intended to enable admin\n    tuning of the executor's memory usage.  Overall system throughput and\n    system responsiveness can be improved by giving hash-based executor\n    nodes more memory (especially over sort-based alternatives, which are\n    often much less sensitive to being memory constrained).\n\n    The default value for hash_mem_multiplier is 1.0, which is also the\n    minimum valid value.  This means that hash-based nodes continue to apply\n    work_mem in the traditional way by default.\n\n    hash_mem_multiplier is generally useful.  However, it is being added now\n    due to concerns about hash aggregate performance stability for users\n    that upgrade to Postgres 13 (which added disk-based hash aggregation in\n    commit 1f39bce0).  While the old hash aggregate behavior risked\n    out-of-memory errors, it is nevertheless likely that many users actually\n    benefited.  Hash agg's previous indifference to work_mem during query\n    execution was not just faster; it also accidentally made aggregation\n    resilient to grouping estimate problems (at least in cases where this\n    didn't create destabilizing memory pressure).\n\n    hash_mem_multiplier can provide a certain kind of continuity with the\n    behavior of Postgres 12 hash aggregates in cases where the planner\n    incorrectly estimates that all groups (plus related allocations) will\n    fit in work_mem/hash_mem.  This seems necessary because hash-based\n    aggregation is usually much slower when only a small fraction of all\n    groups can fit.  Even when it isn't possible to totally avoid hash\n    aggregates that spill, giving hash aggregation more memory will reliably\n    improve performance (the same cannot be said for external sort\n    operations, which appear to be almost unaffected by memory availability\n    provided it's at least possible to get a single merge pass).\n\n    The PostgreSQL 13 release notes should advise users that increasing\n    hash_mem_multiplier can help with performance regressions associated\n    with hash aggregation.  That can be taken care of by a later commit.\n\n    Author: Peter Geoghegan\n    Reviewed-By: Álvaro Herrera, Jeff Davis\n    Discussion: https://postgr.es/m/20200625203629.7m6yvut7eqblgmfo@alap3.anarazel.de\n    Discussion: https://postgr.es/m/CAH2-WzmD%2Bi1pG6rc1%2BCjc4V6EaFJ_qSuKCCHVnH%3DoruqD-zqow%40mail.gmail.com\n    Backpatch: 13-, where disk-based hash aggregation was introduced.\n\n```\n\n# pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands\n```\ncommit 6023b7ea717ca04cf1bd53709d9c862db07eaefb\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Wed Jul 29 23:21:55 2020 +0900\n\n    pg_stat_statements: track number of rows processed by some utility commands.\n\n    This commit makes pg_stat_statements track the total number\n    of rows retrieved or affected by CREATE TABLE AS, SELECT INTO,\n    CREATE MATERIALIZED VIEW and FETCH commands.\n\n    Suggested-by: Pascal Legrand\n    Author: Fujii Masao\n    Reviewed-by: Asif Rehman\n    Discussion: https://postgr.es/m/1584293755198-0.post@n3.nabble.com\n\n```\n\n# 并行增强\n```\ncommit 56788d2156fc32bd5737e7ac716d70e6a269b7bc\nAuthor: David Rowley <drowley@postgresql.org>\nDate:   Sun Jul 26 21:02:45 2020 +1200\n\n    Allocate consecutive blocks during parallel seqscans\n\n    Previously we would allocate blocks to parallel workers during a parallel\n    sequential scan 1 block at a time.  Since other workers were likely to\n    request a block before a worker returns for another block number to work\n    on, this could lead to non-sequential I/O patterns in each worker which\n    could cause the operating system's readahead to perform poorly or not at\n    all.\n\n    Here we change things so that we allocate consecutive \"chunks\" of blocks\n    to workers and have them work on those until they're done, at which time\n    we allocate another chunk for the worker.  The size of these chunks is\n    based on the size of the relation.\n\n    Initial patch here was by Thomas Munro which showed some good improvements\n    just having a fixed chunk size of 64 blocks with a simple ramp-down near\n    the end of the scan. The revisions of the patch to make the chunk size\n    based on the relation size and the adjusted ramp-down in powers of two was\n    done by me, along with quite extensive benchmarking to determine the\n    optimal chunk sizes.\n\n    For the most part, benchmarks have shown significant performance\n    improvements for large parallel sequential scans on Linux, FreeBSD and\n    Windows using SSDs.  It's less clear how this affects the performance of\n    cloud providers.  Tests done so far are unable to obtain stable enough\n    performance to provide meaningful benchmark results.  It is possible that\n    this could cause some performance regressions on more obscure filesystems,\n    so we may need to later provide users with some ability to get something\n    closer to the old behavior.  For now, let's leave that until we see that\n    it's really required.\n\n    Author: Thomas Munro, David Rowley\n    Reviewed-by: Ranier Vilela, Soumyadeep Chakraborty, Robert Haas\n    Reviewed-by: Amit Kapila, Kirk Jamison\n    Discussion: https://postgr.es/m/CA+hUKGJ_EErDv41YycXcbMbCBkztA34+z1ts9VQH+ACRuvpxig@mail.gmail.com\n\n```\n\n# GUC enable_hashagg_disk\n```\ncommit bcbf9446a2983b6452c19cc50050456be262f7c5\nAuthor: Peter Geoghegan <pg@bowt.ie>\nDate:   Mon Jul 27 17:53:19 2020 -0700\n\n    Remove hashagg_avoid_disk_plan GUC.\n\n    Note: This GUC was originally named enable_hashagg_disk when it appeared\n    in commit 1f39bce0, which added disk-based hash aggregation.  It was\n    subsequently renamed in commit 92c58fd9.\n\n    Author: Peter Geoghegan\n    Reviewed-By: Jeff Davis, Álvaro Herrera\n    Discussion: https://postgr.es/m/9d9d1e1252a52ea1bad84ea40dbebfd54e672a0f.camel%40j-davis.com\n    Backpatch: 13-, where disk-based hash aggregation was introduced.\n\n```\n\n# logical decoding output plugin API\n```\ncommit 45fdc9738b36d1068d3ad8fdb06436d6fd14436b\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Tue Jul 28 08:06:44 2020 +0530\n\n    Extend the logical decoding output plugin API with stream methods.\n\n    This adds seven methods to the output plugin API, adding support for\n    streaming changes of large in-progress transactions.\n\n    * stream_start\n    * stream_stop\n    * stream_abort\n    * stream_commit\n    * stream_change\n    * stream_message\n    * stream_truncate\n\n    Most of this is a simple extension of the existing methods, with\n    the semantic difference that the transaction (or subtransaction)\n    is incomplete and may be aborted later (which is something the\n    regular API does not really need to deal with).\n\n    This also extends the 'test_decoding' plugin, implementing these\n    new stream methods.\n\n    The stream_start/start_stop are used to demarcate a chunk of changes\n    streamed for a particular toplevel transaction.\n\n    This commit simply adds these new APIs and the upcoming patch to \"allow\n    the streaming mode in ReorderBuffer\" will use these APIs.\n\n    Author: Tomas Vondra, Dilip Kumar, Amit Kapila\n    Reviewed-by: Amit Kapila\n    Tested-by: Neha Sharma and Mahendra Singh Thalor\n    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com\n\n```\n\n# wal_keep_segments 改名为 wal_keep_size.\n``` \ncommit c3fe108c025e4a080315562d4c15ecbe3f00405e\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jul 20 13:30:18 2020 +0900\n\n    Rename wal_keep_segments to wal_keep_size.\n\n    max_slot_wal_keep_size that was added in v13 and wal_keep_segments are\n    the GUC parameters to specify how much WAL files to retain for\n    the standby servers. While max_slot_wal_keep_size accepts the number of\n    bytes of WAL files, wal_keep_segments accepts the number of WAL files.\n    This difference of setting units between those similar parameters could\n    be confusing to users.\n\n    To alleviate this situation, this commit renames wal_keep_segments to\n    wal_keep_size, and make users specify the WAL size in it instead of\n    the number of WAL files.\n\n    There was also the idea to rename max_slot_wal_keep_size to\n    max_slot_wal_keep_segments, in the discussion. But we have been moving\n    away from measuring in segments, for example, checkpoint_segments was\n    replaced by max_wal_size. So we concluded to rename wal_keep_segments\n    to wal_keep_size.\n\n    Back-patch to v13 where max_slot_wal_keep_size was added.\n\n    Author: Fujii Masao\n    Reviewed-by: Álvaro Herrera, Kyotaro Horiguchi, David Steele\n    Discussion: https://postgr.es/m/574b4ea3-e0f9-b175-ead2-ebea7faea855@oss.nttdata.com\n```\n\n# 增加 generic_plans and custom_plans 域到pg_prepared_statements \n```\ncommit d05b172a760e0ccb3008a2144f96053720000b12\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jul 20 11:55:50 2020 +0900\n\n    Add generic_plans and custom_plans fields into pg_prepared_statements.\n\n    There was no easy way to find how many times generic and custom plans\n    have been executed for a prepared statement. This commit exposes those\n    numbers of times in pg_prepared_statements view.\n\n    Author: Atsushi Torikoshi, Kyotaro Horiguchi\n    Reviewed-by: Tatsuro Yamada, Masahiro Ikeda, Fujii Masao\n    Discussion: https://postgr.es/m/CACZ0uYHZ4M=NZpofH6JuPHeX=__5xcDELF8hT8_2T+R55w4RQw@mail.gmail.com\n```\n\n# 逻辑复制增强， 允许二进制传输数据.\n```\ncommit 9de77b5453130242654ff0b30a551c9c862ed661\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Sat Jul 18 12:44:51 2020 -0400\n\n    Allow logical replication to transfer data in binary format.\n\n    This patch adds a \"binary\" option to CREATE/ALTER SUBSCRIPTION.\n    When that's set, the publisher will send data using the data type's\n    typsend function if any, rather than typoutput.  This is generally\n    faster, if slightly less robust.\n\n    As committed, we won't try to transfer user-defined array or composite\n    types in binary, for fear that type OIDs won't match at the subscriber.\n    This might be changed later, but it seems like fit material for a\n    follow-on patch.\n\n    Dave Cramer, reviewed by Daniel Gustafsson, Petr Jelinek, and others;\n    adjusted some by me\n\n    Discussion: https://postgr.es/m/CADK3HH+R3xMn=8t3Ct+uD+qJ1KD=Hbif5NFMJ+d5DkoCzp6Vgw@mail.gmail.com\n```\n\n#  huge_page_size\n```\ncommit d2bddc2500fb74d56e5bc53a1cfa269e2e846510\nAuthor: Thomas Munro <tmunro@postgresql.org>\nDate:   Fri Jul 17 14:33:00 2020 +1200\n\n    Add huge_page_size setting for use on Linux.\n\n    This allows the huge page size to be set explicitly.  The default is 0,\n    meaning it will use the system default, as before.\n\n    Author: Odin Ugedal <odin@ugedal.com>\n    Discussion: https://postgr.es/m/20200608154639.20254-1-odin%40ugedal.com\n\n```\n\n#  jsonpath 不允许NaN\n```\ncommit df646509f371069c65f84309eb5749642e8650b3\nAuthor: Alexander Korotkov <akorotkov@postgresql.org>\nDate:   Sat Jul 11 03:21:00 2020 +0300\n\n    Forbid numeric NaN in jsonpath\n\n    SQL standard doesn't define numeric Inf or NaN values.  It appears even more\n    ridiculous to support then in jsonpath assuming JSON doesn't support these\n    values as well.  This commit forbids returning NaN from .double(), which was\n    previously allowed.  NaN can't be result of inner-jsonpath computation over\n    non-NaNs.  So, we can not expect NaN in the jsonpath output.\n\n    Reported-by: Tom Lane\n    Discussion: https://postgr.es/m/203949.1591879542%40sss.pgh.pa.us\n    Author: Alexander Korotkov\n    Reviewed-by: Tom Lane\n    Backpatch-through: 12\n\n```\n","source":"_posts/pg14_git_log.md","raw":"---\ntitle: postgresql.git log 阅读记录\ndate: 2020-08-14 19:41:25\ntags: \n- PostgreSQL\n- git\n- postgresql.git\ncategories: \n- PostgreSQL\ntop: 3\ndescription: \npassword: \n\n---\n\n#  psql增加\\d[i|m|t]+\n```\ncommit 07f386ede026ae8c3f2adeba0c22139df19bf2ff\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Wed Sep 2 16:59:22 2020 +0900\n\n    Add access method names to \\d[i|m|t]+ in psql\n\n    Listing a full set of relations with those psql meta-commands, without a\n    matching pattern, has never showed the access method associated with\n    each relation.  This commit adds the access method of tables, indexes\n    and matviews, masking it for relation kinds where it does not apply.\n\n    Note that when HIDE_TABLEAM is enabled, the information does not show\n    up.  This is available when connecting to a backend version of at least\n    12, where table AMs have been introduced.\n\n    Author: Georgios Kokolatos\n    Reviewed-by: Vignesh C, Michael Paquier, Justin Pryzby\n    Discussion: https://postgr.es/m/svaS1VTOEscES9CLKVTeKItjJP1EEJuBhTsA0ESOdlnbXeQSgycYwVlliL5zt8Jwcfo4ATYDXtEqsExxjkSkkhCSTCL8fnRgaCAJdr0unUg=@protonmail.com\n\n```\n\n# 新增函数string_to_table\n```\nAdd string_to_table() function.\n    This splits a string at occurrences of a delimiter.  It is exactly like\n    string_to_array() except for producing a set of values instead of an\n    array of values.  Thus, the relationship of these two functions is\n    the same as between regexp_split_to_table() and regexp_split_to_array().\n\n    Although the same results could be had from unnest(string_to_array()),\n    this is somewhat faster than that, and anyway it seems reasonable to\n    have it for symmetry with the regexp functions.\n\n    Pavel Stehule, reviewed by Peter Smith\n\n\n```\n\n# 逻辑复制增加正在处理的事物中的复制\n```\ncommit 464824323e57dc4b397e8b05854d779908b55304\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Thu Sep 3 07:54:07 2020 +0530\n\n    Add support for streaming to built-in logical replication.\n\n    To add support for streaming of in-progress transactions into the\n    built-in logical replication, we need to do three things:\n\n    * Extend the logical replication protocol, so identify in-progress\n    transactions, and allow adding additional bits of information (e.g.\n    XID of subtransactions).\n\n    * Modify the output plugin (pgoutput) to implement the new stream\n    API callbacks, by leveraging the extended replication protocol.\n\n    * Modify the replication apply worker, to properly handle streamed\n    in-progress transaction by spilling the data to disk and then\n    replaying them on commit.\n\n    We however must explicitly disable streaming replication during\n    replication slot creation, even if the plugin supports it. We\n    don't need to replicate the changes accumulated during this phase,\n    and moreover we don't have a replication connection open so we\n    don't have where to send the data anyway.\n\n    Author: Tomas Vondra, Dilip Kumar and Amit Kapila\n    Reviewed-by: Amit Kapila, Kuntal Ghosh and Ajin Cherian\n    Tested-by: Neha Sharma, Mahendra Singh Thalor and Ajin Cherian\n    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com\n\n```\n\n# 新增视图pg_backend_memory_contexts\n```\ncommit 3e98c0bafb28de87ae095b341687dc082371af54 (HEAD -> master, origin/master, origin/HEAD)\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Wed Aug 19 15:34:43 2020 +0900\n\n    Add pg_backend_memory_contexts system view.\n\n    This view displays the usages of all the memory contexts of the server\n    process attached to the current session. This information is useful to\n    investigate the cause of backend-local memory bloat.\n\n    This information can be also collected by calling\n    MemoryContextStats(TopMemoryContext) via a debugger. But this technique\n    cannot be uesd in some environments because no debugger is available there.\n    And it outputs lots of text messages and it's not easy to analyze them.\n    So, pg_backend_memory_contexts view allows us to access to backend-local\n    memory contexts information more easily.\n\n    Bump catalog version.\n\n    Author: Atsushi Torikoshi, Fujii Masao\n    Reviewed-by: Tatsuhito Kasahara, Andres Freund, Daniel Gustafsson, Robert Haas, Michael Paquier\n    Discussion: https://postgr.es/m/72a656e0f71d0860161e0b3f67e4d771@oss.nttdata.com\n\n```\n\n# log_line_prefix 增加 %P 显示并行leader\n```\ncommit b8fdee7d0ca8bd2165d46fb1468f75571b706a01\nAuthor: Michael Paquier <michael@paquier.xyz>\nDate:   Mon Aug 3 13:38:48 2020 +0900\n\n    Add %P to log_line_prefix for parallel group leader\n\n    This is useful for monitoring purposes with log parsing.  Similarly to\n    pg_stat_activity, the leader's PID is shown only for active parallel\n    workers, minimizing the log footprint for the leaders as the equivalent\n    shared memory field is set as long as a backend is alive.\n\n    Author: Justin Pryzby\n    Reviewed-by: Álvaro Herrera, Michael Paquier, Julien Rouhaud, Tom Lane\n    Discussion: https://postgr.es/m/20200315111831.GA21492@telsasoft.com\n\n```\n\n<!-- more -->\n\n# 增加GUC hash_mem_multiplier\n```\ncommit d6c08e29e7bc8bc3bf49764192c4a9c71fc0b097\nAuthor: Peter Geoghegan <pg@bowt.ie>\nDate:   Wed Jul 29 14:14:58 2020 -0700\n\n    Add hash_mem_multiplier GUC.\n\n    Add a GUC that acts as a multiplier on work_mem.  It gets applied when\n    sizing executor node hash tables that were previously size constrained\n    using work_mem alone.\n\n    The new GUC can be used to preferentially give hash-based nodes more\n    memory than the generic work_mem limit.  It is intended to enable admin\n    tuning of the executor's memory usage.  Overall system throughput and\n    system responsiveness can be improved by giving hash-based executor\n    nodes more memory (especially over sort-based alternatives, which are\n    often much less sensitive to being memory constrained).\n\n    The default value for hash_mem_multiplier is 1.0, which is also the\n    minimum valid value.  This means that hash-based nodes continue to apply\n    work_mem in the traditional way by default.\n\n    hash_mem_multiplier is generally useful.  However, it is being added now\n    due to concerns about hash aggregate performance stability for users\n    that upgrade to Postgres 13 (which added disk-based hash aggregation in\n    commit 1f39bce0).  While the old hash aggregate behavior risked\n    out-of-memory errors, it is nevertheless likely that many users actually\n    benefited.  Hash agg's previous indifference to work_mem during query\n    execution was not just faster; it also accidentally made aggregation\n    resilient to grouping estimate problems (at least in cases where this\n    didn't create destabilizing memory pressure).\n\n    hash_mem_multiplier can provide a certain kind of continuity with the\n    behavior of Postgres 12 hash aggregates in cases where the planner\n    incorrectly estimates that all groups (plus related allocations) will\n    fit in work_mem/hash_mem.  This seems necessary because hash-based\n    aggregation is usually much slower when only a small fraction of all\n    groups can fit.  Even when it isn't possible to totally avoid hash\n    aggregates that spill, giving hash aggregation more memory will reliably\n    improve performance (the same cannot be said for external sort\n    operations, which appear to be almost unaffected by memory availability\n    provided it's at least possible to get a single merge pass).\n\n    The PostgreSQL 13 release notes should advise users that increasing\n    hash_mem_multiplier can help with performance regressions associated\n    with hash aggregation.  That can be taken care of by a later commit.\n\n    Author: Peter Geoghegan\n    Reviewed-By: Álvaro Herrera, Jeff Davis\n    Discussion: https://postgr.es/m/20200625203629.7m6yvut7eqblgmfo@alap3.anarazel.de\n    Discussion: https://postgr.es/m/CAH2-WzmD%2Bi1pG6rc1%2BCjc4V6EaFJ_qSuKCCHVnH%3DoruqD-zqow%40mail.gmail.com\n    Backpatch: 13-, where disk-based hash aggregation was introduced.\n\n```\n\n# pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands\n```\ncommit 6023b7ea717ca04cf1bd53709d9c862db07eaefb\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Wed Jul 29 23:21:55 2020 +0900\n\n    pg_stat_statements: track number of rows processed by some utility commands.\n\n    This commit makes pg_stat_statements track the total number\n    of rows retrieved or affected by CREATE TABLE AS, SELECT INTO,\n    CREATE MATERIALIZED VIEW and FETCH commands.\n\n    Suggested-by: Pascal Legrand\n    Author: Fujii Masao\n    Reviewed-by: Asif Rehman\n    Discussion: https://postgr.es/m/1584293755198-0.post@n3.nabble.com\n\n```\n\n# 并行增强\n```\ncommit 56788d2156fc32bd5737e7ac716d70e6a269b7bc\nAuthor: David Rowley <drowley@postgresql.org>\nDate:   Sun Jul 26 21:02:45 2020 +1200\n\n    Allocate consecutive blocks during parallel seqscans\n\n    Previously we would allocate blocks to parallel workers during a parallel\n    sequential scan 1 block at a time.  Since other workers were likely to\n    request a block before a worker returns for another block number to work\n    on, this could lead to non-sequential I/O patterns in each worker which\n    could cause the operating system's readahead to perform poorly or not at\n    all.\n\n    Here we change things so that we allocate consecutive \"chunks\" of blocks\n    to workers and have them work on those until they're done, at which time\n    we allocate another chunk for the worker.  The size of these chunks is\n    based on the size of the relation.\n\n    Initial patch here was by Thomas Munro which showed some good improvements\n    just having a fixed chunk size of 64 blocks with a simple ramp-down near\n    the end of the scan. The revisions of the patch to make the chunk size\n    based on the relation size and the adjusted ramp-down in powers of two was\n    done by me, along with quite extensive benchmarking to determine the\n    optimal chunk sizes.\n\n    For the most part, benchmarks have shown significant performance\n    improvements for large parallel sequential scans on Linux, FreeBSD and\n    Windows using SSDs.  It's less clear how this affects the performance of\n    cloud providers.  Tests done so far are unable to obtain stable enough\n    performance to provide meaningful benchmark results.  It is possible that\n    this could cause some performance regressions on more obscure filesystems,\n    so we may need to later provide users with some ability to get something\n    closer to the old behavior.  For now, let's leave that until we see that\n    it's really required.\n\n    Author: Thomas Munro, David Rowley\n    Reviewed-by: Ranier Vilela, Soumyadeep Chakraborty, Robert Haas\n    Reviewed-by: Amit Kapila, Kirk Jamison\n    Discussion: https://postgr.es/m/CA+hUKGJ_EErDv41YycXcbMbCBkztA34+z1ts9VQH+ACRuvpxig@mail.gmail.com\n\n```\n\n# GUC enable_hashagg_disk\n```\ncommit bcbf9446a2983b6452c19cc50050456be262f7c5\nAuthor: Peter Geoghegan <pg@bowt.ie>\nDate:   Mon Jul 27 17:53:19 2020 -0700\n\n    Remove hashagg_avoid_disk_plan GUC.\n\n    Note: This GUC was originally named enable_hashagg_disk when it appeared\n    in commit 1f39bce0, which added disk-based hash aggregation.  It was\n    subsequently renamed in commit 92c58fd9.\n\n    Author: Peter Geoghegan\n    Reviewed-By: Jeff Davis, Álvaro Herrera\n    Discussion: https://postgr.es/m/9d9d1e1252a52ea1bad84ea40dbebfd54e672a0f.camel%40j-davis.com\n    Backpatch: 13-, where disk-based hash aggregation was introduced.\n\n```\n\n# logical decoding output plugin API\n```\ncommit 45fdc9738b36d1068d3ad8fdb06436d6fd14436b\nAuthor: Amit Kapila <akapila@postgresql.org>\nDate:   Tue Jul 28 08:06:44 2020 +0530\n\n    Extend the logical decoding output plugin API with stream methods.\n\n    This adds seven methods to the output plugin API, adding support for\n    streaming changes of large in-progress transactions.\n\n    * stream_start\n    * stream_stop\n    * stream_abort\n    * stream_commit\n    * stream_change\n    * stream_message\n    * stream_truncate\n\n    Most of this is a simple extension of the existing methods, with\n    the semantic difference that the transaction (or subtransaction)\n    is incomplete and may be aborted later (which is something the\n    regular API does not really need to deal with).\n\n    This also extends the 'test_decoding' plugin, implementing these\n    new stream methods.\n\n    The stream_start/start_stop are used to demarcate a chunk of changes\n    streamed for a particular toplevel transaction.\n\n    This commit simply adds these new APIs and the upcoming patch to \"allow\n    the streaming mode in ReorderBuffer\" will use these APIs.\n\n    Author: Tomas Vondra, Dilip Kumar, Amit Kapila\n    Reviewed-by: Amit Kapila\n    Tested-by: Neha Sharma and Mahendra Singh Thalor\n    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com\n\n```\n\n# wal_keep_segments 改名为 wal_keep_size.\n``` \ncommit c3fe108c025e4a080315562d4c15ecbe3f00405e\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jul 20 13:30:18 2020 +0900\n\n    Rename wal_keep_segments to wal_keep_size.\n\n    max_slot_wal_keep_size that was added in v13 and wal_keep_segments are\n    the GUC parameters to specify how much WAL files to retain for\n    the standby servers. While max_slot_wal_keep_size accepts the number of\n    bytes of WAL files, wal_keep_segments accepts the number of WAL files.\n    This difference of setting units between those similar parameters could\n    be confusing to users.\n\n    To alleviate this situation, this commit renames wal_keep_segments to\n    wal_keep_size, and make users specify the WAL size in it instead of\n    the number of WAL files.\n\n    There was also the idea to rename max_slot_wal_keep_size to\n    max_slot_wal_keep_segments, in the discussion. But we have been moving\n    away from measuring in segments, for example, checkpoint_segments was\n    replaced by max_wal_size. So we concluded to rename wal_keep_segments\n    to wal_keep_size.\n\n    Back-patch to v13 where max_slot_wal_keep_size was added.\n\n    Author: Fujii Masao\n    Reviewed-by: Álvaro Herrera, Kyotaro Horiguchi, David Steele\n    Discussion: https://postgr.es/m/574b4ea3-e0f9-b175-ead2-ebea7faea855@oss.nttdata.com\n```\n\n# 增加 generic_plans and custom_plans 域到pg_prepared_statements \n```\ncommit d05b172a760e0ccb3008a2144f96053720000b12\nAuthor: Fujii Masao <fujii@postgresql.org>\nDate:   Mon Jul 20 11:55:50 2020 +0900\n\n    Add generic_plans and custom_plans fields into pg_prepared_statements.\n\n    There was no easy way to find how many times generic and custom plans\n    have been executed for a prepared statement. This commit exposes those\n    numbers of times in pg_prepared_statements view.\n\n    Author: Atsushi Torikoshi, Kyotaro Horiguchi\n    Reviewed-by: Tatsuro Yamada, Masahiro Ikeda, Fujii Masao\n    Discussion: https://postgr.es/m/CACZ0uYHZ4M=NZpofH6JuPHeX=__5xcDELF8hT8_2T+R55w4RQw@mail.gmail.com\n```\n\n# 逻辑复制增强， 允许二进制传输数据.\n```\ncommit 9de77b5453130242654ff0b30a551c9c862ed661\nAuthor: Tom Lane <tgl@sss.pgh.pa.us>\nDate:   Sat Jul 18 12:44:51 2020 -0400\n\n    Allow logical replication to transfer data in binary format.\n\n    This patch adds a \"binary\" option to CREATE/ALTER SUBSCRIPTION.\n    When that's set, the publisher will send data using the data type's\n    typsend function if any, rather than typoutput.  This is generally\n    faster, if slightly less robust.\n\n    As committed, we won't try to transfer user-defined array or composite\n    types in binary, for fear that type OIDs won't match at the subscriber.\n    This might be changed later, but it seems like fit material for a\n    follow-on patch.\n\n    Dave Cramer, reviewed by Daniel Gustafsson, Petr Jelinek, and others;\n    adjusted some by me\n\n    Discussion: https://postgr.es/m/CADK3HH+R3xMn=8t3Ct+uD+qJ1KD=Hbif5NFMJ+d5DkoCzp6Vgw@mail.gmail.com\n```\n\n#  huge_page_size\n```\ncommit d2bddc2500fb74d56e5bc53a1cfa269e2e846510\nAuthor: Thomas Munro <tmunro@postgresql.org>\nDate:   Fri Jul 17 14:33:00 2020 +1200\n\n    Add huge_page_size setting for use on Linux.\n\n    This allows the huge page size to be set explicitly.  The default is 0,\n    meaning it will use the system default, as before.\n\n    Author: Odin Ugedal <odin@ugedal.com>\n    Discussion: https://postgr.es/m/20200608154639.20254-1-odin%40ugedal.com\n\n```\n\n#  jsonpath 不允许NaN\n```\ncommit df646509f371069c65f84309eb5749642e8650b3\nAuthor: Alexander Korotkov <akorotkov@postgresql.org>\nDate:   Sat Jul 11 03:21:00 2020 +0300\n\n    Forbid numeric NaN in jsonpath\n\n    SQL standard doesn't define numeric Inf or NaN values.  It appears even more\n    ridiculous to support then in jsonpath assuming JSON doesn't support these\n    values as well.  This commit forbids returning NaN from .double(), which was\n    previously allowed.  NaN can't be result of inner-jsonpath computation over\n    non-NaNs.  So, we can not expect NaN in the jsonpath output.\n\n    Reported-by: Tom Lane\n    Discussion: https://postgr.es/m/203949.1591879542%40sss.pgh.pa.us\n    Author: Alexander Korotkov\n    Reviewed-by: Tom Lane\n    Backpatch-through: 12\n\n```\n","slug":"pg14_git_log","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzj8002rpiebaf2dfg5z","content":"<h1 id=\"psql增加-d-i-m-t\"><a href=\"#psql增加-d-i-m-t\" class=\"headerlink\" title=\"psql增加\\d[i|m|t]+\"></a>psql增加\\d[i|m|t]+</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">07</span>f386ede026ae8c3f2adeba0c22139df19bf2ff<br>Author: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-built_in\">Date</span>:   Wed Sep <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">59</span>:<span class=\"hljs-number\">22</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> <span class=\"hljs-keyword\">access</span> method <span class=\"hljs-keyword\">names</span> <span class=\"hljs-keyword\">to</span> \\d[i|m|t]+ <span class=\"hljs-keyword\">in</span> psql<br><br>    Listing a <span class=\"hljs-keyword\">full</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">of</span> relations <span class=\"hljs-keyword\">with</span> those psql meta-commands, <span class=\"hljs-keyword\">without</span> a<br>    matching pattern, has <span class=\"hljs-keyword\">never</span> showed the <span class=\"hljs-keyword\">access</span> method associated <span class=\"hljs-keyword\">with</span><br>    <span class=\"hljs-keyword\">each</span> relation.  This <span class=\"hljs-keyword\">commit</span> adds the <span class=\"hljs-keyword\">access</span> method <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">tables</span>, <span class=\"hljs-keyword\">indexes</span><br>    <span class=\"hljs-keyword\">and</span> matviews, masking it <span class=\"hljs-keyword\">for</span> relation kinds <span class=\"hljs-keyword\">where</span> it does <span class=\"hljs-keyword\">not</span> apply.<br><br>    Note that <span class=\"hljs-keyword\">when</span> HIDE_TABLEAM <span class=\"hljs-keyword\">is</span> enabled, the information does <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">show</span><br>    up.  This <span class=\"hljs-keyword\">is</span> available <span class=\"hljs-keyword\">when</span> connecting <span class=\"hljs-keyword\">to</span> a backend <span class=\"hljs-keyword\">version</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">at</span> <span class=\"hljs-keyword\">least</span><br>    <span class=\"hljs-number\">12</span>, <span class=\"hljs-keyword\">where</span> <span class=\"hljs-keyword\">table</span> AMs have been introduced.<br><br>    Author: Georgios Kokolatos<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Vignesh C, Michael Paquier, Justin Pryzby<br>    Discussion: https://postgr.es/m/svaS1VTOEscES9CLKVTeKItjJP1EEJuBhTsA0ESOdlnbXeQSgycYwVlliL5zt8Jwcfo4ATYDXtEqsExxjkSkkhCSTCL8fnRgaCAJdr0unUg=@protonmail.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"新增函数string-to-table\"><a href=\"#新增函数string-to-table\" class=\"headerlink\" title=\"新增函数string_to_table\"></a>新增函数string_to_table</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">Add</span> string_to_table() <span class=\"hljs-keyword\">function</span>.<br>    This splits a string at occurrences <span class=\"hljs-keyword\">of</span> a <span class=\"hljs-keyword\">delimiter</span>.  It <span class=\"hljs-keyword\">is</span> exactly <span class=\"hljs-keyword\">like</span><br>    string_to_array() <span class=\"hljs-keyword\">except</span> <span class=\"hljs-keyword\">for</span> producing a <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">values</span> <span class=\"hljs-keyword\">instead</span> <span class=\"hljs-keyword\">of</span> an<br>    <span class=\"hljs-keyword\">array</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">values</span>.  Thus, the relationship <span class=\"hljs-keyword\">of</span> these two <span class=\"hljs-keyword\">functions</span> <span class=\"hljs-keyword\">is</span><br>    the same <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">between</span> regexp_split_to_table() <span class=\"hljs-keyword\">and</span> regexp_split_to_array().<br><br>    Although the same results could be had <span class=\"hljs-keyword\">from</span> unnest(string_to_array()),<br>    this <span class=\"hljs-keyword\">is</span> somewhat faster than that, <span class=\"hljs-keyword\">and</span> anyway it seems reasonable <span class=\"hljs-keyword\">to</span><br>    have it <span class=\"hljs-keyword\">for</span> symmetry <span class=\"hljs-keyword\">with</span> the regexp <span class=\"hljs-keyword\">functions</span>.<br><br>    Pavel Stehule, reviewed <span class=\"hljs-keyword\">by</span> Peter Smith<br><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"逻辑复制增加正在处理的事物中的复制\"><a href=\"#逻辑复制增加正在处理的事物中的复制\" class=\"headerlink\" title=\"逻辑复制增加正在处理的事物中的复制\"></a>逻辑复制增加正在处理的事物中的复制</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">464824323e57</span>dc4b397e8b05854d779908b55304<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Thu Sep <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">07</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">07</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0530</span><br><br>    <span class=\"hljs-keyword\">Add</span> support <span class=\"hljs-keyword\">for</span> streaming <span class=\"hljs-keyword\">to</span> built-<span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">logical</span> replication.<br><br>    <span class=\"hljs-keyword\">To</span> <span class=\"hljs-keyword\">add</span> support <span class=\"hljs-keyword\">for</span> streaming <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">in</span>-progress transactions <span class=\"hljs-keyword\">into</span> the<br>    built-<span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span>, we need <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">do</span> three things:<br><br>    * Extend the <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span> protocol, so identify <span class=\"hljs-keyword\">in</span>-progress<br>    transactions, <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">allow</span> adding additional bits <span class=\"hljs-keyword\">of</span> information (e.g.<br>    XID <span class=\"hljs-keyword\">of</span> subtransactions).<br><br>    * <span class=\"hljs-keyword\">Modify</span> the <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> (pgoutput) <span class=\"hljs-keyword\">to</span> implement the <span class=\"hljs-keyword\">new</span> stream<br>    API callbacks, <span class=\"hljs-keyword\">by</span> leveraging the <span class=\"hljs-keyword\">extended</span> <span class=\"hljs-keyword\">replication</span> protocol.<br><br>    * <span class=\"hljs-keyword\">Modify</span> the <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">apply</span> worker, <span class=\"hljs-keyword\">to</span> properly handle streamed<br>    <span class=\"hljs-keyword\">in</span>-progress <span class=\"hljs-keyword\">transaction</span> <span class=\"hljs-keyword\">by</span> spilling the <span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">to</span> disk <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">then</span><br>    replaying them <span class=\"hljs-keyword\">on</span> commit.<br><br>    We however must explicitly <span class=\"hljs-keyword\">disable</span> streaming <span class=\"hljs-keyword\">replication</span> during<br>    <span class=\"hljs-keyword\">replication</span> slot <span class=\"hljs-keyword\">creation</span>, even <span class=\"hljs-keyword\">if</span> the <span class=\"hljs-keyword\">plugin</span> supports it. We<br>    don<span class=\"hljs-string\">&#x27;t need to replicate the changes accumulated during this phase,</span><br><span class=\"hljs-string\">    and moreover we don&#x27;</span>t have a <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">open</span> so we<br>    don<span class=\"hljs-string\">&#x27;t have where to send the data anyway.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Tomas Vondra, Dilip Kumar and Amit Kapila</span><br><span class=\"hljs-string\">    Reviewed-by: Amit Kapila, Kuntal Ghosh and Ajin Cherian</span><br><span class=\"hljs-string\">    Tested-by: Neha Sharma, Mahendra Singh Thalor and Ajin Cherian</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"新增视图pg-backend-memory-contexts\"><a href=\"#新增视图pg-backend-memory-contexts\" class=\"headerlink\" title=\"新增视图pg_backend_memory_contexts\"></a>新增视图pg_backend_memory_contexts</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">3e98</span>c0bafb28de87ae095b341687dc082371af54 (HEAD -&gt; master, origin/master, origin/HEAD)<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Wed Aug <span class=\"hljs-number\">19</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">34</span>:<span class=\"hljs-number\">43</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> pg_backend_memory_contexts <span class=\"hljs-keyword\">system</span> <span class=\"hljs-keyword\">view</span>.<br><br>    This <span class=\"hljs-keyword\">view</span> displays the usages <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span> the memory contexts <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">server</span><br>    process attached <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">current</span> <span class=\"hljs-keyword\">session</span>. This information <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">to</span><br>    investigate the cause <span class=\"hljs-keyword\">of</span> backend-<span class=\"hljs-keyword\">local</span> memory bloat.<br><br>    This information can be <span class=\"hljs-keyword\">also</span> collected <span class=\"hljs-keyword\">by</span> calling<br>    MemoryContextStats(TopMemoryContext) via a debugger. But this technique<br>    cannot be uesd <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">some</span> environments because <span class=\"hljs-keyword\">no</span> debugger <span class=\"hljs-keyword\">is</span> available there.<br>    <span class=\"hljs-keyword\">And</span> it outputs lots <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">text</span> messages <span class=\"hljs-keyword\">and</span> it<span class=\"hljs-string\">&#x27;s not easy to analyze them.</span><br><span class=\"hljs-string\">    So, pg_backend_memory_contexts view allows us to access to backend-local</span><br><span class=\"hljs-string\">    memory contexts information more easily.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Bump catalog version.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Atsushi Torikoshi, Fujii Masao</span><br><span class=\"hljs-string\">    Reviewed-by: Tatsuhito Kasahara, Andres Freund, Daniel Gustafsson, Robert Haas, Michael Paquier</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/72a656e0f71d0860161e0b3f67e4d771@oss.nttdata.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"log-line-prefix-增加-P-显示并行leader\"><a href=\"#log-line-prefix-增加-P-显示并行leader\" class=\"headerlink\" title=\"log_line_prefix 增加 %P 显示并行leader\"></a>log_line_prefix 增加 %P 显示并行leader</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> b8fdee7d0ca8bd2165d46fb1468f75571b706a01<br>Author: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Aug <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">38</span>:<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> %P <span class=\"hljs-keyword\">to</span> log_line_prefix <span class=\"hljs-keyword\">for</span> parallel <span class=\"hljs-keyword\">group</span> leader<br><br>    This <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">for</span> monitoring purposes <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">log</span> parsing.  Similarly <span class=\"hljs-keyword\">to</span><br>    pg_stat_activity, the leader<span class=\"hljs-string\">&#x27;s PID is shown only for active parallel</span><br><span class=\"hljs-string\">    workers, minimizing the log footprint for the leaders as the equivalent</span><br><span class=\"hljs-string\">    shared memory field is set as long as a backend is alive.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Justin Pryzby</span><br><span class=\"hljs-string\">    Reviewed-by: Álvaro Herrera, Michael Paquier, Julien Rouhaud, Tom Lane</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/20200315111831.GA21492@telsasoft.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h1 id=\"增加GUC-hash-mem-multiplier\"><a href=\"#增加GUC-hash-mem-multiplier\" class=\"headerlink\" title=\"增加GUC hash_mem_multiplier\"></a>增加GUC hash_mem_multiplier</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> d6c08e29e7bc8bc3bf49764192c4a9c71fc0b097<br>Author: Peter Geoghegan &lt;pg@bowt.ie&gt;<br><span class=\"hljs-built_in\">Date</span>:   Wed Jul <span class=\"hljs-number\">29</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2020</span> <span class=\"hljs-number\">-0700</span><br><br>    <span class=\"hljs-keyword\">Add</span> hash_mem_multiplier GUC.<br><br>    <span class=\"hljs-keyword\">Add</span> a GUC that acts <span class=\"hljs-keyword\">as</span> a multiplier <span class=\"hljs-keyword\">on</span> work_mem.  It gets applied <span class=\"hljs-keyword\">when</span><br>    sizing executor node <span class=\"hljs-keyword\">hash</span> <span class=\"hljs-keyword\">tables</span> that were previously <span class=\"hljs-keyword\">size</span> constrained<br>    <span class=\"hljs-keyword\">using</span> work_mem alone.<br><br>    The <span class=\"hljs-keyword\">new</span> GUC can be used <span class=\"hljs-keyword\">to</span> preferentially give <span class=\"hljs-keyword\">hash</span>-based nodes more<br>    <span class=\"hljs-keyword\">memory</span> <span class=\"hljs-keyword\">than</span> the generic work_mem limit.  It <span class=\"hljs-keyword\">is</span> intended <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">enable</span> <span class=\"hljs-keyword\">admin</span><br>    tuning <span class=\"hljs-keyword\">of</span> the executor<span class=\"hljs-string\">&#x27;s memory usage.  Overall system throughput and</span><br><span class=\"hljs-string\">    system responsiveness can be improved by giving hash-based executor</span><br><span class=\"hljs-string\">    nodes more memory (especially over sort-based alternatives, which are</span><br><span class=\"hljs-string\">    often much less sensitive to being memory constrained).</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    The default value for hash_mem_multiplier is 1.0, which is also the</span><br><span class=\"hljs-string\">    minimum valid value.  This means that hash-based nodes continue to apply</span><br><span class=\"hljs-string\">    work_mem in the traditional way by default.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    hash_mem_multiplier is generally useful.  However, it is being added now</span><br><span class=\"hljs-string\">    due to concerns about hash aggregate performance stability for users</span><br><span class=\"hljs-string\">    that upgrade to Postgres 13 (which added disk-based hash aggregation in</span><br><span class=\"hljs-string\">    commit 1f39bce0).  While the old hash aggregate behavior risked</span><br><span class=\"hljs-string\">    out-of-memory errors, it is nevertheless likely that many users actually</span><br><span class=\"hljs-string\">    benefited.  Hash agg&#x27;</span>s previous indifference <span class=\"hljs-keyword\">to</span> work_mem during <span class=\"hljs-keyword\">query</span><br>    execution was <span class=\"hljs-keyword\">not</span> just faster; it also accidentally made aggregation<br>    resilient to grouping estimate problems (at least in cases where this<br>    didn&#x27;t <span class=\"hljs-keyword\">create</span> destabilizing <span class=\"hljs-keyword\">memory</span> pressure).<br><br>    hash_mem_multiplier can provide a certain kind <span class=\"hljs-keyword\">of</span> continuity <span class=\"hljs-keyword\">with</span> the<br>    behavior <span class=\"hljs-keyword\">of</span> Postgres <span class=\"hljs-number\">12</span> <span class=\"hljs-keyword\">hash</span> aggregates <span class=\"hljs-keyword\">in</span> cases <span class=\"hljs-keyword\">where</span> the planner<br>    incorrectly estimates that <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">groups</span> (plus related allocations) will<br>    fit <span class=\"hljs-keyword\">in</span> work_mem/hash_mem.  This seems necessary because <span class=\"hljs-keyword\">hash</span>-based<br>    aggregation <span class=\"hljs-keyword\">is</span> usually much slower <span class=\"hljs-keyword\">when</span> <span class=\"hljs-keyword\">only</span> a small fraction <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span><br>    <span class=\"hljs-keyword\">groups</span> can fit.  Even <span class=\"hljs-keyword\">when</span> it isn<span class=\"hljs-string\">&#x27;t possible to totally avoid hash</span><br><span class=\"hljs-string\">    aggregates that spill, giving hash aggregation more memory will reliably</span><br><span class=\"hljs-string\">    improve performance (the same cannot be said for external sort</span><br><span class=\"hljs-string\">    operations, which appear to be almost unaffected by memory availability</span><br><span class=\"hljs-string\">    provided it&#x27;</span>s <span class=\"hljs-keyword\">at</span> <span class=\"hljs-keyword\">least</span> possible <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> a single <span class=\"hljs-keyword\">merge</span> pass).<br><br>    The PostgreSQL <span class=\"hljs-number\">13</span> <span class=\"hljs-keyword\">release</span> notes should <span class=\"hljs-keyword\">advise</span> <span class=\"hljs-keyword\">users</span> that increasing<br>    hash_mem_multiplier can <span class=\"hljs-keyword\">help</span> <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">performance</span> regressions associated<br>    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">hash</span> aggregation.  That can be taken care <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">by</span> a later commit.<br><br>    Author: Peter Geoghegan<br>    Reviewed-<span class=\"hljs-keyword\">By</span>: Álvaro Herrera, Jeff Davis<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">20200625203629.7</span>m6yvut7eqblgmfo@alap3.anarazel.de<br>    Discussion: https://postgr.es/m/CAH2-WzmD%<span class=\"hljs-number\">2</span>Bi1pG6rc1%<span class=\"hljs-number\">2</span>BCjc4V6EaFJ_qSuKCCHVnH%<span class=\"hljs-number\">3</span>DoruqD-zqow%<span class=\"hljs-number\">40</span>mail.gmail.com<br>    Backpatch: <span class=\"hljs-number\">13</span>-, <span class=\"hljs-keyword\">where</span> disk-based <span class=\"hljs-keyword\">hash</span> aggregation was introduced.<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"pg-stat-statements-新增记录CREATE-TABLE-AS-SELECT-INTO-CREATE-MATERIALIZED-VIEW-and-FETCH-commands\"><a href=\"#pg-stat-statements-新增记录CREATE-TABLE-AS-SELECT-INTO-CREATE-MATERIALIZED-VIEW-and-FETCH-commands\" class=\"headerlink\" title=\"pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands\"></a>pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">6023</span>b7ea717ca04cf1bd53709d9c862db07eaefb<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Wed Jul <span class=\"hljs-number\">29</span> <span class=\"hljs-number\">23</span>:<span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">55</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    pg_stat_statements: track number <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">rows</span> processed <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">some</span> utility commands.<br><br>    This <span class=\"hljs-keyword\">commit</span> makes pg_stat_statements track the total number<br>    <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">rows</span> retrieved <span class=\"hljs-keyword\">or</span> affected <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">AS</span>, <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">INTO</span>,<br>    <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">FETCH</span> commands.<br><br>    Suggested-<span class=\"hljs-keyword\">by</span>: Pascal Legrand<br>    Author: Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Asif Rehman<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">1584293755198</span><span class=\"hljs-number\">-0.</span>post@n3.nabble.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"并行增强\"><a href=\"#并行增强\" class=\"headerlink\" title=\"并行增强\"></a>并行增强</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">56788</span>d2156fc32bd5737e7ac716d70e6a269b7bc<br>Author: David Rowley &lt;drowley@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Sun Jul <span class=\"hljs-number\">26</span> <span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">02</span>:<span class=\"hljs-number\">45</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">1200</span><br><br>    <span class=\"hljs-keyword\">Allocate</span> consecutive blocks during <span class=\"hljs-keyword\">parallel</span> seqscans<br><br>    Previously we would <span class=\"hljs-keyword\">allocate</span> blocks <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">parallel</span> workers during a <span class=\"hljs-keyword\">parallel</span><br>    <span class=\"hljs-keyword\">sequential</span> <span class=\"hljs-keyword\">scan</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">block</span> <span class=\"hljs-keyword\">at</span> a time.  Since other workers were likely <span class=\"hljs-keyword\">to</span><br>    request a <span class=\"hljs-keyword\">block</span> <span class=\"hljs-keyword\">before</span> a worker <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-keyword\">for</span> another <span class=\"hljs-keyword\">block</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">work</span><br>    <span class=\"hljs-keyword\">on</span>, this could <span class=\"hljs-keyword\">lead</span> <span class=\"hljs-keyword\">to</span> non-<span class=\"hljs-keyword\">sequential</span> I/O patterns <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">each</span> worker which<br>    could cause the operating <span class=\"hljs-keyword\">system</span><span class=\"hljs-string\">&#x27;s readahead to perform poorly or not at</span><br><span class=\"hljs-string\">    all.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Here we change things so that we allocate consecutive &quot;chunks&quot; of blocks</span><br><span class=\"hljs-string\">    to workers and have them work on those until they&#x27;</span>re done, <span class=\"hljs-keyword\">at</span> which <span class=\"hljs-built_in\">time</span><br>    we <span class=\"hljs-keyword\">allocate</span> another <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">for</span> the worker.  The <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> these chunks <span class=\"hljs-keyword\">is</span><br>    based <span class=\"hljs-keyword\">on</span> the <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> the relation.<br><br>    <span class=\"hljs-keyword\">Initial</span> <span class=\"hljs-keyword\">patch</span> here was <span class=\"hljs-keyword\">by</span> Thomas Munro which showed <span class=\"hljs-keyword\">some</span> good improvements<br>    just <span class=\"hljs-keyword\">having</span> a <span class=\"hljs-keyword\">fixed</span> <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-number\">64</span> blocks <span class=\"hljs-keyword\">with</span> a simple ramp-down near<br>    the <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">of</span> the scan. The revisions <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">patch</span> <span class=\"hljs-keyword\">to</span> make the <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">size</span><br>    based <span class=\"hljs-keyword\">on</span> the relation <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">and</span> the adjusted ramp-down <span class=\"hljs-keyword\">in</span> powers <span class=\"hljs-keyword\">of</span> two was<br>    done <span class=\"hljs-keyword\">by</span> me, along <span class=\"hljs-keyword\">with</span> quite extensive benchmarking <span class=\"hljs-keyword\">to</span> determine the<br>    <span class=\"hljs-keyword\">optimal</span> <span class=\"hljs-keyword\">chunk</span> sizes.<br><br>    <span class=\"hljs-keyword\">For</span> the most part, benchmarks have shown significant <span class=\"hljs-keyword\">performance</span><br>    improvements <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">large</span> <span class=\"hljs-keyword\">parallel</span> <span class=\"hljs-keyword\">sequential</span> scans <span class=\"hljs-keyword\">on</span> Linux, FreeBSD <span class=\"hljs-keyword\">and</span><br>    Windows <span class=\"hljs-keyword\">using</span> SSDs.  It<span class=\"hljs-string\">&#x27;s less clear how this affects the performance of</span><br><span class=\"hljs-string\">    cloud providers.  Tests done so far are unable to obtain stable enough</span><br><span class=\"hljs-string\">    performance to provide meaningful benchmark results.  It is possible that</span><br><span class=\"hljs-string\">    this could cause some performance regressions on more obscure filesystems,</span><br><span class=\"hljs-string\">    so we may need to later provide users with some ability to get something</span><br><span class=\"hljs-string\">    closer to the old behavior.  For now, let&#x27;</span>s leave that <span class=\"hljs-keyword\">until</span> we see that<br>    it<span class=\"hljs-string\">&#x27;s really required.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Thomas Munro, David Rowley</span><br><span class=\"hljs-string\">    Reviewed-by: Ranier Vilela, Soumyadeep Chakraborty, Robert Haas</span><br><span class=\"hljs-string\">    Reviewed-by: Amit Kapila, Kirk Jamison</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/CA+hUKGJ_EErDv41YycXcbMbCBkztA34+z1ts9VQH+ACRuvpxig@mail.gmail.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"GUC-enable-hashagg-disk\"><a href=\"#GUC-enable-hashagg-disk\" class=\"headerlink\" title=\"GUC enable_hashagg_disk\"></a>GUC enable_hashagg_disk</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> bcbf<span class=\"hljs-number\">9446</span>a<span class=\"hljs-number\">2983</span>b<span class=\"hljs-number\">6452</span>c<span class=\"hljs-number\">19</span>cc<span class=\"hljs-number\">50050456</span>be<span class=\"hljs-number\">262</span>f<span class=\"hljs-number\">7</span>c<span class=\"hljs-number\">5</span><br><span class=\"hljs-attribute\">Author</span>: Peter Geoghegan &lt;pg@bowt.ie&gt;<br><span class=\"hljs-attribute\">Date</span>:   Mon Jul <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">17</span>:<span class=\"hljs-number\">53</span>:<span class=\"hljs-number\">19</span> <span class=\"hljs-number\">2020</span> -<span class=\"hljs-number\">0700</span><br><br>    <span class=\"hljs-attribute\">Remove</span> hashagg_avoid_disk_plan GUC.<br><br>    <span class=\"hljs-attribute\">Note</span>: This GUC was originally named enable_hashagg_disk when it appeared<br>    <span class=\"hljs-attribute\">in</span> commit <span class=\"hljs-number\">1</span>f<span class=\"hljs-number\">39</span>bce<span class=\"hljs-number\">0</span>, which added disk-based hash aggregation.  It was<br>    <span class=\"hljs-attribute\">subsequently</span> renamed in commit <span class=\"hljs-number\">92</span>c<span class=\"hljs-number\">58</span>fd<span class=\"hljs-number\">9</span>.<br><br>    <span class=\"hljs-attribute\">Author</span>: Peter Geoghegan<br>    <span class=\"hljs-attribute\">Reviewed</span>-By: Jeff Davis, Álvaro Herrera<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">9</span>d<span class=\"hljs-number\">9</span>d<span class=\"hljs-number\">1</span>e<span class=\"hljs-number\">1252</span>a<span class=\"hljs-number\">52</span>ea<span class=\"hljs-number\">1</span>bad<span class=\"hljs-number\">84</span>ea<span class=\"hljs-number\">40</span>dbebfd<span class=\"hljs-number\">54</span>e<span class=\"hljs-number\">672</span>a<span class=\"hljs-number\">0</span>f.camel%<span class=\"hljs-number\">40</span>j-davis.com<br>    <span class=\"hljs-attribute\">Backpatch</span>: <span class=\"hljs-number\">13</span>-, where disk-based hash aggregation was introduced.<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"logical-decoding-output-plugin-API\"><a href=\"#logical-decoding-output-plugin-API\" class=\"headerlink\" title=\"logical decoding output plugin API\"></a>logical decoding output plugin API</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">45</span>fdc9738b36d1068d3ad8fdb06436d6fd14436b<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Tue Jul <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">06</span>:<span class=\"hljs-number\">44</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0530</span><br><br>    Extend the <span class=\"hljs-keyword\">logical</span> decoding <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> API <span class=\"hljs-keyword\">with</span> stream methods.<br><br>    This adds seven methods <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> API, adding support <span class=\"hljs-keyword\">for</span><br>    streaming changes <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">large</span> <span class=\"hljs-keyword\">in</span>-progress transactions.<br><br>    * stream_start<br>    * stream_stop<br>    * stream_abort<br>    * stream_commit<br>    * stream_change<br>    * stream_message<br>    * stream_truncate<br><br>    Most <span class=\"hljs-keyword\">of</span> this <span class=\"hljs-keyword\">is</span> a simple extension <span class=\"hljs-keyword\">of</span> the existing methods, <span class=\"hljs-keyword\">with</span><br>    the semantic <span class=\"hljs-keyword\">difference</span> that the <span class=\"hljs-keyword\">transaction</span> (<span class=\"hljs-keyword\">or</span> subtransaction)<br>    <span class=\"hljs-keyword\">is</span> incomplete <span class=\"hljs-keyword\">and</span> may be aborted later (which <span class=\"hljs-keyword\">is</span> something the<br>    regular API does <span class=\"hljs-keyword\">not</span> really need <span class=\"hljs-keyword\">to</span> deal <span class=\"hljs-keyword\">with</span>).<br><br>    This also extends the <span class=\"hljs-string\">&#x27;test_decoding&#x27;</span> <span class=\"hljs-keyword\">plugin</span>, implementing these<br>    <span class=\"hljs-keyword\">new</span> stream methods.<br><br>    The stream_start/start_stop <span class=\"hljs-keyword\">are</span> used <span class=\"hljs-keyword\">to</span> demarcate a <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">of</span> changes<br>    streamed <span class=\"hljs-keyword\">for</span> a particular toplevel transaction.<br><br>    This <span class=\"hljs-keyword\">commit</span> simply adds these <span class=\"hljs-keyword\">new</span> APIs <span class=\"hljs-keyword\">and</span> the upcoming <span class=\"hljs-keyword\">patch</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;allow</span><br><span class=\"hljs-string\">    the streaming mode in ReorderBuffer&quot;</span> will <span class=\"hljs-keyword\">use</span> these APIs.<br><br>    Author: Tomas Vondra, Dilip Kumar, Amit Kapila<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Amit Kapila<br>    Tested-<span class=\"hljs-keyword\">by</span>: Neha Sharma <span class=\"hljs-keyword\">and</span> Mahendra Singh Thalor<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">688</span>b0b7f<span class=\"hljs-number\">-2</span>f6c-d827-c27b<span class=\"hljs-number\">-216</span>a8e3ea700@<span class=\"hljs-number\">2</span>ndquadrant.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"wal-keep-segments-改名为-wal-keep-size\"><a href=\"#wal-keep-segments-改名为-wal-keep-size\" class=\"headerlink\" title=\"wal_keep_segments 改名为 wal_keep_size.\"></a>wal_keep_segments 改名为 wal_keep_size.</h1><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livecodeserver\">commit c3fe108c025e4a080315562d4c15ecbe3f00405e<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br>Date:   Mon Jul <span class=\"hljs-number\">20</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">18</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    Rename wal_keep_segments <span class=\"hljs-built_in\">to</span> wal_keep_size.<br><br>    max_slot_wal_keep_size that was added <span class=\"hljs-keyword\">in</span> v13 <span class=\"hljs-keyword\">and</span> wal_keep_segments are<br>    <span class=\"hljs-keyword\">the</span> GUC parameters <span class=\"hljs-built_in\">to</span> specify how much WAL <span class=\"hljs-built_in\">files</span> <span class=\"hljs-built_in\">to</span> retain <span class=\"hljs-keyword\">for</span><br>    <span class=\"hljs-keyword\">the</span> standby servers. While max_slot_wal_keep_size accepts <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span><br>    <span class=\"hljs-keyword\">bytes</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>, wal_keep_segments accepts <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>.<br>    This <span class=\"hljs-built_in\">difference</span> <span class=\"hljs-keyword\">of</span> setting units between those similar parameters could<br>    be confusing <span class=\"hljs-built_in\">to</span> users.<br><br>    To alleviate this situation, this commit renames wal_keep_segments <span class=\"hljs-built_in\">to</span><br>    wal_keep_size, <span class=\"hljs-keyword\">and</span> make users specify <span class=\"hljs-keyword\">the</span> WAL size <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">it</span> instead <span class=\"hljs-keyword\">of</span><br>    <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>.<br><br>    There was also <span class=\"hljs-keyword\">the</span> idea <span class=\"hljs-built_in\">to</span> <span class=\"hljs-built_in\">rename</span> max_slot_wal_keep_size <span class=\"hljs-built_in\">to</span><br>    max_slot_wal_keep_segments, <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> discussion. But we have been moving<br>    away <span class=\"hljs-built_in\">from</span> measuring <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">segments</span>, <span class=\"hljs-keyword\">for</span> example, checkpoint_segments was<br>    replaced <span class=\"hljs-keyword\">by</span> max_wal_size. So we concluded <span class=\"hljs-built_in\">to</span> <span class=\"hljs-built_in\">rename</span> wal_keep_segments<br>    <span class=\"hljs-built_in\">to</span> wal_keep_size.<br><br>    Back-patch <span class=\"hljs-built_in\">to</span> v13 where max_slot_wal_keep_size was added.<br><br>    Author: Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Álvaro Herrera, Kyotaro Horiguchi, David Steele<br>    Discussion: <span class=\"hljs-keyword\">https</span>://postgr.es/m/<span class=\"hljs-number\">574</span>b4ea3-e0f9-b175-ead2-ebea7faea855@oss.nttdata.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"增加-generic-plans-and-custom-plans-域到pg-prepared-statements\"><a href=\"#增加-generic-plans-and-custom-plans-域到pg-prepared-statements\" class=\"headerlink\" title=\"增加 generic_plans and custom_plans 域到pg_prepared_statements\"></a>增加 generic_plans and custom_plans 域到pg_prepared_statements</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> d05b172a760e0ccb3008a2144f96053720000b12<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Jul <span class=\"hljs-number\">20</span> <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">55</span>:<span class=\"hljs-number\">50</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> generic_plans <span class=\"hljs-keyword\">and</span> custom_plans fields <span class=\"hljs-keyword\">into</span> pg_prepared_statements.<br><br>    There was <span class=\"hljs-keyword\">no</span> easy way <span class=\"hljs-keyword\">to</span> find how many times generic <span class=\"hljs-keyword\">and</span> custom plans<br>    have been executed <span class=\"hljs-keyword\">for</span> a <span class=\"hljs-keyword\">prepared</span> <span class=\"hljs-keyword\">statement</span>. This <span class=\"hljs-keyword\">commit</span> exposes those<br>    numbers <span class=\"hljs-keyword\">of</span> times <span class=\"hljs-keyword\">in</span> pg_prepared_statements <span class=\"hljs-keyword\">view</span>.<br><br>    Author: Atsushi Torikoshi, Kyotaro Horiguchi<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Tatsuro Yamada, Masahiro Ikeda, Fujii Masao<br>    Discussion: https://postgr.es/m/CACZ0uYHZ4M=NZpofH6JuPHeX=__5xcDELF8hT8_2T+R55w4RQw@mail.gmail.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"逻辑复制增强，-允许二进制传输数据\"><a href=\"#逻辑复制增强，-允许二进制传输数据\" class=\"headerlink\" title=\"逻辑复制增强， 允许二进制传输数据.\"></a>逻辑复制增强， 允许二进制传输数据.</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">9</span>de77b5453130242654ff0b30a551c9c862ed661<br>Author: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-built_in\">Date</span>:   Sat Jul <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">12</span>:<span class=\"hljs-number\">44</span>:<span class=\"hljs-number\">51</span> <span class=\"hljs-number\">2020</span> <span class=\"hljs-number\">-0400</span><br><br>    <span class=\"hljs-keyword\">Allow</span> <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">to</span> transfer <span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">binary</span> format.<br><br>    This <span class=\"hljs-keyword\">patch</span> adds a <span class=\"hljs-string\">&quot;binary&quot;</span> <span class=\"hljs-keyword\">option</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">CREATE</span>/<span class=\"hljs-keyword\">ALTER</span> SUBSCRIPTION.<br>    <span class=\"hljs-keyword\">When</span> that<span class=\"hljs-string\">&#x27;s set, the publisher will send data using the data type&#x27;</span>s<br>    typsend <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">any</span>, rather <span class=\"hljs-keyword\">than</span> typoutput.  This <span class=\"hljs-keyword\">is</span> generally<br>    faster, <span class=\"hljs-keyword\">if</span> slightly <span class=\"hljs-keyword\">less</span> robust.<br><br>    <span class=\"hljs-keyword\">As</span> committed, we won<span class=\"hljs-string\">&#x27;t try to transfer user-defined array or composite</span><br><span class=\"hljs-string\">    types in binary, for fear that type OIDs won&#x27;</span>t <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">at</span> the subscriber.<br>    This might be <span class=\"hljs-keyword\">changed</span> later, but it seems <span class=\"hljs-keyword\">like</span> fit material <span class=\"hljs-keyword\">for</span> a<br>    follow-<span class=\"hljs-keyword\">on</span> patch.<br><br>    Dave Cramer, reviewed <span class=\"hljs-keyword\">by</span> Daniel Gustafsson, Petr Jelinek, <span class=\"hljs-keyword\">and</span> others;<br>    adjusted some by me<br><br>    Discussion: https://postgr.es/m/CADK3HH+R3xMn=8t3Ct+uD+qJ1KD=Hbif5NFMJ+d5DkoCzp6Vgw@mail.gmail.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"huge-page-size\"><a href=\"#huge-page-size\" class=\"headerlink\" title=\"huge_page_size\"></a>huge_page_size</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> d<span class=\"hljs-number\">2</span>bddc<span class=\"hljs-number\">2500</span>fb<span class=\"hljs-number\">74</span>d<span class=\"hljs-number\">56</span>e<span class=\"hljs-number\">5</span>bc<span class=\"hljs-number\">53</span>a<span class=\"hljs-number\">1</span>cfa<span class=\"hljs-number\">269</span>e<span class=\"hljs-number\">2</span>e<span class=\"hljs-number\">846510</span><br><span class=\"hljs-attribute\">Author</span>: Thomas Munro &lt;tmunro@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Fri Jul <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">33</span>:<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">1200</span><br><br>    <span class=\"hljs-attribute\">Add</span> huge_page_size setting for use <span class=\"hljs-literal\">on</span> Linux.<br><br>    <span class=\"hljs-attribute\">This</span> allows the huge page size to be set explicitly.  The default is <span class=\"hljs-number\">0</span>,<br>    <span class=\"hljs-attribute\">meaning</span> it will use the system default, as before.<br><br>    <span class=\"hljs-attribute\">Author</span>: Odin Ugedal &lt;odin@ugedal.com&gt;<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">20200608154639</span>.<span class=\"hljs-number\">20254</span>-<span class=\"hljs-number\">1</span>-odin%<span class=\"hljs-number\">40</span>ugedal.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"jsonpath-不允许NaN\"><a href=\"#jsonpath-不允许NaN\" class=\"headerlink\" title=\"jsonpath 不允许NaN\"></a>jsonpath 不允许NaN</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> df<span class=\"hljs-number\">646509</span>f<span class=\"hljs-number\">371069</span>c<span class=\"hljs-number\">65</span>f<span class=\"hljs-number\">84309</span>eb<span class=\"hljs-number\">5749642</span>e<span class=\"hljs-number\">8650</span>b<span class=\"hljs-number\">3</span><br><span class=\"hljs-attribute\">Author</span>: Alexander Korotkov &lt;akorotkov@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sat Jul <span class=\"hljs-number\">11</span> <span class=\"hljs-number\">03</span>:<span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0300</span><br><br>    <span class=\"hljs-attribute\">Forbid</span> numeric NaN in jsonpath<br><br>    <span class=\"hljs-attribute\">SQL</span> standard doesn&#x27;t define numeric Inf or NaN values.  It appears even more<br>    <span class=\"hljs-attribute\">ridiculous</span> to support then in jsonpath assuming JSON doesn&#x27;t support these<br>    <span class=\"hljs-attribute\">values</span> as well.  This commit forbids returning NaN from .double(), which was<br>    <span class=\"hljs-attribute\">previously</span> allowed.  NaN can&#x27;t be result of inner-jsonpath computation over<br>    <span class=\"hljs-attribute\">non</span>-NaNs.  So, we can not expect NaN in the jsonpath output.<br><br>    <span class=\"hljs-attribute\">Reported</span>-by: Tom Lane<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">203949</span>.<span class=\"hljs-number\">1591879542</span>%<span class=\"hljs-number\">40</span>sss.pgh.pa.us<br>    <span class=\"hljs-attribute\">Author</span>: Alexander Korotkov<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Tom Lane<br>    <span class=\"hljs-attribute\">Backpatch</span>-through: <span class=\"hljs-number\">12</span><br><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"psql增加-d-i-m-t\"><a href=\"#psql增加-d-i-m-t\" class=\"headerlink\" title=\"psql增加\\d[i|m|t]+\"></a>psql增加\\d[i|m|t]+</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">07</span>f386ede026ae8c3f2adeba0c22139df19bf2ff<br>Author: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-built_in\">Date</span>:   Wed Sep <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">59</span>:<span class=\"hljs-number\">22</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> <span class=\"hljs-keyword\">access</span> method <span class=\"hljs-keyword\">names</span> <span class=\"hljs-keyword\">to</span> \\d[i|m|t]+ <span class=\"hljs-keyword\">in</span> psql<br><br>    Listing a <span class=\"hljs-keyword\">full</span> <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">of</span> relations <span class=\"hljs-keyword\">with</span> those psql meta-commands, <span class=\"hljs-keyword\">without</span> a<br>    matching pattern, has <span class=\"hljs-keyword\">never</span> showed the <span class=\"hljs-keyword\">access</span> method associated <span class=\"hljs-keyword\">with</span><br>    <span class=\"hljs-keyword\">each</span> relation.  This <span class=\"hljs-keyword\">commit</span> adds the <span class=\"hljs-keyword\">access</span> method <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">tables</span>, <span class=\"hljs-keyword\">indexes</span><br>    <span class=\"hljs-keyword\">and</span> matviews, masking it <span class=\"hljs-keyword\">for</span> relation kinds <span class=\"hljs-keyword\">where</span> it does <span class=\"hljs-keyword\">not</span> apply.<br><br>    Note that <span class=\"hljs-keyword\">when</span> HIDE_TABLEAM <span class=\"hljs-keyword\">is</span> enabled, the information does <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">show</span><br>    up.  This <span class=\"hljs-keyword\">is</span> available <span class=\"hljs-keyword\">when</span> connecting <span class=\"hljs-keyword\">to</span> a backend <span class=\"hljs-keyword\">version</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">at</span> <span class=\"hljs-keyword\">least</span><br>    <span class=\"hljs-number\">12</span>, <span class=\"hljs-keyword\">where</span> <span class=\"hljs-keyword\">table</span> AMs have been introduced.<br><br>    Author: Georgios Kokolatos<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Vignesh C, Michael Paquier, Justin Pryzby<br>    Discussion: https://postgr.es/m/svaS1VTOEscES9CLKVTeKItjJP1EEJuBhTsA0ESOdlnbXeQSgycYwVlliL5zt8Jwcfo4ATYDXtEqsExxjkSkkhCSTCL8fnRgaCAJdr0unUg=@protonmail.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"新增函数string-to-table\"><a href=\"#新增函数string-to-table\" class=\"headerlink\" title=\"新增函数string_to_table\"></a>新增函数string_to_table</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">Add</span> string_to_table() <span class=\"hljs-keyword\">function</span>.<br>    This splits a string at occurrences <span class=\"hljs-keyword\">of</span> a <span class=\"hljs-keyword\">delimiter</span>.  It <span class=\"hljs-keyword\">is</span> exactly <span class=\"hljs-keyword\">like</span><br>    string_to_array() <span class=\"hljs-keyword\">except</span> <span class=\"hljs-keyword\">for</span> producing a <span class=\"hljs-keyword\">set</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">values</span> <span class=\"hljs-keyword\">instead</span> <span class=\"hljs-keyword\">of</span> an<br>    <span class=\"hljs-keyword\">array</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">values</span>.  Thus, the relationship <span class=\"hljs-keyword\">of</span> these two <span class=\"hljs-keyword\">functions</span> <span class=\"hljs-keyword\">is</span><br>    the same <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">between</span> regexp_split_to_table() <span class=\"hljs-keyword\">and</span> regexp_split_to_array().<br><br>    Although the same results could be had <span class=\"hljs-keyword\">from</span> unnest(string_to_array()),<br>    this <span class=\"hljs-keyword\">is</span> somewhat faster than that, <span class=\"hljs-keyword\">and</span> anyway it seems reasonable <span class=\"hljs-keyword\">to</span><br>    have it <span class=\"hljs-keyword\">for</span> symmetry <span class=\"hljs-keyword\">with</span> the regexp <span class=\"hljs-keyword\">functions</span>.<br><br>    Pavel Stehule, reviewed <span class=\"hljs-keyword\">by</span> Peter Smith<br><br><br></code></pre></td></tr></table></figure>\n<h1 id=\"逻辑复制增加正在处理的事物中的复制\"><a href=\"#逻辑复制增加正在处理的事物中的复制\" class=\"headerlink\" title=\"逻辑复制增加正在处理的事物中的复制\"></a>逻辑复制增加正在处理的事物中的复制</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">464824323e57</span>dc4b397e8b05854d779908b55304<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Thu Sep <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">07</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">07</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0530</span><br><br>    <span class=\"hljs-keyword\">Add</span> support <span class=\"hljs-keyword\">for</span> streaming <span class=\"hljs-keyword\">to</span> built-<span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">logical</span> replication.<br><br>    <span class=\"hljs-keyword\">To</span> <span class=\"hljs-keyword\">add</span> support <span class=\"hljs-keyword\">for</span> streaming <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">in</span>-progress transactions <span class=\"hljs-keyword\">into</span> the<br>    built-<span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span>, we need <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">do</span> three things:<br><br>    * Extend the <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span> protocol, so identify <span class=\"hljs-keyword\">in</span>-progress<br>    transactions, <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">allow</span> adding additional bits <span class=\"hljs-keyword\">of</span> information (e.g.<br>    XID <span class=\"hljs-keyword\">of</span> subtransactions).<br><br>    * <span class=\"hljs-keyword\">Modify</span> the <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> (pgoutput) <span class=\"hljs-keyword\">to</span> implement the <span class=\"hljs-keyword\">new</span> stream<br>    API callbacks, <span class=\"hljs-keyword\">by</span> leveraging the <span class=\"hljs-keyword\">extended</span> <span class=\"hljs-keyword\">replication</span> protocol.<br><br>    * <span class=\"hljs-keyword\">Modify</span> the <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">apply</span> worker, <span class=\"hljs-keyword\">to</span> properly handle streamed<br>    <span class=\"hljs-keyword\">in</span>-progress <span class=\"hljs-keyword\">transaction</span> <span class=\"hljs-keyword\">by</span> spilling the <span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">to</span> disk <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">then</span><br>    replaying them <span class=\"hljs-keyword\">on</span> commit.<br><br>    We however must explicitly <span class=\"hljs-keyword\">disable</span> streaming <span class=\"hljs-keyword\">replication</span> during<br>    <span class=\"hljs-keyword\">replication</span> slot <span class=\"hljs-keyword\">creation</span>, even <span class=\"hljs-keyword\">if</span> the <span class=\"hljs-keyword\">plugin</span> supports it. We<br>    don<span class=\"hljs-string\">&#x27;t need to replicate the changes accumulated during this phase,</span><br><span class=\"hljs-string\">    and moreover we don&#x27;</span>t have a <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">connection</span> <span class=\"hljs-keyword\">open</span> so we<br>    don<span class=\"hljs-string\">&#x27;t have where to send the data anyway.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Tomas Vondra, Dilip Kumar and Amit Kapila</span><br><span class=\"hljs-string\">    Reviewed-by: Amit Kapila, Kuntal Ghosh and Ajin Cherian</span><br><span class=\"hljs-string\">    Tested-by: Neha Sharma, Mahendra Singh Thalor and Ajin Cherian</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/688b0b7f-2f6c-d827-c27b-216a8e3ea700@2ndquadrant.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"新增视图pg-backend-memory-contexts\"><a href=\"#新增视图pg-backend-memory-contexts\" class=\"headerlink\" title=\"新增视图pg_backend_memory_contexts\"></a>新增视图pg_backend_memory_contexts</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">3e98</span>c0bafb28de87ae095b341687dc082371af54 (HEAD -&gt; master, origin/master, origin/HEAD)<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Wed Aug <span class=\"hljs-number\">19</span> <span class=\"hljs-number\">15</span>:<span class=\"hljs-number\">34</span>:<span class=\"hljs-number\">43</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> pg_backend_memory_contexts <span class=\"hljs-keyword\">system</span> <span class=\"hljs-keyword\">view</span>.<br><br>    This <span class=\"hljs-keyword\">view</span> displays the usages <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span> the memory contexts <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">server</span><br>    process attached <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">current</span> <span class=\"hljs-keyword\">session</span>. This information <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">to</span><br>    investigate the cause <span class=\"hljs-keyword\">of</span> backend-<span class=\"hljs-keyword\">local</span> memory bloat.<br><br>    This information can be <span class=\"hljs-keyword\">also</span> collected <span class=\"hljs-keyword\">by</span> calling<br>    MemoryContextStats(TopMemoryContext) via a debugger. But this technique<br>    cannot be uesd <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">some</span> environments because <span class=\"hljs-keyword\">no</span> debugger <span class=\"hljs-keyword\">is</span> available there.<br>    <span class=\"hljs-keyword\">And</span> it outputs lots <span class=\"hljs-keyword\">of</span> <span class=\"hljs-type\">text</span> messages <span class=\"hljs-keyword\">and</span> it<span class=\"hljs-string\">&#x27;s not easy to analyze them.</span><br><span class=\"hljs-string\">    So, pg_backend_memory_contexts view allows us to access to backend-local</span><br><span class=\"hljs-string\">    memory contexts information more easily.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Bump catalog version.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Atsushi Torikoshi, Fujii Masao</span><br><span class=\"hljs-string\">    Reviewed-by: Tatsuhito Kasahara, Andres Freund, Daniel Gustafsson, Robert Haas, Michael Paquier</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/72a656e0f71d0860161e0b3f67e4d771@oss.nttdata.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"log-line-prefix-增加-P-显示并行leader\"><a href=\"#log-line-prefix-增加-P-显示并行leader\" class=\"headerlink\" title=\"log_line_prefix 增加 %P 显示并行leader\"></a>log_line_prefix 增加 %P 显示并行leader</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> b8fdee7d0ca8bd2165d46fb1468f75571b706a01<br>Author: Michael Paquier &lt;michael@paquier.xyz&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Aug <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">38</span>:<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> %P <span class=\"hljs-keyword\">to</span> log_line_prefix <span class=\"hljs-keyword\">for</span> parallel <span class=\"hljs-keyword\">group</span> leader<br><br>    This <span class=\"hljs-keyword\">is</span> useful <span class=\"hljs-keyword\">for</span> monitoring purposes <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">log</span> parsing.  Similarly <span class=\"hljs-keyword\">to</span><br>    pg_stat_activity, the leader<span class=\"hljs-string\">&#x27;s PID is shown only for active parallel</span><br><span class=\"hljs-string\">    workers, minimizing the log footprint for the leaders as the equivalent</span><br><span class=\"hljs-string\">    shared memory field is set as long as a backend is alive.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Justin Pryzby</span><br><span class=\"hljs-string\">    Reviewed-by: Álvaro Herrera, Michael Paquier, Julien Rouhaud, Tom Lane</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/20200315111831.GA21492@telsasoft.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>","more":"<h1 id=\"增加GUC-hash-mem-multiplier\"><a href=\"#增加GUC-hash-mem-multiplier\" class=\"headerlink\" title=\"增加GUC hash_mem_multiplier\"></a>增加GUC hash_mem_multiplier</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> d6c08e29e7bc8bc3bf49764192c4a9c71fc0b097<br>Author: Peter Geoghegan &lt;pg@bowt.ie&gt;<br><span class=\"hljs-built_in\">Date</span>:   Wed Jul <span class=\"hljs-number\">29</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">58</span> <span class=\"hljs-number\">2020</span> <span class=\"hljs-number\">-0700</span><br><br>    <span class=\"hljs-keyword\">Add</span> hash_mem_multiplier GUC.<br><br>    <span class=\"hljs-keyword\">Add</span> a GUC that acts <span class=\"hljs-keyword\">as</span> a multiplier <span class=\"hljs-keyword\">on</span> work_mem.  It gets applied <span class=\"hljs-keyword\">when</span><br>    sizing executor node <span class=\"hljs-keyword\">hash</span> <span class=\"hljs-keyword\">tables</span> that were previously <span class=\"hljs-keyword\">size</span> constrained<br>    <span class=\"hljs-keyword\">using</span> work_mem alone.<br><br>    The <span class=\"hljs-keyword\">new</span> GUC can be used <span class=\"hljs-keyword\">to</span> preferentially give <span class=\"hljs-keyword\">hash</span>-based nodes more<br>    <span class=\"hljs-keyword\">memory</span> <span class=\"hljs-keyword\">than</span> the generic work_mem limit.  It <span class=\"hljs-keyword\">is</span> intended <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">enable</span> <span class=\"hljs-keyword\">admin</span><br>    tuning <span class=\"hljs-keyword\">of</span> the executor<span class=\"hljs-string\">&#x27;s memory usage.  Overall system throughput and</span><br><span class=\"hljs-string\">    system responsiveness can be improved by giving hash-based executor</span><br><span class=\"hljs-string\">    nodes more memory (especially over sort-based alternatives, which are</span><br><span class=\"hljs-string\">    often much less sensitive to being memory constrained).</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    The default value for hash_mem_multiplier is 1.0, which is also the</span><br><span class=\"hljs-string\">    minimum valid value.  This means that hash-based nodes continue to apply</span><br><span class=\"hljs-string\">    work_mem in the traditional way by default.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    hash_mem_multiplier is generally useful.  However, it is being added now</span><br><span class=\"hljs-string\">    due to concerns about hash aggregate performance stability for users</span><br><span class=\"hljs-string\">    that upgrade to Postgres 13 (which added disk-based hash aggregation in</span><br><span class=\"hljs-string\">    commit 1f39bce0).  While the old hash aggregate behavior risked</span><br><span class=\"hljs-string\">    out-of-memory errors, it is nevertheless likely that many users actually</span><br><span class=\"hljs-string\">    benefited.  Hash agg&#x27;</span>s previous indifference <span class=\"hljs-keyword\">to</span> work_mem during <span class=\"hljs-keyword\">query</span><br>    execution was <span class=\"hljs-keyword\">not</span> just faster; it also accidentally made aggregation<br>    resilient to grouping estimate problems (at least in cases where this<br>    didn&#x27;t <span class=\"hljs-keyword\">create</span> destabilizing <span class=\"hljs-keyword\">memory</span> pressure).<br><br>    hash_mem_multiplier can provide a certain kind <span class=\"hljs-keyword\">of</span> continuity <span class=\"hljs-keyword\">with</span> the<br>    behavior <span class=\"hljs-keyword\">of</span> Postgres <span class=\"hljs-number\">12</span> <span class=\"hljs-keyword\">hash</span> aggregates <span class=\"hljs-keyword\">in</span> cases <span class=\"hljs-keyword\">where</span> the planner<br>    incorrectly estimates that <span class=\"hljs-keyword\">all</span> <span class=\"hljs-keyword\">groups</span> (plus related allocations) will<br>    fit <span class=\"hljs-keyword\">in</span> work_mem/hash_mem.  This seems necessary because <span class=\"hljs-keyword\">hash</span>-based<br>    aggregation <span class=\"hljs-keyword\">is</span> usually much slower <span class=\"hljs-keyword\">when</span> <span class=\"hljs-keyword\">only</span> a small fraction <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">all</span><br>    <span class=\"hljs-keyword\">groups</span> can fit.  Even <span class=\"hljs-keyword\">when</span> it isn<span class=\"hljs-string\">&#x27;t possible to totally avoid hash</span><br><span class=\"hljs-string\">    aggregates that spill, giving hash aggregation more memory will reliably</span><br><span class=\"hljs-string\">    improve performance (the same cannot be said for external sort</span><br><span class=\"hljs-string\">    operations, which appear to be almost unaffected by memory availability</span><br><span class=\"hljs-string\">    provided it&#x27;</span>s <span class=\"hljs-keyword\">at</span> <span class=\"hljs-keyword\">least</span> possible <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">get</span> a single <span class=\"hljs-keyword\">merge</span> pass).<br><br>    The PostgreSQL <span class=\"hljs-number\">13</span> <span class=\"hljs-keyword\">release</span> notes should <span class=\"hljs-keyword\">advise</span> <span class=\"hljs-keyword\">users</span> that increasing<br>    hash_mem_multiplier can <span class=\"hljs-keyword\">help</span> <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">performance</span> regressions associated<br>    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-keyword\">hash</span> aggregation.  That can be taken care <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">by</span> a later commit.<br><br>    Author: Peter Geoghegan<br>    Reviewed-<span class=\"hljs-keyword\">By</span>: Álvaro Herrera, Jeff Davis<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">20200625203629.7</span>m6yvut7eqblgmfo@alap3.anarazel.de<br>    Discussion: https://postgr.es/m/CAH2-WzmD%<span class=\"hljs-number\">2</span>Bi1pG6rc1%<span class=\"hljs-number\">2</span>BCjc4V6EaFJ_qSuKCCHVnH%<span class=\"hljs-number\">3</span>DoruqD-zqow%<span class=\"hljs-number\">40</span>mail.gmail.com<br>    Backpatch: <span class=\"hljs-number\">13</span>-, <span class=\"hljs-keyword\">where</span> disk-based <span class=\"hljs-keyword\">hash</span> aggregation was introduced.<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"pg-stat-statements-新增记录CREATE-TABLE-AS-SELECT-INTO-CREATE-MATERIALIZED-VIEW-and-FETCH-commands\"><a href=\"#pg-stat-statements-新增记录CREATE-TABLE-AS-SELECT-INTO-CREATE-MATERIALIZED-VIEW-and-FETCH-commands\" class=\"headerlink\" title=\"pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands\"></a>pg_stat_statements 新增记录CREATE TABLE AS, SELECT INTO,CREATE MATERIALIZED VIEW and FETCH commands</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">6023</span>b7ea717ca04cf1bd53709d9c862db07eaefb<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Wed Jul <span class=\"hljs-number\">29</span> <span class=\"hljs-number\">23</span>:<span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">55</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    pg_stat_statements: track number <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">rows</span> processed <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">some</span> utility commands.<br><br>    This <span class=\"hljs-keyword\">commit</span> makes pg_stat_statements track the total number<br>    <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">rows</span> retrieved <span class=\"hljs-keyword\">or</span> affected <span class=\"hljs-keyword\">by</span> <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">AS</span>, <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-keyword\">INTO</span>,<br>    <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">MATERIALIZED</span> <span class=\"hljs-keyword\">VIEW</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">FETCH</span> commands.<br><br>    Suggested-<span class=\"hljs-keyword\">by</span>: Pascal Legrand<br>    Author: Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Asif Rehman<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">1584293755198</span><span class=\"hljs-number\">-0.</span>post@n3.nabble.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"并行增强\"><a href=\"#并行增强\" class=\"headerlink\" title=\"并行增强\"></a>并行增强</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">56788</span>d2156fc32bd5737e7ac716d70e6a269b7bc<br>Author: David Rowley &lt;drowley@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Sun Jul <span class=\"hljs-number\">26</span> <span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">02</span>:<span class=\"hljs-number\">45</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">1200</span><br><br>    <span class=\"hljs-keyword\">Allocate</span> consecutive blocks during <span class=\"hljs-keyword\">parallel</span> seqscans<br><br>    Previously we would <span class=\"hljs-keyword\">allocate</span> blocks <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">parallel</span> workers during a <span class=\"hljs-keyword\">parallel</span><br>    <span class=\"hljs-keyword\">sequential</span> <span class=\"hljs-keyword\">scan</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">block</span> <span class=\"hljs-keyword\">at</span> a time.  Since other workers were likely <span class=\"hljs-keyword\">to</span><br>    request a <span class=\"hljs-keyword\">block</span> <span class=\"hljs-keyword\">before</span> a worker <span class=\"hljs-keyword\">returns</span> <span class=\"hljs-keyword\">for</span> another <span class=\"hljs-keyword\">block</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">work</span><br>    <span class=\"hljs-keyword\">on</span>, this could <span class=\"hljs-keyword\">lead</span> <span class=\"hljs-keyword\">to</span> non-<span class=\"hljs-keyword\">sequential</span> I/O patterns <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">each</span> worker which<br>    could cause the operating <span class=\"hljs-keyword\">system</span><span class=\"hljs-string\">&#x27;s readahead to perform poorly or not at</span><br><span class=\"hljs-string\">    all.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Here we change things so that we allocate consecutive &quot;chunks&quot; of blocks</span><br><span class=\"hljs-string\">    to workers and have them work on those until they&#x27;</span>re done, <span class=\"hljs-keyword\">at</span> which <span class=\"hljs-built_in\">time</span><br>    we <span class=\"hljs-keyword\">allocate</span> another <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">for</span> the worker.  The <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> these chunks <span class=\"hljs-keyword\">is</span><br>    based <span class=\"hljs-keyword\">on</span> the <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> the relation.<br><br>    <span class=\"hljs-keyword\">Initial</span> <span class=\"hljs-keyword\">patch</span> here was <span class=\"hljs-keyword\">by</span> Thomas Munro which showed <span class=\"hljs-keyword\">some</span> good improvements<br>    just <span class=\"hljs-keyword\">having</span> a <span class=\"hljs-keyword\">fixed</span> <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">of</span> <span class=\"hljs-number\">64</span> blocks <span class=\"hljs-keyword\">with</span> a simple ramp-down near<br>    the <span class=\"hljs-keyword\">end</span> <span class=\"hljs-keyword\">of</span> the scan. The revisions <span class=\"hljs-keyword\">of</span> the <span class=\"hljs-keyword\">patch</span> <span class=\"hljs-keyword\">to</span> make the <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">size</span><br>    based <span class=\"hljs-keyword\">on</span> the relation <span class=\"hljs-keyword\">size</span> <span class=\"hljs-keyword\">and</span> the adjusted ramp-down <span class=\"hljs-keyword\">in</span> powers <span class=\"hljs-keyword\">of</span> two was<br>    done <span class=\"hljs-keyword\">by</span> me, along <span class=\"hljs-keyword\">with</span> quite extensive benchmarking <span class=\"hljs-keyword\">to</span> determine the<br>    <span class=\"hljs-keyword\">optimal</span> <span class=\"hljs-keyword\">chunk</span> sizes.<br><br>    <span class=\"hljs-keyword\">For</span> the most part, benchmarks have shown significant <span class=\"hljs-keyword\">performance</span><br>    improvements <span class=\"hljs-keyword\">for</span> <span class=\"hljs-keyword\">large</span> <span class=\"hljs-keyword\">parallel</span> <span class=\"hljs-keyword\">sequential</span> scans <span class=\"hljs-keyword\">on</span> Linux, FreeBSD <span class=\"hljs-keyword\">and</span><br>    Windows <span class=\"hljs-keyword\">using</span> SSDs.  It<span class=\"hljs-string\">&#x27;s less clear how this affects the performance of</span><br><span class=\"hljs-string\">    cloud providers.  Tests done so far are unable to obtain stable enough</span><br><span class=\"hljs-string\">    performance to provide meaningful benchmark results.  It is possible that</span><br><span class=\"hljs-string\">    this could cause some performance regressions on more obscure filesystems,</span><br><span class=\"hljs-string\">    so we may need to later provide users with some ability to get something</span><br><span class=\"hljs-string\">    closer to the old behavior.  For now, let&#x27;</span>s leave that <span class=\"hljs-keyword\">until</span> we see that<br>    it<span class=\"hljs-string\">&#x27;s really required.</span><br><span class=\"hljs-string\"></span><br><span class=\"hljs-string\">    Author: Thomas Munro, David Rowley</span><br><span class=\"hljs-string\">    Reviewed-by: Ranier Vilela, Soumyadeep Chakraborty, Robert Haas</span><br><span class=\"hljs-string\">    Reviewed-by: Amit Kapila, Kirk Jamison</span><br><span class=\"hljs-string\">    Discussion: https://postgr.es/m/CA+hUKGJ_EErDv41YycXcbMbCBkztA34+z1ts9VQH+ACRuvpxig@mail.gmail.com</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h1 id=\"GUC-enable-hashagg-disk\"><a href=\"#GUC-enable-hashagg-disk\" class=\"headerlink\" title=\"GUC enable_hashagg_disk\"></a>GUC enable_hashagg_disk</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> bcbf<span class=\"hljs-number\">9446</span>a<span class=\"hljs-number\">2983</span>b<span class=\"hljs-number\">6452</span>c<span class=\"hljs-number\">19</span>cc<span class=\"hljs-number\">50050456</span>be<span class=\"hljs-number\">262</span>f<span class=\"hljs-number\">7</span>c<span class=\"hljs-number\">5</span><br><span class=\"hljs-attribute\">Author</span>: Peter Geoghegan &lt;pg@bowt.ie&gt;<br><span class=\"hljs-attribute\">Date</span>:   Mon Jul <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">17</span>:<span class=\"hljs-number\">53</span>:<span class=\"hljs-number\">19</span> <span class=\"hljs-number\">2020</span> -<span class=\"hljs-number\">0700</span><br><br>    <span class=\"hljs-attribute\">Remove</span> hashagg_avoid_disk_plan GUC.<br><br>    <span class=\"hljs-attribute\">Note</span>: This GUC was originally named enable_hashagg_disk when it appeared<br>    <span class=\"hljs-attribute\">in</span> commit <span class=\"hljs-number\">1</span>f<span class=\"hljs-number\">39</span>bce<span class=\"hljs-number\">0</span>, which added disk-based hash aggregation.  It was<br>    <span class=\"hljs-attribute\">subsequently</span> renamed in commit <span class=\"hljs-number\">92</span>c<span class=\"hljs-number\">58</span>fd<span class=\"hljs-number\">9</span>.<br><br>    <span class=\"hljs-attribute\">Author</span>: Peter Geoghegan<br>    <span class=\"hljs-attribute\">Reviewed</span>-By: Jeff Davis, Álvaro Herrera<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">9</span>d<span class=\"hljs-number\">9</span>d<span class=\"hljs-number\">1</span>e<span class=\"hljs-number\">1252</span>a<span class=\"hljs-number\">52</span>ea<span class=\"hljs-number\">1</span>bad<span class=\"hljs-number\">84</span>ea<span class=\"hljs-number\">40</span>dbebfd<span class=\"hljs-number\">54</span>e<span class=\"hljs-number\">672</span>a<span class=\"hljs-number\">0</span>f.camel%<span class=\"hljs-number\">40</span>j-davis.com<br>    <span class=\"hljs-attribute\">Backpatch</span>: <span class=\"hljs-number\">13</span>-, where disk-based hash aggregation was introduced.<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"logical-decoding-output-plugin-API\"><a href=\"#logical-decoding-output-plugin-API\" class=\"headerlink\" title=\"logical decoding output plugin API\"></a>logical decoding output plugin API</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">45</span>fdc9738b36d1068d3ad8fdb06436d6fd14436b<br>Author: Amit Kapila &lt;akapila@postgresql.org&gt;<br><span class=\"hljs-built_in\">Date</span>:   Tue Jul <span class=\"hljs-number\">28</span> <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">06</span>:<span class=\"hljs-number\">44</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0530</span><br><br>    Extend the <span class=\"hljs-keyword\">logical</span> decoding <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> API <span class=\"hljs-keyword\">with</span> stream methods.<br><br>    This adds seven methods <span class=\"hljs-keyword\">to</span> the <span class=\"hljs-keyword\">output</span> <span class=\"hljs-keyword\">plugin</span> API, adding support <span class=\"hljs-keyword\">for</span><br>    streaming changes <span class=\"hljs-keyword\">of</span> <span class=\"hljs-keyword\">large</span> <span class=\"hljs-keyword\">in</span>-progress transactions.<br><br>    * stream_start<br>    * stream_stop<br>    * stream_abort<br>    * stream_commit<br>    * stream_change<br>    * stream_message<br>    * stream_truncate<br><br>    Most <span class=\"hljs-keyword\">of</span> this <span class=\"hljs-keyword\">is</span> a simple extension <span class=\"hljs-keyword\">of</span> the existing methods, <span class=\"hljs-keyword\">with</span><br>    the semantic <span class=\"hljs-keyword\">difference</span> that the <span class=\"hljs-keyword\">transaction</span> (<span class=\"hljs-keyword\">or</span> subtransaction)<br>    <span class=\"hljs-keyword\">is</span> incomplete <span class=\"hljs-keyword\">and</span> may be aborted later (which <span class=\"hljs-keyword\">is</span> something the<br>    regular API does <span class=\"hljs-keyword\">not</span> really need <span class=\"hljs-keyword\">to</span> deal <span class=\"hljs-keyword\">with</span>).<br><br>    This also extends the <span class=\"hljs-string\">&#x27;test_decoding&#x27;</span> <span class=\"hljs-keyword\">plugin</span>, implementing these<br>    <span class=\"hljs-keyword\">new</span> stream methods.<br><br>    The stream_start/start_stop <span class=\"hljs-keyword\">are</span> used <span class=\"hljs-keyword\">to</span> demarcate a <span class=\"hljs-keyword\">chunk</span> <span class=\"hljs-keyword\">of</span> changes<br>    streamed <span class=\"hljs-keyword\">for</span> a particular toplevel transaction.<br><br>    This <span class=\"hljs-keyword\">commit</span> simply adds these <span class=\"hljs-keyword\">new</span> APIs <span class=\"hljs-keyword\">and</span> the upcoming <span class=\"hljs-keyword\">patch</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-string\">&quot;allow</span><br><span class=\"hljs-string\">    the streaming mode in ReorderBuffer&quot;</span> will <span class=\"hljs-keyword\">use</span> these APIs.<br><br>    Author: Tomas Vondra, Dilip Kumar, Amit Kapila<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Amit Kapila<br>    Tested-<span class=\"hljs-keyword\">by</span>: Neha Sharma <span class=\"hljs-keyword\">and</span> Mahendra Singh Thalor<br>    Discussion: https://postgr.es/m/<span class=\"hljs-number\">688</span>b0b7f<span class=\"hljs-number\">-2</span>f6c-d827-c27b<span class=\"hljs-number\">-216</span>a8e3ea700@<span class=\"hljs-number\">2</span>ndquadrant.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"wal-keep-segments-改名为-wal-keep-size\"><a href=\"#wal-keep-segments-改名为-wal-keep-size\" class=\"headerlink\" title=\"wal_keep_segments 改名为 wal_keep_size.\"></a>wal_keep_segments 改名为 wal_keep_size.</h1><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livecodeserver\">commit c3fe108c025e4a080315562d4c15ecbe3f00405e<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br>Date:   Mon Jul <span class=\"hljs-number\">20</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">30</span>:<span class=\"hljs-number\">18</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    Rename wal_keep_segments <span class=\"hljs-built_in\">to</span> wal_keep_size.<br><br>    max_slot_wal_keep_size that was added <span class=\"hljs-keyword\">in</span> v13 <span class=\"hljs-keyword\">and</span> wal_keep_segments are<br>    <span class=\"hljs-keyword\">the</span> GUC parameters <span class=\"hljs-built_in\">to</span> specify how much WAL <span class=\"hljs-built_in\">files</span> <span class=\"hljs-built_in\">to</span> retain <span class=\"hljs-keyword\">for</span><br>    <span class=\"hljs-keyword\">the</span> standby servers. While max_slot_wal_keep_size accepts <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span><br>    <span class=\"hljs-keyword\">bytes</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>, wal_keep_segments accepts <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>.<br>    This <span class=\"hljs-built_in\">difference</span> <span class=\"hljs-keyword\">of</span> setting units between those similar parameters could<br>    be confusing <span class=\"hljs-built_in\">to</span> users.<br><br>    To alleviate this situation, this commit renames wal_keep_segments <span class=\"hljs-built_in\">to</span><br>    wal_keep_size, <span class=\"hljs-keyword\">and</span> make users specify <span class=\"hljs-keyword\">the</span> WAL size <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">it</span> instead <span class=\"hljs-keyword\">of</span><br>    <span class=\"hljs-keyword\">the</span> <span class=\"hljs-built_in\">number</span> <span class=\"hljs-keyword\">of</span> WAL <span class=\"hljs-built_in\">files</span>.<br><br>    There was also <span class=\"hljs-keyword\">the</span> idea <span class=\"hljs-built_in\">to</span> <span class=\"hljs-built_in\">rename</span> max_slot_wal_keep_size <span class=\"hljs-built_in\">to</span><br>    max_slot_wal_keep_segments, <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">the</span> discussion. But we have been moving<br>    away <span class=\"hljs-built_in\">from</span> measuring <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">segments</span>, <span class=\"hljs-keyword\">for</span> example, checkpoint_segments was<br>    replaced <span class=\"hljs-keyword\">by</span> max_wal_size. So we concluded <span class=\"hljs-built_in\">to</span> <span class=\"hljs-built_in\">rename</span> wal_keep_segments<br>    <span class=\"hljs-built_in\">to</span> wal_keep_size.<br><br>    Back-patch <span class=\"hljs-built_in\">to</span> v13 where max_slot_wal_keep_size was added.<br><br>    Author: Fujii Masao<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Álvaro Herrera, Kyotaro Horiguchi, David Steele<br>    Discussion: <span class=\"hljs-keyword\">https</span>://postgr.es/m/<span class=\"hljs-number\">574</span>b4ea3-e0f9-b175-ead2-ebea7faea855@oss.nttdata.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"增加-generic-plans-and-custom-plans-域到pg-prepared-statements\"><a href=\"#增加-generic-plans-and-custom-plans-域到pg-prepared-statements\" class=\"headerlink\" title=\"增加 generic_plans and custom_plans 域到pg_prepared_statements\"></a>增加 generic_plans and custom_plans 域到pg_prepared_statements</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">commit</span> d05b172a760e0ccb3008a2144f96053720000b12<br>Author: Fujii Masao &lt;fujii@postgresql.org&gt;<br><span class=\"hljs-type\">Date</span>:   Mon Jul <span class=\"hljs-number\">20</span> <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">55</span>:<span class=\"hljs-number\">50</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0900</span><br><br>    <span class=\"hljs-keyword\">Add</span> generic_plans <span class=\"hljs-keyword\">and</span> custom_plans fields <span class=\"hljs-keyword\">into</span> pg_prepared_statements.<br><br>    There was <span class=\"hljs-keyword\">no</span> easy way <span class=\"hljs-keyword\">to</span> find how many times generic <span class=\"hljs-keyword\">and</span> custom plans<br>    have been executed <span class=\"hljs-keyword\">for</span> a <span class=\"hljs-keyword\">prepared</span> <span class=\"hljs-keyword\">statement</span>. This <span class=\"hljs-keyword\">commit</span> exposes those<br>    numbers <span class=\"hljs-keyword\">of</span> times <span class=\"hljs-keyword\">in</span> pg_prepared_statements <span class=\"hljs-keyword\">view</span>.<br><br>    Author: Atsushi Torikoshi, Kyotaro Horiguchi<br>    Reviewed-<span class=\"hljs-keyword\">by</span>: Tatsuro Yamada, Masahiro Ikeda, Fujii Masao<br>    Discussion: https://postgr.es/m/CACZ0uYHZ4M=NZpofH6JuPHeX=__5xcDELF8hT8_2T+R55w4RQw@mail.gmail.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"逻辑复制增强，-允许二进制传输数据\"><a href=\"#逻辑复制增强，-允许二进制传输数据\" class=\"headerlink\" title=\"逻辑复制增强， 允许二进制传输数据.\"></a>逻辑复制增强， 允许二进制传输数据.</h1><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">commit</span> <span class=\"hljs-number\">9</span>de77b5453130242654ff0b30a551c9c862ed661<br>Author: Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<br><span class=\"hljs-built_in\">Date</span>:   Sat Jul <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">12</span>:<span class=\"hljs-number\">44</span>:<span class=\"hljs-number\">51</span> <span class=\"hljs-number\">2020</span> <span class=\"hljs-number\">-0400</span><br><br>    <span class=\"hljs-keyword\">Allow</span> <span class=\"hljs-keyword\">logical</span> <span class=\"hljs-keyword\">replication</span> <span class=\"hljs-keyword\">to</span> transfer <span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">binary</span> format.<br><br>    This <span class=\"hljs-keyword\">patch</span> adds a <span class=\"hljs-string\">&quot;binary&quot;</span> <span class=\"hljs-keyword\">option</span> <span class=\"hljs-keyword\">to</span> <span class=\"hljs-keyword\">CREATE</span>/<span class=\"hljs-keyword\">ALTER</span> SUBSCRIPTION.<br>    <span class=\"hljs-keyword\">When</span> that<span class=\"hljs-string\">&#x27;s set, the publisher will send data using the data type&#x27;</span>s<br>    typsend <span class=\"hljs-keyword\">function</span> <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">any</span>, rather <span class=\"hljs-keyword\">than</span> typoutput.  This <span class=\"hljs-keyword\">is</span> generally<br>    faster, <span class=\"hljs-keyword\">if</span> slightly <span class=\"hljs-keyword\">less</span> robust.<br><br>    <span class=\"hljs-keyword\">As</span> committed, we won<span class=\"hljs-string\">&#x27;t try to transfer user-defined array or composite</span><br><span class=\"hljs-string\">    types in binary, for fear that type OIDs won&#x27;</span>t <span class=\"hljs-keyword\">match</span> <span class=\"hljs-keyword\">at</span> the subscriber.<br>    This might be <span class=\"hljs-keyword\">changed</span> later, but it seems <span class=\"hljs-keyword\">like</span> fit material <span class=\"hljs-keyword\">for</span> a<br>    follow-<span class=\"hljs-keyword\">on</span> patch.<br><br>    Dave Cramer, reviewed <span class=\"hljs-keyword\">by</span> Daniel Gustafsson, Petr Jelinek, <span class=\"hljs-keyword\">and</span> others;<br>    adjusted some by me<br><br>    Discussion: https://postgr.es/m/CADK3HH+R3xMn=8t3Ct+uD+qJ1KD=Hbif5NFMJ+d5DkoCzp6Vgw@mail.gmail.com<br></code></pre></td></tr></table></figure>\n<h1 id=\"huge-page-size\"><a href=\"#huge-page-size\" class=\"headerlink\" title=\"huge_page_size\"></a>huge_page_size</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> d<span class=\"hljs-number\">2</span>bddc<span class=\"hljs-number\">2500</span>fb<span class=\"hljs-number\">74</span>d<span class=\"hljs-number\">56</span>e<span class=\"hljs-number\">5</span>bc<span class=\"hljs-number\">53</span>a<span class=\"hljs-number\">1</span>cfa<span class=\"hljs-number\">269</span>e<span class=\"hljs-number\">2</span>e<span class=\"hljs-number\">846510</span><br><span class=\"hljs-attribute\">Author</span>: Thomas Munro &lt;tmunro@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Fri Jul <span class=\"hljs-number\">17</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">33</span>:<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">1200</span><br><br>    <span class=\"hljs-attribute\">Add</span> huge_page_size setting for use <span class=\"hljs-literal\">on</span> Linux.<br><br>    <span class=\"hljs-attribute\">This</span> allows the huge page size to be set explicitly.  The default is <span class=\"hljs-number\">0</span>,<br>    <span class=\"hljs-attribute\">meaning</span> it will use the system default, as before.<br><br>    <span class=\"hljs-attribute\">Author</span>: Odin Ugedal &lt;odin@ugedal.com&gt;<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">20200608154639</span>.<span class=\"hljs-number\">20254</span>-<span class=\"hljs-number\">1</span>-odin%<span class=\"hljs-number\">40</span>ugedal.com<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"jsonpath-不允许NaN\"><a href=\"#jsonpath-不允许NaN\" class=\"headerlink\" title=\"jsonpath 不允许NaN\"></a>jsonpath 不允许NaN</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">commit</span> df<span class=\"hljs-number\">646509</span>f<span class=\"hljs-number\">371069</span>c<span class=\"hljs-number\">65</span>f<span class=\"hljs-number\">84309</span>eb<span class=\"hljs-number\">5749642</span>e<span class=\"hljs-number\">8650</span>b<span class=\"hljs-number\">3</span><br><span class=\"hljs-attribute\">Author</span>: Alexander Korotkov &lt;akorotkov@postgresql.org&gt;<br><span class=\"hljs-attribute\">Date</span>:   Sat Jul <span class=\"hljs-number\">11</span> <span class=\"hljs-number\">03</span>:<span class=\"hljs-number\">21</span>:<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">2020</span> +<span class=\"hljs-number\">0300</span><br><br>    <span class=\"hljs-attribute\">Forbid</span> numeric NaN in jsonpath<br><br>    <span class=\"hljs-attribute\">SQL</span> standard doesn&#x27;t define numeric Inf or NaN values.  It appears even more<br>    <span class=\"hljs-attribute\">ridiculous</span> to support then in jsonpath assuming JSON doesn&#x27;t support these<br>    <span class=\"hljs-attribute\">values</span> as well.  This commit forbids returning NaN from .double(), which was<br>    <span class=\"hljs-attribute\">previously</span> allowed.  NaN can&#x27;t be result of inner-jsonpath computation over<br>    <span class=\"hljs-attribute\">non</span>-NaNs.  So, we can not expect NaN in the jsonpath output.<br><br>    <span class=\"hljs-attribute\">Reported</span>-by: Tom Lane<br>    <span class=\"hljs-attribute\">Discussion</span>: https://postgr.es/m/<span class=\"hljs-number\">203949</span>.<span class=\"hljs-number\">1591879542</span>%<span class=\"hljs-number\">40</span>sss.pgh.pa.us<br>    <span class=\"hljs-attribute\">Author</span>: Alexander Korotkov<br>    <span class=\"hljs-attribute\">Reviewed</span>-by: Tom Lane<br>    <span class=\"hljs-attribute\">Backpatch</span>-through: <span class=\"hljs-number\">12</span><br><br></code></pre></td></tr></table></figure>"},{"title":"pg_hint_plan","date":"2020-08-18T06:25:34.000Z","top":16,"description":null,"password":null,"_content":"\n# 名字\n\npg_hint_plan – 在注释中使用特殊格式的 hint 语句来控制查询计划.\n\n# 语法\n\nPostgresQL 使用查询规划器计算开销，查询规划器是基于数据统计的而不是静态的规则。对于一个 SQL 语句查询规划器估计每一种可能执行方法的开销，然后使用开销最低的执行方法。查询规划器使用它认为最好的执行计划，而并非真正最优的，因为它不考虑一些数据的属性，例如，列之间的关系。\n\npg_hint_plan 使用所谓的 “hint” 来调整执行计划，它可以在 SQL 注释中使用特殊的格式来简单的描述。\n\n<!-- more -->\n\n# 描述\n\n## 基本用法\n\npg_hint 在 SQL 注释的特殊格式中读取 hint 语句。特殊格式以 \"/+\" 开头以 \"/\" 结尾。hint 语句由名字和跟在后面的括号中的参数组成，参数以空格分隔。为了可读性每一个 hint 语句使用换行来分隔。\n\n在下面的例子中，哈希 join 被作为 join 的方法，使用顺数扫描作为扫描的方法。\n\n```\npostgres=# /*+\npostgres*#    HashJoin(a b)\npostgres*#    SeqScan(a)\npostgres*#  */\npostgres-# EXPLAIN SELECT *\npostgres-#    FROM pgbench_branches b\npostgres-#    JOIN pgbench_accounts a ON b.bid = a.bid\npostgres-#   ORDER BY a.aid;\n                                      QUERY PLAN\n---------------------------------------------------------------------------------------\n Sort  (cost=31465.84..31715.84 rows=100000 width=197)\n   Sort Key: a.aid\n   ->  Hash Join  (cost=1.02..4016.02 rows=100000 width=197)\n         Hash Cond: (a.bid = b.bid)\n         ->  Seq Scan on pgbench_accounts a  (cost=0.00..2640.00 rows=100000 width=97)\n         ->  Hash  (cost=1.01..1.01 rows=1 width=100)\n               ->  Seq Scan on pgbench_branches b  (cost=0.00..1.01 rows=1 width=100)\n(7 rows)\n\npostgres=#\n```\n\n## hints 的类型\n\nhint 语句通过他们影响的实体而分为四种类型。扫描方法，join 方法，join 顺序，纠正行数和 GUC 设置。对于每一种类型的hint语句有一个 hint 语句列表http://pghintplan.sourceforge.jp/hint_list.html\n\n## hint 的扫描方法\n\nhint 的扫描方法通过在表上指定一个参数来选择一种扫描方式。pg_hint 可以通过表的别名来识别一个表。他们可以是 ‘SeqScan’，‘IndexScan’ 等等。\n\nhint 扫描在普通表，继承表，UNLOGGED 表，临时表，系统表是有效的。它不能应用在外部表，表函数，命令的值（VALUES command results），CTEs，视图和子查询中。\n\n## Hints 的 join 方法\n\n使用表名作为参数的 jion 方法名来指定 Hints 的 join 方法\n\n在参数列表中可以使用普通表，继承表，UNLOGGED 表，临时表，外部表，系统表，表函数，命令的值（VALUES command results），CTEs 作为参数。但是视图和子查询不可以。\n\n## Hint 的 join 顺序\n\n可以使用 “Leading” 来指定 join 的顺序。join 的顺序将按照参数列表的给出顺序来执行。\n\n## Hint 纠正行数\n\n由于查询规划器的能力限制，它可能错误的估计一些条件下的结果集的数量。这种类型的 hint 将会纠正这种情况。\n\n## GUC 参数的临时设置\n\n在查询规划时设置 hint 来改变 GUC 的参数。在 Query Planning 指定 GUC 的参数可以在查询规划时得到预期的效果，除非其他的 hint 和查询规划器配置的参数冲突了。相同的 GUC 参数在 hint 中最后一个配置的将会生效。对于pg_hint_plan 可以通过 hint 来设置 GUC 参数，但是它不一定会按照预期的工作。详细内容可以看限制章节。\n\n# pg_hint_plan 的 GUC 参数\n\n下面的 GUC 参数会影响 pg_hint_plan 的行为.\n\n| Parameter name | description | Default |\n|--|--|--|\n| pg_hint_plan.enable_hint | Enbles or disables the function of pg_hint_plan. | on |\n| pg_hint_plan.debug_print | Enables and select the verbosity of the debug output of pg_hint_plan. off, on, detailed and verbose are valid. | off |\n| pg_hint_plan.message_level | Specifies the message level of debug prints. error, warning, notice, info, log, debug are valid and fatal and panic are inhibited. | info |\n\n对于这些 GUC 参数 PostgreSQL 9.1 需要定义一个变量类. 详细内容见 custom_variable_classes.\n\n# 安装\n\n这部分描述了安装的步骤。\n\n## 编译二进制模块\n\n在源码的根目录执行 “make”，然后使用合适的角色执行 “make install”。在这个过程中对于 PostgresQL 应该将环境变量设置为合适的值。\n```\n$ tar xzvf pg_hint_plan-1.x.x.tar.gz\n$ cd pg_hint_plan-1.x.x\n$ make\n$ su\n$ make install\n```\n\n## 加载 pg_hint_plan\n\npg_hint_plan 不需要使用 CREATE EXTENSION.只要使用 LOAD 命令将它激活，当然你也可以全局的加载它通过在 postgresql.conf 中设置 shared_preload_libraries。你也可以使用 ALTER USER SET/ALTER DATABASE SET 在指定的会话中自动的加载它。\n\n```\npostgres=# LOAD 'pg_hint_plan';\nLOAD\npostgres=#\n```\n\n如果你计划 hint 表，你需要设置 pg_hint_plan.enable_hint_tables 值为 on。\n\n## 卸载\n\n如果你使用源码安装了 pg_hint_plan，你可以在源码的根目录使用 \"make uninstall\" 来卸载安装的文件。\n\n```\n$ cd pg_hint_plan-1.x.x\n$ su\n# make uninstall\n```\n\n# Hint 描述\n\n这部分描述了怎么写各种类型的 hints。\n\n## 扫描方法 hints\n\n扫描 hints 使用一个参数去指定目标对象。使用索引作为参数最好使用索引名。目标对象如果有别名参数应该指定为别名。在下面的例子中 table1 使用顺序扫描，table2 使用主键索引扫描。\n\n```\npostgres=# /*+\npostgres*#     SeqScan(t1)\npostgres*#     IndexScan(t2 t2_pkey)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1 JOIN table table2 t2 ON (t1.key = t2.key);\n```\n\n## Join hints\n\njoin hints 使用两个或多个组成 join 的对象作为参数。如果指定了三个对象，hint 将会 join 两个对象后再 join 他们中的一个。在下面的例子中，首先使用嵌套循环 join talbe1 和 table2，然后使用合并 join 前面的结果和 table3.\n```\npostgres=# /*+\npostgres*#     NestLoop(t1 t2)\npostgres*#     MergeJoin(t1 t2 t3)\npostgres*#     Leading(t1 t2 t3)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1\npostgres-#     JOIN table table2 t2 ON (t1.key = t2.key)\npostgres-#     JOIN table table3 t3 ON (t2.key = t3.key);\n\n```\n\n## join 顺序\n\n尽管先 join table2 和 table3 然后 join table1 这种情况可能出现，但是 NestLoop hint 将不会生效。\"Leading\" hint 在这种情况下可以强制改变 join 顺序。在上面的例子中 Leading hint 改变 join 顺序为 table1,2,3 然后这两种 join 方法都会生效。\n\n上面 Leading hint 的形式改变了 join 的顺序，但是查询规划器的 join 顺序是自左至右的。如果你想改变 join 的方向，第二种方法是有效的。\n\n```\npostgres=# /*+ Leading((t1 (t2 t3))) */ SELECT...\n```\n\n每对括号包括两个元素，可以是对象也可以是嵌套的括号。括号中的第一个元素是驱动者或外部表，第二个是被驱动或者内部。\n\n## hints 纠正结果集数量\n\n如果查询规划器错误的估计了在一些条件下join返回的结果集数量。这个 hint 可以通过几种方法来纠正这个值，包括绝对值，加减和乘法。参数是组成 join 的对象和操作。下面的例子通过4个例子给出了纠正 a join b 返回的值数量的用法。\n\n```\npostgres=# /*+ Rows(a b #10) */ SELECT... ; Sets rows of join result to 10\npostgres=# /*+ Rows(a b +10) */ SELECT... ; Increments row number by 10\npostgres=# /*+ Rows(a b -10) */ SELECT... ; Subtracts 10 from the row number.\npostgres=# /*+ Rows(a b *10) */ SELECT... ; Makes the number 10 times larger.\n```\n\n## GUC 临时设置\n\n在目标语句设置查询规划器使用的 GUC 参数，下面的列子，在该查询中设置查询规划器使用 random_page_cost 的值为 2.0\n\n```\npostgres=# /*+\npostgres*#     Set(random_page_cost 2.0)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1 WHERE key = 'value';\n...\n\n```\n\n# Hint 语法\n\n## Hint 注释位置\n\npg_hint_plan 在第一个注释块读取 hint，在这个注释块中只允许有字母，数字，空格，下划线，逗号，和括号。在下面的例子中 HashJoin(a b) and SeqScan(a) 被认为是 hint 而 IndexScan(a) and MergeJoin(a b) 不是 hint.\n\n```\npostgres=# /*+\npostgres*#    HashJoin(a b)\npostgres*#    SeqScan(a)\npostgres*#  */\npostgres-# /*+ IndexScan(a) */\npostgres-# EXPLAIN SELECT /*+ MergeJoin(a b) */ *\npostgres-#    FROM pgbench_branches b\npostgres-#    JOIN pgbench_accounts a ON b.bid = a.bid\npostgres-#   ORDER BY a.aid;\n                                      QUERY PLAN\n---------------------------------------------------------------------------------------\n Sort  (cost=31465.84..31715.84 rows=100000 width=197)\n   Sort Key: a.aid\n   ->  Hash Join  (cost=1.02..4016.02 rows=100000 width=197)\n         Hash Cond: (a.bid = b.bid)\n         ->  Seq Scan on pgbench_accounts a  (cost=0.00..2640.00 rows=100000 width=97)\n         ->  Hash  (cost=1.01..1.01 rows=1 width=100)\n               ->  Seq Scan on pgbench_branches b  (cost=0.00..1.01 rows=1 width=100)\n(7 rows)\n\npostgres=#\n```\n\n在对象名字中转义特殊的字符\n\n作为 hint 参数的对象如果包括括号，双引号和空格应该使用双引号。和 PostgresQL 的转义规则相同。\n\n使用相同名字表之间的区分\n\n同一对象使用重复的名字出现多次和在不同表空间中使用相同名字的对象可以通过使用别名来区别，并且在 hint 语句中使用这些别名。下面的例子第一个 SQL 语句因为在查询语句中使用一个表名两次而导致了错误，而第二个语句可以正常工作因为 t1 每次出现使用了不同的别名并且在 HashJoin hint 中使用了别名。\n\n```\npostgres=# /*+ HashJoin(t1 t1)*/\npostgres-# EXPLAIN SELECT * FROM s1.t1\npostgres-# JOIN public.t1 ON (s1.t1.id=public.t1.id);\nINFO:  hint syntax error at or near \"HashJoin(t1 t1)\"\nDETAIL:  Relation name \"t1\" is ambiguous.\n                            QUERY PLAN\n------------------------------------------------------------------\n Merge Join  (cost=337.49..781.49 rows=28800 width=8)\n   Merge Cond: (s1.t1.id = public.t1.id)\n   ->  Sort  (cost=168.75..174.75 rows=2400 width=4)\n         Sort Key: s1.t1.id\n         ->  Seq Scan on t1  (cost=0.00..34.00 rows=2400 width=4)\n   ->  Sort  (cost=168.75..174.75 rows=2400 width=4)\n         Sort Key: public.t1.id\n         ->  Seq Scan on t1  (cost=0.00..34.00 rows=2400 width=4)\n(8 行)\n\npostgres=# /*+ HashJoin(pt st) */\npostgres-# EXPLAIN SELECT * FROM s1.t1 st\npostgres-# JOIN public.t1 pt ON (st.id=pt.id);\n                             QUERY PLAN\n---------------------------------------------------------------------\n Hash Join  (cost=64.00..1112.00 rows=28800 width=8)\n   Hash Cond: (st.id = pt.id)\n   ->  Seq Scan on t1 st  (cost=0.00..34.00 rows=2400 width=4)\n   ->  Hash  (cost=34.00..34.00 rows=2400 width=4)\n         ->  Seq Scan on t1 pt  (cost=0.00..34.00 rows=2400 width=4)\n(5 行)\n\npostgres=#\n\n```\n\n# 限制\n\n## 在 from 子句中多种值的限制\n\n无论是语法中给定别名还是在 explain 中显示的描述，所有在 from 子句中出现的值都具有相同的名字 \"VALUES\"。所以如果他们在目标查询中出现两次及以上将不能使用 hints。\n\n## 在继承表上的使用\n\n继承表不能单独的使用 hint。他们和他们父表共享相同的 hint。\n\n## 通过设置 hint 来设置 pg_hint_plan 参数\n\npg_hint_plan 参数改变了它原来的行为所以一些参数不能按照期待的执行。\n\n    hint 改变了 enalbe_hint,enable_hint_tables 被忽略了，但是他们在 debug 日志中记录为 “used hints”。\n    设置 debug_print 和 message_level 工作在目标查询的中间处理。\n\n# hint 在目标语句中使用方法\n\n## hint 在查询语句中隐含实体的使用\n\nHint 对于任何带有目的名字的对象都是有效的，即使他们没有出现在查询语句中，例如在视图里的对象。这样如果你想使用不同于第一个视图的 hint 你可以在不同的视图对同一对象使用不用的别名。\n\n在下面的例子中，在第一个查询中出现的两个表中使用了相同的名字 t1,所以 hint SeqScan(t1) 将会在两次扫描中生效。另一方面第二个语句中在这两个出现的表中使用了不同的名字 t3 所以 hint 只影响这一个扫描。\n\n这个机制也可以应用在两个重写的查询语句中。\n\n```\npostgres=# CREATE VIEW view1 AS SELECT * FROM table1 t1;\nCREATE TABLE\npostgres=# /*+ SeqScan(t1) */\npostgres=# EXPLAIN SELECT * FROM table1 t1 JOIN view1 t2 ON (t1.key = t2.key) WHERE t2.key = 1;\n                           QUERY PLAN\n-----------------------------------------------------------------\n Nested Loop  (cost=0.00..358.01 rows=1 width=16)\n   ->  Seq Scan on table1 t1  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n   ->  Seq Scan on table1 t1  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n(5 rows)\n\npostgres=# /*+ SeqScan(t3) */\npostgres=# EXPLAIN SELECT * FROM table1 t3 JOIN view1 t2 ON (t1.key = t2.key) WHERE t2.key = 1;\n                                   QUERY PLAN\n--------------------------------------------------------------------------------\n Nested Loop  (cost=0.00..187.29 rows=1 width=16)\n   ->  Seq Scan on table1 t3  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n   ->  Index Scan using foo_pkey on table1 t1  (cost=0.00..8.28 rows=1 width=8)\n         Index Cond: (key = 1)\n(5 rows)\n```\n\n## Hint 在继承中的使用\n\nhint 作用在父表将自动影响它的所有孩子。子表不能自己指定自己的 hint。\n\n## hint 在多条语句中的作用范围\n\n一个多语句描述只能有一个 hint 注释并且这个注释会作用在这个多语句的所有单条语句上。注意在一个交互的 psql 的看似多语句实际上是一系列单条语句，所以 hint 只作用在跟在它后面的一条语句。相反每一个单条语句有他们自己的 hint 注释。\n\n## 在一些上下文中的子查询\n\n在下面的上下文中子查询也可以使用 hint。\n\nIN (SELECT ... {LIMIT | OFFSET ...} ...)\n= ANY (SELECT ... {LIMIT | OFFSET ...} ...)\n= SOME (SELECT ... {LIMIT | OFFSET ...} ...)\n\n对于这些语法，当计划 jion 子查询结果时，查询规划器内部分配子查询的名字为 “ANY subquery”，所以 join hint 使用隐含的名字作用在这些 join 中。\n\n```\npostgres=# /*+HashJoin(a1 ANY_subquery)*/\npostgres=# EXPLAIN SELECT *\npostgres=#    FROM pgbench_accounts a1\npostgres=#   WHERE aid IN (SELECT bid FROM pgbench_accounts a2 LIMIT 10);\n                                         QUERY PLAN\n\n---------------------------------------------------------------------------------------------\n Hash Semi Join  (cost=0.49..2903.00 rows=1 width=97)\n   Hash Cond: (a1.aid = a2.bid)\n   ->  Seq Scan on pgbench_accounts a1  (cost=0.00..2640.00 rows=100000 width=97)\n   ->  Hash  (cost=0.36..0.36 rows=10 width=4)\n         ->  Limit  (cost=0.00..0.26 rows=10 width=4)\n               ->  Seq Scan on pgbench_accounts a2  (cost=0.00..2640.00 rows=100000 width=4)\n(6 rows)\n```\n\n## 使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)\n\n如果你在一个表上使用 IndexOnlyScan hint 你应该明确的指定一个能执行仅扫描的索引，而其他的索引不能执行仅扫描。否则 pg_hint_plan 可能会选择他们.\n\n## NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)\n\nNoIndexScan hint 涉及到 NoIndexOnlyScan.\n\n# hints 的错误处理\n\n在大多数情况下 pg_hint_plan 停止解析任何错误并且使用 hints 已经解析的内容。下面是一些典型的错误。\n\n## 语法错误\n\n任何语法错误或者错误的 hint 名字被记录为语法错误。如果 pg_hint_plan.debug_print 被设置为 on 这些错误将会记录在服务器的日志中，并使用 pg_hint_plan.message_level 中指定的信息级别。\n\n## 错误规格\n\n对象的错误规格将会导致被 hints 忽略。这种错误竟会和语法错误一样在日志中被记录为 “not used hints”。\n\n## 冗余或冲突的 hints\n\n当冗余 hints 或者互相冲突的 hint 出现时最后一个 hint 将会生效。这种错误将会和语法错误一样在日志中被记录为 “duplication hints”。\n\n## 嵌套注释\n\n在 hint 的注释内不能嵌套另一个注释。如果 pg_hint_plan 发现这种情况，不同于其它错误的处理方法，它停止解析并且放弃已经解析的所有 hint。这种错误和其他错误以一样的方式记录。\n\n# 函数限制\n\n## GUC 参数对查询规划器的影响\n\n对于 FROM 子句的数量超过了 from_collapse_limit 的情况，查询规划器不会考虑 join 的顺序。在这种情况下 pg_hint_plan 不会影响 join 的顺序。\n\n## pg_hint_plan 本质上无效的情况\n\n因为 pg_hint_plan 性质，它对查询规划器作用范围之外的情况是无效的，包括下面的情况：\n\n- 使用嵌套循环的 FULL OUTER JOIN\n- 没有使用索引资格的列去使用索引\n- 不带 ctid 条件的查询做 TID 扫描\n\n## 在 ECPG 程序中的查询\n\n在嵌入式 SQL 语句中 ECPG 删除了查询语句中的注释所以 hints 不能传给这些查询语句。唯一的方法是通过命令传 给定的未修改的字符串。在这种情况下需要考虑 hint 表。\n\n## 查询指纹的影响\n\n相同的查询使用不同的注释在 PostgresQL 9.2及以后会产生相同的指纹，但是他们在9.1及以前会产生不同的指纹，带有不同 hint 的相同的查询在这个版本被作为单独查询。\n\n# 英文版\n\nhttp://pghintplan.sourceforge.jp/pg_hint_plan.html\n","source":"_posts/pg_hint_plan.md","raw":"---\ntitle: pg_hint_plan \ndate: 2020-08-18 14:25:34\ntags: \n- pg_hint_plan\n- PostgreSQL\ncategories: \n- PostgreSQL\ntop: 16\ndescription: \npassword: \n\n---\n\n# 名字\n\npg_hint_plan – 在注释中使用特殊格式的 hint 语句来控制查询计划.\n\n# 语法\n\nPostgresQL 使用查询规划器计算开销，查询规划器是基于数据统计的而不是静态的规则。对于一个 SQL 语句查询规划器估计每一种可能执行方法的开销，然后使用开销最低的执行方法。查询规划器使用它认为最好的执行计划，而并非真正最优的，因为它不考虑一些数据的属性，例如，列之间的关系。\n\npg_hint_plan 使用所谓的 “hint” 来调整执行计划，它可以在 SQL 注释中使用特殊的格式来简单的描述。\n\n<!-- more -->\n\n# 描述\n\n## 基本用法\n\npg_hint 在 SQL 注释的特殊格式中读取 hint 语句。特殊格式以 \"/+\" 开头以 \"/\" 结尾。hint 语句由名字和跟在后面的括号中的参数组成，参数以空格分隔。为了可读性每一个 hint 语句使用换行来分隔。\n\n在下面的例子中，哈希 join 被作为 join 的方法，使用顺数扫描作为扫描的方法。\n\n```\npostgres=# /*+\npostgres*#    HashJoin(a b)\npostgres*#    SeqScan(a)\npostgres*#  */\npostgres-# EXPLAIN SELECT *\npostgres-#    FROM pgbench_branches b\npostgres-#    JOIN pgbench_accounts a ON b.bid = a.bid\npostgres-#   ORDER BY a.aid;\n                                      QUERY PLAN\n---------------------------------------------------------------------------------------\n Sort  (cost=31465.84..31715.84 rows=100000 width=197)\n   Sort Key: a.aid\n   ->  Hash Join  (cost=1.02..4016.02 rows=100000 width=197)\n         Hash Cond: (a.bid = b.bid)\n         ->  Seq Scan on pgbench_accounts a  (cost=0.00..2640.00 rows=100000 width=97)\n         ->  Hash  (cost=1.01..1.01 rows=1 width=100)\n               ->  Seq Scan on pgbench_branches b  (cost=0.00..1.01 rows=1 width=100)\n(7 rows)\n\npostgres=#\n```\n\n## hints 的类型\n\nhint 语句通过他们影响的实体而分为四种类型。扫描方法，join 方法，join 顺序，纠正行数和 GUC 设置。对于每一种类型的hint语句有一个 hint 语句列表http://pghintplan.sourceforge.jp/hint_list.html\n\n## hint 的扫描方法\n\nhint 的扫描方法通过在表上指定一个参数来选择一种扫描方式。pg_hint 可以通过表的别名来识别一个表。他们可以是 ‘SeqScan’，‘IndexScan’ 等等。\n\nhint 扫描在普通表，继承表，UNLOGGED 表，临时表，系统表是有效的。它不能应用在外部表，表函数，命令的值（VALUES command results），CTEs，视图和子查询中。\n\n## Hints 的 join 方法\n\n使用表名作为参数的 jion 方法名来指定 Hints 的 join 方法\n\n在参数列表中可以使用普通表，继承表，UNLOGGED 表，临时表，外部表，系统表，表函数，命令的值（VALUES command results），CTEs 作为参数。但是视图和子查询不可以。\n\n## Hint 的 join 顺序\n\n可以使用 “Leading” 来指定 join 的顺序。join 的顺序将按照参数列表的给出顺序来执行。\n\n## Hint 纠正行数\n\n由于查询规划器的能力限制，它可能错误的估计一些条件下的结果集的数量。这种类型的 hint 将会纠正这种情况。\n\n## GUC 参数的临时设置\n\n在查询规划时设置 hint 来改变 GUC 的参数。在 Query Planning 指定 GUC 的参数可以在查询规划时得到预期的效果，除非其他的 hint 和查询规划器配置的参数冲突了。相同的 GUC 参数在 hint 中最后一个配置的将会生效。对于pg_hint_plan 可以通过 hint 来设置 GUC 参数，但是它不一定会按照预期的工作。详细内容可以看限制章节。\n\n# pg_hint_plan 的 GUC 参数\n\n下面的 GUC 参数会影响 pg_hint_plan 的行为.\n\n| Parameter name | description | Default |\n|--|--|--|\n| pg_hint_plan.enable_hint | Enbles or disables the function of pg_hint_plan. | on |\n| pg_hint_plan.debug_print | Enables and select the verbosity of the debug output of pg_hint_plan. off, on, detailed and verbose are valid. | off |\n| pg_hint_plan.message_level | Specifies the message level of debug prints. error, warning, notice, info, log, debug are valid and fatal and panic are inhibited. | info |\n\n对于这些 GUC 参数 PostgreSQL 9.1 需要定义一个变量类. 详细内容见 custom_variable_classes.\n\n# 安装\n\n这部分描述了安装的步骤。\n\n## 编译二进制模块\n\n在源码的根目录执行 “make”，然后使用合适的角色执行 “make install”。在这个过程中对于 PostgresQL 应该将环境变量设置为合适的值。\n```\n$ tar xzvf pg_hint_plan-1.x.x.tar.gz\n$ cd pg_hint_plan-1.x.x\n$ make\n$ su\n$ make install\n```\n\n## 加载 pg_hint_plan\n\npg_hint_plan 不需要使用 CREATE EXTENSION.只要使用 LOAD 命令将它激活，当然你也可以全局的加载它通过在 postgresql.conf 中设置 shared_preload_libraries。你也可以使用 ALTER USER SET/ALTER DATABASE SET 在指定的会话中自动的加载它。\n\n```\npostgres=# LOAD 'pg_hint_plan';\nLOAD\npostgres=#\n```\n\n如果你计划 hint 表，你需要设置 pg_hint_plan.enable_hint_tables 值为 on。\n\n## 卸载\n\n如果你使用源码安装了 pg_hint_plan，你可以在源码的根目录使用 \"make uninstall\" 来卸载安装的文件。\n\n```\n$ cd pg_hint_plan-1.x.x\n$ su\n# make uninstall\n```\n\n# Hint 描述\n\n这部分描述了怎么写各种类型的 hints。\n\n## 扫描方法 hints\n\n扫描 hints 使用一个参数去指定目标对象。使用索引作为参数最好使用索引名。目标对象如果有别名参数应该指定为别名。在下面的例子中 table1 使用顺序扫描，table2 使用主键索引扫描。\n\n```\npostgres=# /*+\npostgres*#     SeqScan(t1)\npostgres*#     IndexScan(t2 t2_pkey)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1 JOIN table table2 t2 ON (t1.key = t2.key);\n```\n\n## Join hints\n\njoin hints 使用两个或多个组成 join 的对象作为参数。如果指定了三个对象，hint 将会 join 两个对象后再 join 他们中的一个。在下面的例子中，首先使用嵌套循环 join talbe1 和 table2，然后使用合并 join 前面的结果和 table3.\n```\npostgres=# /*+\npostgres*#     NestLoop(t1 t2)\npostgres*#     MergeJoin(t1 t2 t3)\npostgres*#     Leading(t1 t2 t3)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1\npostgres-#     JOIN table table2 t2 ON (t1.key = t2.key)\npostgres-#     JOIN table table3 t3 ON (t2.key = t3.key);\n\n```\n\n## join 顺序\n\n尽管先 join table2 和 table3 然后 join table1 这种情况可能出现，但是 NestLoop hint 将不会生效。\"Leading\" hint 在这种情况下可以强制改变 join 顺序。在上面的例子中 Leading hint 改变 join 顺序为 table1,2,3 然后这两种 join 方法都会生效。\n\n上面 Leading hint 的形式改变了 join 的顺序，但是查询规划器的 join 顺序是自左至右的。如果你想改变 join 的方向，第二种方法是有效的。\n\n```\npostgres=# /*+ Leading((t1 (t2 t3))) */ SELECT...\n```\n\n每对括号包括两个元素，可以是对象也可以是嵌套的括号。括号中的第一个元素是驱动者或外部表，第二个是被驱动或者内部。\n\n## hints 纠正结果集数量\n\n如果查询规划器错误的估计了在一些条件下join返回的结果集数量。这个 hint 可以通过几种方法来纠正这个值，包括绝对值，加减和乘法。参数是组成 join 的对象和操作。下面的例子通过4个例子给出了纠正 a join b 返回的值数量的用法。\n\n```\npostgres=# /*+ Rows(a b #10) */ SELECT... ; Sets rows of join result to 10\npostgres=# /*+ Rows(a b +10) */ SELECT... ; Increments row number by 10\npostgres=# /*+ Rows(a b -10) */ SELECT... ; Subtracts 10 from the row number.\npostgres=# /*+ Rows(a b *10) */ SELECT... ; Makes the number 10 times larger.\n```\n\n## GUC 临时设置\n\n在目标语句设置查询规划器使用的 GUC 参数，下面的列子，在该查询中设置查询规划器使用 random_page_cost 的值为 2.0\n\n```\npostgres=# /*+\npostgres*#     Set(random_page_cost 2.0)\npostgres*#  */\npostgres-# SELECT * FROM table1 t1 WHERE key = 'value';\n...\n\n```\n\n# Hint 语法\n\n## Hint 注释位置\n\npg_hint_plan 在第一个注释块读取 hint，在这个注释块中只允许有字母，数字，空格，下划线，逗号，和括号。在下面的例子中 HashJoin(a b) and SeqScan(a) 被认为是 hint 而 IndexScan(a) and MergeJoin(a b) 不是 hint.\n\n```\npostgres=# /*+\npostgres*#    HashJoin(a b)\npostgres*#    SeqScan(a)\npostgres*#  */\npostgres-# /*+ IndexScan(a) */\npostgres-# EXPLAIN SELECT /*+ MergeJoin(a b) */ *\npostgres-#    FROM pgbench_branches b\npostgres-#    JOIN pgbench_accounts a ON b.bid = a.bid\npostgres-#   ORDER BY a.aid;\n                                      QUERY PLAN\n---------------------------------------------------------------------------------------\n Sort  (cost=31465.84..31715.84 rows=100000 width=197)\n   Sort Key: a.aid\n   ->  Hash Join  (cost=1.02..4016.02 rows=100000 width=197)\n         Hash Cond: (a.bid = b.bid)\n         ->  Seq Scan on pgbench_accounts a  (cost=0.00..2640.00 rows=100000 width=97)\n         ->  Hash  (cost=1.01..1.01 rows=1 width=100)\n               ->  Seq Scan on pgbench_branches b  (cost=0.00..1.01 rows=1 width=100)\n(7 rows)\n\npostgres=#\n```\n\n在对象名字中转义特殊的字符\n\n作为 hint 参数的对象如果包括括号，双引号和空格应该使用双引号。和 PostgresQL 的转义规则相同。\n\n使用相同名字表之间的区分\n\n同一对象使用重复的名字出现多次和在不同表空间中使用相同名字的对象可以通过使用别名来区别，并且在 hint 语句中使用这些别名。下面的例子第一个 SQL 语句因为在查询语句中使用一个表名两次而导致了错误，而第二个语句可以正常工作因为 t1 每次出现使用了不同的别名并且在 HashJoin hint 中使用了别名。\n\n```\npostgres=# /*+ HashJoin(t1 t1)*/\npostgres-# EXPLAIN SELECT * FROM s1.t1\npostgres-# JOIN public.t1 ON (s1.t1.id=public.t1.id);\nINFO:  hint syntax error at or near \"HashJoin(t1 t1)\"\nDETAIL:  Relation name \"t1\" is ambiguous.\n                            QUERY PLAN\n------------------------------------------------------------------\n Merge Join  (cost=337.49..781.49 rows=28800 width=8)\n   Merge Cond: (s1.t1.id = public.t1.id)\n   ->  Sort  (cost=168.75..174.75 rows=2400 width=4)\n         Sort Key: s1.t1.id\n         ->  Seq Scan on t1  (cost=0.00..34.00 rows=2400 width=4)\n   ->  Sort  (cost=168.75..174.75 rows=2400 width=4)\n         Sort Key: public.t1.id\n         ->  Seq Scan on t1  (cost=0.00..34.00 rows=2400 width=4)\n(8 行)\n\npostgres=# /*+ HashJoin(pt st) */\npostgres-# EXPLAIN SELECT * FROM s1.t1 st\npostgres-# JOIN public.t1 pt ON (st.id=pt.id);\n                             QUERY PLAN\n---------------------------------------------------------------------\n Hash Join  (cost=64.00..1112.00 rows=28800 width=8)\n   Hash Cond: (st.id = pt.id)\n   ->  Seq Scan on t1 st  (cost=0.00..34.00 rows=2400 width=4)\n   ->  Hash  (cost=34.00..34.00 rows=2400 width=4)\n         ->  Seq Scan on t1 pt  (cost=0.00..34.00 rows=2400 width=4)\n(5 行)\n\npostgres=#\n\n```\n\n# 限制\n\n## 在 from 子句中多种值的限制\n\n无论是语法中给定别名还是在 explain 中显示的描述，所有在 from 子句中出现的值都具有相同的名字 \"VALUES\"。所以如果他们在目标查询中出现两次及以上将不能使用 hints。\n\n## 在继承表上的使用\n\n继承表不能单独的使用 hint。他们和他们父表共享相同的 hint。\n\n## 通过设置 hint 来设置 pg_hint_plan 参数\n\npg_hint_plan 参数改变了它原来的行为所以一些参数不能按照期待的执行。\n\n    hint 改变了 enalbe_hint,enable_hint_tables 被忽略了，但是他们在 debug 日志中记录为 “used hints”。\n    设置 debug_print 和 message_level 工作在目标查询的中间处理。\n\n# hint 在目标语句中使用方法\n\n## hint 在查询语句中隐含实体的使用\n\nHint 对于任何带有目的名字的对象都是有效的，即使他们没有出现在查询语句中，例如在视图里的对象。这样如果你想使用不同于第一个视图的 hint 你可以在不同的视图对同一对象使用不用的别名。\n\n在下面的例子中，在第一个查询中出现的两个表中使用了相同的名字 t1,所以 hint SeqScan(t1) 将会在两次扫描中生效。另一方面第二个语句中在这两个出现的表中使用了不同的名字 t3 所以 hint 只影响这一个扫描。\n\n这个机制也可以应用在两个重写的查询语句中。\n\n```\npostgres=# CREATE VIEW view1 AS SELECT * FROM table1 t1;\nCREATE TABLE\npostgres=# /*+ SeqScan(t1) */\npostgres=# EXPLAIN SELECT * FROM table1 t1 JOIN view1 t2 ON (t1.key = t2.key) WHERE t2.key = 1;\n                           QUERY PLAN\n-----------------------------------------------------------------\n Nested Loop  (cost=0.00..358.01 rows=1 width=16)\n   ->  Seq Scan on table1 t1  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n   ->  Seq Scan on table1 t1  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n(5 rows)\n\npostgres=# /*+ SeqScan(t3) */\npostgres=# EXPLAIN SELECT * FROM table1 t3 JOIN view1 t2 ON (t1.key = t2.key) WHERE t2.key = 1;\n                                   QUERY PLAN\n--------------------------------------------------------------------------------\n Nested Loop  (cost=0.00..187.29 rows=1 width=16)\n   ->  Seq Scan on table1 t3  (cost=0.00..179.00 rows=1 width=8)\n         Filter: (key = 1)\n   ->  Index Scan using foo_pkey on table1 t1  (cost=0.00..8.28 rows=1 width=8)\n         Index Cond: (key = 1)\n(5 rows)\n```\n\n## Hint 在继承中的使用\n\nhint 作用在父表将自动影响它的所有孩子。子表不能自己指定自己的 hint。\n\n## hint 在多条语句中的作用范围\n\n一个多语句描述只能有一个 hint 注释并且这个注释会作用在这个多语句的所有单条语句上。注意在一个交互的 psql 的看似多语句实际上是一系列单条语句，所以 hint 只作用在跟在它后面的一条语句。相反每一个单条语句有他们自己的 hint 注释。\n\n## 在一些上下文中的子查询\n\n在下面的上下文中子查询也可以使用 hint。\n\nIN (SELECT ... {LIMIT | OFFSET ...} ...)\n= ANY (SELECT ... {LIMIT | OFFSET ...} ...)\n= SOME (SELECT ... {LIMIT | OFFSET ...} ...)\n\n对于这些语法，当计划 jion 子查询结果时，查询规划器内部分配子查询的名字为 “ANY subquery”，所以 join hint 使用隐含的名字作用在这些 join 中。\n\n```\npostgres=# /*+HashJoin(a1 ANY_subquery)*/\npostgres=# EXPLAIN SELECT *\npostgres=#    FROM pgbench_accounts a1\npostgres=#   WHERE aid IN (SELECT bid FROM pgbench_accounts a2 LIMIT 10);\n                                         QUERY PLAN\n\n---------------------------------------------------------------------------------------------\n Hash Semi Join  (cost=0.49..2903.00 rows=1 width=97)\n   Hash Cond: (a1.aid = a2.bid)\n   ->  Seq Scan on pgbench_accounts a1  (cost=0.00..2640.00 rows=100000 width=97)\n   ->  Hash  (cost=0.36..0.36 rows=10 width=4)\n         ->  Limit  (cost=0.00..0.26 rows=10 width=4)\n               ->  Seq Scan on pgbench_accounts a2  (cost=0.00..2640.00 rows=100000 width=4)\n(6 rows)\n```\n\n## 使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)\n\n如果你在一个表上使用 IndexOnlyScan hint 你应该明确的指定一个能执行仅扫描的索引，而其他的索引不能执行仅扫描。否则 pg_hint_plan 可能会选择他们.\n\n## NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)\n\nNoIndexScan hint 涉及到 NoIndexOnlyScan.\n\n# hints 的错误处理\n\n在大多数情况下 pg_hint_plan 停止解析任何错误并且使用 hints 已经解析的内容。下面是一些典型的错误。\n\n## 语法错误\n\n任何语法错误或者错误的 hint 名字被记录为语法错误。如果 pg_hint_plan.debug_print 被设置为 on 这些错误将会记录在服务器的日志中，并使用 pg_hint_plan.message_level 中指定的信息级别。\n\n## 错误规格\n\n对象的错误规格将会导致被 hints 忽略。这种错误竟会和语法错误一样在日志中被记录为 “not used hints”。\n\n## 冗余或冲突的 hints\n\n当冗余 hints 或者互相冲突的 hint 出现时最后一个 hint 将会生效。这种错误将会和语法错误一样在日志中被记录为 “duplication hints”。\n\n## 嵌套注释\n\n在 hint 的注释内不能嵌套另一个注释。如果 pg_hint_plan 发现这种情况，不同于其它错误的处理方法，它停止解析并且放弃已经解析的所有 hint。这种错误和其他错误以一样的方式记录。\n\n# 函数限制\n\n## GUC 参数对查询规划器的影响\n\n对于 FROM 子句的数量超过了 from_collapse_limit 的情况，查询规划器不会考虑 join 的顺序。在这种情况下 pg_hint_plan 不会影响 join 的顺序。\n\n## pg_hint_plan 本质上无效的情况\n\n因为 pg_hint_plan 性质，它对查询规划器作用范围之外的情况是无效的，包括下面的情况：\n\n- 使用嵌套循环的 FULL OUTER JOIN\n- 没有使用索引资格的列去使用索引\n- 不带 ctid 条件的查询做 TID 扫描\n\n## 在 ECPG 程序中的查询\n\n在嵌入式 SQL 语句中 ECPG 删除了查询语句中的注释所以 hints 不能传给这些查询语句。唯一的方法是通过命令传 给定的未修改的字符串。在这种情况下需要考虑 hint 表。\n\n## 查询指纹的影响\n\n相同的查询使用不同的注释在 PostgresQL 9.2及以后会产生相同的指纹，但是他们在9.1及以前会产生不同的指纹，带有不同 hint 的相同的查询在这个版本被作为单独查询。\n\n# 英文版\n\nhttp://pghintplan.sourceforge.jp/pg_hint_plan.html\n","slug":"pg_hint_plan","published":1,"updated":"2021-03-05T08:30:47.555Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cklw1fzja002tpiebauknc4yr","content":"<h1 id=\"名字\"><a href=\"#名字\" class=\"headerlink\" title=\"名字\"></a>名字</h1><p>pg_hint_plan – 在注释中使用特殊格式的 hint 语句来控制查询计划.</p>\n<h1 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h1><p>PostgresQL 使用查询规划器计算开销，查询规划器是基于数据统计的而不是静态的规则。对于一个 SQL 语句查询规划器估计每一种可能执行方法的开销，然后使用开销最低的执行方法。查询规划器使用它认为最好的执行计划，而并非真正最优的，因为它不考虑一些数据的属性，例如，列之间的关系。</p>\n<p>pg_hint_plan 使用所谓的 “hint” 来调整执行计划，它可以在 SQL 注释中使用特殊的格式来简单的描述。</p>\n<a id=\"more\"></a>\n<h1 id=\"描述\"><a href=\"#描述\" class=\"headerlink\" title=\"描述\"></a>描述</h1><h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><p>pg_hint 在 SQL 注释的特殊格式中读取 hint 语句。特殊格式以 “/+” 开头以 “/“ 结尾。hint 语句由名字和跟在后面的括号中的参数组成，参数以空格分隔。为了可读性每一个 hint 语句使用换行来分隔。</p>\n<p>在下面的例子中，哈希 join 被作为 join 的方法，使用顺数扫描作为扫描的方法。</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">postgres=<span class=\"hljs-comment\"># /*+</span><br>postgres*<span class=\"hljs-comment\">#    HashJoin(a b)</span><br>postgres*<span class=\"hljs-comment\">#    SeqScan(a)</span><br>postgres*<span class=\"hljs-comment\">#  */</span><br>postgres-<span class=\"hljs-comment\"># EXPLAIN SELECT *</span><br>postgres-<span class=\"hljs-comment\">#    FROM pgbench_branches b</span><br>postgres-<span class=\"hljs-comment\">#    JOIN pgbench_accounts a ON b.bid = a.bid</span><br>postgres-<span class=\"hljs-comment\">#   ORDER BY a.aid;</span><br>                                      QUERY PLAN<br><span class=\"hljs-params\">---------------------------------------------------------------------------------------</span><br> Sort  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=31465.84..31715.84 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>   Sort Key: a.aid<br>   -&gt;  Hash Join  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.02..4016.02 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>         Hash Cond: <span class=\"hljs-params\">(a.<span class=\"hljs-attr\">bid</span> = b.bid)</span><br>         -&gt;  Seq Scan on pgbench_accounts a  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..2640.00 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=97)</span><br>         -&gt;  Hash  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.01..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br>               -&gt;  Seq Scan on pgbench_branches b  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br><span class=\"hljs-params\">(7 rows)</span><br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"hints-的类型\"><a href=\"#hints-的类型\" class=\"headerlink\" title=\"hints 的类型\"></a>hints 的类型</h2><p>hint 语句通过他们影响的实体而分为四种类型。扫描方法，join 方法，join 顺序，纠正行数和 GUC 设置。对于每一种类型的hint语句有一个 hint 语句列表<a href=\"http://pghintplan.sourceforge.jp/hint_list.html\">http://pghintplan.sourceforge.jp/hint_list.html</a></p>\n<h2 id=\"hint-的扫描方法\"><a href=\"#hint-的扫描方法\" class=\"headerlink\" title=\"hint 的扫描方法\"></a>hint 的扫描方法</h2><p>hint 的扫描方法通过在表上指定一个参数来选择一种扫描方式。pg_hint 可以通过表的别名来识别一个表。他们可以是 ‘SeqScan’，‘IndexScan’ 等等。</p>\n<p>hint 扫描在普通表，继承表，UNLOGGED 表，临时表，系统表是有效的。它不能应用在外部表，表函数，命令的值（VALUES command results），CTEs，视图和子查询中。</p>\n<h2 id=\"Hints-的-join-方法\"><a href=\"#Hints-的-join-方法\" class=\"headerlink\" title=\"Hints 的 join 方法\"></a>Hints 的 join 方法</h2><p>使用表名作为参数的 jion 方法名来指定 Hints 的 join 方法</p>\n<p>在参数列表中可以使用普通表，继承表，UNLOGGED 表，临时表，外部表，系统表，表函数，命令的值（VALUES command results），CTEs 作为参数。但是视图和子查询不可以。</p>\n<h2 id=\"Hint-的-join-顺序\"><a href=\"#Hint-的-join-顺序\" class=\"headerlink\" title=\"Hint 的 join 顺序\"></a>Hint 的 join 顺序</h2><p>可以使用 “Leading” 来指定 join 的顺序。join 的顺序将按照参数列表的给出顺序来执行。</p>\n<h2 id=\"Hint-纠正行数\"><a href=\"#Hint-纠正行数\" class=\"headerlink\" title=\"Hint 纠正行数\"></a>Hint 纠正行数</h2><p>由于查询规划器的能力限制，它可能错误的估计一些条件下的结果集的数量。这种类型的 hint 将会纠正这种情况。</p>\n<h2 id=\"GUC-参数的临时设置\"><a href=\"#GUC-参数的临时设置\" class=\"headerlink\" title=\"GUC 参数的临时设置\"></a>GUC 参数的临时设置</h2><p>在查询规划时设置 hint 来改变 GUC 的参数。在 Query Planning 指定 GUC 的参数可以在查询规划时得到预期的效果，除非其他的 hint 和查询规划器配置的参数冲突了。相同的 GUC 参数在 hint 中最后一个配置的将会生效。对于pg_hint_plan 可以通过 hint 来设置 GUC 参数，但是它不一定会按照预期的工作。详细内容可以看限制章节。</p>\n<h1 id=\"pg-hint-plan-的-GUC-参数\"><a href=\"#pg-hint-plan-的-GUC-参数\" class=\"headerlink\" title=\"pg_hint_plan 的 GUC 参数\"></a>pg_hint_plan 的 GUC 参数</h1><p>下面的 GUC 参数会影响 pg_hint_plan 的行为.</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>Parameter name</th>\n<th>description</th>\n<th>Default</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pg_hint_plan.enable_hint</td>\n<td>Enbles or disables the function of pg_hint_plan.</td>\n<td>on</td>\n</tr>\n<tr>\n<td>pg_hint_plan.debug_print</td>\n<td>Enables and select the verbosity of the debug output of pg_hint_plan. off, on, detailed and verbose are valid.</td>\n<td>off</td>\n</tr>\n<tr>\n<td>pg_hint_plan.message_level</td>\n<td>Specifies the message level of debug prints. error, warning, notice, info, log, debug are valid and fatal and panic are inhibited.</td>\n<td>info</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>对于这些 GUC 参数 PostgreSQL 9.1 需要定义一个变量类. 详细内容见 custom_variable_classes.</p>\n<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><p>这部分描述了安装的步骤。</p>\n<h2 id=\"编译二进制模块\"><a href=\"#编译二进制模块\" class=\"headerlink\" title=\"编译二进制模块\"></a>编译二进制模块</h2><p>在源码的根目录执行 “make”，然后使用合适的角色执行 “make install”。在这个过程中对于 PostgresQL 应该将环境变量设置为合适的值。<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">$ tar xzvf pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x.tar.gz<br>$ cd pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x<br>$ make<br>$ su<br>$ make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"加载-pg-hint-plan\"><a href=\"#加载-pg-hint-plan\" class=\"headerlink\" title=\"加载 pg_hint_plan\"></a>加载 pg_hint_plan</h2><p>pg_hint_plan 不需要使用 CREATE EXTENSION.只要使用 LOAD 命令将它激活，当然你也可以全局的加载它通过在 postgresql.conf 中设置 shared_preload_libraries。你也可以使用 ALTER USER SET/ALTER DATABASE SET 在指定的会话中自动的加载它。</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">postgres</span>=# LOAD <span class=\"hljs-string\">&#x27;pg_hint_plan&#x27;</span>;<br>LOAD<br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<p>如果你计划 hint 表，你需要设置 pg_hint_plan.enable_hint_tables 值为 on。</p>\n<h2 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h2><p>如果你使用源码安装了 pg_hint_plan，你可以在源码的根目录使用 “make uninstall” 来卸载安装的文件。</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">$ cd pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x<br>$ su<br># make uninstall<br></code></pre></td></tr></table></figure>\n<h1 id=\"Hint-描述\"><a href=\"#Hint-描述\" class=\"headerlink\" title=\"Hint 描述\"></a>Hint 描述</h1><p>这部分描述了怎么写各种类型的 hints。</p>\n<h2 id=\"扫描方法-hints\"><a href=\"#扫描方法-hints\" class=\"headerlink\" title=\"扫描方法 hints\"></a>扫描方法 hints</h2><p>扫描 hints 使用一个参数去指定目标对象。使用索引作为参数最好使用索引名。目标对象如果有别名参数应该指定为别名。在下面的例子中 table1 使用顺序扫描，table2 使用主键索引扫描。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+<br><span class=\"hljs-attribute\">postgres</span>*#     SeqScan(t<span class=\"hljs-number\">1</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     IndexScan(t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span>_pkey)<br><span class=\"hljs-attribute\">postgres</span>*#  */<br><span class=\"hljs-attribute\">postgres</span>-# SELECT * FROM table<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">1</span> JOIN table table<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">1</span>.key = t<span class=\"hljs-number\">2</span>.key);<br></code></pre></td></tr></table></figure>\n<h2 id=\"Join-hints\"><a href=\"#Join-hints\" class=\"headerlink\" title=\"Join hints\"></a>Join hints</h2><p>join hints 使用两个或多个组成 join 的对象作为参数。如果指定了三个对象，hint 将会 join 两个对象后再 join 他们中的一个。在下面的例子中，首先使用嵌套循环 join talbe1 和 table2，然后使用合并 join 前面的结果和 table3.<br><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+<br><span class=\"hljs-attribute\">postgres</span>*#     NestLoop(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     MergeJoin(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     Leading(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>)<br><span class=\"hljs-attribute\">postgres</span>*#  */<br><span class=\"hljs-attribute\">postgres</span>-# SELECT * FROM table<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">1</span><br><span class=\"hljs-attribute\">postgres</span>-#     JOIN table table<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">1</span>.key = t<span class=\"hljs-number\">2</span>.key)<br><span class=\"hljs-attribute\">postgres</span>-#     JOIN table table<span class=\"hljs-number\">3</span> t<span class=\"hljs-number\">3</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">2</span>.key = t<span class=\"hljs-number\">3</span>.key);<br><br></code></pre></td></tr></table></figure></p>\n<h2 id=\"join-顺序\"><a href=\"#join-顺序\" class=\"headerlink\" title=\"join 顺序\"></a>join 顺序</h2><p>尽管先 join table2 和 table3 然后 join table1 这种情况可能出现，但是 NestLoop hint 将不会生效。”Leading” hint 在这种情况下可以强制改变 join 顺序。在上面的例子中 Leading hint 改变 join 顺序为 table1,2,3 然后这两种 join 方法都会生效。</p>\n<p>上面 Leading hint 的形式改变了 join 的顺序，但是查询规划器的 join 顺序是自左至右的。如果你想改变 join 的方向，第二种方法是有效的。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+ Leading((t<span class=\"hljs-number\">1</span> (t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>))) */ SELECT...<br></code></pre></td></tr></table></figure>\n<p>每对括号包括两个元素，可以是对象也可以是嵌套的括号。括号中的第一个元素是驱动者或外部表，第二个是被驱动或者内部。</p>\n<h2 id=\"hints-纠正结果集数量\"><a href=\"#hints-纠正结果集数量\" class=\"headerlink\" title=\"hints 纠正结果集数量\"></a>hints 纠正结果集数量</h2><p>如果查询规划器错误的估计了在一些条件下join返回的结果集数量。这个 hint 可以通过几种方法来纠正这个值，包括绝对值，加减和乘法。参数是组成 join 的对象和操作。下面的例子通过4个例子给出了纠正 a join b 返回的值数量的用法。</p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs makefile\">postgres=<span class=\"hljs-comment\"># /*+ Rows(a b #10) */ SELECT... ; Sets rows of join result to 10</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b +10) */ SELECT... ; Increments row number by 10</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b -10) */ SELECT... ; Subtracts 10 from the row number.</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b *10) */ SELECT... ; Makes the number 10 times larger.</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"GUC-临时设置\"><a href=\"#GUC-临时设置\" class=\"headerlink\" title=\"GUC 临时设置\"></a>GUC 临时设置</h2><p>在目标语句设置查询规划器使用的 GUC 参数，下面的列子，在该查询中设置查询规划器使用 random_page_cost 的值为 2.0</p>\n<figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs n1ql\">postgres=# <span class=\"hljs-comment\">/*+</span><br><span class=\"hljs-comment\">postgres*#     Set(random_page_cost 2.0)</span><br><span class=\"hljs-comment\">postgres*#  */</span><br>postgres-# <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1 <span class=\"hljs-keyword\">WHERE</span> <span class=\"hljs-keyword\">key</span> = <span class=\"hljs-string\">&#x27;value&#x27;</span>;<br>...<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"Hint-语法\"><a href=\"#Hint-语法\" class=\"headerlink\" title=\"Hint 语法\"></a>Hint 语法</h1><h2 id=\"Hint-注释位置\"><a href=\"#Hint-注释位置\" class=\"headerlink\" title=\"Hint 注释位置\"></a>Hint 注释位置</h2><p>pg_hint_plan 在第一个注释块读取 hint，在这个注释块中只允许有字母，数字，空格，下划线，逗号，和括号。在下面的例子中 HashJoin(a b) and SeqScan(a) 被认为是 hint 而 IndexScan(a) and MergeJoin(a b) 不是 hint.</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">postgres=<span class=\"hljs-comment\"># /*+</span><br>postgres*<span class=\"hljs-comment\">#    HashJoin(a b)</span><br>postgres*<span class=\"hljs-comment\">#    SeqScan(a)</span><br>postgres*<span class=\"hljs-comment\">#  */</span><br>postgres-<span class=\"hljs-comment\"># /*+ IndexScan(a) */</span><br>postgres-<span class=\"hljs-comment\"># EXPLAIN SELECT /*+ MergeJoin(a b) */ *</span><br>postgres-<span class=\"hljs-comment\">#    FROM pgbench_branches b</span><br>postgres-<span class=\"hljs-comment\">#    JOIN pgbench_accounts a ON b.bid = a.bid</span><br>postgres-<span class=\"hljs-comment\">#   ORDER BY a.aid;</span><br>                                      QUERY PLAN<br><span class=\"hljs-params\">---------------------------------------------------------------------------------------</span><br> Sort  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=31465.84..31715.84 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>   Sort Key: a.aid<br>   -&gt;  Hash Join  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.02..4016.02 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>         Hash Cond: <span class=\"hljs-params\">(a.<span class=\"hljs-attr\">bid</span> = b.bid)</span><br>         -&gt;  Seq Scan on pgbench_accounts a  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..2640.00 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=97)</span><br>         -&gt;  Hash  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.01..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br>               -&gt;  Seq Scan on pgbench_branches b  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br><span class=\"hljs-params\">(7 rows)</span><br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<p>在对象名字中转义特殊的字符</p>\n<p>作为 hint 参数的对象如果包括括号，双引号和空格应该使用双引号。和 PostgresQL 的转义规则相同。</p>\n<p>使用相同名字表之间的区分</p>\n<p>同一对象使用重复的名字出现多次和在不同表空间中使用相同名字的对象可以通过使用别名来区别，并且在 hint 语句中使用这些别名。下面的例子第一个 SQL 语句因为在查询语句中使用一个表名两次而导致了错误，而第二个语句可以正常工作因为 t1 每次出现使用了不同的别名并且在 HashJoin hint 中使用了别名。</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# <span class=\"hljs-comment\">/*+ HashJoin(t1 t1)*/</span><br>postgres-# EXPLAIN SELECT * FROM s1.t1<br>postgres-# JOIN <span class=\"hljs-keyword\">public</span>.t1 ON (s1.t1.id=<span class=\"hljs-keyword\">public</span>.t1.id);<br>INFO:  hint syntax error at <span class=\"hljs-keyword\">or</span> near <span class=\"hljs-string\">&quot;HashJoin(t1 t1)&quot;</span><br>DETAIL:  Relation name <span class=\"hljs-string\">&quot;t1&quot;</span> <span class=\"hljs-keyword\">is</span> ambiguous.<br>                            QUERY PLAN<br>------------------------------------------------------------------<br> Merge Join  (cost=<span class=\"hljs-number\">337.49</span>.<span class=\"hljs-number\">.781</span><span class=\"hljs-number\">.49</span> rows=<span class=\"hljs-number\">28800</span> width=<span class=\"hljs-number\">8</span>)<br>   Merge Cond: (s1.t1.id = <span class=\"hljs-keyword\">public</span>.t1.id)<br>   -&gt;  Sort  (cost=<span class=\"hljs-number\">168.75</span>.<span class=\"hljs-number\">.174</span><span class=\"hljs-number\">.75</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         Sort Key: s1.t1.id<br>         -&gt;  Seq Scan on t1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>   -&gt;  Sort  (cost=<span class=\"hljs-number\">168.75</span>.<span class=\"hljs-number\">.174</span><span class=\"hljs-number\">.75</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         Sort Key: <span class=\"hljs-keyword\">public</span>.t1.id<br>         -&gt;  Seq Scan on t1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">8</span> 行)<br><br>postgres=# <span class=\"hljs-comment\">/*+ HashJoin(pt st) */</span><br>postgres-# EXPLAIN SELECT * FROM s1.t1 st<br>postgres-# JOIN <span class=\"hljs-keyword\">public</span>.t1 pt ON (st.id=pt.id);<br>                             QUERY PLAN<br>---------------------------------------------------------------------<br> Hash Join  (cost=<span class=\"hljs-number\">64.00</span>.<span class=\"hljs-number\">.1112</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">28800</span> width=<span class=\"hljs-number\">8</span>)<br>   Hash Cond: (st.id = pt.id)<br>   -&gt;  Seq Scan on t1 st  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>   -&gt;  Hash  (cost=<span class=\"hljs-number\">34.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         -&gt;  Seq Scan on t1 pt  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">5</span> 行)<br><br>postgres=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"限制\"><a href=\"#限制\" class=\"headerlink\" title=\"限制\"></a>限制</h1><h2 id=\"在-from-子句中多种值的限制\"><a href=\"#在-from-子句中多种值的限制\" class=\"headerlink\" title=\"在 from 子句中多种值的限制\"></a>在 from 子句中多种值的限制</h2><p>无论是语法中给定别名还是在 explain 中显示的描述，所有在 from 子句中出现的值都具有相同的名字 “VALUES”。所以如果他们在目标查询中出现两次及以上将不能使用 hints。</p>\n<h2 id=\"在继承表上的使用\"><a href=\"#在继承表上的使用\" class=\"headerlink\" title=\"在继承表上的使用\"></a>在继承表上的使用</h2><p>继承表不能单独的使用 hint。他们和他们父表共享相同的 hint。</p>\n<h2 id=\"通过设置-hint-来设置-pg-hint-plan-参数\"><a href=\"#通过设置-hint-来设置-pg-hint-plan-参数\" class=\"headerlink\" title=\"通过设置 hint 来设置 pg_hint_plan 参数\"></a>通过设置 hint 来设置 pg_hint_plan 参数</h2><p>pg_hint_plan 参数改变了它原来的行为所以一些参数不能按照期待的执行。</p>\n<pre><code>hint 改变了 enalbe_hint,enable_hint_tables 被忽略了，但是他们在 debug 日志中记录为 “used hints”。\n设置 debug_print 和 message_level 工作在目标查询的中间处理。\n</code></pre><h1 id=\"hint-在目标语句中使用方法\"><a href=\"#hint-在目标语句中使用方法\" class=\"headerlink\" title=\"hint 在目标语句中使用方法\"></a>hint 在目标语句中使用方法</h1><h2 id=\"hint-在查询语句中隐含实体的使用\"><a href=\"#hint-在查询语句中隐含实体的使用\" class=\"headerlink\" title=\"hint 在查询语句中隐含实体的使用\"></a>hint 在查询语句中隐含实体的使用</h2><p>Hint 对于任何带有目的名字的对象都是有效的，即使他们没有出现在查询语句中，例如在视图里的对象。这样如果你想使用不同于第一个视图的 hint 你可以在不同的视图对同一对象使用不用的别名。</p>\n<p>在下面的例子中，在第一个查询中出现的两个表中使用了相同的名字 t1,所以 hint SeqScan(t1) 将会在两次扫描中生效。另一方面第二个语句中在这两个出现的表中使用了不同的名字 t3 所以 hint 只影响这一个扫描。</p>\n<p>这个机制也可以应用在两个重写的查询语句中。</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> view1 <span class=\"hljs-keyword\">AS</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>postgres=# <span class=\"hljs-comment\">/*+ SeqScan(t1) */</span><br>postgres=# <span class=\"hljs-keyword\">EXPLAIN</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1 <span class=\"hljs-keyword\">JOIN</span> view1 t2 <span class=\"hljs-keyword\">ON</span> (t1.key = t2.key) <span class=\"hljs-keyword\">WHERE</span> t2.key = <span class=\"hljs-number\">1</span>;<br>                           QUERY PLAN<br><span class=\"hljs-comment\">-----------------------------------------------------------------</span><br> Nested <span class=\"hljs-keyword\">Loop</span>  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.358</span><span class=\"hljs-number\">.01</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">16</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>(<span class=\"hljs-number\">5</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-comment\">/*+ SeqScan(t3) */</span><br>postgres=# <span class=\"hljs-keyword\">EXPLAIN</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t3 <span class=\"hljs-keyword\">JOIN</span> view1 t2 <span class=\"hljs-keyword\">ON</span> (t1.key = t2.key) <span class=\"hljs-keyword\">WHERE</span> t2.key = <span class=\"hljs-number\">1</span>;<br>                                   QUERY PLAN<br><span class=\"hljs-comment\">--------------------------------------------------------------------------------</span><br> Nested <span class=\"hljs-keyword\">Loop</span>  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.187</span><span class=\"hljs-number\">.29</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">16</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t3  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>   -&gt;  <span class=\"hljs-keyword\">Index</span> Scan <span class=\"hljs-keyword\">using</span> foo_pkey <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.8</span><span class=\"hljs-number\">.28</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Index</span> Cond: (key = <span class=\"hljs-number\">1</span>)<br>(<span class=\"hljs-number\">5</span> <span class=\"hljs-keyword\">rows</span>)<br></code></pre></td></tr></table></figure>\n<h2 id=\"Hint-在继承中的使用\"><a href=\"#Hint-在继承中的使用\" class=\"headerlink\" title=\"Hint 在继承中的使用\"></a>Hint 在继承中的使用</h2><p>hint 作用在父表将自动影响它的所有孩子。子表不能自己指定自己的 hint。</p>\n<h2 id=\"hint-在多条语句中的作用范围\"><a href=\"#hint-在多条语句中的作用范围\" class=\"headerlink\" title=\"hint 在多条语句中的作用范围\"></a>hint 在多条语句中的作用范围</h2><p>一个多语句描述只能有一个 hint 注释并且这个注释会作用在这个多语句的所有单条语句上。注意在一个交互的 psql 的看似多语句实际上是一系列单条语句，所以 hint 只作用在跟在它后面的一条语句。相反每一个单条语句有他们自己的 hint 注释。</p>\n<h2 id=\"在一些上下文中的子查询\"><a href=\"#在一些上下文中的子查询\" class=\"headerlink\" title=\"在一些上下文中的子查询\"></a>在一些上下文中的子查询</h2><p>在下面的上下文中子查询也可以使用 hint。</p>\n<p>IN (SELECT … {LIMIT | OFFSET …} …)<br>= ANY (SELECT … {LIMIT | OFFSET …} …)<br>= SOME (SELECT … {LIMIT | OFFSET …} …)</p>\n<p>对于这些语法，当计划 jion 子查询结果时，查询规划器内部分配子查询的名字为 “ANY subquery”，所以 join hint 使用隐含的名字作用在这些 join 中。</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# <span class=\"hljs-comment\">/*+HashJoin(a1 ANY_subquery)*/</span><br>postgres=# EXPLAIN SELECT *<br>postgres=#    FROM pgbench_accounts a1<br>postgres=#   WHERE aid IN (SELECT bid FROM pgbench_accounts a2 LIMIT <span class=\"hljs-number\">10</span>);<br>                                         QUERY PLAN<br><br>---------------------------------------------------------------------------------------------<br> Hash Semi Join  (cost=<span class=\"hljs-number\">0.49</span>.<span class=\"hljs-number\">.2903</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">97</span>)<br>   Hash Cond: (a1.aid = a2.bid)<br>   -&gt;  Seq Scan on pgbench_accounts a1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.2640</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">100000</span> width=<span class=\"hljs-number\">97</span>)<br>   -&gt;  Hash  (cost=<span class=\"hljs-number\">0.36</span>.<span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.36</span> rows=<span class=\"hljs-number\">10</span> width=<span class=\"hljs-number\">4</span>)<br>         -&gt;  Limit  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.26</span> rows=<span class=\"hljs-number\">10</span> width=<span class=\"hljs-number\">4</span>)<br>               -&gt;  Seq Scan on pgbench_accounts a2  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.2640</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">100000</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">6</span> rows)<br></code></pre></td></tr></table></figure>\n<h2 id=\"使用-IndexOnlyScan-hint-PostgreSQL-9-2及之后的版本\"><a href=\"#使用-IndexOnlyScan-hint-PostgreSQL-9-2及之后的版本\" class=\"headerlink\" title=\"使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)\"></a>使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)</h2><p>如果你在一个表上使用 IndexOnlyScan hint 你应该明确的指定一个能执行仅扫描的索引，而其他的索引不能执行仅扫描。否则 pg_hint_plan 可能会选择他们.</p>\n<h2 id=\"NoIndexScan-hint-的预防要点-PostgreSQL-9-2-及以后版本\"><a href=\"#NoIndexScan-hint-的预防要点-PostgreSQL-9-2-及以后版本\" class=\"headerlink\" title=\"NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)\"></a>NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)</h2><p>NoIndexScan hint 涉及到 NoIndexOnlyScan.</p>\n<h1 id=\"hints-的错误处理\"><a href=\"#hints-的错误处理\" class=\"headerlink\" title=\"hints 的错误处理\"></a>hints 的错误处理</h1><p>在大多数情况下 pg_hint_plan 停止解析任何错误并且使用 hints 已经解析的内容。下面是一些典型的错误。</p>\n<h2 id=\"语法错误\"><a href=\"#语法错误\" class=\"headerlink\" title=\"语法错误\"></a>语法错误</h2><p>任何语法错误或者错误的 hint 名字被记录为语法错误。如果 pg_hint_plan.debug_print 被设置为 on 这些错误将会记录在服务器的日志中，并使用 pg_hint_plan.message_level 中指定的信息级别。</p>\n<h2 id=\"错误规格\"><a href=\"#错误规格\" class=\"headerlink\" title=\"错误规格\"></a>错误规格</h2><p>对象的错误规格将会导致被 hints 忽略。这种错误竟会和语法错误一样在日志中被记录为 “not used hints”。</p>\n<h2 id=\"冗余或冲突的-hints\"><a href=\"#冗余或冲突的-hints\" class=\"headerlink\" title=\"冗余或冲突的 hints\"></a>冗余或冲突的 hints</h2><p>当冗余 hints 或者互相冲突的 hint 出现时最后一个 hint 将会生效。这种错误将会和语法错误一样在日志中被记录为 “duplication hints”。</p>\n<h2 id=\"嵌套注释\"><a href=\"#嵌套注释\" class=\"headerlink\" title=\"嵌套注释\"></a>嵌套注释</h2><p>在 hint 的注释内不能嵌套另一个注释。如果 pg_hint_plan 发现这种情况，不同于其它错误的处理方法，它停止解析并且放弃已经解析的所有 hint。这种错误和其他错误以一样的方式记录。</p>\n<h1 id=\"函数限制\"><a href=\"#函数限制\" class=\"headerlink\" title=\"函数限制\"></a>函数限制</h1><h2 id=\"GUC-参数对查询规划器的影响\"><a href=\"#GUC-参数对查询规划器的影响\" class=\"headerlink\" title=\"GUC 参数对查询规划器的影响\"></a>GUC 参数对查询规划器的影响</h2><p>对于 FROM 子句的数量超过了 from_collapse_limit 的情况，查询规划器不会考虑 join 的顺序。在这种情况下 pg_hint_plan 不会影响 join 的顺序。</p>\n<h2 id=\"pg-hint-plan-本质上无效的情况\"><a href=\"#pg-hint-plan-本质上无效的情况\" class=\"headerlink\" title=\"pg_hint_plan 本质上无效的情况\"></a>pg_hint_plan 本质上无效的情况</h2><p>因为 pg_hint_plan 性质，它对查询规划器作用范围之外的情况是无效的，包括下面的情况：</p>\n<ul>\n<li>使用嵌套循环的 FULL OUTER JOIN</li>\n<li>没有使用索引资格的列去使用索引</li>\n<li>不带 ctid 条件的查询做 TID 扫描</li>\n</ul>\n<h2 id=\"在-ECPG-程序中的查询\"><a href=\"#在-ECPG-程序中的查询\" class=\"headerlink\" title=\"在 ECPG 程序中的查询\"></a>在 ECPG 程序中的查询</h2><p>在嵌入式 SQL 语句中 ECPG 删除了查询语句中的注释所以 hints 不能传给这些查询语句。唯一的方法是通过命令传 给定的未修改的字符串。在这种情况下需要考虑 hint 表。</p>\n<h2 id=\"查询指纹的影响\"><a href=\"#查询指纹的影响\" class=\"headerlink\" title=\"查询指纹的影响\"></a>查询指纹的影响</h2><p>相同的查询使用不同的注释在 PostgresQL 9.2及以后会产生相同的指纹，但是他们在9.1及以前会产生不同的指纹，带有不同 hint 的相同的查询在这个版本被作为单独查询。</p>\n<h1 id=\"英文版\"><a href=\"#英文版\" class=\"headerlink\" title=\"英文版\"></a>英文版</h1><p><a href=\"http://pghintplan.sourceforge.jp/pg_hint_plan.html\">http://pghintplan.sourceforge.jp/pg_hint_plan.html</a></p>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"名字\"><a href=\"#名字\" class=\"headerlink\" title=\"名字\"></a>名字</h1><p>pg_hint_plan – 在注释中使用特殊格式的 hint 语句来控制查询计划.</p>\n<h1 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h1><p>PostgresQL 使用查询规划器计算开销，查询规划器是基于数据统计的而不是静态的规则。对于一个 SQL 语句查询规划器估计每一种可能执行方法的开销，然后使用开销最低的执行方法。查询规划器使用它认为最好的执行计划，而并非真正最优的，因为它不考虑一些数据的属性，例如，列之间的关系。</p>\n<p>pg_hint_plan 使用所谓的 “hint” 来调整执行计划，它可以在 SQL 注释中使用特殊的格式来简单的描述。</p>","more":"<h1 id=\"描述\"><a href=\"#描述\" class=\"headerlink\" title=\"描述\"></a>描述</h1><h2 id=\"基本用法\"><a href=\"#基本用法\" class=\"headerlink\" title=\"基本用法\"></a>基本用法</h2><p>pg_hint 在 SQL 注释的特殊格式中读取 hint 语句。特殊格式以 “/+” 开头以 “/“ 结尾。hint 语句由名字和跟在后面的括号中的参数组成，参数以空格分隔。为了可读性每一个 hint 语句使用换行来分隔。</p>\n<p>在下面的例子中，哈希 join 被作为 join 的方法，使用顺数扫描作为扫描的方法。</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">postgres=<span class=\"hljs-comment\"># /*+</span><br>postgres*<span class=\"hljs-comment\">#    HashJoin(a b)</span><br>postgres*<span class=\"hljs-comment\">#    SeqScan(a)</span><br>postgres*<span class=\"hljs-comment\">#  */</span><br>postgres-<span class=\"hljs-comment\"># EXPLAIN SELECT *</span><br>postgres-<span class=\"hljs-comment\">#    FROM pgbench_branches b</span><br>postgres-<span class=\"hljs-comment\">#    JOIN pgbench_accounts a ON b.bid = a.bid</span><br>postgres-<span class=\"hljs-comment\">#   ORDER BY a.aid;</span><br>                                      QUERY PLAN<br><span class=\"hljs-params\">---------------------------------------------------------------------------------------</span><br> Sort  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=31465.84..31715.84 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>   Sort Key: a.aid<br>   -&gt;  Hash Join  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.02..4016.02 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>         Hash Cond: <span class=\"hljs-params\">(a.<span class=\"hljs-attr\">bid</span> = b.bid)</span><br>         -&gt;  Seq Scan on pgbench_accounts a  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..2640.00 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=97)</span><br>         -&gt;  Hash  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.01..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br>               -&gt;  Seq Scan on pgbench_branches b  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br><span class=\"hljs-params\">(7 rows)</span><br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"hints-的类型\"><a href=\"#hints-的类型\" class=\"headerlink\" title=\"hints 的类型\"></a>hints 的类型</h2><p>hint 语句通过他们影响的实体而分为四种类型。扫描方法，join 方法，join 顺序，纠正行数和 GUC 设置。对于每一种类型的hint语句有一个 hint 语句列表<a href=\"http://pghintplan.sourceforge.jp/hint_list.html\">http://pghintplan.sourceforge.jp/hint_list.html</a></p>\n<h2 id=\"hint-的扫描方法\"><a href=\"#hint-的扫描方法\" class=\"headerlink\" title=\"hint 的扫描方法\"></a>hint 的扫描方法</h2><p>hint 的扫描方法通过在表上指定一个参数来选择一种扫描方式。pg_hint 可以通过表的别名来识别一个表。他们可以是 ‘SeqScan’，‘IndexScan’ 等等。</p>\n<p>hint 扫描在普通表，继承表，UNLOGGED 表，临时表，系统表是有效的。它不能应用在外部表，表函数，命令的值（VALUES command results），CTEs，视图和子查询中。</p>\n<h2 id=\"Hints-的-join-方法\"><a href=\"#Hints-的-join-方法\" class=\"headerlink\" title=\"Hints 的 join 方法\"></a>Hints 的 join 方法</h2><p>使用表名作为参数的 jion 方法名来指定 Hints 的 join 方法</p>\n<p>在参数列表中可以使用普通表，继承表，UNLOGGED 表，临时表，外部表，系统表，表函数，命令的值（VALUES command results），CTEs 作为参数。但是视图和子查询不可以。</p>\n<h2 id=\"Hint-的-join-顺序\"><a href=\"#Hint-的-join-顺序\" class=\"headerlink\" title=\"Hint 的 join 顺序\"></a>Hint 的 join 顺序</h2><p>可以使用 “Leading” 来指定 join 的顺序。join 的顺序将按照参数列表的给出顺序来执行。</p>\n<h2 id=\"Hint-纠正行数\"><a href=\"#Hint-纠正行数\" class=\"headerlink\" title=\"Hint 纠正行数\"></a>Hint 纠正行数</h2><p>由于查询规划器的能力限制，它可能错误的估计一些条件下的结果集的数量。这种类型的 hint 将会纠正这种情况。</p>\n<h2 id=\"GUC-参数的临时设置\"><a href=\"#GUC-参数的临时设置\" class=\"headerlink\" title=\"GUC 参数的临时设置\"></a>GUC 参数的临时设置</h2><p>在查询规划时设置 hint 来改变 GUC 的参数。在 Query Planning 指定 GUC 的参数可以在查询规划时得到预期的效果，除非其他的 hint 和查询规划器配置的参数冲突了。相同的 GUC 参数在 hint 中最后一个配置的将会生效。对于pg_hint_plan 可以通过 hint 来设置 GUC 参数，但是它不一定会按照预期的工作。详细内容可以看限制章节。</p>\n<h1 id=\"pg-hint-plan-的-GUC-参数\"><a href=\"#pg-hint-plan-的-GUC-参数\" class=\"headerlink\" title=\"pg_hint_plan 的 GUC 参数\"></a>pg_hint_plan 的 GUC 参数</h1><p>下面的 GUC 参数会影响 pg_hint_plan 的行为.</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>Parameter name</th>\n<th>description</th>\n<th>Default</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pg_hint_plan.enable_hint</td>\n<td>Enbles or disables the function of pg_hint_plan.</td>\n<td>on</td>\n</tr>\n<tr>\n<td>pg_hint_plan.debug_print</td>\n<td>Enables and select the verbosity of the debug output of pg_hint_plan. off, on, detailed and verbose are valid.</td>\n<td>off</td>\n</tr>\n<tr>\n<td>pg_hint_plan.message_level</td>\n<td>Specifies the message level of debug prints. error, warning, notice, info, log, debug are valid and fatal and panic are inhibited.</td>\n<td>info</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>对于这些 GUC 参数 PostgreSQL 9.1 需要定义一个变量类. 详细内容见 custom_variable_classes.</p>\n<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><p>这部分描述了安装的步骤。</p>\n<h2 id=\"编译二进制模块\"><a href=\"#编译二进制模块\" class=\"headerlink\" title=\"编译二进制模块\"></a>编译二进制模块</h2><p>在源码的根目录执行 “make”，然后使用合适的角色执行 “make install”。在这个过程中对于 PostgresQL 应该将环境变量设置为合适的值。<br><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">$ tar xzvf pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x.tar.gz<br>$ cd pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x<br>$ make<br>$ su<br>$ make install<br></code></pre></td></tr></table></figure></p>\n<h2 id=\"加载-pg-hint-plan\"><a href=\"#加载-pg-hint-plan\" class=\"headerlink\" title=\"加载 pg_hint_plan\"></a>加载 pg_hint_plan</h2><p>pg_hint_plan 不需要使用 CREATE EXTENSION.只要使用 LOAD 命令将它激活，当然你也可以全局的加载它通过在 postgresql.conf 中设置 shared_preload_libraries。你也可以使用 ALTER USER SET/ALTER DATABASE SET 在指定的会话中自动的加载它。</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-attribute\">postgres</span>=# LOAD <span class=\"hljs-string\">&#x27;pg_hint_plan&#x27;</span>;<br>LOAD<br><span class=\"hljs-attribute\">postgres</span>=#<br></code></pre></td></tr></table></figure>\n<p>如果你计划 hint 表，你需要设置 pg_hint_plan.enable_hint_tables 值为 on。</p>\n<h2 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h2><p>如果你使用源码安装了 pg_hint_plan，你可以在源码的根目录使用 “make uninstall” 来卸载安装的文件。</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">$ cd pg_hint_plan<span class=\"hljs-number\">-1.</span>x.x<br>$ su<br># make uninstall<br></code></pre></td></tr></table></figure>\n<h1 id=\"Hint-描述\"><a href=\"#Hint-描述\" class=\"headerlink\" title=\"Hint 描述\"></a>Hint 描述</h1><p>这部分描述了怎么写各种类型的 hints。</p>\n<h2 id=\"扫描方法-hints\"><a href=\"#扫描方法-hints\" class=\"headerlink\" title=\"扫描方法 hints\"></a>扫描方法 hints</h2><p>扫描 hints 使用一个参数去指定目标对象。使用索引作为参数最好使用索引名。目标对象如果有别名参数应该指定为别名。在下面的例子中 table1 使用顺序扫描，table2 使用主键索引扫描。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+<br><span class=\"hljs-attribute\">postgres</span>*#     SeqScan(t<span class=\"hljs-number\">1</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     IndexScan(t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span>_pkey)<br><span class=\"hljs-attribute\">postgres</span>*#  */<br><span class=\"hljs-attribute\">postgres</span>-# SELECT * FROM table<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">1</span> JOIN table table<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">1</span>.key = t<span class=\"hljs-number\">2</span>.key);<br></code></pre></td></tr></table></figure>\n<h2 id=\"Join-hints\"><a href=\"#Join-hints\" class=\"headerlink\" title=\"Join hints\"></a>Join hints</h2><p>join hints 使用两个或多个组成 join 的对象作为参数。如果指定了三个对象，hint 将会 join 两个对象后再 join 他们中的一个。在下面的例子中，首先使用嵌套循环 join talbe1 和 table2，然后使用合并 join 前面的结果和 table3.<br><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+<br><span class=\"hljs-attribute\">postgres</span>*#     NestLoop(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     MergeJoin(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>)<br><span class=\"hljs-attribute\">postgres</span>*#     Leading(t<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>)<br><span class=\"hljs-attribute\">postgres</span>*#  */<br><span class=\"hljs-attribute\">postgres</span>-# SELECT * FROM table<span class=\"hljs-number\">1</span> t<span class=\"hljs-number\">1</span><br><span class=\"hljs-attribute\">postgres</span>-#     JOIN table table<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">2</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">1</span>.key = t<span class=\"hljs-number\">2</span>.key)<br><span class=\"hljs-attribute\">postgres</span>-#     JOIN table table<span class=\"hljs-number\">3</span> t<span class=\"hljs-number\">3</span> <span class=\"hljs-literal\">ON</span> (t<span class=\"hljs-number\">2</span>.key = t<span class=\"hljs-number\">3</span>.key);<br><br></code></pre></td></tr></table></figure></p>\n<h2 id=\"join-顺序\"><a href=\"#join-顺序\" class=\"headerlink\" title=\"join 顺序\"></a>join 顺序</h2><p>尽管先 join table2 和 table3 然后 join table1 这种情况可能出现，但是 NestLoop hint 将不会生效。”Leading” hint 在这种情况下可以强制改变 join 顺序。在上面的例子中 Leading hint 改变 join 顺序为 table1,2,3 然后这两种 join 方法都会生效。</p>\n<p>上面 Leading hint 的形式改变了 join 的顺序，但是查询规划器的 join 顺序是自左至右的。如果你想改变 join 的方向，第二种方法是有效的。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">postgres</span>=# /*+ Leading((t<span class=\"hljs-number\">1</span> (t<span class=\"hljs-number\">2</span> t<span class=\"hljs-number\">3</span>))) */ SELECT...<br></code></pre></td></tr></table></figure>\n<p>每对括号包括两个元素，可以是对象也可以是嵌套的括号。括号中的第一个元素是驱动者或外部表，第二个是被驱动或者内部。</p>\n<h2 id=\"hints-纠正结果集数量\"><a href=\"#hints-纠正结果集数量\" class=\"headerlink\" title=\"hints 纠正结果集数量\"></a>hints 纠正结果集数量</h2><p>如果查询规划器错误的估计了在一些条件下join返回的结果集数量。这个 hint 可以通过几种方法来纠正这个值，包括绝对值，加减和乘法。参数是组成 join 的对象和操作。下面的例子通过4个例子给出了纠正 a join b 返回的值数量的用法。</p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs makefile\">postgres=<span class=\"hljs-comment\"># /*+ Rows(a b #10) */ SELECT... ; Sets rows of join result to 10</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b +10) */ SELECT... ; Increments row number by 10</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b -10) */ SELECT... ; Subtracts 10 from the row number.</span><br>postgres=<span class=\"hljs-comment\"># /*+ Rows(a b *10) */ SELECT... ; Makes the number 10 times larger.</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"GUC-临时设置\"><a href=\"#GUC-临时设置\" class=\"headerlink\" title=\"GUC 临时设置\"></a>GUC 临时设置</h2><p>在目标语句设置查询规划器使用的 GUC 参数，下面的列子，在该查询中设置查询规划器使用 random_page_cost 的值为 2.0</p>\n<figure class=\"highlight n1ql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs n1ql\">postgres=# <span class=\"hljs-comment\">/*+</span><br><span class=\"hljs-comment\">postgres*#     Set(random_page_cost 2.0)</span><br><span class=\"hljs-comment\">postgres*#  */</span><br>postgres-# <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1 <span class=\"hljs-keyword\">WHERE</span> <span class=\"hljs-keyword\">key</span> = <span class=\"hljs-string\">&#x27;value&#x27;</span>;<br>...<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"Hint-语法\"><a href=\"#Hint-语法\" class=\"headerlink\" title=\"Hint 语法\"></a>Hint 语法</h1><h2 id=\"Hint-注释位置\"><a href=\"#Hint-注释位置\" class=\"headerlink\" title=\"Hint 注释位置\"></a>Hint 注释位置</h2><p>pg_hint_plan 在第一个注释块读取 hint，在这个注释块中只允许有字母，数字，空格，下划线，逗号，和括号。在下面的例子中 HashJoin(a b) and SeqScan(a) 被认为是 hint 而 IndexScan(a) and MergeJoin(a b) 不是 hint.</p>\n<figure class=\"highlight jboss-cli\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs jboss-cli\">postgres=<span class=\"hljs-comment\"># /*+</span><br>postgres*<span class=\"hljs-comment\">#    HashJoin(a b)</span><br>postgres*<span class=\"hljs-comment\">#    SeqScan(a)</span><br>postgres*<span class=\"hljs-comment\">#  */</span><br>postgres-<span class=\"hljs-comment\"># /*+ IndexScan(a) */</span><br>postgres-<span class=\"hljs-comment\"># EXPLAIN SELECT /*+ MergeJoin(a b) */ *</span><br>postgres-<span class=\"hljs-comment\">#    FROM pgbench_branches b</span><br>postgres-<span class=\"hljs-comment\">#    JOIN pgbench_accounts a ON b.bid = a.bid</span><br>postgres-<span class=\"hljs-comment\">#   ORDER BY a.aid;</span><br>                                      QUERY PLAN<br><span class=\"hljs-params\">---------------------------------------------------------------------------------------</span><br> Sort  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=31465.84..31715.84 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>   Sort Key: a.aid<br>   -&gt;  Hash Join  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.02..4016.02 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=197)</span><br>         Hash Cond: <span class=\"hljs-params\">(a.<span class=\"hljs-attr\">bid</span> = b.bid)</span><br>         -&gt;  Seq Scan on pgbench_accounts a  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..2640.00 <span class=\"hljs-attr\">rows</span>=100000 <span class=\"hljs-attr\">width</span>=97)</span><br>         -&gt;  Hash  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=1.01..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br>               -&gt;  Seq Scan on pgbench_branches b  <span class=\"hljs-params\">(<span class=\"hljs-attr\">cost</span>=0.00..1.01 <span class=\"hljs-attr\">rows</span>=1 <span class=\"hljs-attr\">width</span>=100)</span><br><span class=\"hljs-params\">(7 rows)</span><br><br>postgres=<span class=\"hljs-comment\">#</span><br></code></pre></td></tr></table></figure>\n<p>在对象名字中转义特殊的字符</p>\n<p>作为 hint 参数的对象如果包括括号，双引号和空格应该使用双引号。和 PostgresQL 的转义规则相同。</p>\n<p>使用相同名字表之间的区分</p>\n<p>同一对象使用重复的名字出现多次和在不同表空间中使用相同名字的对象可以通过使用别名来区别，并且在 hint 语句中使用这些别名。下面的例子第一个 SQL 语句因为在查询语句中使用一个表名两次而导致了错误，而第二个语句可以正常工作因为 t1 每次出现使用了不同的别名并且在 HashJoin hint 中使用了别名。</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# <span class=\"hljs-comment\">/*+ HashJoin(t1 t1)*/</span><br>postgres-# EXPLAIN SELECT * FROM s1.t1<br>postgres-# JOIN <span class=\"hljs-keyword\">public</span>.t1 ON (s1.t1.id=<span class=\"hljs-keyword\">public</span>.t1.id);<br>INFO:  hint syntax error at <span class=\"hljs-keyword\">or</span> near <span class=\"hljs-string\">&quot;HashJoin(t1 t1)&quot;</span><br>DETAIL:  Relation name <span class=\"hljs-string\">&quot;t1&quot;</span> <span class=\"hljs-keyword\">is</span> ambiguous.<br>                            QUERY PLAN<br>------------------------------------------------------------------<br> Merge Join  (cost=<span class=\"hljs-number\">337.49</span>.<span class=\"hljs-number\">.781</span><span class=\"hljs-number\">.49</span> rows=<span class=\"hljs-number\">28800</span> width=<span class=\"hljs-number\">8</span>)<br>   Merge Cond: (s1.t1.id = <span class=\"hljs-keyword\">public</span>.t1.id)<br>   -&gt;  Sort  (cost=<span class=\"hljs-number\">168.75</span>.<span class=\"hljs-number\">.174</span><span class=\"hljs-number\">.75</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         Sort Key: s1.t1.id<br>         -&gt;  Seq Scan on t1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>   -&gt;  Sort  (cost=<span class=\"hljs-number\">168.75</span>.<span class=\"hljs-number\">.174</span><span class=\"hljs-number\">.75</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         Sort Key: <span class=\"hljs-keyword\">public</span>.t1.id<br>         -&gt;  Seq Scan on t1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">8</span> 行)<br><br>postgres=# <span class=\"hljs-comment\">/*+ HashJoin(pt st) */</span><br>postgres-# EXPLAIN SELECT * FROM s1.t1 st<br>postgres-# JOIN <span class=\"hljs-keyword\">public</span>.t1 pt ON (st.id=pt.id);<br>                             QUERY PLAN<br>---------------------------------------------------------------------<br> Hash Join  (cost=<span class=\"hljs-number\">64.00</span>.<span class=\"hljs-number\">.1112</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">28800</span> width=<span class=\"hljs-number\">8</span>)<br>   Hash Cond: (st.id = pt.id)<br>   -&gt;  Seq Scan on t1 st  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>   -&gt;  Hash  (cost=<span class=\"hljs-number\">34.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>         -&gt;  Seq Scan on t1 pt  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.34</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">2400</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">5</span> 行)<br><br>postgres=#<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"限制\"><a href=\"#限制\" class=\"headerlink\" title=\"限制\"></a>限制</h1><h2 id=\"在-from-子句中多种值的限制\"><a href=\"#在-from-子句中多种值的限制\" class=\"headerlink\" title=\"在 from 子句中多种值的限制\"></a>在 from 子句中多种值的限制</h2><p>无论是语法中给定别名还是在 explain 中显示的描述，所有在 from 子句中出现的值都具有相同的名字 “VALUES”。所以如果他们在目标查询中出现两次及以上将不能使用 hints。</p>\n<h2 id=\"在继承表上的使用\"><a href=\"#在继承表上的使用\" class=\"headerlink\" title=\"在继承表上的使用\"></a>在继承表上的使用</h2><p>继承表不能单独的使用 hint。他们和他们父表共享相同的 hint。</p>\n<h2 id=\"通过设置-hint-来设置-pg-hint-plan-参数\"><a href=\"#通过设置-hint-来设置-pg-hint-plan-参数\" class=\"headerlink\" title=\"通过设置 hint 来设置 pg_hint_plan 参数\"></a>通过设置 hint 来设置 pg_hint_plan 参数</h2><p>pg_hint_plan 参数改变了它原来的行为所以一些参数不能按照期待的执行。</p>\n<pre><code>hint 改变了 enalbe_hint,enable_hint_tables 被忽略了，但是他们在 debug 日志中记录为 “used hints”。\n设置 debug_print 和 message_level 工作在目标查询的中间处理。\n</code></pre><h1 id=\"hint-在目标语句中使用方法\"><a href=\"#hint-在目标语句中使用方法\" class=\"headerlink\" title=\"hint 在目标语句中使用方法\"></a>hint 在目标语句中使用方法</h1><h2 id=\"hint-在查询语句中隐含实体的使用\"><a href=\"#hint-在查询语句中隐含实体的使用\" class=\"headerlink\" title=\"hint 在查询语句中隐含实体的使用\"></a>hint 在查询语句中隐含实体的使用</h2><p>Hint 对于任何带有目的名字的对象都是有效的，即使他们没有出现在查询语句中，例如在视图里的对象。这样如果你想使用不同于第一个视图的 hint 你可以在不同的视图对同一对象使用不用的别名。</p>\n<p>在下面的例子中，在第一个查询中出现的两个表中使用了相同的名字 t1,所以 hint SeqScan(t1) 将会在两次扫描中生效。另一方面第二个语句中在这两个出现的表中使用了不同的名字 t3 所以 hint 只影响这一个扫描。</p>\n<p>这个机制也可以应用在两个重写的查询语句中。</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\">postgres=# <span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">VIEW</span> view1 <span class=\"hljs-keyword\">AS</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span><br>postgres=# <span class=\"hljs-comment\">/*+ SeqScan(t1) */</span><br>postgres=# <span class=\"hljs-keyword\">EXPLAIN</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t1 <span class=\"hljs-keyword\">JOIN</span> view1 t2 <span class=\"hljs-keyword\">ON</span> (t1.key = t2.key) <span class=\"hljs-keyword\">WHERE</span> t2.key = <span class=\"hljs-number\">1</span>;<br>                           QUERY PLAN<br><span class=\"hljs-comment\">-----------------------------------------------------------------</span><br> Nested <span class=\"hljs-keyword\">Loop</span>  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.358</span><span class=\"hljs-number\">.01</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">16</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>(<span class=\"hljs-number\">5</span> <span class=\"hljs-keyword\">rows</span>)<br><br>postgres=# <span class=\"hljs-comment\">/*+ SeqScan(t3) */</span><br>postgres=# <span class=\"hljs-keyword\">EXPLAIN</span> <span class=\"hljs-keyword\">SELECT</span> * <span class=\"hljs-keyword\">FROM</span> table1 t3 <span class=\"hljs-keyword\">JOIN</span> view1 t2 <span class=\"hljs-keyword\">ON</span> (t1.key = t2.key) <span class=\"hljs-keyword\">WHERE</span> t2.key = <span class=\"hljs-number\">1</span>;<br>                                   QUERY PLAN<br><span class=\"hljs-comment\">--------------------------------------------------------------------------------</span><br> Nested <span class=\"hljs-keyword\">Loop</span>  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.187</span><span class=\"hljs-number\">.29</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">16</span>)<br>   -&gt;  Seq Scan <span class=\"hljs-keyword\">on</span> table1 t3  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.179</span><span class=\"hljs-number\">.00</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Filter</span>: (key = <span class=\"hljs-number\">1</span>)<br>   -&gt;  <span class=\"hljs-keyword\">Index</span> Scan <span class=\"hljs-keyword\">using</span> foo_pkey <span class=\"hljs-keyword\">on</span> table1 t1  (<span class=\"hljs-keyword\">cost</span>=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.8</span><span class=\"hljs-number\">.28</span> <span class=\"hljs-keyword\">rows</span>=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">8</span>)<br>         <span class=\"hljs-keyword\">Index</span> Cond: (key = <span class=\"hljs-number\">1</span>)<br>(<span class=\"hljs-number\">5</span> <span class=\"hljs-keyword\">rows</span>)<br></code></pre></td></tr></table></figure>\n<h2 id=\"Hint-在继承中的使用\"><a href=\"#Hint-在继承中的使用\" class=\"headerlink\" title=\"Hint 在继承中的使用\"></a>Hint 在继承中的使用</h2><p>hint 作用在父表将自动影响它的所有孩子。子表不能自己指定自己的 hint。</p>\n<h2 id=\"hint-在多条语句中的作用范围\"><a href=\"#hint-在多条语句中的作用范围\" class=\"headerlink\" title=\"hint 在多条语句中的作用范围\"></a>hint 在多条语句中的作用范围</h2><p>一个多语句描述只能有一个 hint 注释并且这个注释会作用在这个多语句的所有单条语句上。注意在一个交互的 psql 的看似多语句实际上是一系列单条语句，所以 hint 只作用在跟在它后面的一条语句。相反每一个单条语句有他们自己的 hint 注释。</p>\n<h2 id=\"在一些上下文中的子查询\"><a href=\"#在一些上下文中的子查询\" class=\"headerlink\" title=\"在一些上下文中的子查询\"></a>在一些上下文中的子查询</h2><p>在下面的上下文中子查询也可以使用 hint。</p>\n<p>IN (SELECT … {LIMIT | OFFSET …} …)<br>= ANY (SELECT … {LIMIT | OFFSET …} …)<br>= SOME (SELECT … {LIMIT | OFFSET …} …)</p>\n<p>对于这些语法，当计划 jion 子查询结果时，查询规划器内部分配子查询的名字为 “ANY subquery”，所以 join hint 使用隐含的名字作用在这些 join 中。</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">postgres=# <span class=\"hljs-comment\">/*+HashJoin(a1 ANY_subquery)*/</span><br>postgres=# EXPLAIN SELECT *<br>postgres=#    FROM pgbench_accounts a1<br>postgres=#   WHERE aid IN (SELECT bid FROM pgbench_accounts a2 LIMIT <span class=\"hljs-number\">10</span>);<br>                                         QUERY PLAN<br><br>---------------------------------------------------------------------------------------------<br> Hash Semi Join  (cost=<span class=\"hljs-number\">0.49</span>.<span class=\"hljs-number\">.2903</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">1</span> width=<span class=\"hljs-number\">97</span>)<br>   Hash Cond: (a1.aid = a2.bid)<br>   -&gt;  Seq Scan on pgbench_accounts a1  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.2640</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">100000</span> width=<span class=\"hljs-number\">97</span>)<br>   -&gt;  Hash  (cost=<span class=\"hljs-number\">0.36</span>.<span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.36</span> rows=<span class=\"hljs-number\">10</span> width=<span class=\"hljs-number\">4</span>)<br>         -&gt;  Limit  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.26</span> rows=<span class=\"hljs-number\">10</span> width=<span class=\"hljs-number\">4</span>)<br>               -&gt;  Seq Scan on pgbench_accounts a2  (cost=<span class=\"hljs-number\">0.00</span>.<span class=\"hljs-number\">.2640</span><span class=\"hljs-number\">.00</span> rows=<span class=\"hljs-number\">100000</span> width=<span class=\"hljs-number\">4</span>)<br>(<span class=\"hljs-number\">6</span> rows)<br></code></pre></td></tr></table></figure>\n<h2 id=\"使用-IndexOnlyScan-hint-PostgreSQL-9-2及之后的版本\"><a href=\"#使用-IndexOnlyScan-hint-PostgreSQL-9-2及之后的版本\" class=\"headerlink\" title=\"使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)\"></a>使用 IndexOnlyScan hint (PostgreSQL 9.2及之后的版本)</h2><p>如果你在一个表上使用 IndexOnlyScan hint 你应该明确的指定一个能执行仅扫描的索引，而其他的索引不能执行仅扫描。否则 pg_hint_plan 可能会选择他们.</p>\n<h2 id=\"NoIndexScan-hint-的预防要点-PostgreSQL-9-2-及以后版本\"><a href=\"#NoIndexScan-hint-的预防要点-PostgreSQL-9-2-及以后版本\" class=\"headerlink\" title=\"NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)\"></a>NoIndexScan hint 的预防要点 (PostgreSQL 9.2 及以后版本)</h2><p>NoIndexScan hint 涉及到 NoIndexOnlyScan.</p>\n<h1 id=\"hints-的错误处理\"><a href=\"#hints-的错误处理\" class=\"headerlink\" title=\"hints 的错误处理\"></a>hints 的错误处理</h1><p>在大多数情况下 pg_hint_plan 停止解析任何错误并且使用 hints 已经解析的内容。下面是一些典型的错误。</p>\n<h2 id=\"语法错误\"><a href=\"#语法错误\" class=\"headerlink\" title=\"语法错误\"></a>语法错误</h2><p>任何语法错误或者错误的 hint 名字被记录为语法错误。如果 pg_hint_plan.debug_print 被设置为 on 这些错误将会记录在服务器的日志中，并使用 pg_hint_plan.message_level 中指定的信息级别。</p>\n<h2 id=\"错误规格\"><a href=\"#错误规格\" class=\"headerlink\" title=\"错误规格\"></a>错误规格</h2><p>对象的错误规格将会导致被 hints 忽略。这种错误竟会和语法错误一样在日志中被记录为 “not used hints”。</p>\n<h2 id=\"冗余或冲突的-hints\"><a href=\"#冗余或冲突的-hints\" class=\"headerlink\" title=\"冗余或冲突的 hints\"></a>冗余或冲突的 hints</h2><p>当冗余 hints 或者互相冲突的 hint 出现时最后一个 hint 将会生效。这种错误将会和语法错误一样在日志中被记录为 “duplication hints”。</p>\n<h2 id=\"嵌套注释\"><a href=\"#嵌套注释\" class=\"headerlink\" title=\"嵌套注释\"></a>嵌套注释</h2><p>在 hint 的注释内不能嵌套另一个注释。如果 pg_hint_plan 发现这种情况，不同于其它错误的处理方法，它停止解析并且放弃已经解析的所有 hint。这种错误和其他错误以一样的方式记录。</p>\n<h1 id=\"函数限制\"><a href=\"#函数限制\" class=\"headerlink\" title=\"函数限制\"></a>函数限制</h1><h2 id=\"GUC-参数对查询规划器的影响\"><a href=\"#GUC-参数对查询规划器的影响\" class=\"headerlink\" title=\"GUC 参数对查询规划器的影响\"></a>GUC 参数对查询规划器的影响</h2><p>对于 FROM 子句的数量超过了 from_collapse_limit 的情况，查询规划器不会考虑 join 的顺序。在这种情况下 pg_hint_plan 不会影响 join 的顺序。</p>\n<h2 id=\"pg-hint-plan-本质上无效的情况\"><a href=\"#pg-hint-plan-本质上无效的情况\" class=\"headerlink\" title=\"pg_hint_plan 本质上无效的情况\"></a>pg_hint_plan 本质上无效的情况</h2><p>因为 pg_hint_plan 性质，它对查询规划器作用范围之外的情况是无效的，包括下面的情况：</p>\n<ul>\n<li>使用嵌套循环的 FULL OUTER JOIN</li>\n<li>没有使用索引资格的列去使用索引</li>\n<li>不带 ctid 条件的查询做 TID 扫描</li>\n</ul>\n<h2 id=\"在-ECPG-程序中的查询\"><a href=\"#在-ECPG-程序中的查询\" class=\"headerlink\" title=\"在 ECPG 程序中的查询\"></a>在 ECPG 程序中的查询</h2><p>在嵌入式 SQL 语句中 ECPG 删除了查询语句中的注释所以 hints 不能传给这些查询语句。唯一的方法是通过命令传 给定的未修改的字符串。在这种情况下需要考虑 hint 表。</p>\n<h2 id=\"查询指纹的影响\"><a href=\"#查询指纹的影响\" class=\"headerlink\" title=\"查询指纹的影响\"></a>查询指纹的影响</h2><p>相同的查询使用不同的注释在 PostgresQL 9.2及以后会产生相同的指纹，但是他们在9.1及以前会产生不同的指纹，带有不同 hint 的相同的查询在这个版本被作为单独查询。</p>\n<h1 id=\"英文版\"><a href=\"#英文版\" class=\"headerlink\" title=\"英文版\"></a>英文版</h1><p><a href=\"http://pghintplan.sourceforge.jp/pg_hint_plan.html\">http://pghintplan.sourceforge.jp/pg_hint_plan.html</a></p>"},{"title":"CentOS7+PostgreSQL11.2+Docker","date":"2021-03-11T08:36:07.000Z","top":34,"description":"PostgreSQL Docker image 制作","password":null,"_content":"\n# OS image\n## 编写centos7.sh\n```\n#!/bin/bash\nmkdir centos7\ncd centos7\nsupermin5 -v --prepare bash grep yum yum-plugin rpm systemd pkgconfig initscripts -o supermin.d\nsupermin5 -v --build --format chroot supermin.d -o appliance.d\ncp /etc/resolv.conf appliance.d/etc/\necho 7 > appliance.d/etc/yum/vars/releasever\ntar --numeric-owner -cpf centos-7.tar -C appliance.d .\ncat centos-7.tar | docker import - os/centos\n```\n\n<!--more-->\n\n## 生成OS image\n```\n# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED              SIZE\nos/centos           latest              88805d994ae8        About a minute ago   279MB\n```\n\n# PostgreSQL image\n\n## 初始化PostgreSQL基础信息脚本\n```\n#!/bin/bash\nsu postgres <<EOF\n/opt/pg11/bin/pg_ctl start -D /export/pg110_data;\nexit;\nEOF\n```\n## 自定义dockerfile\n```\nFROM os/centos\n \nRUN localedef -c -f UTF-8 -i en_US en_US.utf8\n \nENV LANG=en_US.UTF-8 \\\n    LANGUAGE=en_US:zh \\\n    LC_ALL=en_US.UTF-8\n \nMAINTAINER taot.jin <84660320@qq.com>\n \nRUN mkdir /export\nADD ./pg110_data /export/pg110_data\n \nRUN mkdir /export/rpms\nADD ./rpms/*.rpm /export/rpms/\n#RUN rpm -ivh  /export/rpms/geos-*.rpm  /export/rpms/proj-*.rpm /export/rpms/gdal-*.rpm /export/rpms/json-c*.rpm  /export/rpms/postgis-*.rpm\n \nRUN useradd postgres\nRUN chown -R postgres:postgres /export/pg110_data\nRUN chmod 0700 /export/pg110_data\n \nRUN rm /etc/yum.repos.d/*.repo\nADD ./qunar.repo /etc/yum.repos.d/\n \nENV LD_LIBRARY_PATH \"/opt/pg11/lib:/usr/lib64:/lib64:/usr/lib:/lib\"\nENV PATH  \"/opt/pg11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\n \nRUN ldconfig\n \nRUN yum clean all && yum makecache && yum install -y postgresql wget pkgconfig\n \nADD ./start_postgres.sh /start_postgres.sh\nRUN chmod +x /start_postgres.sh\n \n#RUN echo \"su postgres -c \\\"/opt/pg11/bin/pg_ctl -D /export/pg110_data restart &>/export/pg110_data/log/postgre_start.log\\\"\" >> /etc/rc.local\n \nVOLUME [\"/export/pg110_data\"]\nVOLUME [\"/opt/pg11\"]\nEXPOSE 5432\n \n#RUN echo \"host    all             all             0.0.0.0/0               md5\" >> /var/lib/pgsql/data/pg_hba.conf\n \nCMD [\"/start_postgres.sh\"]\n```\n\n## 生成image\n```\n# docker image build -t postgresql11.2.1 .\n```\n\n# 数据持久化\n```\ndocker volume ls\ndocker volume create pg110_data\ndocker volume create opt_pg11_1\n\n\ndocker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.1\ndocker run -it --mount type=bind,source=/export,target=/export postgresql:11.2.1\n```\n\n# 更新image\n```\n# rpm -qa|grep  proj\n# rpm -ivh proj-4.9.2-1.el7.x86_64.rpm\nPreparing...                          ################################# [100%]\nUpdating / installing...\n   1:proj-4.9.2-1.el7                 ################################# [100%]\n# rpm -qa|grep proj\nproj-4.9.2-1.el7.x86_64\n# docker container ps -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                       PORTS               NAMES\n5aeefd7f48e9        postgresql:11.2.1   \"/bin/sh -c /start_p…\"   About a minute ago   Exited (130) 9 seconds ago                       zealous_ganguly\n\n# docker commit -m \"test commit\" 5aeefd7f48e9 postgresql:11.2.2\nsha256:df7a3a3cff7fd017e889dce7d03885e65f1b512ad3e443ab8254e5375805e24d\n\n# docker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.2\npg_ctl: another server might be running; trying to start server anyway\nwaiting for server to start....[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 1  0]LOG:  listening on IPv4 address \"0.0.0.0\", port 5432\n[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 2  0]LOG:  listening on IPv6 address \"::\", port 5432\n[    2019-03-04 17:23:41.740 CST 10 5c7cee9d.a 3  0]LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 4  0]LOG:  redirecting log output to logging collector process\n[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 5  0]HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n\n# image迁移\n## save/load\n### save导出\n```\ndocker save c92217432f48 > postgresql.tar\n```\n\n### load导入\n```\ndocker load < postgresql.tar\ndocker tag c92217432f48 postgresql:11.2.4\n```\n\n## export/import\n### export导出\n```\n# docker container ps -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES\n9caea184f25b        postgresql:11.2.1   \"/bin/sh -c /start_p…\"   6 minutes ago       Exited (0) 8 seconds ago                       relaxed_benz\n\n# docker export 9caea184f25b > postgresql.tar\n```\n\n### import导入\n```\ncat postgresql.tar |docker import - postgresql:11.2.2\n```\n\n\n# 错误处理\n```\nhttps://www.libaocai.com/2767.html\n```\n","source":"_posts/PostgreSQL_docker.md","raw":"---\ntitle: CentOS7+PostgreSQL11.2+Docker\ndate: 2021-03-11 16:36:07\ntags:\n- docker\n- PostgreSQL\ncategories: \n- PostgreSQL\n- docker\ntop: 34\ndescription: PostgreSQL Docker image 制作\npassword: \n\n---\n\n# OS image\n## 编写centos7.sh\n```\n#!/bin/bash\nmkdir centos7\ncd centos7\nsupermin5 -v --prepare bash grep yum yum-plugin rpm systemd pkgconfig initscripts -o supermin.d\nsupermin5 -v --build --format chroot supermin.d -o appliance.d\ncp /etc/resolv.conf appliance.d/etc/\necho 7 > appliance.d/etc/yum/vars/releasever\ntar --numeric-owner -cpf centos-7.tar -C appliance.d .\ncat centos-7.tar | docker import - os/centos\n```\n\n<!--more-->\n\n## 生成OS image\n```\n# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED              SIZE\nos/centos           latest              88805d994ae8        About a minute ago   279MB\n```\n\n# PostgreSQL image\n\n## 初始化PostgreSQL基础信息脚本\n```\n#!/bin/bash\nsu postgres <<EOF\n/opt/pg11/bin/pg_ctl start -D /export/pg110_data;\nexit;\nEOF\n```\n## 自定义dockerfile\n```\nFROM os/centos\n \nRUN localedef -c -f UTF-8 -i en_US en_US.utf8\n \nENV LANG=en_US.UTF-8 \\\n    LANGUAGE=en_US:zh \\\n    LC_ALL=en_US.UTF-8\n \nMAINTAINER taot.jin <84660320@qq.com>\n \nRUN mkdir /export\nADD ./pg110_data /export/pg110_data\n \nRUN mkdir /export/rpms\nADD ./rpms/*.rpm /export/rpms/\n#RUN rpm -ivh  /export/rpms/geos-*.rpm  /export/rpms/proj-*.rpm /export/rpms/gdal-*.rpm /export/rpms/json-c*.rpm  /export/rpms/postgis-*.rpm\n \nRUN useradd postgres\nRUN chown -R postgres:postgres /export/pg110_data\nRUN chmod 0700 /export/pg110_data\n \nRUN rm /etc/yum.repos.d/*.repo\nADD ./qunar.repo /etc/yum.repos.d/\n \nENV LD_LIBRARY_PATH \"/opt/pg11/lib:/usr/lib64:/lib64:/usr/lib:/lib\"\nENV PATH  \"/opt/pg11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\n \nRUN ldconfig\n \nRUN yum clean all && yum makecache && yum install -y postgresql wget pkgconfig\n \nADD ./start_postgres.sh /start_postgres.sh\nRUN chmod +x /start_postgres.sh\n \n#RUN echo \"su postgres -c \\\"/opt/pg11/bin/pg_ctl -D /export/pg110_data restart &>/export/pg110_data/log/postgre_start.log\\\"\" >> /etc/rc.local\n \nVOLUME [\"/export/pg110_data\"]\nVOLUME [\"/opt/pg11\"]\nEXPOSE 5432\n \n#RUN echo \"host    all             all             0.0.0.0/0               md5\" >> /var/lib/pgsql/data/pg_hba.conf\n \nCMD [\"/start_postgres.sh\"]\n```\n\n## 生成image\n```\n# docker image build -t postgresql11.2.1 .\n```\n\n# 数据持久化\n```\ndocker volume ls\ndocker volume create pg110_data\ndocker volume create opt_pg11_1\n\n\ndocker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.1\ndocker run -it --mount type=bind,source=/export,target=/export postgresql:11.2.1\n```\n\n# 更新image\n```\n# rpm -qa|grep  proj\n# rpm -ivh proj-4.9.2-1.el7.x86_64.rpm\nPreparing...                          ################################# [100%]\nUpdating / installing...\n   1:proj-4.9.2-1.el7                 ################################# [100%]\n# rpm -qa|grep proj\nproj-4.9.2-1.el7.x86_64\n# docker container ps -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                       PORTS               NAMES\n5aeefd7f48e9        postgresql:11.2.1   \"/bin/sh -c /start_p…\"   About a minute ago   Exited (130) 9 seconds ago                       zealous_ganguly\n\n# docker commit -m \"test commit\" 5aeefd7f48e9 postgresql:11.2.2\nsha256:df7a3a3cff7fd017e889dce7d03885e65f1b512ad3e443ab8254e5375805e24d\n\n# docker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.2\npg_ctl: another server might be running; trying to start server anyway\nwaiting for server to start....[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 1  0]LOG:  listening on IPv4 address \"0.0.0.0\", port 5432\n[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 2  0]LOG:  listening on IPv6 address \"::\", port 5432\n[    2019-03-04 17:23:41.740 CST 10 5c7cee9d.a 3  0]LOG:  listening on Unix socket \"/tmp/.s.PGSQL.5432\"\n[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 4  0]LOG:  redirecting log output to logging collector process\n[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 5  0]HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n```\n\n\n# image迁移\n## save/load\n### save导出\n```\ndocker save c92217432f48 > postgresql.tar\n```\n\n### load导入\n```\ndocker load < postgresql.tar\ndocker tag c92217432f48 postgresql:11.2.4\n```\n\n## export/import\n### export导出\n```\n# docker container ps -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES\n9caea184f25b        postgresql:11.2.1   \"/bin/sh -c /start_p…\"   6 minutes ago       Exited (0) 8 seconds ago                       relaxed_benz\n\n# docker export 9caea184f25b > postgresql.tar\n```\n\n### import导入\n```\ncat postgresql.tar |docker import - postgresql:11.2.2\n```\n\n\n# 错误处理\n```\nhttps://www.libaocai.com/2767.html\n```\n","slug":"PostgreSQL_docker","published":1,"updated":"2021-03-12T06:24:32.140Z","_id":"ckm4mphgo0000hmebb34laopm","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"OS-image\"><a href=\"#OS-image\" class=\"headerlink\" title=\"OS image\"></a>OS image</h1><h2 id=\"编写centos7-sh\"><a href=\"#编写centos7-sh\" class=\"headerlink\" title=\"编写centos7.sh\"></a>编写centos7.sh</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br>mkdir centos7<br><span class=\"hljs-built_in\">cd</span> centos7<br>supermin5 -v --prepare bash grep yum yum-plugin rpm systemd pkgconfig initscripts -o supermin.d<br>supermin5 -v --build --format chroot supermin.d -o appliance.d<br>cp /etc/resolv.conf appliance.d/etc/<br><span class=\"hljs-built_in\">echo</span> 7 &gt; appliance.d/etc/yum/vars/releasever<br>tar --numeric-owner -cpf centos-7.tar -C appliance.d .<br>cat centos-7.tar | docker import - os/centos<br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"生成OS-image\"><a href=\"#生成OS-image\" class=\"headerlink\" title=\"生成OS image\"></a>生成OS image</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># docker images</span><br><span class=\"hljs-attribute\">REPOSITORY</span>          TAG                 IMAGE ID            CREATED              SIZE<br><span class=\"hljs-attribute\">os</span>/centos           latest              <span class=\"hljs-number\">88805</span>d<span class=\"hljs-number\">994</span>ae<span class=\"hljs-number\">8</span>        About a minute ago   <span class=\"hljs-number\">279</span>MB<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL-image\"><a href=\"#PostgreSQL-image\" class=\"headerlink\" title=\"PostgreSQL image\"></a>PostgreSQL image</h1><h2 id=\"初始化PostgreSQL基础信息脚本\"><a href=\"#初始化PostgreSQL基础信息脚本\" class=\"headerlink\" title=\"初始化PostgreSQL基础信息脚本\"></a>初始化PostgreSQL基础信息脚本</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/bin/bash</span><br>su postgres &lt;&lt;EOF<br><span class=\"hljs-regexp\">/opt/</span>pg11<span class=\"hljs-regexp\">/bin/</span>pg_ctl start -D <span class=\"hljs-regexp\">/export/</span>pg110_data;<br><span class=\"hljs-keyword\">exit</span>;<br>EOF<br></code></pre></td></tr></table></figure>\n<h2 id=\"自定义dockerfile\"><a href=\"#自定义dockerfile\" class=\"headerlink\" title=\"自定义dockerfile\"></a>自定义dockerfile</h2><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\"><span class=\"hljs-keyword\">FROM</span> os/centos<br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> localedef -c -f UTF-8 -i en_US en_US.utf8</span><br> <br><span class=\"hljs-keyword\">ENV</span> LANG=en_US.UTF-<span class=\"hljs-number\">8</span> \\<br>    LANGUAGE=en_US:zh \\<br>    LC_ALL=en_US.UTF-<span class=\"hljs-number\">8</span><br> <br><span class=\"hljs-keyword\">MAINTAINER</span> taot.jin &lt;<span class=\"hljs-number\">84660320</span>@qq.com&gt;<br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> mkdir /<span class=\"hljs-built_in\">export</span></span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./pg110_data /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> mkdir /<span class=\"hljs-built_in\">export</span>/rpms</span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./rpms/*.rpm /<span class=\"hljs-built_in\">export</span>/rpms/</span><br><span class=\"hljs-comment\">#RUN rpm -ivh  /export/rpms/geos-*.rpm  /export/rpms/proj-*.rpm /export/rpms/gdal-*.rpm /export/rpms/json-c*.rpm  /export/rpms/postgis-*.rpm</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> useradd postgres</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chown -R postgres:postgres /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chmod 0700 /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> rm /etc/yum.repos.d/*.repo</span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./qunar.repo /etc/yum.repos.d/</span><br> <br><span class=\"hljs-keyword\">ENV</span> LD_LIBRARY_PATH <span class=\"hljs-string\">&quot;/opt/pg11/lib:/usr/lib64:/lib64:/usr/lib:/lib&quot;</span><br><span class=\"hljs-keyword\">ENV</span> PATH  <span class=\"hljs-string\">&quot;/opt/pg11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> ldconfig</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> yum clean all &amp;&amp; yum makecache &amp;&amp; yum install -y postgresql wget pkgconfig</span><br> <br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./start_postgres.sh /start_postgres.sh</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chmod +x /start_postgres.sh</span><br> <br><span class=\"hljs-comment\">#RUN echo &quot;su postgres -c \\&quot;/opt/pg11/bin/pg_ctl -D /export/pg110_data restart &amp;&gt;/export/pg110_data/log/postgre_start.log\\&quot;&quot; &gt;&gt; /etc/rc.local</span><br> <br><span class=\"hljs-keyword\">VOLUME</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/export/pg110_data&quot;</span>]</span><br><span class=\"hljs-keyword\">VOLUME</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/opt/pg11&quot;</span>]</span><br><span class=\"hljs-keyword\">EXPOSE</span> <span class=\"hljs-number\">5432</span><br> <br><span class=\"hljs-comment\">#RUN echo &quot;host    all             all             0.0.0.0/0               md5&quot; &gt;&gt; /var/lib/pgsql/data/pg_hba.conf</span><br> <br><span class=\"hljs-keyword\">CMD</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/start_postgres.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"生成image\"><a href=\"#生成image\" class=\"headerlink\" title=\"生成image\"></a>生成image</h2><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"># docker image build -t postgresql11<span class=\"hljs-number\">.2</span><span class=\"hljs-number\">.1</span> .<br></code></pre></td></tr></table></figure>\n<h1 id=\"数据持久化\"><a href=\"#数据持久化\" class=\"headerlink\" title=\"数据持久化\"></a>数据持久化</h1><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\">docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> ls</span><br>docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> create pg110_data</span><br>docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> create opt_pg11_1</span><br><br><br>docker <span class=\"hljs-keyword\">run</span><span class=\"bash\"> -it -v pg110_data:/<span class=\"hljs-built_in\">export</span>/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.1</span><br>docker <span class=\"hljs-keyword\">run</span><span class=\"bash\"> -it --mount <span class=\"hljs-built_in\">type</span>=<span class=\"hljs-built_in\">bind</span>,<span class=\"hljs-built_in\">source</span>=/<span class=\"hljs-built_in\">export</span>,target=/<span class=\"hljs-built_in\">export</span> postgresql:11.2.1</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"更新image\"><a href=\"#更新image\" class=\"headerlink\" title=\"更新image\"></a>更新image</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-comment\"># rpm -qa|grep  proj</span><br><span class=\"hljs-comment\"># rpm -ivh proj-4.9.2-1.el7.x86_64.rpm</span><br>Preparing<span class=\"hljs-built_in\">..</span>.                          ################################# [100%]<br>Updating / installing<span class=\"hljs-built_in\">..</span>.<br>   1:proj-4.9.2-1.el7                 ################################# [100%]<br><span class=\"hljs-comment\"># rpm -qa|grep proj</span><br>proj-4.9.2-1.el7.x86_64<br><span class=\"hljs-comment\"># docker container ps -l</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                       PORTS               NAMES<br>5aeefd7f48e9        postgresql:11.2.1   <span class=\"hljs-string\">&quot;/bin/sh -c /start_p…&quot;</span>   About a minute ago   Exited (130) 9 seconds ago                       zealous_ganguly<br><br><span class=\"hljs-comment\"># docker commit -m &quot;test commit&quot; 5aeefd7f48e9 postgresql:11.2.2</span><br>sha256:df7a3a3cff7fd017e889dce7d03885e65f1b512ad3e443ab8254e5375805e24d<br><br><span class=\"hljs-comment\"># docker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.2</span><br>pg_ctl: another<span class=\"hljs-built_in\"> server </span>might be running; trying <span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\"> server </span>anyway<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 1  0]LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;0.0.0.0&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 2  0]LOG:  listening on<span class=\"hljs-built_in\"> IPv6 address </span><span class=\"hljs-string\">&quot;::&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>[    2019-03-04 17:23:41.740 CST 10 5c7cee9d.a 3  0]LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 4  0]LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 5  0]HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h1 id=\"image迁移\"><a href=\"#image迁移\" class=\"headerlink\" title=\"image迁移\"></a>image迁移</h1><h2 id=\"save-load\"><a href=\"#save-load\" class=\"headerlink\" title=\"save/load\"></a>save/load</h2><h3 id=\"save导出\"><a href=\"#save导出\" class=\"headerlink\" title=\"save导出\"></a>save导出</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">docker</span> save c<span class=\"hljs-number\">92217432</span>f<span class=\"hljs-number\">48</span> &gt; postgresql.tar<br></code></pre></td></tr></table></figure>\n<h3 id=\"load导入\"><a href=\"#load导入\" class=\"headerlink\" title=\"load导入\"></a>load导入</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">docker</span> load &lt; postgresql.tar<br><span class=\"hljs-attribute\">docker</span> tag c<span class=\"hljs-number\">92217432</span>f<span class=\"hljs-number\">48</span> postgresql:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">4</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"export-import\"><a href=\"#export-import\" class=\"headerlink\" title=\"export/import\"></a>export/import</h2><h3 id=\"export导出\"><a href=\"#export导出\" class=\"headerlink\" title=\"export导出\"></a>export导出</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># docker container ps -l</span><br><span class=\"hljs-attribute\">CONTAINER</span> ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES<br><span class=\"hljs-attribute\">9caea184f25b</span>        postgresql:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">1</span>   <span class=\"hljs-string\">&quot;/bin/sh -c /start_p…&quot;</span>   <span class=\"hljs-number\">6</span> minutes ago       Exited (<span class=\"hljs-number\">0</span>) <span class=\"hljs-number\">8</span> seconds ago                       relaxed_benz<br><br><span class=\"hljs-comment\"># docker export 9caea184f25b &gt; postgresql.tar</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"import导入\"><a href=\"#import导入\" class=\"headerlink\" title=\"import导入\"></a>import导入</h3><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">cat postgresql.tar |docker <span class=\"hljs-keyword\">import</span> - postgresql:<span class=\"hljs-number\">11.2</span><span class=\"hljs-number\">.2</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.libaocai.com/<span class=\"hljs-number\">2767</span>.html<br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"OS-image\"><a href=\"#OS-image\" class=\"headerlink\" title=\"OS image\"></a>OS image</h1><h2 id=\"编写centos7-sh\"><a href=\"#编写centos7-sh\" class=\"headerlink\" title=\"编写centos7.sh\"></a>编写centos7.sh</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br>mkdir centos7<br><span class=\"hljs-built_in\">cd</span> centos7<br>supermin5 -v --prepare bash grep yum yum-plugin rpm systemd pkgconfig initscripts -o supermin.d<br>supermin5 -v --build --format chroot supermin.d -o appliance.d<br>cp /etc/resolv.conf appliance.d/etc/<br><span class=\"hljs-built_in\">echo</span> 7 &gt; appliance.d/etc/yum/vars/releasever<br>tar --numeric-owner -cpf centos-7.tar -C appliance.d .<br>cat centos-7.tar | docker import - os/centos<br></code></pre></td></tr></table></figure>","more":"<h2 id=\"生成OS-image\"><a href=\"#生成OS-image\" class=\"headerlink\" title=\"生成OS image\"></a>生成OS image</h2><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># docker images</span><br><span class=\"hljs-attribute\">REPOSITORY</span>          TAG                 IMAGE ID            CREATED              SIZE<br><span class=\"hljs-attribute\">os</span>/centos           latest              <span class=\"hljs-number\">88805</span>d<span class=\"hljs-number\">994</span>ae<span class=\"hljs-number\">8</span>        About a minute ago   <span class=\"hljs-number\">279</span>MB<br></code></pre></td></tr></table></figure>\n<h1 id=\"PostgreSQL-image\"><a href=\"#PostgreSQL-image\" class=\"headerlink\" title=\"PostgreSQL image\"></a>PostgreSQL image</h1><h2 id=\"初始化PostgreSQL基础信息脚本\"><a href=\"#初始化PostgreSQL基础信息脚本\" class=\"headerlink\" title=\"初始化PostgreSQL基础信息脚本\"></a>初始化PostgreSQL基础信息脚本</h2><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\"><span class=\"hljs-comment\">#!/bin/bash</span><br>su postgres &lt;&lt;EOF<br><span class=\"hljs-regexp\">/opt/</span>pg11<span class=\"hljs-regexp\">/bin/</span>pg_ctl start -D <span class=\"hljs-regexp\">/export/</span>pg110_data;<br><span class=\"hljs-keyword\">exit</span>;<br>EOF<br></code></pre></td></tr></table></figure>\n<h2 id=\"自定义dockerfile\"><a href=\"#自定义dockerfile\" class=\"headerlink\" title=\"自定义dockerfile\"></a>自定义dockerfile</h2><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\"><span class=\"hljs-keyword\">FROM</span> os/centos<br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> localedef -c -f UTF-8 -i en_US en_US.utf8</span><br> <br><span class=\"hljs-keyword\">ENV</span> LANG=en_US.UTF-<span class=\"hljs-number\">8</span> \\<br>    LANGUAGE=en_US:zh \\<br>    LC_ALL=en_US.UTF-<span class=\"hljs-number\">8</span><br> <br><span class=\"hljs-keyword\">MAINTAINER</span> taot.jin &lt;<span class=\"hljs-number\">84660320</span>@qq.com&gt;<br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> mkdir /<span class=\"hljs-built_in\">export</span></span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./pg110_data /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> mkdir /<span class=\"hljs-built_in\">export</span>/rpms</span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./rpms/*.rpm /<span class=\"hljs-built_in\">export</span>/rpms/</span><br><span class=\"hljs-comment\">#RUN rpm -ivh  /export/rpms/geos-*.rpm  /export/rpms/proj-*.rpm /export/rpms/gdal-*.rpm /export/rpms/json-c*.rpm  /export/rpms/postgis-*.rpm</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> useradd postgres</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chown -R postgres:postgres /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chmod 0700 /<span class=\"hljs-built_in\">export</span>/pg110_data</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> rm /etc/yum.repos.d/*.repo</span><br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./qunar.repo /etc/yum.repos.d/</span><br> <br><span class=\"hljs-keyword\">ENV</span> LD_LIBRARY_PATH <span class=\"hljs-string\">&quot;/opt/pg11/lib:/usr/lib64:/lib64:/usr/lib:/lib&quot;</span><br><span class=\"hljs-keyword\">ENV</span> PATH  <span class=\"hljs-string\">&quot;/opt/pg11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> ldconfig</span><br> <br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> yum clean all &amp;&amp; yum makecache &amp;&amp; yum install -y postgresql wget pkgconfig</span><br> <br><span class=\"hljs-keyword\">ADD</span><span class=\"bash\"> ./start_postgres.sh /start_postgres.sh</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> chmod +x /start_postgres.sh</span><br> <br><span class=\"hljs-comment\">#RUN echo &quot;su postgres -c \\&quot;/opt/pg11/bin/pg_ctl -D /export/pg110_data restart &amp;&gt;/export/pg110_data/log/postgre_start.log\\&quot;&quot; &gt;&gt; /etc/rc.local</span><br> <br><span class=\"hljs-keyword\">VOLUME</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/export/pg110_data&quot;</span>]</span><br><span class=\"hljs-keyword\">VOLUME</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/opt/pg11&quot;</span>]</span><br><span class=\"hljs-keyword\">EXPOSE</span> <span class=\"hljs-number\">5432</span><br> <br><span class=\"hljs-comment\">#RUN echo &quot;host    all             all             0.0.0.0/0               md5&quot; &gt;&gt; /var/lib/pgsql/data/pg_hba.conf</span><br> <br><span class=\"hljs-keyword\">CMD</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;/start_postgres.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"生成image\"><a href=\"#生成image\" class=\"headerlink\" title=\"生成image\"></a>生成image</h2><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\"># docker image build -t postgresql11<span class=\"hljs-number\">.2</span><span class=\"hljs-number\">.1</span> .<br></code></pre></td></tr></table></figure>\n<h1 id=\"数据持久化\"><a href=\"#数据持久化\" class=\"headerlink\" title=\"数据持久化\"></a>数据持久化</h1><figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dockerfile\">docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> ls</span><br>docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> create pg110_data</span><br>docker <span class=\"hljs-keyword\">volume</span><span class=\"bash\"> create opt_pg11_1</span><br><br><br>docker <span class=\"hljs-keyword\">run</span><span class=\"bash\"> -it -v pg110_data:/<span class=\"hljs-built_in\">export</span>/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.1</span><br>docker <span class=\"hljs-keyword\">run</span><span class=\"bash\"> -it --mount <span class=\"hljs-built_in\">type</span>=<span class=\"hljs-built_in\">bind</span>,<span class=\"hljs-built_in\">source</span>=/<span class=\"hljs-built_in\">export</span>,target=/<span class=\"hljs-built_in\">export</span> postgresql:11.2.1</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"更新image\"><a href=\"#更新image\" class=\"headerlink\" title=\"更新image\"></a>更新image</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-comment\"># rpm -qa|grep  proj</span><br><span class=\"hljs-comment\"># rpm -ivh proj-4.9.2-1.el7.x86_64.rpm</span><br>Preparing<span class=\"hljs-built_in\">..</span>.                          ################################# [100%]<br>Updating / installing<span class=\"hljs-built_in\">..</span>.<br>   1:proj-4.9.2-1.el7                 ################################# [100%]<br><span class=\"hljs-comment\"># rpm -qa|grep proj</span><br>proj-4.9.2-1.el7.x86_64<br><span class=\"hljs-comment\"># docker container ps -l</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                       PORTS               NAMES<br>5aeefd7f48e9        postgresql:11.2.1   <span class=\"hljs-string\">&quot;/bin/sh -c /start_p…&quot;</span>   About a minute ago   Exited (130) 9 seconds ago                       zealous_ganguly<br><br><span class=\"hljs-comment\"># docker commit -m &quot;test commit&quot; 5aeefd7f48e9 postgresql:11.2.2</span><br>sha256:df7a3a3cff7fd017e889dce7d03885e65f1b512ad3e443ab8254e5375805e24d<br><br><span class=\"hljs-comment\"># docker run -it -v pg110_data:/export/pg110_data -v  opt_pg11_1:/opt/pg11 postgresql:11.2.2</span><br>pg_ctl: another<span class=\"hljs-built_in\"> server </span>might be running; trying <span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\"> server </span>anyway<br>waiting <span class=\"hljs-keyword\">for</span><span class=\"hljs-built_in\"> server </span><span class=\"hljs-keyword\">to</span> start<span class=\"hljs-built_in\">..</span><span class=\"hljs-built_in\">..</span>[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 1  0]LOG:  listening on IPv4<span class=\"hljs-built_in\"> address </span><span class=\"hljs-string\">&quot;0.0.0.0&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>[    2019-03-04 17:23:41.736 CST 10 5c7cee9d.a 2  0]LOG:  listening on<span class=\"hljs-built_in\"> IPv6 address </span><span class=\"hljs-string\">&quot;::&quot;</span>,<span class=\"hljs-built_in\"> port </span>5432<br>[    2019-03-04 17:23:41.740 CST 10 5c7cee9d.a 3  0]LOG:  listening on Unix socket <span class=\"hljs-string\">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 4  0]LOG:  redirecting log output <span class=\"hljs-keyword\">to</span><span class=\"hljs-built_in\"> logging </span>collector process<br>[    2019-03-04 17:23:41.766 CST 10 5c7cee9d.a 5  0]HINT:  Future log output will appear <span class=\"hljs-keyword\">in</span> directory <span class=\"hljs-string\">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>\n<h1 id=\"image迁移\"><a href=\"#image迁移\" class=\"headerlink\" title=\"image迁移\"></a>image迁移</h1><h2 id=\"save-load\"><a href=\"#save-load\" class=\"headerlink\" title=\"save/load\"></a>save/load</h2><h3 id=\"save导出\"><a href=\"#save导出\" class=\"headerlink\" title=\"save导出\"></a>save导出</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">docker</span> save c<span class=\"hljs-number\">92217432</span>f<span class=\"hljs-number\">48</span> &gt; postgresql.tar<br></code></pre></td></tr></table></figure>\n<h3 id=\"load导入\"><a href=\"#load导入\" class=\"headerlink\" title=\"load导入\"></a>load导入</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">docker</span> load &lt; postgresql.tar<br><span class=\"hljs-attribute\">docker</span> tag c<span class=\"hljs-number\">92217432</span>f<span class=\"hljs-number\">48</span> postgresql:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">4</span><br></code></pre></td></tr></table></figure>\n<h2 id=\"export-import\"><a href=\"#export-import\" class=\"headerlink\" title=\"export/import\"></a>export/import</h2><h3 id=\"export导出\"><a href=\"#export导出\" class=\"headerlink\" title=\"export导出\"></a>export导出</h3><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># docker container ps -l</span><br><span class=\"hljs-attribute\">CONTAINER</span> ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES<br><span class=\"hljs-attribute\">9caea184f25b</span>        postgresql:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">1</span>   <span class=\"hljs-string\">&quot;/bin/sh -c /start_p…&quot;</span>   <span class=\"hljs-number\">6</span> minutes ago       Exited (<span class=\"hljs-number\">0</span>) <span class=\"hljs-number\">8</span> seconds ago                       relaxed_benz<br><br><span class=\"hljs-comment\"># docker export 9caea184f25b &gt; postgresql.tar</span><br></code></pre></td></tr></table></figure>\n<h3 id=\"import导入\"><a href=\"#import导入\" class=\"headerlink\" title=\"import导入\"></a>import导入</h3><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs angelscript\">cat postgresql.tar |docker <span class=\"hljs-keyword\">import</span> - postgresql:<span class=\"hljs-number\">11.2</span><span class=\"hljs-number\">.2</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h1><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">https:<span class=\"hljs-regexp\">//</span>www.libaocai.com/<span class=\"hljs-number\">2767</span>.html<br></code></pre></td></tr></table></figure>"},{"title":"docker常用命令","date":"2021-03-11T08:57:05.000Z","top":35,"description":null,"password":null,"_content":"\n\n#将 image 文件从仓库抓取到本地， 默认library组\n```\n$ docker image pull library/hello-world\n$ docker image pull hello-world\n\n```\n\n# 列出本机的所有 image 文件。\n```\n$ docker image ls\n```\n\n# 删除 image 文件\n```\n$ docker rmi [imageName]\n```\n\n<!--more-->\n\n# 启动并进入终端\n```\n$ sudo docker run -i -t --name=docker_run centos /bin/bash\n```\n\n#进入docker终端$   \n```\nsudo docker run -it postgres:11.2  /bin/bash\n```\n\n#查看容器重启次数\n```\ndocker inspect -f \"{{.RestartCount }}\" containerid\n```\n\n#查看容器最后一次的启动时间\n```\ndocker inspect -f \"{{.State.StartedAt }}\" containerid\n```\n\n#获取container ip\n```\ndocker inspect --format '{{.NetworkSettings.IPAddress}}'  containerid\n```\n\n#获取网络配置\n```\ndocker incontainerid | jq '.[].NetworkSettings.Networks'\n```\n","source":"_posts/docker_command.md","raw":"---\ntitle: docker常用命令\ndate: 2021-03-11 16:57:05\ntags: \n- docker\ncategories: \n- docker\ntop: 35\ndescription: \npassword: \n\n---\n\n\n#将 image 文件从仓库抓取到本地， 默认library组\n```\n$ docker image pull library/hello-world\n$ docker image pull hello-world\n\n```\n\n# 列出本机的所有 image 文件。\n```\n$ docker image ls\n```\n\n# 删除 image 文件\n```\n$ docker rmi [imageName]\n```\n\n<!--more-->\n\n# 启动并进入终端\n```\n$ sudo docker run -i -t --name=docker_run centos /bin/bash\n```\n\n#进入docker终端$   \n```\nsudo docker run -it postgres:11.2  /bin/bash\n```\n\n#查看容器重启次数\n```\ndocker inspect -f \"{{.RestartCount }}\" containerid\n```\n\n#查看容器最后一次的启动时间\n```\ndocker inspect -f \"{{.State.StartedAt }}\" containerid\n```\n\n#获取container ip\n```\ndocker inspect --format '{{.NetworkSettings.IPAddress}}'  containerid\n```\n\n#获取网络配置\n```\ndocker incontainerid | jq '.[].NetworkSettings.Networks'\n```\n","slug":"docker_command","published":1,"updated":"2021-03-11T08:58:31.580Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckm4n2rh400001pebe8jfdf4y","content":"<h1 id=\"将-image-文件从仓库抓取到本地，-默认library组\"><a href=\"#将-image-文件从仓库抓取到本地，-默认library组\" class=\"headerlink\" title=\"将 image 文件从仓库抓取到本地， 默认library组\"></a>将 image 文件从仓库抓取到本地， 默认library组</h1><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\">$ docker <span class=\"hljs-built_in\">image</span> pull library/hello-world<br>$ docker <span class=\"hljs-built_in\">image</span> pull hello-world<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"列出本机的所有-image-文件。\"><a href=\"#列出本机的所有-image-文件。\" class=\"headerlink\" title=\"列出本机的所有 image 文件。\"></a>列出本机的所有 image 文件。</h1><figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mel\">$ docker <span class=\"hljs-keyword\">image</span> <span class=\"hljs-keyword\">ls</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"删除-image-文件\"><a href=\"#删除-image-文件\" class=\"headerlink\" title=\"删除 image 文件\"></a>删除 image 文件</h1><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs elixir\"><span class=\"hljs-variable\">$ </span>docker rmi [imageName]<br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h1 id=\"启动并进入终端\"><a href=\"#启动并进入终端\" class=\"headerlink\" title=\"启动并进入终端\"></a>启动并进入终端</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">$ sudo docker <span class=\"hljs-builtin-name\">run</span> -i -t <span class=\"hljs-attribute\">--name</span>=docker_run centos /bin/bash<br></code></pre></td></tr></table></figure>\n<h1 id=\"进入docker终端\"><a href=\"#进入docker终端\" class=\"headerlink\" title=\"进入docker终端$\"></a>进入docker终端$</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sudo</span> docker run -it postgres:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>  /bin/bash<br></code></pre></td></tr></table></figure>\n<h1 id=\"查看容器重启次数\"><a href=\"#查看容器重启次数\" class=\"headerlink\" title=\"查看容器重启次数\"></a>查看容器重启次数</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect -f &quot;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.RestartCount</span> &#125;&#125;</span><span class=\"xml\">&quot; containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"查看容器最后一次的启动时间\"><a href=\"#查看容器最后一次的启动时间\" class=\"headerlink\" title=\"查看容器最后一次的启动时间\"></a>查看容器最后一次的启动时间</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect -f &quot;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.State.StartedAt</span> &#125;&#125;</span><span class=\"xml\">&quot; containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取container-ip\"><a href=\"#获取container-ip\" class=\"headerlink\" title=\"获取container ip\"></a>获取container ip</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect --format &#x27;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.NetworkSettings.IPAddress</span>&#125;&#125;</span><span class=\"xml\">&#x27;  containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取网络配置\"><a href=\"#获取网络配置\" class=\"headerlink\" title=\"获取网络配置\"></a>获取网络配置</h1><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">docker</span> incontainerid | jq <span class=\"hljs-string\">&#x27;.[].NetworkSettings.Networks&#x27;</span><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"将-image-文件从仓库抓取到本地，-默认library组\"><a href=\"#将-image-文件从仓库抓取到本地，-默认library组\" class=\"headerlink\" title=\"将 image 文件从仓库抓取到本地， 默认library组\"></a>将 image 文件从仓库抓取到本地， 默认library组</h1><figure class=\"highlight arduino\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs arduino\">$ docker <span class=\"hljs-built_in\">image</span> pull library/hello-world<br>$ docker <span class=\"hljs-built_in\">image</span> pull hello-world<br><br></code></pre></td></tr></table></figure>\n<h1 id=\"列出本机的所有-image-文件。\"><a href=\"#列出本机的所有-image-文件。\" class=\"headerlink\" title=\"列出本机的所有 image 文件。\"></a>列出本机的所有 image 文件。</h1><figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mel\">$ docker <span class=\"hljs-keyword\">image</span> <span class=\"hljs-keyword\">ls</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"删除-image-文件\"><a href=\"#删除-image-文件\" class=\"headerlink\" title=\"删除 image 文件\"></a>删除 image 文件</h1><figure class=\"highlight elixir\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs elixir\"><span class=\"hljs-variable\">$ </span>docker rmi [imageName]<br></code></pre></td></tr></table></figure>","more":"<h1 id=\"启动并进入终端\"><a href=\"#启动并进入终端\" class=\"headerlink\" title=\"启动并进入终端\"></a>启动并进入终端</h1><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">$ sudo docker <span class=\"hljs-builtin-name\">run</span> -i -t <span class=\"hljs-attribute\">--name</span>=docker_run centos /bin/bash<br></code></pre></td></tr></table></figure>\n<h1 id=\"进入docker终端\"><a href=\"#进入docker终端\" class=\"headerlink\" title=\"进入docker终端$\"></a>进入docker终端$</h1><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">sudo</span> docker run -it postgres:<span class=\"hljs-number\">11</span>.<span class=\"hljs-number\">2</span>  /bin/bash<br></code></pre></td></tr></table></figure>\n<h1 id=\"查看容器重启次数\"><a href=\"#查看容器重启次数\" class=\"headerlink\" title=\"查看容器重启次数\"></a>查看容器重启次数</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect -f &quot;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.RestartCount</span> &#125;&#125;</span><span class=\"xml\">&quot; containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"查看容器最后一次的启动时间\"><a href=\"#查看容器最后一次的启动时间\" class=\"headerlink\" title=\"查看容器最后一次的启动时间\"></a>查看容器最后一次的启动时间</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect -f &quot;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.State.StartedAt</span> &#125;&#125;</span><span class=\"xml\">&quot; containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取container-ip\"><a href=\"#获取container-ip\" class=\"headerlink\" title=\"获取container ip\"></a>获取container ip</h1><figure class=\"highlight handlebars\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs handlebars\"><span class=\"xml\">docker inspect --format &#x27;</span><span class=\"hljs-template-variable\">&#123;&#123;<span class=\"hljs-name\">.NetworkSettings.IPAddress</span>&#125;&#125;</span><span class=\"xml\">&#x27;  containerid</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"获取网络配置\"><a href=\"#获取网络配置\" class=\"headerlink\" title=\"获取网络配置\"></a>获取网络配置</h1><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-attribute\">docker</span> incontainerid | jq <span class=\"hljs-string\">&#x27;.[].NetworkSettings.Networks&#x27;</span><br></code></pre></td></tr></table></figure>"},{"title":"PostgreSQL函数/存储过程返回多个游标","date":"2021-03-12T06:15:38.000Z","top":35,"description":null,"password":null,"_content":"\n# function 返回多个游标\n```\nCREATE OR REPLACE FUNCTION show_cities_multiple() RETURNS SETOF refcursor AS $$\n DECLARE\n   ref1 refcursor;           -- Declare cursor variables\n   ref2 refcursor;\n BEGIN\n   OPEN ref1 FOR SELECT 1;   -- Open the first cursor\n   RETURN NEXT ref1;                                                                              -- Return the cursor to the caller\n\n   OPEN ref2 FOR SELECT 2;   -- Open the second cursor\n   RETURN NEXT ref2;                                                                              -- Return the cursor to the caller\n END;\n $$ LANGUAGE plpgsql;\n```\n\n<!--more-->\n\n# procedure 返回多个游标\n```\nCREATE OR REPLACE PROCEDURE public.test_p1(INOUT ref refcursor[])\n LANGUAGE plpgsql\nAS $procedure$\ndeclare ref0 refcursor; ref1 refcursor;\nbegin\nopen ref0 for select 1; ref[0] = ref0;\nopen ref1 for select 2; ref[1] = ref1;\nend;\n$procedure$\n```\n","source":"_posts/PostgreSQL_refcursor.md","raw":"---\ntitle: PostgreSQL函数/存储过程返回多个游标\ndate: 2021-03-12 14:15:38\ntags: \n- PostgreSQL\n- cursor\n- refcursor\ncategories:\n- PostgreSQL\n- cursor\n- refcursor\ntop: 35 \ndescription: \npassword: \n\n---\n\n# function 返回多个游标\n```\nCREATE OR REPLACE FUNCTION show_cities_multiple() RETURNS SETOF refcursor AS $$\n DECLARE\n   ref1 refcursor;           -- Declare cursor variables\n   ref2 refcursor;\n BEGIN\n   OPEN ref1 FOR SELECT 1;   -- Open the first cursor\n   RETURN NEXT ref1;                                                                              -- Return the cursor to the caller\n\n   OPEN ref2 FOR SELECT 2;   -- Open the second cursor\n   RETURN NEXT ref2;                                                                              -- Return the cursor to the caller\n END;\n $$ LANGUAGE plpgsql;\n```\n\n<!--more-->\n\n# procedure 返回多个游标\n```\nCREATE OR REPLACE PROCEDURE public.test_p1(INOUT ref refcursor[])\n LANGUAGE plpgsql\nAS $procedure$\ndeclare ref0 refcursor; ref1 refcursor;\nbegin\nopen ref0 for select 1; ref[0] = ref0;\nopen ref1 for select 2; ref[1] = ref1;\nend;\n$procedure$\n```\n","slug":"PostgreSQL_refcursor","published":1,"updated":"2021-03-12T06:18:20.905Z","_id":"ckm5wshh500002ieb9wt2ez6p","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"function-返回多个游标\"><a href=\"#function-返回多个游标\" class=\"headerlink\" title=\"function 返回多个游标\"></a>function 返回多个游标</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> show_cities_multiple() <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-keyword\">SETOF</span> <span class=\"hljs-type\">refcursor</span> <span class=\"hljs-keyword\">AS</span> $$<br><span class=\"pgsql\"> <span class=\"hljs-keyword\">DECLARE</span></span><br><span class=\"pgsql\">   ref1 <span class=\"hljs-type\">refcursor</span>;           <span class=\"hljs-comment\">-- Declare cursor variables</span></span><br><span class=\"pgsql\">   ref2 <span class=\"hljs-type\">refcursor</span>;</span><br><span class=\"pgsql\"> <span class=\"hljs-keyword\">BEGIN</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">OPEN</span> ref1 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>;   <span class=\"hljs-comment\">-- Open the first cursor</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">RETURN NEXT</span> ref1;                                                                              <span class=\"hljs-comment\">-- Return the cursor to the caller</span></span><br><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">OPEN</span> ref2 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">2</span>;   <span class=\"hljs-comment\">-- Open the second cursor</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">RETURN NEXT</span> ref2;                                                                              <span class=\"hljs-comment\">-- Return the cursor to the caller</span></span><br><span class=\"pgsql\"> <span class=\"hljs-keyword\">END</span>;</span><br><span class=\"ruby\"> $$</span> <span class=\"hljs-keyword\">LANGUAGE</span> plpgsql;<br></code></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h1 id=\"procedure-返回多个游标\"><a href=\"#procedure-返回多个游标\" class=\"headerlink\" title=\"procedure 返回多个游标\"></a>procedure 返回多个游标</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">public</span>.<span class=\"hljs-title\">test_p1</span><span class=\"hljs-params\">(INOUT ref refcursor[])</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span> <span class=\"hljs-title\">ref0</span> <span class=\"hljs-title\">refcursor</span>;</span> ref1 refcursor;<br><span class=\"hljs-keyword\">begin</span><br>open ref0 <span class=\"hljs-keyword\">for</span> select <span class=\"hljs-number\">1</span>; ref[<span class=\"hljs-number\">0</span>] = ref0;<br>open ref1 <span class=\"hljs-keyword\">for</span> select <span class=\"hljs-number\">2</span>; ref[<span class=\"hljs-number\">1</span>] = ref1;<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$</span><br></code></pre></td></tr></table></figure>\n","site":{"data":{"styles":"/* build time:Fri Mar 05 2021 16:30:54 GMT+0800 (中国标准时间)*/\nbody{background:url(https://source.unsplash.com/random/1600x900);background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:50% 50%}.content-wrap{opacity:.85}.sidebar{opacity:.85;background-size:cover;background-position:center;background-repeat:no-repeat}.sidebar a,.sidebar p,.sidebar span{color:#000}.header-inner{background:rgba(255,255,255,.9)}.popup{opacity:1}.comments{padding:$content-desktop-padding;margin:initial;margin-top:sboffset;background:rgba(255,255,255,.9);box-shadow:$box-shadow;border-radius:$border-radius}.chinese-zodiac{float:right}@font-face{font-family:chinese-zodiac;font-display:swap;src:url(/fonts/chinese-zodiac.eot);src:url(/fonts/chinese-zodiac.eot) format('embedded-opentype'),url(/fonts/chinese-zodiac.woff2) format('woff2'),url(/fonts/chinese-zodiac.woff) format('woff');font-weight:400;font-style:normal}.symbolic-animals{display:inline-block;font:normal normal normal 14px/1 chinese-zodiac;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-dragon:before{content:'\\e806'}.icon-tiger:before{content:'\\e809'}.icon-pig:before{content:'\\e810'}.icon-horse:before{content:'\\e813'}.icon-rat:before{content:'\\e816'}.icon-goat:before{content:'\\e818'}.icon-snake:before{content:'\\e820'}.icon-ox:before{content:'\\e822'}.icon-dog:before{content:'\\e825'}.icon-rabbit:before{content:'\\e826'}.icon-monkey:before{content:'\\e829'}.icon-rooster:before{content:'\\e82f'}.post{margin-top:0;margin-bottom:60px;padding:25px;-webkit-box-shadow:0 0 5px rgba(202,203,203,.5);-moz-box-shadow:0 0 5px rgba(202,203,204,.5)}*{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword2.ico),auto!important}:active{cursor:url(http://om8u46rmb.bkt.clouddn.com/sword1.ico),auto!important}#heart{animation:heartAnimate 1.33s ease-in-out infinite}.with-love{color:red}.posts-expand .post-tags a{-webkit-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);-moz-box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);font-family:'Comic Sans MS',sans-serif;transition:.2s ease-out;padding:3px 5px;margin:5px;background:#f5f5f5;border-bottom:none;border-radius:15px}mobile() .posts-expand .post-tags a:hover{background:rgba(100,154,182,.902);color:#fff;-webkit-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);-moz-box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19);box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}.site-title{background-image:linear-gradient(to right,#ff4500,orange,gold,#90ee90,#0ff,#1e90ff,#9370db,#ff69b4,#ff4500);background-size:110vw;-webkit-background-clip:text;color:rgba(0,0,0,.1);animation:sliding 30s linear infinite}.site-meta,.site-subtitle{color:rgba(0,0,0,.1);animation:hue 1.5s linear infinite;background-image:linear-gradient(to right bottom,red,#ff8000,#ff0,#0f0,#00ff80,#0ff,#0080ff,#00f,#8000ff,#f0f,#ff0080);-webkit-background-clip:text}.site-meta{background:#ecf9f8}mobile() .footer-inner{color:#000}.post-toc .nav .nav-child{display:block}@-moz-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-webkit-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-o-keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@keyframes heartAnimate{0%,100%{transform:scale(1)}10%,30%{transform:scale(.9)}20%,40%,60%,80%{transform:scale(1.1)}50%,70%{transform:scale(1.1)}}@-moz-keyframes sliding{to{background-position:-2000vw}}@-webkit-keyframes sliding{to{background-position:-2000vw}}@-o-keyframes sliding{to{background-position:-2000vw}}@keyframes sliding{to{background-position:-2000vw}}@-moz-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-webkit-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@-o-keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}@keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(-360deg)}}\n/* rebuild by neat */"}},"excerpt":"<h1 id=\"function-返回多个游标\"><a href=\"#function-返回多个游标\" class=\"headerlink\" title=\"function 返回多个游标\"></a>function 返回多个游标</h1><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs pgsql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">OR REPLACE</span> <span class=\"hljs-keyword\">FUNCTION</span> show_cities_multiple() <span class=\"hljs-keyword\">RETURNS</span> <span class=\"hljs-keyword\">SETOF</span> <span class=\"hljs-type\">refcursor</span> <span class=\"hljs-keyword\">AS</span> $$<br><span class=\"pgsql\"> <span class=\"hljs-keyword\">DECLARE</span></span><br><span class=\"pgsql\">   ref1 <span class=\"hljs-type\">refcursor</span>;           <span class=\"hljs-comment\">-- Declare cursor variables</span></span><br><span class=\"pgsql\">   ref2 <span class=\"hljs-type\">refcursor</span>;</span><br><span class=\"pgsql\"> <span class=\"hljs-keyword\">BEGIN</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">OPEN</span> ref1 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>;   <span class=\"hljs-comment\">-- Open the first cursor</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">RETURN NEXT</span> ref1;                                                                              <span class=\"hljs-comment\">-- Return the cursor to the caller</span></span><br><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">OPEN</span> ref2 <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">2</span>;   <span class=\"hljs-comment\">-- Open the second cursor</span></span><br><span class=\"pgsql\">   <span class=\"hljs-keyword\">RETURN NEXT</span> ref2;                                                                              <span class=\"hljs-comment\">-- Return the cursor to the caller</span></span><br><span class=\"pgsql\"> <span class=\"hljs-keyword\">END</span>;</span><br><span class=\"ruby\"> $$</span> <span class=\"hljs-keyword\">LANGUAGE</span> plpgsql;<br></code></pre></td></tr></table></figure>","more":"<h1 id=\"procedure-返回多个游标\"><a href=\"#procedure-返回多个游标\" class=\"headerlink\" title=\"procedure 返回多个游标\"></a>procedure 返回多个游标</h1><figure class=\"highlight cal\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cal\">CREATE <span class=\"hljs-keyword\">OR</span> REPLACE <span class=\"hljs-function\"><span class=\"hljs-keyword\">PROCEDURE</span> <span class=\"hljs-title\">public</span>.<span class=\"hljs-title\">test_p1</span><span class=\"hljs-params\">(INOUT ref refcursor[])</span></span><br><span class=\"hljs-function\"> <span class=\"hljs-title\">LANGUAGE</span> <span class=\"hljs-title\">plpgsql</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">AS</span> $<span class=\"hljs-title\">procedure</span>$</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">declare</span> <span class=\"hljs-title\">ref0</span> <span class=\"hljs-title\">refcursor</span>;</span> ref1 refcursor;<br><span class=\"hljs-keyword\">begin</span><br>open ref0 <span class=\"hljs-keyword\">for</span> select <span class=\"hljs-number\">1</span>; ref[<span class=\"hljs-number\">0</span>] = ref0;<br>open ref1 <span class=\"hljs-keyword\">for</span> select <span class=\"hljs-number\">2</span>; ref[<span class=\"hljs-number\">1</span>] = ref1;<br><span class=\"hljs-keyword\">end</span>;<br>$<span class=\"hljs-function\"><span class=\"hljs-keyword\">procedure</span>$</span><br></code></pre></td></tr></table></figure>"}],"PostAsset":[],"PostCategory":[{"post_id":"ckdu7m6uq0003yrebf49phet6","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"ckdu7m6v8000ryreb2d5e0hfn"},{"post_id":"ckdu7m6v3000hyrebbp1n17hd","category_id":"ckdu7m6vd000xyrebfoxu9fnk","_id":"ckdu7m6vi001ayreb0rdsc39s"},{"post_id":"ckdu7m6wu003kyrebf7678o8s","category_id":"ckdu7m6wv003lyreb7ac6hedk","_id":"ckdu7m6ww003oyreb5ixvd7cw"},{"post_id":"cklw1fzgv0000pieb7p55ec0i","category_id":"ckdu7m6vf0013yreb16lpcpa6","_id":"cklw1fzh90006pieb96vc68ag"},{"post_id":"cklw1fzh40001pieb0fav3x86","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzha0009pieb5fsmbod0"},{"post_id":"cklw1fzh40001pieb0fav3x86","category_id":"ckj2jn71h0002n7eb559z7z73","_id":"cklw1fzhc000cpieb8a6nc191"},{"post_id":"cklw1fzh40001pieb0fav3x86","category_id":"ckj2jn71o0005n7ebc3fnb3at","_id":"cklw1fzhe000epieb30qi6vhl"},{"post_id":"cklw1fzh60003pieb50bo1pzp","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhf000hpiebdty2eptr"},{"post_id":"cklw1fzh80005piebh6xmf5u8","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhh000kpiebe2ps2wu0"},{"post_id":"cklw1fzh90008pieb7nd12adz","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhi000npieb979e61a7"},{"post_id":"cklw1fzhb000bpieb2f9ya2xw","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhj000qpieb6paeezti"},{"post_id":"cklw1fzhe000gpieb18fpcc1l","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhk000tpiebhh76egnc"},{"post_id":"cklw1fzhg000jpieb1ia09cop","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhl000wpieb9wfh7g5x"},{"post_id":"cklw1fzhh000mpieb2wfkh6h4","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhm000ypiebh2h75ctg"},{"post_id":"cklw1fzhi000ppieb6unphkrg","category_id":"ckdu7m6v7000qyrebhrba46aj","_id":"cklw1fzhn0011pieb49dod63s"},{"post_id":"cklw1fzhj000spieb5hf61d5c","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhp0014pieb4uoa1bp9"},{"post_id":"cklw1fzhk000vpieb7wgochws","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhq0017piebh7eahv4n"},{"post_id":"cklw1fzhn0010pieba0mh2ns6","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhr001apieb28dd5f4u"},{"post_id":"cklw1fzho0013piebbsfa7bco","category_id":"ckdu7m6v7000qyrebhrba46aj","_id":"cklw1fzht001dpieb5ra0bi7p"},{"post_id":"cklw1fzhp0016pieb3c0910na","category_id":"ckdu7m6vf0013yreb16lpcpa6","_id":"cklw1fzhx001gpiebespk9ub1"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzhy001jpiebeamk5vot"},{"post_id":"cklw1fzhr001cpieba93y5tzv","category_id":"ckdu7m6vj001fyreb95de03ez","_id":"cklw1fzhz001mpiebcq4bdcn2"},{"post_id":"cklw1fzht001fpieb1lrk5qtf","category_id":"ckdu7m6vh0019yreba44c8mbh","_id":"cklw1fzi0001opiebbaqi7e2k"},{"post_id":"cklw1fzhx001ipiebaclaebpw","category_id":"ckdu7m6v7000qyrebhrba46aj","_id":"cklw1fzi0001qpiebftkb1ejr"},{"post_id":"cklw1fzhy001lpieb5g2n9ckx","category_id":"ckdu7m6vk001lyreb6bs4fjdl","_id":"cklw1fzi0001spieb9w316u9p"},{"post_id":"cklw1fzj7002qpiebg9tm6le3","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzjb002vpieb5xy0afm5"},{"post_id":"cklw1fzj8002rpiebaf2dfg5z","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzjb002xpiebbh0l1dry"},{"post_id":"cklw1fzja002tpiebauknc4yr","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"cklw1fzjb002zpieb4emx32ll"},{"post_id":"ckm4mphgo0000hmebb34laopm","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"ckm4mphha0005hmebb9mu7m0y"},{"post_id":"ckm4mphgo0000hmebb34laopm","category_id":"ckm4mphh80002hmeb997038gm","_id":"ckm4mphha0006hmebaef4gch5"},{"post_id":"ckm4n2rh400001pebe8jfdf4y","category_id":"ckm4n2rh700011pebb66qa8fp","_id":"ckm4n2rhe00031peb5g6u9fqw"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","category_id":"ckdu7m6us0004yreb6azcgugx","_id":"ckm5wshhg00082ieb7jb7h0aj"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","category_id":"ckm5wshhc00022iebdaojb0e2","_id":"ckm5wshhh00092iebathhh9bz"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","category_id":"ckm5wshhe00042ieb086i8eph","_id":"ckm5wshhh000a2ieb3pxg9gno"}],"PostTag":[{"post_id":"ckdu7m6uq0003yrebf49phet6","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"ckdu7m6vl001ryrebfewudy3j"},{"post_id":"ckdu7m6uq0003yrebf49phet6","tag_id":"ckdu7m6vj001hyreb2bsb4w0r","_id":"ckdu7m6vl001syreb8vmi2yer"},{"post_id":"ckdu7m6v3000hyrebbp1n17hd","tag_id":"ckdu7m6vo0025yreb8u3a7b8q","_id":"ckdu7m6vp002byrebanjbhwz6"},{"post_id":"ckdu7m6v3000hyrebbp1n17hd","tag_id":"ckdu7m6vo0028yreb71cw4zbl","_id":"ckdu7m6vp002cyreb4k7dbw4l"},{"post_id":"ckdu7m6wu003kyrebf7678o8s","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"ckdu7m6ww003pyrebaublasvx"},{"post_id":"ckdu7m6wu003kyrebf7678o8s","tag_id":"ckdu7m6wv003myrebhv4haa18","_id":"ckdu7m6ww003qyreb9xcz3369"},{"post_id":"ckdu7m6wu003kyrebf7678o8s","tag_id":"ckdu7m6wv003nyrebg6ntdrro","_id":"ckdu7m6ww003ryreb2o4e776p"},{"post_id":"cklw1fzgv0000pieb7p55ec0i","tag_id":"ckdu7m6vo0025yreb8u3a7b8q","_id":"cklw1fzh60002piebdak9dgcu"},{"post_id":"cklw1fzgv0000pieb7p55ec0i","tag_id":"ckesi53870000h1eb0pcocrck","_id":"cklw1fzh70004piebbll47fif"},{"post_id":"cklw1fzh40001pieb0fav3x86","tag_id":"ckdu7m6vt002uyreb7kfy00pv","_id":"cklw1fzh90007piebbejz5qlr"},{"post_id":"cklw1fzh40001pieb0fav3x86","tag_id":"ckdu7m6vr002nyrebfeuhf0v8","_id":"cklw1fzha000apieb0f1xeoey"},{"post_id":"cklw1fzh40001pieb0fav3x86","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzhc000dpieb1jrachkj"},{"post_id":"cklw1fzh60003pieb50bo1pzp","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzhe000fpiebdvlvgi69"},{"post_id":"cklw1fzh60003pieb50bo1pzp","tag_id":"ckecmab180000gxebe0ia2o3q","_id":"cklw1fzhf000ipieb83eb0sig"},{"post_id":"cklw1fzh60003pieb50bo1pzp","tag_id":"ckecmab1k0001gxebdkthcnm0","_id":"cklw1fzhh000lpiebagr176pa"},{"post_id":"cklw1fzh80005piebh6xmf5u8","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzhi000opieb2paa228b"},{"post_id":"cklw1fzh80005piebh6xmf5u8","tag_id":"ckdu7m6vp002dyreb814jdo7x","_id":"cklw1fzhj000rpieb0iwodf80"},{"post_id":"cklw1fzh80005piebh6xmf5u8","tag_id":"ckk7rg8by00010heb43i68nkv","_id":"cklw1fzhk000upieb3618cc55"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6ut0005yreb9cx4cwkx","_id":"cklw1fzhl000xpieb67fk8pdk"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6ux000dyrebgxp478d3","_id":"cklw1fzhn000zpiebc5ab6vh4"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6v4000kyreb1mf76g8z","_id":"cklw1fzho0012pieb684o5nw0"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6v8000syreb77tx141v","_id":"cklw1fzhp0015pieb58lr0ky5"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6vd000yyreb0q9vcyky","_id":"cklw1fzhq0018pieb5pivf2aj"},{"post_id":"cklw1fzh90008pieb7nd12adz","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzhr001bpiebb8zjbsyh"},{"post_id":"cklw1fzhb000bpieb2f9ya2xw","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzht001epiebab9mfc2j"},{"post_id":"cklw1fzhb000bpieb2f9ya2xw","tag_id":"cke2qa9820001sneb5w0y9ku7","_id":"cklw1fzhx001hpiebf3cvf3qo"},{"post_id":"cklw1fzhe000gpieb18fpcc1l","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzhy001kpieb7urkcys9"},{"post_id":"cklw1fzhe000gpieb18fpcc1l","tag_id":"cklknu61e0000udeb2fsna0vr","_id":"cklw1fzhz001npiebaahdbwkw"},{"post_id":"cklw1fzhg000jpieb1ia09cop","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzi0001ppieb0zy5av5b"},{"post_id":"cklw1fzhg000jpieb1ia09cop","tag_id":"ckdu7m6vl001qyreb18u69uhf","_id":"cklw1fzi0001rpiebhqafayb6"},{"post_id":"cklw1fzhg000jpieb1ia09cop","tag_id":"ckdu7m6vl001uyreb18mg5ppl","_id":"cklw1fzi0001tpiebcozn88dv"},{"post_id":"cklw1fzhh000mpieb2wfkh6h4","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzi0001upiebglai60td"},{"post_id":"cklw1fzhh000mpieb2wfkh6h4","tag_id":"ckdu7m6vm001yyreb4mvqf5d8","_id":"cklw1fzi0001vpieb86f0108s"},{"post_id":"cklw1fzhh000mpieb2wfkh6h4","tag_id":"ckdu7m6vm0020yreb6mg90yko","_id":"cklw1fzi0001wpieba1ht6ucb"},{"post_id":"cklw1fzhh000mpieb2wfkh6h4","tag_id":"ckdu7m6vn0021yreba7jp3303","_id":"cklw1fzi1001xpieb97eyco3e"},{"post_id":"cklw1fzhi000ppieb6unphkrg","tag_id":"ckdu7m6vn0022yrebagvmarxa","_id":"cklw1fzi1001ypieb7b996q6f"},{"post_id":"cklw1fzhj000spieb5hf61d5c","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzi1001zpiebaf647qie"},{"post_id":"cklw1fzhj000spieb5hf61d5c","tag_id":"ckdy6pqdq0000yteb0exyh6o8","_id":"cklw1fzi10020pieb83m0ho4o"},{"post_id":"cklw1fzhk000vpieb7wgochws","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzi10021piebecep85a8"},{"post_id":"cklw1fzhk000vpieb7wgochws","tag_id":"ckesg2ut20001giebb8649gdh","_id":"cklw1fzi10022pieb525n310i"},{"post_id":"cklw1fzhk000vpieb7wgochws","tag_id":"ckesg2ut80003giebcgj11co6","_id":"cklw1fzi10023pieb7qbd9w18"},{"post_id":"cklw1fzhn0010pieba0mh2ns6","tag_id":"ckdu7m6vq002fyreb784f7cyv","_id":"cklw1fzi10024pieb7paa85nf"},{"post_id":"cklw1fzho0013piebbsfa7bco","tag_id":"ckiu33r9o0001p6eb9dzk91e4","_id":"cklw1fzi10025pieba3br7brl"},{"post_id":"cklw1fzho0013piebbsfa7bco","tag_id":"ckiu33r9v0003p6eb2njk7vts","_id":"cklw1fzi10026piebbqcv3q22"},{"post_id":"cklw1fzhp0016pieb3c0910na","tag_id":"ckdu7m6vo0025yreb8u3a7b8q","_id":"cklw1fzi10027pieb58tj2w5q"},{"post_id":"cklw1fzhp0016pieb3c0910na","tag_id":"ckdu7m6vr002lyreb82dc5ozi","_id":"cklw1fzi10028piebc9rl9hog"},{"post_id":"cklw1fzhp0016pieb3c0910na","tag_id":"ckdu7m6vr002myrebh5o3d6k7","_id":"cklw1fzi10029pieb5r8r0kea"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6ut0005yreb9cx4cwkx","_id":"cklw1fzi1002apiebackrccck"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6vr002nyrebfeuhf0v8","_id":"cklw1fzi1002bpieb35w5ge65"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6ux000dyrebgxp478d3","_id":"cklw1fzi1002cpiebh4ie0u44"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzi2002dpieb6hb0fwut"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6vd000yyreb0q9vcyky","_id":"cklw1fzi2002epieb38hvh339"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6vs002tyrebbgai6gzb","_id":"cklw1fzi2002fpiebarg885w2"},{"post_id":"cklw1fzhq0019pieb2mu80zb9","tag_id":"ckdu7m6vt002uyreb7kfy00pv","_id":"cklw1fzi3002gpieb8nlp4zp7"},{"post_id":"cklw1fzhr001cpieba93y5tzv","tag_id":"ckdu7m6vt002yyrebhtzg9jtd","_id":"cklw1fzi3002hpiebd1wv961m"},{"post_id":"cklw1fzhr001cpieba93y5tzv","tag_id":"ckdu7m6vu0031yrebg9cj298v","_id":"cklw1fzi3002ipiebahybc160"},{"post_id":"cklw1fzht001fpieb1lrk5qtf","tag_id":"ckdu7m6vt002vyreba8bycz37","_id":"cklw1fzi3002jpiebgb3t64k1"},{"post_id":"cklw1fzhx001ipiebaclaebpw","tag_id":"ckdu7m6vu0034yreb0s8xfllp","_id":"cklw1fzi3002kpiebeh8k3ru3"},{"post_id":"cklw1fzhx001ipiebaclaebpw","tag_id":"ckdu7m6vv0038yrebgrgr3bfv","_id":"cklw1fzi5002lpieb19yb5siz"},{"post_id":"cklw1fzhx001ipiebaclaebpw","tag_id":"ckdu7m6vn0022yrebagvmarxa","_id":"cklw1fzi5002mpiebgm9w2a63"},{"post_id":"cklw1fzhy001lpieb5g2n9ckx","tag_id":"ckdu7m6vo0025yreb8u3a7b8q","_id":"cklw1fzi5002npiebb20cgqlm"},{"post_id":"cklw1fzhy001lpieb5g2n9ckx","tag_id":"ckdu7m6vn0022yrebagvmarxa","_id":"cklw1fzi7002opieb8jbpb0cs"},{"post_id":"cklw1fzhy001lpieb5g2n9ckx","tag_id":"ckdu7m6vx003gyreb20rjh4fx","_id":"cklw1fzi7002ppiebetxia1sl"},{"post_id":"cklw1fzj7002qpiebg9tm6le3","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzja002spiebajkt7v2t"},{"post_id":"cklw1fzj7002qpiebg9tm6le3","tag_id":"cke29cw3e00005jebeclkccm2","_id":"cklw1fzjb002upiebgxgm5zzz"},{"post_id":"cklw1fzj8002rpiebaf2dfg5z","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzjb002wpiebcgarbm62"},{"post_id":"cklw1fzj8002rpiebaf2dfg5z","tag_id":"ckdu7m6vp002dyreb814jdo7x","_id":"cklw1fzjb002ypiebdwyl4hdf"},{"post_id":"cklw1fzj8002rpiebaf2dfg5z","tag_id":"ckdu7m6vp002eyrebaubw1ihy","_id":"cklw1fzjb0030piebd37q9zf6"},{"post_id":"cklw1fzja002tpiebauknc4yr","tag_id":"ckdzkpotc0000gmeb4rjicirq","_id":"cklw1fzjb0031piebb1tcguqf"},{"post_id":"cklw1fzja002tpiebauknc4yr","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"cklw1fzjb0032pieb4evqdr9n"},{"post_id":"ckm4mphgo0000hmebb34laopm","tag_id":"ckm4mphgy0001hmeba45h89qi","_id":"ckm4mphha0003hmeb3g898wir"},{"post_id":"ckm4mphgo0000hmebb34laopm","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"ckm4mphha0004hmeb90io9geh"},{"post_id":"ckm4n2rh400001pebe8jfdf4y","tag_id":"ckm4mphgy0001hmeba45h89qi","_id":"ckm4n2rhe00021peb49afd14g"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","tag_id":"ckdu7m6vg0016yrebb8et1196","_id":"ckm5wshhg00052ieb7dreaj9z"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","tag_id":"ckm5wshhb00012ieb6n2f8csl","_id":"ckm5wshhg00062iebbq13gf5a"},{"post_id":"ckm5wshh500002ieb9wt2ez6p","tag_id":"ckm5wshhd00032ieb9cq7ht2j","_id":"ckm5wshhg00072iebb2egeaqc"}],"Tag":[{"name":"postgres","_id":"ckdu7m6ut0005yreb9cx4cwkx"},{"name":"pg","_id":"ckdu7m6ux000dyrebgxp478d3"},{"name":"install","_id":"ckdu7m6v4000kyreb1mf76g8z"},{"name":"source","_id":"ckdu7m6v8000syreb77tx141v"},{"name":"postgresql","_id":"ckdu7m6vd000yyreb0q9vcyky"},{"name":"PostgreSQL","_id":"ckdu7m6vg0016yrebb8et1196"},{"name":"2pc","_id":"ckdu7m6vj001hyreb2bsb4w0r"},{"name":"role","_id":"ckdu7m6vl001qyreb18u69uhf"},{"name":"权限","_id":"ckdu7m6vl001uyreb18mg5ppl"},{"name":"行列转换","_id":"ckdu7m6vm001yyreb4mvqf5d8"},{"name":"LATERAL","_id":"ckdu7m6vm0020yreb6mg90yko"},{"name":"自连接","_id":"ckdu7m6vn0021yreba7jp3303"},{"name":"python","_id":"ckdu7m6vn0022yrebagvmarxa"},{"name":"Linux","_id":"ckdu7m6vo0025yreb8u3a7b8q"},{"name":"vim","_id":"ckdu7m6vo0028yreb71cw4zbl"},{"name":"git","_id":"ckdu7m6vp002dyreb814jdo7x"},{"name":"postgresql.git","_id":"ckdu7m6vp002eyrebaubw1ihy"},{"name":"psql","_id":"ckdu7m6vq002fyreb784f7cyv"},{"name":"softdog","_id":"ckdu7m6vr002lyreb82dc5ozi"},{"name":"watchdog","_id":"ckdu7m6vr002myrebh5o3d6k7"},{"name":"postgis","_id":"ckdu7m6vr002nyrebfeuhf0v8"},{"name":"geo","_id":"ckdu7m6vs002tyrebbgai6gzb"},{"name":"gis","_id":"ckdu7m6vt002uyreb7kfy00pv"},{"name":"zabbix","_id":"ckdu7m6vt002vyreba8bycz37"},{"name":"hexo","_id":"ckdu7m6vt002yyrebhtzg9jtd"},{"name":"github","_id":"ckdu7m6vu0031yrebg9cj298v"},{"name":"robot","_id":"ckdu7m6vu0034yreb0s8xfllp"},{"name":"微信自动回复","_id":"ckdu7m6vv0038yrebgrgr3bfv"},{"name":"personal","_id":"ckdu7m6vx003gyreb20rjh4fx"},{"name":"DBA","_id":"ckdu7m6wv003myrebhv4haa18"},{"name":"SQL","_id":"ckdu7m6wv003nyrebg6ntdrro"},{"name":"stat","_id":"ckdy6pqdq0000yteb0exyh6o8"},{"name":"pg_hint_plan","_id":"ckdzkpotc0000gmeb4rjicirq"},{"name":"buffer","_id":"cke29cw3e00005jebeclkccm2"},{"name":"vacuum","_id":"cke2qa9820001sneb5w0y9ku7"},{"name":"backend","_id":"ckecmab180000gxebe0ia2o3q"},{"name":"Architecture","_id":"ckecmab1k0001gxebdkthcnm0"},{"name":"hash key","_id":"ckesg2ut20001giebb8649gdh"},{"name":"partition table","_id":"ckesg2ut80003giebcgj11co6"},{"name":"command","_id":"ckesi53870000h1eb0pcocrck"},{"name":"python3","_id":"ckiu33r9o0001p6eb9dzk91e4"},{"name":"ldap","_id":"ckiu33r9v0003p6eb2njk7vts"},{"name":"commit log","_id":"ckk7rg8by00010heb43i68nkv"},{"name":"开发指南","_id":"cklknu61e0000udeb2fsna0vr"},{"name":"hexo hothub","_id":"cklw1d15p0001jneb53eihrq0"},{"name":"docker","_id":"ckm4mphgy0001hmeba45h89qi"},{"name":"cursor","_id":"ckm5wshhb00012ieb6n2f8csl"},{"name":"refcursor","_id":"ckm5wshhd00032ieb9cq7ht2j"}]}}