<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.0.0"><script></script><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon2.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon2.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon2.png"><link rel="mask-icon" href="/images/favicon2.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"daydayup863.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"bounceIn",post_header:"slideDownIn",post_body:"perspectiveRightIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are brie"><meta property="og:type" content="article"><meta property="og:title" content="PostgreSQL vacuum"><meta property="og:url" content="http://daydayup863.github.io/PostgreSQL/PostgreSQL_vacuum/index.html"><meta property="og:site_name" content="daydayup863"><meta property="og:description" content="vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are brie"><meta property="og:locale"><meta property="article:published_time" content="2020-08-20T09:30:29.000Z"><meta property="article:modified_time" content="2021-03-05T08:30:47.555Z"><meta property="article:author" content="daydayup"><meta property="article:tag" content="PostgreSQL"><meta property="article:tag" content="vacuum"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://daydayup863.github.io/PostgreSQL/PostgreSQL_vacuum/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-Hans"}</script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>#needsharebutton-float{bottom:88px;cursor:pointer;left:-8px;position:fixed;z-index:9999}#needsharebutton-float .btn{border:1px solid $btn-default-border-color;border-radius:4px;padding:0 10px 0 14px}</style><title>PostgreSQL vacuum | daydayup863</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script type="text/javascript" src="/js/bubble.js"></script><link rel="alternate" href="/atom.xml" title="daydayup863" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><a target="_blank" rel="noopener" href="https://github.com/daydayup863"><img style="position:fixed;top:0;right:0" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_gray_6d6d6d.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">daydayup863</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">人生就像一杯茶，不会苦一辈子，但总会苦一阵子。</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-messagepad"><a href="/messagepad/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>留言板</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans"><link itemprop="mainEntityOfPage" href="http://daydayup863.github.io/PostgreSQL/PostgreSQL_vacuum/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/user.jpg"><meta itemprop="name" content="daydayup"><meta itemprop="description" content="good good study, day day up."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="daydayup863"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">PostgreSQL vacuum</h1><div class="post-meta"><i class="fa fa-thumbtack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-08-20 17:30:29" itemprop="dateCreated datePublished" datetime="2020-08-20T17:30:29+08:00">2020-08-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PostgreSQL/" itemprop="url" rel="index"><span itemprop="name">PostgreSQL</span></a> </span></span><span id="/PostgreSQL/PostgreSQL_vacuum/" class="post-meta-item leancloud_visitors" data-flag-title="PostgreSQL vacuum" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/PostgreSQL/PostgreSQL_vacuum/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/PostgreSQL/PostgreSQL_vacuum/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>vacuum processing is a maintenance process that facilitates the persistent operation of PostgreSQL. Its two main tasks are removing dead tuples and the freezing transaction ids, both of which are briefly mentioned in Section 5.10.</p><p>To remove dead tuples, vacuum processing provides two modes, i.e. Concurrent VACUUM and Full VACUUM. Concurrent VACUUM, often simply called VACUUM, removes dead tuples for each page of the table file, and other transactions can read the table while this process is running. In contrast, Full VACUUM removes dead tuples and defragments live tuples the whole file, and other transactions cannot access tables while Full VACUUM is running.</p><p>Despite the fact that vacuum processing is essential for PostgreSQL, improving its functionality has been slow compared to other functions. For example, until version 8.0, this process had to be executed manually (with the psql utility or using the cron daemon). It was automated in 2005 when the autovacuum daemon was implemented.</p><p>Since vacuum processing involves scanning whole tables, it is a costly process. In version 8.4 (2009), the Visibility Map (VM) was introduced to improve the efficiency of removing dead tuples. In version 9.6 (2016), the freeze process was improved by enhancing the VM.</p><a id="more"></a><h1 id="Concurrent-VACUUM"><a href="#Concurrent-VACUUM" class="headerlink" title="Concurrent VACUUM"></a>Concurrent VACUUM</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">(<span class="hljs-number">1</span>)  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">table</span><br>(<span class="hljs-number">2</span>)       Acquire ShareUpdateExclusiveLock <span class="hljs-keyword">lock</span> <span class="hljs-keyword">for</span> the target <span class="hljs-keyword">table</span><br><br>          <span class="hljs-comment">/* The first block */</span><br>(<span class="hljs-number">3</span>)       Scan <span class="hljs-keyword">all</span> pages <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> <span class="hljs-keyword">all</span> dead tuples, <span class="hljs-keyword">and</span> <span class="hljs-keyword">freeze</span> <span class="hljs-built_in">old</span> tuples <span class="hljs-keyword">if</span> necessary<br>          PostgreSQL scans a target <span class="hljs-keyword">table</span> <span class="hljs-keyword">to</span> build a list <span class="hljs-keyword">of</span> dead tuples <span class="hljs-keyword">and</span> <span class="hljs-keyword">freeze</span> <span class="hljs-built_in">old</span> tuples <span class="hljs-keyword">if</span> possible. The list <span class="hljs-keyword">is</span> stored <span class="hljs-keyword">in</span> maintenance_work_mem <span class="hljs-keyword">in</span> <span class="hljs-keyword">local</span> memory<br>(<span class="hljs-number">4</span>)       Remove the <span class="hljs-keyword">index</span> tuples that <span class="hljs-type">point</span> <span class="hljs-keyword">to</span> the respective dead tuples <span class="hljs-keyword">if</span> <span class="hljs-keyword">exists</span><br><br>          <span class="hljs-comment">/* The second block */</span><br>(<span class="hljs-number">5</span>)       <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">each</span> page <span class="hljs-keyword">of</span> the <span class="hljs-keyword">table</span><br>(<span class="hljs-number">6</span>)            Remove the dead tuples, <span class="hljs-keyword">and</span> Reallocate the live tuples <span class="hljs-keyword">in</span> the page<br>(<span class="hljs-number">7</span>)            <span class="hljs-keyword">Update</span> FSM <span class="hljs-keyword">and</span> VM<br>           <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br><br>          <span class="hljs-comment">/* The third block */</span><br>(<span class="hljs-number">8</span>)       Clean up indexes<br>(<span class="hljs-number">9</span>)       <span class="hljs-keyword">Truncate</span> the last page <span class="hljs-keyword">if</span> possible<br>(<span class="hljs-number">10</span>       <span class="hljs-keyword">Update</span> <span class="hljs-keyword">both</span> the <span class="hljs-keyword">statistics</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">system</span> catalogs <span class="hljs-keyword">of</span> the target <span class="hljs-keyword">table</span><br>          <span class="hljs-keyword">Release</span> ShareUpdateExclusiveLock <span class="hljs-keyword">lock</span><br>       <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br><br>        <span class="hljs-comment">/* Post-processing */</span><br>(<span class="hljs-number">11</span>)  <span class="hljs-keyword">Update</span> <span class="hljs-keyword">statistics</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">system</span> catalogs<br>(<span class="hljs-number">12</span>)  Remove <span class="hljs-keyword">both</span> unnecessary files <span class="hljs-keyword">and</span> pages <span class="hljs-keyword">of</span> the clog <span class="hljs-keyword">if</span> possible<br><br></code></pre></td></tr></table></figure><p>(1) Get each table from the specified tables.<br>(2) Acquire ShareUpdateExclusiveLock lock for the table. This lock allows reading from other transactions.<br>(3) Scan all pages to get all dead tuples, and freeze old tuples if necessary.<br>(4) Remove the index tuples that point to the respective dead tuples if exists.<br>(5) Do the following tasks, step (6) and (7), for each page of the table.<br>(6) Remove the dead tuples and Reallocate the live tuples in the page.<br>(7) Update both the respective FSM and VM of the target table.<br>(8) Clean up the indexes by the index_vacuum_cleanup()@indexam.c function.<br>(9) Truncate the last page if the last one does not have any tuple.<br>(10) Update both the statistics and the system catalogs related to vacuum processing for the target table.<br>(11) Update both the statistics and the system catalogs related to vacuum processing.<br>(12) Remove both unnecessary files and pages of the clog if possible.</p><h1 id="Full-VACUUM"><a href="#Full-VACUUM" class="headerlink" title="Full VACUUM"></a>Full VACUUM</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">(<span class="hljs-number">1</span>)  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">table</span><br>(<span class="hljs-number">2</span>)       Acquire AccessExclusiveLock <span class="hljs-keyword">lock</span> <span class="hljs-keyword">for</span> the <span class="hljs-keyword">table</span><br>(<span class="hljs-number">3</span>)       <span class="hljs-keyword">Create</span> a <span class="hljs-built_in">new</span> <span class="hljs-keyword">table</span> file<br>(<span class="hljs-number">4</span>)       <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">each</span> live tuple <span class="hljs-keyword">in</span> the <span class="hljs-built_in">old</span> <span class="hljs-keyword">table</span><br>(<span class="hljs-number">5</span>)            <span class="hljs-keyword">Copy</span> the live tuple <span class="hljs-keyword">to</span> the <span class="hljs-built_in">new</span> <span class="hljs-keyword">table</span> file<br>(<span class="hljs-number">6</span>)            <span class="hljs-keyword">Freeze</span> the tuple <span class="hljs-keyword">IF</span> necessary<br>            <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br>(<span class="hljs-number">7</span>)        Remove the <span class="hljs-built_in">old</span> <span class="hljs-keyword">table</span> file<br>(<span class="hljs-number">8</span>)        Rebuild <span class="hljs-keyword">all</span> indexes<br>(<span class="hljs-number">9</span>)        <span class="hljs-keyword">Update</span> FSM <span class="hljs-keyword">and</span> VM<br>(<span class="hljs-number">10</span>)      <span class="hljs-keyword">Update</span> <span class="hljs-keyword">statistics</span><br>            <span class="hljs-keyword">Release</span> AccessExclusiveLock <span class="hljs-keyword">lock</span><br>       <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br>(<span class="hljs-number">11</span>)  Remove unnecessary clog files <span class="hljs-keyword">and</span> pages <span class="hljs-keyword">if</span> possible<br></code></pre></td></tr></table></figure><h2 id="When-should-I-do-VACUUM-FULL"><a href="#When-should-I-do-VACUUM-FULL" class="headerlink" title="When should I do VACUUM FULL?"></a>When should I do VACUUM FULL?</h2><p>There is unfortunately no best practice when you should execute ‘VACUUM FULL’. However, the extension pg_freespacemap may give you good suggestions.</p><p>The following query shows the average freespace ratio of the table you want to know.<br></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">testdb=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> pg_freespacemap;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span><br><br>testdb=# <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class="hljs-keyword">as</span> <span class="hljs-type">bigint</span>)) <span class="hljs-keyword">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class="hljs-number">100</span> * avg(avail)/<span class="hljs-number">8192</span> ,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> &quot;Av. freespace ratio&quot;<br>       <span class="hljs-keyword">FROM</span> pg_freespace(<span class="hljs-string">&#x27;accounts&#x27;</span>);<br> number <span class="hljs-keyword">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class="hljs-comment">-----------------+--------------------+---------------------</span><br>            <span class="hljs-number">1640</span> | <span class="hljs-number">99</span> bytes           |                <span class="hljs-number">1.21</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br></code></pre></td></tr></table></figure><p></p><p>As the result above, You can find that there are few free spaces.</p><p>If you delete almost tuples and execute VACUUM command, you can find that almost pages are spaces ones.<br></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">testdb=# <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> aid %<span class="hljs-number">10</span> != <span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> aid &lt; <span class="hljs-number">100</span>;<br><span class="hljs-keyword">DELETE</span> <span class="hljs-number">90009</span><br><br>testdb=# <span class="hljs-keyword">VACUUM</span> accounts;<br><span class="hljs-keyword">VACUUM</span><br><br>testdb=# <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">as</span> &quot;number of pages&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class="hljs-keyword">as</span> <span class="hljs-type">bigint</span>)) <span class="hljs-keyword">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class="hljs-number">100</span> * avg(avail)/<span class="hljs-number">8192</span> ,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> &quot;Av. freespace ratio&quot;<br>       <span class="hljs-keyword">FROM</span> pg_freespace(<span class="hljs-string">&#x27;accounts&#x27;</span>);<br> number <span class="hljs-keyword">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class="hljs-comment">-----------------+--------------------+---------------------</span><br>            <span class="hljs-number">1640</span> | <span class="hljs-number">7124</span> bytes         |               <span class="hljs-number">86.97</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br></code></pre></td></tr></table></figure><p></p><p>The following query inspects the freespace ratio of each page of the specified table.<br></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs lsl">testdb=# SELECT *, round(<span class="hljs-number">100</span> * avail/<span class="hljs-number">8192</span> ,<span class="hljs-number">2</span>) as <span class="hljs-string">&quot;freespace ratio&quot;</span><br>                FROM pg_freespace(&#x27;accounts&#x27;);<br> blkno | avail | freespace ratio<br>-------+-------+-----------------<br>     <span class="hljs-number">0</span> |  <span class="hljs-number">7904</span> |           <span class="hljs-number">96.00</span><br>     <span class="hljs-number">1</span> |  <span class="hljs-number">7520</span> |           <span class="hljs-number">91.00</span><br>     <span class="hljs-number">2</span> |  <span class="hljs-number">7136</span> |           <span class="hljs-number">87.00</span><br>     <span class="hljs-number">3</span> |  <span class="hljs-number">7136</span> |           <span class="hljs-number">87.00</span><br>     <span class="hljs-number">4</span> |  <span class="hljs-number">7136</span> |           <span class="hljs-number">87.00</span><br>     <span class="hljs-number">5</span> |  <span class="hljs-number">7136</span> |           <span class="hljs-number">87.00</span><br>....<br></code></pre></td></tr></table></figure><br>After executing VACUUM FULL, you can find that the table file has been compacted.<br><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">testdb=# <span class="hljs-keyword">VACUUM</span> <span class="hljs-keyword">FULL</span> accounts;<br><span class="hljs-keyword">VACUUM</span><br>testdb=# <span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">as</span> &quot;number of blocks&quot;,<br>       pg_size_pretty(cast(avg(avail) <span class="hljs-keyword">as</span> <span class="hljs-type">bigint</span>)) <span class="hljs-keyword">as</span> &quot;Av. freespace size&quot;,<br>       round(<span class="hljs-number">100</span> * avg(avail)/<span class="hljs-number">8192</span> ,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> &quot;Av. freespace ratio&quot;<br>       <span class="hljs-keyword">FROM</span> pg_freespace(<span class="hljs-string">&#x27;accounts&#x27;</span>);<br> number <span class="hljs-keyword">of</span> pages | Av. freespace size | Av. freespace ratio<br><span class="hljs-comment">-----------------+--------------------+---------------------</span><br>             <span class="hljs-number">164</span> | <span class="hljs-number">0</span> bytes            |                <span class="hljs-number">0.00</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br></code></pre></td></tr></table></figure><p></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div class="reward-container"><div>听说，打赏我的人都找到了真爱</div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.png" alt="daydayup 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/alipay.png" alt="daydayup 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>daydayup</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://daydayup863.github.io/PostgreSQL/PostgreSQL_vacuum/" title="PostgreSQL vacuum">http://daydayup863.github.io/PostgreSQL/PostgreSQL_vacuum/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/PostgreSQL/" rel="tag"><i class="fa fa-tag"></i> PostgreSQL</a> <a href="/tags/vacuum/" rel="tag"><i class="fa fa-tag"></i> vacuum</a></div><div class="post-nav"><div class="post-nav-item"><a href="/PostgreSQL/PostgreSQL_Buffer_Manager/" rel="prev" title="PostgreSQL 缓冲区管理"><i class="fa fa-chevron-left"></i> PostgreSQL 缓冲区管理</a></div><div class="post-nav-item"><a href="/PostgreSQL/PostgreSQL_backend_process/" rel="next" title="PostgreSQL后端进程">PostgreSQL后端进程 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var o,a,r,f,t,i=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");function h(t,e){for(var n=[1,2,3],l=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],o=0;o<i[e].length;o++)for(var a,h=0;h<i[e][o].length;h++){1==i[e][o][h]&&(a={x:14*(f+2)*t+2*h*(f+1)+(f+1),y:2*o*(f+1)+(f+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:l[Math.floor(Math.random()*l.length)],disY:1},r.push(a))}}function n(){e.height=100;for(var t=0;t<a.length;t++)!function(t,e){for(var n=0;n<i[e].length;n++)for(var l=0;l<i[e][n].length;l++)1==i[e][n][l]&&(o.beginPath(),o.arc(14*(f+2)*t+2*l*(f+1)+(f+1),2*n*(f+1)+(f+1),f,0,2*Math.PI),o.closePath(),o.fill())}(t,a[t]);for(t=0;t<r.length;t++)o.beginPath(),o.arc(r[t].x,r[t].y,f,0,2*Math.PI),o.fillStyle=r[t].color,o.closePath(),o.fill()}e.getContext&&(o=e.getContext("2d"),e.height=100,e.width=700,o.fillStyle="#f00",o.fillRect(10,10,50,50),a=[],r=[],f=e.height/20-1,t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(void 0),setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var l=a.length-1;0<=l;l--)n[l]!==a[l]&&t.push(l+"_"+(Number(a[l])+1)%10);for(l=0;l<t.length;l++)h.apply(this,t[l].split("_"));a=n.concat()}(),function(){for(var t=0;t<r.length;t++)r[t].stepY+=r[t].disY,r[t].x+=r[t].stepX,r[t].y+=r[t].stepY,(r[t].x>700+f||r[t].y>100+f)&&(r.splice(t,1),t--)}(),n()},50))}()</script><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Concurrent-VACUUM"><span class="nav-number">1.</span> <span class="nav-text">Concurrent VACUUM</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Full-VACUUM"><span class="nav-number">2.</span> <span class="nav-text">Full VACUUM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#When-should-I-do-VACUUM-FULL"><span class="nav-number">2.1.</span> <span class="nav-text">When should I do VACUUM FULL?</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" alt="daydayup" src="/images/user.jpg"></a><p class="site-author-name" itemprop="name">daydayup</p><div class="site-description" itemprop="description">good good study, day day up.</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">27</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">44</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/daydayup863" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;daydayup863" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 大神链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/digoal/blog" title="https:&#x2F;&#x2F;github.com&#x2F;digoal&#x2F;blog" rel="noopener" target="_blank">德哥</a></li><li class="links-of-blogroll-item"><a href="https://postgres.fun/" title="https:&#x2F;&#x2F;postgres.fun" rel="noopener" target="_blank">francs</a></li><li class="links-of-blogroll-item"><a href="https://pengzhanyuan.github.io/" title="https:&#x2F;&#x2F;pengzhanyuan.github.io&#x2F;" rel="noopener" target="_blank">元叔</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love" id="heart"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">daydayup</span></div><div class="powered-by"><i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv"> 本站访客数:<span id="busuanzi_value_site_uv"></span></span></div><br><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动</div><br><div class="theme-info"><div class="powered-by"></div><span class="post-count">博客全站共38.3k字</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/local-search.js"></script><script src="/js/cursor/cherry.js"></script><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script><script>flOptions={iconStyle:"default",boxForm:"horizontal",position:"middleRight",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-float",flOptions)</script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : '3i88YSkCct0TI3n9fK42pDqp-gzGzoHsz',
      appKey     : 'HAU6P1j8dEW9P7oMKHQsS0Ub',
      placeholder: "在这里说点什么吧...",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script><script type="text/javascript" src="/js/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/haruto.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0}})</script></body></html>